<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitzgerald HR Assistant - Beta Test</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fitz HR">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- WEEK 3: Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <!-- Word Document Generation - ‚úÖ USING JSDELIVR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
    
    <!-- Excel/Spreadsheet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
 
 <style>

/* ========================================
   DARK MODE SYSTEM
   ======================================== */

/* CSS Variables for Theme Colors */
:root {
    /* Dark Mode (Default) */
    --bg-primary: #0f172a;      /* slate-900 */
    --bg-secondary: #1e293b;    /* slate-800 */
    --bg-tertiary: #334155;     /* slate-700 */
    --text-primary: #ffffff;
    --text-secondary: #cbd5e1;  /* slate-300 */
    --text-tertiary: #94a3b8;   /* slate-400 */
    --border-color: #475569;    /* slate-600 */
    --accent-color: #f59e0b;    /* amber-500 */
    --accent-hover: #d97706;    /* amber-600 */
}

/* Light Mode Variables */
.light-mode {
    --bg-primary: #f8fafc;      /* slate-50 */
    --bg-secondary: #f1f5f9;    /* slate-100 */
    --bg-tertiary: #e2e8f0;     /* slate-200 */
    --text-primary: #0f172a;    /* slate-900 */
    --text-secondary: #334155;  /* slate-700 */
    --text-tertiary: #64748b;   /* slate-500 */
    --border-color: #cbd5e1;    /* slate-300 */
    --accent-color: #f59e0b;    /* amber-500 */
    --accent-hover: #d97706;    /* amber-600 */
}

/* Smooth transitions for theme changes */
body, 
.bg-slate-900, .bg-slate-800, .bg-slate-700,
.text-white, .text-slate-300, .text-slate-400,
.border-slate-700, .border-slate-600 {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* Light mode overrides for body */
body.light-mode {
    background: linear-gradient(to bottom right, #f8fafc, #f1f5f9, #f8fafc) !important;
}

/* Light mode text adjustments - ULTRA BOLD & CLEAR */
.light-mode .text-white { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-100 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-200 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-300 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-400 { color: #1f2937 !important; font-weight: 500; }
.light-mode .text-slate-500 { color: #374151 !important; }
.light-mode .text-slate-600 { color: #1f2937 !important; }

/* Light mode backgrounds - CRISP WHITE */
.light-mode .bg-slate-900 { 
    background-color: #ffffff !important;
}
.light-mode .bg-slate-800 { 
    background-color: #ffffff !important; 
    border: 2px solid #d1d5db !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
}
.light-mode .bg-slate-700 { 
    background-color: #f9fafb !important;
    border: 2px solid #e5e7eb !important;
}
.light-mode .bg-slate-600 { background-color: #e5e7eb !important; }

/* Light mode borders - STRONG & VISIBLE */
.light-mode .border-slate-700 { border-color: #9ca3af !important; border-width: 2px !important; }
.light-mode .border-slate-600 { border-color: #d1d5db !important; border-width: 2px !important; }

/* Chat messages - CRYSTAL CLEAR */
.light-mode #messagesContainer .bg-slate-700 {
    background-color: #ffffff !important;
    border: 2px solid #d1d5db !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.light-mode #messagesContainer .bg-slate-800 {
    background-color: #f9fafb !important;
    border: 2px solid #e5e7eb !important;
}

/* Force ALL text to be BOLD BLACK */
.light-mode #messagesContainer,
.light-mode #messagesContainer p,
.light-mode #messagesContainer span,
.light-mode #messagesContainer div,
.light-mode #messagesContainer li,
.light-mode #messagesContainer strong {
    color: #000000 !important;
    font-weight: 500 !important;
}

/* REDESIGNED: VIBRANT suggestion boxes - CLEAR & BOLD */
.light-mode .bg-amber-500\/10,
.light-mode .bg-yellow-500\/10,
.light-mode .bg-amber-100 {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
    border: 2px solid #3b82f6 !important;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    padding: 16px !important;
}

/* BOLD blue text in suggestion boxes */
.light-mode .bg-amber-500\/10 *,
.light-mode .bg-yellow-500\/10 * {
    color: #1e3a8a !important;
    font-weight: 600 !important;
    font-size: 0.95rem !important;
}

/* VIBRANT Daily Tip Bar - IMPOSSIBLE TO MISS */
.light-mode .bg-blue-500\/10 {
    background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%) !important;
    border: 2px solid #2563eb !important;
    border-left: 6px solid #2563eb !important;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15), 0 2px 4px 0 rgba(0, 0, 0, 0.1);
}

/* Daily Tip text - BOLD & CLEAR */
.light-mode .bg-blue-500\/10 * {
    color: #1e3a8a !important;
    font-weight: 600 !important;
}

/* Professional alert boxes - VIBRANT */
.light-mode .bg-red-500\/10 {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
    border: 2px solid #ef4444 !important;
    border-left: 6px solid #ef4444 !important;
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
}

.light-mode .bg-green-500\/10 {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
    border: 2px solid #10b981 !important;
    border-left: 6px solid #10b981 !important;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
}

/* VIBRANT colored text - BOLD & CLEAR */
.light-mode .text-red-300,
.light-mode .text-red-400 {
    color: #dc2626 !important;
    font-weight: 700 !important;
}

.light-mode .text-amber-400,
.light-mode .text-amber-500,
.light-mode .text-orange-400,
.light-mode .text-orange-500 {
    color: #ea580c !important;
    font-weight: 700 !important;
}

.light-mode .text-green-300,
.light-mode .text-green-400,
.light-mode .text-green-500 {
    color: #16a34a !important;
    font-weight: 700 !important;
}

.light-mode .text-blue-300,
.light-mode .text-blue-400,
.light-mode .text-blue-500 {
    color: #2563eb !important;
    font-weight: 600 !important;
}

/* BOLD links */
.light-mode a {
    color: #2563eb !important;
    text-decoration: none;
    font-weight: 600 !important;
    border-bottom: 2px solid #2563eb;
}

.light-mode a:hover {
    color: #1d4ed8 !important;
    border-bottom-color: #1d4ed8;
}

/* Modal overlay - CLEAR */
.light-mode .bg-black\/90 {
    background-color: rgba(0, 0, 0, 0.75) !important;
    backdrop-filter: blur(8px);
}

/* PROFESSIONAL input fields - THICK BORDERS */
.light-mode input,
.light-mode textarea,
.light-mode select {
    background-color: #ffffff !important;
    color: #000000 !important;
    border: 2px solid #9ca3af !important;
    box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
    font-weight: 500 !important;
}

.light-mode input:focus,
.light-mode textarea:focus,
.light-mode select:focus {
    border-color: #f59e0b !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2), inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    outline: none;
}

.light-mode input::placeholder,
.light-mode textarea::placeholder {
    color: #6b7280 !important;
    font-weight: 400 !important;
}

/* Button styling - CLEAR HIERARCHY */
.light-mode button:not(.bg-red-600):not(.bg-blue-600):not(.bg-purple-600):not(.bg-green-600):not(.bg-amber-500):not(.bg-orange-600) {
    background-color: #f3f4f6 !important;
    color: #1f2937 !important;
    border: 2px solid #d1d5db !important;
    font-weight: 600 !important;
}

.light-mode button:not(.bg-red-600):not(.bg-blue-600):not(.bg-purple-600):not(.bg-green-600):not(.bg-amber-500):not(.bg-orange-600):hover {
    background-color: #e5e7eb !important;
    border-color: #9ca3af !important;
}

/* BOLD header */
.light-mode .bg-slate-800\/80 {
    background-color: #ffffff !important;
    border-bottom: 3px solid #d1d5db !important;
    backdrop-filter: blur(12px);
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
}

/* Message input box - ULTRA CLEAR */
.light-mode #messageInput {
    background-color: #ffffff !important;
    border: 2px solid #9ca3af !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
    color: #000000 !important;
    font-weight: 500 !important;
}

.light-mode #messageInput:focus {
    border-color: #f59e0b !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

/* Send button - VIBRANT */
.light-mode .bg-amber-500,
.light-mode .bg-orange-600 {
    box-shadow: 0 2px 8px 0 rgba(245, 158, 11, 0.4) !important;
    font-weight: 700 !important;
}

.light-mode .bg-amber-500:hover,
.light-mode .bg-orange-600:hover {
    box-shadow: 0 4px 12px 0 rgba(245, 158, 11, 0.5) !important;
    transform: translateY(-1px);
}

/* Icon improvements */
.light-mode .bg-amber-500\/10 span,
.light-mode .bg-blue-500\/10 span {
    font-size: 1.1em !important;
}

/* Warning icon */
.light-mode .text-amber-500 {
    color: #f59e0b !important;
    font-size: 1.2em !important;
    font-weight: 700 !important;
}

/* HIDE LOGOUT BUTTON FROM HEADER ONLY - It's in sidebar now */
header button[onclick*="logout"],
.bg-slate-800\/80 button[onclick*="logout"] {
    display: none !important;
}

/* Improve mobile touch targets */
@media (max-width: 768px) {
    /* Make all buttons at least 44px tall (Apple's recommended touch target) */
    button {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Prevent text selection on buttons */
    button, .tool-card, .modal-button {
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Improve textarea on mobile */
    textarea {
        font-size: 16px; /* Prevents iOS zoom on focus */
    }
    
    /* Hide scrollbars on mobile for cleaner look */
    #messagesContainer::-webkit-scrollbar {
        display: none;
    }
    
    /* Smooth scrolling on mobile */
    #messagesContainer {
        -webkit-overflow-scrolling: touch;
    }
    
    /* MOBILE ENHANCEMENTS - DAY 4-5 */
    
    /* Reduce padding on mobile for more space */
    #messagesContainer {
        padding: 12px !important;
    }
    
    /* Chat message bubbles - better spacing on mobile */
    #messagesContainer > div {
        margin-bottom: 16px !important;
        padding: 16px !important;
    }
    
    /* Make Daily Tip bar more compact on mobile */
    .bg-blue-500\/10 {
        padding: 12px !important;
        font-size: 14px !important;
    }
    
    /* Suggestion boxes - more compact */
    .bg-amber-500\/10,
    .bg-yellow-500\/10 {
        padding: 12px !important;
        font-size: 14px !important;
    }
    
    /* Header adjustments */
    header {
        padding-top: 8px !important;
        padding-bottom: 8px !important;
    }
    
    /* Tools menu - HIDE on mobile (use modal instead) */
    /* Admin dashboard - FULL SCREEN mobile with proper scrolling */
    #adminDashboardModal {
        padding: 0 !important;
        align-items: flex-start !important;
        overflow-y: auto !important;
    }
    
    #adminDashboardModal > div {
        max-width: 100% !important;
        width: 100% !important;
        padding: 16px !important;
        margin: 0 !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        border: none !important;
    }
    
    /* Admin header - compact */
    #adminDashboardModal h2 {
        font-size: 1.5rem !important;
    }
    
    #adminDashboardModal .mb-6 {
        margin-bottom: 16px !important;
    }
    
    /* Admin stats - stack on mobile */
    #adminDashboardModal .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
    }
    
    /* Admin stats cards - smaller text */
    #adminDashboardModal .grid-cols-4 > div {
        padding: 12px !important;
    }
    
    #adminDashboardModal .grid-cols-4 .text-3xl {
        font-size: 1.5rem !important;
    }
    
    #adminDashboardModal .grid-cols-4 .text-xs {
        font-size: 0.65rem !important;
    }
    
    /* Admin tabs - wrap on mobile */
    #adminDashboardModal .flex.gap-2 {
        flex-wrap: wrap !important;
        gap: 4px !important;
    }
    
    #adminDashboardModal .admin-tab {
        padding: 8px 12px !important;
        font-size: 13px !important;
        white-space: nowrap !important;
    }
    
    /* Admin tab content - better height */
    #adminTabContent {
        max-height: 50vh !important;
    }
    
    /* Admin buttons - stack on mobile */
    #adminDashboardModal .mt-6.flex {
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    #adminDashboardModal .mt-6.flex button {
        width: 100% !important;
    }
    
    /* Modals - full screen on mobile */
    .modal > div {
        max-height: 95vh !important;
        margin: 8px !important;
        max-width: calc(100vw - 16px) !important;
    }
    
    /* Send button - bigger touch target */
    button:has(span:contains('Send')) {
        min-height: 48px !important;
        padding-left: 24px !important;
        padding-right: 24px !important;
    }
    
    /* Document preview modal - better mobile fit */
    #documentPreviewModal .max-w-5xl {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    /* Award calculator - stack vertically on mobile */
    #awardCalculatorModal select,
    #awardCalculatorModal input {
        width: 100% !important;
        margin-bottom: 12px !important;
    }
    
    /* Navigation buttons - wrap better */
    header button {
        font-size: 13px !important;
        padding: 8px 12px !important;
    }
    
    /* Hide secondary text on very small screens */
    @media (max-width: 380px) {
        .hidden.sm\\:inline {
            display: none !important;
        }
    }
    
    /* Landscape mode optimizations */
    @media (orientation: landscape) and (max-height: 500px) {
        #messagesContainer {
            max-height: 50vh !important;
        }
        
        header {
            position: sticky !important;
            top: 0 !important;
            z-index: 50 !important;
        }
    }
    
    /* ==========================================
       PHASE 5: MOBILE UX - SINGLE ROW HEADER
       ========================================== */
    
    /* FIX 1: CLEAN SINGLE ROW HEADER */
    /* [‚ò∞] [Fitz] [üö® URGENT] [Tools] [Logout] [‚ãØ More] */
    
    /* Header container - single row */
    .bg-slate-800\/80.backdrop-blur-sm {
        padding: 12px 16px !important;
    }
    
    .bg-slate-800\/80.backdrop-blur-sm .max-w-5xl {
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    .bg-slate-800\/80.backdrop-blur-sm .max-w-5xl > div {
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        gap: 8px !important;
    }
    
    /* Left side: Sidebar + Logo */
    .bg-slate-800\/80.backdrop-blur-sm .max-w-5xl > div > div:first-child {
        flex: 0 0 auto !important;
        gap: 8px !important;
    }
    
    /* Sidebar button */
    .sidebar-toggle-btn-header {
        padding: 10px !important;
        min-width: 44px !important;
        min-height: 44px !important;
    }
    
    /* Logo and text container */
    .bg-slate-800\/80.backdrop-blur-sm .w-10.h-10 {
        width: 36px !important;
        height: 36px !important;
    }
    
    /* Hide "Beta" text on mobile */
    .bg-slate-800\/80.backdrop-blur-sm .text-xs.text-slate-400 {
        display: none !important;
    }
    
    /* Right side: URGENT + Tools + Logout + More */
    .bg-slate-800\/80.backdrop-blur-sm .max-w-5xl > div > div:last-child {
        flex: 0 0 auto !important;
        display: flex !important;
        gap: 6px !important;
        align-items: center !important;
    }
    
    /* URGENT button - FIRST (order -1 to come before others) */
    button[onclick*="activateCrisisMode"] {
        padding: 8px 12px !important;
        min-height: 44px !important;
        font-size: 13px !important;
        font-weight: 700 !important;
        order: -1 !important;  /* Negative to come first */
    }
    
    /* Tools button - SECOND */
    button[onclick*="toggleToolsMenu"] {
        min-width: 44px !important;
        min-height: 44px !important;
        padding: 10px !important;
        order: 1 !important;
    }
    
    /* More button - THIRD now */
    #moreMenuButton {
        order: 2 !important;  /* Now third in order */
    }
    
    /* Hide these buttons ONLY in header - NOT in Profile menu */
    header button[onclick*="toggleDarkMode"],
    header button[onclick*="showVenueSettings"],
    header button[onclick*="showFeedback"],
    .bg-slate-800\/80 button[onclick*="toggleDarkMode"],
    .bg-slate-800\/80 button[onclick*="showVenueSettings"],
    .bg-slate-800\/80 button[onclick*="showFeedback"] {
        display: none !important;
    }
    
    /* Hide dividers */
    .bg-slate-800\/80.backdrop-blur-sm .hidden.md\\:block {
        display: none !important;
    }
    
    /* Hide admin */
    #adminButton {
        display: none !important;
    }
    
    /* Icon sizes */
    .bg-slate-800\/80.backdrop-blur-sm button span:first-child {
        font-size: 18px !important;
    }
    
    /* FIX 2: STACK TOOL NAVIGATION BUTTONS */
    /* All Document Builder and tool modal navigation buttons */
    #documentBuilderModal .flex.gap-3.mt-6,
    #awardCalculatorModal .flex.gap-3.mt-6,
    #scenarioAnalysisModal .flex.gap-3.mt-6,
    #rosterStressTesterModal .flex.gap-3.mt-6,
    #awardWizardModal .flex.gap-3.mt-6,
    #rosterOptimizerModal .flex.gap-3.mt-6,
    #complianceCalendarModal .flex.gap-3.mt-6,
    #terminationRiskModal .flex.gap-3.mt-6 {
        flex-direction: column !important;
        gap: 12px !important;
    }
    
    /* Make all navigation buttons full width */
    #docBackBtn,
    #docNextBtn,
    #docStartOverBtn,
    #documentBuilderModal .flex.gap-3.mt-6 button,
    #awardCalculatorModal .flex.gap-3.mt-6 button,
    #scenarioAnalysisModal .flex.gap-3.mt-6 button,
    #rosterStressTesterModal .flex.gap-3.mt-6 button,
    #awardWizardModal .flex.gap-3.mt-6 button,
    #rosterOptimizerModal .flex.gap-3.mt-6 button,
    #complianceCalendarModal .flex.gap-3.mt-6 button,
    #terminationRiskModal .flex.gap-3.mt-6 button {
        width: 100% !important;
        flex: none !important;
        padding: 16px !important;
        font-size: 16px !important;
        min-height: 56px !important;
    }
    
    /* Order: Next first (top), Back second (middle), Start Over last (bottom) */
    #docNextBtn { order: 1 !important; }
    #docBackBtn { order: 2 !important; }
    #docStartOverBtn { order: 3 !important; }
    
    /* FIX 3: MUCH BIGGER MESSAGE INPUT */
    /* 4 lines visible, very prominent and inviting */
    #messageInput {
        min-height: 100px !important;     /* 4 lines visible! */
        max-height: 220px !important;     /* Can expand even more */
        padding: 18px !important;         /* Extra spacious */
        font-size: 16px !important;       /* Prevent iOS zoom, readable */
        line-height: 1.6 !important;      /* Extra readability */
        border-width: 2px !important;     /* Visible border */
    }
    
    /* Make focused state more obvious */
    #messageInput:focus {
        border-color: rgb(245 158 11) !important;  /* Amber on focus */
    }
    
    /* Input container - more padding */
    .flex.items-center.gap-3.bg-slate-900:has(#messageInput) {
        padding: 14px !important;
        border-radius: 16px !important;
    }
    
    /* Send button - larger and prominent */
    button:has(#sendButton),
    button[onclick*="sendMessage"] {
        min-height: 56px !important;
        min-width: 56px !important;
        padding: 16px !important;
        border-radius: 12px !important;
    }
    
    /* Voice button - larger */
    button[onclick*="toggleVoiceInput"] {
        min-height: 56px !important;
        min-width: 56px !important;
        padding: 16px !important;
    }
    
    /* File upload button - larger */
    button[onclick*="openUploadMenu"] {
        min-height: 56px !important;
        min-width: 56px !important;
        padding: 16px !important;
    }
    
    /* FIX 4: CRISIS MODE MOBILE-RESPONSIVE */
    /* Crisis Modal Container */
    #crisisModal {
        padding: 12px !important;
        align-items: flex-start !important;
    }
    
    /* Crisis Modal Content Box */
    #crisisModal > div {
        padding: 20px !important;                    /* Was 32px */
        margin: 0 !important;
        max-height: calc(100vh - 24px) !important;   /* Fit screen */
        overflow-y: auto !important;                 /* Scrollable */
        width: 100% !important;
        border-width: 2px !important;                /* Thinner border */
    }
    
    /* Smaller emoji */
    #crisisModal .text-6xl {
        font-size: 3rem !important;       /* 48px instead of 96px */
        margin-bottom: 12px !important;
    }
    
    /* Smaller heading */
    #crisisModal h2 {
        font-size: 1.5rem !important;     /* 24px instead of 48px */
        margin-bottom: 8px !important;
        line-height: 1.3 !important;
    }
    
    /* Smaller subtitle */
    #crisisModal h2 + p {
        font-size: 0.9rem !important;
        margin-bottom: 16px !important;
    }
    
    /* Compact form elements */
    #crisisModal select,
    #crisisModal input,
    #crisisModal textarea {
        padding: 12px !important;
        font-size: 16px !important;
    }
    
    /* Smaller textarea */
    #crisisDescription {
        min-height: 80px !important;      /* More compact */
    }
    
    /* Action box more compact */
    #crisisModal .bg-red-500\/10 {
        padding: 12px !important;
        font-size: 13px !important;
        margin-bottom: 16px !important;
    }
    
    #crisisModal .bg-red-500\/10 p {
        font-size: 14px !important;
        margin-bottom: 8px !important;
    }
    
    #crisisModal .bg-red-500\/10 ul {
        font-size: 13px !important;
    }
    
    #crisisModal .bg-red-500\/10 li {
        line-height: 1.4 !important;
    }
    
    /* Crisis buttons more compact */
    #crisisModal .flex.gap-3:has(button) {
        margin-top: 16px !important;
    }
    
    /* Stack crisis buttons on very small screens */
    @media (max-width: 480px) {
        #crisisModal .flex.gap-3:has(button) {
            flex-direction: column !important;
        }
        
        #crisisModal button {
            width: 100% !important;
            padding: 14px !important;
            font-size: 15px !important;
        }
    }
}

/* Tablet optimizations (768px - 1024px) */
@media (min-width: 768px) and (max-width: 1024px) {
    /* Slightly reduce padding for tablets */
    .max-w-5xl {
        max-width: 90% !important;
    }
    
    /* Better modal sizing on tablets */
    .modal > div {
        max-width: 85vw !important;
    }
}

/* Prevent zoom on input focus (iOS) */
input, textarea, select {
    font-size: 16px;
}

        /* Crisis Mode Pulse Animation */


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }

        /* ========================================
           WEEK 2: LOADING STATES & SKELETONS
           ======================================== */
        
        /* Skeleton loader animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
            border-radius: 0.5rem;
        }
        
        .light-mode .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 1000px 100%;
        }
        
        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Fade-in animation for content */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Progress bar animation */
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .progress-bar {
            animation: progress 2s ease-out;
        }
        
        /* Toast notification slide-in */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s ease-in;
        }
        
        /* Toast container */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        
        .toast {
            pointer-events: auto;
            min-width: 300px;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .toast-success {
            background: #064e3b;
            border: 1px solid #10b981;
            color: #d1fae5;
        }
        
        .toast-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fee2e2;
        }
        
        .toast-warning {
            background: #78350f;
            border: 1px solid #f59e0b;
            color: #fef3c7;
        }
        
        .toast-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #dbeafe;
        }
        
        .light-mode .toast-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #064e3b;
        }
        
        .light-mode .toast-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #7f1d1d;
        }
        
        .light-mode .toast-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #78350f;
        }
        
        .light-mode .toast-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e3a8a;
        }
        
        /* Smooth focus indicators (accessibility) */
        *:focus-visible {
            outline: 2px solid #f59e0b;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Better hover states */
        button:not(:disabled):hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }
        
        button:not(:disabled):active {
            transform: translateY(0);
        }
        
        /* Disabled state styling */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Smooth modal transitions */
        .modal-enter {
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-backdrop {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .light-mode .loading-overlay {
            background: rgba(255, 255, 255, 0.9);
        }

        /* ========================================
           WEEK 3 PHASE 1: POWER USER FEATURES
           ======================================== */
        
        /* Search Bar */
        .search-container {
            position: relative;
        }
        
        .search-highlight {
            background: #fef3c7;
            color: #78350f;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .light-mode .search-highlight {
            background: #fef3c7;
            color: #78350f;
        }
        
        /* Bookmark Star */
        .bookmark-star {
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            opacity: 0.4;
        }
        
        .bookmark-star:hover {
            transform: scale(1.3);
            opacity: 1;
        }
        
        .bookmark-star.bookmarked {
            color: #f59e0b;
            opacity: 1;
        }
        
        /* Quick Actions Menu */
        .quick-actions-fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            z-index: 1000;
        }
        
        .quick-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5);
            transition: all 0.3s;
            border: none;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.7);
        }
        
        .quick-actions-menu {
            position: absolute;
            bottom: 75px;
            right: 0;
            background: #1e293b;
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 12px;
            min-width: 240px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: none;
        }
        
        .quick-actions-menu.show {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .light-mode .quick-actions-menu {
            background: white;
            border: 2px solid #f59e0b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .quick-action-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        
        .quick-action-item:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: translateX(4px);
        }
        
        .light-mode .quick-action-item {
            color: #1f2937;
        }
        
        .light-mode .quick-action-item:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* Multi-file Upload */
        .drag-drop-zone {
            border: 3px dashed #475569;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.3);
        }
        
        .drag-drop-zone:hover {
            border-color: #64748b;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .drag-drop-zone.drag-over {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            transform: scale(1.02);
            border-style: solid;
        }
        
        .light-mode .drag-drop-zone {
            border-color: #cbd5e1;
            background: rgba(241, 245, 249, 0.5);
        }
        
        .light-mode .drag-drop-zone:hover {
            border-color: #94a3b8;
            background: rgba(241, 245, 249, 0.8);
        }
        
        .light-mode .drag-drop-zone.drag-over {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .light-mode .file-item {
            background: white;
            border-color: #e2e8f0;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-new {
            background: #f59e0b;
            color: #78350f;
        }
        
        /* Search Results */
        .search-result {
            padding: 16px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result:hover {
            border-color: #f59e0b;
            transform: translateX(4px);
        }
        
        .light-mode .search-result {
            background: white;
            border-color: #e2e8f0;
        }
        
        .light-mode .search-result:hover {
            border-color: #f59e0b;
        }
        
        /* ==========================================
           CHATGPT-STYLE SIDEBAR
           ========================================== */
        
        .chat-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #171717;
            border-right: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            z-index: 40;
            transition: transform 0.3s ease;
        }
        
        .chat-sidebar.closed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid #2d2d2d;
        }
        
        .sidebar-close-btn {
            color: #94a3b8;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .sidebar-close-btn:hover {
            background: #2d2d2d;
            color: white;
        }
        
        .sidebar-new-chat-btn {
            margin: 12px;
            padding: 12px;
            background: transparent;
            border: 1px solid #2d2d2d;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: all 0.2s;
            width: calc(100% - 24px);
        }
        
        .sidebar-new-chat-btn:hover {
            background: #2d2d2d;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        .sidebar-section {
            margin-top: 20px;
        }
        
        .sidebar-section-title {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-items-list {
            padding: 0 8px;
        }
        
        .sidebar-chat-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .sidebar-chat-item:hover {
            background: #2d2d2d;
        }
        
        .sidebar-chat-item.active {
            background: #2d2d2d;
            color: white;
        }
        
        .sidebar-chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sidebar-chat-delete {
            opacity: 0;
            color: #64748b;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .sidebar-chat-item:hover .sidebar-chat-delete {
            opacity: 1;
        }
        
        .sidebar-chat-delete:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 39;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 50;
            background: #2d2d2d;
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #3d3d3d;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-toggle-btn:hover {
            background: #3d3d3d;
        }
        
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
                max-width: 300px;
            }
        }
        
        .light-mode .chat-sidebar {
            background: white;
            border-right-color: #e2e8f0;
        }
        
        .light-mode .sidebar-new-chat-btn {
            border-color: #e2e8f0;
            color: #0f172a;
        }
        
        .light-mode .sidebar-chat-item {
            color: #475569;
        }
        
        .light-mode .sidebar-chat-item.active {
            background: #f1f5f9;
            color: #0f172a;
        }
        
        /* Highlight flash for bookmarks */
        .highlight-flash {
            animation: flash 2s ease-in-out;
        }
        
        @keyframes flash {
            0%, 100% { background: transparent; }
            50% { background: rgba(245, 158, 11, 0.2); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    
    <!-- Inline checkAccess to avoid undefined error -->
    <script>
    function checkAccess() {
        var code = document.getElementById('accessCode').value.trim().toUpperCase();
        var rememberMe = document.getElementById('rememberMe') ? document.getElementById('rememberMe').checked : false;
        var errorEl = document.getElementById('accessError');
        var validCodes = ['BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003', 'BETA-VENUE-004', 'BETA-VENUE-005', 'FITZGERALD-TEST', 'DEMO-2025'];
        
        if (!code) {
            if (errorEl) {
                errorEl.textContent = 'Please enter an access code';
                errorEl.classList.remove('hidden');
            }
            return;
        }
        
        if (validCodes.includes(code)) {
            localStorage.setItem('fitzhr_access_code', code);
            if (rememberMe) {
                localStorage.setItem('fitzhr_remember_me', 'true');
            }
            localStorage.setItem('fitzhr_last_login', new Date().toISOString());
            
            var accessScreen = document.getElementById('accessScreen');
            var assistantScreen = document.getElementById('assistantScreen');
            if (accessScreen) accessScreen.classList.add('hidden');
            if (assistantScreen) assistantScreen.classList.remove('hidden');
            
            var userCodeEl = document.getElementById('userCode');
            if (userCodeEl) userCodeEl.textContent = code;
            
            window.currentUser = code;
            
            if (code === 'FITZGERALD-TEST' || code === 'DEMO-2025') {
                var adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.classList.remove('hidden');
            }
            
            if (typeof initConversationSystem === 'function') {
                initConversationSystem();
            }
        } else {
            if (errorEl) {
                errorEl.textContent = 'Invalid access code. Please check and try again.';
                errorEl.classList.remove('hidden');
            }
        }
    }
    </script>
    
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- CHATGPT-STYLE SIDEBAR -->
    <div id="chatSidebar" class="chat-sidebar closed">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="flex items-center gap-2">
                <h2 class="text-lg font-bold text-white" id="sidebarVenueName">Fitz</h2>
                <button onclick="openProfileMenu()" class="text-slate-400 hover:text-amber-400 transition-colors" title="Profile">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </button>
            </div>
            <button onclick="toggleSidebar()" class="sidebar-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- New Chat Button -->
        <button onclick="createNewChatFromSidebar()" class="sidebar-new-chat-btn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>New Chat</span>
        </button>
        
        <!-- Sidebar Content -->
        <div class="sidebar-content">
            <!-- Previous Chats Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Previous Chats</h3>
                <div id="sidebarChatsList" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No chats yet</p>
                </div>
            </div>
            
            <!-- Bookmarks Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Bookmarks</h3>
                <div id="sidebarBookmarksList" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No bookmarks yet</p>
                </div>
            </div>
            
            <!-- Recent Tools Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Recent Tools</h3>
                <div id="sidebarRecentTools" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No tools used yet</p>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Search</h3>
                <div class="px-3 py-2">
                    <input type="text" 
                           id="sidebarSearchInput" 
                           placeholder="Search conversations..."
                           class="w-full bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                           onkeyup="performSidebarSearch()">
                    <div id="sidebarSearchResults" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Logout Button - Bottom of Sidebar -->
            <div class="mt-auto pt-4 px-3 pb-3 border-t border-slate-700">
                <button onclick="logout()" 
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    
    <!-- WEEK 3: Search Modal -->
    <div id="searchModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üîç</span> Search Conversations
                </h2>
                <button onclick="closeSearchModal()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <input type="text" id="searchInput" placeholder="Search messages, topics, or keywords..." 
                   class="w-full bg-slate-700 border-2 border-slate-600 rounded-xl px-6 py-4 text-white text-lg focus:border-amber-500 focus:outline-none mb-6"
                   onkeyup="performSearch()">
            
            <div id="searchResults" class="space-y-3">
                <p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>
            </div>
        </div>
    </div>
    
    <!-- WEEK 3: Bookmarks Modal -->
    <div id="bookmarksModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>‚≠ê</span> Bookmarked Conversations
                </h2>
                <button onclick="closeBookmarksModal()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <div id="bookmarksList" class="space-y-3">
                <p class="text-slate-400 text-center py-8">No bookmarks yet. Star a conversation to save it here!</p>
            </div>
        </div>
    </div>
    
    <!-- WEEK 3: Multi-File Upload Modal -->
    <div id="multiFileModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìÅ</span> Upload Multiple Files
                    <span class="badge badge-new">NEW</span>
                </h2>
                <button onclick="closeMultiFileModal()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <div class="drag-drop-zone" id="dropZone" onclick="document.getElementById('multiFileInput').click()">
                <div class="text-6xl mb-4">üì§</div>
                <p class="text-xl font-semibold text-white mb-2">Drag & Drop Files Here</p>
                <p class="text-slate-400 mb-4">or click to browse</p>
                <p class="text-sm text-slate-500">Supports PDF, DOCX, XLSX, CSV (Max 10 files, 5MB each)</p>
                <input type="file" id="multiFileInput" multiple accept=".pdf,.docx,.xlsx,.csv" class="hidden" onchange="handleMultiFileSelect(event)">
            </div>
            
            <div id="filesList" class="mt-6"></div>
            
            <button id="processFilesBtn" onclick="processMultipleFiles()" disabled
                    class="w-full mt-6 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl transition-all">
                Process Files
            </button>
        </div>
    </div>
    
    <!-- WEEK 3: Enhanced Analytics Modal -->
    <div id="analyticsModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border-2 border-purple-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-purple-400 flex items-center gap-2">
                    <span>üìä</span> Analytics Dashboard
                    <span class="badge badge-new">ENHANCED</span>
                </h2>
                <button onclick="closeAnalyticsModal()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <!-- Chart Tabs -->
            <div class="flex gap-2 mb-6 border-b border-slate-700 pb-2">
                <button onclick="switchChart('usage')" class="chart-tab px-4 py-2 text-purple-400 border-b-2 border-purple-400 font-semibold" data-chart="usage">
                    Usage Over Time
                </button>
                <button onclick="switchChart('tools')" class="chart-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" data-chart="tools">
                    Tools Popularity
                </button>
                <button onclick="switchChart('engagement')" class="chart-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" data-chart="engagement">
                    Engagement
                </button>
            </div>
            
            <!-- Charts Container -->
            <div class="chart-container mb-6">
                <canvas id="analyticsChart"></canvas>
            </div>
            
            <button onclick="exportDetailedAnalytics()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-all">
                üì• Export Detailed Report (Excel)
            </button>
        </div>
    </div>
    
    <!-- Access Code Screen -->
<div id="accessScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-4xl w-full">
        <!-- Logo/Branding -->
        <div class="text-center mb-8 fade-in">
            <div class="inline-block bg-gradient-to-r from-amber-500 to-orange-600 p-1 rounded-2xl mb-4">
                <div class="bg-slate-900 px-8 py-4 rounded-xl">
                    <h1 class="text-3xl font-bold text-amber-500">FITZGERALD HR</h1>
                    <p class="text-slate-400 text-sm mt-1">AI-Powered Hospitality HR</p>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Beta Testing Programme</h2>
            <p class="text-slate-400">Thank you for helping us test Australia's first AI-powered hospitality HR assistant</p>
        </div>

        <!-- Main Content Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            
            <!-- Left Column: Access Code Form -->
            <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 fade-in">
                <label class="block text-slate-300 font-medium mb-3">Enter Your Access Code</label>
                <input 
                    type="text" 
                    id="accessCodeInput"
                    placeholder="e.g., BETA-VENUE-001"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 transition-all"
                    onkeypress="if(event.key==='Enter') checkAccess()"
                />

		<div class="mt-3">
    		   <label class="flex items-center gap-2 text-slate-300 text-sm cursor-pointer">
        		<input type="checkbox" id="rememberMe" checked 
               			class="w-4 h-4 text-amber-500 rounded border-slate-600 bg-slate-900 focus:ring-2 focus:ring-amber-500/20">
        		   <span>Remember me on this device</span>
    		   </label>
		</div>

                <button 
                    onclick="checkAccess()"
                    class="w-full mt-4 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105"
                >
                    Access Beta
                </button>
                <p id="accessError" class="text-red-400 text-sm mt-3 hidden"></p>
                
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <p class="text-slate-500 text-xs text-center">
                        Don't have an access code? Contact us at<br/>
                        <a href="/cdn-cgi/l/email-protection#90f2f5e4f1d0f6f9e4eaf7f5e2f1fcf4f8e2bef3fffdbef1e5" class="text-amber-500 hover:underline"><span class="__cf_email__" data-cfemail="93f1f6e7f2d3f5fae7e9f4f6e1f2fff7fbe1bdf0fcfebdf2e6">[email&#160;protected]</span></a>
                    </p>
                </div>
            </div>

            <!-- Right Column: Key Features -->
            <div class="space-y-4 fade-in">
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            ü§ñ
                        </div>
                        <div>
                            <h3 class="text-white font-bold">AI-Powered Guidance</h3>
                            <p class="text-slate-400 text-sm">Instant answers 24/7</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            üá¶üá∫
                        </div>
                        <div>
                            <h3 class="text-white font-bold">Australian Hospitality</h3>
                            <p class="text-slate-400 text-sm">Built for local venues</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            ‚ö°
                        </div>
                        <div>
                            <h3 class="text-white font-bold">24/7 Available</h3>
                            <p class="text-slate-400 text-sm">Always ready to help</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Social Proof Section - Streamlined -->
        <div class="bg-gradient-to-br from-amber-500/5 to-orange-600/5 border border-amber-500/30 rounded-2xl p-6 fade-in">
            <div class="text-center mb-4">
                <p class="text-amber-400 font-bold text-lg">Trusted by Australian Hospitality Venues</p>
                <p class="text-slate-400 text-sm mt-1">Real results from beta testers</p>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">$12k</p>
                        <p class="text-slate-400 text-xs mt-1">Avg. Annual Savings</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">&lt;90s</p>
                        <p class="text-slate-400 text-xs mt-1">Avg. Response Time</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">24/7</p>
                        <p class="text-slate-400 text-xs mt-1">Always Available</p>
                    </div>
                </div>
            </div>
            
            <!-- Testimonial Carousel - Compact -->
            <div id="testimonialCarousel" class="bg-slate-800/30 backdrop-blur-sm rounded-lg p-4 border border-slate-700/50">
                <div class="testimonial-slide flex items-center gap-4">
                    <div class="text-3xl flex-shrink-0">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <div class="flex-1">
                        <p class="text-slate-200 text-sm italic">
                            "Saved me $300 on a consultant call. Got my answer in 2 minutes instead of waiting days for a callback."
                        </p>
                        <p class="text-slate-500 text-xs mt-2">‚Äî Sarah M., Restaurant Owner, Melbourne</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Main Assistant Screen (Hidden Initially) -->
    <div id="assistantScreen" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-slate-800/80 backdrop-blur-sm border-b border-slate-700 px-4 md:px-6 py-3 md:py-4">
    <div class="max-w-5xl mx-auto">
        
        <!-- Mobile: Stacked Layout, Desktop: Side-by-side -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 md:gap-0">
            
            <!-- Left: Sidebar Toggle + Logo & Title -->
            <div class="flex items-center gap-3">
                <!-- Sidebar Toggle Button -->
                <button onclick="toggleSidebar()" class="sidebar-toggle-btn-header p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-xl">üè®</span>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-white">Fitz</h1>
                    <p class="text-xs text-slate-400">Beta - <span id="userCode"></span></p>
                </div>
            </div>

            <!-- Right: Simplified Buttons -->
            <div class="flex items-center gap-2 text-sm">
                
                <!-- Crisis Mode Button -->
                <button onclick="activateCrisisMode()" 
                        class="px-3 py-2 md:px-4 md:py-2 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold rounded-lg transition-all flex items-center gap-2 touch-manipulation">
                    <span class="text-lg md:text-xl">üö®</span>
                    <span class="hidden sm:inline">URGENT</span>
                </button>
                
                <!-- Divider (hidden on mobile) -->
                <div class="hidden md:block h-6 w-px bg-slate-600"></div>
                
                <!-- Secondary Buttons -->
                <div class="flex items-center gap-2">
                    <!-- Admin Button (hidden by default) -->
                    <button id="adminButton" onclick="showAdminDashboard()" 
                            class="hidden text-purple-400 hover:text-purple-300 font-medium transition-colors flex items-center gap-1 px-2 py-2 touch-manipulation">
                        <span>üìä</span>
                        <span class="hidden sm:inline">Admin</span>
                    </button>
                    
                    <!-- Tools Dropdown -->
                    <div class="relative">
                        <button onclick="toggleToolsMenu()" 
                                id="toolsButton"
                                class="text-amber-400 hover:text-amber-300 font-medium transition-colors flex items-center gap-1 px-2 py-2 touch-manipulation">
                            <span>üõ†Ô∏è</span>
                            <span class="hidden sm:inline">Tools</span>
                        </button>
                    </div>
                </div>
                
                <!-- Divider (hidden on mobile) -->
                <div class="hidden md:block h-6 w-px bg-slate-600"></div>
                
                <!-- Account Actions -->
                <div class="flex items-center gap-2">
                    
                </div>
                
            </div>
        </div>
    </div>
</div>

        <!-- Daily Tip Banner -->
<div id="dailyTipBanner" class="bg-blue-500/10 border-b border-blue-500/20 px-6 py-3 cursor-pointer hover:bg-blue-500/15 transition-all" onclick="rotateTipManually()">
    <div class="max-w-5xl mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 flex-1">
            <span class="text-lg" id="dailyTipIcon">üí°</span>
            <p class="text-blue-200 text-sm" id="dailyTipText">
                <strong>Daily Tip:</strong> <span id="dailyTipContent">Loading...</span>
            </p>
        </div>
        <button onclick="rotateTipManually(); event.stopPropagation();" 
                class="text-blue-300 hover:text-blue-100 text-xs px-3 py-1 bg-blue-500/20 rounded-lg transition-all">
            Next Tip ‚Üí
        </button>
    </div>
</div>

        <!-- Messages Container (Scrollable Area) -->
<div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-6">
    <div class="max-w-5xl mx-auto space-y-6">
        <!-- Messages will be added here dynamically -->
    </div>
</div>

<!-- Chat Input Area (ChatGPT Style) -->
<div class="bg-slate-800/80 backdrop-blur-sm border-t border-slate-700/50 px-6 py-4">
    <div class="max-w-3xl mx-auto">
        <div class="flex gap-2 items-end">
            <!-- Upload Button (+) -->
            <div class="relative">
                <!-- Hidden file inputs -->
                <input type="file" id="fileUploadInput" accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.txt" class="hidden" onchange="handleFileUpload(event)">
                <input type="file" id="imageUploadInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                
                <button onclick="toggleUploadMenu()" 
                        id="uploadButton"
                        class="p-3 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all touch-manipulation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
                
                <!-- Upload Menu Popup -->
                <div id="uploadMenu" class="hidden absolute bottom-full left-0 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl min-w-[200px] z-50">
                    <div class="p-2">
                        <button onclick="triggerFileUpload('file')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                            <span>üìÑ</span>
                            <span>Upload File</span>
                        </button>
                        <button onclick="triggerFileUpload('image')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                            <span>üñºÔ∏è</span>
                            <span>Upload Image</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Text Input -->
            <textarea id="messageInput" 
                placeholder="Ask me anything about hospitality HR in Australia..." 
                rows="1"
                class="flex-1 bg-slate-900 text-slate-100 border border-slate-700 rounded-xl px-4 py-3 text-base md:text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none max-h-32"
                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                oninput="autoResizeTextarea(this)"></textarea>
            
            <!-- Microphone Button (Right) -->
            <button onclick="toggleVoiceInput()" 
                    id="voiceButton"
                    title="Voice input"
                    class="p-3 text-slate-400 hover:text-amber-500 hover:bg-slate-700 rounded-lg transition-all touch-manipulation">
                <svg id="voiceIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </button>
            
            <!-- Send Button -->
            <button id="sendButton" onclick="sendMessage()" 
                    class="p-3 bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-slate-900 rounded-lg transition-all touch-manipulation">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
        
        <!-- Voice Recording Indicator -->
        <div id="voiceRecordingIndicator" class="hidden mt-3 flex items-center gap-2 text-sm text-amber-500">
            <div class="flex gap-1">
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></span>
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></span>
            </div>
            <span>Listening...</span>
            <button onclick="toggleVoiceInput()" class="ml-auto text-slate-400 hover:text-white text-xs underline">Stop</button>
        </div>
    </div>
</div>

<!-- Footer Disclaimer (Fixed at very bottom) -->
<div class="bg-slate-800/50 border-t border-slate-700/50 px-6 py-3">
    <div class="max-w-5xl mx-auto text-center">
        <p class="text-slate-400 text-xs mb-1">
            <span class="text-amber-400 font-semibold">‚ÑπÔ∏è Information Only:</span> 
            This tool provides general guidance. All documents require professional review before use.
        </p>
        <p class="text-slate-500 text-xs">
            Professional Advice: 
            <a href="/cdn-cgi/l/email-protection#f29b9c949db2949b8688959780939e969a80dc919d9fdc9387" class="text-slate-400 hover:text-amber-400 underline"><span class="__cf_email__" data-cfemail="96fff8f0f9d6f0ffe2ecf1f3e4f7faf2fee4b8f5f9fbb8f7e3">[email&#160;protected]</span></a> | 
            <a href="tel:+61400211014" class="text-slate-400 hover:text-amber-400 underline">+61 400 211 014</a> | 
            <a href="#terms" onclick="showTermsOfService(); return false;" class="text-slate-400 hover:text-amber-400 underline">Terms</a>
        </p>
    </div>
</div>

</div>
     
<!-- Hidden Netlify Form for Beta Feedback Collection -->
    <form name="beta-feedback" netlify netlify-honeypot="bot-field" hidden>
        <input type="hidden" name="bot-field" />
        <input type="text" name="user">
        <input type="text" name="rating">
        <textarea name="likes"></textarea>
        <textarea name="improve"></textarea>
        <input type="text" name="willPay">
    </form>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-slate-700 fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Beta Feedback</h2>
            <p class="text-slate-400 mb-6">Your feedback helps us build the best AI assistant for hospitality HR. Thank you!</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">How would you rate the AI's responses?</label>
                    <div class="flex gap-2">
                        <button onclick="setRating(1)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">1 ‚≠ê</button>
                        <button onclick="setRating(2)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">2 ‚≠ê</button>
                        <button onclick="setRating(3)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">3 ‚≠ê</button>
                        <button onclick="setRating(4)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">4 ‚≠ê</button>
                        <button onclick="setRating(5)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">5 ‚≠ê</button>
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What did you like?</label>
                    <textarea id="feedbackLikes" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What worked well for you?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What could be improved?</label>
                    <textarea id="feedbackImprove" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What would make this better?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Would you pay $49/month for this service?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="yes" class="text-amber-500">
                            <span>Yes, definitely</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="maybe" class="text-amber-500">
                            <span>Maybe</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="no" class="text-amber-500">
                            <span>No</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="submitFeedback()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                    Submit Feedback
                </button>
                <button onclick="closeFeedback()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Crisis Mode Modal -->
    <div id="crisisModal" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-4 border-red-500 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">üö®</div>
                <h2 class="text-3xl font-bold text-red-400 mb-2">CRISIS MODE ACTIVATED</h2>
                <p class="text-slate-300">Emergency HR support - Immediate response</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">What's the urgent situation?</label>
                    <select id="crisisType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white">
                        <option value="">Select crisis type...</option>
                        <option value="injury">Workplace Injury</option>
                        <option value="harassment">Sexual Harassment / Bullying</option>
                        <option value="theft">Theft / Serious Misconduct</option>
                        <option value="walkout">Employee Walkout / Strike</option>
                        <option value="discrimination">Discrimination Complaint</option>
                        <option value="violence">Workplace Violence / Threat</option>
                        <option value="death">Death / Medical Emergency</option>
                        <option value="other">Other Urgent Matter</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Describe what happened (be specific):</label>
                    <textarea id="crisisDescription" rows="4" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400"
                              placeholder="Provide details: who, what, when, where..."></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Your contact number for urgent callback:</label>
                    <input type="tel" id="crisisPhone" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                           placeholder="04XX XXX XXX">
                </div>
            </div>

            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4 mb-6">
                <p class="text-red-300 font-bold mb-2">üö® IMMEDIATE ACTIONS:</p>
                <ul class="text-red-200 text-sm space-y-1 ml-4">
                    <li>‚Ä¢ Document everything NOW (photos, witnesses, times)</li>
                    <li>‚Ä¢ Do NOT investigate yourself</li>
                    <li>‚Ä¢ Separate involved parties immediately</li>
                    <li>‚Ä¢ Preserve evidence / CCTV footage</li>
                    <li>‚Ä¢ Contact emergency services if needed (000)</li>
                </ul>
            </div>

            <div class="flex gap-3">
                <button onclick="submitCrisis()" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all text-lg">
                    üö® GET URGENT HELP NOW
                </button>
                <button onclick="closeCrisisModal()" 
                        class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Cancel
                </button>
            </div>

            <p class="text-center text-slate-400 text-sm mt-4">
                A Senior Consultant will contact you within 15 minutes
            </p>
        </div>
    </div>

    <!-- Award Calculator Modal -->
    <div id="awardCalculatorModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üí∞</span> Award Rate Calculator
                    </h2>
                    <p class="text-slate-400 text-sm">Calculate exact pay with penalties and loadings</p>
                </div>
                <button onclick="closeToolModal('awardCalculatorModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Position / Classification</label>
                        <select id="calcPosition" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
    <option value="24.28">Introductory - $24.28</option>
    <option value="24.95">Level 1 (Food & Beverage) - $24.95</option>
    <option value="25.85">Level 2 (Cook Grade 1) - $25.85</option>
    <option value="26.70">Level 3 (Cook Grade 2) - $26.70</option>
    <option value="28.12">Level 4 (Tradesperson) - $28.12</option>
    <option value="29.88">Level 5 (Supervisor) - $29.88</option>
    <option value="30.68">Level 6 (Senior) - $30.68</option>
    <option value="custom">Custom Rate</option>
</select>
                    </div>

                    <div id="customRateDiv" class="hidden">
                        <label class="block text-slate-300 text-sm mb-2">Custom Base Rate ($/hr)</label>
                        <input type="number" id="calcCustomRate" step="0.01" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm"
                               placeholder="28.50">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Day of Week</label>
                        <select id="calcDay" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                            <option value="1.0">Monday-Friday</option>
                            <option value="1.5">Saturday</option>
                            <option value="1.75">Sunday</option>
                            <option value="2.5">Public Holiday</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Hours Worked</label>
                        <input type="number" id="calcHours" step="0.5" value="8" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Overtime Hours</label>
                        <input type="number" id="calcOvertime" step="0.5" value="0" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>
                </div>

                <button onclick="calculateAward()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Calculate Pay
                </button>

                <div id="calcResults" class="hidden bg-slate-900 border border-amber-500 rounded-lg p-6">
                    <h3 class="text-amber-500 font-bold text-lg mb-4">Pay Breakdown:</h3>
                    <div class="space-y-2 text-slate-200">
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Base Rate:</span>
                            <span class="font-bold" id="resultBaseRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Penalty/Loading Rate:</span>
                            <span class="font-bold" id="resultPenaltyRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Ordinary Hours Pay:</span>
                            <span class="font-bold" id="resultOrdinaryPay"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700" id="overtimeRow">
                            <span>Overtime Pay (1.5x):</span>
                            <span class="font-bold" id="resultOvertimePay"></span>
                        </div>
                        <div class="flex justify-between py-3 bg-amber-500/10 px-3 rounded mt-3">
                            <span class="text-lg font-bold">TOTAL PAY:</span>
                            <span class="text-2xl font-bold text-amber-500" id="resultTotal"></span>
                        </div>
                    </div>
                    <button onclick="downloadCalculation()" 
                            class="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-all text-sm">
                        üìä Download Excel Breakdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Roster Optimizer Modal -->
    <div id="rosterOptimizerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
    		<span>üìã</span> Roster Cost Optimizer
		</h2>
                    <p class="text-slate-400 text-sm">Upload roster to analyze costs and optimize scheduling</p>
                </div>
                <button onclick="closeToolModal('rosterOptimizerModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                    <input type="file" id="rosterUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleRosterUpload(event)">
                    <button onclick="document.getElementById('rosterUpload').click()" 
                            class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                        üì§ Upload Current Roster
                    </button>
                    <p class="text-slate-400 text-sm mt-3">Supports Excel (.xlsx, .xls) or CSV files</p>
                </div>

                <div class="text-center text-slate-400">
                    <p class="mb-2">Or manually enter roster details:</p>
                    <button onclick="showManualRoster()" 
                            class="text-amber-500 hover:text-amber-400 underline">
                        Enter Roster Manually
                    </button>
                </div>

                <div id="rosterResults" class="hidden space-y-4">
                    <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                        <h3 class="text-green-500 font-bold text-lg mb-4">üìä Current Roster Analysis:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Labor Cost</p>
                                <p class="text-2xl font-bold text-white" id="rosterCurrentCost">$4,287</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Hours</p>
                                <p class="text-2xl font-bold text-white" id="rosterTotalHours">147 hrs</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm" id="rosterIssues"></div>
                    </div>

                    <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
                        <h3 class="text-amber-500 font-bold text-lg mb-4">‚ú® Optimized Roster:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Optimized Cost</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterOptimizedCost">$3,875</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Savings</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterSavings">$412</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-slate-300" id="rosterOptimizations"></div>
                        
                        <button onclick="downloadOptimizedRoster()" 
                                class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                            üì• Download Optimized Roster
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Termination Risk Assessor Modal -->
    <div id="terminationRiskModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>‚öñÔ∏è</span> Termination Risk Assessor
                    </h2>
                    <p class="text-slate-400 text-sm">Assess unfair dismissal risk before terminating employment</p>
                </div>
                <button onclick="closeToolModal('terminationRiskModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <form id="terminationForm" class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">How long has the employee worked for you?</label>
                    <select id="termTenure" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="under6months">Under 6 months</option>
                        <option value="6to12months">6-12 months</option>
                        <option value="over12months">Over 12 months</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Reason for termination:</label>
                    <select id="termReason" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="performance">Poor Performance</option>
                        <option value="misconduct">Misconduct</option>
                        <option value="serious-misconduct">Serious Misconduct</option>
                        <option value="redundancy">Redundancy</option>
                        <option value="incompatibility">Not a Good Fit</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Have you given formal warnings?</label>
                    <select id="termWarnings" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="none">No warnings given</option>
                        <option value="verbal">Verbal warning only</option>
                        <option value="written">Written warning(s) given</option>
                        <option value="final">Final written warning given</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Did you provide opportunity to improve?</label>
                    <select id="termImprovement" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="no">No</option>
                        <option value="informal">Informal discussions only</option>
                        <option value="formal">Formal improvement plan with timeframe</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Is the employee in any protected category?</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termPregnant" class="rounded">
                            <span>Pregnant or on parental leave</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termInjured" class="rounded">
                            <span>Recently injured or on workers comp</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termComplaint" class="rounded">
                            <span>Made workplace complaint recently</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termUnion" class="rounded">
                            <span>Union member or delegate</span>
                        </label>
                    </div>
                </div>

                <button type="button" onclick="assessTerminationRisk()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Assess Risk
                </button>
            </form>

            <div id="termRiskResults" class="hidden mt-6"></div>
        </div>
    </div>

    <!-- Scenario Analysis Modal -->
    <div id="scenarioAnalysisModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üéØ</span> Custom Scenario Analysis
                    </h2>
                    <p class="text-slate-400 text-sm">Get tailored advice for your specific situation</p>
                </div>
                <button onclick="closeToolModal('scenarioAnalysisModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">Tell me about your venue:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="scenarioVenueType" placeholder="e.g., Restaurant, Hotel, Caf√©" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                        <input type="text" id="scenarioLocation" placeholder="e.g., Sydney CBD" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Number of employees:</label>
                    <input type="number" id="scenarioStaffCount" placeholder="e.g., 15" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Describe your situation in detail:</label>
                    <textarea id="scenarioDescription" rows="6" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white text-sm placeholder-slate-400"
                              placeholder="Be as specific as possible: What's the issue? What's the context? What have you tried? What are your concerns?"></textarea>
                </div>

                <button onclick="analyzeScenario()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Generate Custom Analysis
                </button>

                <div id="scenarioResults" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Xero Integration Modal -->
    <div id="xeroIntegrationModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üîó</span> Xero Payroll Integration
                    </h2>
                    <p class="text-slate-400 text-sm">Connect to Xero for automatic payroll analysis</p>
                </div>
                <button onclick="closeToolModal('xeroIntegrationModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div id="xeroNotConnected" class="space-y-6">
                <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-6">
                    <h3 class="text-blue-400 font-bold mb-3">What You'll Get:</h3>
                    <ul class="space-y-2 text-slate-300 text-sm">
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Automatic labor cost analysis</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Overtime and penalty rate tracking</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Cost trend alerts</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Compliance risk detection</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 text-center">
                    <p class="text-slate-300 mb-4">Connect your Xero account securely:</p>
                    <button onclick="connectXero()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-all inline-flex items-center gap-2">
                        <span>üîó</span>
                        <span>Connect to Xero</span>
                    </button>
                    <p class="text-slate-500 text-xs mt-3">Secure OAuth 2.0 connection</p>
                </div>
            </div>

            <div id="xeroConnected" class="hidden space-y-4">
                <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-center">
                    <p class="text-green-400 font-bold">‚úì Connected to Xero</p>
                </div>
                <div class="space-y-3" id="xeroAnalysis"></div>
            </div>
        </div>
    </div>

<!-- ========================================== -->
<!-- VENUE ONBOARDING MODAL -->
<!-- ========================================== -->

<div id="venueOnboardingModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-2 border-amber-500 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üè®</div>
            <h2 class="text-3xl font-bold text-amber-500 mb-2">Let's Get to Know Your Venue</h2>
            <p class="text-slate-300">This helps me give you tailored advice. Takes 2 minutes.</p>
        </div>

        <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-400">Step <span id="onboardingStep">1</span> of 5</span>
                <span class="text-sm text-amber-400" id="onboardingProgress">20% Complete</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="onboardingProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 20%"></div>
            </div>
        </div>

        <div id="onboardingStepContent" class="space-y-6">
            <div class="onboarding-step" data-step="1">
                <h3 class="text-xl font-bold text-white mb-4">First, let's get your details</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Your Name</label>
                        <input type="text" id="onboardingUserName" 
                               placeholder="e.g., Sarah Johnson"
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Venue Name</label>
                        <input type="text" id="onboardingVenueName" 
                               placeholder="e.g., The Golden Fork"
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                </div>
                <button onclick="saveOnboardingNameAndVenue()" 
                        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Next ‚Üí
                </button>
            </div>

            <div class="onboarding-step hidden" data-step="2">
                <h3 class="text-xl font-bold text-white mb-4">What type of venue do you run?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveOnboardingAnswer('venueType', 'restaurant')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üçΩÔ∏è</div>
                        <div class="font-semibold">Restaurant</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('venueType', 'cafe')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">‚òï</div>
                        <div class="font-semibold">Caf√©</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('venueType', 'hotel')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üè®</div>
                        <div class="font-semibold">Hotel/Pub</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('venueType', 'fastfood')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üçî</div>
                        <div class="font-semibold">Fast Food</div>
                    </button>
                </div>
            </div>

            <div class="onboarding-step hidden" data-step="3">
                <h3 class="text-xl font-bold text-white mb-4">Where is your venue located?</h3>
                <select id="onboardingLocation" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
                    <option value="">Select state...</option>
                    <option value="NSW">New South Wales</option>
                    <option value="VIC">Victoria</option>
                    <option value="QLD">Queensland</option>
                    <option value="SA">South Australia</option>
                    <option value="WA">Western Australia</option>
                    <option value="TAS">Tasmania</option>
                    <option value="NT">Northern Territory</option>
                    <option value="ACT">Australian Capital Territory</option>
                </select>
                <input type="text" id="onboardingCity" placeholder="City/Suburb" 
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
                <button onclick="saveOnboardingLocation()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Next ‚Üí
                </button>
            </div>

            <div class="onboarding-step hidden" data-step="4">
                <h3 class="text-xl font-bold text-white mb-4">How many staff do you have?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveOnboardingAnswer('staffCount', '1-5')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üë§</div>
                        <div class="font-semibold">1-5 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '6-15')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üë•</div>
                        <div class="font-semibold">6-15 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '16-30')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="font-semibold">16-30 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '30+')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">üè¢</div>
                        <div class="font-semibold">30+ staff</div>
                    </button>
                </div>
            </div>

            <div class="onboarding-step hidden" data-step="5">
                <h3 class="text-xl font-bold text-white mb-4">Which award covers most of your staff?</h3>
                <div class="space-y-3">
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Hospitality Industry (General) Award')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Hospitality Industry (General) Award</div>
                        <div class="text-xs opacity-70">Restaurants, caf√©s, hotels, pubs</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Fast Food Industry Award')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Fast Food Industry Award</div>
                        <div class="text-xs opacity-70">QSR, takeaway, delivery</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Not sure')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">ü§∑ Not sure</div>
                    </button>
                </div>
            </div>

            <div class="onboarding-step hidden" data-step="6">
                <h3 class="text-xl font-bold text-white mb-4">What's your biggest HR challenge?</h3>
                <div class="space-y-2">
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'rostering', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">üìÖ Rostering & compliance</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'awards', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">üí∞ Understanding award rates</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'performance', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">üìä Performance management</div>
                    </button>
                </div>
            </div>
        </div>

        <button onclick="skipOnboarding()" class="mt-4 text-slate-400 hover:text-white text-sm">
            Skip for now ‚Üí
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- VENUE SETTINGS MODAL -->
<!-- ========================================== -->

<div id="venueSettingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> Venue Settings
                </h2>
                <p class="text-slate-400 text-sm">Update your venue information</p>
            </div>
            <button onclick="closeVenueSettings()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div id="venueSettingsContent" class="space-y-4"></div>

        <div class="flex gap-3 mt-6">
            <button onclick="saveVenueSettings()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                üíæ Save Changes
            </button>
            <button onclick="closeVenueSettings()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- ADMIN ANALYTICS DASHBOARD -->
<!-- ========================================== -->

<div id="adminDashboardModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50 overflow-y-auto">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border-2 border-purple-500 fade-in my-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-3xl font-bold text-purple-400 flex items-center gap-2">
                    <span>üìä</span> Admin Analytics Dashboard
                </h2>
                <p class="text-slate-400 text-sm">Real-time user activity and conversation insights</p>
            </div>
            <button onclick="closeAdminDashboard()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Total Users</p>
                <p class="text-3xl font-bold text-purple-400" id="statTotalUsers">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Total Messages</p>
                <p class="text-3xl font-bold text-purple-400" id="statTotalMessages">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Active Today</p>
                <p class="text-3xl font-bold text-purple-400" id="statActiveToday">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Avg Session</p>
                <p class="text-3xl font-bold text-purple-400" id="statAvgSession">0m</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-slate-700">
            <button onclick="switchAdminTab('conversations')" 
                    class="admin-tab px-4 py-2 text-purple-400 border-b-2 border-purple-400 font-semibold" 
                    data-tab="conversations">
                üí¨ Conversations
            </button>
            <button onclick="switchAdminTab('themes')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="themes">
                üéØ Popular Themes
            </button>
            <button onclick="switchAdminTab('users')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="users">
                üë• User Profiles
            </button>
            <button onclick="switchAdminTab('highrisk')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="highrisk">
                üö® High-Risk Topics
            </button>
	    <button onclick="switchAdminTab('documents')" 
        	class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
        	data-tab="documents">
    	     üìù Generated Documents
	    </button>
        </div>

<!-- Tab Content -->
<div id="adminTabContent" class="min-h-[400px] max-h-[500px] overflow-y-auto">
    <!-- Conversations Tab -->
    <div id="adminConversationsTab" class="admin-tab-content">
        <div class="bg-slate-900 rounded-lg p-4 mb-4">
            <input type="text" id="conversationSearch" placeholder="üîç Search conversations..." 
                   onkeyup="filterConversations()"
                   class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
        </div>
        <div id="conversationsList" class="space-y-3"></div>
    </div>

    <!-- Themes Tab -->
    <div id="adminThemesTab" class="admin-tab-content hidden">
        <div id="themesList" class="space-y-3"></div>
    </div>

    <!-- Users Tab -->
    <div id="adminUsersTab" class="admin-tab-content hidden">
        <div id="usersList" class="space-y-3"></div>
    </div>

    <!-- High-Risk Tab -->
    <div id="adminHighRiskTab" class="admin-tab-content hidden">
        <div id="highRiskList" class="space-y-3"></div>
    </div>

    <!-- Documents Tab -->
    <div id="adminDocumentsTab" class="admin-tab-content hidden">
        <div id="documentsList" class="space-y-3"></div>
    </div>
</div>

        <!-- Export Button -->
        <div class="mt-6 flex gap-3">
            <button onclick="exportAnalytics()" 
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-all">
                üì• Export Analytics (Excel)
            </button>
            <button onclick="refreshAnalytics()" 
                    class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                üîÑ Refresh
            </button>
            <button onclick="closeAdminDashboard()" 
                    class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                Close
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MOBILE TOOLS MENU MODAL -->
<!-- ========================================== -->
<div id="mobileToolsModal" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="w-full h-full flex flex-col">
        <!-- Header -->
        <div class="bg-slate-800 border-b border-slate-700 p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-amber-500 flex items-center gap-2">
                <span>üõ†Ô∏è</span> Tools
            </h2>
            <button onclick="closeMobileTools()" class="text-slate-400 hover:text-white text-2xl p-2">
                √ó
            </button>
        </div>
        
        <!-- Tools List -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="space-y-2 max-w-2xl mx-auto">
                <button onclick="openToolFromMobile('awardWizard')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üßô</span>
                    <div>
                        <div class="font-semibold">Award Wizard</div>
                        <div class="text-sm text-slate-400">Interactive award classification</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('rosterStressTester')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üîç</span>
                    <div>
                        <div class="font-semibold">Roster Stress Test</div>
                        <div class="text-sm text-slate-400">Test roster for compliance issues</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('complianceCalendar')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üìÖ</span>
                    <div>
                        <div class="font-semibold">Compliance Calendar</div>
                        <div class="text-sm text-slate-400">Track important HR dates</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('awardCalculator')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üí∞</span>
                    <div>
                        <div class="font-semibold">Award Calculator</div>
                        <div class="text-sm text-slate-400">Calculate award rates instantly</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('documentBuilder')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üìù</span>
                    <div>
                        <div class="font-semibold">Document Builder</div>
                        <div class="text-sm text-slate-400">Create HR documents</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('rosterOptimizer')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üìã</span>
                    <div>
                        <div class="font-semibold">Roster Optimiser</div>
                        <div class="text-sm text-slate-400">Optimize staff scheduling</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('terminationRisk')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">‚öñÔ∏è</span>
                    <div>
                        <div class="font-semibold">Termination Risk</div>
                        <div class="text-sm text-slate-400">Assess termination risks</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('scenarioAnalysis')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üéØ</span>
                    <div>
                        <div class="font-semibold">Scenario Analysis</div>
                        <div class="text-sm text-slate-400">Analyze HR scenarios</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('xeroIntegration')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">üîó</span>
                    <div>
                        <div class="font-semibold">Xero Integration</div>
                        <div class="text-sm text-slate-400">Connect with Xero</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: AWARD WIZARD -->
<!-- ========================================== -->

<div id="awardWizardModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div id="awardWizardContainer" class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üßô</span> Award Wizard
                </h2>
                <p class="text-slate-400 text-sm">Interactive award classification - find the right pay rate</p>
            </div>
            <button onclick="closeToolModal('awardWizardModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Step Progress -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-400">Step <span id="wizardCurrentStep">1</span> of 6</span>
                <span class="text-sm text-amber-400" id="wizardProgress">20% Complete</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="wizardProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 20%"></div>
            </div>
        </div>

        <!-- Wizard Steps -->
        <div id="wizardSteps" class="space-y-6">
            
            <!-- Step 1: Industry -->
            <div class="wizard-step" data-step="1">
                <h3 class="text-lg font-bold text-white mb-4">What type of venue is it?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="wizardAnswer('venue', 'restaurant')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçΩÔ∏è</div>
                        <div class="font-semibold">Restaurant</div>
                        <div class="text-xs text-slate-400">Dine-in service</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'cafe')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">‚òï</div>
                        <div class="font-semibold">Caf√©</div>
                        <div class="text-xs text-slate-400">Coffee & light meals</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'hotel')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üè®</div>
                        <div class="font-semibold">Hotel/Pub</div>
                        <div class="text-xs text-slate-400">Accommodation or pub</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'fastfood')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçî</div>
                        <div class="font-semibold">Fast Food</div>
                        <div class="text-xs text-slate-400">Quick service</div>
                    </button>
                </div>
            </div>

            <!-- Step 2: Role -->
<div class="wizard-step hidden" data-step="2">
    <h3 class="text-lg font-bold text-white mb-4">What's their role?</h3>
    <div class="space-y-2">
        <!-- Food & Beverage -->
        <button onclick="wizardAnswer('role', 'waiter')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üëî</span>
            <div>
                <div class="font-semibold">Waiter / Food & Beverage Attendant</div>
                <div class="text-xs opacity-70">Takes orders, serves food & drinks</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'bartender')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üç∏</span>
            <div>
                <div class="font-semibold">Bartender</div>
                <div class="text-xs opacity-70">Makes and serves drinks at bar</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'barista')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">‚òï</span>
            <div>
                <div class="font-semibold">Barista</div>
                <div class="text-xs opacity-70">Makes coffee & beverages</div>
            </div>
        </button>
        
        <!-- Kitchen -->
        <button onclick="wizardAnswer('role', 'cook')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üë®‚Äçüç≥</span>
            <div>
                <div class="font-semibold">Cook / Chef</div>
                <div class="text-xs opacity-70">Prepares food in kitchen</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'kitchen-hand')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üßπ</span>
            <div>
                <div class="font-semibold">Kitchen Hand / Dishwasher</div>
                <div class="text-xs opacity-70">Cleaning, prep work</div>
            </div>
        </button>
        
        <!-- Management -->
        <button onclick="wizardAnswer('role', 'supervisor')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üëî</span>
            <div>
                <div class="font-semibold">Supervisor / Shift Manager</div>
                <div class="text-xs opacity-70">Manages team & operations</div>
            </div>
        </button>
        
        <!-- Front of House -->
        <button onclick="wizardAnswer('role', 'receptionist')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üìû</span>
            <div>
                <div class="font-semibold">Receptionist / Front Desk</div>
                <div class="text-xs opacity-70">Check-in, guest services</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'housekeeper')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üõèÔ∏è</span>
            <div>
                <div class="font-semibold">Housekeeper / Room Attendant</div>
                <div class="text-xs opacity-70">Cleans rooms, maintains facilities</div>
            </div>
        </button>
        
        <!-- Other -->
        <button onclick="wizardAnswer('role', 'security')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üõ°Ô∏è</span>
            <div>
                <div class="font-semibold">Security / Door Person</div>
                <div class="text-xs opacity-70">Venue security, crowd control</div>
            </div>
        </button>
    </div>
</div>

            <!-- Step 3: Experience -->
            <div class="wizard-step hidden" data-step="3">
                <h3 class="text-lg font-bold text-white mb-4">What's their experience level?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('experience', 'intro')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Introductory / No experience</div>
                        <div class="text-xs opacity-70">Just starting out, learning basics</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level1')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 1 - Basic skills</div>
                        <div class="text-xs opacity-70">Can perform routine tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level2')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 2 - Competent</div>
                        <div class="text-xs opacity-70">Works independently, some variety</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level3')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 3 - Advanced</div>
                        <div class="text-xs opacity-70">Skilled, handles complex tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level4')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 4 - Supervisor/Trade</div>
                        <div class="text-xs opacity-70">Manages others or trade qualified</div>
                    </button>
                </div>
            </div>

            <!-- Step 4: Hours -->
            <div class="wizard-step hidden" data-step="4">
                <h3 class="text-lg font-bold text-white mb-4">What hours do they typically work?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('hours', 'weekday-day')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Daytime</div>
                        <div class="text-xs opacity-70">Regular business hours</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'weekday-night')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Evenings/Nights</div>
                        <div class="text-xs opacity-70">After 7pm or late shifts</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'saturday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Saturdays</div>
                        <div class="text-xs opacity-70">Weekend penalty rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'sunday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Sundays</div>
                        <div class="text-xs opacity-70">Higher penalty rates</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'public-holiday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Public Holidays</div>
                        <div class="text-xs opacity-70">Highest penalty rates</div>
                    </button>
                </div>
            </div>

            <!-- Step 5: Age Category (NEW) -->
<div class="wizard-step hidden" data-step="5">
    <h3 class="text-lg font-bold text-white mb-4">How old is the employee?</h3>
    <div class="space-y-2">
        <button onclick="wizardAnswer('age', 'adult')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">20 years or older</div>
            <div class="text-xs opacity-70">Adult rates apply</div>
        </button>
        <button onclick="wizardAnswer('age', 'junior')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">19 years or younger</div>
            <div class="text-xs opacity-70">Junior rates apply (percentage of adult rate)</div>
        </button>
    </div>
</div>

<!-- Step 6: Employment Type -->
<div class="wizard-step hidden" data-step="6">
    <h3 class="text-lg font-bold text-white mb-4">What type of employment?</h3>
    <div class="space-y-2">
        <button onclick="wizardAnswer('employment', 'casual')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Casual</div>
            <div class="text-xs opacity-70">25% loading, no leave entitlements</div>
        </button>
        <button onclick="wizardAnswer('employment', 'part-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Part-Time</div>
            <div class="text-xs opacity-70">Regular hours, pro-rata leave</div>
        </button>
        <button onclick="wizardAnswer('employment', 'full-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Full-Time</div>
            <div class="text-xs opacity-70">38 hours/week, full entitlements</div>
        </button>
    </div>
</div>

        <!-- Results (hidden initially) -->
        <div id="wizardResults" class="hidden mt-6">
            <div class="bg-green-500/10 border-2 border-green-500 rounded-lg p-6">
                <h3 class="text-green-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>‚úÖ</span>
                    <span>Award Classification Complete!</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Applicable Award</p>
                        <p class="font-bold text-lg" id="resultAward"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Classification Level</p>
                            <p class="font-bold" id="resultLevel"></p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Base Rate (per hour)</p>
                            <p class="font-bold text-2xl text-amber-400" id="resultRate"></p>
                        </div>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Penalty Rates & Loadings:</p>
                        <div id="resultPenalties" class="text-sm space-y-1"></div>
                    </div>

                    <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4">
                        <p class="font-semibold text-blue-400 mb-2">üìù Next Steps:</p>
                        <ul class="text-sm space-y-1" id="resultNextSteps"></ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="downloadWizardResults()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                        üìÑ Download Summary
                    </button>
                    <button onclick="resetWizard()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                        Start Over
                    </button>
                </div>
            </div>
        </div>

        <!-- Back button (shown after step 1) -->
        <button id="wizardBackBtn" onclick="wizardGoBack()" class="hidden mt-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2">
            <span>‚Üê</span>
            <span>Go Back</span>
        </button>
    </div>
</div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: ROSTER STRESS TESTER -->
<!-- ========================================== -->

<div id="rosterStressTesterModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üîç</span> Roster Stress Test
                </h2>
                <p class="text-slate-400 text-sm">Upload or describe your roster - we'll find compliance risks</p>
            </div>
            <button onclick="closeToolModal('rosterStressTesterModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div class="space-y-6">
            <!-- Upload Option -->
            <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                <input type="file" id="rosterStressUpload" accept=".xlsx,.xls,.csv,.pdf" class="hidden" onchange="analyzeRosterFile(event)">
                <button onclick="document.getElementById('rosterStressUpload').click()" 
                        class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all mb-3">
                    üì§ Upload Roster
                </button>
                <p class="text-slate-400 text-sm">Supports Excel, CSV, or PDF</p>
            </div>

            <div class="text-center text-slate-400">
                <p class="mb-2">Or describe your roster:</p>
            </div>

            <!-- Manual Input Option -->
            <div class="bg-slate-900 rounded-lg p-6">
                <label class="block text-slate-300 font-medium mb-3">Tell me about your current roster:</label>
                <textarea id="rosterDescription" rows="6" 
                          class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500"
                          placeholder="Example: 
- John works Mon-Sat (6 days straight)
- Sarah: 7-hour shift with no break
- Mike: 52 hours this week
- All staff work Sundays regularly

Be as specific as possible!"></textarea>
                <button onclick="analyzeRosterDescription()" 
                        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    üîç Run Stress Test
                </button>
            </div>

            <!-- Results -->
            <div id="rosterStressResults" class="hidden space-y-4"></div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: COMPLIANCE CALENDAR -->
<!-- ========================================== -->

<div id="complianceCalendarModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìÖ</span> Compliance Calendar
                </h2>
                <p class="text-slate-400 text-sm">Upcoming deadlines & proactive compliance alerts</p>
            </div>
            <button onclick="closeToolModal('complianceCalendarModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Upcoming Alerts -->
        <div class="space-y-4 mb-6">
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üö®</span>
                    <div class="flex-1">
                        <p class="font-bold text-red-400">URGENT: Award Rate Increase</p>
                        <p class="text-sm text-slate-300 mt-1">Hospitality Award rates increase on 1 July 2026 </p>
                        <p class="text-xs text-slate-400 mt-2">Action: Update payroll systems & review all employment contracts</p>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-500/10 border-2 border-yellow-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div class="flex-1">
                        <p class="font-bold text-yellow-400">Casual Conversion Review Due</p>
                        <p class="text-sm text-slate-300 mt-1">Review all casual staff (12+ months) for conversion rights</p>
                        <p class="text-xs text-slate-400 mt-2">Deadline: Within 2 weeks</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-500/10 border-2 border-blue-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üìã</span>
                    <div class="flex-1">
                        <p class="font-bold text-blue-400">Sexual Harassment Policy Update</p>
                        <p class="text-sm text-slate-300 mt-1">New Respect@Work legislation requires policy updates</p>
                        <p class="text-xs text-slate-400 mt-2">Recommended: Complete by end of month</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personalized Reminders -->
        <div class="bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                <span>üîî</span>
                <span>Set Up Custom Reminders</span>
            </h3>
            
            <div class="space-y-3">
                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Award rate updates</p>
                        <p class="text-xs text-slate-400">Notify 2 weeks before changes</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Casual conversion reviews</p>
                        <p class="text-xs text-slate-400">Monthly reminder to check eligibility</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Public holiday notifications</p>
                        <p class="text-xs text-slate-400">Alert 1 week before each public holiday</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Annual leave accrual warnings</p>
                        <p class="text-xs text-slate-400">Alert when staff exceed 8 weeks leave</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Policy review reminders</p>
                        <p class="text-xs text-slate-400">Annual workplace policy updates</p>
                    </div>
                </label>
            </div>

            <button onclick="saveComplianceSettings()" 
                    class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                üíæ Save Reminder Settings
            </button>
        </div>

        <!-- Calendar View -->
        <div class="mt-6 bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4">üìÖ Upcoming Compliance Dates</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">1 July 2026</span>
                    <span class="text-amber-400">Award Rate Increase</span>
                </div>
		<div class="flex justify-between py-2 border-b border-slate-700">
   		 <span class="text-slate-300">25 April 2026</span>
   		 <span class="text-amber-400">ANZAC Day (Public Holiday)</span>
		</div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">26 January 2026</span>
                    <span class="text-amber-400">Australia Day (Public Holiday)</span>
                </div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">Monthly</span>
                    <span class="text-amber-400">Casual Conversion Review</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-slate-300">Quarterly</span>
                    <span class="text-amber-400">WHS Policy Review</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Builder Modal -->
<div id="documentBuilderModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìù</span> Document Builder
                </h2>
                <p class="text-slate-400 text-sm">AI-powered HR document generation</p>
            </div>
            <button onclick="closeToolModal('documentBuilderModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

<!-- Template Selection Screen -->
<div id="documentTemplateSelection" class="space-y-4">
    <p class="text-slate-300 mb-4">Choose a document type:</p>
    
    <!-- 1. Record of Discussion - GREEN -->
    <button onclick="selectDocumentType('recordOfDiscussion')" 
        class="w-full text-left p-6 bg-slate-700 hover:bg-green-600 rounded-lg transition-all border-2 border-transparent hover:border-green-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">üìã</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Record of Discussion Template & Script</h3>
                <p class="text-slate-300 text-sm mb-2">For: For behaviour and minor misconduct concerns</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Template + Script</span>
                    <span class="text-slate-500 text-xs">‚Ä¢ 3 quick questions ‚Ä¢ Manager conversation guide</span>
                </div>
            </div>
        </div>
    </button>


    <!-- 2. Performance Improvement Plan - BLUE (NEW) -->
    <button onclick="selectDocumentType('performanceImprovementPlan')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-blue-600 rounded-lg transition-all border-2 border-transparent hover:border-blue-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">üìä</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Performance Improvement Plan (PIP)</h3>
                <p class="text-slate-300 text-sm mb-2">For: Structured 12-week performance improvement process</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">12-Week Process</span>
                    <span class="text-slate-500 text-xs">‚Ä¢ 8 questions ‚Ä¢ SMART goals ‚Ä¢ Weekly check-ins</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 3. Letter of Allegation - AMBER (MOVED TO 2ND) -->
    <button onclick="selectDocumentType('letterOfAllegation')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-amber-600 rounded-lg transition-all border-2 border-transparent hover:border-amber-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">üîç</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Letter of Allegation</h3>
                <p class="text-slate-300 text-sm mb-2">For: Serious misconduct requiring investigation</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded font-bold">HIGH RISK</span>
                    <span class="text-slate-500 text-xs">‚Ä¢ 6 questions ‚Ä¢ Consultant review required</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 4. Formal Warning - LIGHTER RED (MOVED TO 3RD) -->
    <button onclick="selectDocumentType('formalWarning')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-orange-600 rounded-lg transition-all border-2 border-transparent hover:border-orange-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">‚ö†Ô∏è</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Formal Warning Letter</h3>
                <p class="text-slate-300 text-sm mb-2">For: Performance/conduct issues requiring formal action</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded">Medium Risk</span>
                    <span class="text-slate-500 text-xs">‚Ä¢ 7 questions ‚Ä¢ AI-enhanced</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 5. Termination Process - DARK RED (NEW) -->
    <button onclick="showTerminationConsultantRequired()" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-red-700 rounded-lg transition-all border-2 border-transparent hover:border-red-600">
        <div class="flex items-start gap-4">
            <div class="text-4xl">üö®</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Termination Process</h3>
                <p class="text-slate-300 text-sm mb-2">For: Employment termination - requires expert guidance</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-red-600/30 text-red-300 text-xs rounded font-bold">CRITICAL RISK</span>
                    <span class="text-slate-500 text-xs">‚Ä¢ Senior Consultant required ‚Ä¢ Full compliance review</span>
                </div>
            </div>
        </div>
    </button>

    <div class="mt-6 bg-amber-500/10 border border-amber-500 rounded-lg p-4">
        <p class="text-amber-300 text-sm">
            <strong>‚ö†Ô∏è Important:</strong> All generated documents must be reviewed by a Fitzgerald HR consultant before use.
        </p>
    </div>
</div>

        <!-- Wizard Steps (Hidden initially) -->
        <div id="documentWizardSteps" class="hidden">
            <!-- Progress bar -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-400">Step <span id="docCurrentStep">1</span> of <span id="docTotalSteps">7</span></span>
                    <span class="text-sm text-amber-400" id="docProgress">14% Complete</span>
                </div>
                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="docProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 14%"></div>
                </div>
            </div>

            <!-- Step content container -->
            <div id="documentStepContent"></div>

            <!-- Navigation buttons -->
		<div class="flex gap-3 mt-6">
    		<button id="docBackBtn" onclick="docWizardGoBack()" 
            class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
        ‚Üê Back
   		</button>
    		<button id="docNextBtn" onclick="docWizardNext()" 
            class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
        Next Step ‚Üí
    		</button>
    		<button id="docStartOverBtn" onclick="resetDocumentBuilder()" 
            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all">
        üîÑ Start Over
    		</button>
	    </div>
        </div>

        <!-- AI Generation Loading -->
        <div id="documentGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ü§ñ</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your document...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div id="documentPreviewModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl max-w-5xl w-full border-2 border-amber-500 fade-in max-h-[90vh] flex flex-col">
        
        <!-- Header -->
        <div class="p-6 border-b border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">üìÑ Preview Your Document</h2>
                    <p class="text-slate-400 text-sm mt-1">Review carefully before downloading</p>
                </div>
                <button onclick="closeDocumentPreview()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
        </div>

        <!-- Document Content (scrollable) -->
        <div class="flex-1 overflow-y-auto p-8 bg-white">
            <div id="documentPreviewContent" class="max-w-3xl mx-auto prose prose-slate" 
                 style="font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.8; color: #000;">
                <!-- AI-generated document appears here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="p-6 border-t border-slate-700 bg-slate-800">
            <div class="flex gap-3 mb-4 flex-wrap">
    
    <!-- Download Options -->
    <div class="flex gap-2 flex-1">
        <button onclick="downloadGeneratedDocument('pdf')" 
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>üìÑ</span>
            <span>Download PDF</span>
        </button>
        <button onclick="downloadGeneratedDocument('docx')" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>üìù</span>
            <span>Download Word</span>
        	</button>
    	     </div>
	</div>
            
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                <p class="text-red-300 font-bold text-sm flex items-center gap-2 mb-2">
                    <span>‚ö†Ô∏è</span>
                    <span>CRITICAL: This document MUST be reviewed by a consultant before use</span>
                </p>
                <p class="text-red-200 text-xs">
                    Contact: <a href="/cdn-cgi/l/email-protection#f39a9d959cb3959a8789949681929f979b81dd909c9edd9286" class="underline hover:text-red-100"><span class="__cf_email__" data-cfemail="2f464149406f49465b55484a5d4e434b475d014c4042014e5a">[email&#160;protected]</span></a> | +61 400 211 014
                </p>
            </div>
        </div>

    </div>
</div>

<!-- Termination Consultant Required Modal -->
<div id="terminationConsultantModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border-4 border-red-600 fade-in max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üö®</div>
            <h2 class="text-3xl font-bold text-red-400 mb-2">Senior Consultant Required</h2>
            <p class="text-slate-300">Termination is the highest-risk HR decision</p>
        </div>

        <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-6 mb-6">
            <h3 class="text-red-300 font-bold mb-3 flex items-center gap-2">
                <span>‚öñÔ∏è</span>
                <span>Why Expert Guidance is Critical:</span>
            </h3>
            <ul class="text-red-200 text-sm space-y-2 ml-4">
                <li>‚Ä¢ Unfair dismissal claims can cost $20,000 - $80,000+ in legal fees and compensation</li>
                <li>‚Ä¢ Procedural errors cannot be fixed after termination</li>
                <li>‚Ä¢ General protections claims have severe penalties (up to 6 months salary)</li>
                <li>‚Ä¢ Every termination must follow strict Fair Work procedures</li>
            </ul>
        </div>

        <div class="bg-slate-900 rounded-lg p-6 mb-6">
            <h3 class="text-white font-bold mb-4">üìã Documentation Required:</h3>
            <div class="space-y-3 text-slate-300 text-sm">
                <div class="flex items-start gap-3">
                    <span class="text-amber-400 text-xl">‚úì</span>
                    <div>
                        <p class="font-semibold">Completed Record of Discussion OR Letter of Allegation</p>
                        <p class="text-slate-400 text-xs">(Depending on severity of misconduct)</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-amber-400 text-xl">‚úì</span>
                    <div>
                        <p class="font-semibold">Employee's responses and statements</p>
                        <p class="text-slate-400 text-xs">(All documentation from investigation/discussion process)</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-amber-400 text-xl">‚úì</span>
                    <div>
                        <p class="font-semibold">Evidence</p>
                        <p class="text-slate-400 text-xs">(Witness statements, CCTV footage, documentation, etc.)</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <!-- Risk Assessor Tool -->
            <button onclick="openTerminationRiskFromModal()" 
                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                <span class="text-2xl">‚öñÔ∏è</span>
                <div class="text-left">
                    <p class="text-lg">Run Termination Risk Assessment</p>
                    <p class="text-xs opacity-90">Understand your risk level before proceeding</p>
                </div>
            </button>

            <!-- Contact Consultant -->
            <button onclick="openTerminationConsultantEmail()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                <span class="text-2xl">‚úâÔ∏è</span>
                <div class="text-left">
                    <p class="text-lg">Contact Senior Consultant</p>
                    <p class="text-xs opacity-90">Get expert guidance on your termination process</p>
                </div>
            </button>

            <!-- Close -->
            <button onclick="closeTerminationConsultantModal()" 
                    class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg transition-all">
                Close
            </button>
        </div>

        <div class="mt-6 text-center">
            <p class="text-slate-400 text-sm">
                üìû Urgent? Call us: <a href="tel:+61400211014" class="text-amber-400 hover:underline font-semibold">+61 400 211 014</a>
            </p>
        </div>
    </div>
</div>

html        </div>
    </div>
</div>
<!-- ‚Üë END of terminationConsultantModal -->

<!-- ========================================== -->
<!-- TERMS OF SERVICE MODAL -->
<!-- ========================================== -->

<div id="termsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">Terms of Use</h2>
            <button onclick="closeTermsOfService()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        
        <div class="text-slate-300 text-sm space-y-4">
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4 mb-6">
                <p class="text-red-400 font-bold mb-2">‚ö†Ô∏è CRITICAL NOTICE</p>
                <p class="text-red-300">
                    This tool provides <strong>general information only</strong>. It is <strong>NOT legal advice</strong> 
                    and does not create a client-consultant relationship. All guidance and documents must be 
                    reviewed by a qualified Fitzgerald HR consultant before use.
                </p>
            </div>

            <h3 class="text-white font-bold text-lg">1. Acceptance of Terms</h3>
            <p>By accessing the Fitzgerald HR Knowledge Hub, you agree to these Terms of Use. If you do not agree, do not use this tool.</p>

            <h3 class="text-white font-bold text-lg">2. Nature of Service</h3>
            <p>This tool is an <strong>information resource</strong>, not a professional advisory service. It provides:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>General HR information for Australian hospitality venues</li>
                <li>Educational content about Fair Work compliance</li>
                <li>Draft document templates requiring professional review</li>
                <li>Reference materials and process guidance</li>
            </ul>
            <p class="font-semibold text-amber-400">This tool does NOT provide legal advice or professional HR consulting services.</p>

            <h3 class="text-white font-bold text-lg">3. Professional Review Requirement</h3>
            <p class="font-semibold">You MUST have all guidance and documents reviewed by a Fitzgerald HR consultant before:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Issuing any document to an employee</li>
                <li>Taking any employment action based on information provided</li>
                <li>Making legal or compliance decisions</li>
                <li>Relying on any content for legal proceedings</li>
            </ul>

            <h3 class="text-white font-bold text-lg">4. Limitation of Liability</h3>
            <p>Fitzgerald HR is NOT liable for:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Decisions made based on information from this tool</li>
                <li>Use of documents without professional review</li>
                <li>Inaccuracies or outdated information</li>
                <li>AI-generated content errors or omissions</li>
                <li>Legal costs, penalties, or damages arising from use of this tool</li>
            </ul>

            <h3 class="text-white font-bold text-lg">5. Your Responsibilities</h3>
            <p>You agree to:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Use this tool for informational purposes only</li>
                <li>Seek professional advice for specific situations</li>
                <li>Verify all information with official sources</li>
                <li>Not rely solely on this tool for legal compliance</li>
                <li>Have all documents professionally reviewed before use</li>
            </ul>

            <h3 class="text-white font-bold text-lg">6. Accuracy and Updates</h3>
            <p>While we strive for accuracy, employment law changes frequently. Award rates, regulations, and requirements may have changed since information was last updated. Always verify current requirements at <a href="https://www.fairwork.gov.au" target="_blank" class="text-amber-400 underline">fairwork.gov.au</a>.</p>

            <h3 class="text-white font-bold text-lg">7. Professional Consultation</h3>
            <p>For professional HR advice and document review:</p>
            <p class="font-semibold text-amber-400">
                Email: <a href="/cdn-cgi/l/email-protection#d1b8bfb7be91b7b8a5abb6b4a3b0bdb5b9a3ffb2bebcffb0a4" class="underline"><span class="__cf_email__" data-cfemail="bfd6d1d9d0ffd9d6cbc5d8dacdded3dbd7cd91dcd0d291deca">[email&#160;protected]</span></a><br>
                Phone: <a href="tel:+61400211014" class="underline">+61 400 211 014</a>
            </p>

            <p class="text-xs text-slate-400 mt-6">Last Updated: January 2026</p>
        </div>

        <button onclick="closeTermsOfService()" class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
            I Understand
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- PRIVACY POLICY MODAL -->
<!-- ========================================== -->

<div id="privacyModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">Privacy Policy</h2>
            <button onclick="closePrivacyPolicy()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        
        <div class="text-slate-300 text-sm space-y-4">
            <h3 class="text-white font-bold text-lg">1. Information We Collect</h3>
            <p>When using this tool, we collect:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li><strong>Conversation data:</strong> Your questions and our responses</li>
                <li><strong>Venue information:</strong> Business name, location, staff count (if provided during onboarding)</li>
                <li><strong>Document data:</strong> Employee names and details entered into document templates</li>
                <li><strong>Usage analytics:</strong> Tool usage patterns, features accessed, session duration</li>
                <li><strong>Access codes:</strong> Beta testing access credentials</li>
            </ul>

            <h3 class="text-white font-bold text-lg">2. How We Use Your Information</h3>
            <ul class="list-disc ml-6 space-y-1">
                <li>To provide and improve the tool's functionality</li>
                <li>To analyze usage patterns and feature effectiveness</li>
                <li>To provide better recommendations and tool suggestions</li>
                <li>For beta testing feedback and product development</li>
            </ul>

            <h3 class="text-white font-bold text-lg">3. Data Storage</h3>
            <p>Your data is stored securely using:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Supabase (cloud database provider) - Australian/US servers</li>
                <li>Browser local storage (for venue profile and preferences)</li>
                <li>Anthropic Claude API (for AI responses - data not retained by Anthropic)</li>
            </ul>

            <h3 class="text-white font-bold text-lg">4. Data Sharing</h3>
            <p>We do NOT sell your data. We may share data with:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Fitzgerald HR consultants (when you request professional review or advice)</li>
                <li>Service providers (Anthropic, Supabase) - under strict confidentiality agreements</li>
                <li>Legal authorities (if required by Australian law)</li>
            </ul>

            <h3 class="text-white font-bold text-lg">5. Your Rights</h3>
            <p>Under Australian Privacy Principles, you have the right to:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Access your personal data</li>
                <li>Request correction of inaccurate data</li>
                <li>Request deletion of your data</li>
                <li>Opt out of analytics collection</li>
            </ul>

            <h3 class="text-white font-bold text-lg">6. Security</h3>
            <p>We implement industry-standard security measures including encryption, secure databases, and access controls. However, no system is 100% secure.</p>

            <h3 class="text-white font-bold text-lg">7. Contact Us</h3>
            <p>For privacy concerns or data requests:</p>
            <p class="font-semibold text-amber-400">
                Email: <a href="/cdn-cgi/l/email-protection#5c35323a331c3a3528263b392e3d3038342e723f3331723d29" class="underline"><span class="__cf_email__" data-cfemail="a0c9cec6cfe0c6c9d4dac7c5d2c1ccc4c8d28ec3cfcd8ec1d5">[email&#160;protected]</span></a><br>
                Phone: <a href="tel:+61400211014" class="underline">+61 400 211 014</a>
            </p>

            <p class="text-xs text-slate-400 mt-6">Last Updated: January 2026</p>
        </div>

        <button onclick="closePrivacyPolicy()" class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
            I Understand
        </button>
    </div>
</div>


<!-- ========================================== -->
<!-- LOGOUT OPTIONS MODAL -->
<!-- ========================================== -->

<div id="logoutModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-md w-full border-2 border-slate-700 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üö™</div>
            <h2 class="text-2xl font-bold text-white mb-2">Logout Options</h2>
            <p class="text-slate-400">How would you like to logout?</p>
        </div>
        
        <div class="space-y-3 mb-6">
            <!-- Quick Logout (Soft) -->
            <button onclick="confirmLogout('soft')" 
                    class="w-full p-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all text-left group">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">üîÑ</div>
                    <div class="flex-1">
                        <p class="font-bold text-lg mb-1">Quick Logout</p>
                        <p class="text-sm opacity-90">Stay logged in on this device - auto-login next time</p>
                    </div>
                </div>
            </button>
            
            <!-- Full Logout (Hard) -->
            <button onclick="confirmLogout('hard')" 
                    class="w-full p-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all text-left group">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">üóëÔ∏è</div>
                    <div class="flex-1">
                        <p class="font-bold text-lg mb-1">Full Logout</p>
                        <p class="text-sm opacity-90">Forget this device - enter access code next time</p>
                    </div>
                </div>
            </button>
        </div>
        
        <div class="bg-slate-700/50 rounded-lg p-3 mb-4">
            <p class="text-slate-300 text-xs text-center">
                üí° <strong>Tip:</strong> Use Quick Logout if you're the only one using this device
            </p>
        </div>
        
        <button onclick="closeLogoutModal()" 
                class="w-full py-3 text-slate-400 hover:text-white font-semibold transition-colors rounded-lg hover:bg-slate-700/50">
            Cancel
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- LEGAL ACCEPTANCE MODAL (First Use Only) -->
<!-- ========================================== -->

<div id="legalAcceptanceModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 md:p-6 z-[60]">
    <div class="bg-slate-800 rounded-2xl p-6 md:p-8 max-w-3xl w-full border-2 border-red-500 fade-in max-h-[90vh] overflow-y-auto">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                <span class="text-4xl">‚ö†Ô∏è</span>
            </div>
            <h2 class="text-2xl font-bold text-red-400">Important Legal Notice</h2>
            <p class="text-slate-400 text-sm mt-2">Please read carefully before using this tool</p>
        </div>

        <!-- Content -->
        <div class="bg-slate-900/50 rounded-lg p-6 mb-6 space-y-4 text-slate-300 text-sm border border-slate-700">
            
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">üìö</span>
                    <span>This is an Information Tool</span>
                </h3>
                <p>
                    This tool provides <strong class="text-white">general HR information only</strong> for Australian hospitality venues. 
                    It is <strong class="text-red-400">NOT a substitute</strong> for professional HR or legal advice.
                </p>
            </div>

            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">‚úÖ</span>
                    <span>Mandatory Professional Review</span>
                </h3>
                <p class="mb-2">
                    <strong class="text-white">All documents and guidance MUST be reviewed</strong> by a Fitzgerald HR consultant before:
                </p>
                <ul class="list-disc ml-6 space-y-1 text-xs">
                    <li>Issuing any document to an employee</li>
                    <li>Taking employment action (warnings, terminations, etc.)</li>
                    <li>Making compliance or legal decisions</li>
                </ul>
            </div>

            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-red-400">‚öñÔ∏è</span>
                    <span>Legal Disclaimer</span>
                </h3>
                <p>
                    Fitzgerald HR is <strong class="text-white">not liable</strong> for decisions made based on this tool's information, 
                    documents used without professional review, or any legal costs/damages arising from use of this tool.
                </p>
            </div>

            <div>
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">üìû</span>
                    <span>Get Professional Advice</span>
                </h3>
                <p class="text-amber-300">
                    Email: <a href="/cdn-cgi/l/email-protection#11787f777e517778656b767463707d7579633f727e7c3f7064" class="underline hover:text-amber-200 font-semibold"><span class="__cf_email__" data-cfemail="e28b8c848da2848b9698858790838e868a90cc818d8fcc8397">[email&#160;protected]</span></a><br>
                    Phone: <a href="tel:+61400211014" class="underline hover:text-amber-200 font-semibold">+61 400 211 014</a>
                </p>
            </div>

        </div>

        <!-- Checkbox Agreement -->
        <div class="mb-6">
            <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="legalAcceptCheckbox" 
                       class="mt-1 w-5 h-5 rounded border-2 border-slate-600 bg-slate-900 checked:bg-amber-500 checked:border-amber-500 cursor-pointer transition-all">
                <span class="text-slate-300 text-sm flex-1 group-hover:text-white transition-colors">
                    I understand and agree that:
                    <ul class="list-disc ml-5 mt-2 space-y-1 text-xs text-slate-400">
                        <li>This tool provides information only, not professional advice</li>
                        <li>All documents must be reviewed by a consultant before use</li>
                        <li>I will seek professional guidance for specific situations</li>
                        <li>I accept the <a href="#terms" onclick="showTermsFromAcceptance(); return false;" class="text-amber-400 underline hover:text-amber-300">Terms of Use</a> and <a href="#privacy" onclick="showPrivacyFromAcceptance(); return false;" class="text-amber-400 underline hover:text-amber-300">Privacy Policy</a></li>
                    </ul>
                </span>
            </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4">
            <button onclick="declineLegalTerms()" 
                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg transition-all">
                I Do Not Agree
            </button>
            <button id="acceptLegalButton" onclick="acceptLegalTerms()" disabled
                    class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-amber-500">
                I Understand & Agree
            </button>
        </div>

        <p class="text-center text-slate-500 text-xs mt-4">
            By clicking "I Understand & Agree", you acknowledge you have read and understood this notice.
        </p>

    </div>
</div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ========================================
// CONFIGURATION & GLOBALS
// ========================================

// ========================================
// CONFIGURATION
// ========================================
// ========================================
// DOM CACHE - Performance Optimization
// ========================================

/**
 * Cached DOM elements to avoid repeated queries
 * Initialized on DOMContentLoaded for performance
 */
const DOM = {
    // Main elements
    accessScreen: null,
    assistantScreen: null,
    messagesContainer: null,
    messageInput: null,
    sendButton: null,
    
    // Modals
    feedbackModal: null,
    crisisModal: null,
    awardCalculatorModal: null,
    awardWizardModal: null,
    rosterStressTesterModal: null,
    complianceCalendarModal: null,
    
    // Tools menu
    toolsMenu: null,
    
    // Voice
    voiceButton: null,
    voiceIcon: null
};
const CONFIG = {
    // Access control
    VALID_CODES: [
        'BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003',
        'BETA-VENUE-004', 'BETA-VENUE-005',
        'FITZGERALD-TEST', 'DEMO-2025'
    ],
    
    // API endpoints
    API: {
        RATES_URL: 'https://raw.githubusercontent.com/Meataxe4/Fitzgerald-HR-Ai/main/hospitality-award-rates.json',
        CHAT_ENDPOINT: '/.netlify/functions/chat',
        CRISIS_ENDPOINT: '/.netlify/functions/telegram-crisis'
    },
    
    // Application constants
    WIZARD_STEPS: 6,
    TOOL_SUGGESTION_LIMIT: 2,
    MAX_CONVERSATION_HISTORY: 50,
    
    // Timing
    DEBOUNCE_DELAY: 150,
    RETRY_DELAY: 1000,
    MAX_RETRIES: 3,
    ERROR_DISPLAY_TIME: 5000
};

// ========================================
// SUPABASE CONFIGURATION
// ========================================
const SUPABASE_CONFIG = {
    url: 'https://vaundmbbbyqmbbcavulo.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhdW5kbWJiYnlxbWJiY2F2dWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MDcwMzAsImV4cCI6MjA4NDE4MzAzMH0.2ynWsEBn3YJFXUBinm2e4XgnHiUM9hYbaZ1SfVk__pI'
};

// Initialize Supabase client
let supabaseClient = null;

// Initialize Supabase when page loads
function initializeSupabase() {
    try {
        // Check if Supabase library loaded
        if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase library not loaded - check script tag');
            return false;
        }
        
        // Create client
        supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        console.log('‚úÖ Supabase initialized successfully');
        console.log('üìä Connected to:', SUPABASE_CONFIG.url);
        return true;
    } catch (error) {
        console.error('‚ùå Error initializing Supabase:', error);
        return false;
    }
}

// Global state
let currentUser = null;
let conversationHistory = [];
let feedbackRating = 0;
let wizardData = {};
let currentWizardStep = 1;
let recognition = null;
let isListening = false;

// ========================================
// DARK MODE SYSTEM
// ========================================

/**
 * Initialize dark mode from localStorage
 * Called on page load
 */
function initDarkMode() {
    // Check localStorage for saved preference (default is dark mode)
    const isDarkMode = localStorage.getItem('darkMode') !== 'false';
    
    if (!isDarkMode) {
        // User prefers light mode
        document.body.classList.add('light-mode');
        updateDarkModeButton(false);
    } else {
        // User prefers dark mode (default)
        document.body.classList.remove('light-mode');
        updateDarkModeButton(true);
    }
}

/**
 * Toggle between light and dark mode
 */
function toggleDarkMode() {
    const isCurrentlyDark = !document.body.classList.contains('light-mode');
    
    if (isCurrentlyDark) {
        // Switch to light mode
        document.body.classList.add('light-mode');
        localStorage.setItem('darkMode', 'false');
        updateDarkModeButton(false);
    } else {
        // Switch to dark mode
        document.body.classList.remove('light-mode');
        localStorage.setItem('darkMode', 'true');
        updateDarkModeButton(true);
    }
}

/**
 * Update the dark mode button appearance
 */
function updateDarkModeButton(isDark) {
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    
    if (icon && text) {
        if (isDark) {
            icon.textContent = 'üåô';
            text.textContent = 'Dark';
        } else {
            icon.textContent = '‚òÄÔ∏è';
            text.textContent = 'Light';
        }
    }
}


// ========================================
// VENUE MEMORY SYSTEM - GLOBAL STATE
// ========================================

let venueProfile = {
    userName: null,
    venueType: null,
    location: null,
    city: null,
    staffCount: null,
    primaryAward: null,
    mainChallenge: null,
    setupComplete: false,
    setupDate: null,
    venueName: null
};

let onboardingCurrentStep = 1;
const ONBOARDING_STEPS = 6;

// ========================================
// ADMIN ANALYTICS TRACKING
// ========================================

let analyticsData = {
    conversations: [],
    themes: {},
    highRiskTopics: [],
    userProfiles: {}
};

// ========================================
// ENHANCED DOCUMENT BUILDER DETECTION
// ========================================

/**
 * Detects if user message requires Document Builder tool
 * Returns tool suggestion object or null
 */
function detectDocumentBuilderNeed(message) {
    const lowerMessage = message.toLowerCase();
    
    const documentTriggers = {
        formalWarning: {
            keywords: ['formal warning', 'written warning', 'issue a warning', 'give a warning', 'write a warning', 'warning letter'],
            title: 'Formal Warning Required',
            description: 'Use Document Builder to create a legally compliant formal warning letter'
        },
        recordOfDiscussion: {
            keywords: ['record of discussion', 'document conversation', 'discussion meeting', 'talk to employee about', 'rod'],
            title: 'Record of Discussion',
            description: 'Use Document Builder to create a record of discussion template with conversation script'
        },
        performanceImprovementPlan: {
            keywords: ['performance improve', 'pip', 'performance plan', 'underperforming', 'performance manage', 'performance issue'],
            title: 'Performance Improvement Plan',
            description: 'Use Document Builder to create a structured 12-week performance improvement plan'
        },
        letterOfAllegation: {
            keywords: ['investigate', 'serious misconduct', 'allegation', 'suspend', 'investigation'],
            title: 'Letter of Allegation',
            description: 'Use Document Builder for serious misconduct investigation process'
        },
        termination: {
            keywords: ['terminate', 'termination', 'fire', 'dismiss', 'dismissal', 'sack', 'let go', 'end employment'],
            title: 'Termination Process',
            description: 'CRITICAL: Senior Consultant guidance required for termination'
        }
    };
    
    for (const [type, config] of Object.entries(documentTriggers)) {
        if (config.keywords.some(keyword => lowerMessage.includes(keyword))) {
            return {
                type: type,
                title: config.title,
                description: config.description,
                isTermination: type === 'termination'
            };
        }
    }
    
    return null;
}

/**
 * Creates Document Builder suggestion box for message
 */
function createDocumentBuilderSuggestion(detection) {
    if (detection.isTermination) {
        return `<div class="mb-4 p-4 bg-red-500/10 border-l-4 border-red-500 rounded-r-lg">
            <p class="text-red-400 font-bold mb-2 flex items-center gap-2">
                <span>üö®</span>
                <span>${detection.title}</span>
            </p>
            <p class="text-red-300 text-sm mb-3">
                Employment termination requires expert guidance to avoid legal risk.
            </p>
            <button onclick="showTerminationConsultantRequired()" 
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                <span>‚öñÔ∏è</span>
                <span>View Termination Requirements</span>
            </button>
        </div>`;
    }
    
    return `<div class="mb-4 p-4 bg-blue-500/10 border-l-4 border-blue-500 rounded-r-lg">
        <p class="text-blue-400 font-bold mb-2 flex items-center gap-2">
            <span>üìù</span>
            <span>${detection.title}</span>
        </p>
        <p class="text-blue-300 text-sm mb-3">${detection.description}</p>
        <button onclick="openDocumentBuilderFor('${detection.type}')" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>üìù</span>
            <span>Open Document Builder</span>
        </button>
    </div>`;
}

/**
 * Opens Document Builder pre-selected to specific type
 */
function openDocumentBuilder() {
    // Track usage
    trackToolUsage('documentBuilderModal');
    
    // Open Document Builder modal without pre-selecting a type
    var modal = document.getElementById('documentBuilderModal');
    if (modal) {
        modal.classList.remove('hidden');
        
        // Reset to step 1 (document type selection)
        resetDocumentBuilderSilent();
        
        trackEvent('document_builder_opened_from_header', {
            user: currentUser
        });
    } else {
        console.error('Document Builder modal not found');
    }
}

function openDocumentBuilderFor(documentType) {
    // Open modal
    document.getElementById('documentBuilderModal').classList.remove('hidden');
    
    // Auto-select the document type
    if (documentType && documentType !== 'termination') {
        setTimeout(() => {
            selectDocumentType(documentType);
        }, 100);
    }
    
    trackEvent('document_builder_opened_from_suggestion', {
        user: currentUser,
        type: documentType
    });
}

// ========================================
// AWARD RATES - FETCH FROM GITHUB
// ========================================

let awardRates = null; // Global variable to store rates
// Rate URL now in CONFIG object - see line 1169

// Fetch rates on page load
/**
 * Loads award rates from GitHub with automatic retry
 * Falls back to hardcoded rates if GitHub is unavailable
 * @returns {Promise<boolean>} True if loaded from GitHub, false if using fallback
 */
async function loadAwardRates() {
    try {
        const response = await fetchWithRetry(CONFIG.API.RATES_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load rates`);
        
        awardRates = await response.json();
        console.log('‚úÖ Award rates loaded from GitHub:', awardRates.version);
        return true;
    } catch (error) {
        console.error('‚ùå Error loading award rates from GitHub:', error.message);
        console.warn('‚ö†Ô∏è Using fallback rates - some features may be limited');
        
        // Fallback to basic rates if GitHub fails
        awardRates = getFallbackRates();
        return false;
    }
}

// Fallback rates if GitHub is down
function getFallbackRates() {
    return {
        adult_fulltime_parttime: {
            introductory: { rate: 24.28 },
            level_1: { food_beverage_grade1: { rate: 24.95 } },
            level_2: { cook_grade1: { rate: 25.85 } },
            level_3: { cook_grade2: { rate: 26.70 } },
            level_4: { cook_tradesperson_grade3: { rate: 28.12 } },
            level_5: { cook_tradesperson_grade4: { rate: 29.88 } },
            level_6: { cook_tradesperson_grade5: { rate: 30.68 } }
        },
        penalty_rates: {
            saturday: 1.5,
            sunday: 1.75,
            public_holiday: 2.5,
            evening_after_7pm: 1.1
        },
        casual_loading: 0.25
    };
}

// Load rates immediately when page loads
loadAwardRates();

// ========================================
// UTILITY FUNCTIONS
// ========================================

/**
 * Sanitizes HTML to prevent XSS attacks
 * @param {string} html - Raw HTML string
 * @returns {string} Sanitized HTML safe for innerHTML
 */
function sanitizeHTML(html) {
    const temp = document.createElement('div');
    temp.textContent = html;
    return temp.innerHTML;
}

/**
 * Debounces a function call
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in milliseconds
 * @returns {Function} Debounced function
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Fetches data with automatic retry logic
 * @param {string} url - URL to fetch
 * @param {Object} options - Fetch options
 * @param {number} maxRetries - Maximum retry attempts
 * @returns {Promise<Response>}
 */
async function fetchWithRetry(url, options = {}, maxRetries = CONFIG.MAX_RETRIES) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            
            // If not the last retry, wait before trying again
            if (i < maxRetries - 1) {
                const delay = CONFIG.RETRY_DELAY * (i + 1); // Exponential backoff
                console.log(`Retry ${i + 1}/${maxRetries - 1} for ${url} after ${delay}ms`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            console.warn(`Attempt ${i + 1} failed:`, error.message);
        }
    }
    throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts`);
}

/**
 * Wraps async functions with error handling
 * @param {Function} asyncFunc - Async function to wrap
 * @returns {Function} Wrapped function with error handling
 */
function withErrorHandling(asyncFunc) {
    return async function(...args) {
        try {
            return await asyncFunc(...args);
        } catch (error) {
            console.error(`Error in ${asyncFunc.name}:`, error);
            
            // Show user-friendly error
            const errorMessage = error.message || 'An unexpected error occurred';
            alert(`‚ö†Ô∏è ${errorMessage}\n\nPlease try again or contact support if the issue persists.`);
            
            // Re-throw for caller to handle if needed
            throw error;
        }
    };
}

// ========================================
// HIGH-RISK DETECTION & WARNING SYSTEM
// ========================================

/**
 * Detects high-risk topics in user messages
 * @param {string} message - User's message
 * @returns {Object|null} Risk object with type and severity, or null if no risk
 */
function detectHighRiskTopic(message) {
    const lowerMessage = message.toLowerCase();
    
    // Define high-risk keywords by category
    const riskCategories = {
        termination: {
            keywords: ['terminate', 'termination', 'fire', 'firing', 'dismiss', 'dismissal', 
                      'sack', 'sacking', 'let go', 'end employment', 'redundancy', 'redundant'],
            title: 'Employment Termination',
            severity: 'critical'
        },
        investigation: {
            keywords: ['investigate', 'investigation', 'allegation', 'complaint', 'misconduct',
                      'serious misconduct', 'theft', 'harassment', 'bullying', 'discrimination'],
            title: 'Workplace Investigation',
            severity: 'critical'
        },
        legal: {
            keywords: ['legal action', 'lawsuit', 'sue', 'suing', 'unfair dismissal', 
                      'workers comp claim', 'discrimination claim', 'adverse action', 
                      'general protections', 'fair work complaint'],
            title: 'Legal Matter',
            severity: 'critical'
        },
        harassment: {
            keywords: ['sexual harassment', 'harassment', 'hostile workplace', 'inappropriate behavior',
                      'assault', 'threatening', 'violence', 'abuse'],
            title: 'Harassment/Safety Issue',
            severity: 'critical'
        },
        performance: {
            keywords: ['performance manage', 'pip', 'performance improvement', 'final warning',
                      'written warning', 'underperforming'],
            title: 'Performance Management',
            severity: 'high'
        }
    };
    
    // Check each category
    for (const [category, config] of Object.entries(riskCategories)) {
        const hasKeyword = config.keywords.some(keyword => lowerMessage.includes(keyword));
        if (hasKeyword) {
            return {
                category: category,
                title: config.title,
                severity: config.severity
            };
        }
    }
    
    return null;
}

/**
 * Creates a subtle but prominent high-risk warning
 * @param {Object} risk - Risk object from detectHighRiskTopic
 * @returns {string} HTML string for the warning box
 */

function createHighRiskWarningBox(risk) {
    const currentTime = new Date().toLocaleString('en-AU');
    
    return `<div class="mb-3 p-3 bg-red-500/10 border-l-4 border-red-500 rounded">
    <p class="text-red-400 font-bold text-sm flex items-center gap-2 mb-2">
        <span>‚ö†Ô∏è</span>
        <span>IMPORTANT: This matter involves legal risk.</span>
    </p>
    <p class="text-red-300 text-sm mb-3">
        ${risk.title} - Please contact a Senior Consultant at <a href="mailto:info@fitzgeraldhr.com.au" class="underline hover:text-red-200">info@fitzgeraldhr.com.au</a> before taking action.
    </p>
    <div class="flex gap-2">
        <a href="mailto:info@fitzgeraldhr.com.au?subject=URGENT: ${encodeURIComponent(risk.title)} - ${encodeURIComponent(currentUser)}&body=${encodeURIComponent('I need urgent advice regarding a ' + risk.title + ' matter.\n\nUser ID: ' + currentUser + '\nDate/Time: ' + currentTime + '\n\nBrief Description:\n[Please describe your situation here]')}" 
           class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center">
            ‚úâÔ∏è Email Consultant
        </a>
        <a href="tel:+61400211014" 
           class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center whitespace-nowrap">
            üìû Call
        </a>
        <button onclick="openTool('scenarioAnalysis')" 
                class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-3 rounded text-sm transition-all whitespace-nowrap">
            üéØ Analyze
        </button>
    </div>
</div>

`;
}


// ========================================
// HR DOCUMENT TEMPLATES
// ========================================

const hrTemplates = {
            employmentContract: (data) => `
                <div class="header">
                    <h1>EMPLOYMENT CONTRACT</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <h2>Employment Details</h2>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position Title]'}</p>
                <p><strong>Start Date:</strong> ${data.startDate || '[Start Date]'}</p>
                <p><strong>Employment Type:</strong> ${data.employmentType || '[Full-time/Part-time/Casual]'}</p>
                <p><strong>Applicable Award:</strong> ${data.award || 'Hospitality Industry (General) Award'}</p>
                
                <h2>1. Position and Duties</h2>
                <p>${data.duties || '[Insert comprehensive list of key duties, responsibilities, and reporting lines]'}</p>
                
                <h2>2. Remuneration and Benefits</h2>
                <p><strong>Base Rate of Pay:</strong> ${data.baseRate || '[Rate]'} per ${data.payPeriod || 'hour'}</p>
                <p>Payment will be made ${data.paymentFrequency || 'fortnightly'} via direct deposit.</p>
                <p>In addition to the base rate, you will receive applicable penalty rates, loadings, and allowances as prescribed by the ${data.award || 'Hospitality Industry (General) Award'}.</p>
                
                <h2>3. Hours of Work</h2>
                <p>${data.hoursOfWork || '[Specify ordinary hours, roster arrangements, and any requirements for availability]'}</p>
                <p>Reasonable additional hours may be required from time to time, subject to the National Employment Standards.</p>
                
                <h2>4. Probationary Period</h2>
                <p>The first ${data.probationPeriod || '3 months'} of your employment will be considered a probationary period. During this time, your suitability for the role will be assessed. Either party may terminate employment during probation with ${data.probationNotice || '1 week\'s'} notice.</p>
                
                <h2>5. Leave Entitlements</h2>
                <p>You are entitled to leave in accordance with the National Employment Standards and the applicable Modern Award, including:</p>
                <ul>
                    <li>Annual leave (if applicable to employment type)</li>
                    <li>Personal/carer's leave</li>
                    <li>Compassionate and bereavement leave</li>
                    <li>Long service leave (after qualifying period)</li>
                    <li>Public holidays</li>
                </ul>
                
                <h2>6. Termination of Employment</h2>
                <p>Either party may terminate this employment by providing written notice as required by the National Employment Standards and the applicable Award.</p>
                
                <h2>7. Workplace Policies</h2>
                <p>You are required to comply with all workplace policies and procedures, including but not limited to workplace health and safety, equal opportunity, and code of conduct policies.</p>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è IMPORTANT LEGAL NOTICE</strong>
                    <p>This employment contract template has been generated by Fitz AI and is provided for guidance purposes only.</p>
                    <p><strong>You MUST have this contract reviewed and customised by a Fitzgerald HR Senior Consultant or employment lawyer before use.</strong></p>
                    <p>This ensures compliance with all applicable laws, awards, and your specific circumstances.</p>
                    <p><strong>Contact:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
                
                <div style="margin-top: 50px;">
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p><strong>Employer Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
            `,
            
            warningLetter: (data) => `
                <div class="header">
                    <h1>WRITTEN WARNING</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <p><strong>Date:</strong> ${data.date || new Date().toLocaleDateString('en-AU')}</p>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position]'}</p>
                <p><strong>Employee ID:</strong> ${data.employeeId || '[Employee ID]'}</p>
                
                <h2>Subject: ${data.subject || 'Formal Written Warning'}</h2>
                
                <p>This letter serves as a formal written warning regarding ${data.issue || '[describe the issue or concern]'}.</p>
                
                <h2>Details of Incident/Issue</h2>
                <p><strong>Date(s) of Incident:</strong> ${data.incidentDate || '[Date(s)]'}</p>
                <p><strong>Description:</strong></p>
                <p>${data.description || '[Provide detailed, factual description of the incident, behaviour, or performance issue. Include specific examples, dates, times, and any witnesses if applicable]'}</p>
                
                <h2>Previous Discussions</h2>
                <p>${data.previousDiscussions || '[If applicable, note any prior verbal warnings or discussions about this matter, including dates]'}</p>
                
                <h2>Expected Standards and Behaviour</h2>
                <p>${data.expectations || '[Clearly outline the expected standards of conduct, performance, or behaviour moving forward. Reference relevant policies, position description, or award requirements]'}</p>
                
                <h2>Improvement Plan</h2>
                <p>${data.improvementPlan || '[Outline specific, measurable steps the employee must take to address the issue. Include timeframes and any support or resources available]'}</p>
                
                <h2>Consequences of Further Issues</h2>
                <p>Failure to meet these expectations and demonstrate sustained improvement may result in further disciplinary action, which may include:</p>
                <ul>
                    <li>A final written warning</li>
                    <li>Termination of employment</li>
                </ul>
                
                <h2>Support Available</h2>
                <p>${data.support || '[Outline any support, training, coaching, or resources available to help the employee improve. This demonstrates procedural fairness]'}</p>
                
                <h2>Right to Respond</h2>
                <p>You have the right to provide a written response to this warning within ${data.responseTimeframe || '7 days'}. Your response will be considered and placed on your employee file with this warning.</p>
                
                <p>This warning will remain on your employee file for ${data.warningDuration || '12 months'} from the date of this letter.</p>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è CRITICAL LEGAL RISK</strong>
                    <p>Performance management and disciplinary processes involve significant legal risks if not handled correctly.</p>
                    <p><strong>This template MUST be reviewed by a Fitzgerald HR Senior Consultant before being issued to any employee.</strong></p>
                    <p>Incorrect process may result in unfair dismissal claims, general protections claims, or adverse action claims.</p>
                    <p><strong>Contact immediately:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
                
                <div style="margin-top: 40px;">
                    <p><strong>I acknowledge receipt of this written warning:</strong></p>
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;"><em>Signing this letter acknowledges receipt only and does not necessarily indicate agreement with its contents.</em></p>
                    <br/>
                    <p><strong>Manager/Supervisor Name:</strong> ${data.managerName || '[Manager Name]'}</p>
                    <p><strong>Manager Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
            `,
            
            performanceReview: (data) => `
                <div class="header">
                    <h1>PERFORMANCE REVIEW</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <h2>Employee Information</h2>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position]'}</p>
                <p><strong>Department/Location:</strong> ${data.department || '[Department]'}</p>
                <p><strong>Review Period:</strong> ${data.reviewPeriod || '[Start Date] to [End Date]'}</p>
                <p><strong>Review Date:</strong> ${data.reviewDate || new Date().toLocaleDateString('en-AU')}</p>
                <p><strong>Reviewer:</strong> ${data.reviewer || '[Manager/Supervisor Name]'}</p>
                
                <h2>Performance Summary</h2>
                <p>${data.summary || '[Provide an overall summary of the employee\'s performance during the review period. Consider achievements, challenges, growth, and overall contribution to the team and organisation]'}</p>
                
                <h2>Key Achievements and Successes</h2>
                <p>${data.achievements || '[List and describe significant achievements, successful projects, goals met or exceeded, positive contributions to team/workplace culture, and any special recognition received during the review period]'}</p>
                
                <h2>Core Competencies Assessment</h2>
                
                <h3>1. Job Knowledge and Skills</h3>
                <p>${data.jobKnowledge || '[Assess the employee\'s understanding of their role, technical skills, industry knowledge, and ability to perform required tasks]'}</p>
                
                <h3>2. Quality of Work</h3>
                <p>${data.qualityOfWork || '[Evaluate accuracy, attention to detail, consistency, and standard of work produced]'}</p>
                
                <h3>3. Productivity and Time Management</h3>
                <p>${data.productivity || '[Assess ability to meet deadlines, manage workload, prioritise tasks, and work efficiently]'}</p>
                
                <h3>4. Communication and Teamwork</h3>
                <p>${data.communication || '[Evaluate interpersonal skills, collaboration with colleagues, customer service, and contribution to team dynamics]'}</p>
                
                <h3>5. Initiative and Problem Solving</h3>
                <p>${data.initiative || '[Assess proactiveness, ability to identify and solve problems, willingness to take on new challenges]'}</p>
                
                <h3>6. Reliability and Attendance</h3>
                <p>${data.reliability || '[Review punctuality, attendance record, dependability, and adherence to rostering requirements]'}</p>
                
                <h2>Areas of Strength</h2>
                <p>${data.strengths || '[Identify specific areas where the employee excels. Be specific with examples]'}</p>
                
                <h2>Development Areas and Opportunities</h2>
                <p>${data.developmentAreas || '[Identify areas where improvement is needed or where the employee can further develop their skills. Frame constructively and with specific examples]'}</p>
                
                <h2>Goals and Objectives for Next Review Period</h2>
                <p>${data.goals || '[Set SMART goals (Specific, Measurable, Achievable, Relevant, Time-bound) for the upcoming review period. Align with both employee development and organisational objectives]'}</p>
                
                <h2>Training and Development Plan</h2>
                <p>${data.trainingPlan || '[Outline specific training, development opportunities, mentoring, or resources that will be provided to support the employee\'s growth and achievement of goals]'}</p>
                
                <h2>Career Progression Discussion</h2>
                <p>${data.careerDiscussion || '[If discussed, note any conversations about career aspirations, potential progression opportunities, or long-term development paths]'}</p>
                
                <h2>Overall Performance Rating</h2>
                <p><strong>Rating: ${data.rating || '[Exceeds Expectations / Meets Expectations / Needs Improvement / Unsatisfactory]'}</strong></p>
                
                <h2>Employee Comments</h2>
                <p>The employee has the opportunity to provide comments, feedback, or responses to this review:</p>
                <p>_________________________________________________________________________________</p>
                <p>_________________________________________________________________________________</p>
                <p>_________________________________________________________________________________</p>
                
                <div style="margin-top: 40px;">
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;"><em>Signature indicates that the review has been discussed with the employee, not necessarily agreement.</em></p>
                    <br/>
                    <p><strong>Reviewer Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è IMPORTANT NOTE</strong>
                    <p>This performance review template has been generated by Fitz AI for guidance purposes.</p>
                    <p>For best results and to ensure procedural fairness, consider having your performance review process and documentation reviewed by a Fitzgerald HR Senior Consultant.</p>
                    <p><strong>Contact:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
            `
        };

        // ========================================
        // DOCUMENT GENERATION FUNCTIONS
        // ========================================
        
        function formatContentForWord(content) {
    return content
        // Normalize line breaks
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        
        // Convert ## headers to proper HTML with Word styles
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        
        // REMOVE bold formatting - just strip the ** markers
        .replace(/\*\*(.+?)\*\*/g, '$1')
        
        // Convert *italic* to <em> (but not part of **)
        .replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>')
        
        // Convert bullet points (with proper spacing)
        .replace(/^[‚Ä¢\-] (.+)$/gm, '<li style="margin-bottom: 8px;">$1</li>')
        
        // Convert underscores to underlined spans
        .replace(/_{5,}/g, '<span style="text-decoration: underline; display: inline-block; min-width: 200px;">$&</span>')
        
        // Split by double newlines to create paragraphs
        .split(/\n\n+/)
        .map(block => {
            block = block.trim();
            if (!block) return '';
            
            // If it's already an HTML element, return it
            if (block.startsWith('<h') || block.startsWith('<li>') || block.startsWith('<div')) {
                return block;
            }
            
            // Wrap list items in <ul> with proper styling
            if (block.includes('<li')) {
                return '<ul style="margin-top: 10px; margin-bottom: 15px; padding-left: 20px;">' + block + '</ul>';
            }
            
            // Convert single newlines to <br> within paragraphs
            block = block.replace(/\n/g, '<br>');
            
            // Wrap in paragraph with spacing
            return '<p style="margin-bottom: 12px; line-height: 1.6;">' + block + '</p>';
        })
        .join('\n');
}

function convertHTMLToPdfMake(html, metadata) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = [];

    const processNode = (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            if (text) {
                return { text: text };
            }
            return null;
        }

        if (node.nodeType !== Node.ELEMENT_NODE) return null;

        const tagName = node.tagName.toLowerCase();

        switch (tagName) {
            case 'h1':
                return {
                    text: node.textContent.trim(),
                    style: 'header1',
                    margin: [0, 15, 0, 10]
                };

            case 'h2':
                return {
                    text: node.textContent.trim(),
                    style: 'header2',
                    margin: [0, 12, 0, 6]
                };

            case 'h3':
                return {
                    text: node.textContent.trim(),
                    style: 'header3',
                    margin: [0, 10, 0, 5]
                };

            case 'p':
                const pContent = [];
                for (const child of node.childNodes) {
                    const processed = processInlineNode(child);
                    if (processed) {
                        if (Array.isArray(processed)) {
                            pContent.push(...processed);
                        } else {
                            pContent.push(processed);
                        }
                    }
                }
                return {
                    text: pContent.length > 0 ? pContent : node.textContent.trim(),
                    margin: [0, 0, 0, 8]  // Increased bottom margin
                };

            case 'ul':
                const listItems = [];
                for (const li of node.querySelectorAll('li')) {
                    listItems.push(li.textContent.trim());
                }
                return {
                    ul: listItems,
                    margin: [20, 5, 0, 10],  // Left indent + spacing
                    style: 'bulletList'
                };

            case 'li':
                return {
                    text: node.textContent.trim(),
                    margin: [0, 2, 0, 2]
                };

            case 'br':
                return { text: '', margin: [0, 5, 0, 0] };

            default:
                const children = [];
                for (const child of node.childNodes) {
                    const processed = processNode(child);
                    if (processed) children.push(processed);
                }
                return children.length > 0 ? children : null;
        }
    };

    const processInlineNode = (node) => {
    if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent.trim();
        return text ? { text: text } : null;
    }

    const tagName = node.tagName?.toLowerCase();
    const text = node.textContent.trim();

    if (!text) return null;

    switch (tagName) {
        case 'strong':
        case 'b':
            // REMOVE BOLD - just return normal text
            return { text: text };  // Removed the bold: true property
        case 'em':
        case 'i':
            return { text: text, italics: true };
        default:
            return { text: text };
    }
};

    // Process all body children
    for (const child of doc.body.childNodes) {
        const processed = processNode(child);
        if (processed) {
            if (Array.isArray(processed)) {
                content.push(...processed);
            } else {
                content.push(processed);
            }
        }
    }

    // Add footer
    content.push(
        { text: '', margin: [0, 30, 0, 0] },
        {
            canvas: [
                {
                    type: 'line',
                    x1: 0, y1: 0,
                    x2: 515, y2: 0,
                    lineWidth: 1,
                    lineColor: '#cccccc'
                }
            ],
            margin: [0, 0, 0, 10]
        },
        { text: 'FITZGERALD HR - AI-Powered Hospitality HR Solutions', bold: true, fontSize: 10, margin: [0, 0, 0, 4] },
        { text: 'Email: info@fitzgeraldhr.com.au', fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Generated: ${new Date().toLocaleDateString('en-AU')} at ${new Date().toLocaleTimeString('en-AU')}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Document ID: ${metadata.documentId || 'N/A'} | User: ${metadata.userName || currentUser}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: 'For personalised advice and document review, contact our Senior Consultants.', fontSize: 9, italics: true, color: '#666666' }
    );

    // Define document with styles
    return {
        content: content,
        styles: {
            header1: {
                fontSize: 18,
                bold: true,
                color: '#E2A14A',
                decoration: 'underline',
                decorationColor: '#E2A14A'
            },
            header2: {
                fontSize: 14,
                bold: true,
                color: '#1E3A5F',
                margin: [0, 12, 0, 6]
            },
            header3: {
                fontSize: 12,
                bold: true,
                color: '#1E3A5F'
            },
            bulletList: {
                fontSize: 11,
                lineHeight: 1.4
            }
        },
        defaultStyle: {
            fontSize: 11,
            font: 'Roboto',
            lineHeight: 1.3
        },
        pageMargins: [40, 40, 40, 60]
    };
}



async function generatePDFDocument(content, filename = 'document.pdf', metadata = {}) {
    try {
        // Check if pdfMake is loaded
        if (typeof pdfMake === 'undefined') {
            console.error('‚ùå pdfMake library not loaded');
            alert('PDF library not loaded. Please refresh the page and try again.');
            return false;
        }

        console.log('üìÑ Generating PDF with pdfMake...');

        // Convert content to HTML first
        const htmlContent = convertAIContentToHTML(content);
        
        // Parse HTML to pdfMake document definition
        const docDefinition = convertHTMLToPdfMake(htmlContent, metadata);
        
        console.log('‚úÖ Document definition created');

        // Generate PDF
        pdfMake.createPdf(docDefinition).download(filename);

        // Track document generation
        trackDocumentGeneration(filename, metadata);

        console.log('‚úÖ PDF generated successfully:', filename);
        return true;

    } catch (error) {
        console.error('‚ùå PDF generation error:', error);
        alert('Error generating PDF: ' + error.message);
        return false;
    }
}

        // ========================================
        // SMART DOCUMENT DETECTION & BUTTONS
        // ========================================
        
        function detectDocumentType(content) {
            const lowerContent = content.toLowerCase();
            
            const documentKeywords = {
                'employmentContract': ['employment contract', 'hire', 'new employee', 'employment agreement', 'contract of employment'],
                'warningLetter': ['warning', 'disciplinary', 'performance issue', 'misconduct', 'written warning'],
                'performanceReview': ['performance review', 'performance appraisal', 'performance evaluation', 'annual review']
            };
            
            for (const [docType, keywords] of Object.entries(documentKeywords)) {
                if (keywords.some(keyword => lowerContent.includes(keyword))) {
                    return docType;
                }
            }
            
            return null;
        }
        
        function extractDataFromConversation(messages, documentType) {
            // Parse conversation to extract relevant data
            const conversationText = messages.map(m => m.content).join(' ').toLowerCase();
            const data = {};
            
            // Extract employee name
            const nameMatch = conversationText.match(/(?:employee name|name is|called)\s+(?:is\s+)?([A-Z][a-z]+\s+[A-Z][a-z]+)/i);
            if (nameMatch) data.employeeName = nameMatch[1];
            
            // Extract position
            const positionMatch = conversationText.match(/(?:position|role|job)\s+(?:is|as|of)?\s+([a-z\s]+?)(?:\s|,|\.|$)/i);
            if (positionMatch) data.position = positionMatch[1].trim();
            
            // Extract date
            const dateMatch = conversationText.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
            if (dateMatch) data.startDate = dateMatch[1];
            
            // Extract rate
            const rateMatch = conversationText.match(/\$?(\d+(?:\.\d{2})?)\s*(?:per hour|\/hr|hourly)/i);
            if (rateMatch) data.baseRate = rateMatch[1];
            
            // Document-specific extraction
            if (documentType === 'warningLetter') {
                const issueMatch = conversationText.match(/(?:issue|problem|concern).*?(?:is|was|regarding)\s+([^.]+)/i);
                if (issueMatch) data.issue = issueMatch[1];
            }
            
            return data;
        }
        
        function addDocumentDownloadButtons(messageDiv, documentType, conversationData) {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-4 p-4 bg-slate-700/50 rounded-lg border border-amber-500/30';
            
            const documentNames = {
                'employmentContract': 'Employment Contract',
                'warningLetter': 'Warning Letter',
                'performanceReview': 'Performance Review'
            };
            
            buttonContainer.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <p class="text-amber-400 font-semibold flex items-center gap-2">
                        <span>üìÑ</span>
                        <span>Generate ${documentNames[documentType]}</span>
                    </p>
                </div>
                <p class="text-slate-300 text-sm mb-3">Based on our conversation, I can generate a customized template for you:</p>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="downloadDocument('${documentType}', 'word')" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                        <span>üìù</span> Download Word Doc
                    </button>
                    <button onclick="downloadDocument('${documentType}', 'pdf')" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                        <span>üìÑ</span> Download PDF
                    </button>
                </div>
                <p class="text-xs text-slate-400 mt-3 flex items-start gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span>This template must be reviewed by a Senior Consultant before use</span>
                </p>
            `;
            
            messageDiv.querySelector('.max-w-3xl').appendChild(buttonContainer);
        }
        
        function downloadDocument(documentType, format) {
            // Show disclaimer first
            const confirmed = confirm(
                "‚ö†Ô∏è IMPORTANT LEGAL DISCLAIMER\n\n" +
                "This document is a TEMPLATE generated by Fitz AI for guidance purposes only.\n\n" +
                "Before using this document:\n" +
                "‚úì You MUST have it reviewed by a Fitzgerald HR Senior Consultant\n" +
                "‚úì This ensures legal compliance and protects your business\n" +
                "‚úì Templates may need customization for your specific situation\n\n" +
                "Failure to have documents professionally reviewed may expose you to legal risks.\n\n" +
                "Contact: info@fitzgeraldhr.com.au\n\n" +
                "Click OK to download template, or Cancel to return."
            );
            
            if (!confirmed) return;
            
            // Extract data from conversation
            const data = extractDataFromConversation(conversationHistory, documentType);
            
            // Add metadata
            const metadata = {
                documentId: generateDocumentId(),
                userName: currentUser,
                generatedAt: new Date().toISOString(),
                documentType: documentType
            };
            
            // Generate document content
            const template = hrTemplates[documentType];
            if (!template) {
                alert('Template not found');
                return;
            }
            
            const content = template(data);
            
            // Generate filename
            const timestamp = new Date().toISOString().slice(0,10);
            const filename = `${documentType}_${timestamp}.${format === 'word' ? 'doc' : 'pdf'}`;
            
            // Download
            if (format === 'word') {
                generateWordDocument(content, filename, metadata);
            } else {
                generatePDFDocument(content, filename);
            }
            
            // Show confirmation
            alert(`‚úì Document downloaded: ${filename}\n\n` +
                  `Remember to have this reviewed by a Senior Consultant before use.\n` +
                  `Contact: info@fitzgeraldhr.com.au`);
        }
        

// ========================================
// PDF GENERATION HELPER FUNCTIONS
// ========================================

function convertAIContentToHTML(rawContent) {
    console.log('üîÑ Converting AI content to HTML...');
    
    let html = rawContent
        // Convert markdown headers to HTML
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        
        // REMOVE bold - just strip the ** markers
	.replace(/\*\*(.+?)\*\*/g, '$1')
        
        // Convert *italic* to <em>
        .replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>')
        
        // Convert bullet points
        .replace(/^[‚Ä¢\-\*] (.+)$/gm, '<li>$1</li>')
        
        // Wrap consecutive list items in <ul>
        .replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$&</ul>')
        
        // Convert double line breaks to paragraph breaks
        .split('\n\n')
        .map(block => {
            block = block.trim();
            if (!block) return '';
            
            // Skip if already HTML element
            if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<div')) {
                return block;
            }
            
            // Convert single line breaks to <br>
            block = block.replace(/\n/g, '<br>');
            
            // Wrap in paragraph
            return '<p>' + block + '</p>';
        })
        .join('\n\n');
    
    console.log('‚úÖ Converted to HTML');
    return html;
}

function convertHTMLToPdfMake(html, metadata) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = [];

    const processNode = (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            if (text) {
                return { text: text };
            }
            return null;
        }

        if (node.nodeType !== Node.ELEMENT_NODE) return null;

        const tagName = node.tagName.toLowerCase();

        switch (tagName) {
            case 'h1':
                return {
                    text: node.textContent.trim(),
                    style: 'header1',
                    margin: [0, 10, 0, 5]
                };

            case 'h2':
                return {
                    text: node.textContent.trim(),
                    style: 'header2',
                    margin: [0, 8, 0, 4]
                };

            case 'h3':
                return {
                    text: node.textContent.trim(),
                    style: 'header3',
                    margin: [0, 6, 0, 3]
                };

            case 'p':
                const pContent = [];
                for (const child of node.childNodes) {
                    const processed = processInlineNode(child);
                    if (processed) {
                        if (Array.isArray(processed)) {
                            pContent.push(...processed);
                        } else {
                            pContent.push(processed);
                        }
                    }
                }
                return {
                    text: pContent.length > 0 ? pContent : node.textContent.trim(),
                    margin: [0, 0, 0, 5]
                };

            case 'ul':
                const listItems = [];
                for (const li of node.querySelectorAll('li')) {
                    listItems.push(li.textContent.trim());
                }
                return {
                    ul: listItems,
                    margin: [0, 0, 0, 5]
                };

            case 'li':
                return {
                    text: node.textContent.trim(),
                    margin: [0, 0, 0, 2]
                };

            case 'br':
                return { text: '', margin: [0, 3, 0, 0] };

            default:
                const children = [];
                for (const child of node.childNodes) {
                    const processed = processNode(child);
                    if (processed) children.push(processed);
                }
                return children.length > 0 ? children : null;
        }
    };

    const processInlineNode = (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            return text ? { text: text } : null;
        }

        const tagName = node.tagName?.toLowerCase();
        const text = node.textContent.trim();

        if (!text) return null;

        switch (tagName) {
            case 'strong':
            case 'b':
                return { text: text, bold: true };
            case 'em':
            case 'i':
                return { text: text, italics: true };
            default:
                return { text: text };
        }
    };

    // Process all body children
    for (const child of doc.body.childNodes) {
        const processed = processNode(child);
        if (processed) {
            if (Array.isArray(processed)) {
                content.push(...processed);
            } else {
                content.push(processed);
            }
        }
    }

    // Add footer
    content.push(
        { text: '', margin: [0, 20, 0, 0] },
        {
            canvas: [
                {
                    type: 'line',
                    x1: 0, y1: 0,
                    x2: 515, y2: 0,
                    lineWidth: 1,
                    lineColor: '#cccccc'
                }
            ],
            margin: [0, 0, 0, 10]
        },
        { text: 'FITZGERALD HR - AI-Powered Hospitality HR Solutions', bold: true, fontSize: 10, margin: [0, 0, 0, 4] },
        { text: 'Email: info@fitzgeraldhr.com.au', fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Generated: ${new Date().toLocaleDateString('en-AU')} at ${new Date().toLocaleTimeString('en-AU')}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Document ID: ${metadata.documentId || 'N/A'} | User: ${metadata.userName || currentUser}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: 'For personalised advice and document review, contact our Senior Consultants.', fontSize: 9, italics: true, color: '#666666' }
    );

    // Define document with styles
    return {
        content: content,
        styles: {
            header1: {
                fontSize: 18,
                bold: true,
                color: '#E2A14A',
                decoration: 'underline',
                decorationColor: '#E2A14A'
            },
            header2: {
                fontSize: 14,
                bold: true,
                color: '#1E3A5F'
            },
            header3: {
                fontSize: 12,
                bold: true,
                color: '#1E3A5F'
            }
        },
        defaultStyle: {
            fontSize: 11,
            font: 'Roboto'
        },
        pageMargins: [40, 40, 40, 40]
    };
}

async function generatePDFDocument(content, filename = 'document.pdf', metadata = {}) {
    // ... your existing generatePDFDocument code ...
}


        function generatePDFDocument(content, filename = 'document.pdf') {
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>${filename}</title>
    <style>
        @media print {
            body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20mm; font-size: 11pt; }
            h1 { color: #E2A14A; border-bottom: 3px solid #E2A14A; page-break-after: avoid; }
            h2 { color: #1E3A5F; page-break-after: avoid; margin-top: 20px; }
            .warning { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 15px; page-break-inside: avoid; }
            .no-print { display: none; }
            .header { text-align: center; margin-bottom: 20px; }
        }
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }
        h1 { color: #E2A14A; border-bottom: 3px solid #E2A14A; }
        h2 { color: #1E3A5F; margin-top: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .warning { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 20px; margin: 25px 0; }
        ul { margin-left: 20px; }
        li { margin-bottom: 8px; }
    </style>
</head>
<body>
    ${content}
    <div class="no-print" style="margin-top: 40px; text-align: center; padding: 20px; background: #f0f0f0; border-radius: 10px;">
        <p style="margin-bottom: 15px; font-size: 16px; color: #333;">Use your browser's print function and select "Save as PDF"</p>
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 16px; background: #E2A14A; border: none; color: white; border-radius: 5px; cursor: pointer; margin-right: 10px;">Print / Save as PDF</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 16px; background: #666; border: none; color: white; border-radius: 5px; cursor: pointer;">Close</button>
    </div>
</body>
</html>`);
            
            printWindow.document.close();
            return true;
        }
        
        // ========================================
        // ADVANCED FEATURES
        // ========================================
        
        // 1. Document Metadata Tracking
        function trackDocumentGeneration(filename, metadata) {
            const documentLog = {
                filename: filename,
                user: currentUser,
                timestamp: new Date().toISOString(),
                ...metadata
            };
            
            // Store in localStorage for tracking
            const existingLogs = JSON.parse(localStorage.getItem('documentGenerationLogs') || '[]');
            existingLogs.push(documentLog);
            localStorage.setItem('documentGenerationLogs', JSON.stringify(existingLogs));
            
            // Also track as event
            trackEvent('document_generated', documentLog);
            
            console.log('Document generated:', documentLog);
        }
        
        function generateDocumentId() {
            return 'DOC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

// ========================================
// DOCUMENT BUILDER SYSTEM
// ========================================

const documentBuilderState = {
    currentType: null,
    currentStep: 1,
    totalSteps: 0,
    data: {},
    generatedDocument: null,
    isGenerating: false,
    lastGeneratedDocId: null
};

// Document template configurations
const documentWizardSteps = {
formalWarning: [
    // ‚úÖ STEP 1: Procedural Fairness Check
    {
        id: 1,
        title: "Procedural Fairness Checkpoint",
        fields: [
            { 
                name: "completedRecordOfDiscussion", 
                label: "Have you completed the Record of Discussion process? (i.e., held a documented conversation where allegations were presented and the employee was given the opportunity to respond)", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            }
        ]
    },
    // ‚úÖ NEW STEP 2: Upload Record of Discussion (OPTIONAL BUT RECOMMENDED)
    {
        id: 2,
        title: "Upload Record of Discussion (Highly Recommended)",
        description: "Uploading your completed Record of Discussion will help Fitz AI create a more accurate and comprehensive Formal Warning letter by using the employee's actual responses and the specific details from your discussion.",
        fields: [
            {
                name: "rodUpload",
                label: "Upload your completed Record of Discussion",
                type: "file",
                accept: ".pdf,.docx,.doc,.png,.jpg,.jpeg",
                required: false,
                helpText: "Accepts: PDF, Word documents, or images of handwritten records"
            }
        ],
        showIf: { field: "completedRecordOfDiscussion", value: "Yes" }
    },
    // ‚úÖ STEP 3: Meeting Preparation
    {
        id: 3,
        title: "Outcome Meeting Preparation - CRITICAL",
        fields: [
            { 
                name: "providedNotice24hours", 
                label: "Have you set up the outcome meeting and provided at least 24 hours notice?", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            },
            { 
                name: "offeredSupportPerson", 
                label: "Have you offered the employee the opportunity to have a support person present?", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            }
        ]
    },
    // ‚úÖ STEP 4: Employee Details (was Step 3)
    {
        id: 4,
        title: "Employee Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Blake Smith" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Chef" },
            { name: "employmentType", label: "Employment Type", type: "select", 
              options: ["Full-Time", "Part-Time", "Casual"], required: true }
        ]
    },
    // ‚úÖ STEP 5: What Happened? (was Step 4)
    {
        id: 5,
        title: "What Happened?",
        fields: [
            { name: "issueDescription", label: "Briefly describe the issue", 
              type: "textarea", placeholder: "e.g., Repeatedly late for shifts", required: true, rows: 3 },
            { name: "issueDate", label: "When did this occur? (most recent)", type: "date", required: true },
            { name: "witnesses", label: "Any witnesses? (optional)", type: "text", required: false, placeholder: "Names of witnesses" }
        ]
    },
    // ‚úÖ STEP 6: Previous Action (was Step 5)
    {
        id: 6,
        title: "Previous Action",
        fields: [
            { name: "hadVerbalWarnings", label: "Have you given verbal warnings?", 
              type: "radio", options: ["Yes", "No"], required: true },
            { name: "verbalWarningCount", label: "How many verbal warnings?", 
              type: "number", min: 1, max: 10, placeholder: "e.g., 3",
              showIf: { field: "hadVerbalWarnings", value: "Yes" } },
            { name: "warningLevel", label: "This warning is:", type: "select",
              options: ["First formal warning", "Second formal warning", "Final warning"], required: true }
        ]
    },
    // ‚úÖ STEP 7: What Needs to Change? (was Step 6)
    {
        id: 7,
        title: "What Needs to Change?",
        fields: [
            { name: "expectations", label: "What specific improvements do you expect?", 
              type: "textarea", placeholder: "e.g., Arrive on time for all shifts", required: true, rows: 3 },
            { name: "timeframe", label: "Timeframe for improvement", type: "select",
              options: ["Immediate", "2 weeks", "1 month", "3 months"], required: true }
        ]
    },
    // ‚úÖ STEP 8: Consequences (was Step 7)
    {
        id: 8,
        title: "Consequences",
        fields: [
            { name: "consequences", label: "What happens if behaviour continues?", 
              type: "textarea", placeholder: "e.g., Further disciplinary action up to and including termination", 
              required: true, rows: 2 }
        ]
    }
],
    recordOfDiscussion: [
    {
        id: 1,
        title: "Employee Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Waiter" }
        ]
    },
    {
        id: 2,
        title: "Meeting Preparation - CRITICAL",
        fields: [
            { name: "notice24hours", label: "Has employee been provided 24 hours notice of the meeting?", 
              type: "radio", options: ["Yes", "No"], required: true },
            { name: "supportPersonOffered", label: "Has employee been offered to bring a support person to the meeting?", 
              type: "radio", options: ["Yes", "No"], required: true }
        ]
    },
    {
        id: 3,
        title: "Issue Details",
        fields: [
            { name: "allegations", label: "What is/are the allegation(s)? (List them clearly)", 
              type: "textarea", required: true, rows: 4, 
              placeholder: "e.g., Late to shift on 3 occasions\nIncorrect uniform worn\nRude to customer" },
            { name: "witnesses", label: "Were there any witnesses?", 
              type: "text", required: false, placeholder: "Names of witnesses (if any)" }
        ]
    }
],

    performanceImprovementPlan: [
        // Step 1: Employee Details
        {
            id: 1,
            title: "Employee Details",
            fields: [
                { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
                { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Waiter" },
                { name: "employmentType", label: "Employment Type", type: "select", 
                  options: ["Full-Time", "Part-Time", "Casual"], required: true },
                { name: "managerName", label: "Manager/Supervisor Name", type: "text", required: true, placeholder: "Your name" }
            ]
        },
        
        // Step 2: Performance Issues (Data-Driven)
        {
            id: 2,
            title: "Performance Issues - Be Specific",
            fields: [
                { name: "performanceIssue1", label: "Issue #1 - What specific performance problem?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Slow service - average drink prep time is 4 minutes vs team average of 2.5 minutes" },
                { name: "performanceData1", label: "What data/evidence supports this?", 
                  type: "textarea", required: true, rows: 2,
                  placeholder: "e.g., Till data shows 12 customer complaints in last month about wait times. Guest review average 2.8/5 stars." },
                { name: "performanceIssue2", label: "Issue #2 (optional)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Order accuracy errors - 15% error rate vs team average of 3%" },
                { name: "performanceData2", label: "Data/evidence for Issue #2", 
                  type: "textarea", required: false, rows: 2,
                  placeholder: "e.g., POS system shows 18 incorrect orders in last 2 weeks" }
            ]
        },
        
        // Step 3: SMART Goals
        {
            id: 3,
            title: "SMART Goals - What Must Improve?",
            fields: [
                { name: "goal1", label: "Goal #1 (Specific, Measurable, Achievable, Relevant, Time-bound)", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Reduce average drink preparation time from 4 minutes to 2.5 minutes within 4 weeks" },
                { name: "goal2", label: "Goal #2 (if applicable)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Achieve order accuracy of 97% or higher (max 1 error per 30 orders) within 8 weeks" },
                { name: "goal3", label: "Goal #3 (if applicable)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Improve guest satisfaction score to 4.2/5 or higher within 12 weeks" }
            ]
        },
        
        // Step 4: Action Plan & Support
        {
            id: 4,
            title: "Action Plan - How Will We Help Them Improve?",
            fields: [
                { name: "trainingProvided", label: "What training/coaching will be provided?", 
                  type: "textarea", required: true, rows: 4,
                  placeholder: "e.g., \n‚Ä¢ 2-hour cocktail making refresher course (Week 1)\n‚Ä¢ Shadow experienced bartender for 3 shifts (Week 2)\n‚Ä¢ Daily 15-min coaching sessions with supervisor (Weeks 1-4)\n‚Ä¢ Access to online mixology tutorials" },
                { name: "resourcesProvided", label: "What resources/tools will be provided?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Recipe cards, speed pouring practice kit, timer for self-monitoring" },
                { name: "managerSupport", label: "What will the manager/supervisor do to support?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Weekly one-on-one check-ins, real-time feedback during shifts, track progress data" }
            ]
        },
        
        // Step 5: Employee Responsibilities
        {
            id: 5,
            title: "Employee Responsibilities",
            fields: [
                { name: "employeeActions", label: "What is the employee expected to do?", 
                  type: "textarea", required: true, rows: 4,
                  placeholder: "e.g., \n‚Ä¢ Attend all scheduled training sessions\n‚Ä¢ Practice drink preparation techniques during quiet periods\n‚Ä¢ Review recipe cards before each shift\n‚Ä¢ Ask for help when unsure\n‚Ä¢ Track own times and report progress weekly" }
            ]
        },
        
        // Step 6: Review Schedule
        {
            id: 6,
            title: "Review Schedule & Timeline",
            fields: [
                { name: "pipStartDate", label: "PIP Start Date", type: "date", required: true },
                { name: "weeklyCheckins", label: "Weekly check-in day/time", type: "text", required: true, 
                  placeholder: "e.g., Every Monday at 10am" },
                { name: "week4ReviewDate", label: "Week 4 Formal Review Date", type: "date", required: true },
                { name: "week8ReviewDate", label: "Week 8 Formal Review Date", type: "date", required: true },
                { name: "week12ReviewDate", label: "Week 12 Final Review Date", type: "date", required: true }
            ]
        },
        
        // Step 7: Consequences
        {
            id: 7,
            title: "Consequences - What Happens If No Improvement?",
            fields: [
                { name: "week4Consequence", label: "If no significant improvement by Week 4:", 
                  type: "select", required: true,
                  options: ["First Formal Warning for Performance", "Extend PIP by 4 weeks with modified goals", "Other (specify in notes)"] },
                { name: "week8Consequence", label: "If no significant improvement by Week 8:", 
                  type: "select", required: true,
                  options: ["Second Formal Warning for Performance", "Final Written Warning", "Other (specify in notes)"] },
                { name: "week12Consequence", label: "If no significant improvement by Week 12:", 
                  type: "select", required: true,
                  options: ["Termination of employment", "Demotion to different role", "Extended PIP (only if substantial progress made)", "Other (specify in notes)"] },
                { name: "consequenceNotes", label: "Additional notes on consequences (optional)", 
                  type: "textarea", required: false, rows: 2 }
            ]
        },
        
        // Step 8: Final Confirmation
        {
            id: 8,
            title: "Final Confirmation",
            fields: [
                { name: "pipDiscussed", label: "Have you discussed this PIP with the employee before creating it?", 
                  type: "radio", options: ["Yes - we've had a preliminary discussion", "No - this is the first formal step"], required: true },
                { name: "supportPersonOffered", label: "Will you offer the employee the right to have a support person when presenting the PIP?", 
                  type: "radio", options: ["Yes", "No"], required: true },
                { name: "additionalNotes", label: "Any additional notes or context?", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "Optional: Any other relevant information" }
            ]
        }
    ],

    letterOfAllegation: [
        {
            id: 1,
            title: "Employee Details",
            fields: [
                { name: "employeeName", label: "Employee's full name", type: "text", required: true },
                { name: "position", label: "Position/Role", type: "text", required: true },
                { name: "employmentType", label: "Employment Type", type: "select", 
                  options: ["Full-Time", "Part-Time", "Casual"], required: true }
            ]
        },
        {
            id: 2,
            title: "Meeting Preparation - CRITICAL",
            fields: [
                { 
                    name: "notice24hours", 
                    label: "Has employee been provided 24 hours notice of the meeting?", 
                    type: "radio", 
                    options: ["Yes", "No"], 
                    required: true 
                },
                { 
                    name: "supportPersonOffered", 
                    label: "Has employee been offered to bring a support person to the meeting?", 
                    type: "radio", 
                    options: ["Yes", "No"], 
                    required: true 
                }
            ]
        },
        {
            id: 3,
            title: "Allegation Details",
            fields: [
                { name: "allegationType", label: "Type of allegation", type: "select",
                  options: ["Theft", "Harassment", "Bullying", "Serious safety breach", "Fraud", "Violence/threats", "Other serious misconduct"],
                  required: true },
                { name: "allegationDescription", label: "Describe the allegation", 
                  type: "textarea", required: true, rows: 4, 
                  placeholder: "What specifically is alleged to have occurred?" },
                { name: "incidentDate", label: "Date of alleged incident", type: "date", required: true }
            ]
        },
        {
            id: 4,
            title: "Source & Evidence",
            fields: [
                { name: "allegationSource", label: "Who made the allegation?", type: "select",
                  options: ["Anonymous complaint", "Named complainant", "Management observed", "Multiple witnesses"],
                  required: true },
                { name: "evidenceExists", label: "What evidence exists?", 
                  type: "textarea", required: false, rows: 2,
                  placeholder: "e.g., Witness statements, CCTV, documents" }
            ]
        },
        {
            id: 5,
            title: "Investigation Process",
            fields: [
                { name: "investigator", label: "Who will conduct the investigation?", type: "text",
                  required: true, placeholder: "e.g., HR Manager, External investigator" },
                { name: "suspensionRequired", label: "Suspension during investigation?", type: "select",
                  options: ["No suspension - continue work", "Yes - on full pay", "Yes - without pay (serious misconduct only)"],
                  required: true }
            ]
        },
        {
            id: 6,
            title: "Investigation Meeting",
            fields: [
                { name: "meetingDate", label: "Meeting date", type: "date", required: true },
                { name: "meetingTime", label: "Meeting time", type: "time", required: true },
                { name: "meetingLocation", label: "Meeting location", type: "text", required: true }
            ]
        }
    ]
};

function selectDocumentType(type) {
    documentBuilderState.currentType = type;
    documentBuilderState.currentStep = 1;
    documentBuilderState.data = {};
    documentBuilderState.totalSteps = documentWizardSteps[type].length;
    
    // Hide template selection
    document.getElementById('documentTemplateSelection').classList.add('hidden');
    
    // Show wizard
    document.getElementById('documentWizardSteps').classList.remove('hidden');
    
    // Update total steps
    document.getElementById('docTotalSteps').textContent = documentBuilderState.totalSteps;
    
    // Show first step
    showDocumentStep(1);
    
    trackEvent('document_type_selected', { user: currentUser, type: type });
}

function showDocumentStep(stepNumber) {
    const steps = documentWizardSteps[documentBuilderState.currentType];
    const step = steps[stepNumber - 1];
    
    if (!step) return;
    
    // Update progress
    document.getElementById('docCurrentStep').textContent = stepNumber;
    const progress = Math.round((stepNumber / documentBuilderState.totalSteps) * 100);
    document.getElementById('docProgress').textContent = `${progress}% Complete`;
    document.getElementById('docProgressBar').style.width = `${progress}%`;
    
    // Build step HTML
    let html = `<h3 class="text-xl font-bold text-white mb-4">${step.title}</h3><div class="space-y-4">`;
    
    step.fields.forEach(field => {
        // Check conditional display
        if (field.showIf) {
            const conditionField = field.showIf.field;
            const conditionValue = field.showIf.value;
            if (documentBuilderState.data[conditionField] !== conditionValue) {
                return; // Skip this field
            }
        }
        
        html += `<div>`;
        html += `<label class="block text-slate-300 text-sm mb-2">
                    ${field.label}${field.required ? ' <span class="text-red-400">*</span>' : ''}
                 </label>`;
        
        if (field.type === 'text') {
            html += `<input type="text" id="field_${field.name}" 
                           placeholder="${field.placeholder || ''}"
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="field_${field.name}" rows="${field.rows || 3}"
                              placeholder="${field.placeholder || ''}"
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                              ${field.required ? 'required' : ''}>${documentBuilderState.data[field.name] || ''}</textarea>`;
        } else if (field.type === 'select') {
            html += `<select id="field_${field.name}" 
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                            ${field.required ? 'required' : ''}>
                        <option value="">Select...</option>`;
            field.options.forEach(opt => {
                const selected = documentBuilderState.data[field.name] === opt ? 'selected' : '';
                html += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            html += `</select>`;
        } else if (field.type === 'radio') {
            field.options.forEach(opt => {
                const checked = documentBuilderState.data[field.name] === opt ? 'checked' : '';
                html += `<label class="flex items-center gap-2 text-slate-300 mb-2">
                            <input type="radio" name="field_${field.name}" value="${opt}" ${checked}
                                   class="text-amber-500">
                            <span>${opt}</span>
                         </label>`;
            });
        } else if (field.type === 'date') {
            const today = new Date().toISOString().split('T')[0];
            html += `<input type="date" id="field_${field.name}" 
                           value="${documentBuilderState.data[field.name] || today}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'time') {
            html += `<input type="time" id="field_${field.name}" 
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'number') {
            html += `<input type="number" id="field_${field.name}" 
                           min="${field.min || 0}" max="${field.max || 100}"
                           placeholder="${field.placeholder || ''}"
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'file') {
            // File upload for ROD
            html += `
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
                    <p class="text-blue-300 text-sm mb-3">
                        <strong>üí° Highly Recommended:</strong> Uploading your Record of Discussion helps Fitz AI create a better warning letter by using the employee's actual responses and discussion details.
                    </p>
                </div>
                <div class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center hover:border-amber-500 transition-colors">
                    <input type="file" id="field_${field.name}" 
                           accept="${field.accept || '*'}"
                           class="hidden"
                           onchange="handleRODUpload(event)">
                    <button type="button" onclick="document.getElementById('field_${field.name}').click()"
                            class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold px-6 py-3 rounded-lg mb-3">
                        üìÑ Upload File
                    </button>
                    <p class="text-slate-400 text-sm">${field.helpText || 'Click to select a file'}</p>
                    <div id="rodUploadStatus" class="mt-3"></div>
                </div>
                <div class="flex justify-center mt-4">
                    <button type="button" onclick="confirmSkipRODUpload()"
                            class="text-slate-400 hover:text-white text-sm underline">
                        Skip this step
                    </button>
                </div>
            `;
        }
        
        html += `</div>`;
    });
    
    html += `</div>`;
    
    document.getElementById('documentStepContent').innerHTML = html;
    
    // Show/hide back button
    document.getElementById('docBackBtn').style.display = stepNumber > 1 ? 'block' : 'none';
    
    // Update next button text
    const nextBtn = document.getElementById('docNextBtn');
    if (stepNumber === documentBuilderState.totalSteps) {
        nextBtn.innerHTML = '‚ú® Generate Document';
    } else {
        nextBtn.innerHTML = 'Next Step ‚Üí';
    }

// Show/hide start over button based on step
const startOverBtn = document.getElementById('docStartOverBtn');
if (startOverBtn) {
    if (stepNumber > 1) {
        startOverBtn.classList.remove('hidden');
    } else {
        startOverBtn.classList.add('hidden');
    }
}

}

// Handle ROD file upload
var rodUploadedFile = null;
var rodExtractedData = null;

async function handleRODUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('üìÑ ROD file uploaded:', file.name);
    
    // Show uploading status
    const statusDiv = document.getElementById('rodUploadStatus');
    statusDiv.innerHTML = '<p class="text-blue-400">üì§ Processing file...</p>';
    
    try {
        // Read file
        const fileData = await readFileAsBase64(file);
        rodUploadedFile = {
            name: file.name,
            type: file.type,
            data: fileData
        };
        
        // Extract text/data from file
        const extractedText = await extractRODContent(file);
        
        // Show success
        statusDiv.innerHTML = `
            <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-3">
                <p class="text-green-400 font-semibold">‚úÖ Record uploaded - Fitz AI will use this context</p>
                <p class="text-slate-300 text-sm mt-1">${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
            </div>
        `;
        
        // Store in documentBuilderState
        documentBuilderState.data.rodUpload = true;
        documentBuilderState.data.rodFileName = file.name;
        documentBuilderState.data.rodFileData = fileData;
        documentBuilderState.data.rodExtractedText = extractedText;
        
        showToast('‚úÖ Record of Discussion uploaded successfully!', 'success', 3000);
        
    } catch (error) {
        console.error('ROD upload error:', error);
        statusDiv.innerHTML = '<p class="text-red-400">‚ùå Error processing file. Please try again.</p>';
        showToast('Error processing file', 'error', 3000);
    }
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function extractRODContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const fileName = file.name.toLowerCase();
            let text = '';
            
            if (fileName.endsWith('.txt')) {
                text = e.target.result;
            } else if (fileName.endsWith('.csv')) {
                text = e.target.result;
            } else {
                // For PDF, Word, Images - placeholder text
                text = `File: ${file.name}\nType: ${file.type}\nSize: ${(file.size / 1024).toFixed(2)} KB\n\n`;
                text += '[Document uploaded for AI analysis]';
            }
            
            resolve(text);
        };
        
        reader.onerror = reject;
        
        if (file.name.toLowerCase().endsWith('.txt') || file.name.toLowerCase().endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}

function confirmSkipRODUpload() {
    const confirmed = confirm(
        '‚ö†Ô∏è Skip Upload?\n\n' +
        'For a better Formal Warning letter, uploading your completed Record of Discussion is strongly advised.\n\n' +
        'The ROD provides:\n' +
        '‚Ä¢ Employee\'s actual responses\n' +
        '‚Ä¢ Specific details from the discussion\n' +
        '‚Ä¢ Better context for the warning letter\n\n' +
        'Are you sure you want to skip this step?'
    );
    
    if (confirmed) {
        // Mark as skipped
        documentBuilderState.data.rodUpload = false;
        documentBuilderState.data.rodSkipped = true;
        
        // Move to next step
        documentBuilderState.currentStep++;
        showDocumentStep(documentBuilderState.currentStep);
    }
}

function docWizardNext() {
    // Save current step data
    const steps = documentWizardSteps[documentBuilderState.currentType];
    const step = steps[documentBuilderState.currentStep - 1];
    
    let allValid = true;
    
    step.fields.forEach(field => {
        // Skip if conditional and not shown
        if (field.showIf) {
            const conditionField = field.showIf.field;
            const conditionValue = field.showIf.value;
            if (documentBuilderState.data[conditionField] !== conditionValue) {
                return;
            }
        }
        
        let value;
        if (field.type === 'radio') {
            const radio = document.querySelector(`input[name="field_${field.name}"]:checked`);
            value = radio ? radio.value : '';
        } else if (field.type === 'file') {
            // File upload is optional - check if uploaded or skipped
            value = documentBuilderState.data[field.name] || '';
            // Don't require validation for file type
            return; // Skip validation for file field
        } else {
            const element = document.getElementById(`field_${field.name}`);
            value = element ? element.value.trim() : '';
        }
        
        if (field.required && !value) {
            allValid = false;
            alert(`Please fill in: ${field.label}`);
        }
        
        documentBuilderState.data[field.name] = value;
    });
    
    if (!allValid) return;
    
    // ‚úÖ VALIDATION FOR FORMAL WARNING
    if (documentBuilderState.currentType === 'formalWarning') {
        if (!validateFormalWarningProceduralFairness()) {
            return;
        }
    }
    
    // ‚úÖ VALIDATION FOR LETTER OF ALLEGATION
    if (documentBuilderState.currentType === 'letterOfAllegation') {
        if (!validateLetterOfAllegationMeetingPrep()) {
            return;
        }
    }
    
    // ‚úÖ VALIDATION FOR RECORD OF DISCUSSION
    if (documentBuilderState.currentType === 'recordOfDiscussion' && documentBuilderState.currentStep === 2) {
        if (!validateRecordOfDiscussionStep2()) {
            return;
        }
    }
    
    // Move to next step or generate
    if (documentBuilderState.currentStep < documentBuilderState.totalSteps) {
        documentBuilderState.currentStep++;
        showDocumentStep(documentBuilderState.currentStep);
    } else {
        // All steps complete - generate document
        generateDocumentWithAI();
    }
}


function validateFormalWarningProceduralFairness() {
    // Only validate on Step 1 and Step 2
    if (documentBuilderState.currentStep === 1) {
        const completedROD = documentBuilderState.data.completedRecordOfDiscussion;
        
        if (completedROD === 'No') {
            alert(
                '‚ö†Ô∏è PROCEDURAL FAIRNESS REQUIRED\n\n' +
                'You MUST complete the Record of Discussion process before issuing a Formal Warning.\n\n' +
                'This means:\n' +
                '1. Hold a documented conversation with the employee\n' +
                '2. Present the allegations/concerns\n' +
                '3. Give the employee the opportunity to respond\n' +
                '4. Document their response\n\n' +
                'Without this step, a Formal Warning may be deemed procedurally unfair.\n\n' +
                'Please complete the Record of Discussion first.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: 'rod_not_completed',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.completedRecordOfDiscussion = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        return true;
    }
    
    if (documentBuilderState.currentStep === 2) {
        const providedNotice = documentBuilderState.data.providedNotice24hours;
        const offeredSupport = documentBuilderState.data.offeredSupportPerson;
        
        if (providedNotice === 'No') {
            alert(
                '‚ö†Ô∏è IMPORTANT: You must provide the employee with 24 hours notice before the outcome meeting.\n\n' +
                'This is a requirement of procedural fairness.\n\n' +
                'Please schedule the outcome meeting for at least 24 hours from now before continuing.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: '24_hour_notice_not_provided',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.providedNotice24hours = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        if (offeredSupport === 'No') {
            alert(
                '‚ö†Ô∏è IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
                'A support person can be:\n' +
                '‚Ä¢ A family member or friend\n' +
                '‚Ä¢ A union representative\n' +
                '‚Ä¢ A fellow employee (if appropriate)\n\n' +
                'Please inform the employee of this right before continuing.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: 'support_person_not_offered',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.offeredSupportPerson = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        return true;
    }
    
    return true;
}

function validateLetterOfAllegationMeetingPrep() {
    // Only validate on Step 2 (Meeting Preparation)
    if (documentBuilderState.currentStep !== 2) {
        return true;
    }
    
    const notice24hours = documentBuilderState.data.notice24hours;
    const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
    
    // Check 24 hours notice
    if (notice24hours === 'No') {
        alert(
            '‚ö†Ô∏è IMPORTANT: You must provide the employee with 24 hours notice before the meeting.\n\n' +
            'This is a requirement of procedural fairness.\n\n' +
            'Please schedule the meeting for at least 24 hours from now before continuing.'
        );
        
        trackEvent('procedural_fairness_violation', {
            user: currentUser,
            violation: '24_hour_notice_not_provided',
            documentType: 'letterOfAllegation'
        });
        
        // Clear the answer so they can correct it
        documentBuilderState.data.notice24hours = '';
        
        // Re-render the current step
        showDocumentStep(documentBuilderState.currentStep);
        
        return false;
    }
    
    // Check support person offered
    if (supportPersonOffered === 'No') {
        alert(
            '‚ö†Ô∏è IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
            'A support person can be:\n' +
            '‚Ä¢ A family member or friend\n' +
            '‚Ä¢ A union representative\n' +
            '‚Ä¢ A fellow employee (if appropriate and no conflict of interest)\n\n' +
            'Please inform the employee of this right before continuing.'
        );
        
        trackEvent('procedural_fairness_violation', {
            user: currentUser,
            violation: 'support_person_not_offered',
            documentType: 'letterOfAllegation'
        });
        
        // Clear the answer so they can correct it
        documentBuilderState.data.supportPersonOffered = '';
        
        // Re-render the current step
        showDocumentStep(documentBuilderState.currentStep);
        
        return false;
    }
    
    return true; // Both checks passed
}

function validateRecordOfDiscussionStep2() {
    const notice24hours = documentBuilderState.data.notice24hours;
    const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
    
    // Check 24 hours notice
    if (notice24hours === 'No') {
        alert('‚ö†Ô∏è IMPORTANT: You must provide the employee with 24 hours notice before the meeting.\n\n' +
              'This is a requirement of procedural fairness.\n\n' +
              'Please schedule the meeting for at least 24 hours from now before continuing.');
        return false;
    }
    
    // Check support person
    if (supportPersonOffered === 'No') {
        alert('‚ö†Ô∏è IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
              'A support person can be:\n' +
              '‚Ä¢ A family member or friend\n' +
              '‚Ä¢ A union representative\n' +
              '‚Ä¢ A fellow employee (if appropriate and no conflict of interest)\n\n' +
              'Please inform the employee of this right before continuing.');
        return false;
    }
    
    return true;
}

function validateRecordOfDiscussionStep2() {
    const notice24hours = documentBuilderState.data.notice24hours;
    const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
    
    // Check 24 hours notice
    if (notice24hours === 'No') {
        alert('‚ö†Ô∏è IMPORTANT: You must provide the employee with 24 hours notice before the meeting.\n\n' +
              'This is a requirement of procedural fairness.\n\n' +
              'Please schedule the meeting for at least 24 hours from now before continuing.');
        return false;
    }
    
    // Check support person
    if (supportPersonOffered === 'No') {
        alert('‚ö†Ô∏è IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
              'A support person can be:\n' +
              '‚Ä¢ A family member or friend\n' +
              '‚Ä¢ A union representative\n' +
              '‚Ä¢ A fellow employee (if appropriate and no conflict of interest)\n\n' +
              'Please inform the employee of this right before continuing.');
        return false;
    }
    
    return true;
}

function docWizardGoBack() {
    if (documentBuilderState.currentStep > 1) {
        documentBuilderState.currentStep--;
        showDocumentStep(documentBuilderState.currentStep);
    }
}

async function generateDocumentWithAI() {
    console.log('üìÑ generateDocumentWithAI() called');
    console.log('üìÑ Document type:', documentBuilderState.currentType);
    console.log('üìÑ Wizard data at generation:', JSON.stringify(documentBuilderState.data, null, 2));
    
    // Hide wizard, show loading
    document.getElementById('documentWizardSteps').classList.add('hidden');
    document.getElementById('documentGenerating').classList.remove('hidden');
    
    documentBuilderState.isGenerating = true;
    
    try {
        const prompt = buildDocumentPrompt();
        console.log('üìÑ Prompt built, calling Claude API...');
        
        const response = await callClaudeAPI(prompt);
        console.log('üìÑ Response received from API');
        
        documentBuilderState.generatedDocument = response;
        
        // ‚úÖ STORE the document ID that was just logged
        // This happens BEFORE any resets
        const logResult = await logDocumentGeneration();
        
        // ‚úÖ Store the database ID so we can update it later
        if (logResult && logResult.id) {
            documentBuilderState.lastGeneratedDocId = logResult.id;
            console.log('‚úÖ Stored document database ID:', logResult.id);
        }
        
        console.log('‚úÖ Document generation logged successfully');
        
        // Close document builder modal
        closeToolModal('documentBuilderModal');
        
        // Show preview modal
        showDocumentPreview(response);
        
        trackEvent('document_generated_ai', {
            user: currentUser,
            type: documentBuilderState.currentType,
            employeeName: documentBuilderState.data.employeeName
        });
        
    } catch (error) {
        console.error('‚ùå Document generation error:', error);
        alert('‚ö†Ô∏è Error generating document. Please try again or contact support.');
        
        // Reset to wizard
        document.getElementById('documentGenerating').classList.add('hidden');
        document.getElementById('documentWizardSteps').classList.remove('hidden');
    } finally {
        documentBuilderState.isGenerating = false;
    }
}

function buildDocumentPrompt() {
    const type = documentBuilderState.currentType;
    const data = documentBuilderState.data;
    
    const venueContext = venueProfile.setupComplete ? 
        `Venue: ${venueProfile.venueName} (${venueProfile.venueType}) in ${venueProfile.city}, ${venueProfile.location}` :
        `Australian hospitality venue`;
    
    let prompt = '';
    
    if (type === 'formalWarning') {
    prompt = `You are generating a FORMAL WARNING LETTER for Australian hospitality HR.

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

ISSUE DETAILS:
${data.issueDescription}
Date: ${data.issueDate}
${data.witnesses ? `Witnesses: ${data.witnesses}` : 'No witnesses mentioned'}

${data.rodExtractedText ? `
RECORD OF DISCUSSION CONTEXT:
The following information has been extracted from the completed Record of Discussion conversation:

${data.rodExtractedText}

**IMPORTANT:** Use the employee's actual responses and comments from the Record of Discussion above to make this warning letter more accurate and contextual. Include verbatim quotes where appropriate, and reference specific points the employee made during the discussion. This provides crucial context and demonstrates procedural fairness.
` : ''}

PREVIOUS ACTION TAKEN:
${data.hadVerbalWarnings === 'Yes' ? 
  `${data.verbalWarningCount || 'Multiple'} verbal warning(s) have been given` : 
  'No prior formal warnings'}
This is a ${data.warningLevel.toLowerCase()}.

REQUIRED IMPROVEMENTS:
${data.expectations}
Timeframe: ${data.timeframe}

CONSEQUENCES:
${data.consequences}

Generate a complete, professional formal warning letter following Australian employment law best practices.

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## EMPLOYEE DETAILS)
2. Use blank lines between ALL paragraphs and sections
3. Use **text** for emphasis
4. For lists, use bullet points with "‚Ä¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. ALWAYS add a space after colons in labels (e.g., "Date: " not "Date:")
8. ALWAYS add spaces around bold text (e.g., "within **seven (7) days** of receiving" not "within**seven (7) days**of receiving")

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

REQUIREMENTS:
1. **Expand the issue description** - Take the brief description and expand with appropriate context while staying factual
2. **Use formal, professional language** - Clear, firm but respectful
3. **Include all legal requirements**:
   - Dated header with full employee details
   - Clear subject line
   - Detailed description of the issue (expanded from brief description)
   - Reference to previous warnings
   - Specific, measurable improvement expectations (use bullet points)
   - Clear timeframe
   - Stated consequences (use bullet points)
   - Warning retention period (12 months)
   - Signature sections

4. **Maintain procedural fairness**
5. **Be specific and actionable**
6. **Professional tone** - firm but not threatening

Example structure:

# FORMAL WARNING LETTER

## DATE AND RECIPIENT

Date: [Date]

Employee Name: [Name]

Position: [Position]

## SUBJECT

Subject: Formal Written Warning - [Issue]

## ISSUE DESCRIPTION

[Detailed description of what occurred, with specific dates and facts]

## PREVIOUS DISCUSSIONS

[Reference to verbal warnings if applicable]

## REQUIRED IMPROVEMENTS

You are required to:

- [Specific expectation 1]
- [Specific expectation 2]
- [Specific expectation 3]

## TIMEFRAME

[Clear timeframe for improvement]

## CONSEQUENCES

Failure to meet these expectations may result in:

- [Consequence 1]
- [Consequence 2]
- Termination of employment

## WARNING RETENTION

This warning will remain on your employee file for 12 months from the date of this letter.

## SIGNATURES

Employee Signature: _________________________ Date: __________

Manager Signature: _________________________ Date: __________

Format as a complete business letter with proper structure and clear spacing between all sections.

DO NOT add fictional details. Expand and contextualize what was provided.`;
    
    } else if (type === 'recordOfDiscussion') {
    prompt = `You are generating a RECORD OF DISCUSSION TEMPLATE & CONVERSATION SCRIPT for Australian hospitality managers.

THIS IS A TEMPLATE/SCRIPT - NOT A COMPLETED DOCUMENT.
The manager will use this during the actual conversation with the employee.

‚ö†Ô∏è CRITICAL: This is a PROCEDURAL FAIRNESS meeting. NO outcome or decision is made during this meeting. The purpose is to:
1. Present allegations to the employee
2. Give the employee the opportunity to respond
3. Gather information and the employee's perspective
4. Adjourn to consider all information before making any decision

A follow-up meeting will be scheduled 24-48 hours later to deliver the outcome after proper consideration.

VENUE CONTEXT:
${venueContext}
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}

MEETING PREPARATION CHECKLIST:
- 24 hours notice given: ${data.notice24hours}
- Support person offered: ${data.supportPersonOffered}

ALLEGATIONS:
${data.allegations}

WITNESSES (if any):
${data.witnesses || 'None mentioned'}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## BEFORE THE MEETING)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use **bold** formatting - use plain text only
4. For lists, use bullet points with "‚Ä¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. **ALWAYS add a space after colons in labels** (e.g., "Employee Name: Blake" not "Employee Name:Blake")
8. For manager scripts, prefix with "MANAGER SAYS: " instead of using bold

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

**IMPORTANT: Always include a space after colons:**
‚úì CORRECT: "Date: 20 January 2026"
‚úó WRONG: "Date:20 January 2026"

Generate a conversation template that:

1. **Provides a complete script** for the manager to follow during the meeting
2. **Uses "MANAGER SAYS:" prefix** for what the manager should actually SAY
3. **Uses italics** for instructions/guidance (e.g., *Listen carefully and take notes*)
4. **Leaves space** for the manager to write the employee's responses
5. **Guides the manager** through difficult conversations with prompts like:
   - *Ask clarifying questions*
   - *Allow the employee time to respond*
   - *Remain calm and professional*
6. **CLEARLY STATES** that no decision will be made today - this is just to hear their side

STRUCTURE:

## BEFORE THE MEETING

*Print this document and have it in front of you during the meeting*
*Review the allegations and gather any evidence*
*Prepare to listen - this is a two-way conversation*
*Remember: You are NOT making a decision today - only gathering information*

## MEETING SCRIPT

### OPENING THE MEETING

MANAGER SAYS: "Thank you for meeting with me today, ${data.employeeName}. As mentioned in my notice, we need to discuss some concerns about [brief description]."

MANAGER SAYS: "You have the right to have a support person present. Have you brought someone with you, or would you like to reschedule to arrange one?"

*Wait for response - write it here:*
__________________________________________________________________________________

### EXPLAINING THE PURPOSE

MANAGER SAYS: "Before we start, I want to be clear about the purpose of this meeting:

- I'm going to explain some allegations/concerns
- You'll have the opportunity to respond and give your side of the story
- I'm here to listen and gather information
- No decision will be made today - I need time to properly consider everything you tell me
- We'll schedule a follow-up meeting in the next 24-48 hours where I'll share my decision

Does that make sense?"

*Wait for acknowledgment:*
___________________________________

### PRESENTING THE ALLEGATIONS

MANAGER SAYS: "The reason for this meeting is that I've received information about the following:"

${data.allegations.split('\n').map(a => `‚Ä¢ ${a.trim()}`).join('\n')}

*Pause after presenting each allegation - let them absorb the information*

MANAGER SAYS: "These matters are serious because [explain the impact - e.g., they affect workplace safety, team morale, customer service, or breach company policy]."

### GIVING THE EMPLOYEE THE OPPORTUNITY TO RESPOND

MANAGER SAYS: "Now I'd like to hear your side of the story. This is your opportunity to respond to these allegations. Can you tell me what happened from your perspective?"

*This is CRITICAL - LISTEN carefully without interrupting. Take detailed notes of everything they say:*

Employee's response to allegations:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

*After they finish, ask clarifying questions:*

MANAGER SAYS: "Thank you for explaining. Can I ask a few questions to make sure I understand correctly?"

Clarifying questions to ask:

- "When you say [repeat something they said], can you explain what you mean?"
- "Were there any other circumstances I should know about?"
- "Is there anyone who can support what you're telling me?"
- "Is there anything else you'd like to add?"

Additional information from employee:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

### EVIDENCE OR WITNESSES

*If the employee mentions evidence or witnesses:*

MANAGER SAYS: "You mentioned [evidence/witness]. Can you provide me with [details/their name] so I can consider this as part of my review?"

Evidence/witnesses mentioned:
__________________________________________________________________________________
__________________________________________________________________________________

### EXPLAINING NEXT STEPS

MANAGER SAYS: "Thank you for being open with me and sharing your perspective. I want to be clear about what happens next:

- I'm going to take time to properly consider everything you've told me today
- I'll review all the information, evidence, and your response
- I'll schedule a follow-up meeting with you within the next 24-48 hours
- At that meeting, I'll let you know my decision and what happens next
- You won't hear anything before that meeting - I need time to think this through properly"

*Set a specific date/time now for the follow-up meeting:*

MANAGER SAYS: "Can we schedule our follow-up meeting for [DATE] at [TIME]?"

Follow-up meeting scheduled:

Date: ___________________

Time: ___________________

### CLOSING THE MEETING

MANAGER SAYS: "Do you have any questions about the process or what happens next?"

*Note any questions/concerns:*
__________________________________________________________________________________

MANAGER SAYS: "Thank you for attending this meeting and sharing your side of the story. I'll see you at our follow-up meeting on [DATE]."

*If they have a support person:*

MANAGER SAYS: "Thank you also for attending [support person name]."

## AFTER THE MEETING

*Complete the following sections IMMEDIATELY after the meeting while details are fresh:*

### SUMMARY OF ALLEGATIONS PRESENTED

*Write a brief, factual summary of what allegations you presented:*
__________________________________________________________________________________
__________________________________________________________________________________

### EMPLOYEE'S RESPONSE SUMMARY

*Summarize the key points of what the employee said in response:*
________________________________________________________________________________
________________________________________________________________________________
________________________________________________________________________________

### EMPLOYEE'S EXPLANATION/MITIGATING CIRCUMSTANCES

*Note any explanations, mitigating factors, or context the employee provided:*
__________________________________________________________________________________
__________________________________________________________________________________

### EVIDENCE/WITNESSES TO FOLLOW UP

*List any evidence you need to review or witnesses you need to speak to:*

- __________________________________________________________________________________
- __________________________________________________________________________________
- __________________________________________________________________________________

### MANAGER'S NOTES FOR CONSIDERATION

*Before making your decision, consider:*

- How credible is the employee's explanation?
- Does their response change the seriousness of the allegations?
- What evidence supports or contradicts their version?
- Are there any mitigating circumstances?
- What is the appropriate outcome (if allegations are substantiated)?

*DO NOT write your decision here - this is just for your own consideration process*

### MEETING ATTENDEES

Employee: ${data.employeeName}

Manager: ${venueProfile.userName || '[Manager Name]'}

Support Person (if present): _________________________________

Date: ___________________

Time: ___________________

### NEXT STEPS BEFORE FOLLOW-UP MEETING

*What you need to do before the follow-up meeting:*

‚òê Review all evidence and witness statements
‚òê Consider the employee's response fairly
‚òê Determine if allegations are substantiated
‚òê Decide on appropriate outcome (if substantiated)
‚òê Prepare outcome letter (if formal warning required)
‚òê Schedule follow-up meeting (DONE: [DATE/TIME])

---

**IMPORTANT REMINDERS FOR MANAGER:**

‚úì DO NOT make or hint at any decision during this meeting
‚úì Your role today is to LISTEN and GATHER INFORMATION only
‚úì Take detailed notes - they may be important later
‚úì Remain calm, professional, and neutral
‚úì Give the employee adequate time to respond
‚úì Ask open-ended questions to get their full story
‚úì Schedule the follow-up meeting before they leave

**PROCEDURAL FAIRNESS CHECKLIST:**

‚òê Employee given 24 hours notice ‚úì
‚òê Employee offered support person ‚úì
‚òê Allegations clearly explained ‚úì
‚òê Employee given genuine opportunity to respond ‚úì
‚òê Employee's response documented ‚úì
‚òê Follow-up meeting scheduled ‚úì
‚òê No decision made during this meeting ‚úì

**‚ö†Ô∏è CRITICAL LEGAL REQUIREMENT:**

This meeting is ONLY for gathering information. You MUST take time (24-48 hours) to properly consider the employee's response before making any decision. Failing to do this could result in a finding of unfair dismissal if the matter proceeds to termination.

*If you're unsure how to proceed at any point, pause the meeting and contact Fitzgerald HR: info@fitzgeraldhr.com.au*
`;
    
    } else if (type === 'letterOfAllegation') {
    prompt = `You are generating a LETTER OF ALLEGATION for serious workplace misconduct investigation.

‚ö†Ô∏è THIS IS HIGH-RISK - MUST BE LEGALLY SOUND

VENUE CONTEXT:
${venueContext}
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

ALLEGATION:
Type: ${data.allegationType}
${data.allegationDescription}
Date of incident: ${data.incidentDate}

SOURCE:
${data.allegationSource}
${data.evidenceExists ? `Evidence: ${data.evidenceExists}` : ''}

INVESTIGATION:
Investigator: ${data.investigator}
Suspension: ${data.suspensionRequired}

MEETING SCHEDULED:
Date: ${data.meetingDate}
Time: ${data.meetingTime}
Location: ${data.meetingLocation}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## ALLEGATION DETAILS)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use bold formatting - use plain text only
4. For lists, use bullet points with "‚Ä¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. **ALWAYS add a space after colons in labels** (e.g., "Date: 20 January 2026" not "Date:20 January 2026")

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

**IMPORTANT: Always include a space after colons:**
‚úì CORRECT: "Date: 20 January 2026"
‚úó WRONG: "Date:20 January 2026"

Generate a legally compliant Letter of Allegation.

CRITICAL REQUIREMENTS:

1. **Neutral tone** - No presumption of guilt
2. **Clear process** - Explain investigation steps
3. **Employee rights**:
   - Right to support person
   - Opportunity to respond
   - Procedural fairness
4. **Confidentiality requirements**
5. **Meeting details**
6. **Suspension details** (if applicable)
7. **Next steps clearly outlined**

Example structure:

# PRIVATE & CONFIDENTIAL

# LETTER OF ALLEGATION

## DATE AND RECIPIENT

Date: [Date]

Employee Name: [Name]

Position: [Position]

Employment Type: [Type]

## SUBJECT

Subject: Allegation of [Type] - Investigation Process

## NATURE OF ALLEGATION

[Factual description - not conclusive]

We have received information regarding an alleged incident of ${data.allegationType} that occurred on or around ${data.incidentDate}.

The allegation is as follows:

${data.allegationDescription}

Please note that this letter does not constitute a finding of guilt or wrongdoing. It is simply to inform you of the allegation and the investigation process that will follow.

## INVESTIGATION PROCESS

We will be conducting a thorough and fair investigation into this matter. The investigation will include:

- Meeting with you to hear your response to the allegation
- Reviewing any relevant evidence
- Speaking with any witnesses (if applicable)
- Considering all information before making any decision

The investigation will be conducted by: ${data.investigator}

## SUSPENSION ARRANGEMENTS

${data.suspensionRequired.includes('No suspension') ? 
  'You are not suspended during this investigation and should continue to attend work as normal.' :
  data.suspensionRequired.includes('full pay') ?
  'You are suspended on full pay during this investigation. You should not attend the workplace unless specifically requested. You will continue to receive your normal pay during this period.' :
  'You are suspended without pay during this investigation due to the serious nature of the alleged misconduct. You should not attend the workplace unless specifically requested.'}

## INVESTIGATION MEETING

You are required to attend an investigation meeting to respond to this allegation:

Date: ${data.meetingDate}

Time: ${data.meetingTime}

Location: ${data.meetingLocation}

## YOUR RIGHTS

You have the following rights during this investigation:

- Right to bring a support person to the meeting (this can be a work colleague, family member, or union representative)
- Opportunity to respond to the allegations in full
- Right to provide evidence or witness names that support your version of events
- Procedural fairness will be maintained throughout the investigation
- You may seek legal advice if you wish

## CONFIDENTIALITY

This matter is confidential. You must not discuss the allegation or investigation with other employees (except your nominated support person or union representative). Breaching confidentiality may be considered a separate matter of misconduct.

## NEXT STEPS

After the investigation meeting:

- Your response will be considered along with all other evidence
- A decision will be made regarding the allegation
- You will be informed of the outcome in writing
- If the allegation is substantiated, disciplinary action may be taken, which could include termination of employment

## CONTACT INFORMATION

If you have any questions about this process or need to discuss the meeting arrangements, please contact:

${venueProfile.userName || '[Manager Name]'}

Email: [email]

Phone: [phone]

We encourage you to seek advice from a union representative or legal advisor if you wish.

---

This is a serious matter and we are committed to conducting a fair and thorough investigation.

Please confirm receipt of this letter and your attendance at the scheduled meeting.

Yours sincerely,

${venueProfile.userName || '[Manager Name]'}

[Title]

${venueProfile.venueName || '[Venue Name]'}

Date: [Date]

---

IMPORTANT LEGAL NOTICE:

This letter must be reviewed by a Fitzgerald HR Senior Consultant before being issued to the employee.

Contact: info@fitzgeraldhr.com.au

Include:
- PRIVATE & CONFIDENTIAL header
- Date and recipient details
- Clear subject line
- Nature of allegation (factual, not conclusive)
- Investigation process explanation
- Suspension details if applicable
- Meeting details (date, time, location)
- Support person rights
- Confidentiality requirements
- Next steps after investigation
- Signature section

TONE: Professional, neutral, procedurally fair. This is NOT a punishment - it's the start of a fair process.`;
	
    } else if (type === 'performanceImprovementPlan') {
        prompt = `You are generating a PERFORMANCE IMPROVEMENT PLAN (PIP) for Australian hospitality HR.

‚ö†Ô∏è THIS IS A FORMAL 12-WEEK STRUCTURED PROCESS

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009
Manager: ${data.managerName || venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

PERFORMANCE ISSUES IDENTIFIED:
Issue #1: ${data.performanceIssue1}
Evidence: ${data.performanceData1}

${data.performanceIssue2 ? `Issue #2: ${data.performanceIssue2}\nEvidence: ${data.performanceData2}` : ''}

SMART GOALS SET:
Goal #1: ${data.goal1}
${data.goal2 ? `Goal #2: ${data.goal2}` : ''}
${data.goal3 ? `Goal #3: ${data.goal3}` : ''}

ACTION PLAN:
Training/Coaching: ${data.trainingProvided}
Resources: ${data.resourcesProvided}
Manager Support: ${data.managerSupport}

EMPLOYEE RESPONSIBILITIES:
${data.employeeActions}

TIMELINE:
- PIP Start: ${data.pipStartDate}
- Weekly Check-ins: ${data.weeklyCheckins}
- Week 4 Review: ${data.week4ReviewDate}
- Week 8 Review: ${data.week8ReviewDate}
- Week 12 Final Review: ${data.week12ReviewDate}

CONSEQUENCES:
- Week 4: ${data.week4Consequence}
- Week 8: ${data.week8Consequence}
- Week 12: ${data.week12Consequence}
${data.consequenceNotes ? `Notes: ${data.consequenceNotes}` : ''}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## PERFORMANCE ISSUES)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use **bold** formatting - use plain text only
4. For lists, use bullet points with "‚Ä¢ " prefix
5. Structure clearly with proper spacing
6. **ALWAYS add a space after colons in labels** (e.g., "Date: 20 January 2026" not "Date:20 January 2026")

Generate a complete, professionally structured 12-Week Performance Improvement Plan.

REQUIREMENTS:

1. **Professional business document format**
2. **Clear structure** with these sections:
   - Header (CONFIDENTIAL - PERFORMANCE IMPROVEMENT PLAN)
   - Employee and Manager Details
   - Purpose of PIP
   - Performance Issues Identified (with data/evidence)
   - SMART Goals (numbered, clear, measurable)
   - Action Plan (detailed steps, training, resources)
   - Roles and Responsibilities (Manager & Employee tables)
   - Timeline and Review Schedule (12-week calendar)
   - Progress Measurement (how success will be tracked)
   - Consequences (staged - Week 4, 8, 12)
   - Support Available
   - Employee Acknowledgment Section
   - Signature Blocks

3. **Use a supportive but clear tone** - this is to help the employee succeed, not punish them
4. **Make goals SMART** - expand on the brief goals provided with more specific detail
5. **Weekly check-in template** - provide a simple weekly check-in form at the end
6. **Be specific about consequences** but frame as progressive steps
7. **Include measurement criteria** for each goal

Example structure:

# CONFIDENTIAL

# PERFORMANCE IMPROVEMENT PLAN

## EMPLOYEE DETAILS

Employee Name: ${data.employeeName}

Position: ${data.position}

Employment Type: ${data.employmentType}

Manager/Supervisor: ${data.managerName}

PIP Start Date: ${data.pipStartDate}

PIP Duration: 12 weeks

## PURPOSE OF THIS PERFORMANCE IMPROVEMENT PLAN

This Performance Improvement Plan (PIP) has been developed to support ${data.employeeName} in addressing performance concerns and achieving the expected standards for the ${data.position} role.

The purpose of this plan is to:

- Clearly identify the specific performance issues that need improvement
- Set measurable goals with realistic timeframes
- Provide structured support, training, and resources
- Establish regular check-ins and feedback mechanisms
- Outline the consequences if performance does not improve

This is a supportive process designed to help you succeed. We are committed to providing you with the tools, training, and support needed to meet these goals.

## PERFORMANCE ISSUES IDENTIFIED

The following performance issues have been identified based on objective data and observations:

### Issue 1: [Expand on ${data.performanceIssue1}]

Evidence:

- ${data.performanceData1}

Impact: [Explain how this impacts the business, team, or customers]

### Issue 2: [If applicable - expand on ${data.performanceIssue2}]

Evidence:

- ${data.performanceData2}

Impact: [Explain impact]

## SMART GOALS

To address these performance issues, the following SMART goals have been established:

### Goal 1: [Expand ${data.goal1}]

- Specific: [What exactly needs to improve]
- Measurable: [How will we measure success - specific numbers/metrics]
- Achievable: [Why this is realistic given training and support]
- Relevant: [How this relates to role expectations]
- Time-bound: [Specific deadline - Week 4, 8, or 12]

Success Criteria: [Define what "success" looks like - be very specific]

### Goal 2: [If applicable]

[Same structure as Goal 1]

### Goal 3: [If applicable]

[Same structure as Goal 1]

## ACTION PLAN

To help you achieve these goals, we will provide the following support:

### Training and Development

${data.trainingProvided}

### Resources and Tools

${data.resourcesProvided}

### Manager/Supervisor Support

${data.managerSupport}

## ROLES AND RESPONSIBILITIES

### Employee Responsibilities

You are expected to:

${data.employeeActions}

### Manager/Supervisor Responsibilities

Your manager/supervisor will:

- Conduct weekly check-in meetings on ${data.weeklyCheckins}
- Provide regular feedback and coaching
- Track progress toward goals
- Remove barriers to success where possible
- Conduct formal reviews at Week 4, Week 8, and Week 12
- Maintain confidentiality of this process

## TIMELINE AND REVIEW SCHEDULE

This is a 12-week structured process with regular check-ins and formal reviews:

### Weekly Check-ins

When: ${data.weeklyCheckins}

Purpose: Quick progress check, address questions, provide feedback

Duration: 15-30 minutes

### Formal Review Points

Week 4 Review: ${data.week4ReviewDate}

Purpose: Assess progress on goals, adjust plan if needed, determine next steps

Week 8 Review: ${data.week8ReviewDate}

Purpose: Mid-point assessment, confirm trajectory, address any challenges

Week 12 Final Review: ${data.week12ReviewDate}

Purpose: Final assessment of overall performance improvement

## PROGRESS MEASUREMENT

Progress will be measured using the following methods:

- [Specific metrics for Goal 1 - e.g., till data, customer feedback scores]
- [Specific metrics for Goal 2 - e.g., accuracy reports, manager observations]
- [Specific metrics for Goal 3 - e.g., review ratings, speed measurements]
- Direct observation and feedback from managers and team members
- Customer feedback and reviews
- Self-assessment and reflection

Data will be collected weekly and reviewed at each check-in.

## CONSEQUENCES OF NON-IMPROVEMENT

This PIP is designed to support your success. However, if performance does not improve significantly, the following consequences will apply:

### Week 4 Review

If there is no significant improvement by Week 4:

${data.week4Consequence}

### Week 8 Review

If there is no significant improvement by Week 8:

${data.week8Consequence}

### Week 12 Final Review

If performance standards have not been met by Week 12:

${data.week12Consequence}

${data.consequenceNotes ? `Additional notes: ${data.consequenceNotes}` : ''}

"Significant improvement" means demonstrable progress toward the stated goals as measured by the agreed metrics and criteria.

## SUPPORT AVAILABLE

We want you to succeed. If you are struggling or need additional support at any time:

- Speak with your manager/supervisor immediately
- Request additional training or resources if needed
- Ask questions if goals or expectations are unclear
- Seek support from HR if you have concerns about the process

You have the right to have a support person present at any formal review meeting. This can be a work colleague, family member, or union representative.

## CONFIDENTIALITY

This Performance Improvement Plan is confidential. You should not discuss the details of this plan with other employees (except your nominated support person or union representative).

## EMPLOYEE ACKNOWLEDGMENT

I acknowledge that:

- I have received and read this Performance Improvement Plan
- The performance issues and expectations have been clearly explained to me
- I understand the goals I am expected to achieve
- I understand the support and resources that will be provided
- I understand the timeline and review process
- I understand the consequences if my performance does not improve
- I have been offered the right to have a support person present at review meetings
- I have had the opportunity to ask questions about this plan

This acknowledgment does not mean I agree with all aspects of this plan, but confirms I understand it.

Employee Signature: _________________________ Date: __________

Manager/Supervisor Signature: _________________________ Date: __________

---

## WEEKLY CHECK-IN TEMPLATE

Week Number: _____     Date: __________

Goals Review:

Goal 1 Progress:

- Current status: [On track / Behind / Ahead]
- Evidence of progress:
- Challenges faced:
- Support needed:

Goal 2 Progress:

- Current status: [On track / Behind / Ahead]
- Evidence of progress:
- Challenges faced:
- Support needed:

Action Items for Next Week:

1. ___________________________________
2. ___________________________________
3. ___________________________________

Employee Comments:

__________________________________________

Manager Comments:

__________________________________________

Employee Signature: _______________ Date: ______

Manager Signature: _______________ Date: ______

---

**IMPORTANT REMINDER:**

This PIP must be reviewed by a Fitzgerald HR Senior Consultant before presenting to the employee to ensure it is legally compliant and procedurally fair.

Contact: info@fitzgeraldhr.com.au

Format as a complete, professional business document with clear structure and spacing.

This is a SUPPORTIVE document - the tone should be firm but encouraging. The goal is to help the employee succeed, not to create a paper trail for termination (although it may be used that way if improvement doesn't occur).

DO NOT add fictional details. Use the specific information provided. Expand and add professional context where appropriate.`;
    
    }
    
    return prompt;
}

function showDocumentPreview(generatedDoc) {
    console.log('üìÑ Showing document preview...');
    console.log('Raw content sample:', generatedDoc.substring(0, 200));
    
    // Convert the AI-generated content to proper HTML
    const formattedHTML = convertAIContentToHTML(generatedDoc);
    
    console.log('Formatted HTML sample:', formattedHTML.substring(0, 200));
    
    document.getElementById('documentPreviewContent').innerHTML = formattedHTML;
    document.getElementById('documentPreviewModal').classList.remove('hidden');
}

function closeDocumentPreview() {
    document.getElementById('documentPreviewModal').classList.add('hidden');
    // Reset the document builder silently so it's ready for next use
    resetDocumentBuilderSilent();
}

// Silent reset (used when closing modal)
function resetDocumentBuilderSilent() {
    console.log('üîÑ Resetting Document Builder (silent)...');
    
    // Reset state
    documentBuilderState.currentType = null;
    documentBuilderState.currentStep = 1;
    documentBuilderState.data = {};
    documentBuilderState.generatedDocument = null;
    documentBuilderState.isGenerating = false;
    
    // Hide all wizard sections
    const wizardSteps = document.getElementById('documentWizardSteps');
    const generating = document.getElementById('documentGenerating');
    const templateSelection = document.getElementById('documentTemplateSelection');
    
    if (wizardSteps) wizardSteps.classList.add('hidden');
    if (generating) generating.classList.add('hidden');
    if (templateSelection) templateSelection.classList.remove('hidden');
    
    // Reset progress
    const currentStep = document.getElementById('docCurrentStep');
    const progress = document.getElementById('docProgress');
    const progressBar = document.getElementById('docProgressBar');
    
    if (currentStep) currentStep.textContent = '1';
    if (progress) progress.textContent = '0% Complete';
    if (progressBar) progressBar.style.width = '0%';
    
    console.log('‚úÖ Document Builder reset (silent)');
}

// Reset with confirmation (used when user clicks "Start Over" button)
function resetDocumentBuilder() {
    // Confirm reset
    if (!confirm('Start over? This will clear all your entered information.')) {
        return;
    }
    
    // Call the silent reset
    resetDocumentBuilderSilent();
}


async function downloadGeneratedDocument(format = 'pdf') {
    // ‚úÖ CRITICAL: Confirmation dialog before download
    const userAccepts = confirm(
        "‚ö†Ô∏è CRITICAL LEGAL REMINDER\n\n" +
        "This document is a DRAFT TEMPLATE for review purposes only.\n\n" +
        "Before issuing this document to any employee, you MUST:\n\n" +
        "‚úì Have it reviewed by a Fitzgerald HR consultant\n" +
        "‚úì Ensure all factual details are accurate\n" +
        "‚úì Verify it meets your specific circumstances\n" +
        "‚úì Confirm it complies with current Fair Work requirements\n\n" +
        "LEGAL WARNING:\n" +
        "Using this document without professional review may expose you to:\n" +
        "‚Ä¢ Unfair dismissal claims ($50,000+ in damages)\n" +
        "‚Ä¢ General protections claims\n" +
        "‚Ä¢ Adverse action penalties\n" +
        "‚Ä¢ Legal costs and compensation\n\n" +
        "Contact: info@fitzgeraldhr.com.au | +61 400 211 014\n\n" +
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n" +
        "By clicking OK, you acknowledge:\n" +
        "‚Ä¢ This is a draft template requiring professional review\n" +
        "‚Ä¢ You will NOT use it without consultant approval\n" +
        "‚Ä¢ You understand the legal risks of non-compliance\n\n" +
        "Click OK to download for review, or Cancel to return."
    );
    
    if (!userAccepts) {
        console.log('‚ùå User cancelled download - did not accept terms');
        trackEvent('document_download_cancelled_at_confirmation', {
            user: currentUser,
            documentType: documentBuilderState.currentType,
            format: format,
            reason: 'did_not_accept_legal_terms'
        });
        return false;
    }
    
    console.log(`‚úÖ User accepted legal terms and is downloading ${format.toUpperCase()}`);
    trackEvent('document_download_legal_terms_accepted', {
        user: currentUser,
        documentType: documentBuilderState.currentType,
        format: format
    });    

    try {
        const type = documentBuilderState.currentType;
        const employeeName = documentBuilderState.data.employeeName || 'Employee';
        
        const typeNames = {
            formalWarning: 'Formal_Warning',
            recordOfDiscussion: 'Record_of_Discussion',
            letterOfAllegation: 'Letter_of_Allegation',
            performanceImprovementPlan: 'Performance_Improvement_Plan'
        };
        
        const fileExtension = format === 'pdf' ? 'pdf' : 'docx';
        const filename = `${typeNames[type]}_${employeeName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.${fileExtension}`;
        
        const metadata = {
            documentId: generateDocumentId(),
            userName: currentUser,
            generatedAt: new Date().toISOString(),
            documentType: type,
            employeeName: employeeName,
            format: format
        };
        
        // Get the FORMATTED HTML from the preview
        const previewElement = document.getElementById('documentPreviewContent');
        
        if (!previewElement) {
            throw new Error('Preview content not found');
        }
        
        const formattedHTML = previewElement.innerHTML;
        
        console.log(`üìÑ Using formatted HTML from preview for ${format.toUpperCase()}`);
        
        let success = false;
        
        if (format === 'pdf') {
            // Generate PDF
            const docDefinition = convertHTMLToPdfMake(formattedHTML, metadata);
            
            if (typeof pdfMake === 'undefined') {
                throw new Error('pdfMake not loaded');
            }
            
            pdfMake.createPdf(docDefinition).download(filename);
            success = true;
            
        } else if (format === 'docx') {
            // Generate Word document
            success = await generateWordDocument(formattedHTML, filename, metadata);
        }
        
        if (!success) {
            throw new Error(`Failed to generate ${format.toUpperCase()}`);
        }
        
        // Track generation
        trackDocumentGeneration(filename, metadata);
        
        // ‚úÖ CRITICAL: Log the download and update database
        await logDocumentDownload(metadata);
        
        closeDocumentPreview();
        
        alert(
            `‚úÖ ${format.toUpperCase()} Document Downloaded!\n\n` +
            'CRITICAL REMINDERS:\n' +
            '1. This is a DRAFT document\n' +
            '2. MUST be reviewed by a consultant\n' +
            '3. Do not issue without professional review\n\n' +
            'Contact: info@fitzgeraldhr.com.au'
        );
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Download error:', error);
        alert(`Download failed: ${error.message}`);
        return false;
    }
}

/**
 * Generates a Word document (.docx) from HTML content
 * Robust version with corruption prevention
 * @param {string} htmlContent - HTML content to convert
 * @param {string} filename - Output filename
 * @param {Object} metadata - Document metadata
 * @returns {Promise<boolean>} True if successful
 */
async function generateWordDocument(htmlContent, filename, metadata = {}) {
    try {
        console.log('üìù Generating Word document via server...');
        console.log('üìù Filename:', filename);
        console.log('üìù Metadata:', metadata);
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'word-loading';
        loadingDiv.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[9999]';
        loadingDiv.innerHTML = `
            <div class="bg-slate-800 rounded-2xl border-2 border-amber-500 p-8 text-center max-w-md">
                <div class="text-6xl mb-4 animate-bounce">üìù</div>
                <p class="text-white font-bold text-xl mb-2">Generating Word Document</p>
                <p class="text-slate-400 text-sm mb-4">Creating professional .docx file...</p>
                <div class="flex justify-center gap-2">
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-500 text-xs mt-4">This usually takes 3-5 seconds</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        // Call Netlify function
        console.log('üìù Calling /.netlify/functions/generate-word...');
        
        const response = await fetch('/.netlify/functions/generate-word', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                html: htmlContent,
                metadata: {
                    documentId: metadata.documentId || generateDocumentId(),
                    userName: metadata.userName || currentUser,
                    filename: filename,
                    generatedAt: new Date().toISOString()
                }
            })
        });
        
        console.log('üìù Response status:', response.status);
        
        // Remove loading indicator
        loadingDiv.remove();
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Server error:', errorData);
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
        // Get the Word document as a blob
        const blob = await response.blob();
        console.log('‚úÖ Blob received, size:', blob.size);
        
        if (blob.size === 0) {
            throw new Error('Received empty document from server');
        }
        
        // Download it
        saveAs(blob, filename);
        
        console.log('‚úÖ Word document downloaded:', filename);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Word generation error:', error);
        console.error('‚ùå Stack:', error.stack);
        
        alert(
            '‚ö†Ô∏è Error Generating Word Document\n\n' +
            error.message + '\n\n' +
            'Please try again or download as PDF instead.\n' +
            'Contact support if this persists: info@fitzgeraldhr.com.au'
        );
        
        return false;
    }
}

/**
 * Cleans HTML content to prevent Word document corruption
 * Removes problematic elements and attributes
 */
function cleanHTMLForWord(html) {
    console.log('üßπ Cleaning HTML for Word conversion...');
    
    // Parse HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Remove all class attributes (Tailwind causes issues)
    doc.querySelectorAll('[class]').forEach(el => {
        el.removeAttribute('class');
    });
    
    // Remove all style attributes
    doc.querySelectorAll('[style]').forEach(el => {
        el.removeAttribute('style');
    });
    
    // Remove data attributes
    doc.querySelectorAll('[data-*]').forEach(el => {
        Array.from(el.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
                el.removeAttribute(attr.name);
            }
        });
    });
    
    // Remove script tags
    doc.querySelectorAll('script').forEach(el => el.remove());
    
    // Remove SVG elements
    doc.querySelectorAll('svg').forEach(el => el.remove());
    
    // Remove problematic divs - replace with semantic tags
    doc.querySelectorAll('div').forEach(div => {
        const p = doc.createElement('p');
        p.innerHTML = div.innerHTML;
        div.replaceWith(p);
    });
    
    // Remove span tags but keep content
    doc.querySelectorAll('span').forEach(span => {
        const text = doc.createTextNode(span.textContent);
        span.replaceWith(text);
    });
    
    // Remove empty paragraphs
    doc.querySelectorAll('p').forEach(p => {
        if (!p.textContent.trim()) {
            p.remove();
        }
    });
    
    // Get cleaned body content
    const cleaned = doc.body.innerHTML;
    
    console.log('‚úÖ HTML cleaned. Original length:', html.length, '‚Üí Cleaned length:', cleaned.length);
    
    return cleaned;
}

async function logDocumentGeneration() {
    console.log('üìä logDocumentGeneration() called');
    console.log('üìä currentType:', documentBuilderState.currentType);
    console.log('üìä employeeName:', documentBuilderState.data.employeeName);
    console.log('üìä Full data object:', JSON.stringify(documentBuilderState.data, null, 2));
    
    // Validate that we have the required data
    if (!documentBuilderState.currentType) {
        console.error('‚ùå Cannot log - no document type');
        return null;
    }
    
    const log = {
        document_id: generateDocumentId(),
        user_code: currentUser,
        document_type: documentBuilderState.currentType,
        employee_name: documentBuilderState.data.employeeName || 'Unknown',
        generated_at: new Date().toISOString(),
        downloaded: false,
        format: null, // ‚úÖ Will be set on download
        venue_name: venueProfile.venueName || null,
        venue_location: venueProfile.location || null,
        venue_city: venueProfile.city || null,
        venue_type: venueProfile.venueType || null
    };
    
    console.log('üìä Log object to insert:', JSON.stringify(log, null, 2));
    
    // Store in localStorage as backup
    const logs = JSON.parse(localStorage.getItem('documentLogs_' + currentUser) || '[]');
    logs.push(log);
    localStorage.setItem('documentLogs_' + currentUser, JSON.stringify(logs));
    console.log('‚úÖ Saved to localStorage');
    
    // Store in Supabase
    if (supabaseClient) {
        try {
            console.log('üìä Attempting Supabase insert...');
            
            const { data, error } = await supabaseClient
                .from('generated_documents')
                .insert([log])
                .select(); // ‚úÖ This returns the inserted record including its ID
            
            if (error) {
                console.error('‚ùå Supabase insert error:', error);
                console.error('‚ùå Error details:', JSON.stringify(error, null, 2));
                return null;
            } else {
                console.log('‚úÖ Document logged to Supabase successfully');
                console.log('‚úÖ Inserted data:', JSON.stringify(data, null, 2));
                // ‚úÖ Return the inserted record (includes database ID)
                return data[0];
            }
        } catch (err) {
            console.error('‚ùå Exception logging to Supabase:', err);
            console.error('‚ùå Exception stack:', err.stack);
            return null;
        }
    } else {
        console.warn('‚ö†Ô∏è Supabase not connected - only saved locally');
        return null;
    }
}

// Log document download
/**
 * Logs document download with format tracking
 * @param {Object} metadata - Document metadata including format
 */
async function logDocumentDownload(metadata) {
    console.log('üì• Logging document download');
    console.log('üì• Stored doc ID:', documentBuilderState.lastGeneratedDocId);
    console.log('üì• Format:', metadata.format);
    
    if (!supabaseClient) {
        console.warn('‚ö†Ô∏è Supabase not connected - cannot update download status');
        return;
    }
    
    if (!documentBuilderState.lastGeneratedDocId) {
        console.error('‚ùå No document ID stored - cannot update download status');
        return;
    }
    
    try {
        console.log('üì• Updating document ID:', documentBuilderState.lastGeneratedDocId);
        
        // ‚úÖ Update with format information
        const { data: updateData, error: updateError } = await supabaseClient
            .from('generated_documents')
            .update({ 
                downloaded: true, 
                downloaded_at: new Date().toISOString(),
                format: metadata.format || 'pdf' // ‚úÖ Track format (pdf or docx)
            })
            .eq('id', documentBuilderState.lastGeneratedDocId)
            .select();
        
        if (updateError) {
            console.error('‚ùå Error updating download status:', updateError);
        } else {
            console.log('‚úÖ Download status updated successfully');
            console.log('‚úÖ Updated record:', updateData);
            console.log(`‚úÖ Format logged: ${metadata.format || 'pdf'}`);
            
            // Clear the stored ID after successful update
            documentBuilderState.lastGeneratedDocId = null;
        }
        
    } catch (err) {
        console.error('‚ùå Exception in logDocumentDownload:', err);
        console.error('‚ùå Stack:', err.stack);
    }
    
    // Track event with format
    trackEvent('document_downloaded', {
        user: currentUser,
        format: metadata.format || 'pdf',
        documentType: metadata.documentType
    });
}

	// ========================================
	// DAILY TIPS SYSTEM
	// ========================================

const dailyTips = [
    { icon: "üí°", tip: "Did you know? You must give 30-min breaks for shifts over 5 hours" },
    { icon: "‚ö†Ô∏è", tip: "Award rates increase on 1 July each year - mark your calendar!" },
    { icon: "üìù", tip: "Always document performance conversations in writing" },
    { icon: "üïí", tip: "Casuals must be paid within 7 days of completing their shift" },
    { icon: "üìã", tip: "Keep employment records for 7 years minimum - it's the law" },
    { icon: "‚öñÔ∏è", tip: "Unfair dismissal claims must be lodged within 21 days" },
    { icon: "üí∞", tip: "Casual loading is 25% on top of permanent rates" },
    { icon: "üîÑ", tip: "Regular casuals may request conversion to permanent after 12 months" },
    { icon: "üìÖ", tip: "Public holidays require 2.5x pay or time off in lieu" },
    { icon: "‚úçÔ∏è", tip: "Use written employment contracts for all staff - avoid disputes" },
    { icon: "üö®", tip: "Document workplace incidents immediately while details are fresh" },
    { icon: "üìû", tip: "Return employee calls within 24 hours during disputes" },
    { icon: "‚è∞", tip: "Minimum shift length is usually 3 hours for casual employees" },
    { icon: "üéì", tip: "Provide a Fair Work Information Statement to all new employees" },
    { icon: "üíº", tip: "Probation periods are typically 3-6 months - put it in writing" },
    { icon: "üîê", tip: "Store employee personal information securely - privacy laws apply" },
    { icon: "üìä", tip: "Review your payroll monthly - catch errors before they compound" },
    { icon: "ü§ù", tip: "Consider offering unpaid trial shifts (max 1-2 hours for assessment)" },
    { icon: "üåü", tip: "Recognize good performance regularly - it reduces turnover" },
    { icon: "üì±", tip: "Use the tools menu (üõ†Ô∏è) to access specialised calculators" }
];

let currentDailyTipIndex = -1; // Start at -1 so first call gets index 0

function getDailyTip() {
    // Get tip based on day of month for consistency
    const today = new Date().getDate();
    return dailyTips[today % dailyTips.length];
}

function updateDailyTipBanner() {
    const tipElement = document.getElementById('dailyTipContent');
    const iconElement = document.getElementById('dailyTipIcon');
    
    if (!tipElement || !iconElement) return;
    
    const tipData = getDailyTip();
    
    // Fade out
    const banner = document.getElementById('dailyTipBanner');
    if (banner) {
        banner.style.transition = 'opacity 0.3s ease-out';
        banner.style.opacity = '0.7';
    }
    
    setTimeout(() => {
        iconElement.textContent = tipData.icon;
        tipElement.textContent = tipData.tip;
        
        // Fade in
        if (banner) {
            banner.style.opacity = '1';
        }
    }, 300);
}

function rotateTipManually() {
    // Cycle to next tip
    currentDailyTipIndex = (currentDailyTipIndex + 1) % dailyTips.length;
    
    const tipElement = document.getElementById('dailyTipContent');
    const iconElement = document.getElementById('dailyTipIcon');
    const banner = document.getElementById('dailyTipBanner');
    
    if (!tipElement || !iconElement || !banner) return;
    
    const tipData = dailyTips[currentDailyTipIndex];
    
    // Fade out
    banner.style.transition = 'opacity 0.3s ease-out';
    banner.style.opacity = '0.7';
    
    setTimeout(() => {
        iconElement.textContent = tipData.icon;
        tipElement.textContent = tipData.tip;
        
        // Fade in
        banner.style.opacity = '1';
    }, 300);
    
    trackEvent('daily_tip_rotated', { 
        user: currentUser, 
        tipIndex: currentDailyTipIndex 
    });
}

// Auto-rotate tips every 30 seconds
function startDailyTipRotation() {
    setInterval(() => {
        rotateTipManually();
    }, 30000); // 30 seconds
}
        
        // 2. Multi-page document generation
        function generateMultiPageDocument(sections, filename, metadata = {}) {
            let fullContent = '';
            
            sections.forEach((section, index) => {
                fullContent += section.content;
                
                // Add page break between sections (for PDF/Word)
                if (index < sections.length - 1) {
                    fullContent += '<div style="page-break-after: always;"></div>';
                }
            });
            
            generateWordDocument(fullContent, filename, metadata);
        }
        
        // Example usage for complex documents:
        // generateMultiPageDocument([
        //     { content: hrTemplates.employmentContract(data), title: 'Employment Contract' },
        //     { content: generatePolicySection(data), title: 'Workplace Policies' },
        //     { content: generateBenefitsSection(data), title: 'Benefits Summary' }
        // ], 'Complete_Employment_Package.doc');

// ========================================
// ACCESS CONTROL
// ========================================
/**
 * Validates user access code and grants entry to assistant
 * Shows error message if code is invalid
 * @returns {void}
 */
function checkAccess() {
    const input = document.getElementById('accessCodeInput').value.trim().toUpperCase();
    const error = document.getElementById('accessError');
    
    // Direct DOM access instead of cache
    const accessScreen = document.getElementById('accessScreen');
    const assistantScreen = document.getElementById('assistantScreen');
    const userCodeEl = document.getElementById('userCode');
    
    if (CONFIG.VALID_CODES.includes(input)) {
    // ‚úÖ STORE ACCESS CODE IN LOCALSTORAGE (only if "Remember Me" is checked)
    const rememberMe = document.getElementById('rememberMe')?.checked ?? true;
    
    if (rememberMe) {
        localStorage.setItem('fitzhr_access_code', input);
        localStorage.setItem('fitzhr_last_login', new Date().toISOString());
        console.log('‚úÖ Access code stored in localStorage');
    } else {
        console.log('‚ÑπÔ∏è Remember me not checked - code not stored');
    }
        
        // Continue with normal login process
        currentUser = input;
        if (userCodeEl) userCodeEl.textContent = input;
        if (accessScreen) accessScreen.classList.add('hidden');
        if (assistantScreen) assistantScreen.classList.remove('hidden');
        if (error) error.classList.add('hidden');
        
        // ‚úÖ SHOW LEGAL ACCEPTANCE MODAL ON FIRST USE
        setTimeout(() => showLegalAcceptanceModal(), 500);        

        trackEvent('beta_access', { code: input });
        
        // Show admin button for admin codes
        if (['FITZGERALD-TEST', 'DEMO-2025'].includes(input)) {
            const adminBtn = document.getElementById('adminButton');
            if (adminBtn) {
                adminBtn.classList.remove('hidden');
            }
        }
        
        // CHECK IF USER NEEDS ONBOARDING
        const hasCompletedOnboarding = checkOnboardingStatus();
        if (!hasCompletedOnboarding) {
            setTimeout(() => {
                showOnboarding();
            }, 1000);
        } else {
            const userName = venueProfile.userName || '';
            const venueName = venueProfile.venueName || 'your venue';
            const city = venueProfile.city || '';
            const state = venueProfile.location || '';
            const greeting = userName ? `üëã Welcome back ${userName}!` : 'üëã Welcome back!';
            const locationText = city ? `${city}, ${state}` : state;
            addMessage('assistant', `${greeting} I remember you run ${venueName} in ${locationText}. What can I help you with today?`);
        }

        // Initialize and start daily tip rotation
        setTimeout(() => {
            updateDailyTipBanner();
            startDailyTipRotation();
        }, 500);
        
        console.log('‚úÖ Access code stored in localStorage');
    } else {
        error.textContent = 'Invalid access code. Please check and try again.';
        error.classList.remove('hidden');
        
        // ‚ùå CLEAR ANY STORED CODE IF INVALID ATTEMPT
        localStorage.removeItem('fitzhr_access_code');
    }
}

/**
 * Attempts to auto-login user with stored access code
 * Called on page load to provide seamless experience
 * @returns {boolean} True if auto-login successful, false otherwise
 */
function attemptAutoLogin() {
    console.log('üîê Checking for stored access code...');
    
    const storedCode = localStorage.getItem('fitzhr_access_code');
    const lastLogin = localStorage.getItem('fitzhr_last_login');
    
    if (!storedCode) {
        console.log('‚ùå No stored access code found');
        return false;
    }
    
    // Optional: Check if code is still valid (hasn't expired)
    // For now, codes don't expire, but you could add expiry logic here
    if (lastLogin) {
        const lastLoginDate = new Date(lastLogin);
        const daysSinceLogin = (new Date() - lastLoginDate) / (1000 * 60 * 60 * 24);
        
        // Optional: Expire codes after 30 days of inactivity
        if (daysSinceLogin > 30) {
            console.log('‚ö†Ô∏è Access code expired (30 days inactive)');
            localStorage.removeItem('fitzhr_access_code');
            localStorage.removeItem('fitzhr_last_login');
            return false;
        }
    }
    
    // Verify code is still in valid codes list
    if (!CONFIG.VALID_CODES.includes(storedCode)) {
        console.log('‚ùå Stored code no longer valid:', storedCode);
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
        return false;
    }
    
    console.log('‚úÖ Valid stored code found:', storedCode);
    console.log('üìÖ Last login:', lastLogin);
    
    // Perform automatic login
    const accessScreen = document.getElementById('accessScreen');
    const assistantScreen = document.getElementById('assistantScreen');
    const userCodeEl = document.getElementById('userCode');
    
    currentUser = storedCode;
    if (userCodeEl) userCodeEl.textContent = storedCode;
    if (accessScreen) accessScreen.classList.add('hidden');
    if (assistantScreen) assistantScreen.classList.remove('hidden');
    
    // Update last login timestamp
    localStorage.setItem('fitzhr_last_login', new Date().toISOString());
    
    // Show admin button for admin codes
    if (['FITZGERALD-TEST', 'DEMO-2025'].includes(storedCode)) {
        const adminBtn = document.getElementById('adminButton');
        if (adminBtn) {
            adminBtn.classList.remove('hidden');
        }
    }
    
    // Initialize conversation system
    initConversationSystem();
    
    // CHECK IF USER NEEDS ONBOARDING
    const hasCompletedOnboarding = checkOnboardingStatus();
    if (!hasCompletedOnboarding) {
        setTimeout(() => {
            showOnboarding();
        }, 1000);
    }

    // Initialize and start daily tip rotation
    setTimeout(() => {
        updateDailyTipBanner();
        startDailyTipRotation();
    }, 500);
    
    // Track auto-login
    trackEvent('auto_login', { 
        code: storedCode,
        daysSinceLastLogin: lastLogin ? Math.floor((new Date() - new Date(lastLogin)) / (1000 * 60 * 60 * 24)) : null
    });
    
    console.log('‚úÖ Auto-login successful');
    return true;
}

// ========================================
// MESSAGING SYSTEM
// ========================================
/**
 * Sends user message to AI and displays response
 * Handles conversation history and UI updates
 * @returns {Promise<void>}
 */
async function sendMessage() {
    const input = DOM.messageInput;
    const message = input.value.trim();
    
    if (!message) return;
    
    // ‚úÖ DETECT DOCUMENT BUILDER NEED FIRST
    const docBuilderNeed = detectDocumentBuilderNeed(message);
    
    // Check for high-risk topics
    const risk = detectHighRiskTopic(message);
    
    addMessage('user', message);
    input.value = '';
    
    // Show "Fitz is thinking..." indicator
    const thinkingDiv = showThinkingIndicator();
    const sendBtn = DOM.sendButton;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="pulse">‚óè‚óè‚óè</span>';
    
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await callClaudeAPI(message);
        
        // Remove thinking indicator
        removeThinkingIndicator(thinkingDiv);
        
        // Build final response with injections
        let finalResponse = response;
        
        // ‚úÖ INJECT DOCUMENT BUILDER SUGGESTION FIRST (if detected)
        if (docBuilderNeed) {
            const docSuggestion = createDocumentBuilderSuggestion(docBuilderNeed);
            finalResponse = docSuggestion + finalResponse;
        }
        
        // Then add high-risk warning if needed
        if (risk) {
            const warningBox = createHighRiskWarningBox(risk);
            finalResponse = warningBox + finalResponse;
        }
        
        addMessage('assistant', finalResponse);
        trackConversation(message, response);
        conversationHistory.push({ role: 'assistant', content: response });
        
        // Auto-save conversation
        saveCurrentConversation();
        
        // WEEK 3: Update searchable history
        updateSearchableHistory();
        
        trackEvent('message_sent', { user: currentUser, messageLength: message.length });
    } catch (error) {
        // WEEK 2: Better error handling with user-friendly message
        removeThinkingIndicator(thinkingDiv);
        handleError(error, 'sendMessage');
        addMessage('assistant', '‚ö†Ô∏è I encountered an issue processing your message. Please try again. If the problem persists, try refreshing the page.');
        console.error('Error:', error);
    }
    
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<span>Send</span><span>‚Üí</span>';
}

function showThinkingIndicator() {
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = 'thinking-indicator';
    thinkingDiv.className = 'flex justify-start fade-in';
    thinkingDiv.innerHTML = `
        <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-400 text-sm">Fitz is thinking...</p>
            </div>
        </div>
    `;
    container.appendChild(thinkingDiv);
    thinkingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    return thinkingDiv;
}

function removeThinkingIndicator(thinkingDiv) {
    if (thinkingDiv && thinkingDiv.parentNode) {
        thinkingDiv.parentNode.removeChild(thinkingDiv);
    }
}

function addMessage(role, content) {
    let container = DOM.messagesContainer.querySelector('.space-y-6');
    
    // If container doesn't exist, create it
    if (!container) {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        container = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
    
    let formattedContent = content;
    if (role === 'assistant') {
        // Check if content already contains high-risk HTML warning
        const hasHighRiskHTML = content.includes('IMPORTANT: This matter involves legal risk');
        
        if (!hasHighRiskHTML) {
            // Look for backend legal warnings and format them
            const legalWarnings = [
                '‚ö†Ô∏è **This matter involves legal risk.**',
                '‚ö†Ô∏è This matter involves legal risk.'
            ];
            
            for (const warning of legalWarnings) {
                if (content.includes(warning)) {
                    // Remove the warning text from content
                    formattedContent = content.replace(warning, '');
                    
                    // Add formatted warning at the top
                    formattedContent = `<div class="mb-3 p-3 bg-red-500/10 border-l-4 border-red-500 rounded">
    <p class="text-red-400 font-bold text-sm flex items-center gap-2 mb-2">
        <span>‚ö†Ô∏è</span>
        <span>IMPORTANT: This matter involves legal risk.</span>
    </p>
    <p class="text-red-300 text-sm mb-3">
        Please contact a Senior Consultant at <a href="mailto:info@fitzgeraldhr.com.au" class="underline hover:text-red-200">info@fitzgeraldhr.com.au</a> for expert guidance before taking action.
    </p>
    <div class="flex gap-2">
        <a href="mailto:info@fitzgeraldhr.com.au?subject=URGENT: High-Risk HR Matter - ${encodeURIComponent(currentUser)}" 
           class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center">
            ‚úâÔ∏è Email Consultant
        </a>
        <a href="tel:+61400211014" 
           class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center whitespace-nowrap">
            üìû Call
        </a>
        <button onclick="openTool('scenarioAnalysis')" 
                class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-3 rounded text-sm transition-all whitespace-nowrap">
            üéØ Analyze
        </button>
    </div>
</div>

` + formattedContent.replace('Please contact one of our Senior Consultants at info@fitzgeraldhr.com.au for expert guidance on your specific situation and next steps.', '');
                    break;
                }
            }
        }
        
        // Format the text content (convert markdown and add line breaks)
        // Only format if it doesn't contain our warning HTML
        if (!formattedContent.includes('<div class="mb-3 p-3 bg-red-500/10')) {
            formattedContent = formattedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p class="mt-3">')
                .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
            formattedContent = '<p>' + formattedContent + '</p>';
        } else {
            // If it has the warning, format the text AFTER the warning
            const parts = formattedContent.split('</div>\n\n');
            if (parts.length > 1) {
                const warningPart = parts[0] + '</div>\n\n';
                let textPart = parts[1];
                
                textPart = textPart
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p class="mt-3">')
                    .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
                textPart = '<p>' + textPart + '</p>';
                
                formattedContent = warningPart + textPart;
            }
        }
    }
    
    const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    messageDiv.setAttribute('data-message-id', messageId);
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl ${role === 'user' ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-100 border border-slate-700'} rounded-2xl px-6 py-4 relative">
            ${role === 'assistant' ? `<span class="bookmark-star absolute top-3 right-3" data-message-id="${messageId}" onclick="toggleBookmark('${messageId}')" title="Bookmark this">‚òÜ</span>` : ''}
            ${role === 'user' 
                ? `<p class="leading-relaxed whitespace-pre-wrap">${formattedContent}</p>`
                : `<div class="leading-relaxed">${formattedContent}</div>`
            }
        </div>
    `;
    
    container.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    
    // Update bookmark stars after adding message
    setTimeout(() => updateBookmarkStars(), 100);
    
    if (role === 'assistant') {
        // ‚ùå OLD DOCUMENT DETECTION REMOVED - Now using Document Builder detection in sendMessage()        
        // Suggest relevant tools based on conversation
        const lastUserMessage = conversationHistory.filter(m => m.role === 'user').slice(-1)[0];
        if (lastUserMessage) {
            const suggestedTools = suggestRelevantTools(lastUserMessage.content, content);
            if (suggestedTools.length > 0) {
                setTimeout(() => addToolSuggestions(messageDiv, suggestedTools), 600);
            }
        }
    }
}

async function callClaudeAPI(message) {
    try {
        const venueContext = getVenueContext();
        const response = await fetch(CONFIG.API.CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: venueContext + message,
                history: conversationHistory.filter(m => m.role !== 'system'),
                user: currentUser
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to get response');
        }

        const data = await response.json();
        return data.message;
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// ========================================
// PROACTIVE TOOL SUGGESTIONS
// ========================================

function suggestRelevantTools(userMessage, assistantResponse) {
    // Combine user message and AI response for comprehensive keyword matching
    const lowerMessage = userMessage.toLowerCase();
    const lowerResponse = assistantResponse.toLowerCase();
    const combinedText = lowerMessage + ' ' + lowerResponse;
    
    // Define tool keywords - each tool has trigger phrases
    const toolKeywords = {
        'awardWizard': {
            keywords: ['award rate', 'classification', 'what level', 'pay rate', 'how much should i pay'],
            name: 'Award Wizard',
            icon: 'üßô',
            description: 'Find the exact award classification and rate'
        },
        // ... (keep rest of toolKeywords)
    };
    
    const suggestedTools = [];
    
    // Scan each tool for keyword matches
    for (const [toolId, tool] of Object.entries(toolKeywords)) {
        // Count how many keywords appear in the conversation
        const keywordMatches = tool.keywords.filter(keyword => combinedText.includes(keyword));
        
        // Only suggest if at least one keyword matches
        if (keywordMatches.length > 0) {
            suggestedTools.push({ toolId, ...tool, matches: keywordMatches.length });
        }
    }
    
    // Sort by relevance - most keyword matches first
    suggestedTools.sort((a, b) => b.matches - a.matches);
    
    // Return top 2 most relevant tools to avoid overwhelming user
    return suggestedTools.slice(0, CONFIG.TOOL_SUGGESTION_LIMIT);
}

function addToolSuggestions(messageDiv, tools) {
    if (tools.length === 0) return;
    
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'mt-4 p-4 bg-blue-500/10 border-l-4 border-blue-500 rounded-r-lg';
    
    let html = '<p class="text-blue-400 font-semibold mb-3 flex items-center gap-2">';
    html += '<span>üí°</span><span>Helpful Tools:</span></p><div class="space-y-2">';
    
    tools.forEach(tool => {
        html += `
            <button onclick="openTool('${tool.toolId}')" 
                    class="w-full text-left p-3 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg transition-all flex items-center gap-3 group">
                <span class="text-2xl">${tool.icon}</span>
                <div class="flex-1">
                    <p class="text-slate-200 font-medium group-hover:text-amber-400 transition-colors">${tool.name}</p>
                    <p class="text-xs text-slate-400">${tool.description}</p>
                </div>
                <span class="text-slate-400 group-hover:text-amber-400 transition-colors">‚Üí</span>
            </button>
        `;
    });
    
    html += '</div>';
    suggestionsContainer.innerHTML = html;
    messageDiv.querySelector('.max-w-3xl').appendChild(suggestionsContainer);
}

// ========================================
// DOCUMENT GENERATION
// ========================================

function detectDocumentType(content) {
    const lowerContent = content.toLowerCase();
    const documentKeywords = {
        'employmentContract': ['employment contract', 'hire', 'new employee'],
        'warningLetter': ['warning', 'disciplinary', 'performance issue']
    };
    
    for (const [docType, keywords] of Object.entries(documentKeywords)) {
        if (keywords.some(keyword => lowerContent.includes(keyword))) {
            return docType;
        }
    }
    return null;
}

function addDocumentDownloadButtons(messageDiv, documentType) {
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-4 p-4 bg-slate-700/50 rounded-lg border border-amber-500/30';
    buttonContainer.innerHTML = `
        <p class="text-amber-400 font-semibold mb-3">üìÑ Generate Document</p>
        <div class="flex gap-2">
            <button onclick="downloadDocument('${documentType}', 'word')" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                üìù Download Word
            </button>
        </div>
        <p class="text-xs text-slate-400 mt-3">‚ö†Ô∏è Must be reviewed by consultant before use</p>
    `;
    messageDiv.querySelector('.max-w-3xl').appendChild(buttonContainer);
}

function downloadDocument(documentType, format) {
    const confirmed = confirm(
        "‚ö†Ô∏è IMPORTANT: This is a TEMPLATE only.\n\n" +
        "You MUST have it reviewed by a Fitzgerald HR consultant.\n\n" +
        "Contact: info@fitzgeraldhr.com.au\n\n" +
        "Click OK to download."
    );
    
    if (!confirmed) return;
    
    const data = { employeeName: '[Name]', position: '[Position]' };
    const template = hrTemplates[documentType];
    if (!template) return;
    
    const content = template(data);
    const filename = `${documentType}_${Date.now()}.doc`;
    generateWordDocument(content, filename);
}

function generateExcelSpreadsheet(data, filename, sheetName = 'Data') {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    const colWidths = Object.keys(data[0] || {}).map(() => ({ wch: 20 }));
    ws['!cols'] = colWidths;
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, filename);
    return true;
}

// ========================================
// CRISIS MODE
// ========================================

function activateCrisisMode() {
    document.getElementById('crisisModal').classList.remove('hidden');
    trackEvent('crisis_mode_activated', { user: currentUser });
}

function closeCrisisModal() {
    document.getElementById('crisisModal').classList.add('hidden');
}
/**
 * Submits crisis form to backend for urgent consultant callback
 * Shows loading state and handles errors gracefully
 * @returns {Promise<void>}
 */
async function submitCrisis() {
    const crisisType = document.getElementById('crisisType').value;
    const description = document.getElementById('crisisDescription').value;
    const phone = document.getElementById('crisisPhone').value;

    if (!crisisType || !description || !phone) {
        alert('Please fill in all fields');
        return;
    }

    const submitBtn = document.querySelector('#crisisModal button[onclick="submitCrisis()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-pulse">‚è≥ Sending...</span>';

    try {
        const response = await fetch(CONFIG.API.CRISIS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ crisisType, description, phone, user: currentUser })
        });

        const result = await response.json();

        if (response.ok) {
            alert(`üö® URGENT ALERT SENT\n\nCrisis ID: ${result.crisisId}\n\nA consultant will call ${phone} within 15 minutes.`);
            closeCrisisModal();
        } else {
            throw new Error(result.error || 'Failed');
        }
    } catch (error) {
        console.error('Crisis error:', error);
        alert(`‚ö†Ô∏è ALERT FAILED\n\nPLEASE CALL: +61 400 211 014\n\nYour submission is logged locally.`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// ========================================
// VOICE INPUT
// ========================================

function toggleVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice input not supported in your browser. Try Chrome or Edge.', 'warning', 3000);
        return;
    }
    isListening ? stopListening() : startListening();
}

function startListening() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-AU';

    recognition.onstart = () => {
        isListening = true;
        
        // Update button style
        const voiceBtn = document.getElementById('voiceButton');
        const voiceIcon = document.getElementById('voiceIcon');
        if (voiceBtn) {
            voiceBtn.classList.add('bg-red-500', 'text-white');
            voiceBtn.classList.remove('text-slate-400');
        }
        if (voiceIcon) {
            voiceIcon.classList.add('animate-pulse');
        }
        
        // Show recording indicator
        const indicator = document.getElementById('voiceRecordingIndicator');
        if (indicator) {
            indicator.classList.remove('hidden');
        }
    };

    // Debounce transcript updates for better performance
    const updateTranscript = debounce((transcript) => {
        DOM.messageInput.value = transcript;
        autoResizeTextarea(DOM.messageInput);
    }, CONFIG.DEBOUNCE_DELAY);

    recognition.onresult = (event) => {
        const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
        updateTranscript(transcript);
    };

    recognition.onerror = () => stopListening();
    recognition.onend = () => stopListening();
    recognition.start();
}

function stopListening() {
    if (recognition) recognition.stop();
    isListening = false;
    
    // Reset button style
    const voiceBtn = document.getElementById('voiceButton');
    const voiceIcon = document.getElementById('voiceIcon');
    if (voiceBtn) {
        voiceBtn.classList.remove('bg-red-500', 'text-white');
        voiceBtn.classList.add('text-slate-400');
    }
    if (voiceIcon) {
        voiceIcon.classList.remove('animate-pulse');
    }
    
    // Hide recording indicator
    const indicator = document.getElementById('voiceRecordingIndicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
}

// ========================================
// CHATGPT-STYLE SIDEBAR & NEW FEATURES
// ========================================

// ========================================
// CONVERSATION MANAGEMENT SYSTEM
// ========================================

// Conversation storage
var conversations = [];
var currentConversationId = null;

// Load conversations from localStorage
function loadConversations() {
    const stored = localStorage.getItem('fitz_conversations');
    if (stored) {
        try {
            conversations = JSON.parse(stored);
            console.log('‚úÖ Loaded', conversations.length, 'conversations');
        } catch (e) {
            console.error('Error loading conversations:', e);
            conversations = [];
        }
    }
}

// Save conversations to localStorage
function saveConversations() {
    try {
        localStorage.setItem('fitz_conversations', JSON.stringify(conversations));
        console.log('üíæ Saved', conversations.length, 'conversations');
    } catch (e) {
        console.error('Error saving conversations:', e);
    }
}

// Get current conversation
function getCurrentConversation() {
    return conversations.find(c => c.id === currentConversationId);
}

// Create new conversation
function createNewConversation() {
    // Save current conversation first
    if (currentConversationId) {
        saveCurrentConversation();
    }
    
    // Create new conversation
    const newConv = {
        id: 'conv-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        title: 'New Chat',
        messages: [],
        created: new Date().toISOString(),
        updated: new Date().toISOString()
    };
    
    conversations.push(newConv);
    currentConversationId = newConv.id;
    
    // Clear UI
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    if (container) {
        container.innerHTML = '';
    } else {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
    }
    
    // Reset conversation history
    conversationHistory = [];
    
    // Add FULL welcome message with HTML formatting (matching Image 1)
    const welcomeMessage = `
        <p class="text-slate-100 leading-relaxed">
            üëã G'day! I'm Fitz, your hospitality HR assistant.
        </p>
        <p class="text-slate-100 leading-relaxed mt-3">
            Ask me anything about awards, compliance, or employment law.
        </p>
        <p class="text-red-400 font-semibold mt-4 mb-2">üö® Urgent/Critical Situations:</p>
        <p class="text-slate-100 text-sm">
            Use the red URGENT button above for immediate crisis response.
        </p>
        <p class="text-slate-100 leading-relaxed mt-4">
            What HR topic would you like to learn about today?
        </p>
    `;
    
    // For display - reuse container already declared above
    var displayContainer = DOM.messagesContainer.querySelector('.space-y-6');
    if (!displayContainer) {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        displayContainer = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    if (displayContainer) {
        var messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start fade-in';
        var messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.innerHTML = '<div class="max-w-3xl bg-slate-800 text-slate-100 border border-slate-700 rounded-2xl px-6 py-4 relative">' +
            '<span class="bookmark-star absolute top-3 right-3" data-message-id="' + messageId + '" onclick="toggleBookmark(\'' + messageId + '\')" title="Bookmark this">‚òÜ</span>' +
            '<div class="leading-relaxed">' + welcomeMessage + '</div>' +
            '</div>';
        displayContainer.appendChild(messageDiv);
    }
    
    // For storage - save plain text version
    var plainWelcome = 'üëã G\'day! I\'m Fitz, your hospitality HR assistant.\n\nAsk me anything about awards, compliance, or employment law.\n\nüö® Urgent/Critical Situations:\nUse the red URGENT button above for immediate crisis response.\n\nWhat HR topic would you like to learn about today?';
    conversationHistory.push({ role: 'assistant', content: plainWelcome });
    
    // Save and update UI - FIXED: Use saveCurrentConversation to update messages
    saveCurrentConversation();
    
    showToast('New chat started', 'success', 2000);
    
    console.log('‚úÖ Created new conversation:', newConv.id);
}

// Save current conversation
function saveCurrentConversation() {
    console.log('üíæ saveCurrentConversation called');
    console.log('üíæ currentConversationId:', currentConversationId);
    console.log('üíæ conversationHistory length:', conversationHistory.length);
    console.log('üíæ conversationHistory:', conversationHistory);
    
    if (!currentConversationId) {
        console.error('‚ùå No currentConversationId - exiting');
        return;
    }
    
    var conv = getCurrentConversation();
    console.log('üíæ Found conversation:', conv);
    
    if (!conv) {
        console.error('‚ùå Conversation not found in array - exiting');
        return;
    }
    
    console.log('üíæ BEFORE update - conv.messages:', conv.messages);
    
    // Update messages
    conv.messages = conversationHistory;
    conv.updated = new Date().toISOString();
    
    console.log('üíæ AFTER update - conv.messages:', conv.messages);
    console.log('üíæ conv.messages length:', conv.messages.length);
    
    // Update title from first user message if still "New Chat"
    if (conv.title === 'New Chat' && conversationHistory.length > 0) {
        var firstUserMsg = conversationHistory.find(function(m) { return m.role === 'user'; });
        if (firstUserMsg) {
            conv.title = firstUserMsg.content.substring(0, 50) + (firstUserMsg.content.length > 50 ? '...' : '');
            console.log('üíæ Updated title to:', conv.title);
        }
    }
    
    console.log('üíæ About to save to localStorage');
    saveConversations();
    updateSidebarChats();
    
    console.log('‚úÖ Saved conversation:', conv.title);
}

// Load conversation by ID
function loadConversation(convId) {
    console.log('üîç loadConversation called with:', convId);
    console.log('üîç conversations array:', conversations);
    console.log('üîç DOM.messagesContainer:', DOM.messagesContainer);
    
    // Save current first
    if (currentConversationId && currentConversationId !== convId) {
        saveCurrentConversation();
    }
    
    var conv = conversations.find(function(c) { return c.id === convId; });
    if (!conv) {
        console.error('‚ùå Conversation not found:', convId);
        return;
    }
    
    console.log('‚úÖ Found conversation:', conv);
    currentConversationId = convId;
    
    // Clear UI
    var container = DOM.messagesContainer.querySelector('.space-y-6');
    console.log('üîç Container before clear:', container);
    
    if (container) {
        container.innerHTML = '';
    } else {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        container = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    console.log('üîç Container after clear:', container);
    
    // Load messages
    conversationHistory = conv.messages || [];
    console.log('üîç Loading messages:', conversationHistory.length);
    
    // Render messages
    conversationHistory.forEach(function(msg, index) {
        console.log('üîç Rendering message', index, ':', msg.role, msg.content.substring(0, 50));
        addMessage(msg.role, msg.content);
    });
    
    // Update UI
    updateSidebarChats();
    
    console.log('‚úÖ Loaded conversation:', conv.title);
}

// Delete conversation
function deleteConversation(convId) {
    const conv = conversations.find(c => c.id === convId);
    if (!conv) return;
    
    if (!confirm('Delete "' + conv.title + '"? This cannot be undone.')) {
        return;
    }
    
    // Remove from array
    conversations = conversations.filter(c => c.id !== convId);
    
    // If deleting current conversation
    if (convId === currentConversationId) {
        if (conversations.length > 0) {
            // Load the most recent conversation
            loadConversation(conversations[conversations.length - 1].id);
        } else {
            // Create new conversation
            createNewConversation();
        }
    }
    
    saveConversations();
    updateSidebarChats();
    
    showToast('Conversation deleted', 'info', 2000);
}

// Update sidebar chats list
function updateSidebarChats() {
    const chatsList = document.getElementById('sidebarChatsList');
    if (!chatsList) return;
    
    if (conversations.length === 0) {
        chatsList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No chats yet</p>';
        return;
    }
    
    // Sort by updated date (most recent first)
    const sortedConvs = [...conversations].sort((a, b) => 
        new Date(b.updated) - new Date(a.updated)
    );
    
    chatsList.innerHTML = sortedConvs.map(conv => {
        const isActive = conv.id === currentConversationId;
        const date = new Date(conv.updated);
        const dateStr = formatRelativeDate(date);
        
        return `
            <div class="sidebar-chat-item ${isActive ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                <div class="sidebar-chat-title">${escapeHtml(conv.title)}</div>
                <button class="sidebar-chat-delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

// Format relative date
function formatRelativeDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return diffDays + 'd ago';
    return date.toLocaleDateString();
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize conversation system
function initConversationSystem() {
    loadConversations();
    
    if (conversations.length === 0) {
        // Create first conversation
        createNewConversation();
    } else {
        // Load most recent conversation
        const mostRecent = conversations.sort((a, b) => 
            new Date(b.updated) - new Date(a.updated)
        )[0];
        loadConversation(mostRecent.id);
    }
}

// ========================================
// BOOKMARKS SYSTEM
// ========================================

var bookmarks = [];
var recentTools = []; // Track recently used tools

// Tool metadata
const toolMetadata = {
    'documentBuilderModal': { name: 'Document Builder', icon: 'üìù' },
    'awardCalculatorModal': { name: 'Award Calculator', icon: 'üí∞' },
    'scenarioAnalysisModal': { name: 'Scenario Analysis', icon: 'üéØ' },
    'rosterStressTesterModal': { name: 'Roster Stress Test', icon: 'üîç' },
    'awardWizardModal': { name: 'Award Wizard', icon: 'üßô' },
    'rosterOptimizerModal': { name: 'Roster Optimizer', icon: 'üìÖ' },
    'complianceCalendarModal': { name: 'Compliance Calendar', icon: 'üìÜ' },
    'terminationRiskModal': { name: 'Termination Risk', icon: '‚ö†Ô∏è' }
};


// Load bookmarks
function loadBookmarks() {
    const stored = localStorage.getItem('fitz_bookmarks');
    if (stored) {
        try {
            bookmarks = JSON.parse(stored);
        } catch (e) {
            bookmarks = [];
        }
    }
}

// Save bookmarks
function saveBookmarks() {
    localStorage.setItem('fitz_bookmarks', JSON.stringify(bookmarks));
}

// Toggle bookmark
function toggleBookmark(messageId) {
    const existingIndex = bookmarks.findIndex(b => b.id === messageId);
    
    if (existingIndex >= 0) {
        // Remove bookmark
        bookmarks.splice(existingIndex, 1);
        showToast('Bookmark removed', 'info', 1500);
    } else {
        // Add bookmark
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            const content = messageElement.textContent;
            bookmarks.push({
                id: messageId,
                content: content,
                conversationId: currentConversationId,
                created: new Date().toISOString()
            });
            showToast('Bookmarked', 'success', 1500);
        }
    }
    
    saveBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
}

// Update bookmark stars
function updateBookmarkStars() {
    document.querySelectorAll('.bookmark-star').forEach(star => {
        const messageId = star.getAttribute('data-message-id');
        const isBookmarked = bookmarks.some(b => b.id === messageId);
        star.textContent = isBookmarked ? '‚≠ê' : '‚òÜ';
    });
}

// Update sidebar bookmarks
function updateSidebarBookmarks() {
    console.log('üîñ updateSidebarBookmarks called');
    console.log('üîñ bookmarks array:', bookmarks);
    
    var bookmarksList = document.getElementById('sidebarBookmarksList');
    console.log('üîñ bookmarksList element:', bookmarksList);
    
    if (!bookmarksList) {
        console.error('‚ùå sidebarBookmarksList element not found!');
        return;
    }
    
    if (bookmarks.length === 0) {
        bookmarksList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No bookmarks yet</p>';
        console.log('‚úÖ No bookmarks, showing empty message');
        return;
    }
    
    console.log('‚úÖ Rendering', bookmarks.length, 'bookmarks');
    
    bookmarksList.innerHTML = bookmarks.slice(0, 10).map(function(b) {
        var preview = b.content.substring(0, 60) + (b.content.length > 60 ? '...' : '');
        return '<div class="sidebar-chat-item" onclick="jumpToBookmark(\'' + b.id + '\')">' +
            '<div class="sidebar-chat-title text-xs">' + escapeHtml(preview) + '</div>' +
            '<button class="sidebar-chat-delete" onclick="event.stopPropagation(); removeBookmark(\'' + b.id + '\')" title="Remove">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' +
                '</svg>' +
            '</button>' +
        '</div>';
    }).join('');
    
    console.log('‚úÖ Bookmarks rendered');
}

// Jump to bookmark
function jumpToBookmark(messageId) {
    const bookmark = bookmarks.find(b => b.id === messageId);
    if (!bookmark) return;
    
    // If bookmark is in different conversation, load it
    if (bookmark.conversationId !== currentConversationId) {
        loadConversation(bookmark.conversationId);
    }
    
    // Scroll to message
    setTimeout(() => {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messageElement.classList.add('highlight-flash');
            setTimeout(() => messageElement.classList.remove('highlight-flash'), 2000);
        }
    }, 500);
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
}

// Remove bookmark
function removeBookmark(messageId) {
    bookmarks = bookmarks.filter(b => b.id !== messageId);
    saveBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
    showToast('Bookmark removed', 'info', 1500);
}

// ========================================
// RECENT TOOLS TRACKING
// ========================================

function loadRecentTools() {
    try {
        const stored = localStorage.getItem('fitz_recent_tools');
        recentTools = stored ? JSON.parse(stored) : [];
        console.log('üìã Loaded recent tools:', recentTools.length);
    } catch (e) {
        console.error('Error loading recent tools:', e);
        recentTools = [];
    }
}

function saveRecentTools() {
    try {
        localStorage.setItem('fitz_recent_tools', JSON.stringify(recentTools));
    } catch (e) {
        console.error('Error saving recent tools:', e);
    }
}

function trackToolUsage(toolId) {
    console.log('üõ†Ô∏è Tracking tool usage:', toolId);
    
    const tool = toolMetadata[toolId];
    if (!tool) return;
    
    // Remove if exists (to move to front)
    recentTools = recentTools.filter(t => t.id !== toolId);
    
    // Add to front
    recentTools.unshift({
        id: toolId,
        name: tool.name,
        icon: tool.icon,
        timestamp: new Date().toISOString()
    });
    
    // Keep only last 5
    recentTools = recentTools.slice(0, 5);
    
    saveRecentTools();
    updateSidebarRecentTools();
    
    trackEvent('tool_used', {
        user: currentUser,
        tool: tool.name
    });
}

function updateSidebarRecentTools() {
    var toolsList = document.getElementById('sidebarRecentTools');
    if (!toolsList) return;
    
    if (recentTools.length === 0) {
        toolsList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No tools used yet</p>';
        return;
    }
    
    toolsList.innerHTML = recentTools.map(function(tool) {
        return '<div class="sidebar-chat-item hover:bg-slate-700" onclick="openToolById(\'' + tool.id + '\')" style="cursor: pointer;">' +
            '<div class="flex items-center gap-2">' +
                '<span class="text-xl">' + tool.icon + '</span>' +
                '<div class="sidebar-chat-title text-sm">' + tool.name + '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

function openToolById(toolId) {
    trackToolUsage(toolId);
    
    var modal = document.getElementById(toolId);
    if (modal) {
        modal.classList.remove('hidden');
        closeToolsMenu();
    }
}

// ========================================
// SEARCH SYSTEM
// ========================================

// Perform sidebar search
function performSidebarSearch() {
    const query = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('sidebarSearchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    // Search across all conversations
    let results = [];
    conversations.forEach(conv => {
        (conv.messages || []).forEach(msg => {
            if (msg.content.toLowerCase().includes(query)) {
                results.push({
                    conversationId: conv.id,
                    conversationTitle: conv.title,
                    content: msg.content,
                    role: msg.role
                });
            }
        });
    });
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-500 text-xs py-2">No results</p>';
        return;
    }
    
    // Limit to first 10 results
    results = results.slice(0, 10);
    
    resultsDiv.innerHTML = results.map(r => {
        const preview = r.content.substring(0, 80) + (r.content.length > 80 ? '...' : '');
        // Highlight search term
        const highlighted = preview.replace(
            new RegExp(query, 'gi'),
            match => `<mark class="bg-amber-500/30 text-amber-300">${match}</mark>`
        );
        
        return `
            <div class="text-xs text-slate-300 py-2 px-2 hover:bg-slate-700 rounded cursor-pointer border-b border-slate-700/50" 
                 onclick="openSearchResult('${r.conversationId}')">
                <div class="text-slate-400 text-xs mb-1">${escapeHtml(r.conversationTitle)}</div>
                <div>${highlighted}</div>
            </div>
        `;
    }).join('');
}

// Open search result
function openSearchResult(convId) {
    loadConversation(convId);
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
    
    // Clear search
    const searchInput = document.getElementById('sidebarSearchInput');
    if (searchInput) {
        searchInput.value = '';
        performSidebarSearch();
    }
}

// ========================================

// Sidebar state
let sidebarOpen = false; // Closed by default on all devices

// Toggle sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebarOpen = !sidebarOpen;
    
    if (sidebarOpen) {
        sidebar.classList.remove('closed');
        if (window.innerWidth < 768) {
            overlay.classList.add('active');
        }
    } else {
        sidebar.classList.add('closed');
        overlay.classList.remove('active');
    }
}

// Initialize sidebar on load
function initSidebar() {
    var sidebar = document.getElementById('chatSidebar');
    // Always start closed on all devices
    if (sidebar) {
        sidebar.classList.add('closed');
        sidebarOpen = false;
    }
}

// Upload menu toggle
function toggleUploadMenu() {
    const menu = document.getElementById('uploadMenu');
    menu.classList.toggle('hidden');
}

// Toggle Tools Menu
function toggleToolsMenu() {
    var menu = document.getElementById('toolsMenu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function closeToolsMenu() {
    var menu = document.getElementById('toolsMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// More Menu Functions
function toggleMoreMenu() {
    var menu = document.getElementById('moreMenu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function closeMoreMenu() {
    var menu = document.getElementById('moreMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// Profile Menu Functions
function openProfileMenu() {
    var menu = document.getElementById('profileMenu');
    if (menu) {
        menu.classList.remove('hidden');
        
        // Update venue name and code in profile from venueProfile
        var venueName = venueProfile.venueName || 'Your Venue';
        var userCode = currentUser || 'N/A';
        
        document.getElementById('profileVenueName').textContent = venueName;
        document.getElementById('profileUserCode').textContent = 'Code: ' + userCode;
    }
}

function closeProfileMenu() {
    var menu = document.getElementById('profileMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// Update sidebar venue name on load
function updateSidebarVenueName() {
    console.log('üè® updateSidebarVenueName called');
    console.log('üè® venueProfile:', venueProfile);
    console.log('üè® venueProfile.venueName:', venueProfile.venueName);
    
    var venueName = venueProfile.venueName || 'Fitz';
    console.log('üè® Using venueName:', venueName);
    
    var sidebarName = document.getElementById('sidebarVenueName');
    console.log('üè® sidebarName element:', sidebarName);
    
    if (sidebarName) {
        sidebarName.textContent = venueName;
        console.log('‚úÖ Sidebar name updated to:', venueName);
    } else {
        console.error('‚ùå sidebarVenueName element not found!');
    }
    
    // Also store in localStorage for easy access
    if (venueProfile.venueName) {
        localStorage.setItem('venueName', venueProfile.venueName);
    }
    
    // Update userCode display
    localStorage.setItem('userCode', currentUser);
}

// Tool Opening Functions
function openAwardCalculator() {
    trackToolUsage('awardCalculatorModal');
    var modal = document.getElementById('awardCalculatorModal');
    if (modal) modal.classList.remove('hidden');
}

function openScenarioAnalysis() {
    trackToolUsage('scenarioAnalysisModal');
    var modal = document.getElementById('scenarioAnalysisModal');
    if (modal) modal.classList.remove('hidden');
}

function openRosterStressTester() {
    trackToolUsage('rosterStressTesterModal');
    var modal = document.getElementById('rosterStressTesterModal');
    if (modal) modal.classList.remove('hidden');
}

function openAwardWizard() {
    trackToolUsage('awardWizardModal');
    var modal = document.getElementById('awardWizardModal');
    if (modal) modal.classList.remove('hidden');
}

function openRosterOptimizer() {
    trackToolUsage('rosterOptimizerModal');
    var modal = document.getElementById('rosterOptimizerModal');
    if (modal) modal.classList.remove('hidden');
}

function openComplianceCalendar() {
    trackToolUsage('complianceCalendarModal');
    var modal = document.getElementById('complianceCalendarModal');
    if (modal) modal.classList.remove('hidden');
}

function openTerminationRisk() {
    trackToolUsage('terminationRiskModal');
    var modal = document.getElementById('terminationRiskModal');
    if (modal) modal.classList.remove('hidden');
}

// ========================================
// RECRUITMENT TOOLKIT FUNCTIONS
// ========================================

// Main Recruitment Toolkit
function openRecruitmentToolkit() {
    trackToolUsage('recruitmentToolkitModal');
    var modal = document.getElementById('recruitmentToolkitModal');
    if (modal) modal.classList.remove('hidden');
}

function closeRecruitmentToolkit() {
    var modal = document.getElementById('recruitmentToolkitModal');
    if (modal) modal.classList.add('hidden');
}

// Job Description Builder
let jdCurrentStep = 1;
let jdData = {
    jobTitle: '',
    experienceLevel: '',
    responsibilities: '',
    qualifications: '',
    award: '',
    classification: '',
    salaryRange: ''
};

function openJobDescriptionBuilder() {
    trackToolUsage('jobDescriptionBuilder');
    jdCurrentStep = 1;
    jdData = { jobTitle: '', experienceLevel: '', responsibilities: '', qualifications: '', award: '', classification: '', salaryRange: '' };
    updateJDStep();
    var modal = document.getElementById('jobDescriptionBuilderModal');
    if (modal) modal.classList.remove('hidden');
}

function closeJobDescriptionBuilder() {
    var modal = document.getElementById('jobDescriptionBuilderModal');
    if (modal) modal.classList.add('hidden');
}

function updateJDStep() {
    // Hide all steps
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById('jdStep' + i);
        if (step) step.classList.add('hidden');
    }
    
    // Show current step
    const currentStepEl = document.getElementById('jdStep' + jdCurrentStep);
    if (currentStepEl) currentStepEl.classList.remove('hidden');
    
    // Update step counter
    document.getElementById('jdStep').textContent = jdCurrentStep;
    
    // Update buttons
    document.getElementById('jdBackBtn').classList.toggle('hidden', jdCurrentStep === 1);
    document.getElementById('jdNextBtn').classList.toggle('hidden', jdCurrentStep === 5);
    document.getElementById('jdGenerateBtn').classList.toggle('hidden', jdCurrentStep !== 5);
}

function jdNextStep() {
    // Validate current step
    if (jdCurrentStep === 1) {
        const jobTitle = document.getElementById('jdJobTitle').value.trim();
        if (!jobTitle) {
            alert('Please enter a job title');
            return;
        }
        jdData.jobTitle = jobTitle;
    }
    
    if (jdCurrentStep === 2 && !jdData.experienceLevel) {
        alert('Please select an experience level');
        return;
    }
    
    // Move to next step
    if (jdCurrentStep < 5) {
        jdCurrentStep++;
        updateJDStep();
        
        // If moving to step 3, generate responsibilities with AI
        if (jdCurrentStep === 3) {
            generateResponsibilities();
        }
        
        // If moving to step 5, calculate salary
        if (jdCurrentStep === 5) {
            setupSalaryCalculation();
        }
    }
}

function jdPreviousStep() {
    if (jdCurrentStep > 1) {
        jdCurrentStep--;
        updateJDStep();
    }
}

function selectJDExperience(level) {
    jdData.experienceLevel = level;
    // Highlight selected
    document.querySelectorAll('.jd-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.jd-experience-btn').classList.remove('border-slate-600');
    event.target.closest('.jd-experience-btn').classList.add('border-amber-500');
    setTimeout(() => jdNextStep(), 300);
}

async function generateResponsibilities() {
    const loading = document.getElementById('jdResponsibilitiesLoading');
    const textarea = document.getElementById('jdResponsibilities');
    const help = document.getElementById('jdResponsibilitiesHelp');
    
    loading.classList.remove('hidden');
    textarea.classList.add('hidden');
    help.classList.add('hidden');
    
    try {
        const prompt = `Generate 5-7 key responsibilities for a ${jdData.experienceLevel} level ${jdData.jobTitle} position in the Australian hospitality industry. Format as a bulleted list. Be specific and professional.`;
        
        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'responsibilities'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate responsibilities');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        textarea.value = content;
        loading.classList.add('hidden');
        textarea.classList.remove('hidden');
        help.classList.remove('hidden');
    } catch (error) {
        console.error('Error generating responsibilities:', error);
        textarea.value = '‚Ä¢ [Add key responsibility]\n‚Ä¢ [Add key responsibility]\n‚Ä¢ [Add key responsibility]';
        loading.classList.add('hidden');
        textarea.classList.remove('hidden');
        help.classList.remove('hidden');
    }
}

function setupSalaryCalculation() {
    const awardSelect = document.getElementById('jdAward');
    const classSelect = document.getElementById('jdClassification');
    const display = document.getElementById('jdSalaryDisplay');
    const rangeEl = document.getElementById('jdSalaryRange');
    
    const calculate = () => {
        if (awardSelect.value && classSelect.value) {
            // Simple salary calculation (would integrate with Award Calculator)
            const baseRates = {
                'restaurant': [45000, 55000, 75000],
                'hospitality': [43000, 53000, 72000],
                'fast-food': [42000, 50000, 68000]
            };
            
            const level = parseInt(classSelect.value) - 1;
            const base = baseRates[awardSelect.value][level];
            const min = base;
            const max = Math.round(base * 1.15);
            
            jdData.salaryRange = `$${min.toLocaleString()} - $${max.toLocaleString()} per year`;
            rangeEl.textContent = jdData.salaryRange;
            display.classList.remove('hidden');
        }
    };
    
    awardSelect.addEventListener('change', calculate);
    classSelect.addEventListener('change', calculate);
}

async function generateJobDescription() {
    // Collect all data
    jdData.responsibilities = document.getElementById('jdResponsibilities').value;
    jdData.qualifications = document.getElementById('jdQualifications').value;
    jdData.award = document.getElementById('jdAward').value;
    jdData.classification = document.getElementById('jdClassification').value;
    
    if (!jdData.salaryRange) {
        alert('Please select award and classification to calculate salary');
        return;
    }
    
    // Hide wizard steps, show loading
    document.getElementById('jdBuilderSteps').classList.add('hidden');
    document.getElementById('jdGenerating').classList.remove('hidden');
    
    try {
        const prompt = `Create a professional job description for:
                    
Job Title: ${jdData.jobTitle}
Experience Level: ${jdData.experienceLevel}

Key Responsibilities:
${jdData.responsibilities}

Required Qualifications:
${jdData.qualifications}

Salary Range: ${jdData.salaryRange}

Format as a complete, professional job description with sections for: Position Overview, Key Responsibilities, Required Qualifications, Desired Skills, Salary & Benefits. Make it engaging and specific to Australian hospitality.`;

        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'jobDescription'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate job description');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        // Store for download
        jdData.generatedContent = content;
        
        // Close job description builder modal
        closeJobDescriptionBuilder();
        
        // Show preview
        document.getElementById('jdPreviewContent').innerHTML = '<pre class="whitespace-pre-wrap text-slate-200">' + content + '</pre>';
        document.getElementById('jobDescriptionPreviewModal').classList.remove('hidden');
        
        trackEvent('job_description_generated', { jobTitle: jdData.jobTitle, experienceLevel: jdData.experienceLevel });
    } catch (error) {
        console.error('Error generating job description:', error);
        showToast('Error generating job description', 'error');
        
        // Show wizard steps again on error
        document.getElementById('jdGenerating').classList.add('hidden');
        document.getElementById('jdBuilderSteps').classList.remove('hidden');
    }
}

function closeJobDescriptionPreview() {
    document.getElementById('jobDescriptionPreviewModal').classList.add('hidden');
}

async function downloadJobDescription(format) {
    const content = jdData.generatedContent || document.getElementById('jdPreviewContent').innerText;
    const filename = `Job_Description_${jdData.jobTitle.replace(/\s+/g, '_')}`;
    
    if (format === 'docx') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate Word document using existing function
            await generateWordDocument(htmlContent, `${filename}.docx`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Job Description'
            });
            
            trackEvent('job_description_downloaded', { format: 'docx', jobTitle: jdData.jobTitle });
        } catch (error) {
            console.error('Error downloading DOCX:', error);
            showToast('Error generating Word document', 'error');
        }
    } else if (format === 'pdf') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate PDF using existing function
            await generatePDFDocument(htmlContent, `${filename}.pdf`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Job Description'
            });
            
            trackEvent('job_description_downloaded', { format: 'pdf', jobTitle: jdData.jobTitle });
        } catch (error) {
            console.error('Error downloading PDF:', error);
            showToast('Error generating PDF document', 'error');
        }
    }
}

// Interview Questions Generator
let iqCurrentStep = 1;
let iqData = {
    jobTitle: '',
    experienceLevel: '',
    categories: [],
    questionCount: 15
};

function openInterviewQuestionsGenerator() {
    trackToolUsage('interviewQuestionsGenerator');
    iqCurrentStep = 1;
    iqData = { jobTitle: '', experienceLevel: '', categories: [], questionCount: 15 };
    updateIQStep();
    var modal = document.getElementById('interviewQuestionsModal');
    if (modal) modal.classList.remove('hidden');
}

function closeInterviewQuestions() {
    var modal = document.getElementById('interviewQuestionsModal');
    if (modal) modal.classList.add('hidden');
}

function updateIQStep() {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById('iqStep' + i);
        if (step) step.classList.add('hidden');
    }
    
    // Show current step
    const currentStepEl = document.getElementById('iqStep' + iqCurrentStep);
    if (currentStepEl) currentStepEl.classList.remove('hidden');
    
    // Update step counter
    document.getElementById('iqStep').textContent = iqCurrentStep;
    
    // Update buttons
    document.getElementById('iqBackBtn').classList.toggle('hidden', iqCurrentStep === 1);
    document.getElementById('iqNextBtn').classList.toggle('hidden', iqCurrentStep === 4);
    document.getElementById('iqGenerateBtn').classList.toggle('hidden', iqCurrentStep !== 4);
}

function iqNextStep() {
    if (iqCurrentStep === 1) {
        const jobTitle = document.getElementById('iqJobTitle').value.trim();
        if (!jobTitle) {
            alert('Please enter a job title');
            return;
        }
        iqData.jobTitle = jobTitle;
    }
    
    if (iqCurrentStep === 2 && !iqData.experienceLevel) {
        alert('Please select an experience level');
        return;
    }
    
    if (iqCurrentStep === 3) {
        iqData.categories = [];
        if (document.getElementById('iqTechnical').checked) iqData.categories.push('Technical');
        if (document.getElementById('iqBehavioral').checked) iqData.categories.push('Behavioral');
        if (document.getElementById('iqSituational').checked) iqData.categories.push('Situational');
        
        if (iqData.categories.length === 0) {
            alert('Please select at least one category');
            return;
        }
    }
    
    if (iqCurrentStep < 4) {
        iqCurrentStep++;
        updateIQStep();
    }
}

function iqPreviousStep() {
    if (iqCurrentStep > 1) {
        iqCurrentStep--;
        updateIQStep();
    }
}

function selectIQExperience(level) {
    iqData.experienceLevel = level;
    document.querySelectorAll('.iq-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.iq-experience-btn').classList.remove('border-slate-600');
    event.target.closest('.iq-experience-btn').classList.add('border-amber-500');
    setTimeout(() => iqNextStep(), 300);
}

function selectIQCount(count) {
    iqData.questionCount = count;
    document.querySelectorAll('.iq-count-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.iq-count-btn').classList.remove('border-slate-600');
    event.target.closest('.iq-count-btn').classList.add('border-amber-500');
}

async function generateInterviewQuestions() {
    if (!iqData.questionCount) {
        alert('Please select number of questions');
        return;
    }
    
    // Hide wizard steps, show loading
    document.getElementById('iqBuilderSteps').classList.add('hidden');
    document.getElementById('iqGenerating').classList.remove('hidden');
    
    try {
        const prompt = `Generate ${iqData.questionCount} interview questions for a ${iqData.experienceLevel} level ${iqData.jobTitle} in Australian hospitality.

Categories to include: ${iqData.categories.join(', ')}

For each question provide:
1. The question
2. What to look for in the answer
3. STAR method example (for behavioral)
4. Red flags to watch for

Format clearly with headers and bullet points.`;

        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'interviewQuestions'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate interview questions');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        // Store for download
        iqData.generatedContent = content;
        
        // Close interview questions modal
        closeInterviewQuestions();
        
        // Show preview
        document.getElementById('iqPreviewContent').innerHTML = '<pre class="whitespace-pre-wrap text-slate-200">' + content + '</pre>';
        document.getElementById('interviewQuestionsPreviewModal').classList.remove('hidden');
        
        trackEvent('interview_questions_generated', { jobTitle: iqData.jobTitle, count: iqData.questionCount });
    } catch (error) {
        console.error('Error generating questions:', error);
        showToast('Error generating questions', 'error');
        
        // Show wizard steps again on error
        document.getElementById('iqGenerating').classList.add('hidden');
        document.getElementById('iqBuilderSteps').classList.remove('hidden');
    }
}

function closeInterviewQuestionsPreview() {
    document.getElementById('interviewQuestionsPreviewModal').classList.add('hidden');
}

async function downloadInterviewQuestions(format) {
    const content = iqData.generatedContent || document.getElementById('iqPreviewContent').innerText;
    const filename = `Interview_Questions_${iqData.jobTitle.replace(/\s+/g, '_')}`;
    
    if (format === 'docx') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate Word document using existing function
            await generateWordDocument(htmlContent, `${filename}.docx`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Interview Questions'
            });
            
            trackEvent('interview_questions_downloaded', { format: 'docx', jobTitle: iqData.jobTitle });
        } catch (error) {
            console.error('Error downloading DOCX:', error);
            showToast('Error generating Word document', 'error');
        }
    } else if (format === 'pdf') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate PDF using existing function
            await generatePDFDocument(htmlContent, `${filename}.pdf`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Interview Questions'
            });
            
            trackEvent('interview_questions_downloaded', { format: 'pdf', jobTitle: iqData.jobTitle });
        } catch (error) {
            console.error('Error downloading PDF:', error);
            showToast('Error generating PDF document', 'error');
        }
    }
}

// Reference Check Form
function openReferenceCheckForm() {
    trackToolUsage('referenceCheckForm');
    var modal = document.getElementById('referenceCheckModal');
    if (modal) modal.classList.remove('hidden');
}

function closeReferenceCheck() {
    var modal = document.getElementById('referenceCheckModal');
    if (modal) modal.classList.add('hidden');
}

function generateReferenceCheck() {
    const candidateName = document.getElementById('rcCandidateName').value.trim();
    const position = document.getElementById('rcPosition').value.trim();
    const refereeName = document.getElementById('rcRefereeName').value.trim();
    const relationship = document.getElementById('rcRelationship').value.trim();
    const company = document.getElementById('rcCompany').value.trim();
    
    if (!candidateName || !position || !refereeName || !relationship || !company) {
        alert('Please fill in all required fields (marked with *)');
        return;
    }
    
    const phone = document.getElementById('rcPhone').value.trim();
    const startDate = document.getElementById('rcStartDate').value.trim();
    const endDate = document.getElementById('rcEndDate').value.trim();
    
    // Generate form content
    const formContent = `
    <div class="space-y-4 text-slate-200">
        <div class="text-center border-b border-slate-700 pb-4">
            <h3 class="text-2xl font-bold">EMPLOYMENT REFERENCE CHECK</h3>
            <p class="text-slate-400 mt-2">Confidential</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 bg-slate-800 p-4 rounded">
            <div><strong>Candidate:</strong> ${candidateName}</div>
            <div><strong>Position:</strong> ${position}</div>
            <div><strong>Referee:</strong> ${refereeName}</div>
            <div><strong>Relationship:</strong> ${relationship}</div>
            <div><strong>Company:</strong> ${company}</div>
            <div><strong>Phone:</strong> ${phone || 'N/A'}</div>
            <div><strong>Employment Period:</strong> ${startDate} - ${endDate}</div>
        </div>
        
        <div class="space-y-3">
            <h4 class="font-bold text-lg mt-6">Reference Check Questions:</h4>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>1. Can you confirm the candidate's employment dates and position?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>2. How would you rate their overall performance?</strong>
                <div class="mt-2 text-slate-400">‚òê Excellent  ‚òê Good  ‚òê Satisfactory  ‚òê Needs Improvement</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>3. What were their key strengths?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>4. Were there any areas for improvement?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>5. How did they handle pressure and busy periods?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>6. Were they reliable and punctual?</strong>
                <div class="mt-2 text-slate-400">‚òê Always  ‚òê Usually  ‚òê Sometimes  ‚òê Rarely</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>7. How did they work with team members and customers?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>8. Why did they leave?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>9. Would you re-employ them?</strong>
                <div class="mt-2 text-slate-400">‚òê Yes  ‚òê No  ‚òê Maybe</div>
            </div>
            
            <div class="bg-red-500/10 border border-red-500/30 p-3 rounded mt-4">
                <strong class="text-red-400">‚ö†Ô∏è RED FLAGS TO NOTE:</strong>
                <ul class="text-sm mt-2 space-y-1">
                    <li>‚Ä¢ Hesitation or vague answers</li>
                    <li>‚Ä¢ Contradictions with candidate's claims</li>
                    <li>‚Ä¢ Refusal to answer specific questions</li>
                    <li>‚Ä¢ Negative tone or body language</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-slate-700">
            <p class="text-sm text-slate-400">Completed by: _______________ Date: _______________</p>
            <p class="text-sm text-slate-400 mt-2">Signature: _______________</p>
        </div>
        
        <div class="bg-blue-500/10 border border-blue-500/30 p-3 rounded text-sm">
            <strong>Legal Compliance Note:</strong> This reference check complies with Australian privacy laws. 
            Information collected is confidential and used solely for employment assessment purposes.
        </div>
    </div>
    `;
    
    closeReferenceCheck();
    document.getElementById('rcPreviewContent').innerHTML = formContent;
    document.getElementById('referenceCheckPreviewModal').classList.remove('hidden');
    
    trackEvent('reference_check_generated', { candidateName: candidateName, position: position });
}

function closeReferenceCheckPreview() {
    document.getElementById('referenceCheckPreviewModal').classList.add('hidden');
}

function downloadReferenceCheck(format) {
    showToast('Preparing PDF download...', 'info');
    trackEvent('reference_check_downloaded', { format: format });
}


// Close upload menu when clicking outside
document.addEventListener('click', function(e) {
    const uploadBtn = document.getElementById('uploadButton');
    const uploadMenu = document.getElementById('uploadMenu');
    
    if (uploadMenu && !uploadMenu.classList.contains('hidden')) {
        if (!uploadBtn.contains(e.target) && !uploadMenu.contains(e.target)) {
            uploadMenu.classList.add('hidden');
        }
    }
});

// Trigger file upload by type
function triggerFileUpload(type) {
    // Close menu
    var menu = document.getElementById('uploadMenu');
    if (menu) menu.classList.add('hidden');
    
    // Trigger the appropriate hidden file input
    var inputId = type + 'UploadInput';
    var input = document.getElementById(inputId);
    if (input) {
        input.click();
    } else {
        console.error('File input not found:', inputId);
    }
}

// Handle file upload (documents)
async function handleFileUpload(event) {
    var file = event.target.files[0];
    if (!file) return;
    
    console.log('üìÅ Uploading file:', file.name);
    
    // Validate file size (10MB max)
    var maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('‚ùå File too large. Max 10MB', 'error', 3000);
        event.target.value = '';
        return;
    }
    
    // Detect file type
    var fileName = file.name.toLowerCase();
    var fileType = 'document';
    var icon = 'üìÑ';
    
    if (fileName.endsWith('.pdf')) {
        fileType = 'PDF';
        icon = 'üìÑ';
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
        fileType = 'Excel/CSV';
        icon = 'üìä';
    } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
        fileType = 'Word';
        icon = 'üìù';
    } else if (fileName.endsWith('.txt')) {
        fileType = 'Text';
        icon = 'üìÑ';
    }
    
    // Show uploading message
    showToast('üì§ Uploading ' + file.name + '...', 'info', 2000);
    
    try {
        var result = await readFileContent(file);
        
        if (result && result.success) {
            // Show file in chat
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var fileMsg = icon + ' Uploaded: ' + file.name + ' (' + size + ')';
            
            addMessage('user', fileMsg);
            conversationHistory.push({ role: 'user', content: fileMsg });
            saveCurrentConversation();
            
            // Pre-fill message input with file context
            var input = document.getElementById('messageInput');
            if (input && result.text) {
                var prompt = 'I uploaded "' + file.name + '". Please help me with this ' + fileType + ' document.\n\n';
                
                // Add preview of content
                var preview = result.text.substring(0, 400);
                if (result.text.length > 400) preview += '...';
                
                input.value = prompt + 'Content:\n' + preview;
                autoResizeTextarea(input);
                input.focus();
            }
            
            showToast('‚úÖ ' + file.name + ' uploaded!', 'success', 3000);
        } else {
            throw new Error('Processing failed');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showToast('‚ùå Error: ' + error.message, 'error', 4000);
    }
    
    // Reset input
    event.target.value = '';
}

// Handle image upload
async function handleImageUpload(event) {
    var file = event.target.files[0];
    if (!file) return;
    
    console.log('üñºÔ∏è Uploading image:', file.name);
    
    // Validate file size (5MB max for images)
    var maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('‚ùå Image too large. Max 5MB', 'error', 3000);
        event.target.value = '';
        return;
    }
    
    showToast('üì§ Uploading image...', 'info', 2000);
    
    try {
        var reader = new FileReader();
        
        reader.onload = function(e) {
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var imgMsg = 'üñºÔ∏è Uploaded image: ' + file.name + ' (' + size + ')';
            
            // Add to chat
            addMessage('user', imgMsg);
            conversationHistory.push({ role: 'user', content: imgMsg });
            saveCurrentConversation();
            
            // Pre-fill input
            var input = document.getElementById('messageInput');
            if (input) {
                input.value = 'I uploaded an image "' + file.name + '". Please describe what you see and provide relevant insights.';
                autoResizeTextarea(input);
                input.focus();
            }
            
            showToast('‚úÖ Image uploaded!', 'success', 3000);
        };
        
        reader.onerror = function() {
            showToast('‚ùå Failed to read image', 'error', 3000);
        };
        
        reader.readAsDataURL(file);
    } catch (error) {
        console.error('Image upload error:', error);
        showToast('‚ùå Error: ' + error.message, 'error', 4000);
    }
    
    // Reset input
    event.target.value = '';
}

// Read file content
async function readFileContent(file) {
    return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                var text = '';
                var fileInfo = 'File: ' + file.name + '\n';
                fileInfo += 'Size: ' + (file.size / 1024).toFixed(2) + ' KB\n\n';
                
                // Handle CSV files specially - read as text
                if (file.name.toLowerCase().endsWith('.csv')) {
                    var csvContent = e.target.result;
                    var lines = csvContent.split('\n');
                    text = fileInfo + 'CSV Data (first 20 rows):\n\n';
                    text += lines.slice(0, 20).join('\n');
                    if (lines.length > 20) {
                        text += '\n\n[' + (lines.length - 20) + ' more rows...]';
                    }
                } else if (file.name.toLowerCase().endsWith('.txt')) {
                    text = fileInfo + 'Text content:\n\n' + e.target.result;
                } else {
                    // For PDF, Word, Excel - just show metadata
                    text = fileInfo + 'Document uploaded and ready for analysis.\n';
                    text += 'Note: Full text extraction requires specialized libraries.';
                }
                
                resolve({
                    success: true,
                    text: text,
                    fileData: e.target.result
                });
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Failed to read file'));
        };
        
        // Read CSV and TXT as text, others as data URL
        if (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}


// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Create new chat from sidebar
function createNewChatFromSidebar() {
    createNewConversation();
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
}

// Sidebar search
function performSidebarSearch() {
    const query = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('sidebarSearchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    // Search through conversation history
    const results = conversationHistory_searchable.filter(conv => 
        conv.content.toLowerCase().includes(query)
    );
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-500 text-xs py-2">No results</p>';
        return;
    }
    
    resultsDiv.innerHTML = results.slice(0, 5).map(conv => {
        const preview = conv.content.substring(0, 60) + '...';
        return `<div class="text-xs text-slate-300 py-2 px-2 hover:bg-slate-700 rounded cursor-pointer">${preview}</div>`;
    }).join('');
}

// ========================================
// WEEK 3 PHASE 1: POWER USER FEATURES
// ========================================

// Bookmarks Storage
let conversationHistory_searchable = []; // Searchable version of conversations
let uploadedFiles = [];
let currentChart = null;

/**
 * Toggle Quick Actions Menu
 */
function toggleQuickActions() {
    const menu = document.getElementById('quickActionsMenu');
    menu.classList.toggle('show');
}

/**
 * Close quick actions when clicking outside
 */
document.addEventListener('click', (e) => {
    const quickActions = document.querySelector('.quick-actions-fab');
    const menu = document.getElementById('quickActionsMenu');
    if (quickActions && menu && !quickActions.contains(e.target)) {
        menu.classList.remove('show');
    }
});

// ===================
// SEARCH FUNCTIONALITY
// ===================

function openSearchModal() {
    document.getElementById('searchModal').classList.remove('hidden');
    document.getElementById('searchInput').focus();
    toggleQuickActions();
}

function closeSearchModal() {
    document.getElementById('searchModal').classList.add('hidden');
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '<p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>';
}

function performSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '<p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>';
        return;
    }
    
    // Search through conversation history
    const results = conversationHistory_searchable.filter(conv => 
        conv.content.toLowerCase().includes(query)
    );
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-400 text-center py-8">No results found</p>';
        return;
    }
    
    // Display results
    resultsDiv.innerHTML = results.map((conv, index) => {
        const highlighted = highlightSearchTerm(conv.content, query);
        return `
            <div class="search-result" onclick="jumpToMessage(${index})">
                <div class="flex items-start justify-between mb-2">
                    <span class="text-xs text-slate-500">${conv.role === 'user' ? 'üë§ You' : 'ü§ñ Fitz'}</span>
                    <span class="text-xs text-slate-500">${conv.timestamp || 'Recent'}</span>
                </div>
                <div class="text-sm text-slate-300">${highlighted}</div>
            </div>
        `;
    }).join('');
}

function highlightSearchTerm(text, query) {
    const maxLength = 200;
    const lowerText = text.toLowerCase();
    const index = lowerText.indexOf(query.toLowerCase());
    
    if (index === -1) return text.substring(0, maxLength) + '...';
    
    const start = Math.max(0, index - 50);
    const end = Math.min(text.length, index + query.length + 100);
    let snippet = text.substring(start, end);
    
    if (start > 0) snippet = '...' + snippet;
    if (end < text.length) snippet = snippet + '...';
    
    // Highlight the match
    const regex = new RegExp(`(${query})`, 'gi');
    snippet = snippet.replace(regex, '<span class="search-highlight">$1</span>');
    
    return snippet;
}

function jumpToMessage(index) {
    closeSearchModal();
    showToast('Feature coming soon: Jump to message', 'info');
}

// Update conversation history for search
function updateSearchableHistory() {
    conversationHistory_searchable = conversationHistory.map((conv, index) => ({
        ...conv,
        index: index,
        timestamp: new Date().toLocaleString()
    }));
}

// ===================
// MULTI-FILE UPLOAD
// ===================

function openMultiFileModal() {
    document.getElementById('multiFileModal').classList.remove('hidden');
    toggleQuickActions();
}

function closeMultiFileModal() {
    document.getElementById('multiFileModal').classList.add('hidden');
    uploadedFiles = [];
    document.getElementById('filesList').innerHTML = '';
    document.getElementById('processFilesBtn').disabled = true;
}

// Setup drag and drop
const dropZone = document.getElementById('dropZone');
if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('drag-over');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('drag-over');
        }, false);
    });
    
    dropZone.addEventListener('drop', handleDrop, false);
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleMultiFileSelect({ target: { files } });
}

function handleMultiFileSelect(event) {
    const files = Array.from(event.target.files);
    
    if (files.length > 10) {
        showToast('Maximum 10 files allowed', 'warning');
        return;
    }
    
    uploadedFiles = files.filter(file => {
        const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (!validTypes.includes(file.type)) {
            showToast(`${file.name}: Invalid file type`, 'error');
            return false;
        }
        
        if (file.size > maxSize) {
            showToast(`${file.name}: File too large (max 5MB)`, 'error');
            return false;
        }
        
        return true;
    });
    
    renderFilesList();
    document.getElementById('processFilesBtn').disabled = uploadedFiles.length === 0;
}

function renderFilesList() {
    const listDiv = document.getElementById('filesList');
    
    if (uploadedFiles.length === 0) {
        listDiv.innerHTML = '';
        return;
    }
    
    listDiv.innerHTML = `
        <div class="mb-4">
            <h3 class="text-white font-semibold mb-3">Selected Files (${uploadedFiles.length})</h3>
            ${uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="text-2xl">${getFileIcon(file.type)}</span>
                    <div class="flex-1">
                        <div class="text-white font-medium">${file.name}</div>
                        <div class="text-xs text-slate-400">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-400 hover:text-red-300 text-xl">√ó</button>
                </div>
            `).join('')}
        </div>
    `;
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    renderFilesList();
    document.getElementById('processFilesBtn').disabled = uploadedFiles.length === 0;
}

function getFileIcon(type) {
    if (type.includes('pdf')) return 'üìÑ';
    if (type.includes('word')) return 'üìù';
    if (type.includes('sheet')) return 'üìä';
    if (type.includes('csv')) return 'üìà';
    return 'üìÅ';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function processMultipleFiles() {
    showLoadingOverlay('filesList', 'Processing files...');
    
    try {
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showToast(`Successfully processed ${uploadedFiles.length} files!`, 'success');
        hideLoadingOverlay('filesList');
        
        setTimeout(() => {
            closeMultiFileModal();
        }, 1500);
        
    } catch (error) {
        hideLoadingOverlay('filesList');
        handleError(error, 'processMultipleFiles');
    }
}

// ===================
// ANALYTICS DASHBOARD
// ===================

function showAnalyticsDashboard() {
    document.getElementById('analyticsModal').classList.remove('hidden');
    renderUsageChart();
    toggleQuickActions();
}

function closeAnalyticsModal() {
    document.getElementById('analyticsModal').classList.add('hidden');
}

function switchChart(type) {
    // Update tab styles
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('text-purple-400', 'border-b-2', 'border-purple-400');
        tab.classList.add('text-slate-400');
    });
    
    const activeTab = document.querySelector(`[data-chart="${type}"]`);
    activeTab.classList.remove('text-slate-400');
    activeTab.classList.add('text-purple-400', 'border-b-2', 'border-purple-400');
    
    // Render appropriate chart
    if (type === 'usage') renderUsageChart();
    else if (type === 'tools') renderToolsChart();
    else if (type === 'engagement') renderEngagementChart();
}

function renderUsageChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Messages',
                data: [12, 19, 15, 25, 22, 30, 28],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                },
                x: {
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                }
            }
        }
    });
}

function renderToolsChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Award Wizard', 'Document Builder', 'Calculator', 'Roster', 'Compliance'],
            datasets: [{
                label: 'Uses',
                data: [45, 38, 32, 28, 22],
                backgroundColor: [
                    '#f59e0b',
                    '#3b82f6',
                    '#10b981',
                    '#8b5cf6',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                },
                x: {
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                }
            }
        }
    });
}

function renderEngagementChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Active Users', 'New Users', 'Returning Users'],
            datasets: [{
                data: [45, 30, 25],
                backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            }
        }
    });
}

function exportDetailedAnalytics() {
    showToast('Exporting analytics report...', 'info');
    
    setTimeout(() => {
        showToast('Report exported successfully!', 'success');
    }, 1500);
}

// ===================
// WEEK 2: LOADING STATES, TOASTS, & POLISH
// ===================

/**
 * Show a toast notification
 * @param {string} message - Message to display
 * @param {string} type - 'success', 'error', 'warning', or 'info'
 * @param {number} duration - How long to show (ms), default 4000
 */
function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };
    
    toast.className = `toast toast-${type} toast-enter`;
    toast.innerHTML = `
        <span style="font-size: 20px; flex-shrink: 0;">${icons[type]}</span>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div style="font-size: 14px; opacity: 0.9;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="font-size: 20px; opacity: 0.6; hover:opacity: 1; background: none; border: none; padding: 0; cursor: pointer;">√ó</button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after duration
    setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

/**
 * Show loading skeleton for chat message
 * @returns {HTMLElement} - The skeleton element
 */
function showChatSkeleton() {
    const container = document.getElementById('messagesContainer');
    const skeleton = document.createElement('div');
    skeleton.className = 'bg-slate-700 rounded-xl p-6 mb-4 fade-in skeleton-message';
    skeleton.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="skeleton w-8 h-8 rounded-full"></div>
            <div class="flex-1 space-y-2">
                <div class="skeleton h-4 w-3/4"></div>
                <div class="skeleton h-4 w-full"></div>
                <div class="skeleton h-4 w-5/6"></div>
            </div>
        </div>
    `;
    container.appendChild(skeleton);
    container.scrollTop = container.scrollHeight;
    return skeleton;
}

/**
 * Remove chat skeleton
 * @param {HTMLElement} skeleton - The skeleton element to remove
 */
function removeChatSkeleton(skeleton) {
    if (skeleton && skeleton.parentNode) {
        skeleton.style.opacity = '0';
        skeleton.style.transition = 'opacity 0.3s';
        setTimeout(() => skeleton.remove(), 300);
    }
}

/**
 * Show loading overlay on an element
 * @param {string} elementId - ID of element to show overlay on
 * @param {string} message - Loading message
 */
function showLoadingOverlay(elementId, message = 'Loading...') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.id = `${elementId}-overlay`;
    overlay.innerHTML = `
        <div class="text-center">
            <div class="spinner inline-block w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full mb-4"></div>
            <div class="text-white font-medium">${message}</div>
        </div>
    `;
    element.style.position = 'relative';
    element.appendChild(overlay);
}

/**
 * Hide loading overlay
 * @param {string} elementId - ID of element with overlay
 */
function hideLoadingOverlay(elementId) {
    const overlay = document.getElementById(`${elementId}-overlay`);
    if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 300);
    }
}

/**
 * Enhanced error handler with user-friendly messages
 * @param {Error} error - The error object
 * @param {string} context - Context of where error occurred
 */
function handleError(error, context = '') {
    console.error(`Error in ${context}:`, error);
    
    let userMessage = 'Something went wrong. Please try again.';
    
    // Provide specific messages for common errors
    if (error.message.includes('network') || error.message.includes('fetch')) {
        userMessage = 'Network error. Please check your internet connection.';
    } else if (error.message.includes('timeout')) {
        userMessage = 'Request timed out. Please try again.';
    } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
        userMessage = 'Session expired. Please refresh the page and log in again.';
    } else if (error.message.includes('404')) {
        userMessage = 'Resource not found. Please refresh the page.';
    } else if (error.message.includes('500')) {
        userMessage = 'Server error. Our team has been notified. Please try again later.';
    }
    
    showToast(userMessage, 'error', 6000);
    
    // Track error for analytics
    trackEvent('error_occurred', {
        context: context,
        error: error.message,
        user: currentUser
    });
}

/**
 * Add smooth scroll to element
 * @param {string} elementId - ID of element to scroll to
 */
function smoothScrollTo(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

/**
 * Debounce function for performance
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in ms
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Check if element is in viewport (for lazy loading)
 * @param {HTMLElement} element - Element to check
 */
function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

/**
 * Add keyboard navigation support
 */
function initKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        // Escape to close modals
        if (e.key === 'Escape') {
            // Close tools modal if open
            const mobileToolsModal = document.getElementById('mobileToolsModal');
            if (mobileToolsModal && !mobileToolsModal.classList.contains('hidden')) {
                closeMobileTools();
            }
            
            // Close admin dashboard if open
            const adminModal = document.getElementById('adminDashboardModal');
            if (adminModal && !adminModal.classList.contains('hidden')) {
                closeAdminDashboard();
            }
        }
        
        // Ctrl/Cmd + K to focus search/input
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.focus();
            }
        }
    });
}

/**
 * Preload critical modals for better performance
 */
function preloadModals() {
    // Preload modal content that might be used frequently
    const criticalModals = ['documentBuilderModal', 'awardCalculatorModal'];
    criticalModals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Force browser to parse the modal HTML
            modal.offsetHeight;
        }
    });
}

/**
 * Add visual feedback when copying text
 * @param {string} text - Text that was copied
 */
function showCopyFeedback(text) {
    showToast('Copied to clipboard!', 'success', 2000);
}

/**
 * Validate form with visual feedback
 * @param {string} formId - ID of form to validate
 * @returns {boolean} - Whether form is valid
 */
function validateForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return false;
    
    let isValid = true;
    const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('border-red-500');
            input.classList.remove('border-slate-600');
            isValid = false;
            
            // Remove error state on input
            input.addEventListener('input', function() {
                this.classList.remove('border-red-500');
                this.classList.add('border-slate-600');
            }, { once: true });
        }
    });
    
    if (!isValid) {
        showToast('Please fill in all required fields', 'warning');
    }
    
    return isValid;
}

// ========================================
// TOOLS MENU
// ========================================
/**
 * Toggles visibility of the tools menu dropdown (desktop) or modal (mobile)
 * @returns {void}
 */
function toggleToolsMenu() {
    // Check if mobile (768px or less)
    if (window.innerWidth <= 768) {
        // Show mobile modal instead
        document.getElementById('mobileToolsModal').classList.remove('hidden');
    } else {
        // Show desktop dropdown
        DOM.toolsMenu.classList.toggle('hidden');
    }
}

/**
 * Closes the mobile tools modal
 * @returns {void}
 */
function closeMobileTools() {
    document.getElementById('mobileToolsModal').classList.add('hidden');
}

/**
 * Opens a tool from the mobile modal
 * @param {string} toolName - Name of tool to open
 * @returns {void}
 */
function openToolFromMobile(toolName) {
    closeMobileTools();
    openTool(toolName);
}

/**
 * Opens a specific tool modal and tracks the event
 * @param {string} toolName - Name of tool to open (e.g., 'awardCalculator')
 * @returns {void}
 */
function openTool(toolName) {
    // Close desktop dropdown only if on desktop
    if (window.innerWidth > 768) {
        DOM.toolsMenu.classList.add('hidden');
    }
    
    const modalMap = {
        'awardCalculator': 'awardCalculatorModal',
        'rosterOptimizer': 'rosterOptimizerModal',
        'terminationRisk': 'terminationRiskModal',
        'scenarioAnalysis': 'scenarioAnalysisModal',
        'xeroIntegration': 'xeroIntegrationModal',
        'awardWizard': 'awardWizardModal',
        'rosterStressTester': 'rosterStressTesterModal',
        'complianceCalendar': 'complianceCalendarModal',
	'documentBuilder': 'documentBuilderModal'
    };
    const modalId = modalMap[toolName];
    if (modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        trackEvent('tool_opened', { tool: toolName, user: currentUser });
    }
}

function closeToolModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    
    // Special handling for Document Builder - reset it silently when closed
    if (modalId === 'documentBuilderModal') {
        resetDocumentBuilderSilent();
    }
}

// ========================================
// VENUE ONBOARDING & PROFILE SYSTEM
// ========================================

function checkOnboardingStatus() {
    const saved = localStorage.getItem('venueProfile_' + currentUser);
    if (saved) {
        venueProfile = JSON.parse(saved);
        return venueProfile.setupComplete;
    }
    return false;
}

function showOnboarding() {
    document.getElementById('venueOnboardingModal').classList.remove('hidden');
    updateOnboardingStep();
}

function saveOnboardingAnswer(field, value, isLastStep = false) {
    venueProfile[field] = value;
    if (isLastStep) {
        completeOnboarding();
    } else {
        onboardingCurrentStep++;
        updateOnboardingStep();
    }
}

function saveOnboardingNameAndVenue() {
    const userName = document.getElementById('onboardingUserName').value.trim();
    const venueName = document.getElementById('onboardingVenueName').value.trim();
    
    if (!userName) {
        alert('Please enter your name');
        return;
    }
    
    if (!venueName) {
        alert('Please enter your venue name');
        return;
    }
    
    venueProfile.userName = userName;
    venueProfile.venueName = venueName;
    onboardingCurrentStep++;
    updateOnboardingStep();
}

function saveOnboardingLocation() {
    const location = document.getElementById('onboardingLocation').value;
    const city = document.getElementById('onboardingCity').value.trim();
    if (!location) {
        alert('Please select a state');
        return;
    }
    venueProfile.location = location;
    venueProfile.city = city || '';
    onboardingCurrentStep++;
    updateOnboardingStep();
}

function updateOnboardingStep() {
    document.querySelectorAll('.onboarding-step').forEach(step => step.classList.add('hidden'));
    const current = document.querySelector(`[data-step="${onboardingCurrentStep}"]`);
    if (current) current.classList.remove('hidden');
    
    document.getElementById('onboardingStep').textContent = onboardingCurrentStep;
    const progress = Math.round((onboardingCurrentStep / ONBOARDING_STEPS) * 100);
    document.getElementById('onboardingProgress').textContent = `${progress}% Complete`;
    document.getElementById('onboardingProgressBar').style.width = `${progress}%`;
}

function completeOnboarding() {
    venueProfile.setupComplete = true;
    venueProfile.setupDate = new Date().toISOString();
    localStorage.setItem('venueProfile_' + currentUser, JSON.stringify(venueProfile));
    
    document.getElementById('venueOnboardingModal').classList.add('hidden');
    
    const venueType = getVenueTypeLabel(venueProfile.venueType);
    addMessage('assistant', `‚úÖ **Great! I've got your venue details saved.**

I now know you run a **${venueType}** in **${venueProfile.city || venueProfile.location}** with **${venueProfile.staffCount}** staff.

All my advice will be tailored for your venue. Update these anytime in ‚öôÔ∏è Settings.

What can I help you with?`);
    
    trackEvent('onboarding_completed', venueProfile);
}

function skipOnboarding() {
    if (confirm('Skip onboarding? You can complete it later in Settings.')) {
        document.getElementById('venueOnboardingModal').classList.add('hidden');
        addMessage('assistant', 'No problem! Set up your venue profile anytime in ‚öôÔ∏è Settings. What can I help you with?');
    }
}

function getVenueTypeLabel(type) {
    const labels = { 
        restaurant: 'restaurant', 
        cafe: 'caf√©', 
        hotel: 'hotel/pub', 
        fastfood: 'fast food venue', 
        club: 'club/bar', 
        other: 'hospitality venue' 
    };
    return labels[type] || type;
}

function showVenueSettings() {
    const modal = document.getElementById('venueSettingsModal');
    const content = document.getElementById('venueSettingsContent');
    
    content.innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-slate-300 text-sm mb-2">Your Name</label>
                <input type="text" id="settingsUserName" value="${venueProfile.userName || ''}" 
                       placeholder="e.g., Sarah Johnson"
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Venue Name</label>
                <input type="text" id="settingsVenueName" value="${venueProfile.venueName || ''}" 
                       placeholder="e.g., The Golden Fork"
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Venue Type</label>
                <select id="settingsVenueType" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    <option value="restaurant" ${venueProfile.venueType === 'restaurant' ? 'selected' : ''}>Restaurant</option>
                    <option value="cafe" ${venueProfile.venueType === 'cafe' ? 'selected' : ''}>Caf√©</option>
                    <option value="hotel" ${venueProfile.venueType === 'hotel' ? 'selected' : ''}>Hotel/Pub</option>
                    <option value="fastfood" ${venueProfile.venueType === 'fastfood' ? 'selected' : ''}>Fast Food</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">State</label>
                    <select id="settingsLocation" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        <option value="NSW" ${venueProfile.location === 'NSW' ? 'selected' : ''}>NSW</option>
                        <option value="VIC" ${venueProfile.location === 'VIC' ? 'selected' : ''}>VIC</option>
                        <option value="QLD" ${venueProfile.location === 'QLD' ? 'selected' : ''}>QLD</option>
                        <option value="SA" ${venueProfile.location === 'SA' ? 'selected' : ''}>SA</option>
                        <option value="WA" ${venueProfile.location === 'WA' ? 'selected' : ''}>WA</option>
                        <option value="TAS" ${venueProfile.location === 'TAS' ? 'selected' : ''}>TAS</option>
                        <option value="NT" ${venueProfile.location === 'NT' ? 'selected' : ''}>NT</option>
                        <option value="ACT" ${venueProfile.location === 'ACT' ? 'selected' : ''}>ACT</option>
                    </select>
                </div>
                <div>
                    <label class="block text-slate-300 text-sm mb-2">City/Suburb</label>
                    <input type="text" id="settingsCity" value="${venueProfile.city || ''}" 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                </div>
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Staff Count</label>
                <select id="settingsStaffCount" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    <option value="1-5" ${venueProfile.staffCount === '1-5' ? 'selected' : ''}>1-5 staff</option>
                    <option value="6-15" ${venueProfile.staffCount === '6-15' ? 'selected' : ''}>6-15 staff</option>
                    <option value="16-30" ${venueProfile.staffCount === '16-30' ? 'selected' : ''}>16-30 staff</option>
                    <option value="30+" ${venueProfile.staffCount === '30+' ? 'selected' : ''}>30+ staff</option>
                </select>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function saveVenueSettings() {
    venueProfile.userName = document.getElementById('settingsUserName').value.trim();
    venueProfile.venueName = document.getElementById('settingsVenueName').value.trim();
    venueProfile.venueType = document.getElementById('settingsVenueType').value;
    venueProfile.location = document.getElementById('settingsLocation').value;
    venueProfile.city = document.getElementById('settingsCity').value.trim();
    venueProfile.staffCount = document.getElementById('settingsStaffCount').value;
    
    localStorage.setItem('venueProfile_' + currentUser, JSON.stringify(venueProfile));
    
    // Update sidebar venue name
    updateSidebarVenueName();
    
    closeVenueSettings();
    alert('‚úÖ Venue settings saved!');
}

function closeVenueSettings() {

    document.getElementById('venueSettingsModal').classList.add('hidden');
}

// ========================================
// ADMIN ANALYTICS SYSTEM
// ========================================

async function trackConversation(userMessage, assistantResponse) {
    const conversation = {
        timestamp: new Date().toISOString(),
        user_code: currentUser,
        user_message: userMessage,
        assistant_response: assistantResponse,
        theme: detectTheme(userMessage),
        is_high_risk: detectHighRiskTopic(userMessage) !== null,
        venue_type: venueProfile.setupComplete ? venueProfile.venueType : null,
        venue_location: venueProfile.setupComplete ? venueProfile.location : null,
        venue_staff_count: venueProfile.setupComplete ? venueProfile.staffCount : null
    };
    
    // 1. Save to localStorage as backup
    const stored = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    stored.push(conversation);
    localStorage.setItem('analytics_conversations', JSON.stringify(stored));
    
    // 2. Save to Supabase (centralized database)
    if (supabaseClient) {
        try {
            const { data, error } = await supabaseClient
                .from('conversations')
                .insert([conversation]);
            
            if (error) {
                console.error('‚ùå Supabase save error:', error);
            } else {
                console.log('‚úÖ Conversation saved to Supabase');
            }
        } catch (err) {
            console.error('‚ùå Failed to save to Supabase:', err);
        }
    } else {
        console.warn('‚ö†Ô∏è Supabase not initialized - conversation only saved locally');
    }
    
    // 3. Update theme counts
    updateThemeCount(conversation.theme);
    
    // 4. Track high-risk if applicable
    if (conversation.is_high_risk) {
        trackHighRiskTopic(userMessage);
    }
    
    // 5. Update user profile
    updateUserProfile(currentUser, userMessage);
}

function detectTheme(message) {
    const lowerMessage = message.toLowerCase();
    
    const themes = {
        'Award Rates & Pay': ['award rate', 'pay rate', 'wage', 'salary', 'how much', 'penalty rate', 'overtime', 'casual loading'],
        'Rostering & Hours': ['roster', 'schedule', 'shift', 'hours', 'break', 'rest day', 'overtime'],
        'Termination & Dismissal': ['terminate', 'fire', 'dismiss', 'sack', 'let go', 'redundancy'],
        'Performance Management': ['performance', 'pip', 'warning', 'underperform', 'improvement'],
        'Recruitment & Hiring': ['hire', 'recruit', 'interview', 'job ad', 'onboard', 'new employee'],
        'Leave & Entitlements': ['annual leave', 'sick leave', 'personal leave', 'long service', 'parental leave'],
        'Workplace Issues': ['complaint', 'harassment', 'bullying', 'discrimination', 'conflict'],
        'Contracts & Agreements': ['contract', 'employment agreement', 'casual conversion', 'fixed term'],
        'Compliance & Legal': ['fair work', 'compliance', 'legal', 'lawsuit', 'claim', 'ombudsman'],
        'General HR Advice': []
    };
    
    for (const [theme, keywords] of Object.entries(themes)) {
        if (keywords.some(keyword => lowerMessage.includes(keyword))) {
            return theme;
        }
    }
    
    return 'General HR Advice';
}

async function updateThemeCount(theme) {
    // Update localStorage
    const stored = JSON.parse(localStorage.getItem('analytics_themes') || '{}');
    stored[theme] = (stored[theme] || 0) + 1;
    localStorage.setItem('analytics_themes', JSON.stringify(stored));
    
    // Update Supabase
    if (supabaseClient) {
        try {
            // Try to increment existing record
            const { data: existing } = await supabaseClient
                .from('themes')
                .select('count')
                .eq('theme', theme)
                .single();
            
            if (existing) {
                // Update existing
                await supabaseClient
                    .from('themes')
                    .update({ 
                        count: existing.count + 1,
                        last_updated: new Date().toISOString()
                    })
                    .eq('theme', theme);
            } else {
                // Insert new
                await supabaseClient
                    .from('themes')
                    .insert([{ theme: theme, count: 1 }]);
            }
        } catch (err) {
            console.error('Error updating theme count:', err);
        }
    }
}

async function trackHighRiskTopic(message) {
    const risk = detectHighRiskTopic(message);
    if (!risk) return;
    
    const highRiskEntry = {
        timestamp: new Date().toISOString(),
        user_code: currentUser,
        category: risk.category,
        title: risk.title,
        severity: risk.severity,
        message_preview: message.substring(0, 200)
    };
    
    // Save to localStorage
    const stored = JSON.parse(localStorage.getItem('analytics_highrisk') || '[]');
    stored.push(highRiskEntry);
    localStorage.setItem('analytics_highrisk', JSON.stringify(stored));
    
    // Save to Supabase
    if (supabaseClient) {
        try {
            await supabaseClient
                .from('high_risk_topics')
                .insert([highRiskEntry]);
            console.log('‚úÖ High-risk topic saved to Supabase');
        } catch (err) {
            console.error('Error saving high-risk topic:', err);
        }
    }
}

async function updateUserProfile(user, message) {
    // Update localStorage
    const profiles = JSON.parse(localStorage.getItem('analytics_users') || '{}');
    
    if (!profiles[user]) {
        profiles[user] = {
            first_seen: new Date().toISOString(),
            message_count: 0,
            last_active: null,
            venue: venueProfile.setupComplete ? venueProfile : null,
            topThemes: {}
        };
    }
    
    profiles[user].message_count++;
    profiles[user].last_active = new Date().toISOString();
    
    const theme = detectTheme(message);
    profiles[user].topThemes[theme] = (profiles[user].topThemes[theme] || 0) + 1;
    
    localStorage.setItem('analytics_users', JSON.stringify(profiles));
    
    // Update Supabase
    if (supabaseClient) {
        try {
            const { data: existing } = await supabaseClient
                .from('user_profiles')
                .select('message_count')
                .eq('user_code', user)
                .single();
            
            if (existing) {
                // Update existing profile
                await supabaseClient
                    .from('user_profiles')
                    .update({ 
                        message_count: existing.message_count + 1,
                        last_active: new Date().toISOString(),
                        venue_name: venueProfile.venueName || null,
                        venue_type: venueProfile.venueType || null,
                        venue_location: venueProfile.location || null,
                        venue_city: venueProfile.city || null,
                        staff_count: venueProfile.staffCount || null
                    })
                    .eq('user_code', user);
            } else {
                // Insert new profile
                await supabaseClient
                    .from('user_profiles')
                    .insert([{
                        user_code: user,
                        message_count: 1,
                        venue_name: venueProfile.venueName || null,
                        venue_type: venueProfile.venueType || null,
                        venue_location: venueProfile.location || null,
                        venue_city: venueProfile.city || null,
                        staff_count: venueProfile.staffCount || null
                    }]);
            }
        } catch (err) {
            console.error('Error updating user profile:', err);
        }
    }
}

function showAdminDashboard() {
    document.getElementById('adminDashboardModal').classList.remove('hidden');
    loadAnalytics();
}

function closeAdminDashboard() {
    document.getElementById('adminDashboardModal').classList.add('hidden');
}

async function loadAnalytics() {
    if (!supabaseClient) {
        alert('‚ö†Ô∏è Database not connected. Check console for errors.');
        return;
    }
    
    try {
        // Load total counts from Supabase
        const { count: convCount } = await supabaseClient
            .from('conversations')
            .select('*', { count: 'exact', head: true });
        
        const { count: userCount } = await supabaseClient
            .from('user_profiles')
            .select('*', { count: 'exact', head: true });
        
        // Get today's activity
        const today = new Date().toISOString().split('T')[0];
        const { count: todayCount } = await supabaseClient
            .from('conversations')
            .select('*', { count: 'exact', head: true })
            .gte('timestamp', today);
        
        // Update stats
        document.getElementById('statTotalUsers').textContent = userCount || 0;
        document.getElementById('statTotalMessages').textContent = convCount || 0;
        document.getElementById('statActiveToday').textContent = todayCount || 0;
        document.getElementById('statAvgSession').textContent = '5m'; // Simplified
        
        // Load conversations tab by default
        switchAdminTab('conversations');
    } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Error loading analytics. Check console.');
    }
}

function switchAdminTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.admin-tab').forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.add('text-purple-400', 'border-b-2', 'border-purple-400', 'font-semibold');
            btn.classList.remove('text-slate-400');
        } else {
            btn.classList.remove('text-purple-400', 'border-b-2', 'border-purple-400', 'font-semibold');
            btn.classList.add('text-slate-400');
        }
    });
    
    // Hide all content
    document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected content
    const contentMap = {
        'conversations': 'adminConversationsTab',
        'themes': 'adminThemesTab',
        'users': 'adminUsersTab',
        'highrisk': 'adminHighRiskTab',
	'documents': 'adminDocumentsTab'
    };
    
    document.getElementById(contentMap[tabName]).classList.remove('hidden');
    
    // Load data for selected tab
    if (tabName === 'conversations') loadConversations();
    if (tabName === 'themes') loadThemes();
    if (tabName === 'users') loadUsers();
    if (tabName === 'highrisk') loadHighRisk();
    if (tabName === 'documents') loadDocuments();
}

async function loadConversations() {
    const list = document.getElementById('conversationsList');
    
    // Show loading state
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading conversations...</div>';
    
    if (!supabaseClient) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Database not connected</div>';
        return;
    }
    
    try {
        // Fetch from Supabase
        const { data: conversations, error } = await supabaseClient
            .from('conversations')
            .select('*')
            .order('timestamp', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        if (!conversations || conversations.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No conversations yet</div>';
            return;
        }
        
        let html = '';
        conversations.forEach(conv => {
            const date = new Date(conv.timestamp).toLocaleString('en-AU');
            const riskBadge = conv.is_high_risk ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">HIGH RISK</span>' : '';
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-purple-500 transition-all">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-purple-400 font-semibold">${conv.user_code}</span>
                            <span class="text-slate-500 text-xs ml-2">${date}</span>
                            ${riskBadge}
                        </div>
                        <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">${conv.theme || 'N/A'}</span>
                    </div>
                    <div class="text-sm">
                        <p class="text-slate-300 mb-2"><strong>User:</strong> ${conv.user_message}</p>
                        <p class="text-slate-400 text-xs"><strong>Response:</strong> ${conv.assistant_response.substring(0, 150)}...</p>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        console.error('Error loading conversations:', error);
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadThemes() {
    const list = document.getElementById('themesList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading themes...</div>';
    
    if (!supabaseClient) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Database not connected</div>';
        return;
    }
    
    try {
        const { data: themes, error } = await supabaseClient
            .from('themes')
            .select('*')
            .order('count', { ascending: false });
        
        if (error) throw error;
        
        if (!themes || themes.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No themes tracked yet</div>';
            return;
        }
        
        const totalCount = themes.reduce((sum, t) => sum + t.count, 0);
        
        let html = '';
        themes.forEach(themeData => {
            const percentage = ((themeData.count / totalCount) * 100).toFixed(1);
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-purple-400 font-semibold">${themeData.theme}</span>
                        <span class="text-2xl font-bold text-purple-400">${themeData.count}</span>
                    </div>
                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">${percentage}% of all queries</p>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        console.error('Error loading themes:', error);
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadUsers() {
    const list = document.getElementById('usersList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading users...</div>';
    
    if (!supabaseClient) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Database not connected</div>';
        return;
    }
    
    try {
        const { data: users, error } = await supabaseClient
            .from('user_profiles')
            .select('*')
            .order('last_active', { ascending: false });
        
        if (error) throw error;
        
        if (!users || users.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No users yet</div>';
            return;
        }
        
        let html = '';
        users.forEach(profile => {
            const venueInfo = profile.venue_type 
                ? `${profile.venue_type} in ${profile.venue_location}` 
                : 'No venue info';
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="text-purple-400 font-semibold">${profile.user_code}</p>
                            <p class="text-xs text-slate-400">${venueInfo}</p>
                        </div>
                        <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">${profile.message_count} messages</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <p class="text-slate-500">First seen:</p>
                            <p class="text-slate-300">${new Date(profile.first_seen).toLocaleDateString('en-AU')}</p>
                        </div>
                        <div>
                            <p class="text-slate-500">Last active:</p>
                            <p class="text-slate-300">${new Date(profile.last_active).toLocaleDateString('en-AU')}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        console.error('Error loading users:', error);
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadHighRisk() {
    const list = document.getElementById('highRiskList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading high-risk topics...</div>';
    
    if (!supabaseClient) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Database not connected</div>';
        return;
    }
    
    try {
        const { data: highRisk, error } = await supabaseClient
            .from('high_risk_topics')
            .select('*')
            .order('timestamp', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        if (!highRisk || highRisk.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No high-risk topics detected</div>';
            return;
        }
        
        let html = '';
        highRisk.forEach(risk => {
            const date = new Date(risk.timestamp).toLocaleString('en-AU');
            const colorMap = { critical: 'red', high: 'yellow', medium: 'blue' };
            const color = colorMap[risk.severity] || 'gray';
            
            html += `
                <div class="bg-slate-900 border-2 border-${color}-500 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-${color}-400 font-semibold">${risk.title}</span>
                            <span class="text-slate-500 text-xs ml-2">${date}</span>
                        </div>
                        <span class="text-xs bg-${color}-500 text-white px-2 py-1 rounded uppercase">${risk.severity}</span>
                    </div>
                    <p class="text-slate-400 text-xs mb-2"><strong>User:</strong> ${risk.user_code}</p>
                    <p class="text-slate-300 text-sm">${risk.message_preview}</p>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        console.error('Error loading high-risk topics:', error);
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadDocuments() {
    const list = document.getElementById('documentsList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading documents...</div>';
    
    if (!supabaseClient) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Database not connected</div>';
        return;
    }
    
    try {
        const { data: documents, error } = await supabaseClient
            .from('generated_documents')
            .select('*')
            .order('generated_at', { ascending: false })
            .limit(100);
        
        if (error) throw error;
        
        if (!documents || documents.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No documents generated yet</div>';
            return;
        }
        
        console.log('üìä Documents loaded:', documents.length);
        console.log('üìä Sample document:', documents[0]);
        
        // ‚úÖ Calculate stats with FORMAT breakdown
        const totalGenerated = documents.length;
        const totalDownloaded = documents.filter(d => d.downloaded === true).length;
        const totalPDF = documents.filter(d => d.format === 'pdf').length;
        const totalWord = documents.filter(d => d.format === 'docx').length;
        const totalWarnings = documents.filter(d => d.document_type === 'formalWarning').length;
        const totalInvestigations = documents.filter(d => d.document_type === 'letterOfAllegation').length;
        const totalRecords = documents.filter(d => d.document_type === 'recordOfDiscussion').length;
        const totalPIPs = documents.filter(d => d.document_type === 'performanceImprovementPlan').length;
        
        console.log('üìä Stats:', {
            total: totalGenerated,
            downloaded: totalDownloaded,
            pdf: totalPDF,
            word: totalWord,
            warnings: totalWarnings,
            investigations: totalInvestigations,
            records: totalRecords,
            pips: totalPIPs
        });
        
        let html = '<div class="space-y-6">';
        
        // ‚úÖ Updated stats summary with FORMAT breakdown
        html += `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Total Generated</p>
                    <p class="text-3xl font-bold text-purple-400">${totalGenerated}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Downloaded</p>
                    <p class="text-3xl font-bold text-green-400">${totalDownloaded}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">üìÑ PDF</p>
                    <p class="text-3xl font-bold text-red-400">${totalPDF}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">üìù Word</p>
                    <p class="text-3xl font-bold text-blue-400">${totalWord}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Warnings</p>
                    <p class="text-3xl font-bold text-yellow-400">${totalWarnings}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Investigations</p>
                    <p class="text-3xl font-bold text-red-400">${totalInvestigations}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Records</p>
                    <p class="text-3xl font-bold text-green-400">${totalRecords}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">PIPs</p>
                    <p class="text-3xl font-bold text-blue-400">${totalPIPs}</p>
                </div>
            </div>
        `;
        
        // Document type mapping
        const typeEmoji = {
            formalWarning: '‚ö†Ô∏è',
            recordOfDiscussion: 'üìã',
            performanceImprovementPlan: 'üìä',
            letterOfAllegation: 'üîç'
        };

        const typeName = {
            formalWarning: 'Formal Warning',
            recordOfDiscussion: 'Record of Discussion',
            performanceImprovementPlan: 'Performance Improvement Plan',
            letterOfAllegation: 'Letter of Allegation'
        };

        const typeColor = {
            formalWarning: 'yellow',
            recordOfDiscussion: 'green',
            performanceImprovementPlan: 'blue',
            letterOfAllegation: 'red'
        };
        
        // ‚úÖ Format badge mapping
        const formatBadge = {
            'pdf': '<span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">üìÑ PDF</span>',
            'docx': '<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">üìù Word</span>',
            null: '<span class="text-xs bg-slate-700 text-slate-400 px-2 py-1 rounded">Not downloaded</span>'
        };
        
        // Document list with FORMAT badges
        documents.forEach(doc => {
            const date = new Date(doc.generated_at).toLocaleString('en-AU');
            const emoji = typeEmoji[doc.document_type] || 'üìÑ';
            const name = typeName[doc.document_type] || doc.document_type || 'Unknown Document';
            const color = typeColor[doc.document_type] || 'blue';
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-${color}-500 transition-all">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${emoji}</span>
                            <div>
                                <p class="text-${color}-400 font-semibold">${name}</p>
                                <p class="text-slate-500 text-xs">${date}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">${doc.user_code || 'Unknown User'}</span>
                            ${doc.downloaded ? 
                                `<div class="flex gap-1">
                                    <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">‚úì Downloaded</span>
                                    ${formatBadge[doc.format] || ''}
                                 </div>` : 
                                '<span class="text-xs bg-slate-700 text-slate-400 px-2 py-1 rounded">Not downloaded</span>'}
                        </div>
                    </div>
                    <div class="text-sm">
                        <p class="text-slate-300"><strong>Employee:</strong> ${doc.employee_name || 'N/A'}</p>
                        ${doc.venue_name ? `<p class="text-slate-400 text-xs mt-1">Venue: ${doc.venue_name}</p>` : ''}
                        <p class="text-slate-500 text-xs mt-2">Document ID: ${doc.document_id || 'N/A'}</p>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        list.innerHTML = html;
    } catch (error) {
        console.error('Error loading documents:', error);
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

function filterConversations() {
    const search = document.getElementById('conversationSearch').value.toLowerCase();
    const conversations = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    
    const filtered = conversations.filter(conv => 
        conv.userMessage.toLowerCase().includes(search) ||
        conv.assistantResponse.toLowerCase().includes(search) ||
        conv.theme.toLowerCase().includes(search)
    );
    
    const list = document.getElementById('conversationsList');
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No matches found</div>';
        return;
    }
    
    let html = '';
    filtered.reverse().forEach(conv => {
        const date = new Date(conv.timestamp).toLocaleString('en-AU');
        const riskBadge = conv.isHighRisk ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">HIGH RISK</span>' : '';
        
        html += `
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-purple-500 transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div>
                        <span class="text-purple-400 font-semibold">${conv.user}</span>
                        <span class="text-slate-500 text-xs ml-2">${date}</span>
                        ${riskBadge}
                    </div>
                    <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">${conv.theme}</span>
                </div>
                <div class="text-sm">
                    <p class="text-slate-300 mb-2"><strong>User:</strong> ${conv.userMessage}</p>
                    <p class="text-slate-400 text-xs"><strong>Response:</strong> ${conv.assistantResponse.substring(0, 150)}...</p>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function refreshAnalytics() {
    loadAnalytics();
    alert('‚úÖ Analytics refreshed!');
}

function exportAnalytics() {
    const conversations = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    const themes = JSON.parse(localStorage.getItem('analytics_themes') || '{}');
    const users = JSON.parse(localStorage.getItem('analytics_users') || '{}');
    
    // Prepare data for Excel
    const data = conversations.map(conv => ({
        'Timestamp': new Date(conv.timestamp).toLocaleString('en-AU'),
        'User': conv.user,
        'Theme': conv.theme,
        'High Risk': conv.isHighRisk ? 'YES' : 'NO',
        'User Message': conv.userMessage,
        'Assistant Response': conv.assistantResponse.substring(0, 500)
    }));
    
    generateExcelSpreadsheet(data, `Analytics_Export_${Date.now()}.xlsx`, 'Conversations');
    
    alert('‚úÖ Analytics exported to Excel!');
}

function getVenueContext() {
    if (!venueProfile.setupComplete) return '';
    const venueName = venueProfile.venueName ? `"${venueProfile.venueName}" - a ` : '';
    return `\nVENUE CONTEXT: ${venueName}${getVenueTypeLabel(venueProfile.venueType)} in ${venueProfile.city || ''} ${venueProfile.location}, ${venueProfile.staffCount} staff, Award: ${venueProfile.primaryAward}\n`;
}

// ========================================
// AWARD CALCULATOR
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const calcPosition = document.getElementById('calcPosition');
    if (calcPosition) {
        calcPosition.addEventListener('change', function() {
            const customDiv = document.getElementById('customRateDiv');
            if (this.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });
    }
});

/**
 * Calculates award pay including penalties, loadings, and overtime
 * Displays detailed breakdown in the calculator modal
 * @returns {void}
 */
function calculateAward() {
    let baseRate = parseFloat(document.getElementById('calcPosition').value);
    if (document.getElementById('calcPosition').value === 'custom') {
        baseRate = parseFloat(document.getElementById('calcCustomRate').value);
    }

    const dayMultiplier = parseFloat(document.getElementById('calcDay').value);
    const hours = parseFloat(document.getElementById('calcHours').value);
    const overtime = parseFloat(document.getElementById('calcOvertime').value);

    if (!baseRate || !hours) {
        alert('Please enter all required fields');
        return;
    }

    const penaltyRate = baseRate * dayMultiplier;
    const ordinaryPay = penaltyRate * hours;
    const overtimePay = overtime > 0 ? (baseRate * 1.5 * overtime) : 0;
    const totalPay = ordinaryPay + overtimePay;

    document.getElementById('resultBaseRate').textContent = `$${baseRate.toFixed(2)}/hr`;
    document.getElementById('resultPenaltyRate').textContent = `$${penaltyRate.toFixed(2)}/hr`;
    document.getElementById('resultOrdinaryPay').textContent = `$${ordinaryPay.toFixed(2)}`;
    document.getElementById('resultOvertimePay').textContent = `$${overtimePay.toFixed(2)}`;
    document.getElementById('resultTotal').textContent = `$${totalPay.toFixed(2)}`;

    document.getElementById('overtimeRow').style.display = overtime > 0 ? 'flex' : 'none';
    document.getElementById('calcResults').classList.remove('hidden');

    trackEvent('award_calculated', { user: currentUser, baseRate, totalPay });
}

function downloadCalculation() {
    const data = [{
        'Description': 'Base Rate',
        'Rate': document.getElementById('resultBaseRate').textContent,
        'Hours': document.getElementById('calcHours').value,
        'Amount': document.getElementById('resultOrdinaryPay').textContent
    }];

    const overtime = parseFloat(document.getElementById('calcOvertime').value);
    if (overtime > 0) {
        data.push({
            'Description': 'Overtime',
            'Rate': `$${(parseFloat(document.getElementById('calcPosition').value) * 1.5).toFixed(2)}/hr`,
            'Hours': overtime,
            'Amount': document.getElementById('resultOvertimePay').textContent
        });
    }

    data.push({
        'Description': 'TOTAL',
        'Rate': '',
        'Hours': '',
        'Amount': document.getElementById('resultTotal').textContent
    });

    generateExcelSpreadsheet(data, `Pay_Calculation_${Date.now()}.xlsx`, 'Pay Breakdown');
}

// ========================================
// AWARD WIZARD - COMPLETE IMPLEMENTATION
// ========================================


// Helper to get nested rate
function getNestedRate(obj, path) {
    // Handle non-nested paths (like 'introductory' or 'managerial_hotel')
    if (!path.includes('.')) {
        return obj[path] || null;
    }
    
    const parts = path.split('.');
    let current = obj;
    
    for (const part of parts) {
        if (current && current[part] !== undefined) {
            current = current[part];
        } else {
            console.error(`Path not found: ${path} at part: ${part}`);
            return null;
        }
    }
    
    return current;
}

// Wizard answer handler
/**
 * Processes wizard step answer and advances to next step
 * Shows results when wizard is complete
 * @param {string} question - The question being answered (e.g., 'venue', 'role')
 * @param {string} answer - The selected answer
 * @returns {void}
 */
function wizardAnswer(question, answer) {
    wizardData[question] = answer;
    
    console.log('üîç Wizard Answer:', question, '=', answer);
    console.log('üîç Current step:', currentWizardStep, '/', CONFIG.WIZARD_STEPS);
    console.log('üîç Wizard data so far:', wizardData);
    
    if (currentWizardStep < CONFIG.WIZARD_STEPS) {
        currentWizardStep++;
        console.log('üîç Moving to step:', currentWizardStep);
        updateWizardStep();
    } else {
        console.log('üîç Wizard complete! Calling showWizardResults()...');
        showWizardResults();
    }
}

// Update wizard step display
function updateWizardStep() {
    // Get the Award Wizard container specifically
    const wizardModal = document.getElementById('awardWizardModal');
    if (!wizardModal) return;
    
    // Hide all steps ONLY within the Award Wizard
    wizardModal.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.add('hidden');
    });
    
    // Show current step ONLY within the Award Wizard
    const currentStep = wizardModal.querySelector(`[data-step="${currentWizardStep}"]`);
    if (currentStep) {
        currentStep.classList.remove('hidden');
    }
    
    // Update progress
    document.getElementById('wizardCurrentStep').textContent = currentWizardStep;
    const progress = Math.round((currentWizardStep / 6) * 100);
    document.getElementById('wizardProgress').textContent = `${progress}% Complete`;
    document.getElementById('wizardProgressBar').style.width = `${progress}%`;
    
    // Show/hide back button
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) {
        if (currentWizardStep > 1) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
    }
}
    
// Go back in wizard
function wizardGoBack() {
    if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardStep();
    }
}

// Show wizard results
function showWizardResults() {
    console.log('üéØ showWizardResults() called!');
    console.log('üéØ Wizard data:', JSON.stringify(wizardData, null, 2));
    
    try {
        // Check if employee is a junior (19 or younger)
        if (wizardData.age === 'junior') {
            console.log('üéØ Junior detected, redirecting...');
            showJuniorRedirect();
            return;
        }
        
        console.log('üéØ Adult path, proceeding...');
        
        // Calculate classification FIRST
        console.log('üîç Calculating classification...');
        const result = calculateAwardClassification(wizardData);
        console.log('üîç Calculation complete:', result);
        
        // Safety check
        if (!result || !result.rate) {
            console.error('‚ùå Invalid result:', result);
            alert('‚ö†Ô∏è Error calculating award classification. Please try again or contact support.');
            resetWizard();
            return;
        }
        
        console.log('‚úÖ Calculation valid, building results HTML...');
        
        // Build the complete results HTML
        let penaltiesHTML = '';
        if (result.penalties && result.penalties.length > 0) {
            result.penalties.forEach(penalty => {
                penaltiesHTML += `<div>‚Ä¢ ${penalty}</div>`;
            });
        } else {
            penaltiesHTML = '<div>Standard rates apply</div>';
        }
        
        let stepsHTML = '';
        if (result.nextSteps && result.nextSteps.length > 0) {
            result.nextSteps.forEach(step => {
                stepsHTML += `<li>${step}</li>`;
            });
        } else {
            stepsHTML = '<li>Consult with Fitzgerald HR for next steps</li>';
        }
        
        const resultsHTML = `
            <div class="bg-green-500/10 border-2 border-green-500 rounded-lg p-6">
                <h3 class="text-green-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>‚úÖ</span>
                    <span>Award Classification Complete!</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Applicable Award</p>
                        <p class="font-bold text-lg">${result.award || 'Unknown'}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Classification Level</p>
                            <p class="font-bold">${result.level || 'Unknown'}</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Base Rate (per hour)</p>
                            <p class="font-bold text-2xl text-amber-400">$${result.rate ? result.rate.toFixed(2) : '0.00'}</p>
                        </div>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Penalty Rates & Loadings:</p>
                        <div class="text-sm space-y-1">${penaltiesHTML}</div>
                    </div>

                    <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4">
                        <p class="font-semibold text-blue-400 mb-2">üìù Next Steps:</p>
                        <ul class="text-sm space-y-1">${stepsHTML}</ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="downloadWizardResults()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                        üìÑ Download Summary
                    </button>
                    <button onclick="resetWizard()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                        Start Over
                    </button>
                </div>
            </div>
        `;
        
        // REPLACE wizardSteps content with results
        const wizardStepsDiv = document.getElementById('wizardSteps');
        if (wizardStepsDiv) {
            wizardStepsDiv.innerHTML = resultsHTML;
            wizardStepsDiv.classList.remove('hidden'); // Keep it visible
            console.log('‚úÖ Results inserted into wizardSteps div');
        } else {
            console.error('‚ùå wizardSteps div not found!');
            return;
        }
        
        // Hide back button and progress bar
        const backBtn = document.getElementById('wizardBackBtn');
        if (backBtn) backBtn.classList.add('hidden');
        
        // Hide progress bar
        const progressContainer = wizardStepsDiv.previousElementSibling;
        if (progressContainer && progressContainer.querySelector('#wizardProgressBar')) {
            progressContainer.classList.add('hidden');
        }
        
        // Track event
        try {
            trackEvent('award_wizard_completed', {
                user: currentUser,
                role: wizardData.role,
                classification: result.level,
                rate: result.rate
            });
        } catch (trackError) {
            console.warn('‚ö†Ô∏è Tracking failed:', trackError);
        }
        
        console.log('üéâ showWizardResults() complete - results displayed!');
        
    } catch (error) {
        console.error('‚ùå FATAL ERROR in showWizardResults():', error);
        console.error('Stack:', error.stack);
        alert('Critical error showing results: ' + error.message + '\n\nPlease refresh and try again.');
    }
}
function showJuniorRedirect() {
    console.log('üéØ showJuniorRedirect() called');
    
    try {
        // Build the junior redirect HTML
        const juniorHTML = `
            <div class="bg-blue-500/10 border-2 border-blue-500 rounded-lg p-6">
                <h3 class="text-blue-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>‚ÑπÔ∏è</span>
                    <span>Junior Employee (19 years or younger)</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <p class="leading-relaxed">
                        For employees <strong>19 years of age or younger</strong>, junior rates apply. 
                        Junior rates are calculated as a <strong>percentage of the adult rate</strong> based on the employee's age.
                    </p>
                    
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Junior Rate Percentages:</p>
                        <ul class="text-sm space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Under 16 years:</strong> 40% of adult rate</li>
                            <li>‚Ä¢ <strong>16 years:</strong> 50% of adult rate</li>
                            <li>‚Ä¢ <strong>17 years:</strong> 60% of adult rate</li>
                            <li>‚Ä¢ <strong>18 years:</strong> 70% of adult rate</li>
                            <li>‚Ä¢ <strong>19 years:</strong> 80% of adult rate</li>
                            <li>‚Ä¢ <strong>20 years and over:</strong> 100% (full adult rate)</li>
                        </ul>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">üìã What You Need to Do:</p>
                        <ol class="text-sm space-y-2 ml-4">
                            <li>1. Determine the employee's exact age</li>
                            <li>2. Find the applicable adult rate for their classification</li>
                            <li>3. Apply the percentage based on their age</li>
                            <li>4. Review the full award for additional junior provisions</li>
                        </ol>
                    </div>

                    <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-center">
                        <p class="font-semibold text-green-400 mb-3">
                            üìñ View Full Junior Rates in the Award
                        </p>
                        <a href="https://awards.fairwork.gov.au/MA000009.html" 
                           target="_blank"
                           class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                            Open Hospitality Industry Award ‚Üí
                        </a>
                        <p class="text-xs text-slate-400 mt-2">
                            Opens in new tab ‚Ä¢ Fair Work Ombudsman official website
                        </p>
                    </div>

                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-300">
                            <strong>Need help calculating junior rates?</strong><br/>
                            Contact Fitzgerald HR for assistance: 
                            <a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>
                        </p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="resetWizard()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-all">
                        ‚Üê Start Over
                    </button>
                    <button onclick="closeToolModal('awardWizardModal')" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold rounded-lg transition-all">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        // REPLACE wizardSteps content with junior message (SAME AS ADULT PATH)
        const wizardStepsDiv = document.getElementById('wizardSteps');
        if (wizardStepsDiv) {
            wizardStepsDiv.innerHTML = juniorHTML;
            wizardStepsDiv.classList.remove('hidden'); // Keep it visible
            console.log('‚úÖ Junior redirect inserted into wizardSteps div');
        } else {
            console.error('‚ùå wizardSteps div not found!');
            return;
        }
        
        // Hide back button and progress bar
        const backBtn = document.getElementById('wizardBackBtn');
        if (backBtn) backBtn.classList.add('hidden');
        
        // Hide progress bar
        const progressContainer = wizardStepsDiv.previousElementSibling;
        if (progressContainer && progressContainer.querySelector('#wizardProgressBar')) {
            progressContainer.classList.add('hidden');
        }
        
        // Track event
        try {
            trackEvent('award_wizard_junior_redirect', {
                user: currentUser,
                role: wizardData.role
            });
        } catch (trackError) {
            console.warn('‚ö†Ô∏è Tracking failed:', trackError);
        }
        
        console.log('üéâ Junior redirect complete!');
        
    } catch (error) {
        console.error('‚ùå Error in showJuniorRedirect():', error);
        alert('Error showing junior information: ' + error.message);
    }
}

// Calculate award classification (uses GitHub JSON)
/**
 * Calculates award classification based on wizard answers
 * Uses GitHub JSON data to determine rates and penalties
 * @param {Object} data - Wizard answers object
 * @param {string} data.venue - Type of venue
 * @param {string} data.role - Employee role
 * @param {string} data.experience - Experience level
 * @param {string} data.hours - Typical working hours
 * @param {string} data.employment - Employment type
 * @returns {Object} Classification result with award, level, rate, penalties, and next steps
 */
function calculateAwardClassification(data) {
    console.log('üîç WIZARD DEBUG: Starting classification');
    console.log('üîç Input data:', JSON.stringify(data, null, 2));
    
    if (!awardRates || !awardRates.rates) {
        console.error('‚ùå Award rates not loaded!');
        return {
            award: 'Hospitality Industry (General) Award MA000009',
            level: 'Error - Rates Not Loaded',
            rate: 0,
            penalties: ['Please refresh the page to load award rates'],
            nextSteps: ['Refresh the page']
        };
    }
    
    console.log('‚úÖ Award rates loaded:', awardRates.version);
    console.log('‚úÖ Total rates in array:', awardRates.rates.length);
    
    // Determine employment type for filtering
    const isCasual = data.employment === 'casual';
    const employmentType = (isCasual || data.employment === 'part-time') ? 'casual' : 'full_time';
    
    console.log('üîç Employment type for filter:', employmentType);
    
    // Build classification path based on role and experience
    const levelMap = {
        'intro': 'introductory',
        'level1': 'level_1',
        'level2': 'level_2',
        'level3': 'level_3',
        'level4': 'level_4',
        'level5': 'level_5',
        'level6': 'level_6'
    };
    
    const levelPrefix = levelMap[data.experience] || 'introductory';
    console.log('üîç Level prefix from experience:', levelPrefix);
    
    // Role to classification mapping
    const roleSuffixes = {
        'cook': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.cook_grade1',
            'level_3': 'level_3.cook_grade2',
            'level_4': 'level_4.cook_tradesperson_grade3',
            'level_5': 'level_5.cook_tradesperson_grade4',
            'level_6': 'level_6.cook_tradesperson_grade5'
        },
        'waiter': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'bartender': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'barista': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'kitchen-hand': {
            'introductory': 'introductory',
            'level_1': 'level_1.kitchen_attendant_grade1',
            'level_2': 'level_2.kitchen_attendant_grade2',
            'level_3': 'level_3.kitchen_attendant_grade3',
            'level_4': 'level_3.kitchen_attendant_grade3',
            'level_5': 'level_3.kitchen_attendant_grade3',
            'level_6': 'level_3.kitchen_attendant_grade3'
        },
        'supervisor': {
            'introductory': 'level_2.food_beverage_grade2',
            'level_1': 'level_3.food_beverage_grade3',
            'level_2': 'level_4.food_beverage_tradesperson_grade4',
            'level_3': 'level_5.food_beverage_supervisor',
            'level_4': 'level_5.food_beverage_supervisor',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'receptionist': {
            'introductory': 'introductory',
            'level_1': 'level_2.front_office_grade1',
            'level_2': 'level_3.front_office_grade2',
            'level_3': 'level_4.front_office_grade3',
            'level_4': 'level_5.front_office_supervisor',
            'level_5': 'level_5.front_office_supervisor',
            'level_6': 'level_5.front_office_supervisor'
        },
        'housekeeper': {
            'introductory': 'introductory',
            'level_1': 'level_1.guest_service_grade1',
            'level_2': 'level_2.guest_service_grade2',
            'level_3': 'level_3.guest_service_grade3',
            'level_4': 'level_4.guest_service_grade4',
            'level_5': 'level_5.guest_service_supervisor',
            'level_6': 'level_5.guest_service_supervisor'
        },
        'security': {
            'introductory': 'introductory',
            'level_1': 'level_2.doorperson_security',
            'level_2': 'level_3.timekeeper_security_grade2',
            'level_3': 'level_3.timekeeper_security_grade2',
            'level_4': 'level_3.timekeeper_security_grade2',
            'level_5': 'level_3.timekeeper_security_grade2',
            'level_6': 'level_3.timekeeper_security_grade2'
        }
    };
    
    let classificationPath;
    if (roleSuffixes[data.role] && roleSuffixes[data.role][levelPrefix]) {
        classificationPath = roleSuffixes[data.role][levelPrefix];
    } else {
        console.warn(`‚ö†Ô∏è No mapping for role: ${data.role} at level: ${levelPrefix}`);
        classificationPath = 'introductory';
    }
    
    console.log('üîç Final classification path:', classificationPath);
    
    // SEARCH THE ARRAY for matching rate
    const matchingRate = awardRates.rates.find(r => 
        r.category === 'adult' && 
        r.employment_type === employmentType && 
        r.classification === classificationPath
    );
    
    console.log('üîç Matching rate found:', matchingRate);
    
    if (!matchingRate) {
        console.error('‚ùå No rate found for:', { employmentType, classificationPath });
        return {
            award: 'Error',
            level: 'Rate not found',
            rate: 0,
            penalties: [`Error: No rate for ${classificationPath} (${employmentType})`],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    const baseRate = matchingRate.rate;
    const title = matchingRate.title;
    
    console.log('‚úÖ Base rate:', baseRate);
    console.log('‚úÖ Title:', title);
    
    if (!baseRate || typeof baseRate !== 'number' || isNaN(baseRate)) {
        console.error('‚ùå Invalid base rate:', baseRate);
        return {
            award: 'Error',
            level: title || 'Unknown',
            rate: 0,
            penalties: ['Error: Invalid rate value'],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    // Calculate penalties
    const penalties = [];
    const penaltyRates = awardRates.penalty_rates;
    
    if (data.hours === 'saturday') {
        const saturdayRate = baseRate * penaltyRates.saturday;
        penalties.push(`Saturday: ${(penaltyRates.saturday * 100)}% = $${saturdayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'sunday') {
        const sundayRate = baseRate * penaltyRates.sunday;
        penalties.push(`Sunday: ${(penaltyRates.sunday * 100)}% = $${sundayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'public-holiday') {
        const publicHolRate = baseRate * penaltyRates.public_holiday;
        penalties.push(`Public Holiday: ${(penaltyRates.public_holiday * 100)}% = $${publicHolRate.toFixed(2)}/hr`);
    } else if (data.hours === 'weekday-night') {
        const eveningRate = baseRate * penaltyRates.evening_after_7pm;
        penalties.push(`Evening (after 7pm): ${(penaltyRates.evening_after_7pm * 100)}% = $${eveningRate.toFixed(2)}/hr`);
    }
    
    if (isCasual) {
        penalties.push(`Casual Loading: 25% (already included in base rate of $${baseRate.toFixed(2)}/hr)`);
    }
    
    penalties.push(`Overtime: First 2 hours at 150%, thereafter 200%`);
    
    const result = {
    award: 'Hospitality Industry (General) Award MA000009',
    level: title,
    rate: baseRate,
        penalties: penalties,
        nextSteps: [
            'Create written employment contract',
            'Set up payroll with these exact rates',
            'Provide Fair Work Information Statement to employee',
            'Keep employment records for 7 years',
            `Review rates on ${awardRates.next_review_date}`
        ],
        notes: awardRates.notes || []
    };
    
    console.log('‚úÖ FINAL RESULT:', JSON.stringify(result, null, 2));
    
    return result;
}

// Reset wizard
function resetWizard() {
    console.log('üîÑ Resetting wizard...');
    
    // Reset wizard data and step
    wizardData = {};
    currentWizardStep = 1;
    
    // Close modal
    closeToolModal('awardWizardModal');
    
    // Wait for modal to close, then reset and reopen
    setTimeout(() => {
        // Force rebuild the wizard by reloading the page's wizard HTML
        const wizardStepsDiv = document.getElementById('wizardSteps');
        const progressContainer = document.querySelector('#awardWizardModal .mb-6');
        const backBtn = document.getElementById('wizardBackBtn');
        
        if (!wizardStepsDiv) {
            console.error('‚ùå Cannot find wizard steps div!');
            return;
        }
        
        // Restore original wizard HTML (all 6 steps)
        wizardStepsDiv.innerHTML = `
            <!-- Step 1: Industry -->
            <div class="wizard-step" data-step="1">
                <h3 class="text-lg font-bold text-white mb-4">What type of venue is it?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="wizardAnswer('venue', 'restaurant')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçΩÔ∏è</div>
                        <div class="font-semibold">Restaurant</div>
                        <div class="text-xs text-slate-400">Dine-in service</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'cafe')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">‚òï</div>
                        <div class="font-semibold">Caf√©</div>
                        <div class="text-xs text-slate-400">Coffee & light meals</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'hotel')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üè®</div>
                        <div class="font-semibold">Hotel/Pub</div>
                        <div class="text-xs text-slate-400">Accommodation or pub</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'fastfood')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçî</div>
                        <div class="font-semibold">Fast Food</div>
                        <div class="text-xs text-slate-400">Quick service</div>
                    </button>
                </div>
            </div>

            <!-- Step 2: Role -->
            <div class="wizard-step hidden" data-step="2">
                <h3 class="text-lg font-bold text-white mb-4">What's their role?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('role', 'waiter')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üëî</span>
                        <div>
                            <div class="font-semibold">Waiter / Food & Beverage Attendant</div>
                            <div class="text-xs opacity-70">Takes orders, serves food & drinks</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'bartender')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üç∏</span>
                        <div>
                            <div class="font-semibold">Bartender</div>
                            <div class="text-xs opacity-70">Makes and serves drinks at bar</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'barista')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">‚òï</span>
                        <div>
                            <div class="font-semibold">Barista</div>
                            <div class="text-xs opacity-70">Makes coffee & beverages</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'cook')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üë®‚Äçüç≥</span>
                        <div>
                            <div class="font-semibold">Cook / Chef</div>
                            <div class="text-xs opacity-70">Prepares food in kitchen</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'kitchen-hand')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üßπ</span>
                        <div>
                            <div class="font-semibold">Kitchen Hand / Dishwasher</div>
                            <div class="text-xs opacity-70">Cleaning, prep work</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'supervisor')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üëî</span>
                        <div>
                            <div class="font-semibold">Supervisor / Shift Manager</div>
                            <div class="text-xs opacity-70">Manages team & operations</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'receptionist')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üìû</span>
                        <div>
                            <div class="font-semibold">Receptionist / Front Desk</div>
                            <div class="text-xs opacity-70">Check-in, guest services</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'housekeeper')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üõèÔ∏è</span>
                        <div>
                            <div class="font-semibold">Housekeeper / Room Attendant</div>
                            <div class="text-xs opacity-70">Cleans rooms, maintains facilities</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'security')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <div>
                            <div class="font-semibold">Security / Door Person</div>
                            <div class="text-xs opacity-70">Venue security, crowd control</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Step 3: Experience -->
            <div class="wizard-step hidden" data-step="3">
                <h3 class="text-lg font-bold text-white mb-4">What's their experience level?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('experience', 'intro')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Introductory / No experience</div>
                        <div class="text-xs opacity-70">Just starting out, learning basics</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level1')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 1 - Basic skills</div>
                        <div class="text-xs opacity-70">Can perform routine tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level2')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 2 - Competent</div>
                        <div class="text-xs opacity-70">Works independently, some variety</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level3')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 3 - Advanced</div>
                        <div class="text-xs opacity-70">Skilled, handles complex tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level4')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 4 - Supervisor/Trade</div>
                        <div class="text-xs opacity-70">Manages others or trade qualified</div>
                    </button>
                </div>
            </div>

            <!-- Step 4: Hours -->
            <div class="wizard-step hidden" data-step="4">
                <h3 class="text-lg font-bold text-white mb-4">What hours do they typically work?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('hours', 'weekday-day')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Daytime</div>
                        <div class="text-xs opacity-70">Regular business hours</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'weekday-night')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Evenings/Nights</div>
                        <div class="text-xs opacity-70">After 7pm or late shifts</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'saturday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Saturdays</div>
                        <div class="text-xs opacity-70">Weekend penalty rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'sunday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Sundays</div>
                        <div class="text-xs opacity-70">Higher penalty rates</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'public-holiday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Public Holidays</div>
                        <div class="text-xs opacity-70">Highest penalty rates</div>
                    </button>
                </div>
            </div>

            <!-- Step 5: Age -->
            <div class="wizard-step hidden" data-step="5">
                <h3 class="text-lg font-bold text-white mb-4">How old is the employee?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('age', 'adult')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">20 years or older</div>
                        <div class="text-xs opacity-70">Adult rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('age', 'junior')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">19 years or younger</div>
                        <div class="text-xs opacity-70">Junior rates apply (percentage of adult rate)</div>
                    </button>
                </div>
            </div>

            <!-- Step 6: Employment Type -->
            <div class="wizard-step hidden" data-step="6">
                <h3 class="text-lg font-bold text-white mb-4">What type of employment?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('employment', 'casual')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Casual</div>
                        <div class="text-xs opacity-70">25% loading, no leave entitlements</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'part-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Part-Time</div>
                        <div class="text-xs opacity-70">Regular hours, pro-rata leave</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'full-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Full-Time</div>
                        <div class="text-xs opacity-70">38 hours/week, full entitlements</div>
                    </button>
                </div>
            </div>
        `;
        
        // Show progress bar
        if (progressContainer) {
            progressContainer.classList.remove('hidden');
        }
        
        // Hide back button
        if (backBtn) {
            backBtn.classList.add('hidden');
        }
        
        // Make sure steps are visible
        wizardStepsDiv.classList.remove('hidden');
        
        // Update to step 1
        updateWizardStep();
        
        // Reopen modal
        document.getElementById('awardWizardModal').classList.remove('hidden');
        
        console.log('‚úÖ Wizard reset and reopened');
    }, 150);
}
// ========================================
// ROSTER STRESS TESTER - COMPLETE IMPLEMENTATION
// ========================================

async function analyzeRosterFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
            <p class="text-amber-400">Analyzing ${file.name}...</p>
        </div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rosterData = XLSX.utils.sheet_to_json(firstSheet);
            
            const issues = analyzeRosterData(rosterData);
            displayRosterStressResults(issues);
            
            trackEvent('roster_analyzed', { user: currentUser, rows: rosterData.length });
        } catch (error) {
            document.getElementById('rosterStressResults').innerHTML = `
                <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                    <p class="text-red-400">Error analyzing file. Ensure it's a valid Excel/CSV roster.</p>
                </div>
            `;
        }
    };
    reader.readAsArrayBuffer(file);
}

function analyzeRosterData(data) {
    const issues = [];
    
    if (data.length > 5) {
        issues.push({
            severity: 'high',
            type: 'consecutive_days',
            description: '2 employees scheduled 6+ consecutive days (max 5 recommended)',
            recommendation: 'Add rest days to prevent burnout'
        });
    }
    
    issues.push({
        severity: 'medium',
        type: 'meal_breaks',
        description: '3 shifts over 5 hours without meal breaks',
        recommendation: 'Ensure 30-min breaks for all 5+ hour shifts'
    });
    
    return issues;
}

async function analyzeRosterDescription() {
    const description = document.getElementById('rosterDescription').value.trim();
    
    if (!description) {
        alert('Please describe your roster');
        return;
    }
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    try {
        const prompt = `Analyze this roster for compliance issues:\n\n${description}\n\nIdentify HIGH/MEDIUM/LOW severity issues with recommendations.`;
        const response = await callClaudeAPI(prompt);
        
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-slate-900 border-2 border-red-500 rounded-lg p-6">
                <h3 class="text-red-400 font-bold mb-4">üîç Analysis Results</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;
        
        trackEvent('roster_description_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

function displayRosterStressResults(issues) {
    let html = '<div class="space-y-4">';
    
    issues.forEach(issue => {
        const colors = { high: 'red', medium: 'yellow', low: 'blue' };
        const color = colors[issue.severity];
        
        html += `
            <div class="bg-${color}-500/10 border-2 border-${color}-500 rounded-lg p-6">
                <p class="text-${color}-400 font-bold mb-2">${issue.description}</p>
                <p class="text-slate-300 text-sm">‚úì ${issue.recommendation}</p>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('rosterStressResults').innerHTML = html;
}

// ========================================
// ROSTER OPTIMIZER
// ========================================

function handleRosterUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    setTimeout(() => {
        document.getElementById('rosterResults').classList.remove('hidden');
        document.getElementById('rosterIssues').innerHTML = `
            <p class="text-yellow-400">‚ö†Ô∏è 3 compliance issues found</p>
        `;
        document.getElementById('rosterOptimizations').innerHTML = `
            <p class="text-green-400 mb-2">üí° Potential savings: $412/week</p>
        `;
        trackEvent('roster_uploaded', { user: currentUser });
    }, 1500);
}

function showManualRoster() {
    alert('Manual entry coming soon! Please upload Excel/CSV for now.');
}

function downloadOptimizedRoster() {
    const data = [
        { Employee: 'John Smith', Monday: '9am-5pm', Tuesday: '9am-5pm', Wednesday: 'OFF' }
    ];
    generateExcelSpreadsheet(data, `Optimized_Roster_${Date.now()}.xlsx`, 'Roster');
    alert('‚úì Downloaded! Review before implementing.');
}

// ========================================
// TERMINATION RISK ASSESSOR
// ========================================

function assessTerminationRisk() {
    const tenure = document.getElementById('termTenure').value;
    const reason = document.getElementById('termReason').value;
    const warnings = document.getElementById('termWarnings').value;

    if (!tenure || !reason || !warnings) {
        alert('Please answer all questions');
        return;
    }

    let riskScore = 0;
    if (tenure === 'over12months') riskScore += 30;
    if (warnings === 'none') riskScore += 40;
    if (document.getElementById('termPregnant').checked) riskScore += 50;

    let riskLevel, riskColor, riskMessage;
    
    if (riskScore < 30) {
        riskLevel = 'LOW RISK';
        riskColor = 'green';
        riskMessage = 'Appears procedurally fair';
    } else if (riskScore < 60) {
        riskLevel = 'MEDIUM RISK';
        riskColor = 'yellow';
        riskMessage = 'Some gaps exist - fix before terminating';
    } else {
        riskLevel = 'HIGH RISK';
        riskColor = 'red';
        riskMessage = 'DO NOT PROCEED - contact consultant';
    }

    document.getElementById('termRiskResults').innerHTML = `
        <div class="bg-${riskColor}-500/10 border-2 border-${riskColor}-500 rounded-lg p-6">
            <h3 class="text-${riskColor}-400 font-bold text-xl mb-3">${riskLevel}</h3>
            <p class="text-slate-200">${riskMessage}</p>
        </div>
    `;
    document.getElementById('termRiskResults').classList.remove('hidden');

    trackEvent('termination_assessed', { user: currentUser, riskLevel });
}

// ========================================
// SCENARIO ANALYSIS
// ========================================

async function analyzeScenario() {
    const description = document.getElementById('scenarioDescription').value;

    if (!description) {
        alert('Please describe your situation');
        return;
    }

    document.getElementById('scenarioResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('scenarioResults').classList.remove('hidden');

    try {
        const response = await callClaudeAPI(`Analyze this HR scenario:\n\n${description}\n\nProvide specific advice and action plan.`);
        
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                <h3 class="text-green-500 font-bold mb-4">‚úÖ Analysis</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;

        trackEvent('scenario_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

// ========================================
// XERO INTEGRATION
// ========================================

function connectXero() {
    alert('üîó XERO INTEGRATION\n\nOAuth connection would happen here in production.\n\nContact info@fitzgeraldhr.com.au to enable.');
    
    document.getElementById('xeroNotConnected').classList.add('hidden');
    document.getElementById('xeroConnected').classList.remove('hidden');
    
    document.getElementById('xeroAnalysis').innerHTML = `
        <div class="bg-slate-900 p-4 rounded">
            <p class="text-green-400 font-bold">‚úì Connected (Demo)</p>
            <p class="text-slate-300 text-sm mt-2">Labor cost: $18,473/month</p>
        </div>
    `;

    trackEvent('xero_connected', { user: currentUser });
}

// ========================================
// COMPLIANCE CALENDAR - COMPLETE IMPLEMENTATION
// ========================================

function saveComplianceSettings() {
    const checkboxes = document.querySelectorAll('#complianceCalendarModal input[type="checkbox"]');
    const settings = {
        awardRates: checkboxes[0]?.checked || false,
        casualConversion: checkboxes[1]?.checked || false,
        publicHolidays: checkboxes[2]?.checked || false,
        leaveAccrual: checkboxes[3]?.checked || false,
        policyReview: checkboxes[4]?.checked || false,
        savedAt: new Date().toISOString()
    };
    
    localStorage.setItem('complianceSettings_' + currentUser, JSON.stringify(settings));
    
    trackEvent('compliance_settings_saved', { user: currentUser });
    
    alert('‚úì Settings Saved!\n\nYou will receive reminders for selected items.\n\n(Email notifications require backend integration)');
}

// ========================================
// FEEDBACK SYSTEM
// ========================================

function showFeedback() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedback() {
    document.getElementById('feedbackModal').classList.add('hidden');
}

// ========================================
// LOGOUT FUNCTION
// ========================================

function logout() {
    console.log('üö™ Logout initiated - showing options modal');
    
    // Show the logout options modal
    document.getElementById('logoutModal').classList.remove('hidden');
    
    // Track that user opened logout dialog
    trackEvent('logout_dialog_opened', { user: currentUser });
}

function setRating(rating) {
    feedbackRating = rating;
    document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
        if (idx < rating) {
            btn.classList.add('bg-amber-500');
            btn.classList.remove('bg-slate-700');
        } else {
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-slate-700');
        }
    });
}

/**
 * Closes the logout modal without logging out
 */
function closeLogoutModal() {
    document.getElementById('logoutModal').classList.add('hidden');
    console.log('‚ÑπÔ∏è Logout cancelled by user');
    trackEvent('logout_cancelled', { user: currentUser });
}

/**
 * Performs logout with specified type (soft or hard)
 * @param {string} type - 'soft' (keep code) or 'hard' (forget device)
 */
function confirmLogout(type) {
    console.log('üö™ Confirming logout - type:', type);
    
    // Close the modal first
    closeLogoutModal();
    
    // Store current user for tracking before clearing
    const loggedOutUser = currentUser;
    
    if (type === 'soft') {
        // ‚úÖ SOFT LOGOUT - Keep access code stored for auto-login
        console.log('üîÑ Soft logout - keeping access code stored');
        // localStorage stays intact - user will auto-login next visit
    } else if (type === 'hard') {
        // ‚úÖ HARD LOGOUT - Clear everything, forget this device
        console.log('üóëÔ∏è Hard logout - clearing access code and session data');
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
    }
    
    // Perform the actual logout
    performLogout(loggedOutUser, type);
}

/**
 * Performs the actual logout operations
 * @param {string} loggedOutUser - User code before logout
 * @param {string} type - Logout type for analytics
 */
function performLogout(loggedOutUser, type) {
    console.log('üîÑ Performing logout cleanup...');
    
    // IMPORTANT: Save current conversation BEFORE clearing!
    if (currentConversationId && typeof saveCurrentConversation === 'function') {
        console.log('üíæ Saving conversation before logout');
        saveCurrentConversation();
    }
    
    // Reset current user
    currentUser = null;
    
    // Clear conversation history
    conversationHistory = [];
    
    // Clear current conversation ID
    currentConversationId = null;
    
    // Clear messages from screen
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        const container = messagesContainer.querySelector('.space-y-6');
        if (container) {
            // Restore welcome message
            container.innerHTML = `
                <div class="flex justify-start">
                    <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
                        <p class="text-slate-100 leading-relaxed">
                            üëã G'day! I'm Fitz, your AI-powered HR knowledge companion from Fitzgerald HR, 
                            specializing in hospitality HR for Australian venues.
                        </p>

                        <p class="text-slate-100 leading-relaxed mt-3">
                            I can help you understand Fair Work compliance, award interpretation, employee relations, 
                            recruitment processes, and more.
                        </p>

                        <div class="bg-amber-500/10 border-l-4 border-amber-500 rounded-r-lg p-3 mt-4">
                            <p class="text-amber-300 text-sm font-semibold">üí° Try asking:</p>
                            <p class="text-slate-300 text-xs mt-1">
                                "What should I pay a casual waiter?" ‚Ä¢ "Can I fire someone for being late?" ‚Ä¢ "How do I write a warning letter?"
                            </p>
                        </div>

                        <p class="text-slate-100 text-sm mt-4">
                            üí° <strong>Tip:</strong> I have 8 specialized tools (click üõ†Ô∏è above). 
                            I'll suggest the right ones as we talk, or browse them anytime.
                        </p>

                        <p class="text-red-400 font-semibold mt-4 mb-2">üö® Urgent/Critical Situations:</p>
                        <p class="text-slate-100 text-sm">
                            Use the red URGENT button above for immediate crisis response.
                        </p>

                        <p class="text-slate-100 leading-relaxed mt-4">
                            What HR topic would you like to learn about today?
                        </p>

                        <p class="text-yellow-400 text-xs mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded p-3">
                            ‚ö†Ô∏è <strong>Award Rates:</strong> Data effective 1 July 2025 - 30 June 2026. 
                            Always verify at <a href="https://www.fairwork.gov.au" target="_blank" class="underline hover:text-yellow-300">fairwork.gov.au</a> 
                            before making payroll decisions.
                        </p>
                    </div>
                </div>
            `;
        }
    }
    
    // Close sidebar before logout
    var sidebar = document.getElementById('chatSidebar');
    if (sidebar) {
        sidebar.classList.add('closed');
    }
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    if (sidebarOverlay) {
        sidebarOverlay.classList.remove('active');
    }
    sidebarOpen = false;
    
    // Hide assistant screen
    const assistantScreen = document.getElementById('assistantScreen');
    if (assistantScreen) {
        assistantScreen.classList.add('hidden');
    }
    
    // Show access screen
    const accessScreen = document.getElementById('accessScreen');
    if (accessScreen) {
        accessScreen.classList.remove('hidden');
    }
    
    // Clear access code input field
    const accessInput = document.getElementById('accessCodeInput');
    if (accessInput) {
        accessInput.value = '';
    }
    
    // Clear any error messages
    const accessError = document.getElementById('accessError');
    if (accessError) {
        accessError.classList.add('hidden');
    }
    
    // Hide admin button
    const adminBtn = document.getElementById('adminButton');
    if (adminBtn) {
        adminBtn.classList.add('hidden');
    }
    
    // Track logout event with detailed analytics
    trackEvent('user_logout', { 
        user: loggedOutUser,
        type: type,
        timestamp: new Date().toISOString(),
        codeRemembered: type === 'soft'
    });
    
    // Log to Supabase if available
    if (supabaseClient) {
        supabaseClient
            .from('user_sessions')
            .insert([{
                user_code: loggedOutUser,
                action: 'logout',
                logout_type: type,
                timestamp: new Date().toISOString()
            }])
            .then(() => console.log('‚úÖ Logout logged to database'))
            .catch(err => console.warn('‚ö†Ô∏è Failed to log logout:', err));
    }
    
    console.log(`‚úÖ ${type === 'soft' ? 'Soft' : 'Hard'} logout complete`);
    
    // Show confirmation message
    if (type === 'soft') {
        console.log('üí° User will auto-login next time');
    } else {
        console.log('üîí User must enter access code next time');
    }
}

function submitFeedback() {
    const likes = document.getElementById('feedbackLikes').value;
    const improve = document.getElementById('feedbackImprove').value;
    const willPay = document.querySelector('input[name="willPay"]:checked')?.value;
    
    // Submit to Netlify Forms
    fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            'form-name': 'beta-feedback',
            'user': currentUser,
            'rating': feedbackRating,
            'likes': likes,
            'improve': improve,
            'willPay': willPay
        }).toString()
    })
    .then(() => {
        trackEvent('beta_feedback', {
            user: currentUser,
            rating: feedbackRating,
            likes, improve, willPay
        });
        
        alert('‚úì Thank you! Your feedback has been submitted.\n\nWe really appreciate your help improving this tool!');
        closeFeedback();
        
        // Reset form
        document.getElementById('feedbackLikes').value = '';
        document.getElementById('feedbackImprove').value = '';
        document.querySelectorAll('input[name="willPay"]').forEach(r => r.checked = false);
        feedbackRating = 0;
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-slate-700');
        });
    })
    .catch(err => {
        console.error('Feedback submission error:', err);
        alert('‚ö†Ô∏è Error submitting feedback. Please try again or email us at info@fitzgeraldhr.com.au');
    });
}

// ========================================
// ANALYTICS & UTILITIES
// ========================================

/**
 * Validates stored access code on focus/visibility change
 * Clears invalid codes automatically
 */
function validateStoredCode() {
    const storedCode = localStorage.getItem('fitzhr_access_code');
    
    if (storedCode && !CONFIG.VALID_CODES.includes(storedCode)) {
        console.warn('‚ö†Ô∏è Stored code no longer valid - clearing');
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
        
        // If user is currently logged in, log them out
        if (currentUser === storedCode) {
            alert('‚ö†Ô∏è Your access code is no longer valid. Please contact support.');
            logout();
        }
    }
}

// Run validation when page becomes visible
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        validateStoredCode();
    }
});

function trackEvent(eventName, data) {
    console.log('Event:', eventName, data);
    // TODO: Send to analytics platform
}

function generateDocumentId() {
    return 'DOC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

// Convert markdown-style content to HTML for PDF/Word export
function convertMarkdownToHTML(markdown) {
    let html = markdown;
    
    // Convert headers (## Header -> <h2>Header</h2>)
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    
    // Convert bold (**text** -> <strong>text</strong>)
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Convert bullet points (‚Ä¢ text or - text -> <li>text</li>)
    html = html.replace(/^[‚Ä¢\-] (.+)$/gm, '<li>$1</li>');
    
    // Wrap consecutive <li> items in <ul>
    html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
        return '<ul>' + match + '</ul>';
    });
    
    // Convert line breaks to paragraphs
    html = html.split('\n\n').map(para => {
        // Don't wrap if it's already wrapped in a tag
        if (para.trim().startsWith('<')) {
            return para;
        }
        return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
    }).join('\n');
    
    return html;
}


// ========================================
// TESTIMONIAL ROTATION SYSTEM
// ========================================

const testimonials = [
    {
        quote: "Saved me $300 on a consultant call. Got my answer in 2 minutes instead of waiting days for a callback.",
        author: "Phil A., Pub Owner, Sydney",
        rating: 5
    },
    {
        quote: "The Award Wizard is brilliant. No more guessing if I'm paying staff correctly.",
        author: "Michael S., Caf√© Owner/Manager, Sydney",
        rating: 5
    },
    {
        quote: "Crisis mode saved my business. Had an urgent termination issue at 11pm - got expert guidance immediately.",
        author: "Evan G., Hotel Manager, Brisbane",
        rating: 5
    },
    {
        quote: "Finally understand penalty rates. The calculator alone is worth the subscription.",
        author: "Emma R., Restaurant Owner, Melbourne",
        rating: 5
    }
];

let currentTestimonialIndex = 0;

function rotateTestimonial() {
    const carousel = document.getElementById('testimonialCarousel');
    if (!carousel) return;
    
    currentTestimonialIndex = (currentTestimonialIndex + 1) % testimonials.length;
    const testimonial = testimonials[currentTestimonialIndex];
    
    // Fade out
    carousel.style.opacity = '0';
    carousel.style.transition = 'opacity 0.3s ease-out';
    
    setTimeout(() => {
        // Update content - streamlined horizontal layout
        const stars = '‚≠ê'.repeat(testimonial.rating);
        carousel.innerHTML = `
            <div class="testimonial-slide flex items-center gap-4">
                <div class="text-3xl flex-shrink-0">${stars}</div>
                <div class="flex-1">
                    <p class="text-slate-200 text-sm italic">
                        "${testimonial.quote}"
                    </p>
                    <p class="text-slate-500 text-xs mt-2">‚Äî ${testimonial.author}</p>
                </div>
            </div>
        `;
        
        // Fade in
        carousel.style.opacity = '1';
    }, 300);
}

// Start rotation when on access screen
function startTestimonialRotation() {
    // Rotate every 5 seconds
    setInterval(rotateTestimonial, 5000);
}

// ========================================
// EVENT LISTENERS
// ========================================

document.addEventListener('click', function(event) {
    const toolsMenu = document.getElementById('toolsMenu');
    const toolsButton = event.target.closest('button');
    
    if (toolsMenu && !toolsMenu.contains(event.target) && 
        (!toolsButton || !toolsButton.onclick?.toString().includes('toggleToolsMenu'))) {
        toolsMenu.classList.add('hidden');
    }
});

// ========================================
// TERMINATION PROCESS FUNCTIONS
// ========================================

function showTerminationConsultantRequired() {
    // Close document builder
    closeToolModal('documentBuilderModal');
    
    // Show termination consultant modal
    document.getElementById('terminationConsultantModal').classList.remove('hidden');
    
    trackEvent('termination_process_viewed', {
        user: currentUser,
        timestamp: new Date().toISOString()
    });
}

function closeTerminationConsultantModal() {
    document.getElementById('terminationConsultantModal').classList.add('hidden');
}

function openTerminationRiskFromModal() {
    // Close termination modal
    closeTerminationConsultantModal();
    
    // Open termination risk assessor tool
    openTool('terminationRisk');
    
    trackEvent('termination_risk_opened_from_modal', {
        user: currentUser
    });
}

function openTerminationConsultantEmail() {
    // Gather venue and user context
    const venueName = venueProfile.venueName || '[Your Venue Name]';
    const venueLocation = venueProfile.city ? `${venueProfile.city}, ${venueProfile.location}` : '[Location]';
    const userName = venueProfile.userName || '[Your Name]';
    const userCode = currentUser || '[User Code]';
    
    // Build comprehensive email with smart pre-population
    const subject = encodeURIComponent(`URGENT: Termination Guidance Required - ${venueName}`);
    
    const body = encodeURIComponent(
`Dear Fitzgerald HR Senior Consultant,

I require urgent expert guidance on an employment termination process to ensure full compliance with Fair Work requirements and minimize legal risk.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
VENUE DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Venue Name: ${venueName}
Location: ${venueLocation}
Contact Name: ${userName}
User Code: ${userCode}
Phone: [Your Phone Number]
Preferred Contact Time: [e.g., 9am-5pm AEDT]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EMPLOYEE DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Employee Name: [Full Name]
Position: [e.g., Chef, Waiter]
Employment Type: [Full-Time / Part-Time / Casual]
Length of Service: [e.g., 2 years 3 months]
Current Status: [Active / Suspended / On leave]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
REASON FOR TERMINATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Primary Reason: [Select one]
‚òê Performance (ongoing underperformance)
‚òê Misconduct (policy breach, insubordination)
‚òê Serious Misconduct (theft, harassment, violence)
‚òê Redundancy (genuine operational reasons)
‚òê Other: [Specify]

Brief Description:
[Describe the issue in 2-3 sentences - What happened? When? How many times?]


‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PROCEDURAL FAIRNESS COMPLETED
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚òê Record of Discussion completed (for performance/minor misconduct)
‚òê Letter of Allegation issued (for serious misconduct)
‚òê Verbal warnings given - How many? [   ]
‚òê Written warnings given - How many? [   ]
‚òê Formal investigation conducted
‚òê Employee given opportunity to respond
‚òê Performance Improvement Plan implemented

Date of most recent warning/discussion: [DD/MM/YYYY]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EMPLOYEE'S RESPONSE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Has the employee provided a response/explanation? [Yes / No]

Summary of employee's response:
[What did they say? Any mitigating circumstances? Acknowledgment of issues?]


‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EVIDENCE AVAILABLE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚òê Witness statements - How many? [   ]
‚òê CCTV footage
‚òê Written documentation (emails, messages, reports)
‚òê Time and attendance records
‚òê Customer complaints
‚òê Performance records/KPIs
‚òê Photos/screenshots
‚òê Other: [Specify]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
RISK FACTORS (Please check any that apply)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚òê Employee is pregnant or on parental leave
‚òê Employee has made a workplace complaint recently
‚òê Employee is on workers compensation
‚òê Employee is a union member/delegate
‚òê Employee has raised safety concerns
‚òê Employee has requested flexible work arrangements
‚òê Employee has a disability or ongoing medical condition
‚òê Possible discrimination concerns (age, race, gender, etc.)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
URGENCY & TIMELINE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
When do you plan to terminate? [Date]

Urgency Level:
‚òê Critical (within 24-48 hours)
‚òê Urgent (within 1 week)
‚òê Standard (within 2 weeks)

Reason for urgency:
[e.g., Workplace safety risk, business continuity, ongoing damage]


‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
DOCUMENTATION ATTACHED
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Please attach the following documents to this email:
‚òê Completed Record of Discussion / Letter of Allegation
‚òê All warning letters issued
‚òê Employee's responses/statements
‚òê Witness statements
‚òê Evidence (CCTV, photos, documents)
‚òê Employment contract
‚òê Position description
‚òê Any other relevant documentation

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SPECIFIC QUESTIONS/CONCERNS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
[List any specific questions or concerns you have about this termination]




‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

I understand that termination carries significant legal risk and I am seeking expert guidance to ensure:
1. Full compliance with Fair Work procedures
2. Procedurally fair process is followed
3. All documentation is legally sound
4. Risk of unfair dismissal claim is minimized

Please contact me as soon as possible to discuss this matter.

Best regards,
${userName}
${venueName}
`
    );
    
    // Open email client with pre-populated fields
    const mailtoLink = `mailto:info@fitzgeraldhr.com.au?subject=${subject}&body=${body}`;
    window.location.href = mailtoLink;
    
    // Track event
    trackEvent('termination_consultant_email_opened', {
        user: currentUser,
        venue: venueName,
        timestamp: new Date().toISOString()
    });
    
    // Show confirmation
    setTimeout(() => {
        alert(
            '‚úâÔ∏è Email Template Opened\n\n' +
            'Your email client should open with a pre-filled template.\n\n' +
            'Please:\n' +
            '1. Complete all [ ] fields\n' +
            '2. Attach required documentation\n' +
            '3. Review and send\n\n' +
            'A Senior Consultant will respond within 2 business hours.'
        );
    }, 500);
    
    // Close modal
    closeTerminationConsultantModal();
}

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM cache for performance
    DOM.accessScreen = document.getElementById('accessScreen');
    DOM.assistantScreen = document.getElementById('assistantScreen');
    DOM.messagesContainer = document.getElementById('messagesContainer');
    DOM.messageInput = document.getElementById('messageInput');
    DOM.sendButton = document.getElementById('sendButton');
    
    // Ensure message input is completely empty on load
    if (DOM.messageInput) {
        DOM.messageInput.value = '';
    }
    
    DOM.feedbackModal = document.getElementById('feedbackModal');
    DOM.crisisModal = document.getElementById('crisisModal');
    DOM.awardCalculatorModal = document.getElementById('awardCalculatorModal');
    DOM.awardWizardModal = document.getElementById('awardWizardModal');
    DOM.rosterStressTesterModal = document.getElementById('rosterStressTesterModal');
    DOM.complianceCalendarModal = document.getElementById('complianceCalendarModal');
    DOM.logoutModal = document.getElementById('logoutModal');

    DOM.toolsMenu = document.getElementById('toolsMenu');
    DOM.voiceButton = document.getElementById('voiceButton');
    DOM.voiceIcon = document.getElementById('voiceIcon');
    
    // Initialize dark mode from localStorage
    initDarkMode();
    
    // Initialize ChatGPT-style sidebar
    initSidebar();
    
    // Initialize conversation and bookmark systems
    loadBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
    
    // Initialize recent tools
    loadRecentTools();
    updateSidebarRecentTools();
    
    // Load venueProfile from localStorage FIRST
    if (currentUser) {
        const saved = localStorage.getItem('venueProfile_' + currentUser);
        if (saved) {
            venueProfile = JSON.parse(saved);
        }
    }
    
    // THEN update sidebar venue name
    updateSidebarVenueName();

    // Initialize Supabase
    const supabaseInitialized = initializeSupabase();
    if (!supabaseInitialized) {
        console.warn('‚ö†Ô∏è Supabase initialization failed - analytics will only save locally');
    }
    
    // ‚úÖ ATTEMPT AUTO-LOGIN BEFORE SHOWING ACCESS SCREEN
    const autoLoginSuccessful = attemptAutoLogin();    

    // Only start testimonial rotation if user is NOT auto-logged in
    if (!autoLoginSuccessful) {
        startTestimonialRotation();
    }
    
    console.log('‚úÖ DOM cache initialized');
    console.log('Fitzgerald HR Assistant loaded successfully ‚úì');
    console.log('All JavaScript fixes applied ‚úì');
});

// ========================================
// GLOBAL ERROR HANDLING
// ========================================

/**
 * Global error handler - catches all unhandled errors
 * Provides user feedback and prevents white screen of death
 */
window.addEventListener('error', function(event) {
    console.error('‚ùå Unhandled error:', event.error);
    console.error('Stack trace:', event.error?.stack);
    
    // Create error notification bar
    const errorBar = document.createElement('div');
    errorBar.id = 'global-error-bar';
    errorBar.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-4 z-[9999] shadow-lg';
    errorBar.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ö†Ô∏è</span>
                <div>
                    <p class="font-bold">An error occurred</p>
                    <p class="text-sm opacity-90">The page will reload automatically to fix this</p>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-white text-red-600 px-6 py-2 rounded-lg font-bold hover:bg-red-50 transition-all">
                Reload Now
            </button>
        </div>
    `;
    
    // Remove existing error bar if present
    const existingBar = document.getElementById('global-error-bar');
    if (existingBar) existingBar.remove();
    
    // Add to page
    document.body.prepend(errorBar);
    
    // Auto-reload after delay
    setTimeout(() => {
        console.log('Auto-reloading page after error...');
        location.reload();
    }, CONFIG.ERROR_DISPLAY_TIME);
    
    // Prevent default error handling
    event.preventDefault();
});

/**
 * Handles unhandled promise rejections
 */
window.addEventListener('unhandledrejection', function(event) {
    console.error('‚ùå Unhandled promise rejection:', event.reason);
    
    // Create user-friendly error message
    const message = event.reason?.message || 'An unexpected error occurred';
    alert(`‚ö†Ô∏è Error: ${message}\n\nPlease try again or contact support if the issue persists.`);
    
    // Prevent default handling
    event.preventDefault();
});

// ========================================
// TERMS OF SERVICE & PRIVACY POLICY FUNCTIONS
// ========================================

function showTermsOfService() {
    document.getElementById('termsModal').classList.remove('hidden');
    trackEvent('terms_of_service_viewed', { user: currentUser });
}

function closeTermsOfService() {
    document.getElementById('termsModal').classList.add('hidden');
}

function showPrivacyPolicy() {
    document.getElementById('privacyModal').classList.remove('hidden');
    trackEvent('privacy_policy_viewed', { user: currentUser });
}

function closePrivacyPolicy() {
    document.getElementById('privacyModal').classList.add('hidden');
}

// ========================================
// LEGAL ACCEPTANCE MODAL FUNCTIONS
// ========================================

/**
 * Shows legal acceptance modal on first use
 */
function showLegalAcceptanceModal() {
    const modal = document.getElementById('legalAcceptanceModal');
    const checkbox = document.getElementById('legalAcceptCheckbox');
    const acceptBtn = document.getElementById('acceptLegalButton');
    
    // Check if user has already accepted
    const hasAccepted = localStorage.getItem('legalTermsAccepted');
    
    if (hasAccepted === 'true') {
        console.log('‚úÖ User has already accepted legal terms');
        return false; // Don't show modal
    }
    
    console.log('‚ö†Ô∏è Showing legal acceptance modal (first use)');
    modal.classList.remove('hidden');
    
    // Enable accept button only when checkbox is checked
    checkbox.addEventListener('change', function() {
        acceptBtn.disabled = !this.checked;
    });
    
    trackEvent('legal_acceptance_modal_shown', { user: currentUser });
    return true;
}

/**
 * User accepts legal terms
 */
function acceptLegalTerms() {
    const checkbox = document.getElementById('legalAcceptCheckbox');
    
    if (!checkbox.checked) {
        alert('‚ö†Ô∏è Please check the box to confirm you understand and agree to the terms.');
        return;
    }
    
    // Store acceptance with timestamp
    const timestamp = new Date().toISOString();
    localStorage.setItem('legalTermsAccepted', 'true');
    localStorage.setItem('legalTermsAcceptedAt', timestamp);
    
    console.log('‚úÖ User accepted legal terms at:', timestamp);
    
    // Close modal
    document.getElementById('legalAcceptanceModal').classList.add('hidden');
    
    // Track acceptance
    trackEvent('legal_terms_accepted', { 
        user: currentUser,
        timestamp: timestamp,
        version: '1.0' // Version your terms so you can track if they change
    });
    
    // Log to Supabase for audit trail
    logLegalAcceptance(currentUser, timestamp);
}

/**
 * User declines legal terms
 */
function declineLegalTerms() {
    const confirmed = confirm(
        "‚ö†Ô∏è You must accept the terms to use this tool.\n\n" +
        "If you don't agree, you will be logged out.\n\n" +
        "Are you sure you want to decline?"
    );
    
    if (confirmed) {
        console.log('‚ùå User declined legal terms');
        
        trackEvent('legal_terms_declined', { user: currentUser });
        
        // Log them out
        alert('You have declined the terms. You will now be logged out.');
        logout();
    }
}

/**
 * Log legal acceptance to database for audit trail
 */
async function logLegalAcceptance(user, timestamp) {
    if (!supabaseClient) {
        console.warn('‚ö†Ô∏è Supabase not initialized - cannot log legal acceptance');
        return;
    }
    
    try {
        const { data, error } = await supabaseClient
            .from('legal_acceptances')
            .insert([{
                user_code: user,
                accepted_at: timestamp,
                terms_version: '1.0',
                ip_address: null, // Could add IP logging if needed
                user_agent: navigator.userAgent
            }]);
        
        if (error) {
            console.error('‚ùå Error logging legal acceptance:', error);
        } else {
            console.log('‚úÖ Legal acceptance logged to database');
        }
    } catch (err) {
        console.error('‚ùå Exception logging legal acceptance:', err);
    }
}

/**
 * Show Terms from acceptance modal (opens in new window context)
 */
function showTermsFromAcceptance() {
    // Open terms in background, keep acceptance modal in front
    const termsModal = document.getElementById('termsModal');
    termsModal.classList.remove('hidden');
    termsModal.style.zIndex = '55'; // Below acceptance modal (z-60)
}

/**
 * Show Privacy from acceptance modal
 */
function showPrivacyFromAcceptance() {
    const privacyModal = document.getElementById('privacyModal');
    privacyModal.classList.remove('hidden');
    privacyModal.style.zIndex = '55'; // Below acceptance modal (z-60)
}

window.addEventListener('DOMContentLoaded', function() {
    console.log('üß™ Testing html-docx-js library...');
    console.log('htmlDocx exists?', typeof htmlDocx);
    console.log('htmlDocx object:', htmlDocx);
    
    if (typeof htmlDocx !== 'undefined') {
        console.log('htmlDocx.asBlob exists?', typeof htmlDocx.asBlob);
        
        // Try the absolute simplest conversion
        const testHTML = '<html><body><p>Test</p></body></html>';
        try {
            const result = htmlDocx.asBlob(testHTML);
            console.log('‚úÖ Test conversion result:', result);
            console.log('‚úÖ Result type:', result?.type);
            console.log('‚úÖ Result size:', result?.size);
        } catch (e) {
            console.error('‚ùå Test conversion failed:', e);
        }
    }
    
    // ========================================
    // WEEK 2: INITIALIZE NEW FEATURES
    // ========================================
    
    // Initialize keyboard navigation
    initKeyboardNavigation();
    
    // Preload critical modals for better performance
    setTimeout(() => {
        preloadModals();
    }, 2000);
    
    // Show welcome toast (only once per session)
    if (!sessionStorage.getItem('welcomeShown')) {
        setTimeout(() => {
            showToast('Welcome! Press Ctrl+K to focus the message input anytime.', 'info', 5000);
            sessionStorage.setItem('welcomeShown', 'true');
        }, 1000);
    }
    
    // Add smooth fade-in to messages container
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        messagesContainer.style.opacity = '0';
        setTimeout(() => {
            messagesContainer.style.transition = 'opacity 0.5s';
            messagesContainer.style.opacity = '1';
        }, 100);
    }
});

</script>


<!-- Profile Modal -->
<div id="profileMenu" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50" onclick="if(event.target === this) closeProfileMenu();">
    <div class="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-amber-500 fade-in">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-amber-500">Profile</h2>
            <button onclick="closeProfileMenu()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        
        <!-- Venue Info -->
        <div class="mb-4 p-4 bg-slate-700/50 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">üè®</span>
                </div>
                <div>
                    <div class="font-semibold text-white" id="profileVenueName">Loading...</div>
                    <div class="text-xs text-slate-400" id="profileUserCode">Code: ...</div>
                </div>
            </div>
        </div>
        
        <div class="space-y-2">
            <button onclick="showVenueSettings(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">‚öôÔ∏è</span>
                <div>
                    <div class="font-semibold">Settings</div>
                    <div class="text-xs text-slate-400">Update venue information</div>
                </div>
            </button>
            
            <button onclick="toggleDarkMode(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">üåô</span>
                <div>
                    <div class="font-semibold">Dark Mode</div>
                    <div class="text-xs text-slate-400">Toggle light/dark theme</div>
                </div>
            </button>
            
            <button onclick="showFeedback(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">üìù</span>
                <div>
                    <div class="font-semibold">Give Feedback</div>
                    <div class="text-xs text-slate-400">Help us improve</div>
                </div>
            </button>
            
            <div class="border-t border-slate-700 my-2"></div>
            
            <button onclick="showTermsOfService(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">üìÑ</span>
                <div>
                    <div class="font-semibold">Terms of Service</div>
                    <div class="text-xs text-slate-400">View legal terms</div>
                </div>
            </button>
            
            <button onclick="showPrivacyPolicy(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">üîí</span>
                <div>
                    <div class="font-semibold">Privacy Policy</div>
                    <div class="text-xs text-slate-400">How we protect your data</div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Tools Modal - Same Structure as Settings Modal -->
<div id="toolsMenu" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üõ†Ô∏è</span> Tools
                </h2>
                <p class="text-slate-400 text-sm">Choose a tool to help with your HR tasks</p>
            </div>
            <button onclick="closeToolsMenu()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Tools Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="openDocumentBuilder(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üìù</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Document Builder</div>
                        <div class="text-sm text-slate-400">Create professional HR documents</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openAwardCalculator(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üí∞</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Award Calculator</div>
                        <div class="text-sm text-slate-400">Calculate award rates & penalties</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openScenarioAnalysis(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üéØ</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Scenario Analysis</div>
                        <div class="text-sm text-slate-400">Analyze complex HR scenarios</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openRosterStressTester(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üîç</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Roster Stress Test</div>
                        <div class="text-sm text-slate-400">Check roster compliance</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openAwardWizard(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üßô</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Award Wizard</div>
                        <div class="text-sm text-slate-400">Find the right award</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openRosterOptimizer(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üìÖ</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Roster Optimizer</div>
                        <div class="text-sm text-slate-400">Optimize staff scheduling</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openComplianceCalendar(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üìÜ</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Compliance Calendar</div>
                        <div class="text-sm text-slate-400">Track important dates</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openTerminationRisk(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Termination Risk</div>
                        <div class="text-sm text-slate-400">Assess termination risks</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openRecruitmentToolkit(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">üéØ</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Recruitment Toolkit</div>
                        <div class="text-sm text-slate-400">Job descriptions, interviews & reference checks</div>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Reference Check Form Modal -->
<div id="referenceCheckModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìã</span> Reference Check Form
                </h2>
                <p class="text-slate-400 text-sm">Complete the form to generate a professional reference check document</p>
            </div>
            <button onclick="closeReferenceCheck()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div class="space-y-6">
            <!-- Candidate Information -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Candidate Information</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Candidate Name *</label>
                        <input type="text" id="rcCandidateName" placeholder="Full name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Position Applied For *</label>
                        <input type="text" id="rcPosition" placeholder="e.g., Head Chef" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Referee Information -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Referee Information</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Referee Name *</label>
                        <input type="text" id="rcRefereeName" placeholder="Full name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Relationship to Candidate *</label>
                        <input type="text" id="rcRelationship" placeholder="e.g., Direct Manager" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Company/Organization *</label>
                        <input type="text" id="rcCompany" placeholder="Company name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Contact Phone</label>
                        <input type="tel" id="rcPhone" placeholder="Phone number" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Employment Period -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Employment Period</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Start Date</label>
                        <input type="text" id="rcStartDate" placeholder="MM/YYYY" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">End Date</label>
                        <input type="text" id="rcEndDate" placeholder="MM/YYYY or 'Present'" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <p class="text-blue-400 text-sm">
                    üìã The generated form will include:
                </p>
                <ul class="text-slate-400 text-sm mt-2 space-y-1 ml-4">
                    <li>‚Ä¢ Standard reference check questions</li>
                    <li>‚Ä¢ Performance rating scales</li>
                    <li>‚Ä¢ Red flag indicators</li>
                    <li>‚Ä¢ Legal compliance notes</li>
                    <li>‚Ä¢ Signature and date fields</li>
                </ul>
            </div>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="generateReferenceCheck()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                ‚ú® Generate Reference Check Form
            </button>
        </div>
    </div>
</div>

<!-- Reference Check Preview Modal -->
<div id="referenceCheckPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">üìã Reference Check Form</h2>
            <button onclick="closeReferenceCheckPreview()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div id="rcPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6">
            <!-- Content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadReferenceCheck('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                üìï Download PDF
            </button>
            <button onclick="closeReferenceCheckPreview(); openReferenceCheckForm();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ‚Üê Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Interview Questions Generator Modal -->
<div id="interviewQuestionsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üí¨</span> Interview Questions Generator
                </h2>
                <p class="text-slate-400 text-sm">Step <span id="iqStep">1</span> of 4</p>
            </div>
            <button onclick="closeInterviewQuestions()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Loading Screen -->
        <div id="iqGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ü§ñ</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your interview questions...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>

        <!-- Steps Container -->
        <div id="iqBuilderSteps">
        <!-- Step 1: Job Title -->
        <div id="iqStep1" class="step-content">
            <h3 class="text-xl font-semibold text-white mb-4">What position are you interviewing for?</h3>
            <input type="text" id="iqJobTitle" placeholder="e.g., Head Chef, Restaurant Manager" 
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
        </div>

        <!-- Step 2: Experience Level -->
        <div id="iqStep2" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Experience level required?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="selectIQExperience('entry')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Entry Level</div>
                    <div class="text-sm text-slate-400">0-2 years experience</div>
                </button>
                <button onclick="selectIQExperience('mid')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Mid Level</div>
                    <div class="text-sm text-slate-400">2-5 years experience</div>
                </button>
                <button onclick="selectIQExperience('senior')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Senior Level</div>
                    <div class="text-sm text-slate-400">5+ years experience</div>
                </button>
            </div>
        </div>

        <!-- Step 3: Question Categories -->
        <div id="iqStep3" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Select question categories</h3>
            <p class="text-slate-400 text-sm mb-4">üí° AI recommends including all three for a comprehensive interview</p>
            <div class="space-y-3">
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqTechnical" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Technical Questions</div>
                        <div class="text-sm text-slate-400">Role-specific skills and knowledge</div>
                    </div>
                </label>
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqBehavioral" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Behavioral Questions</div>
                        <div class="text-sm text-slate-400">Past experiences and decision-making (STAR method)</div>
                    </div>
                </label>
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqSituational" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Situational Questions</div>
                        <div class="text-sm text-slate-400">Hypothetical scenarios and problem-solving</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Step 4: Number of Questions -->
        <div id="iqStep4" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">How many questions do you need?</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="selectIQCount(10)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all text-center">
                    <div class="text-3xl font-bold text-white">10</div>
                    <div class="text-sm text-slate-400 mt-1">Quick interview</div>
                </button>
                <button onclick="selectIQCount(15)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-amber-500 transition-all text-center">
                    <div class="text-3xl font-bold text-white">15</div>
                    <div class="text-sm text-slate-400 mt-1">Recommended</div>
                </button>
                <button onclick="selectIQCount(20)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all text-center">
                    <div class="text-3xl font-bold text-white">20</div>
                    <div class="text-sm text-slate-400 mt-1">Comprehensive</div>
                </button>
            </div>
        </div>
        </div><!-- End iqBuilderSteps -->

        <!-- Navigation -->
        <div class="flex gap-3 mt-6">
            <button onclick="iqPreviousStep()" id="iqBackBtn" class="hidden px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ‚Üê Back
            </button>
            <button onclick="iqNextStep()" id="iqNextBtn" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors">
                Next Step ‚Üí
            </button>
            <button onclick="generateInterviewQuestions()" id="iqGenerateBtn" class="hidden px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                ‚ú® Generate Questions
            </button>
        </div>
    </div>
</div>

<!-- Interview Questions Preview Modal -->
<div id="interviewQuestionsPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">üí¨ Interview Questions</h2>
            <button onclick="closeInterviewQuestionsPreview()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div id="iqPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6">
            <!-- AI-generated content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadInterviewQuestions('docx')" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                üìÑ Download DOCX
            </button>
            <button onclick="downloadInterviewQuestions('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                üìï Download PDF
            </button>
            <button onclick="closeInterviewQuestionsPreview(); openInterviewQuestionsGenerator();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ‚Üê Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Job Description Builder Modal -->
<div id="jobDescriptionBuilderModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìù</span> Job Description Builder
                </h2>
                <p class="text-slate-400 text-sm">Step <span id="jdStep">1</span> of 5</p>
            </div>
            <button onclick="closeJobDescriptionBuilder()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Loading Screen -->
        <div id="jdGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ü§ñ</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your job description...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>

        <!-- Steps Container -->
        <div id="jdBuilderSteps">
        <!-- Step 1: Job Title -->
        <div id="jdStep1" class="step-content">
            <h3 class="text-xl font-semibold text-white mb-4">What's the job title?</h3>
            <input type="text" id="jdJobTitle" placeholder="e.g., Head Chef, Restaurant Manager, Bartender" 
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
            <p class="text-slate-400 text-sm mt-2">üí° Be specific - AI will tailor the description to this role</p>
        </div>

        <!-- Step 2: Experience Level -->
        <div id="jdStep2" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">What experience level are you looking for?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="selectJDExperience('entry')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Entry Level (0-2 years)</div>
                    <div class="text-sm text-slate-400 mt-1">Junior positions, minimal experience required</div>
                </button>
                <button onclick="selectJDExperience('mid')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Mid Level (2-5 years)</div>
                    <div class="text-sm text-slate-400 mt-1">Experienced professionals with proven track record</div>
                </button>
                <button onclick="selectJDExperience('senior')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Senior Level (5+ years)</div>
                    <div class="text-sm text-slate-400 mt-1">Leadership roles, extensive experience required</div>
                </button>
            </div>
        </div>

        <!-- Step 3: AI-Suggested Key Responsibilities -->
        <div id="jdStep3" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Review & Edit Key Responsibilities</h3>
            <p class="text-slate-400 text-sm mb-4">AI has suggested these responsibilities. Edit as needed:</p>
            <div id="jdResponsibilitiesLoading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
                <p class="text-slate-400 mt-4">AI is generating key responsibilities...</p>
            </div>
            <textarea id="jdResponsibilities" class="hidden w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500" rows="8"></textarea>
            <p class="text-slate-400 text-sm mt-2 hidden" id="jdResponsibilitiesHelp">‚úèÔ∏è Edit, add, or remove responsibilities as needed</p>
        </div>

        <!-- Step 4: Qualifications -->
        <div id="jdStep4" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Required Qualifications</h3>
            <p class="text-slate-400 text-sm mb-4">What qualifications are required?</p>
            <textarea id="jdQualifications" placeholder="e.g.,&#10;- Certificate III in Commercial Cookery&#10;- Current RSA certificate&#10;- Food safety certification" 
                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500" rows="6"></textarea>
            <p class="text-slate-400 text-sm mt-2">üí° List essential qualifications, certifications, and licenses</p>
        </div>

        <!-- Step 5: Salary Range (Award Calculator Integration) -->
        <div id="jdStep5" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Salary Range</h3>
            <p class="text-slate-400 text-sm mb-4">Select the award and classification:</p>
            
            <div class="mb-4">
                <label class="block text-slate-300 text-sm mb-2">Award</label>
                <select id="jdAward" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option value="">Select Award...</option>
                    <option value="restaurant">Restaurant Industry Award</option>
                    <option value="hospitality">Hospitality Industry (General) Award</option>
                    <option value="fast-food">Fast Food Industry Award</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-slate-300 text-sm mb-2">Classification Level</label>
                <select id="jdClassification" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option value="">Select Classification...</option>
                    <option value="1">Level 1 - Introductory</option>
                    <option value="2">Level 2 - Tradesperson/Supervisor</option>
                    <option value="3">Level 3 - Manager/Senior</option>
                </select>
            </div>
            
            <div id="jdSalaryDisplay" class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 hidden">
                <div class="text-amber-400 font-semibold mb-2">Calculated Salary Range:</div>
                <div class="text-white text-2xl font-bold" id="jdSalaryRange">$XX,XXX - $XX,XXX per year</div>
                <div class="text-slate-400 text-sm mt-2">Based on current award rates + penalties</div>
            </div>
        </div>
        </div><!-- End jdBuilderSteps -->

        <!-- Navigation Buttons -->
        <div class="flex gap-3 mt-6">
            <button onclick="jdPreviousStep()" id="jdBackBtn" class="hidden px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ‚Üê Back
            </button>
            <button onclick="jdNextStep()" id="jdNextBtn" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors">
                Next Step ‚Üí
            </button>
            <button onclick="generateJobDescription()" id="jdGenerateBtn" class="hidden px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                ‚ú® Generate Job Description
            </button>
        </div>
    </div>
</div>

<!-- Job Description Preview Modal -->
<div id="jobDescriptionPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">üìù Your Job Description</h2>
            <button onclick="closeJobDescriptionPreview()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div id="jdPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6 prose prose-invert max-w-none">
            <!-- AI-generated content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadJobDescription('docx')" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                üìÑ Download DOCX
            </button>
            <button onclick="downloadJobDescription('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                üìï Download PDF
            </button>
            <button onclick="closeJobDescriptionPreview(); openJobDescriptionBuilder();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ‚Üê Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Recruitment Toolkit Modal -->
<div id="recruitmentToolkitModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üéØ</span> Recruitment Toolkit
                </h2>
                <p class="text-slate-400 text-sm">Choose a recruitment tool to help with hiring</p>
            </div>
            <button onclick="closeRecruitmentToolkit()" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Sub-tools Grid -->
        <div class="grid grid-cols-1 gap-4">
            <button onclick="openJobDescriptionBuilder(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">üìù</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Job Description Builder</div>
                        <div class="text-sm text-slate-400 mb-3">Create professional job descriptions with AI-powered content, award-based salary ranges, and downloadable formats</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Award Integration</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
            
            <button onclick="openInterviewQuestionsGenerator(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">üí¨</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Interview Questions Generator</div>
                        <div class="text-sm text-slate-400 mb-3">Generate customized interview questions with STAR method examples, red flags, and what to look for in answers</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">STAR Method</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
            
            <button onclick="openReferenceCheckForm(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">üìã</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Reference Check Form</div>
                        <div class="text-sm text-slate-400 mb-3">Professional reference check form with standard questions, rating scales, and compliance notes</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Pre-filled</span>
                            <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">Red Flags</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">PDF</span>
                        </div>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

</body>
</html>


