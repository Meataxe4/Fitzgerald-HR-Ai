<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitzgerald HR Assistant - Beta Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CRITICAL: checkAccess function in head -->
    <script>
    function checkAccess() {
        const input = document.getElementById('accessCodeInput');
        const error = document.getElementById('accessError');
        
        if (!input || !error) {
            console.error('Elements not found yet');
            return;
        }
        
        const value = input.value.trim().toUpperCase();
        
        const VALID_CODES = [
            'BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003',
            'BETA-VENUE-004', 'BETA-VENUE-005',
            'FITZGERALD-TEST', 'DEMO-2025'
        ];
        
        if (VALID_CODES.includes(value)) {
            window.currentUser = value;
            document.getElementById('userCode').textContent = value;
            document.getElementById('accessScreen').classList.add('hidden');
            document.getElementById('assistantScreen').classList.remove('hidden');
            error.classList.add('hidden');
            console.log('‚úÖ Access granted:', value);
        } else {
            error.textContent = 'Invalid access code. Please check and try again.';
            error.classList.remove('hidden');
        }
    }
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    
    <!-- Access Code Screen -->
    <div id="accessScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <div class="inline-block bg-gradient-to-r from-amber-500 to-orange-600 p-1 rounded-2xl mb-4">
                    <div class="bg-slate-900 px-8 py-4 rounded-xl">
                        <h1 class="text-3xl font-bold text-amber-500">FITZGERALD HR</h1>
                        <p class="text-slate-400 text-sm mt-1">AI-Powered Hospitality HR</p>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Beta Testing Programme</h2>
                <p class="text-slate-400">Thank you for helping us test Australia's first AI-powered hospitality HR assistant</p>
            </div>

            <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700">
                <label class="block text-slate-300 font-medium mb-3">Enter Your Access Code</label>
                <input 
                    type="text" 
                    id="accessCodeInput"
                    placeholder="e.g., BETA-VENUE-001"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 transition-all"
                    onkeypress="if(event.key==='Enter') checkAccess();"
                />
                <button 
                    onclick="checkAccess()"
                    class="w-full mt-4 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105"
                >
                    Access Beta
                </button>
                <p id="accessError" class="text-red-400 text-sm mt-3 hidden"></p>
                
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <p class="text-slate-500 text-xs text-center">
                        Don't have an access code? Contact us at<br/>
                        <a href="mailto:beta@fitzgeraldhr.com.au" class="text-amber-500 hover:underline">beta@fitzgeraldhr.com.au</a>
                    </p>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-3 gap-4">
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">ü§ñ</div>
                    <p class="text-slate-400 text-xs">AI-Powered Guidance</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">üá¶üá∫</div>
                    <p class="text-slate-400 text-xs">Australian Hospitality</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">‚ö°</div>
                    <p class="text-slate-400 text-xs">24/7 Available</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Assistant Screen -->
    <div id="assistantScreen" class="hidden min-h-screen flex flex-col">
        <div class="bg-slate-800/80 backdrop-blur-sm border-b border-slate-700 px-6 py-4">
            <div class="max-w-5xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                        <span class="text-xl">üè®</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Fitz - Your HR Assistant</h1>
                        <p class="text-xs text-slate-400">Beta Testing - <span id="userCode"></span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="activateCrisisMode()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all flex items-center gap-2">
                        <span class="text-xl">üö®</span>
                        <span>URGENT</span>
                    </button>
                    
                    <button onclick="toggleVoiceInput()" 
                            id="voiceButton"
                            class="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        <span id="voiceIcon">üé§</span>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleToolsMenu()" 
                                class="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                            <span>üõ†Ô∏è</span>
                        </button>
                        <div id="toolsMenu" class="hidden absolute right-0 top-12 bg-slate-800 border border-slate-700 rounded-lg shadow-xl w-64 z-50">
                            <div class="p-2">
                                <button onclick="openTool('awardWizard')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>üßô</span><span>Award Wizard</span>
                                </button>
                                <button onclick="openTool('rosterStressTester')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>üîç</span><span>Roster Stress Test</span>
                                </button>
                                <button onclick="openTool('complianceCalendar')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>üìÖ</span><span>Compliance Calendar</span>
                                </button>
                                <button onclick="openTool('awardCalculator')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>üí∞</span><span>Award Calculator</span>
                                </button>
                                <button onclick="openTool('rosterOptimizer')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>üìã</span><span>Roster Optimiser</span>
                                </button>
                                <button onclick="openTool('terminationRisk')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                                    <span>‚öñÔ∏è</span><span>Termination Risk</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="showFeedback()" class="text-amber-500 hover:text-amber-400 text-sm font-medium transition-colors">
                        Give Feedback
                    </button>
                    <button onclick="location.reload()" class="text-slate-400 hover:text-white text-sm transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-amber-500/10 border-b border-amber-500/20 px-6 py-3">
            <div class="max-w-5xl mx-auto flex items-center gap-3">
                <span class="text-lg">‚ö†Ô∏è</span>
                <p class="text-amber-200 text-sm">
                    <strong>Beta Test:</strong> This is a preview. Please share honest feedback on your experience!
                </p>
            </div>
        </div>

        <div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-6">
            <div class="max-w-5xl mx-auto space-y-6">
                <div class="flex justify-start">
                    <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
                        <p class="text-slate-100 leading-relaxed">G'day! I'm Fitz, your AI assistant from Fitzgerald HR, specialised in hospitality HR for Australian venues.</p>
                        <p class="text-slate-100 leading-relaxed mt-3">I can help you with Fair Work compliance, award interpretation, employee relations, recruitment advice, and more.</p>
                        <p class="text-slate-100 text-sm mt-4">üí° <strong>Tip:</strong> I have 8 specialized tools (click üõ†Ô∏è above). I'll suggest the right ones as we talk, or browse them anytime.</p>
                        <p class="text-red-400 font-semibold mt-4 mb-2">üö® Urgent/Critical Situations:</p>
                        <p class="text-slate-100 text-sm">Use the red URGENT button for immediate crisis response.</p>
                        <p class="text-slate-100 leading-relaxed mt-4">What HR challenge can I help you with today?</p>
                        <p class="text-slate-300 text-sm mt-4">‚úâÔ∏è For personalised support, contact our Senior Consultants at <a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/30 border-t border-slate-700/50 px-6 py-3">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-start gap-2 text-xs text-slate-400 mb-2">
                    <span class="text-amber-500">‚ö†Ô∏è</span>
                    <p>This AI assistant provides general guidance only. For complex matters or legal advice, consult with a Senior Fitzgerald HR Consultant.</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-300">
                        <span class="text-amber-500 font-semibold">Contact us:</span> info@fitzgeraldhr.com.au
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/80 backdrop-blur-sm border-t border-slate-700 px-6 py-4">
            <div class="max-w-5xl mx-auto flex gap-3">
                <textarea
                    id="messageInput"
                    placeholder="Ask me anything about hospitality HR in Australia..."
                    class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500 resize-none"
                    rows="2"
                    onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                ></textarea>
                <button
                    onclick="sendMessage()"
                    id="sendButton"
                    class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-medium rounded-lg transition-colors flex items-center gap-2"
                >
                    <span>Send</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-slate-700 fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Beta Feedback</h2>
            <p class="text-slate-400 mb-6">Your feedback helps us build the best AI assistant for hospitality HR. Thank you!</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">What did you like?</label>
                    <textarea id="feedbackLikes" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" rows="3"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What could be improved?</label>
                    <textarea id="feedbackImprove" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" rows="3"></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="submitFeedback()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                    Submit Feedback
                </button>
                <button onclick="closeFeedback()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Crisis Mode Modal -->
    <div id="crisisModal" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-4 border-red-500 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">üö®</div>
                <h2 class="text-3xl font-bold text-red-400 mb-2">CRISIS MODE ACTIVATED</h2>
                <p class="text-slate-300">Emergency HR support - Immediate response</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">What's the urgent situation?</label>
                    <select id="crisisType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white">
                        <option value="">Select crisis type...</option>
                        <option value="injury">Workplace Injury</option>
                        <option value="harassment">Sexual Harassment / Bullying</option>
                        <option value="theft">Theft / Serious Misconduct</option>
                        <option value="violence">Workplace Violence / Threat</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Describe what happened:</label>
                    <textarea id="crisisDescription" rows="4" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                              placeholder="Provide details: who, what, when, where..."></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Your contact number:</label>
                    <input type="tel" id="crisisPhone" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                           placeholder="04XX XXX XXX">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="submitCrisis()" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all text-lg">
                    üö® GET URGENT HELP NOW
                </button>
                <button onclick="closeCrisisModal()" 
                        class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Award Wizard Modal -->
    <div id="awardWizardModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üßô</span> Award Wizard
                    </h2>
                    <p class="text-slate-400 text-sm">Find the right award classification and pay rate</p>
                </div>
                <button onclick="closeToolModal('awardWizardModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
                <p class="text-slate-200 mb-4">The Award Wizard helps you determine the correct classification and pay rate for your employees based on:</p>
                <ul class="text-slate-300 text-sm space-y-2 ml-4">
                    <li>‚Ä¢ Venue type (restaurant, caf√©, hotel, etc.)</li>
                    <li>‚Ä¢ Employee role and responsibilities</li>
                    <li>‚Ä¢ Experience level</li>
                    <li>‚Ä¢ Working hours (weekdays, weekends, public holidays)</li>
                    <li>‚Ä¢ Employment type (casual, part-time, full-time)</li>
                </ul>
                <button onclick="alert('Award Wizard interactive flow would start here')" 
                        class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Start Award Wizard
                </button>
            </div>
        </div>
    </div>

    <!-- Award Calculator Modal -->
    <div id="awardCalculatorModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">üí∞ Award Rate Calculator</h2>
                    <p class="text-slate-400 text-sm">Calculate exact pay with penalties</p>
                </div>
                <button onclick="closeToolModal('awardCalculatorModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
                <p class="text-slate-200">Quick calculator for penalty rates, overtime, and loadings.</p>
                <button onclick="alert('Calculator form would appear here')" 
                        class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Open Calculator
                </button>
            </div>
        </div>
    </div>

    <!-- Roster Optimizer Modal -->
    <div id="rosterOptimizerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">üìã Roster Cost Optimizer</h2>
                </div>
                <button onclick="closeToolModal('rosterOptimizerModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
                <p class="text-slate-200">Upload your roster to analyze costs and find optimization opportunities.</p>
            </div>
        </div>
    </div>

    <!-- Termination Risk Modal -->
    <div id="terminationRiskModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">‚öñÔ∏è Termination Risk Assessor</h2>
                </div>
                <button onclick="closeToolModal('terminationRiskModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
                <p class="text-slate-200">Assess unfair dismissal risk before terminating employment.</p>
            </div>
        </div>
    </div>

    <!-- Roster Stress Tester Modal -->
    <div id="rosterStressTesterModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">üîç Roster Stress Test</h2>
                </div>
                <button onclick="closeToolModal('rosterStressTesterModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
                <p class="text-slate-200">Upload or describe your roster to find compliance risks.</p>
            </div>
        </div>
    </div>

    <!-- Compliance Calendar Modal -->
    <div id="complianceCalendarModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">üìÖ Compliance Calendar</h2>
                    <p class="text-slate-400 text-sm">Upcoming deadlines & important dates</p>
                </div>
                <button onclick="closeToolModal('complianceCalendarModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                    <p class="font-bold text-red-400">URGENT: Award Rate Increase</p>
                    <p class="text-sm text-slate-300 mt-1">Hospitality Award rates increase on 1 July 2026</p>
                </div>

                <div class="bg-slate-900 rounded-lg p-6">
                    <h3 class="text-white font-bold mb-4">üìÖ Upcoming Dates 2026</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span class="text-slate-300">1 January 2026</span>
                            <span class="text-amber-400">New Year's Day</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span class="text-slate-300">27 January 2026</span>
                            <span class="text-amber-400">Australia Day</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span class="text-slate-300">18 April 2026</span>
                            <span class="text-amber-400">Good Friday</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span class="text-slate-300">25 April 2026</span>
                            <span class="text-amber-400">ANZAC Day</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span class="text-slate-300">25 December 2026</span>
                            <span class="text-amber-400">Christmas Day</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Global state
let currentUser = null;
let conversationHistory = [];
let isListening = false;
let recognition = null;

// Configuration
const CONFIG = {
    API: {
        CHAT_ENDPOINT: '/.netlify/functions/chat',
        CRISIS_ENDPOINT: '/.netlify/functions/telegram-crisis'
    }
};

// Tools Menu
function toggleToolsMenu() {
    document.getElementById('toolsMenu').classList.toggle('hidden');
}

function openTool(toolName) {
    toggleToolsMenu();
    const modalMap = {
        'awardWizard': 'awardWizardModal',
        'awardCalculator': 'awardCalculatorModal',
        'rosterOptimizer': 'rosterOptimizerModal',
        'terminationRisk': 'terminationRiskModal',
        'rosterStressTester': 'rosterStressTesterModal',
        'complianceCalendar': 'complianceCalendarModal'
    };
    const modalId = modalMap[toolName];
    if (modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }
}

function closeToolModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Crisis Mode
function activateCrisisMode() {
    document.getElementById('crisisModal').classList.remove('hidden');
}

function closeCrisisModal() {
    document.getElementById('crisisModal').classList.add('hidden');
}

async function submitCrisis() {
    const type = document.getElementById('crisisType').value;
    const description = document.getElementById('crisisDescription').value;
    const phone = document.getElementById('crisisPhone').value;

    if (!type || !description || !phone) {
        alert('Please fill in all fields');
        return;
    }

    alert('üö® URGENT ALERT SENT\n\nA consultant will call you at ' + phone + ' within 15 minutes.\n\nIn production, this would send to: ' + CONFIG.API.CRISIS_ENDPOINT);
    closeCrisisModal();
}

// Feedback
function showFeedback() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedback() {
    document.getElementById('feedbackModal').classList.add('hidden');
}

function submitFeedback() {
    const likes = document.getElementById('feedbackLikes').value;
    const improve = document.getElementById('feedbackImprove').value;
    
    alert('‚úì Thank you for your feedback!\n\nLikes: ' + likes + '\nImprove: ' + improve);
    closeFeedback();
}

// Voice Input
function toggleVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Voice input not supported in your browser. Try Chrome or Edge.');
        return;
    }
    
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
}

function startListening() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-AU';

    recognition.onstart = () => {
        isListening = true;
        document.getElementById('voiceIcon').textContent = 'üî¥';
        document.getElementById('voiceButton').classList.add('bg-red-600');
    };

    recognition.onresult = (event) => {
        const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
        document.getElementById('messageInput').value = transcript;
    };

    recognition.onerror = () => stopListening();
    recognition.onend = () => stopListening();
    recognition.start();
}

function stopListening() {
    if (recognition) recognition.stop();
    isListening = false;
    document.getElementById('voiceIcon').textContent = 'üé§';
    document.getElementById('voiceButton').classList.remove('bg-red-600');
}

// Messaging
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessage('user', message);
    input.value = '';
    
    const thinkingDiv = showThinkingIndicator();
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await callClaudeAPI(message);
        removeThinkingIndicator(thinkingDiv);
        addMessage('assistant', response);
        conversationHistory.push({ role: 'assistant', content: response });
    } catch (error) {
        removeThinkingIndicator(thinkingDiv);
        addMessage('assistant', 'Sorry, I encountered an error. Please try again or contact support at info@fitzgeraldhr.com.au');
        console.error('Error:', error);
    }
}

function showThinkingIndicator() {
    const container = document.getElementById('messagesContainer').querySelector('.space-y-6');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = 'thinking-indicator';
    thinkingDiv.className = 'flex justify-start fade-in';
    thinkingDiv.innerHTML = `
        <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-400 text-sm">Fitz is thinking...</p>
            </div>
        </div>
    `;
    container.appendChild(thinkingDiv);
    thinkingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    return thinkingDiv;
}

function removeThinkingIndicator(thinkingDiv) {
    if (thinkingDiv && thinkingDiv.parentNode) {
        thinkingDiv.parentNode.removeChild(thinkingDiv);
    }
}

function addMessage(role, content) {
    const container = document.getElementById('messagesContainer').querySelector('.space-y-6');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
    
    let formattedContent = content;
    if (role === 'assistant') {
        formattedContent = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
    }
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl ${role === 'user' ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-100 border border-slate-700'} rounded-2xl px-6 py-4">
            <p class="leading-relaxed whitespace-pre-wrap">${formattedContent}</p>
        </div>
    `;
    
    container.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

async function callClaudeAPI(message) {
    try {
        const response = await fetch(CONFIG.API.CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: conversationHistory.filter(m => m.role !== 'system'),
                user: currentUser
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to get response');
        }

        const data = await response.json();
        return data.message;
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// Close tools menu when clicking outside
document.addEventListener('click', function(event) {
    const toolsMenu = document.getElementById('toolsMenu');
    const toolsButton = event.target.closest('button');
    
    if (toolsMenu && !toolsMenu.contains(event.target) && 
        (!toolsButton || !toolsButton.onclick?.toString().includes('toggleToolsMenu'))) {
        toolsMenu.classList.add('hidden');
    }
});

console.log('‚úÖ Fitzgerald HR Assistant loaded successfully');
console.log('‚úÖ All features active: Chat, Tools, Crisis Mode, Voice Input');
</script>

</body>
</html>
