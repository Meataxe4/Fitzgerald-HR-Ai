<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitzgerald HR Assistant - Beta Test</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- WEEK 3: Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <!-- Word Document Generation - âœ… USING JSDELIVR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
    
    <!-- Excel/Spreadsheet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    
    <!-- Stripe.js for Payments -->
    <script src="https://js.stripe.com/v3/"></script>
 
 <style>

/* ========================================
   DARK MODE SYSTEM
   ======================================== */

/* CSS Variables for Theme Colors */
:root {
    /* Dark Mode (Default) */
    --bg-primary: #0f172a;      /* slate-900 */
    --bg-secondary: #1e293b;    /* slate-800 */
    --bg-tertiary: #334155;     /* slate-700 */
    --text-primary: #ffffff;
    --text-secondary: #cbd5e1;  /* slate-300 */
    --text-tertiary: #94a3b8;   /* slate-400 */
    --border-color: #475569;    /* slate-600 */
    --accent-color: #f59e0b;    /* amber-500 */
    --accent-hover: #d97706;    /* amber-600 */
}

/* Light Mode Variables */
.light-mode {
    --bg-primary: #f8fafc;      /* slate-50 */
    --bg-secondary: #f1f5f9;    /* slate-100 */
    --bg-tertiary: #e2e8f0;     /* slate-200 */
    --text-primary: #0f172a;    /* slate-900 */
    --text-secondary: #334155;  /* slate-700 */
    --text-tertiary: #64748b;   /* slate-500 */
    --border-color: #cbd5e1;    /* slate-300 */
    --accent-color: #f59e0b;    /* amber-500 */
    --accent-hover: #d97706;    /* amber-600 */
}

/* Smooth transitions for theme changes */
body, 
.bg-slate-900, .bg-slate-800, .bg-slate-700,
.text-white, .text-slate-300, .text-slate-400,
.border-slate-700, .border-slate-600 {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* Light mode overrides for body */
body.light-mode {
    background: linear-gradient(to bottom right, #f8fafc, #f1f5f9, #f8fafc) !important;
}

/* Light mode text adjustments - ULTRA BOLD & CLEAR */
.light-mode .text-white { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-100 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-200 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-300 { color: #000000 !important; font-weight: 500; }
.light-mode .text-slate-400 { color: #1f2937 !important; font-weight: 500; }
.light-mode .text-slate-500 { color: #374151 !important; }
.light-mode .text-slate-600 { color: #1f2937 !important; }

/* Light mode backgrounds - CRISP WHITE */
.light-mode .bg-slate-900 { 
    background-color: #ffffff !important;
}
.light-mode .bg-slate-800 { 
    background-color: #ffffff !important; 
    border: 2px solid #d1d5db !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
}
.light-mode .bg-slate-700 { 
    background-color: #f9fafb !important;
    border: 2px solid #e5e7eb !important;
}
.light-mode .bg-slate-600 { background-color: #e5e7eb !important; }

/* Light mode borders - STRONG & VISIBLE */
.light-mode .border-slate-700 { border-color: #9ca3af !important; border-width: 2px !important; }
.light-mode .border-slate-600 { border-color: #d1d5db !important; border-width: 2px !important; }

/* Chat messages - CRYSTAL CLEAR */
.light-mode #messagesContainer .bg-slate-700 {
    background-color: #ffffff !important;
    border: 2px solid #d1d5db !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

.light-mode #messagesContainer .bg-slate-800 {
    background-color: #f9fafb !important;
    border: 2px solid #e5e7eb !important;
}

/* Force ALL text to be BOLD BLACK */
.light-mode #messagesContainer,
.light-mode #messagesContainer p,
.light-mode #messagesContainer span,
.light-mode #messagesContainer div,
.light-mode #messagesContainer li,
.light-mode #messagesContainer strong {
    color: #000000 !important;
    font-weight: 500 !important;
}

/* REDESIGNED: VIBRANT suggestion boxes - CLEAR & BOLD */
.light-mode .bg-amber-500\/10,
.light-mode .bg-yellow-500\/10,
.light-mode .bg-amber-100 {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
    border: 2px solid #3b82f6 !important;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    padding: 16px !important;
}

/* BOLD blue text in suggestion boxes */
.light-mode .bg-amber-500\/10 *,
.light-mode .bg-yellow-500\/10 * {
    color: #1e3a8a !important;
    font-weight: 600 !important;
    font-size: 0.95rem !important;
}

/* VIBRANT Daily Tip Bar - IMPOSSIBLE TO MISS */
.light-mode .bg-blue-500\/10 {
    background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%) !important;
    border: 2px solid #2563eb !important;
    border-left: 6px solid #2563eb !important;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15), 0 2px 4px 0 rgba(0, 0, 0, 0.1);
}

/* Daily Tip text - BOLD & CLEAR */
.light-mode .bg-blue-500\/10 * {
    color: #1e3a8a !important;
    font-weight: 600 !important;
}

/* Professional alert boxes - VIBRANT */
.light-mode .bg-red-500\/10 {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
    border: 2px solid #ef4444 !important;
    border-left: 6px solid #ef4444 !important;
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
}

.light-mode .bg-green-500\/10 {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
    border: 2px solid #10b981 !important;
    border-left: 6px solid #10b981 !important;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
}

/* VIBRANT colored text - BOLD & CLEAR */
.light-mode .text-red-300,
.light-mode .text-red-400 {
    color: #dc2626 !important;
    font-weight: 700 !important;
}

.light-mode .text-amber-400,
.light-mode .text-amber-500,
.light-mode .text-orange-400,
.light-mode .text-orange-500 {
    color: #ea580c !important;
    font-weight: 700 !important;
}

.light-mode .text-green-300,
.light-mode .text-green-400,
.light-mode .text-green-500 {
    color: #16a34a !important;
    font-weight: 700 !important;
}

.light-mode .text-blue-300,
.light-mode .text-blue-400,
.light-mode .text-blue-500 {
    color: #2563eb !important;
    font-weight: 600 !important;
}

/* BOLD links */
.light-mode a {
    color: #2563eb !important;
    text-decoration: none;
    font-weight: 600 !important;
    border-bottom: 2px solid #2563eb;
}

.light-mode a:hover {
    color: #1d4ed8 !important;
    border-bottom-color: #1d4ed8;
}

/* Modal overlay - CLEAR */
.light-mode .bg-black\/90 {
    background-color: rgba(0, 0, 0, 0.75) !important;
    backdrop-filter: blur(8px);
}

/* PROFESSIONAL input fields - THICK BORDERS */
.light-mode input,
.light-mode textarea,
.light-mode select {
    background-color: #ffffff !important;
    color: #000000 !important;
    border: 2px solid #9ca3af !important;
    box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
    font-weight: 500 !important;
}

.light-mode input:focus,
.light-mode textarea:focus,
.light-mode select:focus {
    border-color: #f59e0b !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2), inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    outline: none;
}

.light-mode input::placeholder,
.light-mode textarea::placeholder {
    color: #6b7280 !important;
    font-weight: 400 !important;
}

/* Button styling - CLEAR HIERARCHY */
.light-mode button:not(.bg-red-600):not(.bg-blue-600):not(.bg-purple-600):not(.bg-green-600):not(.bg-amber-500):not(.bg-orange-600) {
    background-color: #f3f4f6 !important;
    color: #1f2937 !important;
    border: 2px solid #d1d5db !important;
    font-weight: 600 !important;
}

.light-mode button:not(.bg-red-600):not(.bg-blue-600):not(.bg-purple-600):not(.bg-green-600):not(.bg-amber-500):not(.bg-orange-600):hover {
    background-color: #e5e7eb !important;
    border-color: #9ca3af !important;
}

/* BOLD header */
.light-mode .bg-slate-800\/80 {
    background-color: #ffffff !important;
    border-bottom: 3px solid #d1d5db !important;
    backdrop-filter: blur(12px);
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
}

/* Credits display in header - LIGHT MODE */
.light-mode #creditsDisplay {
    background-color: #f1f5f9 !important;
    border: 2px solid #cbd5e1 !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.light-mode #creditsDisplay span.text-slate-300 {
    color: #475569 !important;
}

.light-mode #creditsDisplay span.text-amber-400 {
    color: #d97706 !important;
}

.light-mode #promptsCounter {
    background-color: #2563eb !important;
    color: #ffffff !important;
    font-weight: 600 !important;
}

.light-mode #promptsCounter.bg-amber-600 {
    background-color: #d97706 !important;
}

.light-mode #promptsCounter.bg-red-600 {
    background-color: #dc2626 !important;
}

/* Message input box - ULTRA CLEAR */
.light-mode #messageInput {
    background-color: #ffffff !important;
    border: 2px solid #9ca3af !important;
    box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
    color: #000000 !important;
    font-weight: 500 !important;
}

.light-mode #messageInput:focus {
    border-color: #f59e0b !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2), 0 2px 4px 0 rgba(0, 0, 0, 0.08);
}

/* Send button - VIBRANT */
.light-mode .bg-amber-500,
.light-mode .bg-orange-600 {
    box-shadow: 0 2px 8px 0 rgba(245, 158, 11, 0.4) !important;
    font-weight: 700 !important;
}

.light-mode .bg-amber-500:hover,
.light-mode .bg-orange-600:hover {
    box-shadow: 0 4px 12px 0 rgba(245, 158, 11, 0.5) !important;
    transform: translateY(-1px);
}

/* Icon improvements */
.light-mode .bg-amber-500\/10 span,
.light-mode .bg-blue-500\/10 span {
    font-size: 1.1em !important;
}

/* Warning icon */
.light-mode .text-amber-500 {
    color: #f59e0b !important;
    font-size: 1.2em !important;
    font-weight: 700 !important;
}

/* HIDE LOGOUT BUTTON FROM HEADER ONLY - It's in sidebar now */
header button[onclick*="logout"],
.bg-slate-800\/80 button[onclick*="logout"] {
    display: none !important;
}

/* ========================================
   STICKY HEADER - Always visible when scrolling
   ======================================== */

/* Make the assistant screen a proper flex container that fills viewport */
#assistantScreen {
    height: 100vh;
    height: 100dvh; /* Dynamic viewport height for mobile browsers */
    max-height: 100vh;
    max-height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Make header sticky at top - z-index must be BELOW modals (z-50 = 50) */
#mainHeader {
    position: sticky;
    top: 0;
    z-index: 40;
    flex-shrink: 0;
}

/* Make daily tip banner also sticky, right below header */
#dailyTipBanner {
    position: sticky;
    top: 0;
    z-index: 39;
    flex-shrink: 0;
}

/* Messages container takes remaining space and scrolls */
#messagesContainer {
    flex: 1;
    overflow-y: auto;
    min-height: 0; /* Important for flex children to scroll properly */
}

/* Input area stays at bottom */
#inputArea, 
#assistantScreen > div:last-child {
    flex-shrink: 0;
}

/* Improve mobile touch targets */
@media (max-width: 768px) {
    /* Prevent text selection on buttons */
    button, .tool-card, .modal-button {
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Improve textarea on mobile */
    textarea {
        font-size: 16px; /* Prevents iOS zoom on focus */
    }
    
    /* Hide scrollbars on mobile for cleaner look */
    #messagesContainer::-webkit-scrollbar {
        display: none;
    }
    
    /* Smooth scrolling on mobile */
    #messagesContainer {
        -webkit-overflow-scrolling: touch;
    }
    
    /* MOBILE ENHANCEMENTS - DAY 4-5 */
    
    /* Reduce padding on mobile for more space */
    #messagesContainer {
        padding: 12px !important;
    }
    
    /* Chat message bubbles - better spacing on mobile */
    #messagesContainer > div {
        margin-bottom: 16px !important;
        padding: 16px !important;
    }
    
    /* Suggestion boxes - more compact */
    .bg-amber-500\/10,
    .bg-yellow-500\/10 {
        padding: 12px !important;
        font-size: 14px !important;
    }
    
    /* Tools menu - HIDE on mobile (use modal instead) */
    /* Admin dashboard - FULL SCREEN mobile with proper scrolling */
    #adminDashboardModal {
        padding: 0 !important;
        align-items: flex-start !important;
        overflow-y: auto !important;
    }
    
    #adminDashboardModal > div {
        max-width: 100% !important;
        width: 100% !important;
        padding: 16px !important;
        margin: 0 !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        border: none !important;
    }
    
    /* Admin header - compact */
    #adminDashboardModal h2 {
        font-size: 1.5rem !important;
    }
    
    #adminDashboardModal .mb-6 {
        margin-bottom: 16px !important;
    }
    
    /* Admin stats - stack on mobile */
    #adminDashboardModal .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
    }
    
    /* Admin stats cards - smaller text */
    #adminDashboardModal .grid-cols-4 > div {
        padding: 12px !important;
    }
    
    #adminDashboardModal .grid-cols-4 .text-3xl {
        font-size: 1.5rem !important;
    }
    
    #adminDashboardModal .grid-cols-4 .text-xs {
        font-size: 0.65rem !important;
    }
    
    /* Admin tabs - wrap on mobile */
    #adminDashboardModal .flex.gap-2 {
        flex-wrap: wrap !important;
        gap: 4px !important;
    }
    
    #adminDashboardModal .admin-tab {
        padding: 8px 12px !important;
        font-size: 13px !important;
        white-space: nowrap !important;
    }
    
    /* Admin tab content - better height */
    #adminTabContent {
        max-height: 50vh !important;
    }
    
    /* Admin buttons - stack on mobile */
    #adminDashboardModal .mt-6.flex {
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    #adminDashboardModal .mt-6.flex button {
        width: 100% !important;
    }
    
    /* Modals - full screen on mobile */
    .modal > div {
        max-height: 95vh !important;
        margin: 8px !important;
        max-width: calc(100vw - 16px) !important;
    }
    
    /* Document preview modal - better mobile fit */
    #documentPreviewModal .max-w-5xl {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    /* Award calculator - stack vertically on mobile */
    #awardCalculatorModal select,
    #awardCalculatorModal input {
        width: 100% !important;
        margin-bottom: 12px !important;
    }
    
    /* Hide secondary text on very small screens */
    @media (max-width: 380px) {
        .hidden.sm\\:inline {
            display: none !important;
        }
    }
    
    /* Landscape mode optimizations */
    @media (orientation: landscape) and (max-height: 500px) {
        #messagesContainer {
            max-height: 50vh !important;
        }
    }
    
    /* ==========================================
       PHASE 5: MOBILE UX - SINGLE ROW HEADER
       ========================================== */
    
    /* Main header - very compact */
    #mainHeader {
        padding: 6px 10px !important;
    }
    
    /* Header content - FORCE single row */
    #headerContent {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        gap: 6px !important;
    }
    
    /* Left side - compact */
    #headerLeft {
        flex: 0 0 auto !important;
        gap: 6px !important;
    }
    
    /* Sidebar button */
    .sidebar-toggle-btn-header {
        padding: 6px !important;
    }
    
    /* Logo - smaller */
    #headerLeft .w-10 {
        width: 28px !important;
        height: 28px !important;
    }
    
    /* Show FITZ title but hide beta text */
    #headerTitle {
        display: block !important;
    }
    
    #headerTitle h1 {
        font-size: 14px !important;
        line-height: 1.2 !important;
    }
    
    #headerTitle p {
        display: none !important;
    }
    
    /* Right side */
    #headerRight {
        flex: 1 1 auto !important;
        justify-content: flex-end !important;
        gap: 4px !important;
    }
    
    /* Header buttons */
    #headerRight button {
        padding: 6px 8px !important;
    }
    
    /* Hide text labels on mobile */
    #headerRight .hidden.sm\\:inline {
        display: none !important;
    }
    
    /* Emoji sizes in header */
    #headerRight button span:first-child {
        font-size: 14px !important;
    }
    
    /* Daily tip - very compact */
    #dailyTipBanner {
        padding: 4px 10px !important;
    }
    
    #dailyTipBanner .text-sm {
        font-size: 10px !important;
        line-height: 1.3 !important;
    }
    
    #dailyTipBanner .text-lg {
        font-size: 12px !important;
    }
    
    #dailyTipBanner button {
        display: none !important;
    }
    
    /* Scroll to bottom button - larger on mobile for touch */
    #scrollToBottomBtn {
        width: 48px !important;
        height: 48px !important;
        bottom: 240px !important;
    }
    
    #scrollToBottomBtn.visible {
        opacity: 1 !important;
        pointer-events: auto !important;
    }
    
    #scrollToBottomBtn:hover {
        transform: translateX(-50%) scale(1.05) !important;
    }
    
    /* FIX 2: STACK TOOL NAVIGATION BUTTONS */
    /* All Document Builder and tool modal navigation buttons */
    #documentBuilderModal .flex.gap-3.mt-6,
    #awardCalculatorModal .flex.gap-3.mt-6,
    #scenarioAnalysisModal .flex.gap-3.mt-6,
    #rosterStressTesterModal .flex.gap-3.mt-6,
    #awardWizardModal .flex.gap-3.mt-6,
    #rosterOptimizerModal .flex.gap-3.mt-6,
    #complianceCalendarModal .flex.gap-3.mt-6,
    #terminationRiskModal .flex.gap-3.mt-6 {
        flex-direction: column !important;
        gap: 12px !important;
    }
    
    /* Make all navigation buttons full width */
    #docBackBtn,
    #docNextBtn,
    #docStartOverBtn,
    #documentBuilderModal .flex.gap-3.mt-6 button,
    #awardCalculatorModal .flex.gap-3.mt-6 button,
    #scenarioAnalysisModal .flex.gap-3.mt-6 button,
    #rosterStressTesterModal .flex.gap-3.mt-6 button,
    #awardWizardModal .flex.gap-3.mt-6 button,
    #rosterOptimizerModal .flex.gap-3.mt-6 button,
    #complianceCalendarModal .flex.gap-3.mt-6 button,
    #terminationRiskModal .flex.gap-3.mt-6 button {
        width: 100% !important;
        flex: none !important;
        padding: 16px !important;
        font-size: 16px !important;
        min-height: 56px !important;
    }
    
    /* Order: Next first (top), Back second (middle), Start Over last (bottom) */
    #docNextBtn { order: 1 !important; }
    #docBackBtn { order: 2 !important; }
    #docStartOverBtn { order: 3 !important; }
    
    /* FIX 3: MESSAGE INPUT - Taller like Claude's */
    #messageInput {
        min-height: 44px !important;
        max-height: 200px !important;
        padding: 14px !important;
        font-size: 16px !important;
        line-height: 1.5 !important;
    }
    
    /* Send button */
    #sendButton {
        padding: 10px !important;
    }
    
    /* Voice button */
    #voiceButton {
        padding: 10px !important;
    }
    
    /* FIX 4: CRISIS MODE MOBILE-RESPONSIVE */
    /* Crisis Modal Container */
    #crisisModal {
        padding: 12px !important;
        align-items: flex-start !important;
    }
    
    /* Crisis Modal Content Box */
    #crisisModal > div {
        padding: 20px !important;                    /* Was 32px */
        margin: 0 !important;
        max-height: calc(100vh - 24px) !important;   /* Fit screen */
        overflow-y: auto !important;                 /* Scrollable */
        width: 100% !important;
        border-width: 2px !important;                /* Thinner border */
    }
    
    /* Smaller emoji */
    #crisisModal .text-6xl {
        font-size: 3rem !important;       /* 48px instead of 96px */
        margin-bottom: 12px !important;
    }
    
    /* Smaller heading */
    #crisisModal h2 {
        font-size: 1.5rem !important;     /* 24px instead of 48px */
        margin-bottom: 8px !important;
        line-height: 1.3 !important;
    }
    
    /* Smaller subtitle */
    #crisisModal h2 + p {
        font-size: 0.9rem !important;
        margin-bottom: 16px !important;
    }
    
    /* Compact form elements */
    #crisisModal select,
    #crisisModal input,
    #crisisModal textarea {
        padding: 12px !important;
        font-size: 16px !important;
    }
    
    /* Smaller textarea */
    #crisisDescription {
        min-height: 80px !important;      /* More compact */
    }
    
    /* Action box more compact */
    #crisisModal .bg-red-500\/10 {
        padding: 12px !important;
        font-size: 13px !important;
        margin-bottom: 16px !important;
    }
    
    #crisisModal .bg-red-500\/10 p {
        font-size: 14px !important;
        margin-bottom: 8px !important;
    }
    
    #crisisModal .bg-red-500\/10 ul {
        font-size: 13px !important;
    }
    
    #crisisModal .bg-red-500\/10 li {
        line-height: 1.4 !important;
    }
    
    /* Crisis buttons more compact */
    #crisisModal .flex.gap-3:has(button) {
        margin-top: 16px !important;
    }
    
    /* Stack crisis buttons on very small screens */
    @media (max-width: 480px) {
        #crisisModal .flex.gap-3:has(button) {
            flex-direction: column !important;
        }
        
        #crisisModal button {
            width: 100% !important;
            padding: 14px !important;
            font-size: 15px !important;
        }
    }
    
    /* ==========================================
       MOBILE UX ENHANCEMENTS - PHASE 2
       ========================================== */
    
    /* Tools Menu - FORCE scrollable on mobile */
    #toolsMenu:not(.hidden) {
        display: block !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        padding: 0 !important;
        overflow-y: scroll !important;
        -webkit-overflow-scrolling: touch !important;
        z-index: 9999 !important;
    }
    
    #toolsMenu > div,
    #toolsMenu #toolsMenuInner {
        position: relative !important;
        max-width: 100% !important;
        width: 100% !important;
        min-height: auto !important;
        max-height: none !important;
        height: auto !important;
        border-radius: 0 !important;
        padding: 16px !important;
        padding-bottom: 200px !important;
        margin: 0 !important;
        border: none !important;
        overflow: visible !important;
    }
    
    #toolsMenu h2 {
        font-size: 1.3rem !important;
    }
    
    #toolsMenu .grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
    }
    
    #toolsMenu .grid button {
        padding: 12px !important;
        min-height: 54px !important;
    }
    
    #toolsMenu .text-3xl {
        font-size: 1.25rem !important;
    }
    
    #toolsMenu .text-sm {
        font-size: 11px !important;
    }
    
    /* Document Builder Modal - Full screen */
    #documentBuilderModal {
        padding: 0 !important;
        align-items: flex-start !important;
    }
    
    #documentBuilderModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        padding: 16px !important;
        margin: 0 !important;
    }
    
    #documentBuilderModal h2 {
        font-size: 1.25rem !important;
    }
    
    #documentBuilderModal select,
    #documentBuilderModal input,
    #documentBuilderModal textarea {
        font-size: 16px !important;
        padding: 14px !important;
        min-height: 48px !important;
    }
    
    /* Contract Builder - Full screen */
    #contractBuilderStepsModal {
        padding: 0 !important;
    }
    
    #contractBuilderStepsModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }
    
    #contractBuilderStepsModal .contract-header {
        padding: 12px 16px !important;
    }
    
    #contractBuilderStepsModal .contract-header h2 {
        font-size: 1.1rem !important;
    }
    
    #contractBuilderStepsModal .contract-body {
        padding: 16px !important;
    }
    
    #contractBuilderStepsModal .contract-footer {
        padding: 12px 16px !important;
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    #contractBuilderStepsModal .contract-footer button {
        width: 100% !important;
        padding: 14px !important;
    }
    
    /* Contract step content - better mobile form fields */
    #contractStepContent select,
    #contractStepContent input,
    #contractStepContent textarea {
        font-size: 16px !important;
        padding: 12px !important;
        min-height: 48px !important;
    }
    
    #contractStepContent .grid {
        grid-template-columns: 1fr !important;
    }
    
    /* Employee Onboarding Checklist Modal */
    #employeeOnboardingChecklistModal {
        padding: 0 !important;
    }
    
    #employeeOnboardingChecklistModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 16px !important;
    }
    
    /* Training Plan Modal */
    #trainingPlanModal {
        padding: 0 !important;
    }
    
    #trainingPlanModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 16px !important;
    }
    
    /* Sidebar improvements */
    .chat-sidebar {
        width: 85vw !important;
        max-width: 320px !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
    }
    
    /* Make sidebar content DEFINITELY scrollable */
    .sidebar-content {
        flex: 1 1 0 !important;
        overflow-y: scroll !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 20px !important;
        min-height: 0 !important;
    }
    
    /* Ensure all sidebar sections are visible */
    .sidebar-section {
        display: block !important;
        margin-bottom: 16px !important;
    }
    
    .sidebar-section-title {
        display: block !important;
        padding: 8px 16px !important;
        font-size: 11px !important;
    }
    
    .sidebar-items-list {
        display: block !important;
    }
    
    .sidebar-chat-item {
        padding: 14px 12px !important;
        min-height: 48px !important;
    }
    
    .sidebar-new-chat-btn {
        min-height: 48px !important;
        padding: 14px !important;
    }
    
    .sidebar-close-btn {
        min-width: 44px !important;
        min-height: 44px !important;
        padding: 10px !important;
    }
    
    /* Better touch targets for bookmark stars */
    .bookmark-star {
        min-width: 44px !important;
        min-height: 44px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 1.5rem !important;
    }
    
    /* Chat messages - better mobile spacing */
    #messagesContainer .space-y-6 > div {
        padding: 14px !important;
        margin-bottom: 12px !important;
    }
    
    /* Suggestion chips - wrap better on mobile */
    .flex.flex-wrap.gap-2 {
        gap: 8px !important;
    }
    
    .flex.flex-wrap.gap-2 button {
        padding: 10px 14px !important;
        font-size: 14px !important;
        min-height: 44px !important;
    }
    
    /* Legal acceptance modal - full screen */
    #legalAcceptanceModal {
        padding: 0 !important;
    }
    
    #legalAcceptanceModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 20px !important;
    }
    
    /* Onboarding modal - full screen */
    #onboardingModal {
        padding: 0 !important;
    }
    
    #onboardingModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 24px !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    #onboardingModal select,
    #onboardingModal input {
        font-size: 16px !important;
        padding: 14px !important;
        min-height: 52px !important;
    }
    
    #onboardingModal button {
        min-height: 52px !important;
        font-size: 16px !important;
    }
    
    /* Settings modal - full screen */
    #venueSettingsModal {
        padding: 0 !important;
    }
    
    #venueSettingsModal > div {
        max-width: 100% !important;
        width: 100% !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        overflow-y: auto !important;
    }
    
    /* Document preview modal - full screen */
    #documentPreviewModal {
        padding: 0 !important;
    }
    
    #documentPreviewModal > div {
        max-width: 100% !important;
        width: 100% !important;
        height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }
    
    /* Validation popup - centered and readable */
    #validationPopup {
        padding: 16px !important;
    }
    
    #validationPopup > div {
        max-width: calc(100vw - 32px) !important;
        padding: 20px !important;
    }
    
    /* Better spacing for form sections on mobile */
    .form-section {
        padding: 16px !important;
        margin-bottom: 16px !important;
    }
    
    .form-section-title {
        font-size: 1rem !important;
        margin-bottom: 12px !important;
    }
    
    /* Progress indicators on mobile */
    .step-indicator {
        padding: 8px !important;
    }
    
    .step-indicator .step-number {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
    }
    
    .step-indicator .step-label {
        font-size: 11px !important;
    }
    
    /* Footer disclaimer - more compact */
    .bg-slate-800\/50.border-t {
        padding: 8px 12px !important;
    }
    
    .bg-slate-800\/50.border-t p {
        font-size: 10px !important;
        line-height: 1.4 !important;
    }
    
    /* Quick action cards - stack on mobile */
    .grid.grid-cols-2.md\\:grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
    }
    
    .grid.grid-cols-2.md\\:grid-cols-4 > div {
        padding: 12px !important;
    }
    
    /* Toast notifications - better mobile positioning */
    .toast-container {
        bottom: 80px !important;
        left: 16px !important;
        right: 16px !important;
        max-width: calc(100vw - 32px) !important;
    }
    
    /* Profile dropdown - better mobile sizing */
    #profileDropdown {
        right: 8px !important;
        min-width: 200px !important;
    }
    
    #profileDropdown button {
        padding: 14px 16px !important;
        min-height: 48px !important;
    }
    
    /* More menu dropdown - better mobile */
    #moreMenuDropdown {
        right: 8px !important;
        min-width: 180px !important;
    }
    
    #moreMenuDropdown button {
        padding: 14px 16px !important;
        min-height: 48px !important;
    }
}

/* Desktop styles for tools menu (restore flex centering) */
@media (min-width: 769px) {
    #toolsMenu:not(.hidden) {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
    }
    
    /* Desktop message input - taller like Claude */
    #messageInput {
        min-height: 100px;
        max-height: 250px;
        padding: 16px;
        font-size: 15px;
        line-height: 1.6;
    }
}

/* Tablet optimizations (768px - 1024px) */
@media (min-width: 768px) and (max-width: 1024px) {
    /* Slightly reduce padding for tablets */
    .max-w-5xl {
        max-width: 90% !important;
    }
    
    /* Better modal sizing on tablets */
    .modal > div {
        max-width: 85vw !important;
    }
}

/* Prevent zoom on input focus (iOS) */
input, textarea, select {
    font-size: 16px;
}

        /* Crisis Mode Pulse Animation */


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }

        /* ========================================
           WEEK 2: LOADING STATES & SKELETONS
           ======================================== */
        
        /* Skeleton loader animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
            border-radius: 0.5rem;
        }
        
        .light-mode .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 1000px 100%;
        }
        
        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Fade-in animation for content */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Progress bar animation */
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .progress-bar {
            animation: progress 2s ease-out;
        }
        
        /* Toast notification slide-in */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s ease-in;
        }
        
        /* Scroll to bottom button - Claude-style floating button */
        #scrollToBottomBtn {
            display: flex;
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: rgba(30, 41, 59, 0.95); /* slate-800 with opacity */
            border: 1px solid rgba(71, 85, 105, 0.8); /* slate-600 */
            border-radius: 50%;
            color: #94a3b8; /* slate-400 */
            cursor: pointer;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        #scrollToBottomBtn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        #scrollToBottomBtn:hover {
            background: rgba(51, 65, 85, 0.95); /* slate-700 */
            color: #f59e0b; /* amber-500 */
            border-color: #f59e0b;
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }
        
        #scrollToBottomBtn:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        /* Light mode adjustments */
        .light-mode #scrollToBottomBtn {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(203, 213, 225, 0.8);
            color: #64748b;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }
        
        .light-mode #scrollToBottomBtn:hover {
            background: rgba(248, 250, 252, 0.95);
            color: #f59e0b;
            border-color: #f59e0b;
        }
        
        /* Toast container */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        
        .toast {
            pointer-events: auto;
            min-width: 300px;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .toast-success {
            background: #064e3b;
            border: 1px solid #10b981;
            color: #d1fae5;
        }
        
        .toast-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fee2e2;
        }
        
        .toast-warning {
            background: #78350f;
            border: 1px solid #f59e0b;
            color: #fef3c7;
        }
        
        .toast-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #dbeafe;
        }
        
        .light-mode .toast-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #064e3b;
        }
        
        .light-mode .toast-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #7f1d1d;
        }
        
        .light-mode .toast-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #78350f;
        }
        
        .light-mode .toast-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e3a8a;
        }
        
        /* Smooth focus indicators (accessibility) */
        *:focus-visible {
            outline: 2px solid #f59e0b;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Better hover states */
        button:not(:disabled):hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }
        
        button:not(:disabled):active {
            transform: translateY(0);
        }
        
        /* Disabled state styling */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Smooth modal transitions */
        .modal-enter {
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-backdrop {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .light-mode .loading-overlay {
            background: rgba(255, 255, 255, 0.9);
        }

        /* ========================================
           WEEK 3 PHASE 1: POWER USER FEATURES
           ======================================== */
        
        /* Search Bar */
        .search-container {
            position: relative;
        }
        
        .search-highlight {
            background: #fef3c7;
            color: #78350f;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .light-mode .search-highlight {
            background: #fef3c7;
            color: #78350f;
        }
        
        /* Bookmark Star */
        .bookmark-star {
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            opacity: 0.4;
        }
        
        .bookmark-star:hover {
            transform: scale(1.3);
            opacity: 1;
        }
        
        .bookmark-star.bookmarked {
            color: #f59e0b;
            opacity: 1;
        }
        
        /* Quick Actions Menu */
        .quick-actions-fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            z-index: 1000;
        }
        
        .quick-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5);
            transition: all 0.3s;
            border: none;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.7);
        }
        
        .quick-actions-menu {
            position: absolute;
            bottom: 75px;
            right: 0;
            background: #1e293b;
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 12px;
            min-width: 240px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: none;
        }
        
        .quick-actions-menu.show {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .light-mode .quick-actions-menu {
            background: white;
            border: 2px solid #f59e0b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .quick-action-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        
        .quick-action-item:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: translateX(4px);
        }
        
        .light-mode .quick-action-item {
            color: #1f2937;
        }
        
        .light-mode .quick-action-item:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* Multi-file Upload */
        .drag-drop-zone {
            border: 3px dashed #475569;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.3);
        }
        
        .drag-drop-zone:hover {
            border-color: #64748b;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .drag-drop-zone.drag-over {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            transform: scale(1.02);
            border-style: solid;
        }
        
        .light-mode .drag-drop-zone {
            border-color: #cbd5e1;
            background: rgba(241, 245, 249, 0.5);
        }
        
        .light-mode .drag-drop-zone:hover {
            border-color: #94a3b8;
            background: rgba(241, 245, 249, 0.8);
        }
        
        .light-mode .drag-drop-zone.drag-over {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .light-mode .file-item {
            background: white;
            border-color: #e2e8f0;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-new {
            background: #f59e0b;
            color: #78350f;
        }
        
        /* Search Results */
        .search-result {
            padding: 16px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result:hover {
            border-color: #f59e0b;
            transform: translateX(4px);
        }
        
        .light-mode .search-result {
            background: white;
            border-color: #e2e8f0;
        }
        
        .light-mode .search-result:hover {
            border-color: #f59e0b;
        }
        
        /* ==========================================
           CHATGPT-STYLE SIDEBAR
           ========================================== */
        
        .chat-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #171717;
            border-right: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            z-index: 200; /* Higher than header (100) so sidebar appears on top */
            transition: transform 0.3s ease;
        }
        
        .chat-sidebar.closed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid #2d2d2d;
        }
        
        .sidebar-close-btn {
            color: #94a3b8;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .sidebar-close-btn:hover {
            background: #2d2d2d;
            color: white;
        }
        
        .sidebar-new-chat-btn {
            margin: 12px;
            padding: 12px;
            background: transparent;
            border: 1px solid #2d2d2d;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: all 0.2s;
            width: calc(100% - 24px);
        }
        
        .sidebar-new-chat-btn:hover {
            background: #2d2d2d;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        .sidebar-section {
            margin-top: 20px;
        }
        
        .sidebar-section-title {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-items-list {
            padding: 0 8px;
        }
        
        .sidebar-chat-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .sidebar-chat-item:hover {
            background: #2d2d2d;
        }
        
        .sidebar-chat-item.active {
            background: #2d2d2d;
            color: white;
        }
        
        .sidebar-chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sidebar-chat-delete {
            opacity: 0;
            color: #64748b;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .sidebar-chat-item:hover .sidebar-chat-delete {
            opacity: 1;
        }
        
        .sidebar-chat-delete:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 39;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 50;
            background: #2d2d2d;
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #3d3d3d;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-toggle-btn:hover {
            background: #3d3d3d;
        }
        
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
                max-width: 300px;
            }
        }
        
        .light-mode .chat-sidebar {
            background: white;
            border-right-color: #e2e8f0;
        }
        
        .light-mode .sidebar-new-chat-btn {
            border-color: #e2e8f0;
            color: #0f172a;
        }
        
        .light-mode .sidebar-chat-item {
            color: #475569;
        }
        
        .light-mode .sidebar-chat-item.active {
            background: #f1f5f9;
            color: #0f172a;
        }
        
        /* Highlight flash for bookmarks */
        .highlight-flash {
            animation: flash 2s ease-in-out;
        }
        
        @keyframes flash {
            0%, 100% { background: transparent; }
            50% { background: rgba(245, 158, 11, 0.2); }
        }

/* ========================================
   EMPLOYMENT CONTRACT BUILDER STYLES
   HIGH SPECIFICITY - Overrides dark mode
   ======================================== */

#employmentContractBuilder {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 14, 39, 0.95);
    backdrop-filter: blur(10px);
    z-index: 999999;
    overflow-y: auto;
    padding: 20px;
}

#employmentContractBuilder.active {
    display: flex !important;
    justify-content: center;
    align-items: flex-start;
}

#employmentContractBuilder .contract-content-area {
    background: #ffffff !important;
    max-width: 900px;
    width: 100%;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    margin: 20px auto;
    overflow: hidden;
}

#employmentContractBuilder .contract-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 32px;
    text-align: center;
    position: relative;
}

#employmentContractBuilder .contract-header h1 {
    color: #ffffff !important;
    font-size: 32px !important;
    font-weight: 700 !important;
    margin: 0 0 8px 0 !important;
}

#employmentContractBuilder .contract-header p {
    color: rgba(255, 255, 255, 0.9) !important;
    font-size: 16px !important;
    margin: 0 !important;
}

#employmentContractBuilder .contract-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: #ffffff !important;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 24px !important;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#employmentContractBuilder .contract-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

#employmentContractBuilder .progress-container {
    background: #f8f9fa;
    padding: 24px 32px;
    border-bottom: 2px solid #e9ecef;
}

#employmentContractBuilder .progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    margin-bottom: 16px;
}

#employmentContractBuilder .progress-line {
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 4px;
    background: #e9ecef;
    z-index: 1;
}

#employmentContractBuilder .progress-line-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
    width: 0%;
}

#employmentContractBuilder .progress-step {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

#employmentContractBuilder .progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ffffff;
    border: 3px solid #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px !important;
    color: #6c757d !important;
    transition: all 0.3s;
}

#employmentContractBuilder .progress-circle.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff !important;
    transform: scale(1.1);
}

#employmentContractBuilder .progress-circle.completed {
    border-color: #28a745;
    background: #28a745;
    color: #ffffff !important;
}

#employmentContractBuilder .progress-circle.completed::after {
    content: "âœ“";
    font-size: 18px;
}

#employmentContractBuilder .progress-label {
    font-size: 12px !important;
    color: #6c757d !important;
    font-weight: 500 !important;
    text-align: center;
    max-width: 80px;
}

#employmentContractBuilder .progress-label.active {
    color: #667eea !important;
    font-weight: 600 !important;
}

#employmentContractBuilder .step-content {
    padding: 40px;
}

#employmentContractBuilder .step-title {
    color: #212529 !important;
    font-size: 28px !important;
    font-weight: 700 !important;
    margin: 0 0 12px 0 !important;
}

#employmentContractBuilder .step-description {
    color: #6c757d !important;
    font-size: 16px !important;
    margin: 0 0 32px 0 !important;
    line-height: 1.6 !important;
}

#employmentContractBuilder .form-group {
    margin-bottom: 24px;
}

#employmentContractBuilder .form-label {
    display: block;
    color: #495057 !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    margin-bottom: 8px !important;
}

#employmentContractBuilder .form-label.required::after {
    content: " *";
    color: #dc3545 !important;
}

#employmentContractBuilder .form-input,
#employmentContractBuilder .form-select,
#employmentContractBuilder .form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 15px !important;
    color: #212529 !important;
    background: #ffffff !important;
    transition: all 0.3s;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
}

#employmentContractBuilder .form-input:focus,
#employmentContractBuilder .form-select:focus,
#employmentContractBuilder .form-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#employmentContractBuilder .form-textarea {
    min-height: 120px;
    resize: vertical;
}

#employmentContractBuilder .form-hint {
    display: block;
    color: #6c757d !important;
    font-size: 13px !important;
    margin-top: 6px !important;
    line-height: 1.5 !important;
}

#employmentContractBuilder .radio-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

#employmentContractBuilder .radio-option {
    flex: 1;
    min-width: 200px;
}

#employmentContractBuilder .radio-label {
    display: flex;
    align-items: center;
    padding: 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    background: #ffffff !important;
}

#employmentContractBuilder .radio-label:hover {
    border-color: #667eea;
    background: #f8f9ff !important;
}

#employmentContractBuilder .radio-input {
    margin-right: 12px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

#employmentContractBuilder .radio-text {
    color: #212529 !important;
    font-weight: 600 !important;
    font-size: 15px !important;
}

#employmentContractBuilder .radio-description {
    color: #6c757d !important;
    font-size: 13px !important;
    margin-top: 4px !important;
}

#employmentContractBuilder .checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    padding: 12px;
    border-radius: 8px;
    transition: background 0.3s;
}

#employmentContractBuilder .checkbox-label:hover {
    background: #f8f9fa !important;
}

#employmentContractBuilder .checkbox-input {
    margin-right: 12px;
    margin-top: 4px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

#employmentContractBuilder .checkbox-text {
    color: #212529 !important;
    font-size: 15px !important;
    line-height: 1.6 !important;
}

#employmentContractBuilder .warning-box {
    background: #fff3cd !important;
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

#employmentContractBuilder .warning-box-title {
    color: #856404 !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    margin: 0 0 12px 0 !important;
    display: flex;
    align-items: center;
    gap: 8px;
}

#employmentContractBuilder .warning-box-content {
    color: #856404 !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin: 0 !important;
}

#employmentContractBuilder .warning-box ul {
    margin: 8px 0 0 20px !important;
    padding: 0 !important;
}

#employmentContractBuilder .warning-box li {
    color: #856404 !important;
    margin-bottom: 6px !important;
}

#employmentContractBuilder .info-box {
    background: #e7f3ff !important;
    border: 2px solid #007bff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

#employmentContractBuilder .info-box-title {
    color: #004085 !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    margin: 0 0 8px 0 !important;
}

#employmentContractBuilder .info-box-content {
    color: #004085 !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin: 0 !important;
}

#employmentContractBuilder .help-section {
    margin-bottom: 16px;
}

#employmentContractBuilder .help-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8f9fa !important;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s;
    width: 100%;
    text-align: left;
}

#employmentContractBuilder .help-toggle:hover {
    background: #e9ecef !important;
}

#employmentContractBuilder .help-toggle-icon {
    color: #007bff !important;
    font-size: 18px !important;
    transition: transform 0.3s;
}

#employmentContractBuilder .help-toggle.expanded .help-toggle-icon {
    transform: rotate(90deg);
}

#employmentContractBuilder .help-toggle-text {
    color: #007bff !important;
    font-weight: 600 !important;
    font-size: 14px !important;
}

#employmentContractBuilder .help-content {
    display: none;
    background: #f8f9fa !important;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 16px;
    margin-top: -8px;
}

#employmentContractBuilder .help-content.expanded {
    display: block;
}

#employmentContractBuilder .help-content p {
    color: #495057 !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin: 0 0 12px 0 !important;
}

#employmentContractBuilder .help-content p:last-child {
    margin-bottom: 0 !important;
}

#employmentContractBuilder .help-content ul {
    margin: 8px 0 12px 20px !important;
    padding: 0 !important;
}

#employmentContractBuilder .help-content li {
    color: #495057 !important;
    margin-bottom: 6px !important;
}

#employmentContractBuilder .btn-container {
    display: flex;
    gap: 12px;
    margin-top: 40px;
    padding-top: 32px;
    border-top: 2px solid #e9ecef;
}

#employmentContractBuilder .btn {
    padding: 14px 32px;
    border-radius: 8px;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

#employmentContractBuilder .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#employmentContractBuilder .btn-primary {
    background: #ffc107 !important;
    color: #000000 !important;
    flex: 1;
}

#employmentContractBuilder .btn-primary:hover:not(:disabled) {
    background: #ffb300 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

#employmentContractBuilder .btn-secondary {
    background: #e9ecef !important;
    color: #495057 !important;
    min-width: 120px;
}

#employmentContractBuilder .btn-secondary:hover:not(:disabled) {
    background: #dee2e6 !important;
}

#employmentContractBuilder .btn-link {
    background: transparent !important;
    color: #007bff !important;
    padding: 14px 24px;
    text-decoration: underline;
}

#employmentContractBuilder .btn-link:hover {
    color: #0056b3 !important;
    background: #f8f9fa !important;
}

/* Form Section Styles */
#employmentContractBuilder .form-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 1px solid #e9ecef;
}

#employmentContractBuilder .form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

#employmentContractBuilder .form-section-title {
    color: #212529 !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    margin: 0 0 8px 0 !important;
}

#employmentContractBuilder .form-section-title.required::after {
    content: ' *';
    color: #dc3545;
    font-weight: 700;
}

#employmentContractBuilder .form-section-description {
    color: #6c757d !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin: 0 0 20px 0 !important;
}

#employmentContractBuilder .form-section-description a {
    color: #007bff !important;
    text-decoration: underline;
}

/* Input with Suffix */
#employmentContractBuilder .input-with-suffix {
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 300px;
}

#employmentContractBuilder .input-with-suffix .form-input {
    flex: 0 0 120px;
    width: 120px;
}

#employmentContractBuilder .input-suffix {
    color: #495057 !important;
    font-size: 14px !important;
    white-space: nowrap;
}

/* Input with Prefix and Suffix */
#employmentContractBuilder .input-with-prefix-suffix {
    display: flex;
    align-items: center;
    gap: 0;
    max-width: 350px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: #ffffff;
}

#employmentContractBuilder .input-with-prefix-suffix:focus-within {
    border-color: #667eea;
}

#employmentContractBuilder .input-prefix {
    padding: 12px 16px;
    background: #f8f9fa !important;
    color: #495057 !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    border-right: 1px solid #dee2e6;
    white-space: nowrap;
}

#employmentContractBuilder .input-with-prefix-suffix .form-input {
    flex: 1;
    border: none !important;
    border-radius: 0 !important;
    padding: 12px 16px;
    min-width: 100px;
}

#employmentContractBuilder .input-with-prefix-suffix .form-input:focus {
    outline: none;
    box-shadow: none;
}

#employmentContractBuilder .input-with-prefix-suffix .input-suffix {
    padding: 12px 16px;
    background: #f8f9fa !important;
    color: #495057 !important;
    font-size: 14px !important;
    border-left: 1px solid #dee2e6;
    white-space: nowrap;
}

/* Clause Preview Box */
#employmentContractBuilder .clause-preview {
    background: #f0f9f4 !important;
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    transition: all 0.3s ease;
}

#employmentContractBuilder .clause-preview.collapsed {
    display: none;
}

#employmentContractBuilder .clause-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

#employmentContractBuilder .clause-icon {
    font-size: 20px;
}

#employmentContractBuilder .clause-title {
    color: #212529 !important;
    font-size: 16px !important;
    font-weight: 600 !important;
}

#employmentContractBuilder .clause-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    margin-left: auto;
}

#employmentContractBuilder .clause-badge.included {
    background: #28a745 !important;
    color: #ffffff !important;
}

#employmentContractBuilder .clause-badge.optional {
    background: #6c757d !important;
    color: #ffffff !important;
}

#employmentContractBuilder .clause-content {
    color: #495057 !important;
    font-size: 14px !important;
    line-height: 1.7 !important;
}

#employmentContractBuilder .clause-content p {
    color: #495057 !important;
    font-size: 14px !important;
    line-height: 1.7 !important;
    margin: 0 0 12px 0 !important;
}

#employmentContractBuilder .clause-content p:last-child {
    margin-bottom: 0 !important;
}

#employmentContractBuilder .clause-content ul {
    margin: 8px 0 12px 20px !important;
    padding: 0 !important;
}

#employmentContractBuilder .clause-content li {
    color: #495057 !important;
    margin-bottom: 6px !important;
    font-size: 14px !important;
}

/* Radio Group Vertical */
#employmentContractBuilder .radio-group-vertical {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
}

#employmentContractBuilder .radio-option-card {
    display: flex;
    align-items: center;
    padding: 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    background: #ffffff !important;
}

#employmentContractBuilder .radio-option-card:hover {
    border-color: #667eea;
    background: #f8f9ff !important;
}

#employmentContractBuilder .radio-option-card input[type="radio"] {
    margin-right: 12px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

#employmentContractBuilder .radio-option-card input[type="radio"]:checked + .radio-card-content {
    color: #667eea !important;
}

#employmentContractBuilder .radio-option-card:has(input[type="radio"]:checked) {
    border-color: #667eea;
    background: #f0f4ff !important;
}

#employmentContractBuilder .radio-card-content {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #212529 !important;
    font-size: 15px !important;
}

/* Optional Clause Toggle */
#employmentContractBuilder .optional-clause-toggle {
    margin: 16px 0;
    padding: 12px 16px;
    background: #f8f9fa !important;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

#employmentContractBuilder .optional-clause-toggle .checkbox-label {
    padding: 0;
    margin: 0;
}

#employmentContractBuilder .optional-clause-toggle .checkbox-text {
    color: #212529 !important;
    font-weight: 600 !important;
}

/* Roster Fields */
#employmentContractBuilder .roster-fields {
    background: #f8f9fa !important;
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    transition: all 0.3s ease;
}

#employmentContractBuilder .roster-fields.collapsed {
    display: none;
}

#employmentContractBuilder .roster-fields .form-group {
    margin-bottom: 20px;
}

#employmentContractBuilder .roster-fields .form-group:last-of-type {
    margin-bottom: 16px;
}

#employmentContractBuilder .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
    z-index: 1000000;
}

#employmentContractBuilder .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #e9ecef;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@media (max-width: 768px) {
    #employmentContractBuilder .contract-content-area {
        margin: 0;
        border-radius: 0;
        max-width: 100%;
    }
    
    #employmentContractBuilder .step-content {
        padding: 24px;
    }
    
    #employmentContractBuilder .progress-steps {
        flex-wrap: wrap;
        gap: 16px;
    }
    
    #employmentContractBuilder .progress-line {
        display: none;
    }
    
    #employmentContractBuilder .radio-group {
        flex-direction: column;
    }
    
    #employmentContractBuilder .radio-option {
        width: 100%;
    }
    
    #employmentContractBuilder .btn-container {
        flex-direction: column-reverse;
    }
    
    #employmentContractBuilder .btn {
        width: 100%;
    }
}

/* ========================================
   FITZ CREDITS SYSTEM STYLES
   ======================================== */

/* Credits display in header */
#creditsDisplay {
    animation: fadeIn 0.3s ease-out;
}

/* Prompts counter styling */
#promptsDisplay {
    font-variant-numeric: tabular-nums;
}

/* Credit balance color states */
.credits-high { color: #10B981; } /* green */
.credits-medium { color: #F59E0B; } /* amber */
.credits-low { color: #EF4444; } /* red */

/* Document blur overlay */
#documentBlurOverlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 10;
    background: linear-gradient(to bottom, 
        transparent 0%, 
        transparent 12%, 
        rgba(255,255,255,0.3) 18%,
        rgba(255,255,255,0.7) 25%,
        rgba(255,255,255,0.95) 35%,
        white 50%
    );
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

/* Unlock prompt on blurred document */
#documentUnlockPrompt {
    position: absolute;
    bottom: 35%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

/* Notification toast styles */
.notification-toast {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Consultation type button selection */
.consultation-type-btn.selected,
.consultation-type-btn.border-amber-500 {
    border-color: #F59E0B !important;
    border-width: 2px !important;
    background: rgba(245, 158, 11, 0.1) !important;
}

/* Modal transitions */
#promptLimitModal,
#creditsModal,
#consultationBookingModal,
#documentUnlockModal,
#consultationRequiredModal {
    animation: fadeIn 0.2s ease-out;
}

#promptLimitModal > div,
#creditsModal > div,
#consultationBookingModal > div,
#documentUnlockModal > div,
#consultationRequiredModal > div {
    animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Credit pack hover effect */
#creditsModal button[onclick^="purchaseCreditPack"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Pulse animation for low credits warning */
@keyframes creditPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.credits-warning {
    animation: creditPulse 2s ease-in-out infinite;
}
    </style>
    
    <!-- Calendly Styles & Script -->
    <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet">
    <script src="https://assets.calendly.com/assets/external/widget.js" type="text/javascript" async></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
<!-- SYNC DEBUG PANEL - ADD THIS TO THE HEADER -->

<script>
// Simple manual sync functions for testing
async function manualSyncToCloud() {
    const status = document.getElementById('syncStatus');
    status.innerHTML = 'â³ Saving to cloud...';
    
    if (!currentUser || !db) {
        status.innerHTML = 'âŒ Error: Not signed in!';
        return;
    }
    
    try {
        // Get ALL data from localStorage
        const allData = {
            conversations: JSON.parse(localStorage.getItem('fitz_conversations') || '[]'),
            contracts: [],
            checklists: [],
            trainingPlans: [],
            timestamp: new Date().toISOString()
        };
        
        // Get all contracts
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('contract_')) {
                try {
                    allData.contracts.push(JSON.parse(localStorage.getItem(key)));
                } catch (e) {}
            }
            if (key && key.startsWith('checklist_')) {
                try {
                    allData.checklists.push(JSON.parse(localStorage.getItem(key)));
                } catch (e) {}
            }
            if (key && key.startsWith('training_plan_')) {
                try {
                    allData.trainingPlans.push(JSON.parse(localStorage.getItem(key)));
                } catch (e) {}
            }
        }
        
        // Save to Firestore
        await db.collection('users').doc(currentUser.uid).set({
            syncedData: allData,
            lastSync: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        status.innerHTML = `âœ… Synced to cloud!<br>
        ðŸ“ ${allData.conversations.length} conversations<br>
        ðŸ“„ ${allData.contracts.length} contracts<br>
        âœ”ï¸ ${allData.checklists.length} checklists<br>
        ðŸ“š ${allData.trainingPlans.length} training plans`;
        
    } catch (error) {
        status.innerHTML = 'âŒ Error: ' + error.message;
    }
}

async function manualLoadFromCloud() {
    const status = document.getElementById('syncStatus');
    status.innerHTML = 'â³ Loading from cloud...';
    
    if (!currentUser || !db) {
        status.innerHTML = 'âŒ Error: Not signed in!';
        return;
    }
    
    try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        
        if (!doc.exists || !doc.data().syncedData) {
            status.innerHTML = 'ðŸ“­ No cloud data found';
            return;
        }
        
        const cloudData = doc.data().syncedData;
        
        // Restore conversations
        if (cloudData.conversations && cloudData.conversations.length > 0) {
            localStorage.setItem('fitz_conversations', JSON.stringify(cloudData.conversations));
            conversations = cloudData.conversations;
        }
        
        // Restore contracts
        if (cloudData.contracts && cloudData.contracts.length > 0) {
            cloudData.contracts.forEach(contract => {
                localStorage.setItem('contract_' + contract.contractId, JSON.stringify(contract));
            });
        }
        
        // Restore checklists
        if (cloudData.checklists && cloudData.checklists.length > 0) {
            cloudData.checklists.forEach(checklist => {
                localStorage.setItem('checklist_' + checklist.checklistId, JSON.stringify(checklist));
            });
        }
        
        // Restore training plans
        if (cloudData.trainingPlans && cloudData.trainingPlans.length > 0) {
            cloudData.trainingPlans.forEach(plan => {
                localStorage.setItem('training_plan_' + plan.planId, JSON.stringify(plan));
            });
        }
        
        status.innerHTML = `âœ… Loaded from cloud!<br>
        ðŸ“ ${cloudData.conversations?.length || 0} conversations<br>
        ðŸ“„ ${cloudData.contracts?.length || 0} contracts<br>
        âœ”ï¸ ${cloudData.checklists?.length || 0} checklists<br>
        ðŸ“š ${cloudData.trainingPlans?.length || 0} training plans<br><br>
        ðŸ”„ Refresh page to see changes`;
        
        // Show notification
        showAlert('âœ… Data loaded! Refresh the page to see everything.');
        
    } catch (error) {
        status.innerHTML = 'âŒ Error: ' + error.message;
    }
}

async function checkFirestoreData() {
    const status = document.getElementById('syncStatus');
    status.innerHTML = 'â³ Checking Firestore...';
    
    if (!currentUser || !db) {
        status.innerHTML = 'âŒ Error: Not signed in!';
        return;
    }
    
    try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        
        if (!doc.exists) {
            status.innerHTML = 'ðŸ“­ No user document found';
            return;
        }
        
        const data = doc.data();
        const syncedData = data.syncedData || {};
        
        status.innerHTML = `ðŸ“Š Firestore Data:<br>
        User ID: ${currentUser.uid}<br>
        Email: ${currentUser.email}<br>
        Last Sync: ${data.lastSync ? new Date(data.lastSync.toDate()).toLocaleString() : 'Never'}<br><br>
        ðŸ“ ${syncedData.conversations?.length || 0} conversations<br>
        ðŸ“„ ${syncedData.contracts?.length || 0} contracts<br>
        âœ”ï¸ ${syncedData.checklists?.length || 0} checklists<br>
        ðŸ“š ${syncedData.trainingPlans?.length || 0} training plans`;
        
    } catch (error) {
        status.innerHTML = 'âŒ Error: ' + error.message;
    }
}

</script>

    
    <!-- Inline checkAccess to avoid undefined error -->
    <script>
// ========================================
// CAPTURE OAUTH CALLBACK IMMEDIATELY
// ========================================
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');
    
    if (code && state) {
        // Store in sessionStorage so it survives any refresh
        sessionStorage.setItem('deputy_oauth_code', code);
        sessionStorage.setItem('deputy_oauth_state', state);
        sessionStorage.setItem('deputy_oauth_timestamp', Date.now().toString());
        
    } else if (error) {
        sessionStorage.setItem('deputy_oauth_error', error);
    }
    
    // Check if we have stored OAuth data from a previous page load
    const storedCode = sessionStorage.getItem('deputy_oauth_code');
    if (storedCode) {
        const timestamp = sessionStorage.getItem('deputy_oauth_timestamp');
        const age = Date.now() - parseInt(timestamp);
    }
})();


    function checkAccess() {
        var code = document.getElementById('accessCode').value.trim().toUpperCase();
        var rememberMe = document.getElementById('rememberMe') ? document.getElementById('rememberMe').checked : false;
        var errorEl = document.getElementById('accessError');
        var validCodes = ['BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003', 'BETA-VENUE-004', 'BETA-VENUE-005', 'FITZGERALD-TEST', 'DEMO-2025'];
        
        if (!code) {
            if (errorEl) {
                errorEl.textContent = 'Please enter an access code';
                errorEl.classList.remove('hidden');
            }
            return;
        }
        
        if (validCodes.includes(code)) {
            localStorage.setItem('fitzhr_access_code', code);
            if (rememberMe) {
                localStorage.setItem('fitzhr_remember_me', 'true');
            }
            localStorage.setItem('fitzhr_last_login', new Date().toISOString());
            
            var accessScreen = document.getElementById('accessScreen');
            var assistantScreen = document.getElementById('assistantScreen');
            if (accessScreen) accessScreen.classList.add('hidden');
            if (assistantScreen) assistantScreen.classList.remove('hidden');
            
            var userCodeEl = document.getElementById('userCode');
            if (userCodeEl) userCodeEl.textContent = code;
            
            window.currentUser = code;
            
            // Admin access is now email-based only (via Google Sign-In)
            
            if (typeof initConversationSystem === 'function') {
                initConversationSystem();
            }
        } else {
            if (errorEl) {
                errorEl.textContent = 'Invalid access code. Please check and try again.';
                errorEl.classList.remove('hidden');
            }
        }
    }
    </script>
    
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- CHATGPT-STYLE SIDEBAR -->
    <div id="chatSidebar" class="chat-sidebar closed">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="flex items-center gap-2">
                <h2 class="text-lg font-bold text-white" id="sidebarVenueName">Fitz</h2>
                <button onclick="openProfileMenu()" class="text-slate-400 hover:text-amber-400 transition-colors" title="Profile">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </button>
            </div>
            <button onclick="toggleSidebar()" class="sidebar-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- New Chat Button -->
        <button onclick="createNewChatFromSidebar()" class="sidebar-new-chat-btn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>New Chat</span>
        </button>
        
        <!-- Sidebar Content -->
        <div class="sidebar-content">
            <!-- Previous Chats Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Recent Chats (Last 5)</h3>
                <div id="sidebarChatsList" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No chats yet</p>
                </div>
            </div>
            
            <!-- Bookmarks Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Bookmarks</h3>
                <div id="sidebarBookmarksList" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No bookmarks yet</p>
                </div>
            </div>
            
            <!-- Recent Tools Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Recent Tools</h3>
                <div id="sidebarRecentTools" class="sidebar-items-list">
                    <p class="text-slate-500 text-sm py-4 text-center">No tools used yet</p>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Search</h3>
                <div class="px-3 py-2">
                    <input type="text" 
                           id="sidebarSearchInput" 
                           placeholder="Search conversations..."
                           class="w-full bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                           onkeyup="performSidebarSearch()">
                    <div id="sidebarSearchResults" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Logout Button - Bottom of Sidebar -->
            <div class="mt-auto pt-4 px-3 pb-3 border-t border-slate-700">
                <button onclick="logout()" 
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    <span>ðŸšª</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    
    <!-- WEEK 3: Search Modal -->
    <div id="searchModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ”</span> Search Conversations
                </h2>
                <button onclick="closeSearchModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <input type="text" id="searchInput" placeholder="Search messages, topics, or keywords..." 
                   class="w-full bg-slate-700 border-2 border-slate-600 rounded-xl px-6 py-4 text-white text-lg focus:border-amber-500 focus:outline-none mb-6"
                   onkeyup="performSearch()">
            
            <div id="searchResults" class="space-y-3">
                <p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>
            </div>
        </div>
    </div>
    
    <!-- WEEK 3: Bookmarks Modal -->
    <div id="bookmarksModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>â­</span> Bookmarked Conversations
                </h2>
                <button onclick="closeBookmarksModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <div id="bookmarksList" class="space-y-3">
                <p class="text-slate-400 text-center py-8">No bookmarks yet. Star a conversation to save it here!</p>
            </div>
        </div>
    </div>
    
    <!-- WEEK 3: Multi-File Upload Modal -->
    <div id="multiFileModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“</span> Upload Multiple Files
                    <span class="badge badge-new">NEW</span>
                </h2>
                <button onclick="closeMultiFileModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <div class="drag-drop-zone" id="dropZone" onclick="document.getElementById('multiFileInput').click()">
                <div class="text-6xl mb-4">ðŸ“¤</div>
                <p class="text-xl font-semibold text-white mb-2">Drag & Drop Files Here</p>
                <p class="text-slate-400 mb-4">or click to browse</p>
                <p class="text-sm text-slate-500">Supports PDF, DOCX, XLSX, CSV (Max 10 files, 5MB each)</p>
                <input type="file" id="multiFileInput" multiple accept=".pdf,.docx,.xlsx,.csv" class="hidden" onchange="handleMultiFileSelect(event)">
            </div>
            
            <div id="filesList" class="mt-6"></div>
            
            <button id="processFilesBtn" onclick="processMultipleFiles()" disabled
                    class="w-full mt-6 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl transition-all">
                Process Files
            </button>
        </div>
    </div>
    
    <!-- WEEK 3: Enhanced Analytics Modal -->
    <div id="analyticsModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border-2 border-purple-500 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-purple-400 flex items-center gap-2">
                    <span>ðŸ“Š</span> Analytics Dashboard
                    <span class="badge badge-new">ENHANCED</span>
                </h2>
                <button onclick="closeAnalyticsModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <!-- Chart Tabs -->
            <div class="flex gap-2 mb-6 border-b border-slate-700 pb-2">
                <button onclick="switchChart('usage')" class="chart-tab px-4 py-2 text-purple-400 border-b-2 border-purple-400 font-semibold" data-chart="usage">
                    Usage Over Time
                </button>
                <button onclick="switchChart('tools')" class="chart-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" data-chart="tools">
                    Tools Popularity
                </button>
                <button onclick="switchChart('engagement')" class="chart-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" data-chart="engagement">
                    Engagement
                </button>
            </div>
            
            <!-- Charts Container -->
            <div class="chart-container mb-6">
                <canvas id="analyticsChart"></canvas>
            </div>
            
            <button onclick="exportDetailedAnalytics()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-all">
                ðŸ“¥ Export Detailed Report (Excel)
            </button>
        </div>
    </div>
    
    <!-- Access Code Screen -->
<div id="accessScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-6xl w-full">
        <!-- Logo/Branding -->
        <div class="text-center mb-8 fade-in">
            <div class="inline-block bg-gradient-to-r from-amber-500 to-orange-600 p-1 rounded-2xl mb-4">
                <div class="bg-slate-900 px-8 py-4 rounded-xl">
                    <h1 class="text-4xl font-bold text-amber-500">FITZ</h1>
                    <p class="text-slate-400 text-sm mt-1">AI-Powered Hospitality HR Assistant</p>
                </div>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">HR Compliance. Simplified.</h2>
            <p class="text-slate-400 text-lg">Automated contracts, onboarding, and award compliance for Australian hospitality</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mb-8">
            
            <!-- Left Column: Sign In -->
            <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 fade-in">
                <h3 class="text-xl font-bold text-white mb-6 text-center">Sign In to Continue</h3>
                
                <!-- Google Sign-In -->
                <button 
                    onclick="signInWithGoogleFromAccess()"
                    class="w-full bg-white hover:bg-gray-50 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-105 flex items-center justify-center gap-3 shadow-lg mb-4"
                >
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path fill="#4285F4" d="M19.6 10.2c0-.7-.1-1.4-.2-2H10v3.8h5.4c-.2 1.2-1 2.2-2.1 2.9v2.5h3.4c2-1.8 3.1-4.5 3.1-7.2z"/>
                        <path fill="#34A853" d="M10 20c2.9 0 5.3-1 7.1-2.6l-3.4-2.5c-1 .7-2.2 1.1-3.7 1.1-2.8 0-5.2-1.9-6.1-4.5H.3v2.6C2.1 17.9 5.8 20 10 20z"/>
                        <path fill="#FBBC05" d="M3.9 11.5c-.4-1.2-.4-2.5 0-3.7V5.2H.3C-1 7.4-1 12.6.3 14.8l3.6-2.6z"/>
                        <path fill="#EA4335" d="M10 4c1.6 0 3 .5 4.1 1.6l3.1-3.1C15.3.9 12.9 0 10 0 5.8 0 2.1 2.1.3 5.2l3.6 2.6C4.8 5.9 7.2 4 10 4z"/>
                    </svg>
                    <span>Continue with Google</span>
                </button>

                <!-- Divider -->
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-slate-700"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-4 bg-slate-800 text-slate-400">OR</span>
                    </div>
                </div>

                <!-- Email Sign-In -->
                <div id="emailSignInSection">
                    <input 
                        type="email" 
                        id="emailInput"
                        placeholder="Enter your email"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 transition-all mb-3"
                    />
                    <button 
                        onclick="continueWithEmail()"
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all"
                    >
                        Continue with email
                    </button>
                    <p class="text-slate-500 text-xs mt-3 text-center">
                        We'll send you a magic link to sign in
                    </p>
                </div>

                <div class="mt-6 pt-6 border-t border-slate-700">
                    <p class="text-slate-400 text-xs text-center">
                        By continuing, you acknowledge our 
                        <a href="#" class="text-amber-500 hover:underline">Privacy Policy</a>
                    </p>
                </div>
            </div>

            <!-- Right Column: Meet Fitz -->
            <div class="space-y-4 fade-in">
                <!-- Meet Fitz Dropdown -->
                <div class="bg-slate-800 rounded-xl border border-slate-700">
                    <button onclick="toggleMeetFitz()" class="w-full p-6 flex items-center justify-between text-left hover:bg-slate-700/50 transition-all rounded-xl">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                                ðŸ¤–
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-lg">Meet Fitz</h3>
                                <p class="text-slate-400 text-sm">Your AI-powered HR assistant</p>
                            </div>
                        </div>
                        <svg id="meetFitzChevron" class="w-6 h-6 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="meetFitzContent" class="hidden px-6 pb-6 space-y-3">
                        <div class="pl-4 border-l-2 border-amber-500">
                            <p class="text-slate-300 text-sm mb-3">Fitz is powered by advanced AI to help Australian hospitality venues with:</p>
                            <ul class="space-y-2 text-sm text-slate-400">
                                <li class="flex items-start gap-2">
                                    <span class="text-amber-500 mt-0.5">âœ“</span>
                                    <span><strong class="text-white">Smart Employment Contracts</strong> - Generate compliant contracts in minutes</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-amber-500 mt-0.5">âœ“</span>
                                    <span><strong class="text-white">Onboarding Automation</strong> - AI-powered checklists for new hires</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-amber-500 mt-0.5">âœ“</span>
                                    <span><strong class="text-white">Training Plans</strong> - Role-specific training adapted to experience levels</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-amber-500 mt-0.5">âœ“</span>
                                    <span><strong class="text-white">24/7 HR Guidance</strong> - Instant answers to workplace questions</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-amber-500 mt-0.5">âœ“</span>
                                    <span><strong class="text-white">Award Compliance</strong> - Stay compliant with Australian hospitality awards</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            ðŸ‡¦ðŸ‡º
                        </div>
                        <div>
                            <h3 class="text-white font-bold">Built for Australia</h3>
                            <p class="text-slate-400 text-sm">Hospitality awards & compliance</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            âš¡
                        </div>
                        <div>
                            <h3 class="text-white font-bold">Always Available</h3>
                            <p class="text-slate-400 text-sm">24/7 instant HR support</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-amber-500/50 transition-all">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center text-2xl">
                            ðŸ”’
                        </div>
                        <div>
                            <h3 class="text-white font-bold">Secure & Private</h3>
                            <p class="text-slate-400 text-sm">Your data synced across devices</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trust Indicators -->
        <div class="bg-gradient-to-br from-amber-500/5 to-orange-600/5 border border-amber-500/30 rounded-2xl p-6 fade-in">
            <div class="text-center mb-4">
                <p class="text-amber-400 font-bold text-lg">Trusted by Australian Hospitality Venues</p>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">$12k</p>
                        <p class="text-slate-400 text-xs mt-1">Avg. Annual Savings</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">&lt;90s</p>
                        <p class="text-slate-400 text-xs mt-1">Avg. Response Time</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-700">
                        <p class="text-3xl font-bold text-amber-500">24/7</p>
                        <p class="text-slate-400 text-xs mt-1">Always Available</p>
                    </div>
                </div>
            </div>
            
            <!-- Testimonial -->
            <div class="mt-6 bg-slate-800/30 backdrop-blur-sm rounded-lg p-6 border border-slate-700/50">
                <div class="flex items-start gap-4">
                    <div class="text-3xl flex-shrink-0">â­â­â­â­â­</div>
                    <div class="flex-1">
                        <p class="text-slate-200 text-base italic leading-relaxed">
                            "Saved me $300 on a consultant call. Got my answer in 2 minutes instead of waiting days for a callback."
                        </p>
                        <p class="text-slate-500 text-sm mt-3">â€” Sarah M., Restaurant Owner, Melbourne</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleMeetFitz() {
    const content = document.getElementById('meetFitzContent');
    const chevron = document.getElementById('meetFitzChevron');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
    } else {
        content.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
    }
}

function continueWithEmail() {
    const email = document.getElementById('emailInput').value.trim();
    
    if (!email) {
        showAlert('Please enter your email address');
        return;
    }
    
    if (!email.includes('@')) {
        showAlert('Please enter a valid email address');
        return;
    }
    
    // For now, show a message (you can implement magic link later)
    showAlert('Email sign-in coming soon! Please use "Continue with Google" for now.');
    
    // TODO: Implement Firebase email link authentication
    // firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
}
</script>

        </div>
    </div>
</div>

    <!-- Main Assistant Screen (Hidden Initially) -->
    <div id="assistantScreen" class="hidden flex flex-col">
        <!-- Header -->
        <div id="mainHeader" class="bg-slate-800/80 backdrop-blur-sm border-b border-slate-700 px-4 md:px-6 py-3 md:py-4">
    <div class="max-w-5xl mx-auto">
        
        <!-- Mobile: Stacked Layout, Desktop: Side-by-side -->
        <div id="headerContent" class="flex flex-col md:flex-row md:items-center justify-between gap-3 md:gap-0">
            
            <!-- Left: Sidebar Toggle + Logo & Title -->
            <div id="headerLeft" class="flex items-center gap-3">
                <!-- Sidebar Toggle Button -->
                <button onclick="toggleSidebar()" class="sidebar-toggle-btn-header p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-xl">ðŸ¨</span>
                </div>
                <div id="headerTitle">
                    <h1 class="text-lg md:text-xl font-bold text-white">Fitz</h1>
                    <p id="headerSubtitle" class="text-xs text-slate-400"><span id="userTierDisplay">Free</span> Plan</p>
                </div>
            </div>

            <!-- Right: Simplified Buttons -->
            <div id="headerRight" class="flex items-center gap-2 text-sm">
                
                <!-- Credits Display -->
                <div id="creditsDisplay" class="hidden flex items-center gap-2 bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-1">
                        <span class="text-amber-400">ðŸ’³</span>
                        <span id="creditsBalance" class="font-bold text-green-400">0</span>
                        <span class="text-slate-300 text-xs">credits</span>
                    </div>
                    <div id="promptsDisplay" class="hidden border-l border-slate-500 pl-2 ml-1">
                        <span id="promptsCounter" class="text-white text-xs font-semibold bg-blue-600 px-2 py-0.5 rounded">20/20</span>
                    </div>
                    <button onclick="openCreditsModal()" class="text-amber-400 hover:text-amber-300 ml-1" title="Manage Credits">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Crisis Mode Button -->
                <button onclick="activateCrisisMode()" 
                        class="px-3 py-2 md:px-4 md:py-2 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold rounded-lg transition-all flex items-center gap-2 touch-manipulation">
                    <span class="text-lg md:text-xl">ðŸš¨</span>
                    <span class="hidden sm:inline">URGENT</span>
                </button>
                
                <!-- Book Expert Button -->
                <button onclick="openConsultationBookingModal()" 
                        class="px-3 py-2 md:px-4 md:py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-lg transition-all flex items-center gap-2 touch-manipulation shadow-lg shadow-purple-500/20">
                    <span class="text-lg md:text-xl">ðŸ“ž</span>
                    <span class="hidden sm:inline">Book Expert</span>
                </button>
                
                <!-- Divider (hidden on mobile) -->
                <div class="hidden md:block h-6 w-px bg-slate-600"></div>
                
                <!-- Secondary Buttons -->
                <div class="flex items-center gap-2">
                    <!-- Admin Button (hidden by default) -->
                    <button id="adminButton" onclick="showAdminDashboard()" 
                            class="hidden text-purple-400 hover:text-purple-300 font-medium transition-colors flex items-center gap-1 px-2 py-2 touch-manipulation">
                        <span>ðŸ“Š</span>
                        <span class="hidden sm:inline">Admin</span>
                    </button>
                    
                    <!-- Tools Dropdown -->
                    <div class="relative">
                        <button onclick="toggleToolsMenu()" 
                                id="toolsButton"
                                class="text-amber-400 hover:text-amber-300 font-medium transition-colors flex items-center gap-1 px-2 py-2 touch-manipulation">
                            <span>ðŸ› ï¸</span>
                            <span class="hidden sm:inline">Tools</span>
                        </button>
                    </div>
                </div>
                
                <!-- Divider (hidden on mobile) -->
                <div class="hidden md:block h-6 w-px bg-slate-600"></div>
                
                <!-- Account Actions -->
                <div class="flex items-center gap-2">
                    
                </div>
                
            </div>
        </div>
    </div>
</div>

        <!-- Daily Tip Banner -->
<div id="dailyTipBanner" class="bg-blue-500/10 border-b border-blue-500/20 px-6 py-3 cursor-pointer hover:bg-blue-500/15 transition-all" onclick="rotateTipManually()">
    <div class="max-w-5xl mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 flex-1">
            <span class="text-lg" id="dailyTipIcon">ðŸ’¡</span>
            <p class="text-blue-200 text-sm" id="dailyTipText">
                <strong>Daily Tip:</strong> <span id="dailyTipContent">Loading...</span>
            </p>
        </div>
        <button onclick="rotateTipManually(); event.stopPropagation();" 
                class="text-blue-300 hover:text-blue-100 text-xs px-3 py-1 bg-blue-500/20 rounded-lg transition-all">
            Next Tip â†’
        </button>
    </div>
</div>

        <!-- Messages Container (Scrollable Area) -->
<!-- Scroll to Bottom Button - Claude-style floating button -->
<button id="scrollToBottomBtn" onclick="scrollToBottom()" title="Scroll to bottom" aria-label="Scroll to bottom">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 9l6 6 6-6"/>
    </svg>
</button>

<div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-6">
    <div class="max-w-5xl mx-auto space-y-6">
        <!-- Messages will be added here dynamically -->
    </div>
</div>

<!-- Chat Input Area (ChatGPT Style) -->
<div class="bg-slate-800/80 backdrop-blur-sm border-t border-slate-700/50 px-6 py-4">
    <div class="max-w-3xl mx-auto">
        <div class="flex gap-2 items-end">
            <!-- Upload Button (+) -->
            <div class="relative">
                <!-- Hidden file inputs -->
                <input type="file" id="fileUploadInput" accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.txt" class="hidden" onchange="handleFileUpload(event)">
                <input type="file" id="imageUploadInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                
                <button onclick="toggleUploadMenu()" 
                        id="uploadButton"
                        class="p-3 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all touch-manipulation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
                
                <!-- Upload Menu Popup -->
                <div id="uploadMenu" class="hidden absolute bottom-full left-0 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl min-w-[200px] z-50">
                    <div class="p-2">
                        <button onclick="triggerFileUpload('file')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                            <span>ðŸ“„</span>
                            <span>Upload File</span>
                        </button>
                        <button onclick="triggerFileUpload('image')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                            <span>ðŸ–¼ï¸</span>
                            <span>Upload Image</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Text Input -->
            <textarea id="messageInput" 
                placeholder="Ask me anything about hospitality HR in Australia..." 
                rows="1"
                class="flex-1 bg-slate-900 text-slate-100 border border-slate-700 rounded-xl px-4 py-3 text-base md:text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none min-h-[44px] max-h-[200px]"
                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                oninput="autoResizeTextarea(this)"></textarea>
            
            <!-- Microphone Button (Right) -->
            <button onclick="toggleVoiceInput()" 
                    id="voiceButton"
                    title="Voice input"
                    class="p-3 text-slate-400 hover:text-amber-500 hover:bg-slate-700 rounded-lg transition-all touch-manipulation">
                <svg id="voiceIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </button>
            
            <!-- Send Button -->
            <button id="sendButton" onclick="sendMessage()" 
                    class="p-3 bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-slate-900 rounded-lg transition-all touch-manipulation">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
        
        <!-- Voice Recording Indicator -->
        <div id="voiceRecordingIndicator" class="hidden mt-3 flex items-center gap-2 text-sm text-amber-500">
            <div class="flex gap-1">
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></span>
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></span>
            </div>
            <span>Listening...</span>
            <button onclick="toggleVoiceInput()" class="ml-auto text-slate-400 hover:text-white text-xs underline">Stop</button>
        </div>
    </div>
</div>

<!-- Footer Disclaimer (Fixed at very bottom) -->
<div class="bg-slate-800/50 border-t border-slate-700/50 px-6 py-3">
    <div class="max-w-5xl mx-auto text-center">
        <p class="text-slate-400 text-xs mb-1">
            <span class="text-amber-400 font-semibold">â„¹ï¸ Information Only:</span> 
            This tool provides general guidance. All documents require professional review before use.
        </p>
        <p class="text-slate-500 text-xs">
            Professional Advice: 
            <a href="/cdn-cgi/l/email-protection#f29b9c949db2949b8688959780939e969a80dc919d9fdc9387" class="text-slate-400 hover:text-amber-400 underline"><span class="__cf_email__" data-cfemail="96fff8f0f9d6f0ffe2ecf1f3e4f7faf2fee4b8f5f9fbb8f7e3">[email&#160;protected]</span></a> | 
            <a href="tel:+61400211014" class="text-slate-400 hover:text-amber-400 underline">+61 400 211 014</a> | 
            <a href="#terms" onclick="showTermsOfService(); return false;" class="text-slate-400 hover:text-amber-400 underline">Terms</a>
        </p>
    </div>
</div>

</div>
     
<!-- Hidden Netlify Form for Beta Feedback Collection -->
    <form name="beta-feedback" netlify netlify-honeypot="bot-field" hidden>
        <input type="hidden" name="bot-field" />
        <input type="text" name="user">
        <input type="text" name="rating">
        <textarea name="likes"></textarea>
        <textarea name="improve"></textarea>
        <input type="text" name="willPay">
    </form>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-slate-700 fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Beta Feedback</h2>
            <p class="text-slate-400 mb-6">Your feedback helps us build the best AI assistant for hospitality HR. Thank you!</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">How would you rate the AI's responses?</label>
                    <div class="flex gap-2">
                        <button onclick="setRating(1)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">1 â­</button>
                        <button onclick="setRating(2)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">2 â­</button>
                        <button onclick="setRating(3)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">3 â­</button>
                        <button onclick="setRating(4)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">4 â­</button>
                        <button onclick="setRating(5)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">5 â­</button>
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What did you like?</label>
                    <textarea id="feedbackLikes" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What worked well for you?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What could be improved?</label>
                    <textarea id="feedbackImprove" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What would make this better?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Would you pay $49/month for this service?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="yes" class="text-amber-500">
                            <span>Yes, definitely</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="maybe" class="text-amber-500">
                            <span>Maybe</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="no" class="text-amber-500">
                            <span>No</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="submitFeedback()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                    Submit Feedback
                </button>
                <button onclick="closeFeedback()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Crisis Mode Modal -->
    <div id="crisisModal" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-4 border-red-500 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">ðŸš¨</div>
                <h2 class="text-3xl font-bold text-red-400 mb-2">CRISIS MODE ACTIVATED</h2>
                <p class="text-slate-300">Emergency HR support - Immediate response</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">What's the urgent situation?</label>
                    <select id="crisisType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white">
                        <option value="">Select crisis type...</option>
                        <option value="injury">Workplace Injury</option>
                        <option value="harassment">Sexual Harassment / Bullying</option>
                        <option value="theft">Theft / Serious Misconduct</option>
                        <option value="walkout">Employee Walkout / Strike</option>
                        <option value="discrimination">Discrimination Complaint</option>
                        <option value="violence">Workplace Violence / Threat</option>
                        <option value="death">Death / Medical Emergency</option>
                        <option value="other">Other Urgent Matter</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Describe what happened (be specific):</label>
                    <textarea id="crisisDescription" rows="4" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400"
                              placeholder="Provide details: who, what, when, where..."></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Your contact number for urgent callback:</label>
                    <input type="tel" id="crisisPhone" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                           placeholder="04XX XXX XXX">
                </div>
            </div>

            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4 mb-6">
                <p class="text-red-300 font-bold mb-2">ðŸš¨ IMMEDIATE ACTIONS:</p>
                <ul class="text-red-200 text-sm space-y-1 ml-4">
                    <li>â€¢ Document everything NOW (photos, witnesses, times)</li>
                    <li>â€¢ Do NOT investigate yourself</li>
                    <li>â€¢ Separate involved parties immediately</li>
                    <li>â€¢ Preserve evidence / CCTV footage</li>
                    <li>â€¢ Contact emergency services if needed (000)</li>
                </ul>
            </div>

            <div class="flex gap-3">
                <button onclick="submitCrisis()" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all text-lg">
                    ðŸš¨ GET URGENT HELP NOW
                </button>
                <button onclick="closeCrisisModal()" 
                        class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Cancel
                </button>
            </div>

            <p class="text-center text-slate-400 text-sm mt-4">
                A Senior Consultant will contact you within 15 minutes
            </p>
        </div>
    </div>

    <!-- Award Calculator Modal -->
    <div id="awardCalculatorModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>ðŸ’°</span> Award Rate Calculator
                    </h2>
                    <p class="text-slate-400 text-sm">Calculate exact pay with penalties and loadings</p>
                </div>
                <button onclick="closeToolModal('awardCalculatorModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Position / Classification</label>
                        <select id="calcPosition" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
    <option value="24.28">Introductory - $24.28</option>
    <option value="24.95">Level 1 (Food & Beverage) - $24.95</option>
    <option value="25.85">Level 2 (Cook Grade 1) - $25.85</option>
    <option value="26.70">Level 3 (Cook Grade 2) - $26.70</option>
    <option value="28.12">Level 4 (Tradesperson) - $28.12</option>
    <option value="29.88">Level 5 (Supervisor) - $29.88</option>
    <option value="30.68">Level 6 (Senior) - $30.68</option>
    <option value="custom">Custom Rate</option>
</select>
                    </div>

                    <div id="customRateDiv" class="hidden">
                        <label class="block text-slate-300 text-sm mb-2">Custom Base Rate ($/hr)</label>
                        <input type="number" id="calcCustomRate" step="0.01" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm"
                               placeholder="28.50">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Day of Week</label>
                        <select id="calcDay" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                            <option value="1.0">Monday-Friday</option>
                            <option value="1.5">Saturday</option>
                            <option value="1.75">Sunday</option>
                            <option value="2.5">Public Holiday</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Hours Worked</label>
                        <input type="number" id="calcHours" step="0.5" value="8" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Overtime Hours</label>
                        <input type="number" id="calcOvertime" step="0.5" value="0" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>
                </div>

                <button onclick="calculateAward()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Calculate Pay
                </button>

                <div id="calcResults" class="hidden bg-slate-900 border border-amber-500 rounded-lg p-6">
                    <h3 class="text-amber-500 font-bold text-lg mb-4">Pay Breakdown:</h3>
                    <div class="space-y-2 text-slate-200">
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Base Rate:</span>
                            <span class="font-bold" id="resultBaseRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Penalty/Loading Rate:</span>
                            <span class="font-bold" id="resultPenaltyRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Ordinary Hours Pay:</span>
                            <span class="font-bold" id="resultOrdinaryPay"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700" id="overtimeRow">
                            <span>Overtime Pay (1.5x):</span>
                            <span class="font-bold" id="resultOvertimePay"></span>
                        </div>
                        <div class="flex justify-between py-3 bg-amber-500/10 px-3 rounded mt-3">
                            <span class="text-lg font-bold">TOTAL PAY:</span>
                            <span class="text-2xl font-bold text-amber-500" id="resultTotal"></span>
                        </div>
                    </div>
                    <button onclick="downloadCalculation()" 
                            class="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-all text-sm">
                        ðŸ“Š Download Excel Breakdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Roster Optimizer Modal -->
    <div id="rosterOptimizerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
    		<span>ðŸ“‹</span> Roster Cost Optimizer
		</h2>
                    <p class="text-slate-400 text-sm">Upload roster to analyze costs and optimize scheduling</p>
                </div>
                <button onclick="closeToolModal('rosterOptimizerModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                    <input type="file" id="rosterUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleRosterUpload(event)">
                    <button onclick="document.getElementById('rosterUpload').click()" 
                            class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                        ðŸ“¤ Upload Current Roster
                    </button>
                    <p class="text-slate-400 text-sm mt-3">Supports Excel (.xlsx, .xls) or CSV files</p>
                </div>

                <div class="text-center text-slate-400">
                    <p class="mb-2">Or manually enter roster details:</p>
                    <button onclick="showManualRoster()" 
                            class="text-amber-500 hover:text-amber-400 underline">
                        Enter Roster Manually
                    </button>
                </div>

                <div id="rosterResults" class="hidden space-y-4">
                    <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                        <h3 class="text-green-500 font-bold text-lg mb-4">ðŸ“Š Current Roster Analysis:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Labor Cost</p>
                                <p class="text-2xl font-bold text-white" id="rosterCurrentCost">$4,287</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Hours</p>
                                <p class="text-2xl font-bold text-white" id="rosterTotalHours">147 hrs</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm" id="rosterIssues"></div>
                    </div>

                    <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
                        <h3 class="text-amber-500 font-bold text-lg mb-4">âœ¨ Optimized Roster:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Optimized Cost</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterOptimizedCost">$3,875</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Savings</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterSavings">$412</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-slate-300" id="rosterOptimizations"></div>
                        
                        <button onclick="downloadOptimizedRoster()" 
                                class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                            ðŸ“¥ Download Optimized Roster
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Termination Risk Assessor Modal -->
    <div id="terminationRiskModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>âš–ï¸</span> Termination Risk Assessor
                    </h2>
                    <p class="text-slate-400 text-sm">Assess unfair dismissal risk before terminating employment</p>
                </div>
                <button onclick="closeToolModal('terminationRiskModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <form id="terminationForm" class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">How long has the employee worked for you?</label>
                    <select id="termTenure" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="under6months">Under 6 months</option>
                        <option value="6to12months">6-12 months</option>
                        <option value="over12months">Over 12 months</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Reason for termination:</label>
                    <select id="termReason" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="performance">Poor Performance</option>
                        <option value="misconduct">Misconduct</option>
                        <option value="serious-misconduct">Serious Misconduct</option>
                        <option value="redundancy">Redundancy</option>
                        <option value="incompatibility">Not a Good Fit</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Have you given formal warnings?</label>
                    <select id="termWarnings" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="none">No warnings given</option>
                        <option value="verbal">Verbal warning only</option>
                        <option value="written">Written warning(s) given</option>
                        <option value="final">Final written warning given</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Did you provide opportunity to improve?</label>
                    <select id="termImprovement" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="no">No</option>
                        <option value="informal">Informal discussions only</option>
                        <option value="formal">Formal improvement plan with timeframe</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Is the employee in any protected category?</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termPregnant" class="rounded">
                            <span>Pregnant or on parental leave</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termInjured" class="rounded">
                            <span>Recently injured or on workers comp</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termComplaint" class="rounded">
                            <span>Made workplace complaint recently</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termUnion" class="rounded">
                            <span>Union member or delegate</span>
                        </label>
                    </div>
                </div>

                <button type="button" onclick="assessTerminationRisk()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Assess Risk
                </button>
            </form>

            <div id="termRiskResults" class="hidden mt-6"></div>
        </div>
    </div>

    <!-- Scenario Analysis Modal -->
    <div id="scenarioAnalysisModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>ðŸŽ¯</span> Custom Scenario Analysis
                    </h2>
                    <p class="text-slate-400 text-sm">Get tailored advice for your specific situation</p>
                </div>
                <button onclick="closeToolModal('scenarioAnalysisModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">Tell me about your venue:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="scenarioVenueType" placeholder="e.g., Restaurant, Hotel, CafÃ©" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                        <input type="text" id="scenarioLocation" placeholder="e.g., Sydney CBD" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Number of employees:</label>
                    <input type="number" id="scenarioStaffCount" placeholder="e.g., 15" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Describe your situation in detail:</label>
                    <textarea id="scenarioDescription" rows="6" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white text-sm placeholder-slate-400"
                              placeholder="Be as specific as possible: What's the issue? What's the context? What have you tried? What are your concerns?"></textarea>
                </div>

                <button onclick="analyzeScenario()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Generate Custom Analysis
                </button>

                <div id="scenarioResults" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Xero Integration Modal -->
    <div id="xeroIntegrationModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>ðŸ”—</span> Xero Payroll Integration
                    </h2>
                    <p class="text-slate-400 text-sm">Connect to Xero for automatic payroll analysis</p>
                </div>
                <button onclick="closeToolModal('xeroIntegrationModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div id="xeroNotConnected" class="space-y-6">
                <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-6">
                    <h3 class="text-blue-400 font-bold mb-3">What You'll Get:</h3>
                    <ul class="space-y-2 text-slate-300 text-sm">
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">âœ“</span>
                            <span>Automatic labor cost analysis</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">âœ“</span>
                            <span>Overtime and penalty rate tracking</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">âœ“</span>
                            <span>Cost trend alerts</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">âœ“</span>
                            <span>Compliance risk detection</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 text-center">
                    <p class="text-slate-300 mb-4">Connect your Xero account securely:</p>
                    <button onclick="connectXero()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-all inline-flex items-center gap-2">
                        <span>ðŸ”—</span>
                        <span>Connect to Xero</span>
                    </button>
                    <p class="text-slate-500 text-xs mt-3">Secure OAuth 2.0 connection</p>
                </div>
            </div>

            <div id="xeroConnected" class="hidden space-y-4">
                <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-center">
                    <p class="text-green-400 font-bold">âœ“ Connected to Xero</p>
                </div>
                <div class="space-y-3" id="xeroAnalysis"></div>
            </div>
        </div>
    </div>

<!-- ========================================== -->
<!-- VENUE ONBOARDING MODAL -->
<!-- ========================================== -->

<div id="venueOnboardingModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-2 border-amber-500 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸ¨</div>
            <h2 class="text-3xl font-bold text-amber-500 mb-2">Let's Get to Know Your Venue</h2>
            <p class="text-slate-300">This helps me give you tailored advice. Takes 2 minutes.</p>
        </div>

        <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-400">Step <span id="onboardingStep">1</span> of 5</span>
                <span class="text-sm text-amber-400" id="onboardingProgress">20% Complete</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="onboardingProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 20%"></div>
            </div>
        </div>

        <div id="onboardingStepContent" class="space-y-6">
            <div class="onboarding-step" data-step="1">
                <h3 class="text-xl font-bold text-white mb-4">First, let's get your details</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Your Name</label>
                        <input type="text" id="onboardingUserName" 
                               placeholder="e.g., Sarah Johnson"
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Venue Name</label>
                        <input type="text" id="onboardingVenueName" 
                               placeholder="e.g., The Golden Fork"
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                </div>
                <button onclick="saveOnboardingNameAndVenue()" 
                        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Next â†’
                </button>
            </div>

            <div class="onboarding-step hidden" data-step="2">
                <h3 class="text-xl font-bold text-white mb-4">What type of venue do you run?</h3>
                <select id="onboardingVenueType" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
                    <option value="">Select venue type...</option>
                    <option value="bakery-cafe">Bakery CafÃ©</option>
                    <option value="bar">Bar</option>
                    <option value="bistro">Bistro</option>
                    <option value="boutique-hotel">Boutique Hotel</option>
                    <option value="brewery">Brewery / Brewpub</option>
                    <option value="cafe">CafÃ©</option>
                    <option value="cinema-fnb">Cinema with Food & Beverage Service</option>
                    <option value="conference-venue">Conference Venue</option>
                    <option value="dessert-bar">Dessert Bar</option>
                    <option value="distillery-bar">Distillery Bar</option>
                    <option value="entertainment-venue">Entertainment Venue (Comedy Club / Theatre)</option>
                    <option value="food-court">Food Court Outlet</option>
                    <option value="function-centre">Function Centre</option>
                    <option value="hotel-accommodation">Hotel (Accommodation Venue)</option>
                    <option value="ice-cream-bar">Ice Cream / Gelato Bar</option>
                    <option value="juice-bar">Juice / Smoothie Bar</option>
                    <option value="live-music-venue">Live Music Venue</option>
                    <option value="motel">Motel</option>
                    <option value="nightclub">Nightclub</option>
                    <option value="pub">Pub / Hotel</option>
                    <option value="resort">Resort</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="rooftop-bar">Rooftop Bar</option>
                    <option value="serviced-apartments">Serviced Apartments</option>
                    <option value="sports-bar">Sports Bar</option>
                    <option value="tea-house">Tea House</option>
                    <option value="wine-bar">Wine Bar</option>
                </select>
                <button onclick="saveOnboardingVenueType()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Next â†’
                </button>
            </div>

            <div class="onboarding-step hidden" data-step="3">
                <h3 class="text-xl font-bold text-white mb-4">Where is your venue located?</h3>
                <select id="onboardingLocation" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
                    <option value="">Select state...</option>
                    <option value="NSW">New South Wales</option>
                    <option value="VIC">Victoria</option>
                    <option value="QLD">Queensland</option>
                    <option value="SA">South Australia</option>
                    <option value="WA">Western Australia</option>
                    <option value="TAS">Tasmania</option>
                    <option value="NT">Northern Territory</option>
                    <option value="ACT">Australian Capital Territory</option>
                </select>
                <input type="text" id="onboardingCity" placeholder="City/Suburb" 
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
                <button onclick="saveOnboardingLocation()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                    Next â†’
                </button>
            </div>

            <div class="onboarding-step hidden" data-step="4">
                <h3 class="text-xl font-bold text-white mb-4">How many staff do you have?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveOnboardingAnswer('staffCount', '1-5')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">ðŸ‘¤</div>
                        <div class="font-semibold">1-5 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '6-15')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">ðŸ‘¥</div>
                        <div class="font-semibold">6-15 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '16-30')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                        <div class="font-semibold">16-30 staff</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('staffCount', '30+')" class="p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all">
                        <div class="text-3xl mb-2">ðŸ¢</div>
                        <div class="font-semibold">30+ staff</div>
                    </button>
                </div>
            </div>

            <div class="onboarding-step hidden" data-step="5">
                <h3 class="text-xl font-bold text-white mb-4">Which award covers most of your staff?</h3>
                <div class="space-y-3">
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Hospitality Industry (General) Award')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Hospitality Industry (General) Award</div>
                        <div class="text-xs opacity-70">Restaurants, cafÃ©s, hotels, pubs</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Fast Food Industry Award')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Fast Food Industry Award</div>
                        <div class="text-xs opacity-70">QSR, takeaway, delivery</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('primaryAward', 'Not sure')" 
                            class="w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">ðŸ¤· Not sure</div>
                    </button>
                </div>
            </div>

            <div class="onboarding-step hidden" data-step="6">
                <h3 class="text-xl font-bold text-white mb-4">What's your biggest HR challenge?</h3>
                <div class="space-y-2">
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'rostering', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">ðŸ“… Rostering & compliance</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'awards', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">ðŸ’° Understanding award rates</div>
                    </button>
                    <button onclick="saveOnboardingAnswer('mainChallenge', 'performance', true)" 
                            class="w-full p-3 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">ðŸ“Š Performance management</div>
                    </button>
                </div>
            </div>
        </div>

        <button onclick="skipOnboarding()" class="mt-4 text-slate-400 hover:text-white text-sm">
            Skip for now â†’
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- VENUE SETTINGS MODAL -->
<!-- ========================================== -->

<div id="venueSettingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>âš™ï¸</span> Venue Settings
                </h2>
                <p class="text-slate-400 text-sm">Update your venue information</p>
            </div>
            <button onclick="closeVenueSettings()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div id="venueSettingsContent" class="space-y-4"></div>

        <div class="flex gap-3 mt-6">
            <button onclick="saveVenueSettings()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">
                ðŸ’¾ Save Changes
            </button>
            <button onclick="closeVenueSettings()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- ADMIN ANALYTICS DASHBOARD -->
<!-- ========================================== -->

<div id="adminDashboardModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50 overflow-y-auto">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border-2 border-purple-500 fade-in my-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-3xl font-bold text-purple-400 flex items-center gap-2">
                    <span>ðŸ“Š</span> Admin Analytics Dashboard
                </h2>
                <p class="text-slate-400 text-sm">Real-time user activity and conversation insights</p>
            </div>
            <button onclick="closeAdminDashboard()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Total Users</p>
                <p class="text-3xl font-bold text-purple-400" id="statTotalUsers">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Total Messages</p>
                <p class="text-3xl font-bold text-purple-400" id="statTotalMessages">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Active Today</p>
                <p class="text-3xl font-bold text-purple-400" id="statActiveToday">0</p>
            </div>
            <div class="bg-slate-900 border border-purple-500/30 rounded-lg p-4">
                <p class="text-slate-400 text-xs mb-1">Avg Session</p>
                <p class="text-3xl font-bold text-purple-400" id="statAvgSession">0m</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-slate-700">
            <button onclick="switchAdminTab('conversations')" 
                    class="admin-tab px-4 py-2 text-purple-400 border-b-2 border-purple-400 font-semibold" 
                    data-tab="conversations">
                ðŸ’¬ Conversations
            </button>
            <button onclick="switchAdminTab('themes')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="themes">
                ðŸŽ¯ Popular Themes
            </button>
            <button onclick="switchAdminTab('users')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="users">
                ðŸ‘¥ User Profiles
            </button>
            <button onclick="switchAdminTab('highrisk')" 
                    class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
                    data-tab="highrisk">
                ðŸš¨ High-Risk Topics
            </button>
	    <button onclick="switchAdminTab('documents')" 
        	class="admin-tab px-4 py-2 text-slate-400 hover:text-purple-400 transition-colors" 
        	data-tab="documents">
    	     ðŸ“ Generated Documents
	    </button>
        </div>

<!-- Tab Content -->
<div id="adminTabContent" class="min-h-[400px] max-h-[500px] overflow-y-auto">
    <!-- Conversations Tab -->
    <div id="adminConversationsTab" class="admin-tab-content">
        <div class="bg-slate-900 rounded-lg p-4 mb-4">
            <input type="text" id="conversationSearch" placeholder="ðŸ” Search conversations..." 
                   onkeyup="filterConversations()"
                   class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
        </div>
        <div id="conversationsList" class="space-y-3"></div>
    </div>

    <!-- Themes Tab -->
    <div id="adminThemesTab" class="admin-tab-content hidden">
        <div id="themesList" class="space-y-3"></div>
    </div>

    <!-- Users Tab -->
    <div id="adminUsersTab" class="admin-tab-content hidden">
        <div id="usersList" class="space-y-3"></div>
    </div>

    <!-- High-Risk Tab -->
    <div id="adminHighRiskTab" class="admin-tab-content hidden">
        <div id="highRiskList" class="space-y-3"></div>
    </div>

    <!-- Documents Tab -->
    <div id="adminDocumentsTab" class="admin-tab-content hidden">
        <div id="documentsList" class="space-y-3"></div>
    </div>
</div>

        <!-- Export Button -->
        <div class="mt-6 flex gap-3">
            <button onclick="exportAnalytics()" 
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-all">
                ðŸ“¥ Export Analytics (Excel)
            </button>
            <button onclick="refreshAnalytics()" 
                    class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                ðŸ”„ Refresh
            </button>
            <button onclick="closeAdminDashboard()" 
                    class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                Close
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MOBILE TOOLS MENU MODAL -->
<!-- ========================================== -->
<div id="mobileToolsModal" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="w-full h-full flex flex-col">
        <!-- Header -->
        <div class="bg-slate-800 border-b border-slate-700 p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-amber-500 flex items-center gap-2">
                <span>ðŸ› ï¸</span> Tools
            </h2>
            <button onclick="closeMobileTools()" class="text-slate-400 hover:text-white text-2xl p-2">
                Ã—
            </button>
        </div>
        
        <!-- Tools List -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="space-y-2 max-w-2xl mx-auto">
                <button onclick="openToolFromMobile('awardWizard')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ§™</span>
                    <div>
                        <div class="font-semibold">Award Wizard</div>
                        <div class="text-sm text-slate-400">Interactive award classification</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('rosterStressTester')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ’¥</span>
                    <div>
                        <div class="font-semibold">Roster Stress Test</div>
                        <div class="text-sm text-slate-400">Test roster for compliance issues</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('complianceCalendar')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ“…</span>
                    <div>
                        <div class="font-semibold">Compliance Calendar</div>
                        <div class="text-sm text-slate-400">Track important HR dates</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('awardCalculator')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ’°</span>
                    <div>
                        <div class="font-semibold">Award Calculator</div>
                        <div class="text-sm text-slate-400">Calculate award rates instantly</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('documentBuilder')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ“</span>
                    <div>
                        <div class="font-semibold">Document Builder</div>
                        <div class="text-sm text-slate-400">Create HR documents</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('recruitmentToolkit')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ”</span>
                    <div>
                        <div class="font-semibold">Recruitment Toolkit</div>
                        <div class="text-sm text-slate-400">Job descriptions, interviews & reference checks</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('newEmployeeToolkit')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸŒŸ</span>
                    <div>
                        <div class="font-semibold">New Employee Toolkit</div>
                        <div class="text-sm text-slate-400">Create employment contracts</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('terminationRisk')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">âš–ï¸</span>
                    <div>
                        <div class="font-semibold">Termination Risk</div>
                        <div class="text-sm text-slate-400">Assess termination risks</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('scenarioAnalysis')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸŽ¯</span>
                    <div>
                        <div class="font-semibold">Scenario Analysis</div>
                        <div class="text-sm text-slate-400">Analyze HR scenarios</div>
                    </div>
                </button>
                
                <button onclick="openToolFromMobile('xeroIntegration')" class="w-full text-left px-6 py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 rounded-xl text-white flex items-center gap-4 touch-manipulation border border-slate-700 transition-all">
                    <span class="text-2xl">ðŸ”—</span>
                    <div>
                        <div class="font-semibold">Xero Integration</div>
                        <div class="text-sm text-slate-400">Connect with Xero</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: AWARD WIZARD -->
<!-- ========================================== -->

<div id="awardWizardModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div id="awardWizardContainer" class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ§™</span> Award Wizard
                </h2>
                <p class="text-slate-400 text-sm">Interactive award classification - find the right pay rate</p>
            </div>
            <button onclick="closeToolModal('awardWizardModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Step Progress -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-400">Step <span id="wizardCurrentStep">1</span> of 5</span>
                <span class="text-sm text-amber-400" id="wizardProgress">20% Complete</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="wizardProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 20%"></div>
            </div>
        </div>

        <!-- Wizard Steps -->
        <div id="wizardSteps" class="space-y-6">
            
            <!-- Step 1: Role -->
<div class="wizard-step" data-step="1">
    <h3 class="text-lg font-bold text-white mb-4">What's their role?</h3>
    <div class="space-y-2">
        <!-- Food & Beverage -->
        <button onclick="wizardAnswer('role', 'waiter')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ‘”</span>
            <div>
                <div class="font-semibold">Waiter / Food & Beverage Attendant</div>
                <div class="text-xs opacity-70">Takes orders, serves food & drinks</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'bartender')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ¸</span>
            <div>
                <div class="font-semibold">Bartender</div>
                <div class="text-xs opacity-70">Makes and serves drinks at bar</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'barista')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">â˜•</span>
            <div>
                <div class="font-semibold">Barista</div>
                <div class="text-xs opacity-70">Makes coffee & beverages</div>
            </div>
        </button>
        
        <!-- Kitchen -->
        <button onclick="wizardAnswer('role', 'cook')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ‘¨â€ðŸ³</span>
            <div>
                <div class="font-semibold">Cook / Chef</div>
                <div class="text-xs opacity-70">Prepares food in kitchen</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'kitchen-hand')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ§¹</span>
            <div>
                <div class="font-semibold">Kitchen Hand / Dishwasher</div>
                <div class="text-xs opacity-70">Cleaning, prep work</div>
            </div>
        </button>
        
        <!-- Management -->
        <button onclick="wizardAnswer('role', 'supervisor')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ‘”</span>
            <div>
                <div class="font-semibold">Supervisor / Shift Manager</div>
                <div class="text-xs opacity-70">Manages team & operations</div>
            </div>
        </button>
        
        <!-- Front of House -->
        <button onclick="wizardAnswer('role', 'receptionist')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ“ž</span>
            <div>
                <div class="font-semibold">Receptionist / Front Desk</div>
                <div class="text-xs opacity-70">Check-in, guest services</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'housekeeper')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ›ï¸</span>
            <div>
                <div class="font-semibold">Housekeeper / Room Attendant</div>
                <div class="text-xs opacity-70">Cleans rooms, maintains facilities</div>
            </div>
        </button>
        
        <!-- Other -->
        <button onclick="wizardAnswer('role', 'security')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">ðŸ›¡ï¸</span>
            <div>
                <div class="font-semibold">Security / Door Person</div>
                <div class="text-xs opacity-70">Venue security, crowd control</div>
            </div>
        </button>
    </div>
</div>

            <!-- Step 2: Experience -->
            <div class="wizard-step hidden" data-step="2">
                <h3 class="text-lg font-bold text-white mb-4">What's their experience level?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('experience', 'intro')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Introductory / No experience</div>
                        <div class="text-xs opacity-70">Just starting out, learning basics</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level1')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 1 - Basic skills</div>
                        <div class="text-xs opacity-70">Can perform routine tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level2')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 2 - Competent</div>
                        <div class="text-xs opacity-70">Works independently, some variety</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level3')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 3 - Advanced</div>
                        <div class="text-xs opacity-70">Skilled, handles complex tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level4')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 4 - Supervisor/Trade</div>
                        <div class="text-xs opacity-70">Manages others or trade qualified</div>
                    </button>
                </div>
            </div>

            <!-- Step 3: Hours -->
            <div class="wizard-step hidden" data-step="3">
                <h3 class="text-lg font-bold text-white mb-4">What hours do they typically work?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('hours', 'weekday-day')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Daytime</div>
                        <div class="text-xs opacity-70">Regular business hours</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'weekday-night')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Evenings/Nights</div>
                        <div class="text-xs opacity-70">After 7pm or late shifts</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'saturday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Saturdays</div>
                        <div class="text-xs opacity-70">Weekend penalty rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'sunday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Sundays</div>
                        <div class="text-xs opacity-70">Higher penalty rates</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'public-holiday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Public Holidays</div>
                        <div class="text-xs opacity-70">Highest penalty rates</div>
                    </button>
                </div>
            </div>

            <!-- Step 4: Age Category -->
<div class="wizard-step hidden" data-step="4">
    <h3 class="text-lg font-bold text-white mb-4">How old is the employee?</h3>
    <div class="space-y-2">
        <button onclick="wizardAnswer('age', 'adult')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">20 years or older</div>
            <div class="text-xs opacity-70">Adult rates apply</div>
        </button>
        <button onclick="wizardAnswer('age', 'junior')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">19 years or younger</div>
            <div class="text-xs opacity-70">Junior rates apply (percentage of adult rate)</div>
        </button>
    </div>
</div>

<!-- Step 5: Employment Type -->
<div class="wizard-step hidden" data-step="5">
    <h3 class="text-lg font-bold text-white mb-4">What type of employment?</h3>
    <div class="space-y-2">
        <button onclick="wizardAnswer('employment', 'casual')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Casual</div>
            <div class="text-xs opacity-70">25% loading, no leave entitlements</div>
        </button>
        <button onclick="wizardAnswer('employment', 'part-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Part-Time</div>
            <div class="text-xs opacity-70">Regular hours, pro-rata leave</div>
        </button>
        <button onclick="wizardAnswer('employment', 'full-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
            <div class="font-semibold">Full-Time</div>
            <div class="text-xs opacity-70">38 hours/week, full entitlements</div>
        </button>
    </div>
</div>

        <!-- Results (hidden initially) -->
        <div id="wizardResults" class="hidden mt-6">
            <div class="bg-green-500/10 border-2 border-green-500 rounded-lg p-6">
                <h3 class="text-green-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>âœ…</span>
                    <span>Award Classification Complete!</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Applicable Award</p>
                        <p class="font-bold text-lg" id="resultAward"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Classification Level</p>
                            <p class="font-bold" id="resultLevel"></p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Base Rate (per hour)</p>
                            <p class="font-bold text-2xl text-amber-400" id="resultRate"></p>
                        </div>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Penalty Rates & Loadings:</p>
                        <div id="resultPenalties" class="text-sm space-y-1"></div>
                    </div>

                    <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4">
                        <p class="font-semibold text-blue-400 mb-2">ðŸ“ Next Steps:</p>
                        <ul class="text-sm space-y-1" id="resultNextSteps"></ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="downloadWizardResults()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                        ðŸ“„ Download Summary
                    </button>
                    <button onclick="resetWizard()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                        Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>

        <!-- Back button (shown after step 1) -->
        <button id="wizardBackBtn" onclick="wizardGoBack()" class="hidden mt-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2">
            <span>â†</span>
            <span>Go Back</span>
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: ROSTER STRESS TESTER -->
<!-- ========================================== -->

<div id="rosterStressTesterModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ’¥</span> Roster Stress Test
                </h2>
                <p class="text-slate-400 text-sm">Upload or describe your roster - we'll find compliance risks</p>
            </div>
            <button onclick="closeToolModal('rosterStressTesterModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div class="space-y-6">
            <!-- Upload Option -->
            <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                <input type="file" id="rosterStressUpload" accept=".xlsx,.xls,.csv,.pdf" class="hidden" onchange="analyzeRosterFile(event)">
                <button onclick="document.getElementById('rosterStressUpload').click()" 
                        class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all mb-3">
                    ðŸ“¤ Upload Roster
                </button>
                <p class="text-slate-400 text-sm">Supports Excel, CSV, or PDF</p>
            </div>

            <div class="text-center text-slate-400">
                <p class="mb-2">Or describe your roster:</p>
            </div>

            <!-- Manual Input Option -->
            <div class="bg-slate-900 rounded-lg p-6">
                <label class="block text-slate-300 font-medium mb-3">Tell me about your current roster:</label>
                <textarea id="rosterDescription" rows="6" 
                          class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500"
                          placeholder="Example: 
- John works Mon-Sat (6 days straight)
- Sarah: 7-hour shift with no break
- Mike: 52 hours this week
- All staff work Sundays regularly

Be as specific as possible!"></textarea>
                <button onclick="analyzeRosterDescription()" 
                        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    ðŸ’¥ Run Stress Test
                </button>
            </div>

            <!-- Results -->
            <div id="rosterStressResults" class="hidden space-y-4"></div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: COMPLIANCE CALENDAR -->
<!-- ========================================== -->

<div id="complianceCalendarModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“…</span> Compliance Calendar
                </h2>
                <p class="text-slate-400 text-sm">Upcoming deadlines & proactive compliance alerts</p>
            </div>
            <button onclick="closeToolModal('complianceCalendarModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- State/Territory Selector -->
        <div class="mb-6 bg-slate-900 rounded-lg p-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <span class="text-lg">ðŸ“</span>
                    <span class="text-slate-300 text-sm">Showing public holidays for:</span>
                </div>
                <select id="complianceStateSelector" onchange="updatePublicHolidays()" 
                        class="bg-slate-700 text-white border border-slate-600 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-amber-500">
                    <option value="NSW">New South Wales</option>
                    <option value="VIC">Victoria</option>
                    <option value="QLD">Queensland</option>
                    <option value="SA">South Australia</option>
                    <option value="WA">Western Australia</option>
                    <option value="TAS">Tasmania</option>
                    <option value="NT">Northern Territory</option>
                    <option value="ACT">Australian Capital Territory</option>
                </select>
            </div>
            <p class="text-xs text-slate-500 mt-2">ðŸ’¡ This is based on your venue location. Change if you operate in multiple states.</p>
        </div>

        <!-- Public Holidays Section -->
        <div class="mb-6 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-lg p-4">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                <span>ðŸŽ‰</span>
                <span>2026 Public Holidays</span>
                <span id="stateHolidayBadge" class="ml-2 px-2 py-0.5 bg-purple-500/30 text-purple-300 text-xs rounded">NSW</span>
            </h3>
            <div id="publicHolidaysList" class="space-y-2 text-sm max-h-64 overflow-y-auto">
                <!-- Populated by JavaScript -->
            </div>
            <div class="mt-4 pt-3 border-t border-slate-700/50">
                <p class="text-xs text-slate-400 mb-2">âš ï¸ Staff working on public holidays are entitled to penalty rates under the Hospitality Award</p>
                <a href="https://www.fairwork.gov.au/employment-conditions/public-holidays/2026-public-holidays" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 text-xs text-amber-400 hover:text-amber-300 transition-colors">
                    <span>ðŸ“‹</span>
                    <span>View official list on Fair Work Ombudsman â†’</span>
                </a>
            </div>
        </div>

        <!-- Upcoming Alerts -->
        <div class="space-y-4 mb-6">
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ðŸš¨</span>
                    <div class="flex-1">
                        <p class="font-bold text-red-400">URGENT: Award Rate Increase</p>
                        <p class="text-sm text-slate-300 mt-1">Hospitality Award rates increase on 1 July 2026 </p>
                        <p class="text-xs text-slate-400 mt-2">Action: Update payroll systems & review all employment contracts</p>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-500/10 border-2 border-yellow-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">âš ï¸</span>
                    <div class="flex-1">
                        <p class="font-bold text-yellow-400">Casual Conversion Review Due</p>
                        <p class="text-sm text-slate-300 mt-1">Review all casual staff (12+ months) for conversion rights</p>
                        <p class="text-xs text-slate-400 mt-2">Deadline: Within 2 weeks</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-500/10 border-2 border-blue-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ðŸ“‹</span>
                    <div class="flex-1">
                        <p class="font-bold text-blue-400">Sexual Harassment Policy Update</p>
                        <p class="text-sm text-slate-300 mt-1">New Respect@Work legislation requires policy updates</p>
                        <p class="text-xs text-slate-400 mt-2">Recommended: Complete by end of month</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personalized Reminders -->
        <div class="bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                <span>ðŸ””</span>
                <span>Set Up Custom Reminders</span>
            </h3>
            
            <div class="space-y-3">
                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Award rate updates</p>
                        <p class="text-xs text-slate-400">Notify 2 weeks before changes</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Casual conversion reviews</p>
                        <p class="text-xs text-slate-400">Monthly reminder to check eligibility</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Public holiday notifications</p>
                        <p class="text-xs text-slate-400">Alert 1 week before each public holiday</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Annual leave accrual warnings</p>
                        <p class="text-xs text-slate-400">Alert when staff exceed 8 weeks leave</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Policy review reminders</p>
                        <p class="text-xs text-slate-400">Annual workplace policy updates</p>
                    </div>
                </label>
            </div>

            <button onclick="saveComplianceSettings()" 
                    class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                ðŸ’¾ Save Reminder Settings
            </button>
        </div>

        <!-- Calendar View -->
        <div class="mt-6 bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4">ðŸ“… Upcoming Compliance Dates</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">1 July 2026</span>
                    <span class="text-amber-400">Award Rate Increase</span>
                </div>
		<div class="flex justify-between py-2 border-b border-slate-700">
   		 <span class="text-slate-300">25 April 2026</span>
   		 <span class="text-amber-400">ANZAC Day (Public Holiday)</span>
		</div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">26 January 2026</span>
                    <span class="text-amber-400">Australia Day (Public Holiday)</span>
                </div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">Monthly</span>
                    <span class="text-amber-400">Casual Conversion Review</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-slate-300">Quarterly</span>
                    <span class="text-amber-400">WHS Policy Review</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Builder Modal -->
<div id="documentBuilderModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“</span> Document Builder
                </h2>
                <p class="text-slate-400 text-sm">AI-powered HR document generation</p>
            </div>
            <button onclick="closeToolModal('documentBuilderModal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

<!-- Template Selection Screen -->
<div id="documentTemplateSelection" class="space-y-4">
    <p class="text-slate-300 mb-4">Choose a document type:</p>
    
    <!-- 1. Record of Discussion - GREEN -->
    <button onclick="selectDocumentType('recordOfDiscussion')" 
        class="w-full text-left p-6 bg-slate-700 hover:bg-green-600 rounded-lg transition-all border-2 border-transparent hover:border-green-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">ðŸ“‹</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Record of Discussion Template & Script</h3>
                <p class="text-slate-300 text-sm mb-2">For: For behaviour and minor misconduct concerns</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Template + Script</span>
                    <span class="text-slate-500 text-xs">â€¢ 3 quick questions â€¢ Manager conversation guide</span>
                </div>
            </div>
        </div>
    </button>


    <!-- 2. Formal Probation Review - TEAL (NEW) -->
    <button onclick="selectDocumentType('formalProbationReview')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-teal-600 rounded-lg transition-all border-2 border-transparent hover:border-teal-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">ðŸ“‘</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Formal Probation Review</h3>
                <p class="text-slate-300 text-sm mb-2">For: Guiding an open & honest probation discussion on performance, behaviours & support</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-teal-500/20 text-teal-400 text-xs rounded">Template + Script</span>
                    <span class="text-slate-500 text-xs">â€¢ 8 steps â€¢ Action plan â€¢ Procedural fairness</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 3. Performance Improvement Plan - BLUE -->
    <button onclick="selectDocumentType('performanceImprovementPlan')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-blue-600 rounded-lg transition-all border-2 border-transparent hover:border-blue-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">ðŸ“Š</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Performance Improvement Plan (PIP)</h3>
                <p class="text-slate-300 text-sm mb-2">For: Structured 12-week performance improvement process</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">12-Week Process</span>
                    <span class="text-slate-500 text-xs">â€¢ 8 questions â€¢ SMART goals â€¢ Weekly check-ins</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 3. Letter of Allegation - AMBER (MOVED TO 2ND) -->
    <button onclick="selectDocumentType('letterOfAllegation')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-amber-600 rounded-lg transition-all border-2 border-transparent hover:border-amber-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">ðŸ”</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Letter of Allegation</h3>
                <p class="text-slate-300 text-sm mb-2">For: Serious misconduct requiring investigation</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded font-bold">HIGH RISK</span>
                    <span class="text-slate-500 text-xs">â€¢ 6 questions â€¢ Consultant review required</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 4. Formal Warning - LIGHTER RED (MOVED TO 3RD) -->
    <button onclick="selectDocumentType('formalWarning')" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-orange-600 rounded-lg transition-all border-2 border-transparent hover:border-orange-500">
        <div class="flex items-start gap-4">
            <div class="text-4xl">âš ï¸</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Formal Warning Letter</h3>
                <p class="text-slate-300 text-sm mb-2">For: Performance/conduct issues requiring formal action</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded">Medium Risk</span>
                    <span class="text-slate-500 text-xs">â€¢ 7 questions â€¢ AI-enhanced</span>
                </div>
            </div>
        </div>
    </button>

    <!-- 5. Termination Process - DARK RED (NEW) -->
    <button onclick="showTerminationConsultantRequired()" 
            class="w-full text-left p-6 bg-slate-700 hover:bg-red-700 rounded-lg transition-all border-2 border-transparent hover:border-red-600">
        <div class="flex items-start gap-4">
            <div class="text-4xl">ðŸš¨</div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg mb-1">Termination Process</h3>
                <p class="text-slate-300 text-sm mb-2">For: Employment termination - requires expert guidance</p>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-red-600/30 text-red-300 text-xs rounded font-bold">CRITICAL RISK</span>
                    <span class="text-slate-500 text-xs">â€¢ Senior Consultant required â€¢ Full compliance review</span>
                </div>
            </div>
        </div>
    </button>

    <div class="mt-6 bg-amber-500/10 border border-amber-500 rounded-lg p-4">
        <p class="text-amber-300 text-sm">
            <strong>âš ï¸ Important:</strong> All generated documents must be reviewed by a Fitzgerald HR consultant before use.
        </p>
    </div>
</div>

        <!-- Wizard Steps (Hidden initially) -->
        <div id="documentWizardSteps" class="hidden">
            <!-- Progress bar -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-400">Step <span id="docCurrentStep">1</span> of <span id="docTotalSteps">7</span></span>
                    <span class="text-sm text-amber-400" id="docProgress">14% Complete</span>
                </div>
                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="docProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 14%"></div>
                </div>
            </div>

            <!-- Step content container -->
            <div id="documentStepContent"></div>

            <!-- Navigation buttons -->
		<div class="flex gap-3 mt-6">
    		<button id="docBackBtn" onclick="docWizardGoBack()" 
            class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
        â† Back
   		</button>
    		<button id="docNextBtn" onclick="docWizardNext()" 
            class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
        Next Step â†’
    		</button>
    		<button id="docStartOverBtn" onclick="resetDocumentBuilder()" 
            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all">
        ðŸ”„ Start Over
    		</button>
	    </div>
        </div>

        <!-- AI Generation Loading -->
        <div id="documentGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ðŸ¤–</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your document...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div id="documentPreviewModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl max-w-5xl w-full border-2 border-amber-500 fade-in max-h-[90vh] flex flex-col">
        
        <!-- Header -->
        <div class="p-6 border-b border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500">ðŸ“„ Preview Your Document</h2>
                    <p class="text-slate-400 text-sm mt-1">Review carefully before downloading</p>
                </div>
                <button onclick="closeDocumentPreview()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
        </div>

        <!-- Document Content (scrollable) -->
        <div class="flex-1 overflow-y-auto p-8 bg-white">
            <div id="documentPreviewContent" class="max-w-3xl mx-auto prose prose-slate" 
                 style="font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.8; color: #000;">
                <!-- AI-generated document appears here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="p-6 border-t border-slate-700 bg-slate-800">
            <div class="flex gap-3 mb-4 flex-wrap">
    
    <!-- Download Options -->
    <div class="flex gap-2 flex-1">
        <button onclick="downloadGeneratedDocument('pdf')" 
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>ðŸ“„</span>
            <span>Download PDF</span>
        </button>
        <button onclick="downloadGeneratedDocument('docx')" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>ðŸ“</span>
            <span>Download Word</span>
        	</button>
    	     </div>
	</div>
            
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                <p class="text-red-300 font-bold text-sm flex items-center gap-2 mb-2">
                    <span>âš ï¸</span>
                    <span>CRITICAL: This document MUST be reviewed by a consultant before use</span>
                </p>
                <p class="text-red-200 text-xs">
                    Contact: <a href="/cdn-cgi/l/email-protection#f39a9d959cb3959a8789949681929f979b81dd909c9edd9286" class="underline hover:text-red-100"><span class="__cf_email__" data-cfemail="2f464149406f49465b55484a5d4e434b475d014c4042014e5a">[email&#160;protected]</span></a> | +61 400 211 014
                </p>
            </div>
        </div>

    </div>
</div>

<!-- Termination Consultant Required Modal -->
<div id="terminationConsultantModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border-4 border-red-600 fade-in max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸš¨</div>
            <h2 class="text-3xl font-bold text-red-400 mb-2">Senior Consultant Required</h2>
            <p class="text-slate-300">Termination is the highest-risk HR decision</p>
        </div>

        <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-6 mb-6">
            <h3 class="text-red-300 font-bold mb-3 flex items-center gap-2">
                <span>âš–ï¸</span>
                <span>Why Expert Guidance is Critical:</span>
            </h3>
            <ul class="text-red-200 text-sm space-y-2 ml-4">
                <li>â€¢ Unfair dismissal claims can cost $20,000 - $80,000+ in legal fees and compensation</li>
                <li>â€¢ Procedural errors cannot be fixed after termination</li>
                <li>â€¢ General protections claims have severe penalties (up to 6 months salary)</li>
                <li>â€¢ Every termination must follow strict Fair Work procedures</li>
            </ul>
        </div>

        <div class="bg-slate-900 rounded-lg p-6 mb-6">
            <h3 class="text-white font-bold mb-4">ðŸ“‹ Documentation Required:</h3>
            <div class="space-y-5 text-slate-300 text-sm">

                <!-- Probation -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                    <p class="text-amber-400 font-bold mb-3 text-sm uppercase tracking-wide">For Employees Within Probation</p>
                    <div class="flex items-start gap-3">
                        <span class="text-amber-400 text-xl">âœ“</span>
                        <div>
                            <p class="font-semibold">Completed Formal Probation Review and Check-In Documents</p>
                        </div>
                    </div>
                </div>

                <!-- Performance -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                    <p class="text-blue-400 font-bold mb-3 text-sm uppercase tracking-wide">For Performance Concerns</p>
                    <div class="flex items-start gap-3">
                        <span class="text-amber-400 text-xl">âœ“</span>
                        <div>
                            <p class="font-semibold">Completed 12 Week Performance Improvement Plan</p>
                        </div>
                    </div>
                </div>

                <!-- Conduct / Behaviour -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                    <p class="text-red-400 font-bold mb-3 text-sm uppercase tracking-wide">For Conduct / Behaviour Concerns</p>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="text-amber-400 text-xl">âœ“</span>
                            <div>
                                <p class="font-semibold">Completed Record of Discussion OR Letter of Allegation</p>
                                <p class="text-slate-400 text-xs">(Depending on severity of misconduct)</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-amber-400 text-xl">âœ“</span>
                            <div>
                                <p class="font-semibold">Employee's responses and statements</p>
                                <p class="text-slate-400 text-xs">(All documentation from investigation/discussion process)</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-amber-400 text-xl">âœ“</span>
                            <div>
                                <p class="font-semibold">Evidence</p>
                                <p class="text-slate-400 text-xs">(Witness statements, CCTV footage, documentation, etc.)</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="space-y-4">
            <!-- Risk Assessor Tool -->
            <button onclick="openTerminationRiskFromModal()" 
                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                <span class="text-2xl">âš–ï¸</span>
                <div class="text-left">
                    <p class="text-lg">Run Termination Risk Assessment</p>
                    <p class="text-xs opacity-90">Understand your risk level before proceeding</p>
                </div>
            </button>

            <!-- Contact Consultant -->
            <button onclick="openTerminationConsultantEmail()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                <span class="text-2xl">âœ‰ï¸</span>
                <div class="text-left">
                    <p class="text-lg">Contact Senior Consultant</p>
                    <p class="text-xs opacity-90">Get expert guidance on your termination process</p>
                </div>
            </button>

            <!-- Close -->
            <button onclick="closeTerminationConsultantModal()" 
                    class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg transition-all">
                Close
            </button>
        </div>

        <div class="mt-6 text-center">
            <p class="text-slate-400 text-sm">
                ðŸ“ž Urgent? Call us: <a href="tel:+61400211014" class="text-amber-400 hover:underline font-semibold">+61 400 211 014</a>
            </p>
        </div>
    </div>
</div>
<!-- â†‘ END of terminationConsultantModal -->

<!-- ========================================== -->
<!-- PROMPT LIMIT MODAL -->
<!-- ========================================== -->
<div id="promptLimitModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-lg w-full border-2 border-amber-500 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸ’¬</div>
            <h2 class="text-2xl font-bold text-amber-400 mb-2">You've Used Your Free Prompts</h2>
            <p class="text-slate-300">You've used all 20 free prompts for this month.</p>
        </div>

        <div class="bg-slate-900 rounded-lg p-6 mb-6">
            <h3 class="text-white font-bold mb-4">Continue the Conversation:</h3>
            <div class="space-y-4">
                <!-- Subscribe Option -->
                <button onclick="showSubscriptionOptions()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                    <span class="text-2xl">â­</span>
                    <div class="text-left">
                        <p class="text-lg">Subscribe from $59/month</p>
                        <p class="text-xs opacity-75">Unlimited chat + 5-25 document credits</p>
                    </div>
                </button>
                
                <!-- Top-Up Option -->
                <button onclick="purchaseChatTopUp()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                    <span class="text-xl">ðŸ’³</span>
                    <div class="text-left">
                        <p>Chat Top-Up â€” $19</p>
                        <p class="text-xs opacity-75">30 additional prompts this month</p>
                    </div>
                </button>
            </div>
        </div>

        <div class="text-center">
            <p class="text-slate-400 text-sm mb-4">Your prompts reset on the 1st of each month.</p>
            <button onclick="closePromptLimitModal()" class="text-slate-400 hover:text-white text-sm underline">
                Maybe Later
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- CREDITS MODAL -->
<!-- ========================================== -->
<div id="creditsModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-2 border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-400">ðŸ’³ Fitz Credits</h2>
                <p class="text-slate-400 text-sm">Manage your credits and subscription</p>
            </div>
            <button onclick="closeCreditsModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Current Balance -->
        <div class="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-xl p-6 mb-6 border border-amber-500/30">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Current Balance</p>
                    <p id="modalCreditsBalance" class="text-4xl font-bold text-amber-400">0</p>
                    <p class="text-slate-400 text-xs mt-1">Fitz Credits</p>
                </div>
                <div class="text-right">
                    <p class="text-slate-400 text-sm">Your Plan</p>
                    <p id="modalCurrentTier" class="text-xl font-bold text-white">Free</p>
                    <p id="modalPromptsRemaining" class="text-slate-400 text-xs mt-1">20/20 prompts remaining</p>
                </div>
            </div>
            
            <!-- Free Tier Info (for free tier) -->
            <div id="freeDocumentStatus" class="hidden mt-4 pt-4 border-t border-amber-500/30">
                <button onclick="toggleFreeDocsDropdown()" class="w-full text-left group">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-amber-400">ðŸŽ</span>
                            <span class="text-amber-400 font-semibold group-hover:text-amber-300 transition-colors">Free Tier: 1 credit/month</span>
                            <svg id="freeDocsChevron" class="w-4 h-4 text-amber-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <span class="text-slate-400 text-sm">See what you can create</span>
                    </div>
                </button>
                
                <!-- Expandable list of 1-credit documents -->
                <div id="freeDocsDropdown" class="hidden mt-3 bg-slate-900/50 rounded-lg p-3 border border-amber-500/30">
                    <p class="text-slate-400 text-xs mb-2">Use your 1 free credit on any of these (click to try):</p>
                    <ul class="space-y-1">
                        <li>
                            <button onclick="closeCreditsModal(); openProbationCheckIn();" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-800 transition-colors group text-left">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-amber-400">ðŸ“‹</span>
                                    <span class="text-white group-hover:text-amber-400 transition-colors">Probation Check-In</span>
                                    <span class="text-slate-500 text-xs">(1 credit)</span>
                                </div>
                                <span class="text-amber-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Try â†’</span>
                            </button>
                        </li>
                        <li>
                            <button onclick="closeCreditsModal(); startPositionDescriptionChat();" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-800 transition-colors group text-left">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-amber-400">ðŸ“</span>
                                    <span class="text-white group-hover:text-amber-400 transition-colors">Position Description</span>
                                    <span class="text-slate-500 text-xs">(1 credit)</span>
                                </div>
                                <span class="text-amber-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Try â†’</span>
                            </button>
                        </li>
                        <li>
                            <button onclick="closeCreditsModal(); openReferenceCheckForm();" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-800 transition-colors group text-left">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-amber-400">ðŸ“ž</span>
                                    <span class="text-white group-hover:text-amber-400 transition-colors">Reference Check Form</span>
                                    <span class="text-slate-500 text-xs">(1 credit)</span>
                                </div>
                                <span class="text-amber-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Try â†’</span>
                            </button>
                        </li>
                        <li>
                            <button onclick="closeCreditsModal(); openOnboardingChecklist();" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-800 transition-colors group text-left">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-amber-400">âœ…</span>
                                    <span class="text-white group-hover:text-amber-400 transition-colors">Onboarding Checklist</span>
                                    <span class="text-slate-500 text-xs">(1 credit)</span>
                                </div>
                                <span class="text-amber-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Try â†’</span>
                            </button>
                        </li>
                        <li>
                            <button onclick="closeCreditsModal(); openTrainingPlan();" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-800 transition-colors group text-left">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-amber-400">ðŸ“š</span>
                                    <span class="text-white group-hover:text-amber-400 transition-colors">Training Plan</span>
                                    <span class="text-slate-500 text-xs">(1 credit)</span>
                                </div>
                                <span class="text-amber-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Try â†’</span>
                            </button>
                        </li>
                    </ul>
                    <p class="text-slate-500 text-xs mt-3 pt-2 border-t border-slate-700">
                        ðŸ’¡ Need more? Upgrade for 5-25 credits/month + unlimited chat.
                    </p>
                </div>
            </div>
            <div id="freeDocumentUsedStatus" class="hidden"></div>
        </div>

        <!-- Credit Packs -->
        <div class="mb-6">
            <h3 class="text-white font-bold mb-4">Buy Credit Packs</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="purchaseCreditPack('small')" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-4 text-center transition-all border border-slate-600 hover:border-amber-500">
                    <p class="text-2xl font-bold text-amber-400">5</p>
                    <p class="text-slate-300 text-sm">Credits</p>
                    <p class="text-white font-bold mt-2">$79</p>
                    <p class="text-slate-500 text-xs">$15.80/credit</p>
                </button>
                <button onclick="purchaseCreditPack('medium')" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-4 text-center transition-all border-2 border-amber-500 relative">
                    <span class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-amber-500 text-slate-900 text-xs font-bold px-2 py-0.5 rounded">POPULAR</span>
                    <p class="text-2xl font-bold text-amber-400">10</p>
                    <p class="text-slate-300 text-sm">Credits</p>
                    <p class="text-white font-bold mt-2">$149</p>
                    <p class="text-slate-500 text-xs">$14.90/credit</p>
                </button>
                <button onclick="purchaseCreditPack('large')" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-4 text-center transition-all border border-slate-600 hover:border-amber-500">
                    <p class="text-2xl font-bold text-amber-400">20</p>
                    <p class="text-slate-300 text-sm">Credits</p>
                    <p class="text-white font-bold mt-2">$249</p>
                    <p class="text-slate-500 text-xs">$12.45/credit</p>
                </button>
            </div>
            <p class="text-slate-500 text-xs mt-2 text-center">Pack credits never expire</p>
        </div>

        <!-- Subscription Upgrade -->
        <div class="bg-slate-900 rounded-lg p-4 mb-6">
            <h3 class="text-white font-bold mb-3">ðŸ’¡ Save with a Subscription</h3>
            <p class="text-slate-400 text-sm mb-4">Get more credits at a lower per-credit rate, plus unlimited chat.</p>
            <div class="grid grid-cols-3 gap-2 text-center text-sm">
                <div class="bg-slate-800 rounded-lg p-3">
                    <p class="text-white font-bold">Starter</p>
                    <p class="text-amber-400 font-bold">5 credits</p>
                    <p class="text-slate-400">$59/mo</p>
                    <p class="text-green-400 text-xs">$11.80/credit</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-3 border border-amber-500">
                    <p class="text-amber-400 font-bold">Professional â­</p>
                    <p class="text-amber-400 font-bold">14 credits</p>
                    <p class="text-slate-400">$149/mo</p>
                    <p class="text-green-400 text-xs">$10.64/credit</p>
                </div>
                <div class="bg-slate-800 rounded-lg p-3">
                    <p class="text-white font-bold">Enterprise</p>
                    <p class="text-amber-400 font-bold">25 credits</p>
                    <p class="text-slate-400">$349/mo</p>
                    <p class="text-green-400 text-xs">$13.96/credit</p>
                </div>
            </div>
            <button onclick="showSubscriptionOptions()" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 rounded-lg transition-all">
                View Subscription Plans
            </button>
        </div>

        <!-- Credit Costs Reference -->
        <details class="bg-slate-900 rounded-lg p-4">
            <summary class="text-white font-bold cursor-pointer">ðŸ“‹ Document Credit Costs</summary>
            <div class="mt-4 space-y-2 text-sm">
                <div class="flex justify-between text-slate-300">
                    <span>Low-risk documents (Check-In, PD, etc.)</span>
                    <span class="text-amber-400 font-bold">1 credit</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Moderate-risk (ROD, PIP, etc.)</span>
                    <span class="text-amber-400 font-bold">2 credits</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Significant-risk (Contracts, Warnings)</span>
                    <span class="text-amber-400 font-bold">3 credits</span>
                </div>
                <div class="flex justify-between text-slate-300 border-t border-slate-700 pt-2 mt-2">
                    <span>Termination Review (consultation)</span>
                    <span class="text-red-400 font-bold">7 credits</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Investigation Review (consultation)</span>
                    <span class="text-red-400 font-bold">8 credits</span>
                </div>
            </div>
        </details>
    </div>
</div>

<!-- ========================================== -->
<!-- SUBSCRIPTION SELECTION MODAL -->
<!-- ========================================== -->
<div id="subscriptionModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border-2 border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-400">â­ Choose Your Plan</h2>
                <p class="text-slate-400 text-sm">Unlimited chat + monthly document credits</p>
            </div>
            <button onclick="closeSubscriptionModal()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Billing Toggle -->
        <div class="flex justify-center mb-6">
            <div class="bg-slate-900 rounded-lg p-1 flex">
                <button id="billingMonthly" onclick="setBilling('monthly')" 
                        class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-amber-500 text-slate-900">
                    Monthly
                </button>
                <button id="billingAnnual" onclick="setBilling('annual')" 
                        class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white">
                    Annual <span class="text-green-400 text-xs">(Save ~17%)</span>
                </button>
            </div>
        </div>

        <!-- Plan Cards -->
        <div class="grid md:grid-cols-3 gap-4 mb-6">
            <!-- Starter -->
            <div class="bg-slate-900 rounded-xl p-6 border border-slate-700 hover:border-amber-500 transition-all">
                <h3 class="text-xl font-bold text-white mb-2">Starter</h3>
                <p class="text-slate-400 text-sm mb-4">For small venues with occasional HR needs</p>
                
                <div class="mb-4">
                    <span id="starterPrice" class="text-3xl font-bold text-white">$59</span>
                    <span id="starterBilling" class="text-slate-400">/month</span>
                </div>
                
                <ul class="text-slate-300 text-sm space-y-2 mb-6">
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 5 credits/month</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Unlimited AI chat</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> All document types</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 1 month rollover</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Email support (48hr)</li>
                </ul>
                
                <button onclick="purchaseSubscription('starter', currentBilling)" 
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-all">
                    Choose Starter
                </button>
            </div>

            <!-- Professional (Recommended) -->
            <div class="bg-gradient-to-b from-amber-500/20 to-slate-900 rounded-xl p-6 border-2 border-amber-500 relative">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-amber-500 text-slate-900 text-xs font-bold px-3 py-1 rounded-full">
                    BEST VALUE
                </div>
                
                <h3 class="text-xl font-bold text-amber-400 mb-2">Professional</h3>
                <p class="text-slate-400 text-sm mb-4">For busy venues with regular HR needs</p>
                
                <div class="mb-4">
                    <span id="professionalPrice" class="text-3xl font-bold text-white">$149</span>
                    <span id="professionalBilling" class="text-slate-400">/month</span>
                </div>
                
                <ul class="text-slate-300 text-sm space-y-2 mb-6">
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> <strong>14 credits/month</strong></li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Unlimited AI chat</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> All document types</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 3 month rollover</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Email support (24hr)</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 3 user logins</li>
                </ul>
                
                <button onclick="purchaseSubscription('professional', currentBilling)" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Choose Professional
                </button>
                
                <p class="text-center text-green-400 text-xs mt-2">$10.64/credit â€” Best rate!</p>
            </div>

            <!-- Enterprise -->
            <div class="bg-slate-900 rounded-xl p-6 border border-slate-700 hover:border-amber-500 transition-all">
                <h3 class="text-xl font-bold text-white mb-2">Enterprise</h3>
                <p class="text-slate-400 text-sm mb-4">For multi-venue or high-turnover operations</p>
                
                <div class="mb-4">
                    <span id="enterprisePrice" class="text-3xl font-bold text-white">$349</span>
                    <span id="enterpriseBilling" class="text-slate-400">/month</span>
                </div>
                
                <ul class="text-slate-300 text-sm space-y-2 mb-6">
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> <strong>25 credits/month</strong></li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Unlimited AI chat</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> All document types</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 6 month rollover</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Priority support (4hr)</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 10 user logins</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 5 venue profiles</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Quarterly strategy call</li>
                </ul>
                
                <button onclick="purchaseSubscription('enterprise', currentBilling)" 
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-all">
                    Choose Enterprise
                </button>
            </div>
        </div>

        <!-- FAQ -->
        <div class="text-center text-slate-400 text-sm">
            <p>All plans include a 14-day money-back guarantee. Cancel anytime.</p>
            <p class="mt-2">Questions? Contact <a href="mailto:blake@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">blake@fitzgeraldhr.com.au</a></p>
        </div>
    </div>
</div>

<script>
// Billing toggle state
let currentBilling = 'monthly';

function setBilling(billing) {
    currentBilling = billing;
    
    // Update toggle buttons
    const monthlyBtn = document.getElementById('billingMonthly');
    const annualBtn = document.getElementById('billingAnnual');
    
    if (billing === 'monthly') {
        monthlyBtn.classList.add('bg-amber-500', 'text-slate-900');
        monthlyBtn.classList.remove('text-slate-400');
        annualBtn.classList.remove('bg-amber-500', 'text-slate-900');
        annualBtn.classList.add('text-slate-400');
        
        // Update prices
        document.getElementById('starterPrice').textContent = '$59';
        document.getElementById('starterBilling').textContent = '/month';
        document.getElementById('professionalPrice').textContent = '$149';
        document.getElementById('professionalBilling').textContent = '/month';
        document.getElementById('enterprisePrice').textContent = '$349';
        document.getElementById('enterpriseBilling').textContent = '/month';
    } else {
        annualBtn.classList.add('bg-amber-500', 'text-slate-900');
        annualBtn.classList.remove('text-slate-400');
        monthlyBtn.classList.remove('bg-amber-500', 'text-slate-900');
        monthlyBtn.classList.add('text-slate-400');
        
        // Update prices (annual = monthly * 10, billed yearly)
        document.getElementById('starterPrice').textContent = '$49';
        document.getElementById('starterBilling').textContent = '/mo (billed $588/yr)';
        document.getElementById('professionalPrice').textContent = '$125';
        document.getElementById('professionalBilling').textContent = '/mo (billed $1,500/yr)';
        document.getElementById('enterprisePrice').textContent = '$290';
        document.getElementById('enterpriseBilling').textContent = '/mo (billed $3,480/yr)';
    }
}
</script>

<!-- ========================================== -->
<!-- CONSULTATION BOOKING MODAL -->
<!-- ========================================== -->
<!-- Old consultationBookingModal removed - using new enhanced version below -->

<!-- ========================================== -->
<!-- DOCUMENT UNLOCK MODAL (Preview & Unlock) -->
<!-- ========================================== -->
<div id="documentUnlockModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-lg w-full border-2 border-amber-500 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸ”’</div>
            <h2 class="text-2xl font-bold text-amber-400 mb-2">Unlock Your Document</h2>
            <p class="text-slate-300">Your document is ready! Confirm to unlock and download.</p>
        </div>

        <div class="bg-slate-900 rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-slate-400 text-sm">Document:</p>
                    <p id="unlockDocumentName" class="text-white font-bold">â€”</p>
                </div>
                <div class="text-right">
                    <p class="text-slate-400 text-sm">Cost:</p>
                    <p id="unlockDocumentCost" class="text-2xl font-bold text-amber-400">0 credits</p>
                </div>
            </div>
            
            <div class="border-t border-slate-700 pt-4 space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-slate-400">Your balance:</span>
                    <span id="unlockCurrentBalance" class="text-white font-bold">0 credits</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-400">After unlock:</span>
                    <span id="unlockBalanceAfter" class="text-green-400 font-bold">0 credits</span>
                </div>
            </div>
        </div>

        <div id="unlockActions" class="space-y-3">
            <!-- This section is hidden - all documents now use credits -->
            <div id="unlockFreeDocument" class="hidden">
            </div>
            
            <!-- Unlock Button (if enough credits) -->
            <button id="unlockDocumentBtn" onclick="unlockDocument()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition-all flex items-center justify-center gap-2">
                <span>ðŸ”“</span>
                <span>Yes, Unlock Document</span>
            </button>
            
            <!-- Not enough credits -->
            <div id="unlockNeedMoreCredits" class="hidden">
                <p class="text-red-400 text-center mb-3">You need more credits to unlock this document.</p>
                <button onclick="savePendingDocumentAndGetCredits()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Get More Credits
                </button>
            </div>
        </div>

        <button onclick="closeDocumentUnlockModal()" class="w-full mt-4 text-slate-400 hover:text-white text-sm">
            Cancel
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- CONSULTATION REQUIRED MODAL (for gated docs) -->
<!-- ========================================== -->
<div id="consultationRequiredModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-lg w-full border-4 border-red-500 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸš¨</div>
            <h2 class="text-2xl font-bold text-red-400 mb-2">Consultation Required</h2>
            <p class="text-slate-300">This document requires a professional review before generation.</p>
        </div>

        <div class="bg-red-500/10 border border-red-500 rounded-lg p-4 mb-6">
            <p class="text-red-300 text-sm">
                <strong>Why?</strong> Termination and other high-risk documents carry significant legal exposure 
                ($20,000â€“$80,000+ in potential claims). All termination letters must be reviewed by a senior HR 
                professional to ensure proper process has been followed.
            </p>
        </div>

        <div class="bg-slate-900 rounded-lg p-4 mb-6">
            <h3 class="text-white font-bold mb-3">What's included:</h3>
            <ul class="text-slate-300 text-sm space-y-2">
                <li class="flex items-center gap-2">
                    <span class="text-green-400">âœ“</span>
                    <span>30-minute consultation with senior HR professional</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="text-green-400">âœ“</span>
                    <span>Review of your specific situation</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="text-green-400">âœ“</span>
                    <span>Document generated <em>if approved</em></span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="text-green-400">âœ“</span>
                    <span>Guidance on correct approach if not approved</span>
                </li>
            </ul>
        </div>

        <div class="space-y-3">
            <button onclick="openConsultationBookingFromRequired()" 
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg">
                <span>ðŸ“ž</span>
                <span>Book Consultation</span>
                <span class="bg-white/20 text-white text-sm px-2 py-1 rounded ml-2" id="requiredConsultationCredits">7 credits</span>
            </button>
            
            <button onclick="closeConsultationRequiredModal()" 
                    class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg transition-all">
                Go Back
            </button>
        </div>

        <p class="text-center text-slate-500 text-xs mt-4">
            Questions? Call us: <a href="tel:+61400211014" class="text-amber-400">+61 400 211 014</a>
        </p>
    </div>
</div>

<!-- ========================================== -->
<!-- CONSULTATION BOOKING MODAL (Main booking flow) -->
<!-- ========================================== -->
<div id="consultationBookingModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-start justify-center p-4 z-50 overflow-y-auto">
    <div class="bg-slate-800 rounded-2xl max-w-3xl w-full border border-purple-500/50 fade-in my-4">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-t-2xl p-6 text-center relative">
            <button onclick="closeConsultationBookingModal()" class="absolute top-4 right-4 text-white/70 hover:text-white text-2xl">Ã—</button>
            <div class="text-5xl mb-3">ðŸ‘©â€ðŸ’¼</div>
            <h2 class="text-2xl font-bold text-white mb-1">Book an HR Expert</h2>
            <p class="text-purple-200 text-sm">30-minute consultation with a senior HR professional</p>
        </div>
        
        <!-- Content -->
        <div class="p-6">
            
            <!-- Step 1: Select Consultation Type -->
            <div id="bookingStep1">
                <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                    <span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm">1</span>
                    Select Consultation Type
                </h3>
                
                <div class="grid gap-3" id="consultationTypeGrid">
                    <!-- Termination Review -->
                    <button onclick="selectConsultationType('terminationReview')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸšª</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">Termination Review</p>
                                    <p class="text-slate-400 text-xs">Includes termination letter if approved</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">7 credits</span>
                        </div>
                    </button>
                    
                    <!-- Redundancy Review -->
                    <button onclick="selectConsultationType('redundancyReview')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸ“‰</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">Redundancy Review</p>
                                    <p class="text-slate-400 text-xs">Includes redundancy letters if approved</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">7 credits</span>
                        </div>
                    </button>
                    
                    <!-- Investigation Review -->
                    <button onclick="selectConsultationType('investigationReview')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸ”</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">Investigation Review</p>
                                    <p class="text-slate-400 text-xs">Includes investigation report</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">8 credits</span>
                        </div>
                    </button>
                    
                    <!-- Settlement Review -->
                    <button onclick="selectConsultationType('settlementReview')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸ¤</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">Settlement Review</p>
                                    <p class="text-slate-400 text-xs">Includes deed of settlement draft</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">8 credits</span>
                        </div>
                    </button>
                    
                    <!-- Unfair Dismissal Response -->
                    <button onclick="selectConsultationType('unfairDismissalResponse')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">âš–ï¸</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">Unfair Dismissal Response</p>
                                    <p class="text-slate-400 text-xs">Includes response draft for Fair Work</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">8 credits</span>
                        </div>
                    </button>
                    
                    <!-- General Consultation -->
                    <button onclick="selectConsultationType('generalConsultation')" 
                            class="consultation-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 hover:border-purple-500 rounded-xl text-left transition-all group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ðŸ’¬</span>
                                <div>
                                    <p class="text-white font-semibold group-hover:text-purple-400 transition-colors">General HR Consultation</p>
                                    <p class="text-slate-400 text-xs">Expert advice on any HR matter</p>
                                </div>
                            </div>
                            <span class="bg-purple-600/30 text-purple-300 px-3 py-1 rounded-full text-sm font-bold">5 credits</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Select Meeting Type & Book -->
            <div id="bookingStep2" class="hidden">
                <button onclick="goBackToStep1()" class="text-purple-400 hover:text-purple-300 text-sm mb-4 flex items-center gap-1">
                    â† Back to consultation types
                </button>
                
                <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                    <span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm">2</span>
                    Choose Meeting Type
                </h3>
                
                <!-- Selected consultation summary -->
                <div id="selectedConsultationSummary" class="bg-purple-600/20 border border-purple-500 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span id="selectedConsultationIcon" class="text-2xl">ðŸ’¬</span>
                            <div>
                                <p id="selectedConsultationName" class="text-white font-semibold">General HR Consultation</p>
                                <p id="selectedConsultationIncludes" class="text-purple-300 text-xs">Expert advice on any HR matter</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p id="selectedConsultationCredits" class="text-2xl font-bold text-purple-400">5</p>
                            <p class="text-purple-300 text-xs">credits</p>
                        </div>
                    </div>
                </div>
                
                <!-- Meeting Type Selection -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="selectMeetingType('zoom')" id="meetingTypeZoom"
                            class="meeting-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 rounded-xl text-center transition-all">
                        <span class="text-3xl block mb-2">ðŸ“¹</span>
                        <p class="text-white font-semibold">Zoom Meeting</p>
                        <p class="text-slate-400 text-xs">Video call with screen share</p>
                    </button>
                    <button onclick="selectMeetingType('phone')" id="meetingTypePhone"
                            class="meeting-type-btn p-4 bg-slate-900 hover:bg-slate-700 border-2 border-slate-600 rounded-xl text-center transition-all">
                        <span class="text-3xl block mb-2">ðŸ“ž</span>
                        <p class="text-white font-semibold">Phone Call</p>
                        <p class="text-slate-400 text-xs">We'll call you</p>
                    </button>
                </div>
                
                <!-- Credit Check & Book Button -->
                <div id="bookingCreditCheck" class="mb-4">
                    <div class="flex items-center justify-between text-sm mb-2">
                        <span class="text-slate-400">Your credit balance:</span>
                        <span id="bookingCurrentCredits" class="text-white font-bold">0 credits</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-400">After booking:</span>
                        <span id="bookingCreditsAfter" class="text-green-400 font-bold">0 credits</span>
                    </div>
                </div>
                
                <!-- Insufficient Credits Warning -->
                <div id="bookingInsufficientCredits" class="hidden bg-red-500/20 border border-red-500 rounded-xl p-4 mb-4">
                    <p class="text-red-400 font-semibold mb-2">âš ï¸ Not enough credits</p>
                    <p class="text-red-300 text-sm mb-3">You need more credits to book this consultation.</p>
                    <button onclick="getCreditsFromBooking()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 rounded-lg transition-all">
                        Get More Credits
                    </button>
                </div>
                
                <!-- Book Now Button -->
                <button id="proceedToCalendlyBtn" onclick="proceedToCalendly()" 
                        class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>ðŸ“…</span>
                    <span>Select Time Slot</span>
                </button>
                
                <p class="text-slate-500 text-xs text-center mt-3">
                    Credits will be deducted when you confirm your booking
                </p>
            </div>
            
            <!-- Step 3: Calendly Embed -->
            <div id="bookingStep3" class="hidden">
                <button onclick="goBackToStep2()" class="text-purple-400 hover:text-purple-300 text-sm mb-4 flex items-center gap-1">
                    â† Back to meeting type
                </button>
                
                <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                    <span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm">3</span>
                    Select Your Time Slot
                </h3>
                
                <!-- Calendly Container -->
                <div id="calendlyContainer" class="bg-white rounded-xl overflow-hidden" style="min-height: 700px;">
                    <!-- Calendly inline widget will be loaded here -->
                    <div id="calendlyPlaceholder" class="flex items-center justify-center bg-slate-100" style="height: 650px;">
                        <div class="text-center">
                            <div class="animate-spin text-4xl mb-4">â³</div>
                            <p class="text-slate-600">Loading calendar...</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Footer -->
        <div class="bg-slate-900 rounded-b-2xl p-4 flex items-center justify-between">
            <p class="text-slate-500 text-xs">
                Questions? <a href="tel:+61400211014" class="text-purple-400 hover:text-purple-300">+61 400 211 014</a>
            </p>
            <p class="text-slate-500 text-xs">
                <a href="mailto:blake@fitzgeraldhr.com.au" class="text-purple-400 hover:text-purple-300">blake@fitzgeraldhr.com.au</a>
            </p>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- TERMS OF SERVICE MODAL -->
<!-- ========================================== -->

<div id="termsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">Terms of Use</h2>
            <button onclick="closeTermsOfService()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>
        
        <div class="text-slate-300 text-sm space-y-4">
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4 mb-6">
                <p class="text-red-400 font-bold mb-2">âš ï¸ CRITICAL NOTICE</p>
                <p class="text-red-300">
                    This tool provides <strong>general information only</strong>. It is <strong>NOT legal advice</strong> 
                    and does not create a client-consultant relationship. All guidance and documents must be 
                    reviewed by a qualified Fitzgerald HR consultant before use.
                </p>
            </div>

            <h3 class="text-white font-bold text-lg">1. Acceptance of Terms</h3>
            <p>By accessing the Fitzgerald HR Knowledge Hub, you agree to these Terms of Use. If you do not agree, do not use this tool.</p>

            <h3 class="text-white font-bold text-lg">2. Nature of Service</h3>
            <p>This tool is an <strong>information resource</strong>, not a professional advisory service. It provides:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>General HR information for Australian hospitality venues</li>
                <li>Educational content about Fair Work compliance</li>
                <li>Draft document templates requiring professional review</li>
                <li>Reference materials and process guidance</li>
            </ul>
            <p class="font-semibold text-amber-400">This tool does NOT provide legal advice or professional HR consulting services.</p>

            <h3 class="text-white font-bold text-lg">3. Professional Review Requirement</h3>
            <p class="font-semibold">You MUST have all guidance and documents reviewed by a Fitzgerald HR consultant before:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Issuing any document to an employee</li>
                <li>Taking any employment action based on information provided</li>
                <li>Making legal or compliance decisions</li>
                <li>Relying on any content for legal proceedings</li>
            </ul>

            <h3 class="text-white font-bold text-lg">4. Limitation of Liability</h3>
            <p>Fitzgerald HR is NOT liable for:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Decisions made based on information from this tool</li>
                <li>Use of documents without professional review</li>
                <li>Inaccuracies or outdated information</li>
                <li>AI-generated content errors or omissions</li>
                <li>Legal costs, penalties, or damages arising from use of this tool</li>
            </ul>

            <h3 class="text-white font-bold text-lg">5. Your Responsibilities</h3>
            <p>You agree to:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Use this tool for informational purposes only</li>
                <li>Seek professional advice for specific situations</li>
                <li>Verify all information with official sources</li>
                <li>Not rely solely on this tool for legal compliance</li>
                <li>Have all documents professionally reviewed before use</li>
            </ul>

            <h3 class="text-white font-bold text-lg">6. Accuracy and Updates</h3>
            <p>While we strive for accuracy, employment law changes frequently. Award rates, regulations, and requirements may have changed since information was last updated. Always verify current requirements at <a href="https://www.fairwork.gov.au" target="_blank" class="text-amber-400 underline">fairwork.gov.au</a>.</p>

            <h3 class="text-white font-bold text-lg">7. Professional Consultation</h3>
            <p>For professional HR advice and document review:</p>
            <p class="font-semibold text-amber-400">
                Email: <a href="/cdn-cgi/l/email-protection#d1b8bfb7be91b7b8a5abb6b4a3b0bdb5b9a3ffb2bebcffb0a4" class="underline"><span class="__cf_email__" data-cfemail="bfd6d1d9d0ffd9d6cbc5d8dacdded3dbd7cd91dcd0d291deca">[email&#160;protected]</span></a><br>
                Phone: <a href="tel:+61400211014" class="underline">+61 400 211 014</a>
            </p>

            <p class="text-xs text-slate-400 mt-6">Last Updated: January 2026</p>
        </div>

        <button onclick="closeTermsOfService()" class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
            I Understand
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- PRIVACY POLICY MODAL -->
<!-- ========================================== -->

<div id="privacyModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">Privacy Policy</h2>
            <button onclick="closePrivacyPolicy()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>
        
        <div class="text-slate-300 text-sm space-y-4">
            <h3 class="text-white font-bold text-lg">1. Information We Collect</h3>
            <p>When using this tool, we collect:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li><strong>Conversation data:</strong> Your questions and our responses</li>
                <li><strong>Venue information:</strong> Business name, location, staff count (if provided during onboarding)</li>
                <li><strong>Document data:</strong> Employee names and details entered into document templates</li>
                <li><strong>Usage analytics:</strong> Tool usage patterns, features accessed, session duration</li>
                <li><strong>Access codes:</strong> Beta testing access credentials</li>
            </ul>

            <h3 class="text-white font-bold text-lg">2. How We Use Your Information</h3>
            <ul class="list-disc ml-6 space-y-1">
                <li>To provide and improve the tool's functionality</li>
                <li>To analyze usage patterns and feature effectiveness</li>
                <li>To provide better recommendations and tool suggestions</li>
                <li>For beta testing feedback and product development</li>
            </ul>

            <h3 class="text-white font-bold text-lg">3. Data Storage</h3>
            <p>Your data is stored securely using:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Supabase (cloud database provider) - Australian/US servers</li>
                <li>Browser local storage (for venue profile and preferences)</li>
                <li>Anthropic Claude API (for AI responses - data not retained by Anthropic)</li>
            </ul>

            <h3 class="text-white font-bold text-lg">4. Data Sharing</h3>
            <p>We do NOT sell your data. We may share data with:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Fitzgerald HR consultants (when you request professional review or advice)</li>
                <li>Service providers (Anthropic, Supabase) - under strict confidentiality agreements</li>
                <li>Legal authorities (if required by Australian law)</li>
            </ul>

            <h3 class="text-white font-bold text-lg">5. Your Rights</h3>
            <p>Under Australian Privacy Principles, you have the right to:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li>Access your personal data</li>
                <li>Request correction of inaccurate data</li>
                <li>Request deletion of your data</li>
                <li>Opt out of analytics collection</li>
            </ul>

            <h3 class="text-white font-bold text-lg">6. Security</h3>
            <p>We implement industry-standard security measures including encryption, secure databases, and access controls. However, no system is 100% secure.</p>

            <h3 class="text-white font-bold text-lg">7. Contact Us</h3>
            <p>For privacy concerns or data requests:</p>
            <p class="font-semibold text-amber-400">
                Email: <a href="/cdn-cgi/l/email-protection#5c35323a331c3a3528263b392e3d3038342e723f3331723d29" class="underline"><span class="__cf_email__" data-cfemail="a0c9cec6cfe0c6c9d4dac7c5d2c1ccc4c8d28ec3cfcd8ec1d5">[email&#160;protected]</span></a><br>
                Phone: <a href="tel:+61400211014" class="underline">+61 400 211 014</a>
            </p>

            <p class="text-xs text-slate-400 mt-6">Last Updated: January 2026</p>
        </div>

        <button onclick="closePrivacyPolicy()" class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
            I Understand
        </button>
    </div>
</div>


<!-- ========================================== -->
<!-- LOGOUT OPTIONS MODAL -->
<!-- ========================================== -->

<div id="logoutModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-md w-full border-2 border-slate-700 fade-in">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸšª</div>
            <h2 class="text-2xl font-bold text-white mb-2">Logout Options</h2>
            <p class="text-slate-400">How would you like to logout?</p>
        </div>
        
        <div class="space-y-3 mb-6">
            <!-- Quick Logout (Soft) -->
            <button onclick="confirmLogout('soft')" 
                    class="w-full p-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all text-left group">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">ðŸ”„</div>
                    <div class="flex-1">
                        <p class="font-bold text-lg mb-1">Quick Logout</p>
                        <p class="text-sm opacity-90">Stay logged in on this device - auto-login next time</p>
                    </div>
                </div>
            </button>
            
            <!-- Full Logout (Hard) -->
            <button onclick="confirmLogout('hard')" 
                    class="w-full p-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all text-left group">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">ðŸ—‘ï¸</div>
                    <div class="flex-1">
                        <p class="font-bold text-lg mb-1">Full Logout</p>
                        <p class="text-sm opacity-90">Forget this device - enter access code next time</p>
                    </div>
                </div>
            </button>
        </div>
        
        <div class="bg-slate-700/50 rounded-lg p-3 mb-4">
            <p class="text-slate-300 text-xs text-center">
                ðŸ’¡ <strong>Tip:</strong> Use Quick Logout if you're the only one using this device
            </p>
        </div>
        
        <button onclick="closeLogoutModal()" 
                class="w-full py-3 text-slate-400 hover:text-white font-semibold transition-colors rounded-lg hover:bg-slate-700/50">
            Cancel
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- LEGAL ACCEPTANCE MODAL (First Use Only) -->
<!-- ========================================== -->

<div id="legalAcceptanceModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 md:p-6 z-[60]">
    <div class="bg-slate-800 rounded-2xl p-6 md:p-8 max-w-3xl w-full border-2 border-red-500 fade-in max-h-[90vh] overflow-y-auto">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                <span class="text-4xl">âš ï¸</span>
            </div>
            <h2 class="text-2xl font-bold text-red-400">Important Legal Notice</h2>
            <p class="text-slate-400 text-sm mt-2">Please read carefully before using this tool</p>
        </div>

        <!-- Content -->
        <div class="bg-slate-900/50 rounded-lg p-6 mb-6 space-y-4 text-slate-300 text-sm border border-slate-700">
            
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">ðŸ“š</span>
                    <span>This is an Information Tool</span>
                </h3>
                <p>
                    This tool provides <strong class="text-white">general HR information only</strong> for Australian hospitality venues. 
                    It is <strong class="text-red-400">NOT a substitute</strong> for professional HR or legal advice.
                </p>
            </div>

            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">âœ…</span>
                    <span>Mandatory Professional Review</span>
                </h3>
                <p class="mb-2">
                    <strong class="text-white">All documents and guidance MUST be reviewed</strong> by a Fitzgerald HR consultant before:
                </p>
                <ul class="list-disc ml-6 space-y-1 text-xs">
                    <li>Issuing any document to an employee</li>
                    <li>Taking employment action (warnings, terminations, etc.)</li>
                    <li>Making compliance or legal decisions</li>
                </ul>
            </div>

            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-red-400">âš–ï¸</span>
                    <span>Legal Disclaimer</span>
                </h3>
                <p>
                    Fitzgerald HR is <strong class="text-white">not liable</strong> for decisions made based on this tool's information, 
                    documents used without professional review, or any legal costs/damages arising from use of this tool.
                </p>
            </div>

            <div>
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">ðŸ“ž</span>
                    <span>Get Professional Advice</span>
                </h3>
                <p class="text-amber-300">
                    Email: <a href="/cdn-cgi/l/email-protection#11787f777e517778656b767463707d7579633f727e7c3f7064" class="underline hover:text-amber-200 font-semibold"><span class="__cf_email__" data-cfemail="e28b8c848da2848b9698858790838e868a90cc818d8fcc8397">[email&#160;protected]</span></a><br>
                    Phone: <a href="tel:+61400211014" class="underline hover:text-amber-200 font-semibold">+61 400 211 014</a>
                </p>
            </div>

        </div>

        <!-- Checkbox Agreement -->
        <div class="mb-6">
            <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="legalAcceptCheckbox" 
                       class="mt-1 w-5 h-5 rounded border-2 border-slate-600 bg-slate-900 checked:bg-amber-500 checked:border-amber-500 cursor-pointer transition-all">
                <span class="text-slate-300 text-sm flex-1 group-hover:text-white transition-colors">
                    I understand and agree that:
                    <ul class="list-disc ml-5 mt-2 space-y-1 text-xs text-slate-400">
                        <li>This tool provides information only, not professional advice</li>
                        <li>All documents must be reviewed by a consultant before use</li>
                        <li>I will seek professional guidance for specific situations</li>
                        <li>I accept the <a href="#terms" onclick="showTermsFromAcceptance(); return false;" class="text-amber-400 underline hover:text-amber-300">Terms of Use</a> and <a href="#privacy" onclick="showPrivacyFromAcceptance(); return false;" class="text-amber-400 underline hover:text-amber-300">Privacy Policy</a></li>
                    </ul>
                </span>
            </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4">
            <button onclick="declineLegalTerms()" 
                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg transition-all">
                I Do Not Agree
            </button>
            <button id="acceptLegalButton" onclick="acceptLegalTerms()" disabled
                    class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-amber-500">
                I Understand & Agree
            </button>
        </div>

        <p class="text-center text-slate-500 text-xs mt-4">
            By clicking "I Understand & Agree", you acknowledge you have read and understood this notice.
        </p>

    </div>
</div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ========================================
// CONFIGURATION & GLOBALS
// ========================================

// ========================================
// CONFIGURATION
// ========================================
// ========================================
// DOM CACHE - Performance Optimization
// ========================================

/**
 * Cached DOM elements to avoid repeated queries
 * Initialized on DOMContentLoaded for performance
 */
const DOM = {
    // Main elements
    accessScreen: null,
    assistantScreen: null,
    messagesContainer: null,
    messageInput: null,
    sendButton: null,
    
    // Modals
    feedbackModal: null,
    crisisModal: null,
    awardCalculatorModal: null,
    awardWizardModal: null,
    rosterStressTesterModal: null,
    complianceCalendarModal: null,
    
    // Tools menu
    toolsMenu: null,
    
    // Voice
    voiceButton: null,
    voiceIcon: null
};
const CONFIG = {
    // Access control
    VALID_CODES: [
        'BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003',
        'BETA-VENUE-004', 'BETA-VENUE-005',
        'FITZGERALD-TEST', 'DEMO-2025'
    ],
    
    // API endpoints
    API: {
        RATES_URL: 'https://raw.githubusercontent.com/Meataxe4/Fitzgerald-HR-Ai/main/hospitality-award-rates.json',
        CHAT_ENDPOINT: '/.netlify/functions/chat',
        CRISIS_ENDPOINT: '/.netlify/functions/telegram-crisis'
    },
    
    // Application constants
    WIZARD_STEPS: 5,
    TOOL_SUGGESTION_LIMIT: 2,
    MAX_CONVERSATION_HISTORY: 50,
    
    // Timing
    DEBOUNCE_DELAY: 150,
    RETRY_DELAY: 1000,
    MAX_RETRIES: 3,
    ERROR_DISPLAY_TIME: 5000,
    
    // ========================================
    // FITZ CREDITS SYSTEM
    // ========================================
    CREDITS: {
        // Free tier limits
        FREE_TIER: {
            MONTHLY_PROMPTS: 20,
            MONTHLY_CREDITS: 1  // 1 free credit per month for any document
        },
        
        // Subscription tiers
        TIERS: {
            // Free tier: 1 credit/month, does NOT accumulate (stays at 1 if unused)
            free: { name: 'Free', monthlyCredits: 1, rolloverMonths: 0, maxBanked: 1 },
            starter: { name: 'Starter', monthlyCredits: 5, rolloverMonths: 1, maxBanked: 10, price: 59 },
            professional: { name: 'Professional', monthlyCredits: 14, rolloverMonths: 3, maxBanked: 42, price: 149 },
            enterprise: { name: 'Enterprise', monthlyCredits: 25, rolloverMonths: 6, maxBanked: 75, price: 349 }
        },
        
        // Document credit costs
        DOCUMENT_COSTS: {
            // 1 Credit - Low Risk
            probationCheckIn: { credits: 1, risk: 'low', name: 'Probation Check-In' },
            letterOfConcern: { credits: 1, risk: 'low', name: 'Letter of Concern' },
            positionDescription: { credits: 1, risk: 'low', name: 'Position Description' },
            changeOfHours: { credits: 1, risk: 'low', name: 'Change of Hours Letter' },
            referenceCheck: { credits: 1, risk: 'low', name: 'Reference Check Form' },
            onboardingChecklist: { credits: 1, risk: 'low', name: 'Onboarding Checklist' },
            trainingPlan: { credits: 1, risk: 'low', name: 'Training Plan' },
            
            // 2 Credits - Moderate Risk
            recordOfDiscussion: { credits: 2, risk: 'moderate', name: 'Record of Discussion' },
            pip: { credits: 2, risk: 'moderate', name: 'Performance Improvement Plan' },
            casualConversion: { credits: 2, risk: 'moderate', name: 'Casual Conversion Letter' },
            probationExtension: { credits: 2, risk: 'moderate', name: 'Probation Extension Letter' },
            
            // 3 Credits - Significant Risk (Expert Review Included)
            employmentContract: { credits: 3, risk: 'significant', name: 'Employment Contract' },
            formalWarning: { credits: 3, risk: 'significant', name: 'Formal Warning' },
            firstWarning: { credits: 3, risk: 'significant', name: 'First Written Warning' },
            finalWarning: { credits: 3, risk: 'significant', name: 'Final Written Warning' },
            formalProbationReview: { credits: 3, risk: 'significant', name: 'Formal Probation Review' },
            showCause: { credits: 3, risk: 'significant', name: 'Show Cause Letter' },
            letterOfAllegation: { credits: 3, risk: 'significant', name: 'Letter of Allegation' }
        },
        
        // Consultation-gated documents (require booking, cannot self-serve)
        CONSULTATION_GATED: {
            terminationReview: { credits: 7, name: 'Termination Review', includes: 'Termination Letter' },
            redundancyReview: { credits: 7, name: 'Redundancy Review', includes: 'Redundancy Letters' },
            investigationReview: { credits: 8, name: 'Investigation Review', includes: 'Investigation Report' },
            settlementReview: { credits: 8, name: 'Settlement Review', includes: 'Deed of Settlement Draft' },
            unfairDismissalResponse: { credits: 8, name: 'Unfair Dismissal Response', includes: 'Response Draft' },
            generalConsultation: { credits: 5, name: 'General HR Consultation', includes: 'Expert advice' }
        },
        
        // Process bundles
        BUNDLES: {
            probationDocumentation: { 
                credits: 3, 
                savings: '25%', 
                includes: ['probationCheckIn', 'formalProbationReview'],
                name: 'Probation Documentation Bundle'
            },
            performanceManagement: { 
                credits: 6, 
                savings: '25%', 
                includes: ['pip', 'firstWarning', 'finalWarning'],
                name: 'Performance Management Bundle'
            },
            misconductDocumentation: { 
                credits: 4, 
                savings: '20%', 
                includes: ['recordOfDiscussion', 'showCause'],
                name: 'Misconduct Documentation Bundle'
            },
            newHire: { 
                credits: 4, 
                savings: '20%', 
                includes: ['employmentContract', 'positionDescription', 'probationCheckIn'],
                name: 'New Hire Bundle'
            }
        },
        
        // Credit packs
        PACKS: {
            small: { credits: 5, price: 79, perCredit: 15.80 },
            medium: { credits: 10, price: 149, perCredit: 14.90 },
            large: { credits: 20, price: 249, perCredit: 12.45 }
        },
        
        // Chat top-up
        CHAT_TOPUP: { prompts: 30, price: 19 },
        
        // Urgent consultation premium
        URGENT_PREMIUM: 100
    }
};

// ========================================
// SUPABASE CONFIGURATION
// ========================================
const SUPABASE_CONFIG = {
    url: 'https://vaundmbbbyqmbbcavulo.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhdW5kbWJiYnlxbWJiY2F2dWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MDcwMzAsImV4cCI6MjA4NDE4MzAzMH0.2ynWsEBn3YJFXUBinm2e4XgnHiUM9hYbaZ1SfVk__pI'
};

// Initialize Supabase client
let supabaseClient = null;

// Initialize Supabase when page loads
function initializeSupabase() {
    try {
        // Check if Supabase library loaded
        if (typeof supabase === 'undefined') {
            return false;
        }
        
        // Create client
        supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        return true;
    } catch (error) {
        return false;
    }
}

// Global state
let currentUser = null;
let conversationHistory = [];
let feedbackRating = 0;
let wizardData = {};
let currentWizardStep = 1;
let recognition = null;
let isListening = false;

// ========================================
// FITZ CREDITS - GLOBAL STATE
// ========================================
let userCredits = {
    balance: 0,
    tier: 'free',
    monthlyPromptsUsed: 0,
    monthlyPromptsReset: null,
    activeBundles: [],
    purchasedCredits: 0, // Never expire
    subscriptionCredits: 1, // Free tier starts with 1 credit
    lastCreditRefresh: null
};

// Flag to prevent Firebase from overwriting local credits after payment return
let skipFirebaseCreditsLoad = false;

// Initialize credits from localStorage/Firebase
function initializeUserCredits() {
    const userKey = currentUser?.uid || currentUser || 'anonymous';
    const stored = localStorage.getItem('fitzCredits_' + userKey);
    
    if (stored) {
        try {
            const parsed = JSON.parse(stored);
            userCredits = { ...userCredits, ...parsed };
            
            // Remove legacy freeDocumentUsed if present
            delete userCredits.freeDocumentUsed;
            
            // Check if monthly prompts need reset (new month)
            const now = new Date();
            const resetDate = userCredits.monthlyPromptsReset ? new Date(userCredits.monthlyPromptsReset) : null;
            
            if (!resetDate || now.getMonth() !== resetDate.getMonth() || now.getFullYear() !== resetDate.getFullYear()) {
                userCredits.monthlyPromptsUsed = 0;
                userCredits.monthlyPromptsReset = now.toISOString();
                
                // Refresh monthly credits
                const lastRefresh = userCredits.lastCreditRefresh ? new Date(userCredits.lastCreditRefresh) : null;
                const shouldRefreshCredits = !lastRefresh || 
                    (now.getMonth() !== lastRefresh.getMonth() || now.getFullYear() !== lastRefresh.getFullYear());
                
                if (shouldRefreshCredits) {
                    const tierConfig = CONFIG.CREDITS.TIERS[userCredits.tier];
                    if (tierConfig) {
                        if (userCredits.tier === 'free') {
                            // FREE TIER: Set to 1, don't accumulate (but keep any purchased credits)
                            userCredits.subscriptionCredits = 1;
                        } else {
                            // PAID TIERS: Add monthly credits (respecting rollover max)
                            const newCredits = userCredits.subscriptionCredits + tierConfig.monthlyCredits;
                            userCredits.subscriptionCredits = Math.min(newCredits, tierConfig.maxBanked);
                        }
                        userCredits.lastCreditRefresh = now.toISOString();
                    }
                }
                
                saveUserCredits();
            }
            
            // ALWAYS ensure free tier has at least 1 subscription credit
            // (This catches existing users who have 0)
            if (userCredits.tier === 'free' && userCredits.subscriptionCredits < 1) {
                userCredits.subscriptionCredits = 1;
                saveUserCredits();
            }
            
        } catch (e) {
            console.error('Error parsing credits:', e);
        }
    } else {
        // New user - initialize with free tier defaults (1 credit)
        userCredits = {
            balance: 0,
            tier: 'free',
            monthlyPromptsUsed: 0,
            monthlyPromptsReset: new Date().toISOString(),
            activeBundles: [],
            purchasedCredits: 0,
            subscriptionCredits: 1, // Free tier gets 1 credit
            lastCreditRefresh: new Date().toISOString()
        };
        saveUserCredits();
    }
    
    updateCreditsDisplay();
}

// Save credits to localStorage
function saveUserCredits() {
    const userKey = currentUser?.uid || currentUser || 'anonymous';
    localStorage.setItem('fitzCredits_' + userKey, JSON.stringify(userCredits));
    updateCreditsDisplay();
    
    // Also sync to Firebase if user is logged in
    if (currentUser?.uid) {
        syncCreditsToFirebase();
    }
}

// Load credits from Firebase
async function loadCreditsFromFirebase() {
    if (!currentUser?.uid) return false;
    
    // Skip if we just processed a payment return (local credits are more up-to-date)
    if (skipFirebaseCreditsLoad) {
        console.log('â­ï¸ Skipping Firebase load - payment just processed');
        skipFirebaseCreditsLoad = false;
        return false;
    }
    
    try {
        console.log('ðŸ”„ Loading credits from Firebase for:', currentUser.uid);
        const userRef = db.collection('users').doc(currentUser.uid);
        const doc = await userRef.get();
        
        if (doc.exists && doc.data().credits) {
            const firebaseCredits = doc.data().credits;
            
            // Merge Firebase data with local (Firebase is source of truth)
            userCredits = {
                ...userCredits,
                tier: firebaseCredits.tier || 'free',
                subscriptionCredits: firebaseCredits.subscriptionCredits || 0,
                purchasedCredits: firebaseCredits.purchasedCredits || 0,
                bonusPrompts: firebaseCredits.bonusPrompts || 0,
                monthlyPromptsUsed: firebaseCredits.monthlyPromptsUsed || 0,
                monthlyPromptsReset: firebaseCredits.monthlyPromptsReset || new Date().toISOString(),
                lastCreditRefresh: firebaseCredits.lastCreditRefresh || null,
                stripeCustomerId: firebaseCredits.stripeCustomerId || null
            };
            
            // Save to localStorage as cache
            const userKey = currentUser.uid;
            localStorage.setItem('fitzCredits_' + userKey, JSON.stringify(userCredits));
            
            console.log('âœ… Credits loaded from Firebase:', userCredits);
            updateCreditsDisplay();
            return true;
        } else {
            console.log('No credits data in Firebase, using defaults');
            return false;
        }
    } catch (e) {
        console.error('Error loading credits from Firebase:', e);
        return false;
    }
}

/**
 * Sync local credits to Firebase (called after local changes)
 */
async function syncCreditsToFirebase() {
    if (!currentUser?.uid) return;
    
    try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await userRef.set({
            credits: {
                tier: userCredits.tier,
                subscriptionCredits: userCredits.subscriptionCredits,
                purchasedCredits: userCredits.purchasedCredits,
                bonusPrompts: userCredits.bonusPrompts || 0,
                monthlyPromptsUsed: userCredits.monthlyPromptsUsed,
                monthlyPromptsReset: userCredits.monthlyPromptsReset,
                lastCreditRefresh: userCredits.lastCreditRefresh,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }
        }, { merge: true });
        console.log('âœ… Credits synced to Firebase');
    } catch (e) {
        console.error('Error syncing credits to Firebase:', e);
    }
}

// Get total available credits
function getTotalCredits() {
    return userCredits.purchasedCredits + userCredits.subscriptionCredits;
}

// Check if user can afford a document
function canAffordDocument(docType) {
    const cost = CONFIG.CREDITS.DOCUMENT_COSTS[docType];
    if (!cost) return false;
    
    return getTotalCredits() >= cost.credits;
}

// Deduct credits for a document
function deductCreditsForDocument(docType) {
    const cost = CONFIG.CREDITS.DOCUMENT_COSTS[docType];
    if (!cost) return false;
    
    // Deduct from purchased credits first (they don't expire)
    if (userCredits.purchasedCredits >= cost.credits) {
        userCredits.purchasedCredits -= cost.credits;
    } else {
        // Use combination of purchased and subscription credits
        const remaining = cost.credits - userCredits.purchasedCredits;
        userCredits.purchasedCredits = 0;
        userCredits.subscriptionCredits -= remaining;
    }
    
    saveUserCredits();
    return true;
}

// Check if user has prompts remaining
function hasPromptsRemaining() {
    // Paid subscribers have unlimited prompts
    if (userCredits.tier !== 'free') return true;
    
    return userCredits.monthlyPromptsUsed < CONFIG.CREDITS.FREE_TIER.MONTHLY_PROMPTS;
}

// Use a prompt
function usePrompt() {
    if (userCredits.tier === 'free') {
        userCredits.monthlyPromptsUsed++;
        saveUserCredits();
    }
}

// Get remaining prompts for free tier
function getRemainingPrompts() {
    if (userCredits.tier !== 'free') return Infinity;
    return CONFIG.CREDITS.FREE_TIER.MONTHLY_PROMPTS - userCredits.monthlyPromptsUsed;
}

// Update the credits display in the header
function updateCreditsDisplay() {
    const creditsDisplay = document.getElementById('creditsDisplay');
    const creditsBalance = document.getElementById('creditsBalance');
    const promptsDisplay = document.getElementById('promptsDisplay');
    const promptsCounter = document.getElementById('promptsCounter');
    const userTierDisplay = document.getElementById('userTierDisplay');
    
    if (creditsDisplay) {
        creditsDisplay.classList.remove('hidden');
    }
    
    // Update tier display in header
    if (userTierDisplay) {
        const tierName = CONFIG.CREDITS.TIERS[userCredits.tier]?.name || 'Free';
        userTierDisplay.textContent = tierName;
        
        // Color code by tier
        userTierDisplay.classList.remove('text-slate-400', 'text-blue-400', 'text-amber-400', 'text-purple-400');
        if (userCredits.tier === 'enterprise') {
            userTierDisplay.classList.add('text-purple-400');
        } else if (userCredits.tier === 'professional') {
            userTierDisplay.classList.add('text-amber-400');
        } else if (userCredits.tier === 'starter') {
            userTierDisplay.classList.add('text-blue-400');
        } else {
            userTierDisplay.classList.add('text-slate-400');
        }
    }
    
    if (creditsBalance) {
        const total = getTotalCredits();
        creditsBalance.textContent = total;
        
        // Color code based on balance
        creditsBalance.classList.remove('text-green-400', 'text-amber-400', 'text-red-400');
        if (total >= 10) {
            creditsBalance.classList.add('text-green-400');
        } else if (total >= 3) {
            creditsBalance.classList.add('text-amber-400');
        } else if (total >= 1) {
            creditsBalance.classList.add('text-amber-400');
        } else {
            creditsBalance.classList.add('text-red-400');
        }
    }
    
    // Update prompts display for free tier
    if (promptsDisplay && promptsCounter) {
        if (userCredits.tier === 'free') {
            const remaining = getRemainingPrompts();
            promptsCounter.textContent = `${remaining}/${CONFIG.CREDITS.FREE_TIER.MONTHLY_PROMPTS}`;
            promptsDisplay.classList.remove('hidden');
            
            // Color code prompts based on remaining
            promptsCounter.classList.remove('bg-blue-600', 'bg-amber-600', 'bg-red-600');
            if (remaining > 10) {
                promptsCounter.classList.add('bg-blue-600');
            } else if (remaining > 5) {
                promptsCounter.classList.add('bg-amber-600');
            } else {
                promptsCounter.classList.add('bg-red-600');
            }
        } else {
            // Paid tiers get unlimited prompts
            promptsDisplay.classList.add('hidden');
        }
    }
}

// ========================================
// DARK MODE SYSTEM
// ========================================

/**
 * Initialize dark mode from localStorage
 * Called on page load
 */
function initDarkMode() {
    // Check localStorage for saved preference (default is dark mode)
    const isDarkMode = localStorage.getItem('darkMode') !== 'false';
    
    if (!isDarkMode) {
        // User prefers light mode
        document.body.classList.add('light-mode');
        updateDarkModeButton(false);
    } else {
        // User prefers dark mode (default)
        document.body.classList.remove('light-mode');
        updateDarkModeButton(true);
    }
}

/**
 * Toggle between light and dark mode
 */
function toggleDarkMode() {
    const isCurrentlyDark = !document.body.classList.contains('light-mode');
    
    if (isCurrentlyDark) {
        // Switch to light mode
        document.body.classList.add('light-mode');
        localStorage.setItem('darkMode', 'false');
        updateDarkModeButton(false);
    } else {
        // Switch to dark mode
        document.body.classList.remove('light-mode');
        localStorage.setItem('darkMode', 'true');
        updateDarkModeButton(true);
    }
}

/**
 * Update the dark mode button appearance
 */
function updateDarkModeButton(isDark) {
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    
    if (icon && text) {
        if (isDark) {
            icon.textContent = 'ðŸŒ™';
            text.textContent = 'Dark';
        } else {
            icon.textContent = 'â˜€ï¸';
            text.textContent = 'Light';
        }
    }
}


// ========================================
// VENUE MEMORY SYSTEM - GLOBAL STATE
// ========================================

let venueProfile = {
    userName: null,
    venueType: null,
    location: null,
    city: null,
    staffCount: null,
    primaryAward: null,
    mainChallenge: null,
    setupComplete: false,
    setupDate: null,
    venueName: null
};

let onboardingCurrentStep = 1;
const ONBOARDING_STEPS = 6;

// ========================================
// ADMIN ANALYTICS TRACKING
// ========================================

let analyticsData = {
    conversations: [],
    themes: {},
    highRiskTopics: [],
    userProfiles: {}
};

// ========================================
// ENHANCED DOCUMENT BUILDER DETECTION
// ========================================

/**
 * Detects if user message requires Document Builder tool
 * Returns tool suggestion object or null
 */
function detectDocumentBuilderNeed(message) {
    const lowerMessage = message.toLowerCase();
    
    const documentTriggers = {
        formalWarning: {
            keywords: ['formal warning', 'written warning', 'issue a warning', 'give a warning', 'write a warning', 'warning letter'],
            title: 'Formal Warning Required',
            description: 'Use Document Builder to create a legally compliant formal warning letter'
        },
        recordOfDiscussion: {
            keywords: ['record of discussion', 'document conversation', 'discussion meeting', 'talk to employee about', 'rod'],
            title: 'Record of Discussion',
            description: 'Use Document Builder to create a record of discussion template with conversation script'
        },
        performanceImprovementPlan: {
            keywords: ['performance improve', 'pip', 'performance plan', 'underperforming', 'performance manage', 'performance issue'],
            title: 'Performance Improvement Plan',
            description: 'Use Document Builder to create a structured 12-week performance improvement plan'
        },
        letterOfAllegation: {
            keywords: ['investigate', 'serious misconduct', 'allegation', 'suspend', 'investigation'],
            title: 'Letter of Allegation',
            description: 'Use Document Builder for serious misconduct investigation process'
        },
        termination: {
            keywords: ['terminate', 'termination', 'fire', 'dismiss', 'dismissal', 'sack', 'let go', 'end employment'],
            title: 'Termination Process',
            description: 'CRITICAL: Senior Consultant guidance required for termination'
        }
    };
    
    for (const [type, config] of Object.entries(documentTriggers)) {
        if (config.keywords.some(keyword => lowerMessage.includes(keyword))) {
            return {
                type: type,
                title: config.title,
                description: config.description,
                isTermination: type === 'termination'
            };
        }
    }
    
    return null;
}

/**
 * Detects if user needs a specific tool based on their message
 * Returns array of tool suggestions (can suggest multiple tools)
 */
function detectToolNeeds(message) {
    const lowerMessage = message.toLowerCase();
    const detectedTools = [];
    
    const toolTriggers = {
        // ============================================================
        // EMPLOYMENT CONTRACT / NEW EMPLOYEE TOOLKIT
        // ============================================================
        employmentContract: {
            keywords: [
                // Direct terms
                'employment contract', 'employee contract', 'work contract', 'job contract',
                'contract template', 'employment agreement', 'hiring contract', 'staff contract',
                // Offer letters
                'offer letter', 'letter of offer', 'job offer letter', 'employment offer',
                // Contract types
                'full time contract', 'part time contract', 'casual contract', 'fixed term contract',
                'permanent contract', 'temporary contract', 'probation contract',
                // New hire related
                'new employee paperwork', 'employment paperwork', 'hiring paperwork',
                'new starter paperwork', 'new hire documents', 'employment documents',
                // Actions
                'create contract', 'draft contract', 'write contract', 'make contract',
                'need a contract', 'prepare contract', 'generate contract',
                // Situations
                'hiring someone', 'taking on staff', 'employing someone', 'new staff member',
                'bringing on', 'onboard new', 'starting new employee', 'new team member',
                // Questions
                'contract for new', 'what should contract include', 'contract requirements',
                'fair work contract', 'compliant contract', 'legal contract'
            ],
            title: 'ðŸ“„ Employment Contract',
            description: 'Create Fair Work compliant employment contracts with our New Employee Toolkit',
            action: 'openNewEmployeeToolkit()',
            buttonText: 'Open New Employee Toolkit',
            color: 'emerald'
        },
        
        // ============================================================
        // JOB DESCRIPTION / RECRUITMENT
        // ============================================================
        jobDescription: {
            keywords: [
                // Direct terms
                'job description', 'job ad', 'job advertisement', 'job posting', 'job listing',
                'position description', 'role description', 'pd', 'jd',
                // Writing/Creating
                'write job ad', 'create job ad', 'draft job ad', 'make job ad',
                'write job description', 'create job description', 'write position description',
                // Hiring intent
                'hiring for', 'recruiting for', 'need to hire', 'looking to hire', 'want to hire',
                'looking for staff', 'need staff', 'need employees', 'hiring staff',
                'recruit a', 'recruit an', 'recruiting a', 'recruiting an',
                // Advertising
                'advertise position', 'advertise role', 'advertise job', 'post job',
                'seek ad', 'indeed ad', 'linkedin job', 'job board',
                // Specific roles (hospitality)
                'hire a chef', 'hire a cook', 'hire a waiter', 'hire a waitress',
                'hire a bartender', 'hire a barista', 'hire kitchen hand', 'hire dishwasher',
                'hire a manager', 'hire supervisor', 'hire front of house', 'hire foh',
                'hire back of house', 'hire boh', 'hire hospo staff',
                // Questions
                'how to write job ad', 'job ad template', 'what to include in job ad',
                'attract candidates', 'find staff', 'find employees'
            ],
            title: 'ðŸ“ Job Description Generator',
            description: 'Create professional, compliant job descriptions with our Recruitment Toolkit',
            action: 'openRecruitmentToolkit()',
            buttonText: 'Open Recruitment Toolkit',
            color: 'purple'
        },
        
        // ============================================================
        // INTERVIEW QUESTIONS
        // ============================================================
        interviewQuestions: {
            keywords: [
                // Direct terms
                'interview question', 'interview questions', 'interview guide', 'interview template',
                'interview script', 'interview form', 'interview sheet',
                // Actions
                'interviewing candidate', 'interviewing applicant', 'conduct interview',
                'conducting interview', 'run interview', 'running interviews', 'do interview',
                // Questions about interviewing
                'how to interview', 'what to ask in interview', 'what to ask candidate',
                'questions to ask', 'good interview questions', 'best questions to ask',
                'interview tips', 'interview advice',
                // Types
                'behavioural interview', 'behavioral interview', 'competency interview',
                'structured interview', 'phone interview', 'phone screen',
                // Preparation
                'interview prep', 'prepare for interview', 'interview preparation',
                'ready for interview', 'before interview',
                // Specific roles
                'interview chef', 'interview waiter', 'interview bartender', 'interview barista',
                'interview manager', 'interview cook', 'interview kitchen',
                // Compliance
                'legal interview questions', 'compliant interview', 'what can i ask',
                'what cant i ask', 'illegal interview questions', 'discriminatory questions'
            ],
            title: 'ðŸŽ¤ Interview Questions Generator',
            description: 'Generate role-specific, legally compliant interview questions',
            action: 'openRecruitmentToolkit()',
            buttonText: 'Open Recruitment Toolkit',
            color: 'purple'
        },
        
        // ============================================================
        // REFERENCE CHECK
        // ============================================================
        referenceCheck: {
            keywords: [
                // Direct terms
                'reference check', 'reference checking', 'ref check', 'check reference',
                'reference call', 'reference form', 'reference template',
                // People
                'calling referee', 'contact referee', 'speak to referee', 'referee questions',
                'previous employer', 'former employer', 'past employer', 'old boss',
                // Verification
                'employment verification', 'verify employment', 'check employment history',
                'background check', 'employment history', 'work history',
                // Actions
                'do reference check', 'conduct reference check', 'get references',
                'call references', 'check references', 'contact references',
                // Questions
                'reference questions', 'what to ask referee', 'what to ask reference',
                'how to check references', 'reference check questions',
                // After interview
                'after interview', 'before hiring', 'before offering job'
            ],
            title: 'ðŸ“‹ Reference Check Form',
            description: 'Generate a professional reference check form with key questions',
            action: 'openReferenceCheckForm()',
            buttonText: 'Open Reference Check Form',
            color: 'blue'
        },
        
        // ============================================================
        // ONBOARDING CHECKLIST
        // ============================================================
        onboardingChecklist: {
            keywords: [
                // Direct terms
                'onboarding checklist', 'onboarding list', 'onboarding template',
                'induction checklist', 'induction list', 'induction template',
                'orientation checklist', 'orientation list',
                // New starter
                'new starter checklist', 'new starter induction', 'new starter orientation',
                'new employee checklist', 'new employee induction', 'new employee orientation',
                'new hire checklist', 'new hire induction', 'new hire onboarding',
                // First day/week
                'first day checklist', 'first day list', 'first week checklist',
                'day one checklist', 'week one checklist', 'first shift checklist',
                // Process
                'onboarding process', 'induction process', 'orientation process',
                'onboarding program', 'induction program', 'orientation program',
                // Staff
                'staff induction', 'staff orientation', 'staff onboarding',
                'employee induction', 'employee orientation', 'employee onboarding',
                // Actions
                'onboard new employee', 'induct new employee', 'orient new employee',
                'onboard new staff', 'induct new staff', 'starting new employee',
                // Questions
                'how to onboard', 'what to include in induction', 'onboarding requirements',
                'induction requirements', 'new employee needs', 'new starter needs',
                // Documents needed
                'tfn declaration', 'super choice', 'tax file', 'superannuation form',
                'bank details', 'emergency contact'
            ],
            title: 'âœ… Onboarding Checklist Builder',
            description: 'Create a comprehensive onboarding checklist for new employees',
            action: 'openOnboardingChecklist()',
            buttonText: 'Build Onboarding Checklist',
            color: 'amber'
        },
        
        // ============================================================
        // TRAINING PLAN
        // ============================================================
        trainingPlan: {
            keywords: [
                // Direct terms
                'training plan', 'training program', 'training schedule', 'training template',
                'development plan', 'learning plan', 'training matrix', 'skills matrix',
                // Types
                'employee training', 'staff training', 'team training', 'new employee training',
                'competency training', 'skills training', 'job training', 'role training',
                // Actions
                'train new employee', 'train new staff', 'train team', 'upskill',
                'skill development', 'develop skills', 'develop employee', 'develop staff',
                'create training', 'design training', 'build training',
                // Hospitality specific
                'train chef', 'train cook', 'train waiter', 'train bartender', 'train barista',
                'kitchen training', 'front of house training', 'foh training', 'boh training',
                'food safety training', 'rsa training', 'customer service training',
                // Compliance
                'training requirements', 'mandatory training', 'required training',
                'training records', 'training log', 'training documentation',
                // Questions
                'how to train', 'what training needed', 'training checklist',
                'how long to train', 'training timeline', 'training duration'
            ],
            title: 'ðŸ“š Training Plan Generator',
            description: 'Create structured training plans for employee development',
            action: 'openTrainingPlan()',
            buttonText: 'Create Training Plan',
            color: 'cyan'
        },
        
        // ============================================================
        // PROBATION CHECK-IN
        // ============================================================
        probationCheckIn: {
            keywords: [
                // Direct terms
                'probation check-in', 'probation check in', 'probation checkin',
                'probation meeting', 'probation assessment',
                'probation evaluation', 'probation period', 'probation progress',
                // Variations
                'probationary period', 'probationary check',
                'probation report', 'probation template',
                // Actions
                'check probation', 'assess probation',
                'probation conversation', 'probation discussion', 'probation feedback',
                // Questions
                'probation check in template',
                'what to cover in probation',
                'probation meeting template',
                // Contextual
                'new employee review', 'new starter review', 'new hire review',
                'first month review', 'second month review', 'third month review',
                // Combined
                'probation support', 'probation development', 'probation plan',
                'during probation'
            ],
            title: 'ðŸ”„ Probation Check-In Builder',
            description: 'Generate structured probation review documents with AI',
            action: 'openProbationCheckIn()',
            buttonText: 'Build Probation Check-In',
            color: 'teal'
        },
        
        // ============================================================
        // FORMAL PROBATION REVIEW
        // ============================================================
        formalProbationReview: {
            keywords: [
                // Direct terms
                'formal probation review', 'formal probation', 'probation review document',
                'probation review form', 'probation review template',
                // Actions
                'review probation', 'probation review',
                // End of probation outcomes
                'end of probation', 'pass probation', 'fail probation', 'extend probation',
                'confirm employment', 'confirm permanent', 'probation outcome',
                'probationary review', 'probation period review',
                // Formal review context
                'not meeting probation', 'failing probation', 'probation concerns',
                'terminate during probation', 'end employment probation',
                'probation performance review', 'how to do probation review',
                'probation review questions'
            ],
            title: 'ðŸ“‘ Formal Probation Review',
            description: 'Generate a formal probation review document with AI â€” includes action plan, key messages & signatures',
            action: "openDocumentBuilderFor('formalProbationReview')",
            buttonText: 'Build Formal Probation Review',
            color: 'teal'
        },
        
        // ============================================================
        // AWARD WIZARD / PAY RATES
        // ============================================================
        awardRates: {
            keywords: [
                // Direct terms
                'award rate', 'award rates', 'pay rate', 'pay rates', 'wage rate', 'wage rates',
                'minimum wage', 'minimum pay', 'base rate', 'base pay',
                // Specific rates
                'hourly rate', 'hourly pay', 'casual rate', 'casual loading',
                'penalty rate', 'penalty rates', 'weekend rate', 'weekend rates',
                'saturday rate', 'sunday rate', 'public holiday rate', 'holiday rate',
                'overtime rate', 'overtime pay', 'night rate', 'evening rate',
                // Questions
                'what should i pay', 'how much to pay', 'how much should i pay',
                'what is the rate', 'what are the rates', 'current rates',
                'correct pay', 'right pay', 'legal pay', 'fair pay',
                // Classification
                'classification', 'award classification', 'employee classification',
                'level 1', 'level 2', 'level 3', 'level 4', 'level 5', 'level 6',
                'food and beverage', 'kitchen employee', 'front of house attendant',
                // Award
                'hospitality award', 'restaurant award', 'cafe award', 'hotel award',
                'higa', 'hospitality industry general award', 'modern award',
                // Specific roles
                'pay chef', 'pay cook', 'pay waiter', 'pay bartender', 'pay barista',
                'pay kitchen hand', 'pay dishwasher', 'pay manager', 'pay supervisor',
                // Underpayment concerns
                'underpaying', 'underpayment', 'paying enough', 'paying correctly',
                'am i paying right', 'paying too little', 'paying correctly'
            ],
            title: 'ðŸ§™ Award Wizard',
            description: 'Find the correct pay rates and classifications under the Hospitality Award',
            action: 'openAwardWizard()',
            buttonText: 'Open Award Wizard',
            color: 'amber'
        },
        
        // ============================================================
        // AWARD CALCULATOR
        // ============================================================
        awardCalculator: {
            keywords: [
                // Direct calculations
                'calculate pay', 'calculate wage', 'calculate wages', 'calculate shift',
                'work out pay', 'work out wage', 'work out shift',
                // Calculator terms
                'pay calculator', 'wage calculator', 'shift calculator', 'payroll calculator',
                'hours calculator', 'overtime calculator', 'penalty calculator',
                // Specific calculations
                'how much for shift', 'how much is shift', 'shift cost', 'shift pay',
                'calculate overtime', 'calculate penalty', 'calculate penalties',
                'calculate public holiday', 'calculate weekend', 'calculate saturday', 'calculate sunday',
                // Questions
                'what will shift cost', 'cost of shift', 'shift total',
                'how much do i owe', 'how much to pay for', 'total pay for',
                // Specific scenarios
                '8 hour shift', '10 hour shift', 'double shift', 'split shift',
                'morning shift', 'afternoon shift', 'night shift', 'overnight shift',
                // Payroll
                'weekly pay', 'fortnightly pay', 'payslip', 'pay run'
            ],
            title: 'ðŸ’° Award Calculator',
            description: 'Calculate exact pay for shifts including penalties and overtime',
            action: 'openAwardCalculator()',
            buttonText: 'Open Award Calculator',
            color: 'green'
        },
        
        // ============================================================
        // ROSTER STRESS TESTER / COMPLIANCE
        // ============================================================
        rosterCompliance: {
            keywords: [
                // Direct terms
                'roster compliance', 'roster check', 'check roster', 'roster legal',
                'compliant roster', 'roster rules', 'rostering rules', 'roster requirements',
                // Stress test
                'roster stress', 'stress test', 'stress tester', 'test roster',
                // Breaks
                'break compliance', 'break requirements', 'break rules', 'meal break',
                'rest break', 'minimum break', 'break between shifts',
                // Hours
                'minimum hours', 'maximum hours', 'minimum shift', 'maximum shift',
                'hours between shifts', '10 hour break', '11 hour break', 'rest period',
                'consecutive days', 'days off', 'overtime hours',
                // Shift issues
                'shift compliance', 'shift legal', 'shift rules', 'shift requirements',
                'split shift', 'clopening', 'close open', 'back to back',
                // Questions
                'is my roster legal', 'is roster compliant', 'roster okay',
                'roster problem', 'roster issue', 'roster violation',
                // Before publishing
                'before publishing roster', 'check before publish', 'review roster'
            ],
            title: 'ðŸ’¥ Roster Stress Tester',
            description: 'Check your roster for compliance issues before publishing',
            action: 'openRosterStressTester()',
            buttonText: 'Open Roster Stress Tester',
            color: 'red'
        },
        
        // ============================================================
        // DEPUTY INTEGRATION
        // ============================================================
        deputyImport: {
            keywords: [
                // Direct terms
                'deputy', 'import deputy', 'deputy import', 'connect deputy',
                'deputy integration', 'sync deputy', 'link deputy',
                // Data
                'deputy roster', 'deputy rosters', 'deputy timesheet', 'deputy timesheets',
                'deputy data', 'deputy export', 'export from deputy', 'deputy csv',
                'deputy employees', 'deputy staff', 'deputy schedule',
                // Actions
                'get deputy data', 'pull from deputy', 'import from deputy',
                'connect to deputy', 'link to deputy', 'sync with deputy',
                // Questions
                'use deputy', 'using deputy', 'have deputy', 'deputy account'
            ],
            title: 'ðŸ”— Deputy Integration',
            description: 'Import rosters and timesheets from Deputy for compliance checking',
            action: 'openIntegrationHub()',
            buttonText: 'Open Integration Hub',
            color: 'blue'
        },
        
        // ============================================================
        // XERO INTEGRATION
        // ============================================================
        xeroImport: {
            keywords: [
                // Direct terms
                'xero', 'import xero', 'xero import', 'connect xero',
                'xero integration', 'sync xero', 'link xero',
                // Data
                'xero payroll', 'xero employees', 'xero staff', 'xero data',
                'xero export', 'export from xero', 'xero csv',
                // Actions
                'get xero data', 'pull from xero', 'import from xero',
                'connect to xero', 'link to xero', 'sync with xero',
                // Questions
                'use xero', 'using xero', 'have xero', 'xero account'
            ],
            title: 'ðŸ”— Xero Integration',
            description: 'Import employee and payroll data from Xero',
            action: 'openIntegrationHub()',
            buttonText: 'Open Integration Hub',
            color: 'green'
        },
        
        // ============================================================
        // TERMINATION RISK ASSESSOR
        // ============================================================
        terminationRisk: {
            keywords: [
                // Direct termination terms
                'terminate', 'termination', 'terminating', 'fire', 'firing', 'fired',
                'dismiss', 'dismissal', 'dismissing', 'sack', 'sacking', 'sacked',
                'let go', 'letting go', 'end employment', 'ending employment',
                // Redundancy
                'redundancy', 'redundant', 'make redundant', 'making redundant',
                'restructure', 'restructuring', 'downsizing', 'downsize',
                // Risk assessment
                'termination risk', 'dismissal risk', 'unfair dismissal',
                'unfair dismissal risk', 'risk of termination', 'termination assessment',
                // Questions/Intent
                'can i fire', 'can i terminate', 'can i dismiss', 'can i sack',
                'should i fire', 'should i terminate', 'want to fire', 'want to terminate',
                'need to fire', 'need to terminate', 'going to fire', 'going to terminate',
                'thinking of firing', 'considering termination', 'planning to fire',
                // Safe to proceed
                'safe to terminate', 'safe to fire', 'safe to dismiss',
                'okay to fire', 'okay to terminate', 'legal to fire', 'legal to terminate',
                // Getting rid of
                'get rid of employee', 'get rid of staff', 'remove employee',
                'exit employee', 'move on employee', 'part ways'
            ],
            title: 'âš–ï¸ Termination Risk Assessor',
            description: 'Assess the legal risks before proceeding with termination',
            action: 'openTerminationRisk()',
            buttonText: 'Open Risk Assessor',
            color: 'red'
        },
        
        // ============================================================
        // COMPLIANCE CALENDAR
        // ============================================================
        complianceCalendar: {
            keywords: [
                // Direct terms
                'compliance calendar', 'compliance dates', 'compliance deadlines',
                'compliance reminder', 'compliance reminders', 'compliance schedule',
                // Award updates
                'award update', 'award updates', 'rate change', 'rate changes',
                'pay increase', 'wage increase', 'minimum wage increase',
                'annual wage review', '1 july', 'july rate increase',
                // Leave
                'annual leave', 'leave accrual', 'leave balance', 'leave entitlements',
                'personal leave', 'sick leave', 'long service leave',
                // Casual conversion
                'casual conversion', 'casual to permanent', 'casual to part time',
                'conversion offer', '12 month casual', 'regular casual',
                // Deadlines
                'compliance deadline', 'deadline', 'due date', 'when is',
                'important dates', 'key dates', 'hr calendar', 'payroll calendar',
                // Questions
                'what compliance', 'upcoming compliance', 'compliance requirements'
            ],
            title: 'ðŸ“… Compliance Calendar',
            description: 'Track important compliance deadlines and get reminders',
            action: 'openComplianceCalendar()',
            buttonText: 'Open Compliance Calendar',
            color: 'indigo'
        },
        
        // ============================================================
        // DOCUMENT BUILDER - FORMAL WARNING
        // ============================================================
        formalWarning: {
            keywords: [
                // Direct terms
                'formal warning', 'written warning', 'official warning', 'warning letter',
                'first warning', 'second warning', 'final warning', '1st warning', '2nd warning',
                'first written warning', 'second written warning', 'final written warning',
                // Actions
                'issue warning', 'issue a warning', 'give warning', 'give a warning',
                'write warning', 'write a warning', 'send warning', 'send a warning',
                'create warning', 'draft warning', 'prepare warning',
                // Situations
                'need to warn', 'want to warn', 'going to warn',
                'warning for lateness', 'warning for absence', 'warning for conduct',
                'warning for behaviour', 'warning for behavior', 'warning for performance',
                // Discipline
                'disciplinary warning', 'disciplinary letter', 'disciplinary action',
                'discipline employee', 'disciplining staff'
            ],
            title: 'ðŸ“ Formal Warning Letter',
            description: 'Create a legally compliant formal warning letter with our Document Builder',
            action: "openDocumentBuilderFor('formalWarning')",
            buttonText: 'Open Document Builder',
            color: 'blue'
        },
        
        // ============================================================
        // DOCUMENT BUILDER - RECORD OF DISCUSSION
        // ============================================================
        recordOfDiscussion: {
            keywords: [
                // Direct terms
                'record of discussion', 'rod', 'discussion record', 'meeting record',
                'record of conversation', 'conversation record', 'documented discussion',
                // Informal actions
                'verbal warning', 'informal warning', 'informal chat', 'quick chat',
                'counselling session', 'counseling session', 'coaching session',
                // Actions
                'document conversation', 'document discussion', 'record meeting',
                'talk to employee about', 'speak to employee about', 'chat with employee',
                'have a conversation with', 'discuss with employee', 'address with employee',
                // Situations
                'talk about performance', 'talk about behaviour', 'talk about behavior',
                'talk about lateness', 'talk about attendance', 'talk about attitude',
                'address issue', 'address concern', 'raise concern',
                // Before formal action
                'before formal warning', 'instead of warning', 'informal first'
            ],
            title: 'ðŸ“ Record of Discussion',
            description: 'Create a record of discussion template with conversation script',
            action: "openDocumentBuilderFor('recordOfDiscussion')",
            buttonText: 'Open Document Builder',
            color: 'blue'
        },
        
        // ============================================================
        // DOCUMENT BUILDER - PERFORMANCE IMPROVEMENT PLAN
        // ============================================================
        performanceImprovementPlan: {
            keywords: [
                // Direct terms
                'performance improvement plan', 'pip', 'performance plan',
                'improvement plan', 'performance action plan', 'performance management plan',
                // Performance issues
                'performance issue', 'performance issues', 'performance problem',
                'performance concern', 'performance concerns', 'performance gap',
                'underperforming', 'under performing', 'not performing',
                'poor performance', 'bad performance', 'below expectations',
                'not meeting expectations', 'not meeting standards', 'not up to standard',
                // Performance management
                'performance manage', 'performance managing', 'manage performance',
                'managing performance', 'manage out', 'managing out',
                // Situations
                'employee not performing', 'staff not performing', 'struggling employee',
                'employee struggling', 'help employee improve', 'improve performance',
                // Actions
                'put on pip', 'place on pip', 'create pip', 'draft pip', 'need pip'
            ],
            title: 'ðŸ“ Performance Improvement Plan',
            description: 'Create a structured 12-week performance improvement plan',
            action: "openDocumentBuilderFor('performanceImprovementPlan')",
            buttonText: 'Open Document Builder',
            color: 'blue'
        },
        
        // ============================================================
        // DOCUMENT BUILDER - LETTER OF ALLEGATION
        // ============================================================
        letterOfAllegation: {
            keywords: [
                // Direct terms
                'letter of allegation', 'allegation letter', 'allegations letter',
                'show cause', 'show cause letter', 'please explain', 'please explain letter',
                // Investigation
                'investigate', 'investigation', 'investigating', 'workplace investigation',
                'conduct investigation', 'internal investigation', 'formal investigation',
                // Misconduct
                'serious misconduct', 'gross misconduct', 'misconduct', 'wilful misconduct',
                'breach of policy', 'policy breach', 'code of conduct breach',
                // Specific misconduct
                'theft', 'stealing', 'stole', 'stolen', 'fraud', 'fraudulent',
                'dishonesty', 'dishonest', 'lying', 'lied', 'falsified',
                'harassment', 'bullying', 'bullied', 'discrimination',
                'violence', 'violent', 'assault', 'threatened', 'threatening',
                'intoxicated', 'drunk', 'drugs', 'drug use', 'substance abuse',
                'insubordination', 'refused direction', 'disobeyed',
                // Response
                'respond to allegation', 'respond to allegations', 'right to respond',
                'opportunity to respond', 'employee response'
            ],
            title: 'ðŸ“ Letter of Allegation',
            description: 'Create a letter of allegation for serious misconduct investigation',
            action: "openDocumentBuilderFor('letterOfAllegation')",
            buttonText: 'Open Document Builder',
            color: 'orange'
        }
    };
    
    // Check each tool's keywords
    for (const [toolId, config] of Object.entries(toolTriggers)) {
        if (config.keywords.some(keyword => lowerMessage.includes(keyword))) {
            detectedTools.push({
                id: toolId,
                ...config
            });
        }
    }
    
    // Limit to top 2 most relevant tools to avoid overwhelming the user
    return detectedTools.slice(0, 2);
}

/**
 * Creates tool suggestion UI for detected tools
 */
function createToolSuggestions(detectedTools) {
    if (!detectedTools || detectedTools.length === 0) return '';
    
    const colorClasses = {
        emerald: { bg: 'bg-emerald-500/10', border: 'border-emerald-500', text: 'text-emerald-400', textLight: 'text-emerald-300', btn: 'bg-emerald-600 hover:bg-emerald-700' },
        purple: { bg: 'bg-purple-500/10', border: 'border-purple-500', text: 'text-purple-400', textLight: 'text-purple-300', btn: 'bg-purple-600 hover:bg-purple-700' },
        blue: { bg: 'bg-blue-500/10', border: 'border-blue-500', text: 'text-blue-400', textLight: 'text-blue-300', btn: 'bg-blue-600 hover:bg-blue-700' },
        amber: { bg: 'bg-amber-500/10', border: 'border-amber-500', text: 'text-amber-400', textLight: 'text-amber-300', btn: 'bg-amber-600 hover:bg-amber-700' },
        cyan: { bg: 'bg-cyan-500/10', border: 'border-cyan-500', text: 'text-cyan-400', textLight: 'text-cyan-300', btn: 'bg-cyan-600 hover:bg-cyan-700' },
        green: { bg: 'bg-green-500/10', border: 'border-green-500', text: 'text-green-400', textLight: 'text-green-300', btn: 'bg-green-600 hover:bg-green-700' },
        red: { bg: 'bg-red-500/10', border: 'border-red-500', text: 'text-red-400', textLight: 'text-red-300', btn: 'bg-red-600 hover:bg-red-700' },
        orange: { bg: 'bg-orange-500/10', border: 'border-orange-500', text: 'text-orange-400', textLight: 'text-orange-300', btn: 'bg-orange-600 hover:bg-orange-700' },
        indigo: { bg: 'bg-indigo-500/10', border: 'border-indigo-500', text: 'text-indigo-400', textLight: 'text-indigo-300', btn: 'bg-indigo-600 hover:bg-indigo-700' }
    };
    
    let html = '<div class="mb-4 space-y-3">';
    
    detectedTools.forEach(tool => {
        const colors = colorClasses[tool.color] || colorClasses.blue;
        html += `
            <div class="p-4 ${colors.bg} border-l-4 ${colors.border} rounded-r-lg">
                <p class="${colors.text} font-bold mb-1 flex items-center gap-2">
                    <span>${tool.title}</span>
                </p>
                <p class="${colors.textLight} text-sm mb-3">${tool.description}</p>
                <button onclick="${tool.action}" 
                        class="w-full ${colors.btn} text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 text-sm">
                    <span>${tool.buttonText}</span>
                    <span>â†’</span>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

/**
 * Creates Document Builder suggestion box for message
 */
function createDocumentBuilderSuggestion(detection) {
    if (detection.isTermination) {
        return `<div class="mb-4 p-4 bg-red-500/10 border-l-4 border-red-500 rounded-r-lg">
            <p class="text-red-400 font-bold mb-2 flex items-center gap-2">
                <span>ðŸš¨</span>
                <span>${detection.title}</span>
            </p>
            <p class="text-red-300 text-sm mb-3">
                Employment termination requires expert guidance to avoid legal risk.
            </p>
            <button onclick="showTerminationConsultantRequired()" 
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                <span>âš–ï¸</span>
                <span>View Termination Requirements</span>
            </button>
        </div>`;
    }
    
    return `<div class="mb-4 p-4 bg-blue-500/10 border-l-4 border-blue-500 rounded-r-lg">
        <p class="text-blue-400 font-bold mb-2 flex items-center gap-2">
            <span>ðŸ“</span>
            <span>${detection.title}</span>
        </p>
        <p class="text-blue-300 text-sm mb-3">${detection.description}</p>
        <button onclick="openDocumentBuilderFor('${detection.type}')" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>ðŸ“</span>
            <span>Open Document Builder</span>
        </button>
    </div>`;
}

/**
 * Opens Document Builder pre-selected to specific type
 */
function openDocumentBuilder() {
    // Track usage
    trackToolUsage('documentBuilderModal');
    
    // Open Document Builder modal without pre-selecting a type
    var modal = document.getElementById('documentBuilderModal');
    if (modal) {
        modal.classList.remove('hidden');
        
        // Reset to step 1 (document type selection)
        resetDocumentBuilderSilent();
        
        trackEvent('document_builder_opened_from_header', {
            user: currentUser
        });
    } else {
    }
}

function openDocumentBuilderFor(documentType) {
    // Open modal
    document.getElementById('documentBuilderModal').classList.remove('hidden');
    
    // Auto-select the document type
    if (documentType && documentType !== 'termination') {
        setTimeout(() => {
            selectDocumentType(documentType);
        }, 100);
    }
    
    trackEvent('document_builder_opened_from_suggestion', {
        user: currentUser,
        type: documentType
    });
}

// ========================================
// AWARD RATES - FETCH FROM GITHUB
// ========================================

let awardRates = null; // Global variable to store rates
// Rate URL now in CONFIG object - see line 1169

// Fetch rates on page load
/**
 * Loads award rates from GitHub with automatic retry
 * Falls back to hardcoded rates if GitHub is unavailable
 * @returns {Promise<boolean>} True if loaded from GitHub, false if using fallback
 */
async function loadAwardRates() {
    try {
        const response = await fetchWithRetry(CONFIG.API.RATES_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load rates`);
        
        awardRates = await response.json();
        return true;
    } catch (error) {
        // Fallback to basic rates if GitHub fails
        awardRates = getFallbackRates();
        return false;
    }
}

// Fallback rates if GitHub is down
function getFallbackRates() {
    return {
        version: 'fallback-2025',
        effective_date: '2024-07-01',
        next_review_date: '2025-07-01',
        notes: ['Using offline fallback rates'],
        rates: [
            { category: 'adult', employment_type: 'full_time', classification: 'introductory', rate: 24.28, title: 'Introductory Level' },
            { category: 'adult', employment_type: 'casual', classification: 'introductory', rate: 30.35, title: 'Introductory Level (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_1.food_beverage_grade1', rate: 24.95, title: 'Food & Beverage Grade 1' },
            { category: 'adult', employment_type: 'casual', classification: 'level_1.food_beverage_grade1', rate: 31.19, title: 'Food & Beverage Grade 1 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_1.kitchen_attendant_grade1', rate: 24.95, title: 'Kitchen Attendant Grade 1' },
            { category: 'adult', employment_type: 'casual', classification: 'level_1.kitchen_attendant_grade1', rate: 31.19, title: 'Kitchen Attendant Grade 1 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_1.guest_service_grade1', rate: 24.95, title: 'Guest Services Grade 1' },
            { category: 'adult', employment_type: 'casual', classification: 'level_1.guest_service_grade1', rate: 31.19, title: 'Guest Services Grade 1 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.food_beverage_grade2', rate: 25.85, title: 'Food & Beverage Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.food_beverage_grade2', rate: 32.31, title: 'Food & Beverage Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.cook_grade1', rate: 25.85, title: 'Cook Grade 1' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.cook_grade1', rate: 32.31, title: 'Cook Grade 1 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.kitchen_attendant_grade2', rate: 25.85, title: 'Kitchen Attendant Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.kitchen_attendant_grade2', rate: 32.31, title: 'Kitchen Attendant Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.guest_service_grade2', rate: 25.85, title: 'Guest Services Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.guest_service_grade2', rate: 32.31, title: 'Guest Services Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.front_office_grade1', rate: 25.85, title: 'Front Office Grade 1' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.front_office_grade1', rate: 32.31, title: 'Front Office Grade 1 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_2.doorperson_security', rate: 25.85, title: 'Doorperson/Security' },
            { category: 'adult', employment_type: 'casual', classification: 'level_2.doorperson_security', rate: 32.31, title: 'Doorperson/Security (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.food_beverage_grade3', rate: 26.70, title: 'Food & Beverage Grade 3' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.food_beverage_grade3', rate: 33.38, title: 'Food & Beverage Grade 3 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.cook_grade2', rate: 26.70, title: 'Cook Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.cook_grade2', rate: 33.38, title: 'Cook Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.kitchen_attendant_grade3', rate: 26.70, title: 'Kitchen Attendant Grade 3' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.kitchen_attendant_grade3', rate: 33.38, title: 'Kitchen Attendant Grade 3 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.guest_service_grade3', rate: 26.70, title: 'Guest Services Grade 3' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.guest_service_grade3', rate: 33.38, title: 'Guest Services Grade 3 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.front_office_grade2', rate: 26.70, title: 'Front Office Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.front_office_grade2', rate: 33.38, title: 'Front Office Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_3.timekeeper_security_grade2', rate: 26.70, title: 'Timekeeper/Security Grade 2' },
            { category: 'adult', employment_type: 'casual', classification: 'level_3.timekeeper_security_grade2', rate: 33.38, title: 'Timekeeper/Security Grade 2 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_4.food_beverage_tradesperson_grade4', rate: 28.12, title: 'Food & Beverage Tradesperson Grade 4' },
            { category: 'adult', employment_type: 'casual', classification: 'level_4.food_beverage_tradesperson_grade4', rate: 35.15, title: 'Food & Beverage Tradesperson Grade 4 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_4.cook_tradesperson_grade3', rate: 28.12, title: 'Cook Tradesperson Grade 3' },
            { category: 'adult', employment_type: 'casual', classification: 'level_4.cook_tradesperson_grade3', rate: 35.15, title: 'Cook Tradesperson Grade 3 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_4.guest_service_grade4', rate: 28.12, title: 'Guest Services Grade 4' },
            { category: 'adult', employment_type: 'casual', classification: 'level_4.guest_service_grade4', rate: 35.15, title: 'Guest Services Grade 4 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_4.front_office_grade3', rate: 28.12, title: 'Front Office Grade 3' },
            { category: 'adult', employment_type: 'casual', classification: 'level_4.front_office_grade3', rate: 35.15, title: 'Front Office Grade 3 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_5.food_beverage_supervisor', rate: 29.88, title: 'Food & Beverage Supervisor' },
            { category: 'adult', employment_type: 'casual', classification: 'level_5.food_beverage_supervisor', rate: 37.35, title: 'Food & Beverage Supervisor (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_5.cook_tradesperson_grade4', rate: 29.88, title: 'Cook Tradesperson Grade 4' },
            { category: 'adult', employment_type: 'casual', classification: 'level_5.cook_tradesperson_grade4', rate: 37.35, title: 'Cook Tradesperson Grade 4 (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_5.guest_service_supervisor', rate: 29.88, title: 'Guest Services Supervisor' },
            { category: 'adult', employment_type: 'casual', classification: 'level_5.guest_service_supervisor', rate: 37.35, title: 'Guest Services Supervisor (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_5.front_office_supervisor', rate: 29.88, title: 'Front Office Supervisor' },
            { category: 'adult', employment_type: 'casual', classification: 'level_5.front_office_supervisor', rate: 37.35, title: 'Front Office Supervisor (Casual)' },
            { category: 'adult', employment_type: 'full_time', classification: 'level_6.cook_tradesperson_grade5', rate: 30.68, title: 'Cook Tradesperson Grade 5' },
            { category: 'adult', employment_type: 'casual', classification: 'level_6.cook_tradesperson_grade5', rate: 38.35, title: 'Cook Tradesperson Grade 5 (Casual)' }
        ],
        penalty_rates: {
            saturday: 1.5,
            sunday: 1.75,
            public_holiday: 2.5,
            evening_after_7pm: 1.1
        },
        casual_loading: 0.25
    };
}

// Load rates immediately when page loads
loadAwardRates();

// ========================================
// UTILITY FUNCTIONS
// ========================================

/**
 * Sanitizes HTML to prevent XSS attacks
 * @param {string} html - Raw HTML string
 * @returns {string} Sanitized HTML safe for innerHTML
 */
function sanitizeHTML(html) {
    const temp = document.createElement('div');
    temp.textContent = html;
    return temp.innerHTML;
}

/**
 * Debounces a function call
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in milliseconds
 * @returns {Function} Debounced function
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Fetches data with automatic retry logic
 * @param {string} url - URL to fetch
 * @param {Object} options - Fetch options
 * @param {number} maxRetries - Maximum retry attempts
 * @returns {Promise<Response>}
 */
async function fetchWithRetry(url, options = {}, maxRetries = CONFIG.MAX_RETRIES) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            
            // If not the last retry, wait before trying again
            if (i < maxRetries - 1) {
                const delay = CONFIG.RETRY_DELAY * (i + 1); // Exponential backoff
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        } catch (error) {
            if (i === maxRetries - 1) throw error;
        }
    }
    throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts`);
}

/**
 * Wraps async functions with error handling
 * @param {Function} asyncFunc - Async function to wrap
 * @returns {Function} Wrapped function with error handling
 */
function withErrorHandling(asyncFunc) {
    return async function(...args) {
        try {
            return await asyncFunc(...args);
        } catch (error) {
            // Show user-friendly error
            const errorMessage = error.message || 'An unexpected error occurred';
            showAlert(`âš ï¸ ${errorMessage}\n\nPlease try again or contact support if the issue persists.`);
            
            // Re-throw for caller to handle if needed
            throw error;
        }
    };
}

// ========================================
// HIGH-RISK DETECTION & WARNING SYSTEM
// ========================================

/**
 * Detects high-risk topics in user messages
 * @param {string} message - User's message
 * @returns {Object|null} Risk object with type and severity, or null if no risk
 */
function detectHighRiskTopic(message) {
    const lowerMessage = message.toLowerCase();
    
    // Define high-risk keywords - ONLY for critical legal/termination matters
    const riskCategories = {
        termination: {
            keywords: [
                'terminate', 'termination', 'terminating', 'fire', 'firing', 'fired',
                'dismiss', 'dismissal', 'dismissing', 'sack', 'sacking', 'sacked',
                'let go', 'letting go', 'end employment', 'ending employment',
                'redundancy', 'redundant', 'make redundant', 'restructure',
                'get rid of employee', 'get rid of staff', 'exit employee'
            ],
            title: 'Employment Termination',
            severity: 'critical'
        },
        investigation: {
            keywords: [
                'investigate', 'investigation', 'investigating', 'allegation', 'allegations',
                'serious misconduct', 'gross misconduct', 'misconduct',
                'theft', 'stealing', 'stole', 'stolen', 'fraud', 'fraudulent',
                'dishonesty', 'dishonest', 'falsified'
            ],
            title: 'Workplace Investigation',
            severity: 'critical'
        },
        legal: {
            keywords: [
                'legal action', 'lawsuit', 'sue', 'suing', 'lawyer', 'solicitor',
                'unfair dismissal', 'unfair dismissal claim', 'general protections',
                'adverse action', 'discrimination claim', 'workers comp claim',
                'fair work complaint', 'fair work commission', 'fwc',
                'lodged complaint', 'filed complaint', 'taking legal'
            ],
            title: 'Legal Matter',
            severity: 'critical'
        },
        harassment: {
            keywords: [
                'sexual harassment', 'sexually harassed', 'assault', 'assaulted',
                'violence', 'violent', 'threatened', 'threatening', 'threats',
                'physical altercation', 'hit', 'punched', 'attacked'
            ],
            title: 'Harassment/Safety Issue',
            severity: 'critical'
        }
    };
    
    // Check each category - only return for critical severity
    for (const [category, config] of Object.entries(riskCategories)) {
        if (config.severity === 'critical') {
            const hasKeyword = config.keywords.some(keyword => lowerMessage.includes(keyword));
            if (hasKeyword) {
                return {
                    category: category,
                    title: config.title,
                    severity: config.severity
                };
            }
        }
    }
    
    return null;
}

/**
 * Creates a subtle but prominent high-risk warning
 * @param {Object} risk - Risk object from detectHighRiskTopic
 * @returns {string} HTML string for the warning box
 */

function createHighRiskWarningBox(risk) {
    const currentTime = new Date().toLocaleString('en-AU');
    
    return `<div class="mb-3 p-3 bg-red-500/10 border-l-4 border-red-500 rounded">
    <p class="text-red-400 font-bold text-sm flex items-center gap-2 mb-2">
        <span>âš ï¸</span>
        <span>IMPORTANT: This matter involves legal risk.</span>
    </p>
    <p class="text-red-300 text-sm mb-3">
        ${risk.title} - Please contact a Senior Consultant at <a href="mailto:info@fitzgeraldhr.com.au" class="underline hover:text-red-200">info@fitzgeraldhr.com.au</a> before taking action.
    </p>
    <div class="flex gap-2">
        <a href="mailto:info@fitzgeraldhr.com.au?subject=URGENT: ${encodeURIComponent(risk.title)} - ${encodeURIComponent(currentUser)}&body=${encodeURIComponent('I need urgent advice regarding a ' + risk.title + ' matter.\n\nUser ID: ' + currentUser + '\nDate/Time: ' + currentTime + '\n\nBrief Description:\n[Please describe your situation here]')}" 
           class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center">
            âœ‰ï¸ Email Consultant
        </a>
        <a href="tel:+61400211014" 
           class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center whitespace-nowrap">
            ðŸ“ž Call
        </a>
        <button onclick="openTool('scenarioAnalysis')" 
                class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-3 rounded text-sm transition-all whitespace-nowrap">
            ðŸŽ¯ Analyze
        </button>
    </div>
</div>

`;
}


// ========================================
// HR DOCUMENT TEMPLATES
// ========================================

const hrTemplates = {
            employmentContract: (data) => `
                <div class="header">
                    <h1>EMPLOYMENT CONTRACT</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <h2>Employment Details</h2>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position Title]'}</p>
                <p><strong>Start Date:</strong> ${data.startDate || '[Start Date]'}</p>
                <p><strong>Employment Type:</strong> ${data.employmentType || '[Full-time/Part-time/Casual]'}</p>
                <p><strong>Applicable Award:</strong> ${data.award || 'Hospitality Industry (General) Award'}</p>
                
                <h2>1. Position and Duties</h2>
                <p>${data.duties || '[Insert comprehensive list of key duties, responsibilities, and reporting lines]'}</p>
                
                <h2>2. Remuneration and Benefits</h2>
                <p><strong>Base Rate of Pay:</strong> ${data.baseRate || '[Rate]'} per ${data.payPeriod || 'hour'}</p>
                <p>Payment will be made ${data.paymentFrequency || 'fortnightly'} via direct deposit.</p>
                <p>In addition to the base rate, you will receive applicable penalty rates, loadings, and allowances as prescribed by the ${data.award || 'Hospitality Industry (General) Award'}.</p>
                
                <h2>3. Hours of Work</h2>
                <p>${data.hoursOfWork || '[Specify ordinary hours, roster arrangements, and any requirements for availability]'}</p>
                <p>Reasonable additional hours may be required from time to time, subject to the National Employment Standards.</p>
                
                <h2>4. Probationary Period</h2>
                <p>The first ${data.probationPeriod || '3 months'} of your employment will be considered a probationary period. During this time, your suitability for the role will be assessed. Either party may terminate employment during probation with ${data.probationNotice || '1 week\'s'} notice.</p>
                
                <h2>5. Leave Entitlements</h2>
                <p>You are entitled to leave in accordance with the National Employment Standards and the applicable Modern Award, including:</p>
                <ul>
                    <li>Annual leave (if applicable to employment type)</li>
                    <li>Personal/carer's leave</li>
                    <li>Compassionate and bereavement leave</li>
                    <li>Long service leave (after qualifying period)</li>
                    <li>Public holidays</li>
                </ul>
                
                <h2>6. Termination of Employment</h2>
                <p>Either party may terminate this employment by providing written notice as required by the National Employment Standards and the applicable Award.</p>
                
                <h2>7. Workplace Policies</h2>
                <p>You are required to comply with all workplace policies and procedures, including but not limited to workplace health and safety, equal opportunity, and code of conduct policies.</p>
                
                <div class="warning">
                    <strong>âš ï¸ IMPORTANT LEGAL NOTICE</strong>
                    <p>This employment contract template has been generated by Fitz AI and is provided for guidance purposes only.</p>
                    <p><strong>You MUST have this contract reviewed and customised by a Fitzgerald HR Senior Consultant or employment lawyer before use.</strong></p>
                    <p>This ensures compliance with all applicable laws, awards, and your specific circumstances.</p>
                    <p><strong>Contact:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
                
                <div style="margin-top: 50px;">
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p><strong>Employer Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
            `,
            
            warningLetter: (data) => `
                <div class="header">
                    <h1>WRITTEN WARNING</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <p><strong>Date:</strong> ${data.date || new Date().toLocaleDateString('en-AU')}</p>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position]'}</p>
                <p><strong>Employee ID:</strong> ${data.employeeId || '[Employee ID]'}</p>
                
                <h2>Subject: ${data.subject || 'Formal Written Warning'}</h2>
                
                <p>This letter serves as a formal written warning regarding ${data.issue || '[describe the issue or concern]'}.</p>
                
                <h2>Details of Incident/Issue</h2>
                <p><strong>Date(s) of Incident:</strong> ${data.incidentDate || '[Date(s)]'}</p>
                <p><strong>Description:</strong></p>
                <p>${data.description || '[Provide detailed, factual description of the incident, behaviour, or performance issue. Include specific examples, dates, times, and any witnesses if applicable]'}</p>
                
                <h2>Previous Discussions</h2>
                <p>${data.previousDiscussions || '[If applicable, note any prior verbal warnings or discussions about this matter, including dates]'}</p>
                
                <h2>Expected Standards and Behaviour</h2>
                <p>${data.expectations || '[Clearly outline the expected standards of conduct, performance, or behaviour moving forward. Reference relevant policies, position description, or award requirements]'}</p>
                
                <h2>Improvement Plan</h2>
                <p>${data.improvementPlan || '[Outline specific, measurable steps the employee must take to address the issue. Include timeframes and any support or resources available]'}</p>
                
                <h2>Consequences of Further Issues</h2>
                <p>Failure to meet these expectations and demonstrate sustained improvement may result in further disciplinary action, which may include:</p>
                <ul>
                    <li>A final written warning</li>
                    <li>Termination of employment</li>
                </ul>
                
                <h2>Support Available</h2>
                <p>${data.support || '[Outline any support, training, coaching, or resources available to help the employee improve. This demonstrates procedural fairness]'}</p>
                
                <h2>Right to Respond</h2>
                <p>You have the right to provide a written response to this warning within ${data.responseTimeframe || '7 days'}. Your response will be considered and placed on your employee file with this warning.</p>
                
                <p>This warning will remain on your employee file for ${data.warningDuration || '12 months'} from the date of this letter.</p>
                
                <div class="warning">
                    <strong>âš ï¸ CRITICAL LEGAL RISK</strong>
                    <p>Performance management and disciplinary processes involve significant legal risks if not handled correctly.</p>
                    <p><strong>This template MUST be reviewed by a Fitzgerald HR Senior Consultant before being issued to any employee.</strong></p>
                    <p>Incorrect process may result in unfair dismissal claims, general protections claims, or adverse action claims.</p>
                    <p><strong>Contact immediately:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
                
                <div style="margin-top: 40px;">
                    <p><strong>I acknowledge receipt of this written warning:</strong></p>
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;"><em>Signing this letter acknowledges receipt only and does not necessarily indicate agreement with its contents.</em></p>
                    <br/>
                    <p><strong>Manager/Supervisor Name:</strong> ${data.managerName || '[Manager Name]'}</p>
                    <p><strong>Manager Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
            `,
            
            performanceReview: (data) => `
                <div class="header">
                    <h1>PERFORMANCE REVIEW</h1>
                    <p>Fitzgerald HR - Professional HR Solutions</p>
                </div>
                
                <h2>Employee Information</h2>
                <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
                <p><strong>Position:</strong> ${data.position || '[Position]'}</p>
                <p><strong>Department/Location:</strong> ${data.department || '[Department]'}</p>
                <p><strong>Review Period:</strong> ${data.reviewPeriod || '[Start Date] to [End Date]'}</p>
                <p><strong>Review Date:</strong> ${data.reviewDate || new Date().toLocaleDateString('en-AU')}</p>
                <p><strong>Reviewer:</strong> ${data.reviewer || '[Manager/Supervisor Name]'}</p>
                
                <h2>Performance Summary</h2>
                <p>${data.summary || '[Provide an overall summary of the employee\'s performance during the review period. Consider achievements, challenges, growth, and overall contribution to the team and organisation]'}</p>
                
                <h2>Key Achievements and Successes</h2>
                <p>${data.achievements || '[List and describe significant achievements, successful projects, goals met or exceeded, positive contributions to team/workplace culture, and any special recognition received during the review period]'}</p>
                
                <h2>Core Competencies Assessment</h2>
                
                <h3>1. Job Knowledge and Skills</h3>
                <p>${data.jobKnowledge || '[Assess the employee\'s understanding of their role, technical skills, industry knowledge, and ability to perform required tasks]'}</p>
                
                <h3>2. Quality of Work</h3>
                <p>${data.qualityOfWork || '[Evaluate accuracy, attention to detail, consistency, and standard of work produced]'}</p>
                
                <h3>3. Productivity and Time Management</h3>
                <p>${data.productivity || '[Assess ability to meet deadlines, manage workload, prioritise tasks, and work efficiently]'}</p>
                
                <h3>4. Communication and Teamwork</h3>
                <p>${data.communication || '[Evaluate interpersonal skills, collaboration with colleagues, customer service, and contribution to team dynamics]'}</p>
                
                <h3>5. Initiative and Problem Solving</h3>
                <p>${data.initiative || '[Assess proactiveness, ability to identify and solve problems, willingness to take on new challenges]'}</p>
                
                <h3>6. Reliability and Attendance</h3>
                <p>${data.reliability || '[Review punctuality, attendance record, dependability, and adherence to rostering requirements]'}</p>
                
                <h2>Areas of Strength</h2>
                <p>${data.strengths || '[Identify specific areas where the employee excels. Be specific with examples]'}</p>
                
                <h2>Development Areas and Opportunities</h2>
                <p>${data.developmentAreas || '[Identify areas where improvement is needed or where the employee can further develop their skills. Frame constructively and with specific examples]'}</p>
                
                <h2>Goals and Objectives for Next Review Period</h2>
                <p>${data.goals || '[Set SMART goals (Specific, Measurable, Achievable, Relevant, Time-bound) for the upcoming review period. Align with both employee development and organisational objectives]'}</p>
                
                <h2>Training and Development Plan</h2>
                <p>${data.trainingPlan || '[Outline specific training, development opportunities, mentoring, or resources that will be provided to support the employee\'s growth and achievement of goals]'}</p>
                
                <h2>Career Progression Discussion</h2>
                <p>${data.careerDiscussion || '[If discussed, note any conversations about career aspirations, potential progression opportunities, or long-term development paths]'}</p>
                
                <h2>Overall Performance Rating</h2>
                <p><strong>Rating: ${data.rating || '[Exceeds Expectations / Meets Expectations / Needs Improvement / Unsatisfactory]'}</strong></p>
                
                <h2>Employee Comments</h2>
                <p>The employee has the opportunity to provide comments, feedback, or responses to this review:</p>
                <p>_________________________________________________________________________________</p>
                <p>_________________________________________________________________________________</p>
                <p>_________________________________________________________________________________</p>
                
                <div style="margin-top: 40px;">
                    <p><strong>Employee Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;"><em>Signature indicates that the review has been discussed with the employee, not necessarily agreement.</em></p>
                    <br/>
                    <p><strong>Reviewer Signature:</strong> _________________________ <strong>Date:</strong> __________</p>
                </div>
                
                <div class="warning">
                    <strong>âš ï¸ IMPORTANT NOTE</strong>
                    <p>This performance review template has been generated by Fitz AI for guidance purposes.</p>
                    <p>For best results and to ensure procedural fairness, consider having your performance review process and documentation reviewed by a Fitzgerald HR Senior Consultant.</p>
                    <p><strong>Contact:</strong> info@fitzgeraldhr.com.au | Fitzgerald HR</p>
                </div>
            `
        };

        // ========================================
        // DOCUMENT GENERATION FUNCTIONS
        // ========================================
        
        function formatContentForWord(content) {
    return content
        // Normalize line breaks
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        
        // Convert ## headers to proper HTML with Word styles
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        
        // REMOVE bold formatting - just strip the ** markers
        .replace(/\*\*(.+?)\*\*/g, '$1')
        
        // Convert *italic* to <em> (but not part of **)
        .replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>')
        
        // Convert bullet points (with proper spacing)
        .replace(/^[â€¢\-] (.+)$/gm, '<li style="margin-bottom: 8px;">$1</li>')
        
        // Convert underscores to underlined spans
        .replace(/_{5,}/g, '<span style="text-decoration: underline; display: inline-block; min-width: 200px;">$&</span>')
        
        // Split by double newlines to create paragraphs
        .split(/\n\n+/)
        .map(block => {
            block = block.trim();
            if (!block) return '';
            
            // If it's already an HTML element, return it
            if (block.startsWith('<h') || block.startsWith('<li>') || block.startsWith('<div')) {
                return block;
            }
            
            // Wrap list items in <ul> with proper styling
            if (block.includes('<li')) {
                return '<ul style="margin-top: 10px; margin-bottom: 15px; padding-left: 20px;">' + block + '</ul>';
            }
            
            // Convert single newlines to <br> within paragraphs
            block = block.replace(/\n/g, '<br>');
            
            // Wrap in paragraph with spacing
            return '<p style="margin-bottom: 12px; line-height: 1.6;">' + block + '</p>';
        })
        .join('\n');
}

function convertHTMLToPdfMake(html, metadata) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = [];

    const processNode = (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            if (text) {
                return { text: text };
            }
            return null;
        }

        if (node.nodeType !== Node.ELEMENT_NODE) return null;

        const tagName = node.tagName.toLowerCase();

        switch (tagName) {
            case 'h1':
                return {
                    text: node.textContent.trim(),
                    style: 'header1',
                    margin: [0, 15, 0, 10]
                };

            case 'h2':
                return {
                    text: node.textContent.trim(),
                    style: 'header2',
                    margin: [0, 12, 0, 6]
                };

            case 'h3':
                return {
                    text: node.textContent.trim(),
                    style: 'header3',
                    margin: [0, 10, 0, 5]
                };

            case 'p':
                const pContent = [];
                for (const child of node.childNodes) {
                    const processed = processInlineNode(child);
                    if (processed) {
                        if (Array.isArray(processed)) {
                            pContent.push(...processed);
                        } else {
                            pContent.push(processed);
                        }
                    }
                }
                return {
                    text: pContent.length > 0 ? pContent : node.textContent.trim(),
                    margin: [0, 0, 0, 8]  // Increased bottom margin
                };

            case 'ul':
                const listItems = [];
                for (const li of node.querySelectorAll('li')) {
                    listItems.push(li.textContent.trim());
                }
                return {
                    ul: listItems,
                    margin: [20, 5, 0, 10],  // Left indent + spacing
                    style: 'bulletList'
                };

            case 'li':
                return {
                    text: node.textContent.trim(),
                    margin: [0, 2, 0, 2]
                };

            case 'br':
                return { text: '', margin: [0, 5, 0, 0] };

            default:
                const children = [];
                for (const child of node.childNodes) {
                    const processed = processNode(child);
                    if (processed) children.push(processed);
                }
                return children.length > 0 ? children : null;
        }
    };

    const processInlineNode = (node) => {
    if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent.trim();
        return text ? { text: text } : null;
    }

    const tagName = node.tagName?.toLowerCase();
    const text = node.textContent.trim();

    if (!text) return null;

    switch (tagName) {
        case 'strong':
        case 'b':
            // REMOVE BOLD - just return normal text
            return { text: text };  // Removed the bold: true property
        case 'em':
        case 'i':
            return { text: text, italics: true };
        default:
            return { text: text };
    }
};

    // Process all body children
    for (const child of doc.body.childNodes) {
        const processed = processNode(child);
        if (processed) {
            if (Array.isArray(processed)) {
                content.push(...processed);
            } else {
                content.push(processed);
            }
        }
    }

    // Add footer
    content.push(
        { text: '', margin: [0, 30, 0, 0] },
        {
            canvas: [
                {
                    type: 'line',
                    x1: 0, y1: 0,
                    x2: 515, y2: 0,
                    lineWidth: 1,
                    lineColor: '#cccccc'
                }
            ],
            margin: [0, 0, 0, 10]
        },
        { text: 'FITZGERALD HR - AI-Powered Hospitality HR Solutions', bold: true, fontSize: 10, margin: [0, 0, 0, 4] },
        { text: 'Email: info@fitzgeraldhr.com.au', fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Generated: ${new Date().toLocaleDateString('en-AU')} at ${new Date().toLocaleTimeString('en-AU')}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: `Document ID: ${metadata.documentId || 'N/A'} | User: ${metadata.userName || currentUser}`, fontSize: 9, margin: [0, 0, 0, 3] },
        { text: 'For personalised advice and document review, contact our Senior Consultants.', fontSize: 9, italics: true, color: '#666666' }
    );

    // Define document with styles
    return {
        content: content,
        styles: {
            header1: {
                fontSize: 18,
                bold: true,
                color: '#E2A14A',
                decoration: 'underline',
                decorationColor: '#E2A14A'
            },
            header2: {
                fontSize: 14,
                bold: true,
                color: '#1E3A5F',
                margin: [0, 12, 0, 6]
            },
            header3: {
                fontSize: 12,
                bold: true,
                color: '#1E3A5F'
            },
            bulletList: {
                fontSize: 11,
                lineHeight: 1.4
            }
        },
        defaultStyle: {
            fontSize: 11,
            font: 'Roboto',
            lineHeight: 1.3
        },
        pageMargins: [40, 40, 40, 60]
    };
}



async function generatePDFDocument(content, filename = 'document.pdf', metadata = {}) {
    try {
        // Check if pdfMake is loaded
        if (typeof pdfMake === 'undefined') {
            showAlert('PDF library not loaded. Please refresh the page and try again.');
            return false;
        }

        // Convert content to HTML first
        const htmlContent = convertAIContentToHTML(content);
        
        // Parse HTML to pdfMake document definition
        const docDefinition = convertHTMLToPdfMake(htmlContent, metadata);
        
        // Generate PDF
        pdfMake.createPdf(docDefinition).download(filename);

        // Track document generation
        trackDocumentGeneration(filename, metadata);

        return true;

    } catch (error) {
        showAlert('Error generating PDF: ' + error.message);
        return false;
    }
}

        // [Removed: old detectDocumentType, extractDataFromConversation,
        //  addDocumentDownloadButtons, downloadDocument - replaced by later versions at ~line 11985]


// ========================================
// PDF GENERATION HELPER FUNCTIONS
// ========================================

function convertAIContentToHTML(rawContent) {
    let html = rawContent
        // Convert markdown headers to HTML
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        
        // REMOVE bold - just strip the ** markers
	.replace(/\*\*(.+?)\*\*/g, '$1')
        
        // Convert *italic* to <em>
        .replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>')
        
        // Convert bullet points
        .replace(/^[â€¢\-\*] (.+)$/gm, '<li>$1</li>')
        
        // Wrap consecutive list items in <ul>
        .replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$&</ul>')
        
        // Convert double line breaks to paragraph breaks
        .split('\n\n')
        .map(block => {
            block = block.trim();
            if (!block) return '';
            
            // Skip if already HTML element
            if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<div')) {
                return block;
            }
            
            // Convert single line breaks to <br>
            block = block.replace(/\n/g, '<br>');
            
            // Wrap in paragraph
            return '<p>' + block + '</p>';
        })
        .join('\n\n');
    
    return html;
}

// [Removed: duplicate convertHTMLToPdfMake - keeping first version with bulletList style]


// [Removed: empty generatePDFDocument stub - was overriding pdfMake version]


        function generatePDFDocumentPrintFallback(content, filename = 'document.pdf') {
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>${filename}</title>
    <style>
        @media print {
            body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20mm; font-size: 11pt; }
            h1 { color: #E2A14A; border-bottom: 3px solid #E2A14A; page-break-after: avoid; }
            h2 { color: #1E3A5F; page-break-after: avoid; margin-top: 20px; }
            .warning { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 15px; page-break-inside: avoid; }
            .no-print { display: none; }
            .header { text-align: center; margin-bottom: 20px; }
        }
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }
        h1 { color: #E2A14A; border-bottom: 3px solid #E2A14A; }
        h2 { color: #1E3A5F; margin-top: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .warning { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 20px; margin: 25px 0; }
        ul { margin-left: 20px; }
        li { margin-bottom: 8px; }
    

/* ========================================
   AI-POWERED IMPORT SYSTEM STYLES
   ======================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e27;
            --bg-card: #141b3d;
            --accent-primary: #00f0ff;
            --accent-secondary: #7b2ff7;
            --accent-success: #00ff9d;
            --accent-warning: #ff6b35;
            --text-primary: #ffffff;
            --text-secondary: #8b9dc3;
            --gradient-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--bg-dark);
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            top: -200px;
            right: -200px;
            animation: float 20s infinite ease-in-out;
        }

        .animated-bg::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(123, 47, 247, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            bottom: -100px;
            left: -100px;
            animation: float 15s infinite ease-in-out reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* Main Container */
        .import-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header with Glow Effect */
        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
            animation: fadeInUp 0.8s ease-out;
            letter-spacing: -2px;
        }

        .header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-radius: 100px;
            color: var(--accent-primary);
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.6); }
        }

        /* Upload Zone - Futuristic */
        .upload-zone {
            background: var(--bg-card);
            border: 2px dashed rgba(0, 240, 255, 0.3);
            border-radius: 24px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .upload-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 240, 255, 0.05);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0, 240, 255, 0.2);
        }

        .upload-icon {
            font-size: 6rem;
            margin-bottom: 24px;
            display: inline-block;
            animation: bounceIn 1s ease-out;
        }

        .upload-zone h3 {
            font-size: 1.75rem;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-bottom: 32px;
        }

        .supported-formats {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .format-badge {
            padding: 8px 16px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 8px;
            font-size: 0.875rem;
            font-family: 'Space Mono', monospace;
            color: var(--accent-primary);
        }

        /* AI Analysis Section */
        .ai-analysis {
            margin-top: 60px;
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .ai-analysis.active {
            display: block;
        }

        .analysis-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 240, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-accent);
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .analysis-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: var(--gradient-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            animation: rotateIn 0.6s ease-out;
        }

        .analysis-title {
            flex: 1;
        }

        .analysis-title h3 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .analysis-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* AI Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .insight-card {
            background: rgba(0, 240, 255, 0.05);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out both;
        }

        .insight-card:nth-child(1) { animation-delay: 0.1s; }
        .insight-card:nth-child(2) { animation-delay: 0.2s; }
        .insight-card:nth-child(3) { animation-delay: 0.3s; }
        .insight-card:nth-child(4) { animation-delay: 0.4s; }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 240, 255, 0.2);
            border-color: var(--accent-primary);
        }

        .insight-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            font-family: 'Space Mono', monospace;
        }

        .insight-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* AI Issues Detection */
        .issues-section {
            margin-top: 32px;
        }

        .issue-item {
            background: rgba(255, 107, 53, 0.1);
            border-left: 4px solid var(--accent-warning);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: start;
            gap: 16px;
            animation: slideInLeft 0.4s ease-out both;
        }

        .issue-item:nth-child(1) { animation-delay: 0.1s; }
        .issue-item:nth-child(2) { animation-delay: 0.2s; }
        .issue-item:nth-child(3) { animation-delay: 0.3s; }

        .issue-icon {
            font-size: 1.5rem;
        }

        .issue-content h4 {
            margin-bottom: 4px;
            color: var(--accent-warning);
        }

        .issue-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Success Items */
        .success-item {
            background: rgba(0, 255, 157, 0.1);
            border-left: 4px solid var(--accent-success);
        }

        .success-item .issue-content h4 {
            color: var(--accent-success);
        }

        /* Data Preview Table */
        .data-preview {
            margin-top: 32px;
            overflow: hidden;
            border-radius: 16px;
            border: 1px solid rgba(0, 240, 255, 0.2);
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th {
            background: rgba(0, 240, 255, 0.1);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
        }

        .data-preview td {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
        }

        .data-preview tr:hover td {
            background: rgba(0, 240, 255, 0.05);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 40px;
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        .btn {
            flex: 1;
            padding: 20px 40px;
            border-radius: 16px;
            font-size: 1.125rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-main);
            color: white;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Processing Animation */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            text-align: center;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(0, 240, 255, 0.1);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            margin: 0 auto 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .processing-subtext {
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-200deg) scale(0);
            }
            to {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    
</style>
</head>
<body>
<div class="animated-bg"></div>

    ${content}
    <div class="no-print" style="margin-top: 40px; text-align: center; padding: 20px; background: #f0f0f0; border-radius: 10px;">
        <p style="margin-bottom: 15px; font-size: 16px; color: #333;">Use your browser's print function and select "Save as PDF"</p>
        <button onclick="window.print()" style="padding: 12px 24px; font-size: 16px; background: #E2A14A; border: none; color: white; border-radius: 5px; cursor: pointer; margin-right: 10px;">Print / Save as PDF</button>
        <button onclick="window.close()" style="padding: 12px 24px; font-size: 16px; background: #666; border: none; color: white; border-radius: 5px; cursor: pointer;">Close</button>
    </div>
</body>
</html>`);
            
            printWindow.document.close();
            return true;
        }
        
        // ========================================
        // ADVANCED FEATURES
        // ========================================
        
        // 1. Document Metadata Tracking
        function trackDocumentGeneration(filename, metadata) {
            const documentLog = {
                filename: filename,
                user: currentUser,
                timestamp: new Date().toISOString(),
                ...metadata
            };
            
            // Store in localStorage for tracking
            const existingLogs = JSON.parse(localStorage.getItem('documentGenerationLogs') || '[]');
            existingLogs.push(documentLog);
            localStorage.setItem('documentGenerationLogs', JSON.stringify(existingLogs));
            
            // Also track as event
            trackEvent('document_generated', documentLog);
            
        }
        
        function generateDocumentId() {
            return 'DOC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

// ========================================
// DOCUMENT BUILDER SYSTEM
// ========================================

const documentBuilderState = {
    currentType: null,
    currentStep: 1,
    totalSteps: 0,
    data: {},
    generatedDocument: null,
    isGenerating: false,
    lastGeneratedDocId: null
};

// Document template configurations
const documentWizardSteps = {
formalWarning: [
    // âœ… STEP 1: Procedural Fairness Check
    {
        id: 1,
        title: "Procedural Fairness Checkpoint",
        fields: [
            { 
                name: "completedRecordOfDiscussion", 
                label: "Have you completed the Record of Discussion process? (i.e., held a documented conversation where allegations were presented and the employee was given the opportunity to respond)", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            }
        ]
    },
    // âœ… NEW STEP 2: Upload Record of Discussion (OPTIONAL BUT RECOMMENDED)
    {
        id: 2,
        title: "Upload Record of Discussion (Highly Recommended)",
        description: "Uploading your completed Record of Discussion will help Fitz AI create a more accurate and comprehensive Formal Warning letter by using the employee's actual responses and the specific details from your discussion.",
        fields: [
            {
                name: "rodUpload",
                label: "Upload your completed Record of Discussion",
                type: "file",
                accept: ".pdf,.docx,.doc,.png,.jpg,.jpeg",
                required: false,
                helpText: "Accepts: PDF, Word documents, or images of handwritten records"
            }
        ],
        showIf: { field: "completedRecordOfDiscussion", value: "Yes" }
    },
    // âœ… STEP 3: Meeting Preparation
    {
        id: 3,
        title: "Outcome Meeting Preparation - CRITICAL",
        fields: [
            { 
                name: "providedNotice24hours", 
                label: "Have you set up the outcome meeting and provided at least 24 hours notice?", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            },
            { 
                name: "offeredSupportPerson", 
                label: "Have you offered the employee the opportunity to have a support person present?", 
                type: "radio", 
                options: ["Yes", "No"], 
                required: true 
            }
        ]
    },
    // âœ… STEP 4: Employee Details (was Step 3)
    {
        id: 4,
        title: "Employee Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Blake Smith" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Chef" },
            { name: "employmentType", label: "Employment Type", type: "select", 
              options: ["Full-Time", "Part-Time", "Casual"], required: true }
        ]
    },
    // âœ… STEP 5: What Happened? (was Step 4)
    {
        id: 5,
        title: "What Happened?",
        fields: [
            { name: "issueDescription", label: "Briefly describe the issue", 
              type: "textarea", placeholder: "e.g., Repeatedly late for shifts", required: true, rows: 3 },
            { name: "issueDate", label: "When did this occur? (most recent)", type: "date", required: true },
            { name: "witnesses", label: "Any witnesses? (optional)", type: "text", required: false, placeholder: "Names of witnesses" }
        ]
    },
    // âœ… STEP 6: Previous Action (was Step 5)
    {
        id: 6,
        title: "Previous Action",
        fields: [
            { name: "hadVerbalWarnings", label: "Have you given verbal warnings?", 
              type: "radio", options: ["Yes", "No"], required: true },
            { name: "verbalWarningCount", label: "How many verbal warnings?", 
              type: "number", min: 1, max: 10, placeholder: "e.g., 3",
              showIf: { field: "hadVerbalWarnings", value: "Yes" } },
            { name: "warningLevel", label: "This warning is:", type: "select",
              options: ["First formal warning", "Second formal warning", "Final warning"], required: true }
        ]
    },
    // âœ… STEP 7: What Needs to Change? (was Step 6)
    {
        id: 7,
        title: "What Needs to Change?",
        fields: [
            { name: "expectations", label: "What specific improvements do you expect?", 
              type: "textarea", placeholder: "e.g., Arrive on time for all shifts", required: true, rows: 3 },
            { name: "timeframe", label: "Timeframe for improvement", type: "select",
              options: ["Immediate", "2 weeks", "1 month", "3 months"], required: true }
        ]
    },
    // âœ… STEP 8: Consequences (was Step 7)
    {
        id: 8,
        title: "Consequences",
        fields: [
            { name: "consequences", label: "What happens if behaviour continues?", 
              type: "textarea", placeholder: "e.g., Further disciplinary action up to and including termination", 
              required: true, rows: 2 }
        ]
    }
],
    recordOfDiscussion: [
    {
        id: 1,
        title: "Employee Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Waiter" }
        ]
    },
    {
        id: 2,
        title: "Meeting Preparation - CRITICAL",
        fields: [
            { name: "notice24hours", label: "Has employee been provided 24 hours notice of the meeting?", 
              type: "radio", options: ["Yes", "No"], required: true },
            { name: "supportPersonOffered", label: "Has employee been offered to bring a support person to the meeting?", 
              type: "radio", options: ["Yes", "No"], required: true }
        ]
    },
    {
        id: 3,
        title: "Issue Details",
        fields: [
            { name: "allegations", label: "What is/are the allegation(s)? (List them clearly)", 
              type: "textarea", required: true, rows: 4, 
              placeholder: "e.g., Late to shift on 3 occasions\nIncorrect uniform worn\nRude to customer" },
            { name: "witnesses", label: "Were there any witnesses?", 
              type: "text", required: false, placeholder: "Names of witnesses (if any)" }
        ]
    }
],

    formalProbationReview: [
    // STEP 1: Procedural Fairness
    {
        id: 1,
        title: "Procedural Fairness & Meeting Preparation",
        infoBox: {
            type: 'info',
            icon: 'âš–ï¸',
            title: 'Why Procedural Fairness Matters',
            content: `<p class="mb-2">A Formal Probation Review is a <strong>structured conversation</strong> to openly discuss whether the employee is meeting the requirements of the role during their probation period. To ensure fairness:</p>
            <ul class="list-disc pl-5 space-y-1 text-sm">
                <li>The employee must be given reasonable notice (at least 24 hours) that this meeting is taking place</li>
                <li>The purpose of the meeting must be clearly explained â€” this is a formal probation review</li>
                <li>The employee must be offered the right to bring a support person</li>
                <li>The conversation must be two-way â€” the employee must have a genuine opportunity to respond</li>
                <li>Any concerns raised must be specific, factual and supported by examples</li>
                <li>The employee must be offered support and a clear path to improvement</li>
                <li>Both parties retain a copy of the completed document</li>
            </ul>
            <p class="mt-2 text-amber-400 font-semibold text-sm">This is a development conversation with formal documentation, not a disciplinary meeting.</p>`
        },
        fields: [
            {
                name: "noticeGiven",
                label: "Has the employee been given at least 24 hours notice of this Formal Probation Review meeting?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            },
            {
                name: "purposeExplained",
                label: "Has the employee been told this is a Formal Probation Review to discuss their performance and suitability for the role?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            },
            {
                name: "supportPersonOffered",
                label: "Has the employee been advised they may bring a support person if they wish?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            }
        ]
    },
    // STEP 2: Probation Check-In Gate
    {
        id: 2,
        title: "Prior Probation Check-In Confirmation",
        infoBox: {
            type: 'warning',
            icon: 'âš ï¸',
            title: 'Important â€” Check-In Required Before This Step',
            content: `<p class="mb-2">Generally, <strong>at least one Probation Check-In Conversation</strong> should have occurred before a Formal Probation Review.</p>
            <p class="text-sm">The Probation Check-In is an informal, supportive conversation that documents early feedback and gives the employee an opportunity to adjust. Moving to a Formal Probation Review without a prior check-in may undermine procedural fairness.</p>
            <p class="mt-2 text-amber-400 font-semibold text-sm">If you haven't completed a Probation Check-In yet, you'll be directed to that tool first.</p>`
        },
        fields: [
            {
                name: "priorCheckInCompleted",
                label: "Has at least one Probation Check-In Conversation been completed with this employee before this Formal Review?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            }
        ]
    },
    // STEP 3: Employee & Probation Details
    {
        id: 3,
        title: "Employee & Probation Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Bartender" },
            { name: "peopleLeader", label: "People Leader / Manager conducting the review", type: "text", required: true, placeholder: "Your name" },
            { name: "meetingDate", label: "Meeting date", type: "date", required: true },
            { name: "employmentType", label: "Employment Type", type: "select",
              options: ["Full-Time", "Part-Time", "Casual"], required: true },
            { name: "startDate", label: "Employment start date", type: "date", required: true },
            { name: "probationEndDate", label: "Probation end date", type: "date", required: true }
        ]
    },
    // STEP 4: Previous Check-In Conversations
    {
        id: 4,
        title: "Previous Coaching & Check-In Conversations",
        infoBox: {
            type: 'tip',
            icon: 'ðŸ’¡',
            title: 'Document Prior Conversations',
            content: '<p>List all prior coaching conversations and/or Probation Check-Ins that have occurred. This establishes the history of support and feedback the employee has received.</p>'
        },
        fields: [
            { name: "checkInHistory", label: "List previous check-in/coaching conversations (date and brief overview of each)",
              type: "textarea", required: true, rows: 5,
              placeholder: "e.g.,\nâ€¢ 15 Jan 2026 â€” Informal catch-up: Discussed settling in, answered questions about rosters and POS system\nâ€¢ 29 Jan 2026 â€” Probation Check-In #1: Reviewed key requirements, identified speed of service as area for development, agreed to buddy shifts with senior staff\nâ€¢ 12 Feb 2026 â€” Ad hoc coaching: Discussed customer complaint regarding wait times, provided real-time feedback on section management" }
        ]
    },
    // STEP 5: Review of Performance â€” Strengths
    {
        id: 5,
        title: "Review of Performance â€” Strengths",
        infoBox: {
            type: 'tip',
            icon: 'âœ…',
            title: 'Acknowledge What Is Working',
            content: '<p>Discuss the areas of performance and/or behaviours that <strong>are</strong> currently meeting the required standards. Be specific and use examples â€” recognition motivates continued positive performance.</p>'
        },
        fields: [
            { name: "strengths", label: "What areas of performance and/or behaviour ARE currently meeting the required standards?",
              type: "textarea", required: true, rows: 4,
              placeholder: "e.g.,\nâ€¢ Punctuality and attendance have been excellent â€” no unexplained absences\nâ€¢ Positive attitude with guests â€” received two written compliments\nâ€¢ Follows WHS procedures consistently\nâ€¢ Works well with the team and communicates during service" },
            { name: "strengthsComments", label: "Additional comments on strengths (specific examples)",
              type: "textarea", required: false, rows: 3,
              placeholder: "e.g., Sarah has shown strong initiative in learning the wine list and regularly asks questions to improve her product knowledge." }
        ]
    },
    // STEP 6: Opportunities for Development
    {
        id: 6,
        title: "Opportunities for Development",
        infoBox: {
            type: 'info',
            icon: 'ðŸ“ˆ',
            title: 'Be Specific and Fair',
            content: '<p>Discuss the areas of performance and/or behaviours that are <strong>not</strong> currently meeting the required standards. Be specific with examples and dates. This is an opportunity for the employee to understand exactly what needs to change and to respond with their perspective.</p>'
        },
        fields: [
            { name: "developmentAreas", label: "What areas of performance and/or behaviour are NOT currently meeting the required standards?",
              type: "textarea", required: true, rows: 4,
              placeholder: "e.g.,\nâ€¢ Speed of service during peak periods â€” average table turn time is 15 mins above target\nâ€¢ Accuracy of orders â€” 3 incorrect orders in the past 2 weeks\nâ€¢ Needs to be more proactive seeking tasks during quiet periods rather than waiting to be directed" },
            { name: "developmentComments", label: "Additional comments on development areas (specific examples and context)",
              type: "textarea", required: false, rows: 3,
              placeholder: "e.g., On Friday 7 Feb, section turnaround during the 7pm rush took 25 minutes compared to the 10-minute target. Two tables received incorrect mains." },
            { name: "conductConcerns", label: "Are there any conduct or compliance concerns? (If yes, describe)",
              type: "textarea", required: false, rows: 2,
              placeholder: "e.g., No conduct or compliance concerns at this time. OR: One instance of incorrect uniform on 3 Feb â€” addressed verbally at the time." }
        ]
    },
    // STEP 7: Action Plan
    {
        id: 7,
        title: "Action Plan â€” Agreed Actions",
        infoBox: {
            type: 'tip',
            icon: 'ðŸŽ¯',
            title: 'Focus on Actions and Outcomes',
            content: '<p>The most effective Action Plans focus on <strong>behaviours and actions</strong> (inputs) rather than just metrics and outcomes (outputs). Include agreed actions for <strong>both</strong> the employee and the leader â€” probation is a two-way street.</p>'
        },
        fields: [
            { name: "agreedActions", label: "Agreed actions to improve performance â€” what specifically will be done, by whom, and by when?",
              type: "textarea", required: true, rows: 5,
              placeholder: "e.g.,\nEmployee:\nâ€¢ Focus on speed of service during Friday/Saturday peaks â€” aim for 10-min table turns\nâ€¢ Double-check all orders before sending to kitchen\nâ€¢ Proactively ask supervisor for tasks during quiet periods\n\nLeader:\nâ€¢ Arrange buddy shifts with Senior Waiter (James) for next 2 weeks\nâ€¢ Provide real-time coaching during Friday/Saturday peak services\nâ€¢ Continue fortnightly check-ins to review progress" },
            { name: "trainingAndSupport", label: "What additional training or support will be provided?",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nâ€¢ Advanced POS refresher training (split bills, modifications) â€” scheduled Week of 17 Feb\nâ€¢ Shadow senior staff during 2 weekend peak shifts\nâ€¢ Menu knowledge quiz to build confidence" },
            { name: "nextReviewDate", label: "When will the next review take place to assess progress?", type: "date", required: true }
        ]
    },
    // STEP 8: Employee Feedback & Key Messages
    {
        id: 8,
        title: "Employee Feedback & Key Messages",
        infoBox: {
            type: 'info',
            icon: 'ðŸ’¬',
            title: 'The Employee\'s Voice Matters',
            content: '<p>This section captures the employee\'s self-assessment and any barriers they\'re facing. It also sets out the key messages that should be clearly communicated during the meeting. The AI will generate these based on the information you\'ve provided.</p>'
        },
        fields: [
            { name: "employeeSelfAssessment", label: "Employee's comments/feedback â€” how do they feel they are performing? Any barriers or support needed?",
              type: "textarea", required: false, rows: 4,
              placeholder: "Leave blank if you want to complete this section during the meeting with the employee. Or pre-fill with anything they've already communicated.\n\ne.g., Employee feels they are settling in well but finds Friday nights overwhelming. Would like more guidance on handling large party bookings." },
            { name: "overallOutcome", label: "What is the overall outcome of this Formal Probation Review?", type: "select",
              options: [
                "On track â€” employee is meeting expectations, continue to support",
                "On track with development areas â€” minor concerns addressed with clear action plan",
                "At risk â€” significant concerns raised, improvement required within clear timeframe",
                "Recommend extending probation period (if applicable)",
                "Recommend confirming employment â€” probation passed",
                "Recommend ending employment during probation"
              ],
              required: true },
            { name: "additionalNotes", label: "Any additional notes or context for the AI to consider?",
              type: "textarea", required: false, rows: 2 }
        ]
    }
],

    performanceImprovementPlan: [
        // Step 1: Employee Details
        {
            id: 1,
            title: "Employee Details",
            fields: [
                { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
                { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Waiter" },
                { name: "employmentType", label: "Employment Type", type: "select", 
                  options: ["Full-Time", "Part-Time", "Casual"], required: true },
                { name: "managerName", label: "Manager/Supervisor Name", type: "text", required: true, placeholder: "Your name" }
            ]
        },
        
        // Step 2: Performance Issues (Data-Driven)
        {
            id: 2,
            title: "Performance Issues - Be Specific",
            fields: [
                { name: "performanceIssue1", label: "Issue #1 - What specific performance problem?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Slow service - average drink prep time is 4 minutes vs team average of 2.5 minutes" },
                { name: "performanceData1", label: "What data/evidence supports this?", 
                  type: "textarea", required: true, rows: 2,
                  placeholder: "e.g., Till data shows 12 customer complaints in last month about wait times. Guest review average 2.8/5 stars." },
                { name: "performanceIssue2", label: "Issue #2 (optional)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Order accuracy errors - 15% error rate vs team average of 3%" },
                { name: "performanceData2", label: "Data/evidence for Issue #2", 
                  type: "textarea", required: false, rows: 2,
                  placeholder: "e.g., POS system shows 18 incorrect orders in last 2 weeks" }
            ]
        },
        
        // Step 3: SMART Goals
        {
            id: 3,
            title: "SMART Goals - What Must Improve?",
            fields: [
                { name: "goal1", label: "Goal #1 (Specific, Measurable, Achievable, Relevant, Time-bound)", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Reduce average drink preparation time from 4 minutes to 2.5 minutes within 4 weeks" },
                { name: "goal2", label: "Goal #2 (if applicable)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Achieve order accuracy of 97% or higher (max 1 error per 30 orders) within 8 weeks" },
                { name: "goal3", label: "Goal #3 (if applicable)", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "e.g., Improve guest satisfaction score to 4.2/5 or higher within 12 weeks" }
            ]
        },
        
        // Step 4: Action Plan & Support
        {
            id: 4,
            title: "Action Plan - How Will We Help Them Improve?",
            fields: [
                { name: "trainingProvided", label: "What training/coaching will be provided?", 
                  type: "textarea", required: true, rows: 4,
                  placeholder: "e.g., \nâ€¢ 2-hour cocktail making refresher course (Week 1)\nâ€¢ Shadow experienced bartender for 3 shifts (Week 2)\nâ€¢ Daily 15-min coaching sessions with supervisor (Weeks 1-4)\nâ€¢ Access to online mixology tutorials" },
                { name: "resourcesProvided", label: "What resources/tools will be provided?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Recipe cards, speed pouring practice kit, timer for self-monitoring" },
                { name: "managerSupport", label: "What will the manager/supervisor do to support?", 
                  type: "textarea", required: true, rows: 3,
                  placeholder: "e.g., Weekly one-on-one check-ins, real-time feedback during shifts, track progress data" }
            ]
        },
        
        // Step 5: Employee Responsibilities
        {
            id: 5,
            title: "Employee Responsibilities",
            fields: [
                { name: "employeeActions", label: "What is the employee expected to do?", 
                  type: "textarea", required: true, rows: 4,
                  placeholder: "e.g., \nâ€¢ Attend all scheduled training sessions\nâ€¢ Practice drink preparation techniques during quiet periods\nâ€¢ Review recipe cards before each shift\nâ€¢ Ask for help when unsure\nâ€¢ Track own times and report progress weekly" }
            ]
        },
        
        // Step 6: Review Schedule
        {
            id: 6,
            title: "Review Schedule & Timeline",
            fields: [
                { name: "pipStartDate", label: "PIP Start Date", type: "date", required: true },
                { name: "weeklyCheckins", label: "Weekly check-in day/time", type: "text", required: true, 
                  placeholder: "e.g., Every Monday at 10am" },
                { name: "week4ReviewDate", label: "Week 4 Formal Review Date", type: "date", required: true },
                { name: "week8ReviewDate", label: "Week 8 Formal Review Date", type: "date", required: true },
                { name: "week12ReviewDate", label: "Week 12 Final Review Date", type: "date", required: true }
            ]
        },
        
        // Step 7: Consequences
        {
            id: 7,
            title: "Consequences - What Happens If No Improvement?",
            fields: [
                { name: "week4Consequence", label: "If no significant improvement by Week 4:", 
                  type: "select", required: true,
                  options: ["First Formal Warning for Performance", "Extend PIP by 4 weeks with modified goals", "Other (specify in notes)"] },
                { name: "week8Consequence", label: "If no significant improvement by Week 8:", 
                  type: "select", required: true,
                  options: ["Second Formal Warning for Performance", "Final Written Warning", "Other (specify in notes)"] },
                { name: "week12Consequence", label: "If no significant improvement by Week 12:", 
                  type: "select", required: true,
                  options: ["Termination of employment", "Demotion to different role", "Extended PIP (only if substantial progress made)", "Other (specify in notes)"] },
                { name: "consequenceNotes", label: "Additional notes on consequences (optional)", 
                  type: "textarea", required: false, rows: 2 }
            ]
        },
        
        // Step 8: Final Confirmation
        {
            id: 8,
            title: "Final Confirmation",
            fields: [
                { name: "pipDiscussed", label: "Have you discussed this PIP with the employee before creating it?", 
                  type: "radio", options: ["Yes - we've had a preliminary discussion", "No - this is the first formal step"], required: true },
                { name: "supportPersonOffered", label: "Will you offer the employee the right to have a support person when presenting the PIP?", 
                  type: "radio", options: ["Yes", "No"], required: true },
                { name: "additionalNotes", label: "Any additional notes or context?", 
                  type: "textarea", required: false, rows: 3,
                  placeholder: "Optional: Any other relevant information" }
            ]
        }
    ],

    letterOfAllegation: [
        {
            id: 1,
            title: "Employee Details",
            fields: [
                { name: "employeeName", label: "Employee's full name", type: "text", required: true },
                { name: "position", label: "Position/Role", type: "text", required: true },
                { name: "employmentType", label: "Employment Type", type: "select", 
                  options: ["Full-Time", "Part-Time", "Casual"], required: true }
            ]
        },
        {
            id: 2,
            title: "Meeting Preparation - CRITICAL",
            fields: [
                { 
                    name: "notice24hours", 
                    label: "Has employee been provided 24 hours notice of the meeting?", 
                    type: "radio", 
                    options: ["Yes", "No"], 
                    required: true 
                },
                { 
                    name: "supportPersonOffered", 
                    label: "Has employee been offered to bring a support person to the meeting?", 
                    type: "radio", 
                    options: ["Yes", "No"], 
                    required: true 
                }
            ]
        },
        {
            id: 3,
            title: "Allegation Details",
            fields: [
                { name: "allegationType", label: "Type of allegation", type: "select",
                  options: ["Theft", "Harassment", "Bullying", "Serious safety breach", "Fraud", "Violence/threats", "Other serious misconduct"],
                  required: true },
                { name: "allegationDescription", label: "Describe the allegation", 
                  type: "textarea", required: true, rows: 4, 
                  placeholder: "What specifically is alleged to have occurred?" },
                { name: "incidentDate", label: "Date of alleged incident", type: "date", required: true }
            ]
        },
        {
            id: 4,
            title: "Source & Evidence",
            fields: [
                { name: "allegationSource", label: "Who made the allegation?", type: "select",
                  options: ["Anonymous complaint", "Named complainant", "Management observed", "Multiple witnesses"],
                  required: true },
                { name: "evidenceExists", label: "What evidence exists?", 
                  type: "textarea", required: false, rows: 2,
                  placeholder: "e.g., Witness statements, CCTV, documents" }
            ]
        },
        {
            id: 5,
            title: "Investigation Process",
            fields: [
                { name: "investigator", label: "Who will conduct the investigation?", type: "text",
                  required: true, placeholder: "e.g., HR Manager, External investigator" },
                { name: "suspensionRequired", label: "Suspension during investigation?", type: "select",
                  options: ["No suspension - continue work", "Yes - on full pay", "Yes - without pay (serious misconduct only)"],
                  required: true }
            ]
        },
        {
            id: 6,
            title: "Investigation Meeting",
            fields: [
                { name: "meetingDate", label: "Meeting date", type: "date", required: true },
                { name: "meetingTime", label: "Meeting time", type: "time", required: true },
                { name: "meetingLocation", label: "Meeting location", type: "text", required: true }
            ]
        }
    ]
};

function selectDocumentType(type) {
    documentBuilderState.currentType = type;
    documentBuilderState.currentStep = 1;
    documentBuilderState.data = {};
    documentBuilderState.totalSteps = documentWizardSteps[type].length;
    
    // Hide template selection
    document.getElementById('documentTemplateSelection').classList.add('hidden');
    
    // Show wizard
    document.getElementById('documentWizardSteps').classList.remove('hidden');
    
    // Update total steps
    document.getElementById('docTotalSteps').textContent = documentBuilderState.totalSteps;
    
    // Show first step
    showDocumentStep(1);
    
    trackEvent('document_type_selected', { user: currentUser, type: type });
}

function showDocumentStep(stepNumber) {
    const steps = documentWizardSteps[documentBuilderState.currentType];
    const step = steps[stepNumber - 1];
    
    if (!step) return;
    
    // Update progress
    document.getElementById('docCurrentStep').textContent = stepNumber;
    const progress = Math.round((stepNumber / documentBuilderState.totalSteps) * 100);
    document.getElementById('docProgress').textContent = `${progress}% Complete`;
    document.getElementById('docProgressBar').style.width = `${progress}%`;
    
    // Build step HTML
    let html = `<h3 class="text-xl font-bold text-white mb-4">${step.title}</h3>`;
    
    // Render infoBox if present
    if (step.infoBox) {
        const box = step.infoBox;
        const bgColor = box.type === 'warning' ? 'bg-amber-500/10 border-amber-500' : 
                         box.type === 'tip' ? 'bg-blue-500/10 border-blue-500' : 
                         'bg-teal-500/10 border-teal-500';
        const textColor = box.type === 'warning' ? 'text-amber-400' : 
                          box.type === 'tip' ? 'text-blue-400' : 
                          'text-teal-400';
        html += `<div class="mb-4 p-4 ${bgColor} border rounded-lg">
            <p class="${textColor} font-bold text-sm flex items-center gap-2 mb-2">
                <span>${box.icon}</span> ${box.title}
            </p>
            <div class="text-slate-300 text-sm">${box.content}</div>
        </div>`;
    }
    
    html += `<div class="space-y-4">`;
    
    step.fields.forEach(field => {
        // Check conditional display
        if (field.showIf) {
            const conditionField = field.showIf.field;
            const conditionValue = field.showIf.value;
            if (documentBuilderState.data[conditionField] !== conditionValue) {
                return; // Skip this field
            }
        }
        
        html += `<div>`;
        html += `<label class="block text-slate-300 text-sm mb-2">
                    ${field.label}${field.required ? ' <span class="text-red-400">*</span>' : ''}
                 </label>`;
        
        if (field.type === 'text') {
            html += `<input type="text" id="field_${field.name}" 
                           placeholder="${field.placeholder || ''}"
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="field_${field.name}" rows="${field.rows || 3}"
                              placeholder="${field.placeholder || ''}"
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                              ${field.required ? 'required' : ''}>${documentBuilderState.data[field.name] || ''}</textarea>`;
        } else if (field.type === 'select') {
            html += `<select id="field_${field.name}" 
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                            ${field.required ? 'required' : ''}>
                        <option value="">Select...</option>`;
            field.options.forEach(opt => {
                const selected = documentBuilderState.data[field.name] === opt ? 'selected' : '';
                html += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            html += `</select>`;
        } else if (field.type === 'radio') {
            field.options.forEach(opt => {
                const checked = documentBuilderState.data[field.name] === opt ? 'checked' : '';
                html += `<label class="flex items-center gap-2 text-slate-300 mb-2">
                            <input type="radio" name="field_${field.name}" value="${opt}" ${checked}
                                   class="text-amber-500">
                            <span>${opt}</span>
                         </label>`;
            });
        } else if (field.type === 'date') {
            const today = new Date().toISOString().split('T')[0];
            html += `<input type="date" id="field_${field.name}" 
                           value="${documentBuilderState.data[field.name] || today}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'time') {
            html += `<input type="time" id="field_${field.name}" 
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'number') {
            html += `<input type="number" id="field_${field.name}" 
                           min="${field.min || 0}" max="${field.max || 100}"
                           placeholder="${field.placeholder || ''}"
                           value="${documentBuilderState.data[field.name] || ''}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'file') {
            // File upload for ROD
            html += `
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
                    <p class="text-blue-300 text-sm mb-3">
                        <strong>ðŸ’¡ Highly Recommended:</strong> Uploading your Record of Discussion helps Fitz AI create a better warning letter by using the employee's actual responses and discussion details.
                    </p>
                </div>
                <div class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center hover:border-amber-500 transition-colors">
                    <input type="file" id="field_${field.name}" 
                           accept="${field.accept || '*'}"
                           class="hidden"
                           onchange="handleRODUpload(event)">
                    <button type="button" onclick="document.getElementById('field_${field.name}').click()"
                            class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold px-6 py-3 rounded-lg mb-3">
                        ðŸ“„ Upload File
                    </button>
                    <p class="text-slate-400 text-sm">${field.helpText || 'Click to select a file'}</p>
                    <div id="rodUploadStatus" class="mt-3"></div>
                </div>
                <div class="flex justify-center mt-4">
                    <button type="button" onclick="confirmSkipRODUpload()"
                            class="text-slate-400 hover:text-white text-sm underline">
                        Skip this step
                    </button>
                </div>
            `;
        }
        
        html += `</div>`;
    });
    
    html += `</div>`;
    
    document.getElementById('documentStepContent').innerHTML = html;
    
    // Show/hide back button
    document.getElementById('docBackBtn').style.display = stepNumber > 1 ? 'block' : 'none';
    
    // Update next button text
    const nextBtn = document.getElementById('docNextBtn');
    if (stepNumber === documentBuilderState.totalSteps) {
        nextBtn.innerHTML = 'âœ¨ Generate Document';
    } else {
        nextBtn.innerHTML = 'Next Step â†’';
    }

// Show/hide start over button based on step
const startOverBtn = document.getElementById('docStartOverBtn');
if (startOverBtn) {
    if (stepNumber > 1) {
        startOverBtn.classList.remove('hidden');
    } else {
        startOverBtn.classList.add('hidden');
    }
}

}

// Handle ROD file upload
var rodUploadedFile = null;
var rodExtractedData = null;

async function handleRODUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show uploading status
    const statusDiv = document.getElementById('rodUploadStatus');
    statusDiv.innerHTML = '<p class="text-blue-400">ðŸ“¤ Processing file...</p>';
    
    try {
        // Read file
        const fileData = await readFileAsBase64(file);
        rodUploadedFile = {
            name: file.name,
            type: file.type,
            data: fileData
        };
        
        // Extract text/data from file
        const extractedText = await extractRODContent(file);
        
        // Show success
        statusDiv.innerHTML = `
            <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-3">
                <p class="text-green-400 font-semibold">âœ… Record uploaded - Fitz AI will use this context</p>
                <p class="text-slate-300 text-sm mt-1">${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
            </div>
        `;
        
        // Store in documentBuilderState
        documentBuilderState.data.rodUpload = true;
        documentBuilderState.data.rodFileName = file.name;
        documentBuilderState.data.rodFileData = fileData;
        documentBuilderState.data.rodExtractedText = extractedText;
        
        showToast('âœ… Record of Discussion uploaded successfully!', 'success', 3000);
        
    } catch (error) {
        statusDiv.innerHTML = '<p class="text-red-400">âŒ Error processing file. Please try again.</p>';
        showToast('Error processing file', 'error', 3000);
    }
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function extractRODContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const fileName = file.name.toLowerCase();
            let text = '';
            
            if (fileName.endsWith('.txt')) {
                text = e.target.result;
            } else if (fileName.endsWith('.csv')) {
                text = e.target.result;
            } else {
                // For PDF, Word, Images - placeholder text
                text = `File: ${file.name}\nType: ${file.type}\nSize: ${(file.size / 1024).toFixed(2)} KB\n\n`;
                text += '[Document uploaded for AI analysis]';
            }
            
            resolve(text);
        };
        
        reader.onerror = reject;
        
        if (file.name.toLowerCase().endsWith('.txt') || file.name.toLowerCase().endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}

function confirmSkipRODUpload() {
    const confirmed = confirm(
        'âš ï¸ Skip Upload?\n\n' +
        'For a better Formal Warning letter, uploading your completed Record of Discussion is strongly advised.\n\n' +
        'The ROD provides:\n' +
        'â€¢ Employee\'s actual responses\n' +
        'â€¢ Specific details from the discussion\n' +
        'â€¢ Better context for the warning letter\n\n' +
        'Are you sure you want to skip this step?'
    );
    
    if (confirmed) {
        // Mark as skipped
        documentBuilderState.data.rodUpload = false;
        documentBuilderState.data.rodSkipped = true;
        
        // Move to next step
        documentBuilderState.currentStep++;
        showDocumentStep(documentBuilderState.currentStep);
    }
}

function docWizardNext() {
    // Save current step data
    const steps = documentWizardSteps[documentBuilderState.currentType];
    const step = steps[documentBuilderState.currentStep - 1];
    
    let allValid = true;
    
    step.fields.forEach(field => {
        // Skip if conditional and not shown
        if (field.showIf) {
            const conditionField = field.showIf.field;
            const conditionValue = field.showIf.value;
            if (documentBuilderState.data[conditionField] !== conditionValue) {
                return;
            }
        }
        
        let value;
        if (field.type === 'radio') {
            const radio = document.querySelector(`input[name="field_${field.name}"]:checked`);
            value = radio ? radio.value : '';
        } else if (field.type === 'file') {
            // File upload is optional - check if uploaded or skipped
            value = documentBuilderState.data[field.name] || '';
            // Don't require validation for file type
            return; // Skip validation for file field
        } else {
            const element = document.getElementById(`field_${field.name}`);
            value = element ? element.value.trim() : '';
        }
        
        if (field.required && !value) {
            allValid = false;
            showAlert(`Please fill in: ${field.label}`);
        }
        
        documentBuilderState.data[field.name] = value;
    });
    
    if (!allValid) return;
    
    // âœ… VALIDATION FOR FORMAL WARNING
    if (documentBuilderState.currentType === 'formalWarning') {
        if (!validateFormalWarningProceduralFairness()) {
            return;
        }
    }
    
    // âœ… VALIDATION FOR LETTER OF ALLEGATION
    if (documentBuilderState.currentType === 'letterOfAllegation') {
        if (!validateLetterOfAllegationMeetingPrep()) {
            return;
        }
    }
    
    // âœ… VALIDATION FOR RECORD OF DISCUSSION
    if (documentBuilderState.currentType === 'recordOfDiscussion' && documentBuilderState.currentStep === 2) {
        if (!validateRecordOfDiscussionStep2()) {
            return;
        }
    }
    
    // âœ… VALIDATION FOR FORMAL PROBATION REVIEW
    if (documentBuilderState.currentType === 'formalProbationReview') {
        if (!validateFormalProbationReview()) {
            return;
        }
    }
    
    // Move to next step or generate
    if (documentBuilderState.currentStep < documentBuilderState.totalSteps) {
        documentBuilderState.currentStep++;
        showDocumentStep(documentBuilderState.currentStep);
    } else {
        // All steps complete - generate document
        generateDocumentWithAI();
    }
}


function validateFormalWarningProceduralFairness() {
    // Only validate on Step 1 and Step 2
    if (documentBuilderState.currentStep === 1) {
        const completedROD = documentBuilderState.data.completedRecordOfDiscussion;
        
        if (completedROD === 'No') {
            showAlert(
                'âš ï¸ PROCEDURAL FAIRNESS REQUIRED\n\n' +
                'You MUST complete the Record of Discussion process before issuing a Formal Warning.\n\n' +
                'This means:\n' +
                '1. Hold a documented conversation with the employee\n' +
                '2. Present the allegations/concerns\n' +
                '3. Give the employee the opportunity to respond\n' +
                '4. Document their response\n\n' +
                'Without this step, a Formal Warning may be deemed procedurally unfair.\n\n' +
                'Please complete the Record of Discussion first.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: 'rod_not_completed',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.completedRecordOfDiscussion = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        return true;
    }
    
    if (documentBuilderState.currentStep === 2) {
        const providedNotice = documentBuilderState.data.providedNotice24hours;
        const offeredSupport = documentBuilderState.data.offeredSupportPerson;
        
        if (providedNotice === 'No') {
            showAlert(
                'âš ï¸ IMPORTANT: You must provide the employee with 24 hours notice before the outcome meeting.\n\n' +
                'This is a requirement of procedural fairness.\n\n' +
                'Please schedule the outcome meeting for at least 24 hours from now before continuing.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: '24_hour_notice_not_provided',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.providedNotice24hours = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        if (offeredSupport === 'No') {
            showAlert(
                'âš ï¸ IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
                'A support person can be:\n' +
                'â€¢ A family member or friend\n' +
                'â€¢ A union representative\n' +
                'â€¢ A fellow employee (if appropriate)\n\n' +
                'Please inform the employee of this right before continuing.'
            );
            
            trackEvent('procedural_fairness_violation', {
                user: currentUser,
                violation: 'support_person_not_offered',
                documentType: 'formalWarning'
            });
            
            documentBuilderState.data.offeredSupportPerson = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        return true;
    }
    
    return true;
}

function validateLetterOfAllegationMeetingPrep() {
    // Only validate on Step 2 (Meeting Preparation)
    if (documentBuilderState.currentStep !== 2) {
        return true;
    }
    
    const notice24hours = documentBuilderState.data.notice24hours;
    const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
    
    // Check 24 hours notice
    if (notice24hours === 'No') {
        showAlert(
            'âš ï¸ IMPORTANT: You must provide the employee with 24 hours notice before the meeting.\n\n' +
            'This is a requirement of procedural fairness.\n\n' +
            'Please schedule the meeting for at least 24 hours from now before continuing.'
        );
        
        trackEvent('procedural_fairness_violation', {
            user: currentUser,
            violation: '24_hour_notice_not_provided',
            documentType: 'letterOfAllegation'
        });
        
        // Clear the answer so they can correct it
        documentBuilderState.data.notice24hours = '';
        
        // Re-render the current step
        showDocumentStep(documentBuilderState.currentStep);
        
        return false;
    }
    
    // Check support person offered
    if (supportPersonOffered === 'No') {
        showAlert(
            'âš ï¸ IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
            'A support person can be:\n' +
            'â€¢ A family member or friend\n' +
            'â€¢ A union representative\n' +
            'â€¢ A fellow employee (if appropriate and no conflict of interest)\n\n' +
            'Please inform the employee of this right before continuing.'
        );
        
        trackEvent('procedural_fairness_violation', {
            user: currentUser,
            violation: 'support_person_not_offered',
            documentType: 'letterOfAllegation'
        });
        
        // Clear the answer so they can correct it
        documentBuilderState.data.supportPersonOffered = '';
        
        // Re-render the current step
        showDocumentStep(documentBuilderState.currentStep);
        
        return false;
    }
    
    return true; // Both checks passed
}

function validateRecordOfDiscussionStep2() {
    const notice24hours = documentBuilderState.data.notice24hours;
    const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
    
    // Check 24 hours notice
    if (notice24hours === 'No') {
        showAlert('âš ï¸ IMPORTANT: You must provide the employee with 24 hours notice before the meeting.\n\n' +
              'This is a requirement of procedural fairness.\n\n' +
              'Please schedule the meeting for at least 24 hours from now before continuing.');
        return false;
    }
    
    // Check support person
    if (supportPersonOffered === 'No') {
        showAlert('âš ï¸ IMPORTANT: You must offer the employee the right to bring a support person.\n\n' +
              'A support person can be:\n' +
              'â€¢ A family member or friend\n' +
              'â€¢ A union representative\n' +
              'â€¢ A fellow employee (if appropriate and no conflict of interest)\n\n' +
              'Please inform the employee of this right before continuing.');
        return false;
    }
    
    return true;
}

// âœ… VALIDATION FOR FORMAL PROBATION REVIEW
function validateFormalProbationReview() {
    // Step 1: Procedural Fairness
    if (documentBuilderState.currentStep === 1) {
        const noticeGiven = documentBuilderState.data.noticeGiven;
        const purposeExplained = documentBuilderState.data.purposeExplained;
        const supportPersonOffered = documentBuilderState.data.supportPersonOffered;
        
        if (noticeGiven === 'No') {
            showAlert(
                'âš ï¸ PROCEDURAL FAIRNESS REQUIRED\n\n' +
                'You must provide the employee with at least 24 hours notice of this Formal Probation Review meeting.\n\n' +
                'This is a requirement of procedural fairness.\n\n' +
                'Please schedule the meeting for at least 24 hours from now before continuing.'
            );
            documentBuilderState.data.noticeGiven = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        if (purposeExplained === 'No') {
            showAlert(
                'âš ï¸ PROCEDURAL FAIRNESS REQUIRED\n\n' +
                'The employee must be told the purpose of this meeting before it takes place.\n\n' +
                'They need to know this is a Formal Probation Review so they can:\n' +
                'â€¢ Prepare their own reflections\n' +
                'â€¢ Arrange a support person if desired\n' +
                'â€¢ Gather any relevant information\n\n' +
                'Please inform the employee of the meeting purpose before continuing.'
            );
            documentBuilderState.data.purposeExplained = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        if (supportPersonOffered === 'No') {
            showAlert(
                'âš ï¸ PROCEDURAL FAIRNESS REQUIRED\n\n' +
                'You must offer the employee the right to bring a support person.\n\n' +
                'A support person can be:\n' +
                'â€¢ A family member or friend\n' +
                'â€¢ A union representative\n' +
                'â€¢ A fellow employee (if appropriate)\n\n' +
                'Please inform the employee of this right before continuing.'
            );
            documentBuilderState.data.supportPersonOffered = '';
            showDocumentStep(documentBuilderState.currentStep);
            return false;
        }
        
        return true;
    }
    
    // Step 2: Prior Probation Check-In Gate
    if (documentBuilderState.currentStep === 2) {
        const priorCheckIn = documentBuilderState.data.priorCheckInCompleted;
        
        if (priorCheckIn === 'No') {
            // Show popup with link to Probation Check-In tool
            showProbationCheckInRequiredPopup();
            return false;
        }
        
        return true;
    }
    
    return true;
}

// Popup when user hasn't completed a Probation Check-In
function showProbationCheckInRequiredPopup() {
    // Create modal overlay
    const popup = document.createElement('div');
    popup.id = 'probationCheckInRequiredPopup';
    popup.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-[60]';
    popup.innerHTML = `
        <div class="bg-slate-800 rounded-2xl p-8 max-w-lg w-full border-2 border-amber-500 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-bold text-amber-400 mb-2">Probation Check-In Required</h3>
                <p class="text-slate-300 text-sm leading-relaxed">
                    Generally, at least one <strong class="text-white">Probation Check-In Conversation</strong> should be completed before conducting a Formal Probation Review.
                </p>
            </div>
            
            <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-6">
                <p class="text-amber-300 text-sm mb-2"><strong>Why?</strong></p>
                <ul class="text-slate-300 text-sm space-y-1">
                    <li>â€¢ It gives the employee early feedback and a chance to improve</li>
                    <li>â€¢ It demonstrates you've provided support before escalating</li>
                    <li>â€¢ It strengthens your procedural fairness position</li>
                    <li>â€¢ It creates a documented history of the employee's progress</li>
                </ul>
            </div>
            
            <div class="space-y-3">
                <button onclick="openProbationCheckInFromPopup()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                    <span>ðŸ”„</span> Open Probation Check-In Tool
                </button>
                <button onclick="closeProbationCheckInRequiredPopup()" 
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg transition-all text-sm">
                    â† Go Back to Formal Probation Review
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function openProbationCheckInFromPopup() {
    // Close the popup
    closeProbationCheckInRequiredPopup();
    // Close the document builder modal
    closeToolModal('documentBuilderModal');
    // Reset document builder state
    resetDocumentBuilderSilent();
    // Open the Probation Check-In tool
    if (typeof openProbationCheckIn === 'function') {
        openProbationCheckIn();
    }
}

function closeProbationCheckInRequiredPopup() {
    const popup = document.getElementById('probationCheckInRequiredPopup');
    if (popup) {
        popup.remove();
    }
    // Reset the answer so they can try again
    documentBuilderState.data.priorCheckInCompleted = '';
    showDocumentStep(documentBuilderState.currentStep);
}

function docWizardGoBack() {
    if (documentBuilderState.currentStep > 1) {
        documentBuilderState.currentStep--;
        showDocumentStep(documentBuilderState.currentStep);
    }
}

async function generateDocumentWithAI() {
    const docType = documentBuilderState.currentType;
    
    // âœ… CHECK IF DOCUMENT IS CONSULTATION-GATED
    if (isConsultationGated(docType)) {
        // Close the document builder
        closeToolModal('documentBuilderModal');
        // Show consultation required modal
        showConsultationRequiredModal(docType);
        return;
    }
    
    // Hide wizard, show loading
    document.getElementById('documentWizardSteps').classList.add('hidden');
    document.getElementById('documentGenerating').classList.remove('hidden');
    
    documentBuilderState.isGenerating = true;
    
    try {
        const prompt = buildDocumentPrompt();
        const response = await callClaudeAPIForDocument(prompt);
        documentBuilderState.generatedDocument = response;
        
        // âœ… STORE the document ID that was just logged
        // This happens BEFORE any resets
        const logResult = await logDocumentGeneration();
        
        // âœ… Store the database ID so we can update it later
        if (logResult && logResult.id) {
            documentBuilderState.lastGeneratedDocId = logResult.id;
        }
        
        // âœ… Store docType and docName BEFORE closing modal (which resets state)
        const currentDocType = docType;
        const currentDocName = CONFIG.CREDITS.DOCUMENT_COSTS[docType]?.name || 'Document';
        
        // Close document builder modal
        closeToolModal('documentBuilderModal');
        
        // âœ… CHECK IF USER CAN AFFORD - Apply blur if not
        const shouldBlur = shouldBlurDocument(currentDocType);
        
        // Show preview modal
        showDocumentPreview(response);
        
        // Apply blur after preview is shown (pass stored values)
        if (shouldBlur) {
            setTimeout(() => {
                applyDocumentBlur(currentDocType, currentDocName);
            }, 100);
        }
        
        trackEvent('document_generated_ai', {
            user: currentUser,
            type: currentDocType,
            employeeName: documentBuilderState.data?.employeeName,
            blurred: shouldBlur
        });
        
    } catch (error) {
        showAlert('âš ï¸ Error generating document. Please try again or contact support.');
        
        // Reset to wizard
        document.getElementById('documentGenerating').classList.add('hidden');
        document.getElementById('documentWizardSteps').classList.remove('hidden');
    } finally {
        documentBuilderState.isGenerating = false;
    }
}

function buildDocumentPrompt() {
    const type = documentBuilderState.currentType;
    const data = documentBuilderState.data;
    
    const venueContext = venueProfile.setupComplete ? 
        `Venue: ${venueProfile.venueName} (${venueProfile.venueType}) in ${venueProfile.city}, ${venueProfile.location}` :
        `Australian hospitality venue`;
    
    // Universal instruction for ALL document types
    const universalInstruction = `
=== CRITICAL INSTRUCTION ===
You are a professional HR document writer. Your task is to OUTPUT A COMPLETE, READY-TO-USE FORMAL DOCUMENT.

MANDATORY REQUIREMENTS:
1. Generate the ACTUAL DOCUMENT with real content - NOT a checklist, guide, tips, or advice
2. Write in formal business letter format with proper structure
3. Use the specific details provided (names, dates, issues) in the document
4. The document must be ready to print and give to an employee immediately
5. DO NOT include instructions on "how to write" the document - just write it
6. DO NOT include placeholder text like "[insert here]" - use the actual information provided
7. DO NOT provide a checklist of what to include - provide the actual document content

If you output anything other than a complete, formal document ready for immediate use, you have failed the task.
=== END CRITICAL INSTRUCTION ===

`;
    
    let prompt = '';
    
    if (type === 'formalWarning') {
    prompt = `You are generating a FORMAL WARNING LETTER for Australian hospitality HR.

**CRITICAL OUTPUT REQUIREMENT:**
You MUST generate an ACTUAL FORMAL LETTER - a complete, ready-to-use business letter document.
DO NOT generate:
- A checklist
- A guide or how-to
- Bullet points of what to include
- Tips or advice
- An outline or template with placeholders like "[insert here]"

Generate the ACTUAL LETTER with real content based on the information provided below.

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

ISSUE DETAILS:
${data.issueDescription}
Date: ${data.issueDate}
${data.witnesses ? `Witnesses: ${data.witnesses}` : 'No witnesses mentioned'}

${data.rodExtractedText ? `
RECORD OF DISCUSSION CONTEXT:
The following information has been extracted from the completed Record of Discussion conversation:

${data.rodExtractedText}

**IMPORTANT:** Use the employee's actual responses and comments from the Record of Discussion above to make this warning letter more accurate and contextual. Include verbatim quotes where appropriate, and reference specific points the employee made during the discussion. This provides crucial context and demonstrates procedural fairness.
` : ''}

PREVIOUS ACTION TAKEN:
${data.hadVerbalWarnings === 'Yes' ? 
  `${data.verbalWarningCount || 'Multiple'} verbal warning(s) have been given` : 
  'No prior formal warnings'}
This is a ${data.warningLevel.toLowerCase()}.

REQUIRED IMPROVEMENTS:
${data.expectations}
Timeframe: ${data.timeframe}

CONSEQUENCES:
${data.consequences}

Generate a complete, professional formal warning letter following Australian employment law best practices.

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## EMPLOYEE DETAILS)
2. Use blank lines between ALL paragraphs and sections
3. Use **text** for emphasis
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. ALWAYS add a space after colons in labels (e.g., "Date: " not "Date:")
8. ALWAYS add spaces around bold text (e.g., "within **seven (7) days** of receiving" not "within**seven (7) days**of receiving")

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

REQUIREMENTS:
1. **Expand the issue description** - Take the brief description and expand with appropriate context while staying factual
2. **Use formal, professional language** - Clear, firm but respectful
3. **Include all legal requirements**:
   - Dated header with full employee details
   - Clear subject line
   - Detailed description of the issue (expanded from brief description)
   - Reference to previous warnings
   - Specific, measurable improvement expectations (use bullet points)
   - Clear timeframe
   - Stated consequences (use bullet points)
   - Warning retention period (12 months)
   - Signature sections

4. **Maintain procedural fairness**
5. **Be specific and actionable**
6. **Professional tone** - firm but not threatening

Example structure:

# FORMAL WARNING LETTER

## DATE AND RECIPIENT

Date: [Date]

Employee Name: [Name]

Position: [Position]

## SUBJECT

Subject: Formal Written Warning - [Issue]

## ISSUE DESCRIPTION

[Detailed description of what occurred, with specific dates and facts]

## PREVIOUS DISCUSSIONS

[Reference to verbal warnings if applicable]

## REQUIRED IMPROVEMENTS

You are required to:

- [Specific expectation 1]
- [Specific expectation 2]
- [Specific expectation 3]

## TIMEFRAME

[Clear timeframe for improvement]

## CONSEQUENCES

Failure to meet these expectations may result in:

- [Consequence 1]
- [Consequence 2]
- Termination of employment

## WARNING RETENTION

This warning will remain on your employee file for 12 months from the date of this letter.

## SIGNATURES

Employee Signature: _________________________ Date: __________

Manager Signature: _________________________ Date: __________

Format as a complete business letter with proper structure and clear spacing between all sections.

DO NOT add fictional details. Expand and contextualize what was provided.`;
    
    } else if (type === 'recordOfDiscussion') {
    prompt = `You are generating a RECORD OF DISCUSSION TEMPLATE & CONVERSATION SCRIPT for Australian hospitality managers.

THIS IS A TEMPLATE/SCRIPT - NOT A COMPLETED DOCUMENT.
The manager will use this during the actual conversation with the employee.

âš ï¸ CRITICAL: This is a PROCEDURAL FAIRNESS meeting. NO outcome or decision is made during this meeting. The purpose is to:
1. Present allegations to the employee
2. Give the employee the opportunity to respond
3. Gather information and the employee's perspective
4. Adjourn to consider all information before making any decision

A follow-up meeting will be scheduled 24-48 hours later to deliver the outcome after proper consideration.

VENUE CONTEXT:
${venueContext}
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}

MEETING PREPARATION CHECKLIST:
- 24 hours notice given: ${data.notice24hours}
- Support person offered: ${data.supportPersonOffered}

ALLEGATIONS:
${data.allegations}

WITNESSES (if any):
${data.witnesses || 'None mentioned'}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## BEFORE THE MEETING)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use **bold** formatting - use plain text only
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. **ALWAYS add a space after colons in labels** (e.g., "Employee Name: Blake" not "Employee Name:Blake")
8. For manager scripts, prefix with "MANAGER SAYS: " instead of using bold

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

**IMPORTANT: Always include a space after colons:**
âœ“ CORRECT: "Date: 20 January 2026"
âœ— WRONG: "Date:20 January 2026"

Generate a conversation template that:

1. **Provides a complete script** for the manager to follow during the meeting
2. **Uses "MANAGER SAYS:" prefix** for what the manager should actually SAY
3. **Uses italics** for instructions/guidance (e.g., *Listen carefully and take notes*)
4. **Leaves space** for the manager to write the employee's responses
5. **Guides the manager** through difficult conversations with prompts like:
   - *Ask clarifying questions*
   - *Allow the employee time to respond*
   - *Remain calm and professional*
6. **CLEARLY STATES** that no decision will be made today - this is just to hear their side

STRUCTURE:

## BEFORE THE MEETING

*Print this document and have it in front of you during the meeting*
*Review the allegations and gather any evidence*
*Prepare to listen - this is a two-way conversation*
*Remember: You are NOT making a decision today - only gathering information*

## MEETING SCRIPT

### OPENING THE MEETING

MANAGER SAYS: "Thank you for meeting with me today, ${data.employeeName}. As mentioned in my notice, we need to discuss some concerns about [brief description]."

MANAGER SAYS: "You have the right to have a support person present. Have you brought someone with you, or would you like to reschedule to arrange one?"

*Wait for response - write it here:*
__________________________________________________________________________________

### EXPLAINING THE PURPOSE

MANAGER SAYS: "Before we start, I want to be clear about the purpose of this meeting:

- I'm going to explain some allegations/concerns
- You'll have the opportunity to respond and give your side of the story
- I'm here to listen and gather information
- No decision will be made today - I need time to properly consider everything you tell me
- We'll schedule a follow-up meeting in the next 24-48 hours where I'll share my decision

Does that make sense?"

*Wait for acknowledgment:*
___________________________________

### PRESENTING THE ALLEGATIONS

MANAGER SAYS: "The reason for this meeting is that I've received information about the following:"

${data.allegations.split('\n').map(a => `â€¢ ${a.trim()}`).join('\n')}

*Pause after presenting each allegation - let them absorb the information*

MANAGER SAYS: "These matters are serious because [explain the impact - e.g., they affect workplace safety, team morale, customer service, or breach company policy]."

### GIVING THE EMPLOYEE THE OPPORTUNITY TO RESPOND

MANAGER SAYS: "Now I'd like to hear your side of the story. This is your opportunity to respond to these allegations. Can you tell me what happened from your perspective?"

*This is CRITICAL - LISTEN carefully without interrupting. Take detailed notes of everything they say:*

Employee's response to allegations:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

*After they finish, ask clarifying questions:*

MANAGER SAYS: "Thank you for explaining. Can I ask a few questions to make sure I understand correctly?"

Clarifying questions to ask:

- "When you say [repeat something they said], can you explain what you mean?"
- "Were there any other circumstances I should know about?"
- "Is there anyone who can support what you're telling me?"
- "Is there anything else you'd like to add?"

Additional information from employee:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

### EVIDENCE OR WITNESSES

*If the employee mentions evidence or witnesses:*

MANAGER SAYS: "You mentioned [evidence/witness]. Can you provide me with [details/their name] so I can consider this as part of my review?"

Evidence/witnesses mentioned:
__________________________________________________________________________________
__________________________________________________________________________________

### EXPLAINING NEXT STEPS

MANAGER SAYS: "Thank you for being open with me and sharing your perspective. I want to be clear about what happens next:

- I'm going to take time to properly consider everything you've told me today
- I'll review all the information, evidence, and your response
- I'll schedule a follow-up meeting with you within the next 24-48 hours
- At that meeting, I'll let you know my decision and what happens next
- You won't hear anything before that meeting - I need time to think this through properly"

*Set a specific date/time now for the follow-up meeting:*

MANAGER SAYS: "Can we schedule our follow-up meeting for [DATE] at [TIME]?"

Follow-up meeting scheduled:

Date: ___________________

Time: ___________________

### CLOSING THE MEETING

MANAGER SAYS: "Do you have any questions about the process or what happens next?"

*Note any questions/concerns:*
__________________________________________________________________________________

MANAGER SAYS: "Thank you for attending this meeting and sharing your side of the story. I'll see you at our follow-up meeting on [DATE]."

*If they have a support person:*

MANAGER SAYS: "Thank you also for attending [support person name]."

## AFTER THE MEETING

*Complete the following sections IMMEDIATELY after the meeting while details are fresh:*

### SUMMARY OF ALLEGATIONS PRESENTED

*Write a brief, factual summary of what allegations you presented:*
__________________________________________________________________________________
__________________________________________________________________________________

### EMPLOYEE'S RESPONSE SUMMARY

*Summarize the key points of what the employee said in response:*
________________________________________________________________________________
________________________________________________________________________________
________________________________________________________________________________

### EMPLOYEE'S EXPLANATION/MITIGATING CIRCUMSTANCES

*Note any explanations, mitigating factors, or context the employee provided:*
__________________________________________________________________________________
__________________________________________________________________________________

### EVIDENCE/WITNESSES TO FOLLOW UP

*List any evidence you need to review or witnesses you need to speak to:*

- __________________________________________________________________________________
- __________________________________________________________________________________
- __________________________________________________________________________________

### MANAGER'S NOTES FOR CONSIDERATION

*Before making your decision, consider:*

- How credible is the employee's explanation?
- Does their response change the seriousness of the allegations?
- What evidence supports or contradicts their version?
- Are there any mitigating circumstances?
- What is the appropriate outcome (if allegations are substantiated)?

*DO NOT write your decision here - this is just for your own consideration process*

### MEETING ATTENDEES

Employee: ${data.employeeName}

Manager: ${venueProfile.userName || '[Manager Name]'}

Support Person (if present): _________________________________

Date: ___________________

Time: ___________________

### NEXT STEPS BEFORE FOLLOW-UP MEETING

*What you need to do before the follow-up meeting:*

â˜ Review all evidence and witness statements
â˜ Consider the employee's response fairly
â˜ Determine if allegations are substantiated
â˜ Decide on appropriate outcome (if substantiated)
â˜ Prepare outcome letter (if formal warning required)
â˜ Schedule follow-up meeting (DONE: [DATE/TIME])

---

**IMPORTANT REMINDERS FOR MANAGER:**

âœ“ DO NOT make or hint at any decision during this meeting
âœ“ Your role today is to LISTEN and GATHER INFORMATION only
âœ“ Take detailed notes - they may be important later
âœ“ Remain calm, professional, and neutral
âœ“ Give the employee adequate time to respond
âœ“ Ask open-ended questions to get their full story
âœ“ Schedule the follow-up meeting before they leave

**PROCEDURAL FAIRNESS CHECKLIST:**

â˜ Employee given 24 hours notice âœ“
â˜ Employee offered support person âœ“
â˜ Allegations clearly explained âœ“
â˜ Employee given genuine opportunity to respond âœ“
â˜ Employee's response documented âœ“
â˜ Follow-up meeting scheduled âœ“
â˜ No decision made during this meeting âœ“

**âš ï¸ CRITICAL LEGAL REQUIREMENT:**

This meeting is ONLY for gathering information. You MUST take time (24-48 hours) to properly consider the employee's response before making any decision. Failing to do this could result in a finding of unfair dismissal if the matter proceeds to termination.

*If you're unsure how to proceed at any point, pause the meeting and contact Fitzgerald HR: info@fitzgeraldhr.com.au*
`;
    
    } else if (type === 'letterOfAllegation') {
    prompt = `You are generating a LETTER OF ALLEGATION for serious workplace misconduct investigation.

**CRITICAL OUTPUT REQUIREMENT:**
You MUST generate an ACTUAL FORMAL LETTER - a complete, ready-to-use business letter document.
DO NOT generate:
- A checklist
- A guide or how-to
- Bullet points of what to include
- Tips or advice
- An outline or template with placeholders like "[insert here]"

Generate the ACTUAL LETTER with real content based on the information provided below.

âš ï¸ THIS IS HIGH-RISK - MUST BE LEGALLY SOUND

VENUE CONTEXT:
${venueContext}
Manager: ${venueProfile.userName || '[Manager Name]'}

EMPLOYEE:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

ALLEGATION:
Type: ${data.allegationType}
${data.allegationDescription}
Date of incident: ${data.incidentDate}

SOURCE:
${data.allegationSource}
${data.evidenceExists ? `Evidence: ${data.evidenceExists}` : ''}

INVESTIGATION:
Investigator: ${data.investigator}
Suspension: ${data.suspensionRequired}

MEETING SCHEDULED:
Date: ${data.meetingDate}
Time: ${data.meetingTime}
Location: ${data.meetingLocation}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## ALLEGATION DETAILS)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use bold formatting - use plain text only
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. **ALWAYS add a space after colons in labels** (e.g., "Date: 20 January 2026" not "Date:20 January 2026")

**IMPORTANT: Format lists clearly with bullet points like this:**
- First item
- Second item
- Third item

**IMPORTANT: Always include a space after colons:**
âœ“ CORRECT: "Date: 20 January 2026"
âœ— WRONG: "Date:20 January 2026"

Generate a legally compliant Letter of Allegation.

CRITICAL REQUIREMENTS:

1. **Neutral tone** - No presumption of guilt
2. **Clear process** - Explain investigation steps
3. **Employee rights**:
   - Right to support person
   - Opportunity to respond
   - Procedural fairness
4. **Confidentiality requirements**
5. **Meeting details**
6. **Suspension details** (if applicable)
7. **Next steps clearly outlined**

Example structure:

# PRIVATE & CONFIDENTIAL

# LETTER OF ALLEGATION

## DATE AND RECIPIENT

Date: [Date]

Employee Name: [Name]

Position: [Position]

Employment Type: [Type]

## SUBJECT

Subject: Allegation of [Type] - Investigation Process

## NATURE OF ALLEGATION

[Factual description - not conclusive]

We have received information regarding an alleged incident of ${data.allegationType} that occurred on or around ${data.incidentDate}.

The allegation is as follows:

${data.allegationDescription}

Please note that this letter does not constitute a finding of guilt or wrongdoing. It is simply to inform you of the allegation and the investigation process that will follow.

## INVESTIGATION PROCESS

We will be conducting a thorough and fair investigation into this matter. The investigation will include:

- Meeting with you to hear your response to the allegation
- Reviewing any relevant evidence
- Speaking with any witnesses (if applicable)
- Considering all information before making any decision

The investigation will be conducted by: ${data.investigator}

## SUSPENSION ARRANGEMENTS

${data.suspensionRequired.includes('No suspension') ? 
  'You are not suspended during this investigation and should continue to attend work as normal.' :
  data.suspensionRequired.includes('full pay') ?
  'You are suspended on full pay during this investigation. You should not attend the workplace unless specifically requested. You will continue to receive your normal pay during this period.' :
  'You are suspended without pay during this investigation due to the serious nature of the alleged misconduct. You should not attend the workplace unless specifically requested.'}

## INVESTIGATION MEETING

You are required to attend an investigation meeting to respond to this allegation:

Date: ${data.meetingDate}

Time: ${data.meetingTime}

Location: ${data.meetingLocation}

## YOUR RIGHTS

You have the following rights during this investigation:

- Right to bring a support person to the meeting (this can be a work colleague, family member, or union representative)
- Opportunity to respond to the allegations in full
- Right to provide evidence or witness names that support your version of events
- Procedural fairness will be maintained throughout the investigation
- You may seek legal advice if you wish

## CONFIDENTIALITY

This matter is confidential. You must not discuss the allegation or investigation with other employees (except your nominated support person or union representative). Breaching confidentiality may be considered a separate matter of misconduct.

## NEXT STEPS

After the investigation meeting:

- Your response will be considered along with all other evidence
- A decision will be made regarding the allegation
- You will be informed of the outcome in writing
- If the allegation is substantiated, disciplinary action may be taken, which could include termination of employment

## CONTACT INFORMATION

If you have any questions about this process or need to discuss the meeting arrangements, please contact:

${venueProfile.userName || '[Manager Name]'}

Email: [email]

Phone: [phone]

We encourage you to seek advice from a union representative or legal advisor if you wish.

---

This is a serious matter and we are committed to conducting a fair and thorough investigation.

Please confirm receipt of this letter and your attendance at the scheduled meeting.

Yours sincerely,

${venueProfile.userName || '[Manager Name]'}

[Title]

${venueProfile.venueName || '[Venue Name]'}

Date: [Date]

---

IMPORTANT LEGAL NOTICE:

This letter must be reviewed by a Fitzgerald HR Senior Consultant before being issued to the employee.

Contact: info@fitzgeraldhr.com.au

Include:
- PRIVATE & CONFIDENTIAL header
- Date and recipient details
- Clear subject line
- Nature of allegation (factual, not conclusive)
- Investigation process explanation
- Suspension details if applicable
- Meeting details (date, time, location)
- Support person rights
- Confidentiality requirements
- Next steps after investigation
- Signature section

TONE: Professional, neutral, procedurally fair. This is NOT a punishment - it's the start of a fair process.`;
	
    } else if (type === 'formalProbationReview') {
        prompt = `You are generating a FORMAL PROBATION REVIEW DOCUMENT for Australian hospitality HR.

The purpose of this Formal Probation Review Document is to guide an open and honest discussion about performance and/or behaviours in probation, including support the employee may need.

The probation period is an opportunity for the venue and the employee to determine the employee's suitability for the role and culture fit.

THIS IS A TEMPLATE & CONVERSATION GUIDE â€” the manager will use this during the actual meeting with the employee and complete sections together.

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009

EMPLOYEE DETAILS:
- Employee Name: ${data.employeeName}
- Position: ${data.position}
- People Leader: ${data.peopleLeader}
- Meeting Date: ${data.meetingDate}
- Employment Type: ${data.employmentType}
- Start Date: ${data.startDate}
- Probation End Date: ${data.probationEndDate}

PREVIOUS CHECK-IN/COACHING CONVERSATIONS:
${data.checkInHistory}

REVIEW OF PERFORMANCE â€” STRENGTHS:
Areas currently meeting the required standards:
${data.strengths}
${data.strengthsComments ? `Additional comments: ${data.strengthsComments}` : ''}

OPPORTUNITIES FOR DEVELOPMENT:
Areas NOT currently meeting the required standards:
${data.developmentAreas}
${data.developmentComments ? `Additional comments: ${data.developmentComments}` : ''}
${data.conductConcerns ? `Conduct/compliance concerns: ${data.conductConcerns}` : 'No conduct or compliance concerns noted.'}

ACTION PLAN:
Agreed actions:
${data.agreedActions}

Training and support to be provided:
${data.trainingAndSupport}

Next review date: ${data.nextReviewDate}

EMPLOYEE FEEDBACK:
${data.employeeSelfAssessment || 'To be completed during the meeting with the employee.'}

OVERALL OUTCOME: ${data.overallOutcome}
${data.additionalNotes ? `Additional notes: ${data.additionalNotes}` : ''}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections
2. Use blank lines between ALL paragraphs and sections
3. Use **text** for emphasis on key headings only
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. ALWAYS add a space after colons in labels (e.g., "Date: " not "Date:")
7. Include writable lines (______) for sections completed during the meeting

Generate a complete, professional Formal Probation Review Document with the following structure:

## FORMAL PROBATION REVIEW DOCUMENT

*Start with a brief purpose statement: "The purpose of this Formal Probation Review Document is to guide an open and honest discussion about performance and/or behaviours in probation, including support the employee may need."*

*Add: "The probation period is an opportunity for [venue name] and the employee to determine the employee's suitability for the role and culture fit."*

*Add: "Generally, at least one Probation Check-In Conversation has occurred before a Formal Probation Review."*

## EMPLOYEE DETAILS

Create a clear details table with:
- Employee Name: ${data.employeeName}
- Position: ${data.position}
- People Leader: ${data.peopleLeader}
- Meeting Date: ${data.meetingDate}
- Employment Start Date: ${data.startDate}
- Probation End Date: ${data.probationEndDate}

## PREVIOUS COACHING & CHECK-IN CONVERSATIONS

*Add: "The following coaching and/or check-in conversations have occurred:"*

List each conversation from the provided history as bullet points with date and overview. Format as:
â€¢ [date] â€” [overview of conversation]

## REVIEW OF PERFORMANCE

### Strengths

*Add: "Discuss the areas of performance and/or behaviours that ARE currently meeting the required standards."*

Expand the provided strengths into clear, professional bullet points with specific examples. Then add a comments section:

Comments:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

### Opportunities for Development

*Add: "Discuss the areas of performance and/or behaviours that are NOT currently meeting the required standards."*

Expand the provided development areas into clear, professional bullet points with specific examples. Then add a comments section:

Comments:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

${data.conductConcerns ? `*Add a note about conduct/compliance matters if applicable: "${data.conductConcerns}"*` : '*Add: "Conduct or compliance breaches? Contact Fitzgerald HR: info@fitzgeraldhr.com.au"*'}

## ACTION PLAN

*Add: "What is to be done, who will do it, when it needs to be completed. The most effective Action Plans focus on behaviours and actions (inputs) rather than metrics and outcomes (outputs)."*

*Add: "To help improve performance and/or behaviours to the required standard, the following action plan is agreed:"*

Create a clear action plan table/section with columns:
- Agreed Actions | By Whom | By When

Expand the provided agreed actions into the table. Include BOTH employee actions AND leader actions.

Then add the training and support section with specific details.

Next Review Date: ${data.nextReviewDate}

## EMPLOYEE'S COMMENTS/FEEDBACK

*Add: "Ask the employee for their self-assessment on their performance and/or behaviours, including any barriers they are facing, support they need, and feedback for you as their leader."*

${data.employeeSelfAssessment ? `Pre-filled: ${data.employeeSelfAssessment}` : ''}

Comments:
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

## KEY MESSAGES

*Add: "The following points were discussed and agreed (adjust as appropriate):"*

Based on the overall outcome "${data.overallOutcome}", generate appropriate key messages. These should be specific bullet points that summarise what was discussed and agreed. Include messages like:

${data.overallOutcome.includes('On track') ? 
`- The employee is currently meeting the required performance and/or behavioural standards for their role
- Areas of strength have been acknowledged and areas for continued development have been identified
- Both parties have agreed on an action plan for the next period
- A follow-up review will take place on ${data.nextReviewDate} to continue tracking progress` :
data.overallOutcome.includes('At risk') || data.overallOutcome.includes('Significant') ?
`- The employee is not currently meeting the required performance and/or behavioural standards required of their role
- The employee will need to address these performance or behavioural gaps and show sufficient improvement to be considered suitable for ongoing employment
- We have discussed and confirmed that the employee has received appropriate training to date to understand and perform the requirements of their role
- Both parties have agreed on an action plan with specific, measurable improvements required
- Another meeting will take place on ${data.nextReviewDate} to review their progress and to determine next steps` :
data.overallOutcome.includes('ending employment') ?
`- The employee has not demonstrated sufficient improvement during the probation period despite support and feedback provided
- The requirements of the role and expected standards were clearly communicated
- Support, training and regular feedback were provided throughout the probation period
- The employee was given a genuine opportunity to improve
- The decision to end employment during the probation period has been made in accordance with procedural fairness` :
`- Generate 4-5 appropriate key messages based on the outcome: ${data.overallOutcome}`}

*Add: "Should the employee feel they need any support in dealing with this matter, confidential independent professional counsellors can be contacted for a range of issues." (Include an EAP reference if the venue has one)*

## SIGNATURES

People Leader's Signature: _________________________ Date: __ / __ / ____

Employee's Signature: _________________________ Date: __ / __ / ____

---

**IMPORTANT REMINDERS:**

âœ“ Both parties should retain a copy of this completed document
âœ“ This document forms part of the employee's probation record
âœ“ Any serious concerns should be escalated to Fitzgerald HR: info@fitzgeraldhr.com.au
âœ“ The tone throughout should be supportive and developmental â€” firm where needed but always fair

**âš ï¸ All generated documents must be reviewed by a Fitzgerald HR consultant before use.**

Contact: info@fitzgeraldhr.com.au

TONE: Professional, supportive, and fair. This is a development conversation â€” not a disciplinary meeting. Be specific with examples, balanced in acknowledging strengths and identifying areas for improvement, and constructive in the action plan. The document should demonstrate genuine procedural fairness.

DO NOT add fictional details. Expand and contextualise what was provided. DO NOT reference any other organisations by name.`;
	
    } else if (type === 'performanceImprovementPlan') {
        prompt = `You are generating a PERFORMANCE IMPROVEMENT PLAN (PIP) for Australian hospitality HR.

**CRITICAL OUTPUT REQUIREMENT:**
You MUST generate an ACTUAL FORMAL DOCUMENT - a complete, ready-to-use Performance Improvement Plan.
DO NOT generate:
- A checklist
- A guide or how-to
- Bullet points of what to include
- Tips or advice
- An outline or template with placeholders like "[insert here]"

Generate the ACTUAL PIP DOCUMENT with real content based on the information provided below.

âš ï¸ THIS IS A FORMAL 12-WEEK STRUCTURED PROCESS

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009
Manager: ${data.managerName || venueProfile.userName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}

PERFORMANCE ISSUES IDENTIFIED:
Issue #1: ${data.performanceIssue1}
Evidence: ${data.performanceData1}

${data.performanceIssue2 ? `Issue #2: ${data.performanceIssue2}\nEvidence: ${data.performanceData2}` : ''}

SMART GOALS SET:
Goal #1: ${data.goal1}
${data.goal2 ? `Goal #2: ${data.goal2}` : ''}
${data.goal3 ? `Goal #3: ${data.goal3}` : ''}

ACTION PLAN:
Training/Coaching: ${data.trainingProvided}
Resources: ${data.resourcesProvided}
Manager Support: ${data.managerSupport}

EMPLOYEE RESPONSIBILITIES:
${data.employeeActions}

TIMELINE:
- PIP Start: ${data.pipStartDate}
- Weekly Check-ins: ${data.weeklyCheckins}
- Week 4 Review: ${data.week4ReviewDate}
- Week 8 Review: ${data.week8ReviewDate}
- Week 12 Final Review: ${data.week12ReviewDate}

CONSEQUENCES:
- Week 4: ${data.week4Consequence}
- Week 8: ${data.week8Consequence}
- Week 12: ${data.week12Consequence}
${data.consequenceNotes ? `Notes: ${data.consequenceNotes}` : ''}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## PERFORMANCE ISSUES)
2. Use blank lines between ALL paragraphs and sections
3. DO NOT use **bold** formatting - use plain text only
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. **ALWAYS add a space after colons in labels** (e.g., "Date: 20 January 2026" not "Date:20 January 2026")

Generate a complete, professionally structured 12-Week Performance Improvement Plan.

REQUIREMENTS:

1. **Professional business document format**
2. **Clear structure** with these sections:
   - Header (CONFIDENTIAL - PERFORMANCE IMPROVEMENT PLAN)
   - Employee and Manager Details
   - Purpose of PIP
   - Performance Issues Identified (with data/evidence)
   - SMART Goals (numbered, clear, measurable)
   - Action Plan (detailed steps, training, resources)
   - Roles and Responsibilities (Manager & Employee tables)
   - Timeline and Review Schedule (12-week calendar)
   - Progress Measurement (how success will be tracked)
   - Consequences (staged - Week 4, 8, 12)
   - Support Available
   - Employee Acknowledgment Section
   - Signature Blocks

3. **Use a supportive but clear tone** - this is to help the employee succeed, not punish them
4. **Make goals SMART** - expand on the brief goals provided with more specific detail
5. **Weekly check-in template** - provide a simple weekly check-in form at the end
6. **Be specific about consequences** but frame as progressive steps
7. **Include measurement criteria** for each goal

Example structure:

# CONFIDENTIAL

# PERFORMANCE IMPROVEMENT PLAN

## EMPLOYEE DETAILS

Employee Name: ${data.employeeName}

Position: ${data.position}

Employment Type: ${data.employmentType}

Manager/Supervisor: ${data.managerName}

PIP Start Date: ${data.pipStartDate}

PIP Duration: 12 weeks

## PURPOSE OF THIS PERFORMANCE IMPROVEMENT PLAN

This Performance Improvement Plan (PIP) has been developed to support ${data.employeeName} in addressing performance concerns and achieving the expected standards for the ${data.position} role.

The purpose of this plan is to:

- Clearly identify the specific performance issues that need improvement
- Set measurable goals with realistic timeframes
- Provide structured support, training, and resources
- Establish regular check-ins and feedback mechanisms
- Outline the consequences if performance does not improve

This is a supportive process designed to help you succeed. We are committed to providing you with the tools, training, and support needed to meet these goals.

## PERFORMANCE ISSUES IDENTIFIED

The following performance issues have been identified based on objective data and observations:

### Issue 1: [Expand on ${data.performanceIssue1}]

Evidence:

- ${data.performanceData1}

Impact: [Explain how this impacts the business, team, or customers]

### Issue 2: [If applicable - expand on ${data.performanceIssue2}]

Evidence:

- ${data.performanceData2}

Impact: [Explain impact]

## SMART GOALS

To address these performance issues, the following SMART goals have been established:

### Goal 1: [Expand ${data.goal1}]

- Specific: [What exactly needs to improve]
- Measurable: [How will we measure success - specific numbers/metrics]
- Achievable: [Why this is realistic given training and support]
- Relevant: [How this relates to role expectations]
- Time-bound: [Specific deadline - Week 4, 8, or 12]

Success Criteria: [Define what "success" looks like - be very specific]

### Goal 2: [If applicable]

[Same structure as Goal 1]

### Goal 3: [If applicable]

[Same structure as Goal 1]

## ACTION PLAN

To help you achieve these goals, we will provide the following support:

### Training and Development

${data.trainingProvided}

### Resources and Tools

${data.resourcesProvided}

### Manager/Supervisor Support

${data.managerSupport}

## ROLES AND RESPONSIBILITIES

### Employee Responsibilities

You are expected to:

${data.employeeActions}

### Manager/Supervisor Responsibilities

Your manager/supervisor will:

- Conduct weekly check-in meetings on ${data.weeklyCheckins}
- Provide regular feedback and coaching
- Track progress toward goals
- Remove barriers to success where possible
- Conduct formal reviews at Week 4, Week 8, and Week 12
- Maintain confidentiality of this process

## TIMELINE AND REVIEW SCHEDULE

This is a 12-week structured process with regular check-ins and formal reviews:

### Weekly Check-ins

When: ${data.weeklyCheckins}

Purpose: Quick progress check, address questions, provide feedback

Duration: 15-30 minutes

### Formal Review Points

Week 4 Review: ${data.week4ReviewDate}

Purpose: Assess progress on goals, adjust plan if needed, determine next steps

Week 8 Review: ${data.week8ReviewDate}

Purpose: Mid-point assessment, confirm trajectory, address any challenges

Week 12 Final Review: ${data.week12ReviewDate}

Purpose: Final assessment of overall performance improvement

## PROGRESS MEASUREMENT

Progress will be measured using the following methods:

- [Specific metrics for Goal 1 - e.g., till data, customer feedback scores]
- [Specific metrics for Goal 2 - e.g., accuracy reports, manager observations]
- [Specific metrics for Goal 3 - e.g., review ratings, speed measurements]
- Direct observation and feedback from managers and team members
- Customer feedback and reviews
- Self-assessment and reflection

Data will be collected weekly and reviewed at each check-in.

## CONSEQUENCES OF NON-IMPROVEMENT

This PIP is designed to support your success. However, if performance does not improve significantly, the following consequences will apply:

### Week 4 Review

If there is no significant improvement by Week 4:

${data.week4Consequence}

### Week 8 Review

If there is no significant improvement by Week 8:

${data.week8Consequence}

### Week 12 Final Review

If performance standards have not been met by Week 12:

${data.week12Consequence}

${data.consequenceNotes ? `Additional notes: ${data.consequenceNotes}` : ''}

"Significant improvement" means demonstrable progress toward the stated goals as measured by the agreed metrics and criteria.

## SUPPORT AVAILABLE

We want you to succeed. If you are struggling or need additional support at any time:

- Speak with your manager/supervisor immediately
- Request additional training or resources if needed
- Ask questions if goals or expectations are unclear
- Seek support from HR if you have concerns about the process

You have the right to have a support person present at any formal review meeting. This can be a work colleague, family member, or union representative.

## CONFIDENTIALITY

This Performance Improvement Plan is confidential. You should not discuss the details of this plan with other employees (except your nominated support person or union representative).

## EMPLOYEE ACKNOWLEDGMENT

I acknowledge that:

- I have received and read this Performance Improvement Plan
- The performance issues and expectations have been clearly explained to me
- I understand the goals I am expected to achieve
- I understand the support and resources that will be provided
- I understand the timeline and review process
- I understand the consequences if my performance does not improve
- I have been offered the right to have a support person present at review meetings
- I have had the opportunity to ask questions about this plan

This acknowledgment does not mean I agree with all aspects of this plan, but confirms I understand it.

Employee Signature: _________________________ Date: __________

Manager/Supervisor Signature: _________________________ Date: __________

---

## WEEKLY CHECK-IN TEMPLATE

Week Number: _____     Date: __________

Goals Review:

Goal 1 Progress:

- Current status: [On track / Behind / Ahead]
- Evidence of progress:
- Challenges faced:
- Support needed:

Goal 2 Progress:

- Current status: [On track / Behind / Ahead]
- Evidence of progress:
- Challenges faced:
- Support needed:

Action Items for Next Week:

1. ___________________________________
2. ___________________________________
3. ___________________________________

Employee Comments:

__________________________________________

Manager Comments:

__________________________________________

Employee Signature: _______________ Date: ______

Manager Signature: _______________ Date: ______

---

**IMPORTANT REMINDER:**

This PIP must be reviewed by a Fitzgerald HR Senior Consultant before presenting to the employee to ensure it is legally compliant and procedurally fair.

Contact: info@fitzgeraldhr.com.au

Format as a complete, professional business document with clear structure and spacing.

This is a SUPPORTIVE document - the tone should be firm but encouraging. The goal is to help the employee succeed, not to create a paper trail for termination (although it may be used that way if improvement doesn't occur).

DO NOT add fictional details. Use the specific information provided. Expand and add professional context where appropriate.`;
    
    }
    
    // Add FINAL instruction at the end of every prompt
    const finalInstruction = `

=== FINAL REMINDER - READ THIS CAREFULLY ===
Your output MUST be the actual document content itself - starting with the document header (e.g., "FORMAL WARNING LETTER" or "PRIVATE & CONFIDENTIAL").

DO NOT:
- Start with "I understand..." or "Here's what you need..." or any conversational text
- Provide advice, guidance, or process steps
- Give a checklist of what the document should contain
- Explain what the document is for

DO:
- Begin IMMEDIATELY with the document header
- Write the actual formal letter/document content
- Use the employee name, dates, and details provided
- Format as a ready-to-print professional document

START YOUR RESPONSE WITH THE DOCUMENT HEADER NOW:
=== END FINAL REMINDER ===`;
    
    // Prepend universal instruction and append final instruction
    return universalInstruction + prompt + finalInstruction;
}

function showDocumentPreview(generatedDoc) {
    // Convert the AI-generated content to proper HTML
    const formattedHTML = convertAIContentToHTML(generatedDoc);
    
    document.getElementById('documentPreviewContent').innerHTML = formattedHTML;
    document.getElementById('documentPreviewModal').classList.remove('hidden');
}

function closeDocumentPreview() {
    document.getElementById('documentPreviewModal').classList.add('hidden');
    // Reset the document builder silently so it's ready for next use
    resetDocumentBuilderSilent();
}

// Silent reset (used when closing modal)
function resetDocumentBuilderSilent() {
    // Reset state
    documentBuilderState.currentType = null;
    documentBuilderState.currentStep = 1;
    documentBuilderState.data = {};
    documentBuilderState.generatedDocument = null;
    documentBuilderState.isGenerating = false;
    
    // Hide all wizard sections
    const wizardSteps = document.getElementById('documentWizardSteps');
    const generating = document.getElementById('documentGenerating');
    const templateSelection = document.getElementById('documentTemplateSelection');
    
    if (wizardSteps) wizardSteps.classList.add('hidden');
    if (generating) generating.classList.add('hidden');
    if (templateSelection) templateSelection.classList.remove('hidden');
    
    // Reset progress
    const currentStep = document.getElementById('docCurrentStep');
    const progress = document.getElementById('docProgress');
    const progressBar = document.getElementById('docProgressBar');
    
    if (currentStep) currentStep.textContent = '1';
    if (progress) progress.textContent = '0% Complete';
    if (progressBar) progressBar.style.width = '0%';
    
}

// Reset with confirmation (used when user clicks "Start Over" button)
function resetDocumentBuilder() {
    // Confirm reset
    if (!confirm('Start over? This will clear all your entered information.')) {
        return;
    }
    
    // Call the silent reset
    resetDocumentBuilderSilent();
}

// ========================================
// FITZ CREDITS MODAL FUNCTIONS
// ========================================

// Track selected consultation type
let selectedConsultation = null;
let selectedMeetingType = null;

// Consultation types configuration
const CONSULTATION_TYPES = {
    terminationReview: {
        name: 'Termination Review',
        icon: 'ðŸšª',
        credits: 7,
        includes: 'Includes termination letter if approved',
        calendlyZoom: 'CALENDLY_TERMINATION_ZOOM_URL',
        calendlyPhone: 'CALENDLY_TERMINATION_PHONE_URL'
    },
    redundancyReview: {
        name: 'Redundancy Review',
        icon: 'ðŸ“‰',
        credits: 7,
        includes: 'Includes redundancy letters if approved',
        calendlyZoom: 'CALENDLY_REDUNDANCY_ZOOM_URL',
        calendlyPhone: 'CALENDLY_REDUNDANCY_PHONE_URL'
    },
    investigationReview: {
        name: 'Investigation Review',
        icon: 'ðŸ”',
        credits: 8,
        includes: 'Includes investigation report',
        calendlyZoom: 'CALENDLY_INVESTIGATION_ZOOM_URL',
        calendlyPhone: 'CALENDLY_INVESTIGATION_PHONE_URL'
    },
    settlementReview: {
        name: 'Settlement Review',
        icon: 'ðŸ¤',
        credits: 8,
        includes: 'Includes deed of settlement draft',
        calendlyZoom: 'CALENDLY_SETTLEMENT_ZOOM_URL',
        calendlyPhone: 'CALENDLY_SETTLEMENT_PHONE_URL'
    },
    unfairDismissalResponse: {
        name: 'Unfair Dismissal Response',
        icon: 'âš–ï¸',
        credits: 8,
        includes: 'Includes response draft for Fair Work',
        calendlyZoom: 'CALENDLY_UNFAIR_DISMISSAL_ZOOM_URL',
        calendlyPhone: 'CALENDLY_UNFAIR_DISMISSAL_PHONE_URL'
    },
    generalConsultation: {
        name: 'General HR Consultation',
        icon: 'ðŸ’¬',
        credits: 5,
        includes: 'Expert advice on any HR matter',
        calendlyZoom: 'CALENDLY_GENERAL_ZOOM_URL',
        calendlyPhone: 'CALENDLY_GENERAL_PHONE_URL'
    }
};

// ============================================
// CALENDLY CONFIGURATION
// ============================================
const CALENDLY_CONFIG = {
    baseUrl: 'https://calendly.com/blakefitzgerald4',
    events: {
        zoom: 'hr-consultation-zoom',
        phone: '30min'
    }
};

/**
 * Toggle the free documents dropdown in credits modal
 */
function toggleFreeDocsDropdown() {
    const dropdown = document.getElementById('freeDocsDropdown');
    const chevron = document.getElementById('freeDocsChevron');
    
    if (dropdown && chevron) {
        dropdown.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }
}

/**
 * Start a chat to help create a Position Description
 */
function startPositionDescriptionChat() {
    // Add a helpful prompt to the chat input
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.value = "I need help creating a Position Description for a ";
        chatInput.focus();
        // Place cursor at end
        chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
    }
    
    // Add a helpful message
    addMessage('assistant', `## ðŸ“ Position Description Generator\n\nI'll help you create a professional Position Description! Just tell me:\n\n1. **Job title** (e.g., Marketing Manager, Sales Associate)\n2. **Department** (e.g., Marketing, Sales, Operations)\n3. **Employment type** (Full-time, Part-time, Casual)\n4. **Key responsibilities** (what will they do day-to-day?)\n\nFor example, you could say:\n\n*"Create a Position Description for a full-time Marketing Coordinator in the Marketing department. They'll manage social media, coordinate campaigns, and report on analytics."*\n\nWhat role would you like to create a Position Description for?`);
    
    showNotification('ðŸ’¡ Tell me about the role and I\'ll create the Position Description!', 'info');
}

/**
 * Open the credits management modal
 */
function openCreditsModal() {
    const totalCredits = getTotalCredits();
    const modalCreditsBalance = document.getElementById('modalCreditsBalance');
    const freeDocStatus = document.getElementById('freeDocumentStatus');
    const freeDocUsedStatus = document.getElementById('freeDocumentUsedStatus');
    
    // Update tier display
    document.getElementById('modalCurrentTier').textContent = CONFIG.CREDITS.TIERS[userCredits.tier]?.name || 'Free';
    
    // Update credits balance - show actual number
    modalCreditsBalance.textContent = totalCredits;
    modalCreditsBalance.classList.remove('text-green-400', 'text-amber-400', 'text-red-400');
    if (totalCredits >= 5) {
        modalCreditsBalance.classList.add('text-green-400');
    } else if (totalCredits >= 1) {
        modalCreditsBalance.classList.add('text-amber-400');
    } else {
        modalCreditsBalance.classList.add('text-red-400');
    }
    
    // Show free tier info or hide for paid tiers
    if (freeDocStatus && freeDocUsedStatus) {
        if (userCredits.tier === 'free') {
            freeDocStatus.classList.remove('hidden');
            freeDocUsedStatus.classList.add('hidden');
        } else {
            // Hide for paid tiers
            freeDocStatus.classList.add('hidden');
            freeDocUsedStatus.classList.add('hidden');
        }
    }
    
    // Update prompts remaining
    if (userCredits.tier === 'free') {
        const remaining = getRemainingPrompts();
        document.getElementById('modalPromptsRemaining').textContent = `${remaining}/${CONFIG.CREDITS.FREE_TIER.MONTHLY_PROMPTS} prompts remaining`;
    } else {
        document.getElementById('modalPromptsRemaining').textContent = 'Unlimited prompts';
    }
    
    // Reset free docs dropdown state
    const freeDocsDropdown = document.getElementById('freeDocsDropdown');
    const freeDocsChevron = document.getElementById('freeDocsChevron');
    if (freeDocsDropdown) freeDocsDropdown.classList.add('hidden');
    if (freeDocsChevron) freeDocsChevron.classList.remove('rotate-180');
    
    document.getElementById('creditsModal').classList.remove('hidden');
}

/**
 * Close the credits modal
 */
function closeCreditsModal() {
    document.getElementById('creditsModal').classList.add('hidden');
}

/**
 * Open the prompt limit modal (shown when free user hits 20 prompts)
 */
function openPromptLimitModal() {
    document.getElementById('promptLimitModal').classList.remove('hidden');
}

/**
 * Close the prompt limit modal
 */
function closePromptLimitModal() {
    document.getElementById('promptLimitModal').classList.add('hidden');
}

/**
 * Open the consultation booking modal
 */
function openConsultationBookingModal(preselectedType = null) {
    // Reset state
    selectedConsultation = null;
    selectedMeetingType = null;
    
    // Reset all button states
    document.querySelectorAll('.consultation-type-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'border-2', 'bg-slate-700');
        btn.classList.add('border-slate-600');
    });
    
    document.querySelectorAll('.meeting-type-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'border-2', 'bg-slate-700');
        btn.classList.add('border-slate-600');
    });
    
    // Show step 1, hide others
    document.getElementById('bookingStep1').classList.remove('hidden');
    document.getElementById('bookingStep2').classList.add('hidden');
    document.getElementById('bookingStep3').classList.add('hidden');
    
    // Show modal
    document.getElementById('consultationBookingModal').classList.remove('hidden');
    
    // If preselected type, auto-select it
    if (preselectedType && CONSULTATION_TYPES[preselectedType]) {
        setTimeout(() => selectConsultationType(preselectedType), 100);
    }
}

/**
 * Close consultation booking modal
 */
function closeConsultationBookingModal() {
    document.getElementById('consultationBookingModal').classList.add('hidden');
    
    // Clean up any Calendly widget
    const calendlyContainer = document.getElementById('calendlyContainer');
    if (calendlyContainer) {
        calendlyContainer.innerHTML = `
            <div id="calendlyPlaceholder" class="flex items-center justify-center bg-slate-100" style="height: 650px;">
                <div class="text-center">
                    <div class="animate-spin text-4xl mb-4">â³</div>
                    <p class="text-slate-600">Loading calendar...</p>
                </div>
            </div>
        `;
    }
}

/**
 * Open consultation booking from "Consultation Required" modal
 */
function openConsultationBookingFromRequired() {
    closeConsultationRequiredModal();
    
    // Get the required consultation type from context
    const requiredType = document.getElementById('consultationRequiredModal').dataset.consultationType || 'terminationReview';
    
    openConsultationBookingModal(requiredType);
}

/**
 * Close consultation required modal
 */
function closeConsultationRequiredModal() {
    document.getElementById('consultationRequiredModal').classList.add('hidden');
}

/**
 * Select a consultation type
 */
function selectConsultationType(type) {
    const config = CONSULTATION_TYPES[type];
    if (!config) return;
    
    selectedConsultation = type;
    
    // Update button styles
    document.querySelectorAll('.consultation-type-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'border-2', 'bg-slate-700');
        btn.classList.add('border-slate-600');
    });
    
    // Find and highlight the selected button
    const buttons = document.querySelectorAll('.consultation-type-btn');
    buttons.forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(type)) {
            btn.classList.remove('border-slate-600');
            btn.classList.add('border-purple-500', 'border-2', 'bg-slate-700');
        }
    });
    
    // Move to step 2
    goToStep2();
}

/**
 * Navigate to step 2 (meeting type selection)
 */
function goToStep2() {
    const config = CONSULTATION_TYPES[selectedConsultation];
    if (!config) return;
    
    // Update summary
    document.getElementById('selectedConsultationIcon').textContent = config.icon;
    document.getElementById('selectedConsultationName').textContent = config.name;
    document.getElementById('selectedConsultationIncludes').textContent = config.includes;
    document.getElementById('selectedConsultationCredits').textContent = config.credits;
    
    // Update credit display
    const currentCredits = getTotalCredits();
    const creditsAfter = Math.max(0, currentCredits - config.credits);
    
    document.getElementById('bookingCurrentCredits').textContent = `${currentCredits} credits`;
    document.getElementById('bookingCreditsAfter').textContent = `${creditsAfter} credits`;
    
    // Check if user can afford
    const canAfford = currentCredits >= config.credits;
    
    if (canAfford) {
        document.getElementById('bookingInsufficientCredits').classList.add('hidden');
        document.getElementById('proceedToCalendlyBtn').classList.remove('hidden');
        document.getElementById('proceedToCalendlyBtn').disabled = true; // Enable after meeting type selected
        document.getElementById('bookingCreditsAfter').className = creditsAfter <= 2 ? 'text-red-400 font-bold' : 'text-green-400 font-bold';
    } else {
        document.getElementById('bookingInsufficientCredits').classList.remove('hidden');
        document.getElementById('proceedToCalendlyBtn').classList.add('hidden');
        document.getElementById('bookingCreditsAfter').textContent = 'Not enough credits';
        document.getElementById('bookingCreditsAfter').className = 'text-red-400 font-bold';
    }
    
    // Reset meeting type selection
    selectedMeetingType = null;
    document.querySelectorAll('.meeting-type-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'border-2', 'bg-slate-700');
        btn.classList.add('border-slate-600');
    });
    
    // Switch views
    document.getElementById('bookingStep1').classList.add('hidden');
    document.getElementById('bookingStep2').classList.remove('hidden');
    document.getElementById('bookingStep3').classList.add('hidden');
}

/**
 * Go back to step 1
 */
function goBackToStep1() {
    selectedConsultation = null;
    selectedMeetingType = null;
    
    document.getElementById('bookingStep1').classList.remove('hidden');
    document.getElementById('bookingStep2').classList.add('hidden');
    document.getElementById('bookingStep3').classList.add('hidden');
}

/**
 * Go back to step 2
 */
function goBackToStep2() {
    document.getElementById('bookingStep1').classList.add('hidden');
    document.getElementById('bookingStep2').classList.remove('hidden');
    document.getElementById('bookingStep3').classList.add('hidden');
}

/**
 * Select meeting type (Zoom or Phone)
 */
function selectMeetingType(type) {
    selectedMeetingType = type;
    
    // Update button styles
    document.querySelectorAll('.meeting-type-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'border-2', 'bg-slate-700');
        btn.classList.add('border-slate-600');
    });
    
    const selectedBtn = document.getElementById(type === 'zoom' ? 'meetingTypeZoom' : 'meetingTypePhone');
    if (selectedBtn) {
        selectedBtn.classList.remove('border-slate-600');
        selectedBtn.classList.add('border-purple-500', 'border-2', 'bg-slate-700');
    }
    
    // Enable proceed button
    const proceedBtn = document.getElementById('proceedToCalendlyBtn');
    if (proceedBtn) {
        proceedBtn.disabled = false;
    }
}

/**
 * Get credits from booking flow (save state and open credits modal)
 */
function getCreditsFromBooking() {
    // Save booking state to localStorage so we can restore after purchase
    const bookingState = {
        consultationType: selectedConsultation,
        meetingType: selectedMeetingType,
        timestamp: Date.now()
    };
    localStorage.setItem('pendingConsultationBooking', JSON.stringify(bookingState));
    
    closeConsultationBookingModal();
    openCreditsModal();
}

/**
 * Proceed to Calendly booking
 */
function proceedToCalendly() {
    if (!selectedConsultation || !selectedMeetingType) {
        showNotification('Please select a meeting type', 'error');
        return;
    }
    
    const config = CONSULTATION_TYPES[selectedConsultation];
    if (!config) return;
    
    // Check credits one more time
    if (getTotalCredits() < config.credits) {
        showNotification('Insufficient credits', 'error');
        return;
    }
    
    // Store booking intent for credit deduction after Calendly completes
    const bookingIntent = {
        consultationType: selectedConsultation,
        meetingType: selectedMeetingType,
        credits: config.credits,
        timestamp: Date.now()
    };
    localStorage.setItem('pendingCalendlyBooking', JSON.stringify(bookingIntent));
    
    // Move to step 3
    document.getElementById('bookingStep1').classList.add('hidden');
    document.getElementById('bookingStep2').classList.add('hidden');
    document.getElementById('bookingStep3').classList.remove('hidden');
    
    // Load Calendly
    loadCalendlyWidget();
}

/**
 * Load Calendly inline widget
 */
function loadCalendlyWidget() {
    const container = document.getElementById('calendlyContainer');
    if (!container) return;
    
    const config = CONSULTATION_TYPES[selectedConsultation];
    if (!config) return;
    
    // Build Calendly URL
    const eventSlug = selectedMeetingType === 'zoom' ? CALENDLY_CONFIG.events.zoom : CALENDLY_CONFIG.events.phone;
    const calendlyUrl = `${CALENDLY_CONFIG.baseUrl}/${eventSlug}`;
    
    // Prefill user data if available
    const prefillData = {};
    if (currentUser?.email) {
        prefillData.email = currentUser.email;
    }
    if (currentUser?.displayName) {
        prefillData.name = currentUser.displayName;
    }
    
    // Build prefill query string
    const prefillParams = new URLSearchParams();
    if (prefillData.email) prefillParams.set('email', prefillData.email);
    if (prefillData.name) prefillParams.set('name', prefillData.name);
    
    const fullUrl = prefillParams.toString() ? `${calendlyUrl}?${prefillParams.toString()}` : calendlyUrl;
    
    // Check if Calendly script is loaded
    if (typeof Calendly !== 'undefined') {
        container.innerHTML = '';
        Calendly.initInlineWidget({
            url: fullUrl,
            parentElement: container,
            prefill: prefillData,
            utm: {
                utmSource: 'fitz-hr-app',
                utmMedium: 'consultation-booking',
                utmCampaign: selectedConsultation
            }
        });
    } else {
        // Show manual booking fallback
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center bg-slate-100 rounded-xl p-6" style="height: 650px;">
                <div class="text-5xl mb-4">ðŸ“…</div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Book Your Consultation</h3>
                <p class="text-slate-600 text-center mb-6">Click the button below to select your preferred time slot.</p>
                <a href="${fullUrl}" target="_blank" rel="noopener noreferrer"
                   onclick="handleCalendlyRedirect()"
                   class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-xl transition-all inline-flex items-center gap-2">
                    <span>ðŸ“…</span>
                    <span>Open Calendar</span>
                </a>
                <p class="text-slate-500 text-sm mt-4">
                    ${config.credits} credits will be deducted when you confirm your booking
                </p>
            </div>
        `;
    }
}

/**
 * Handle Calendly redirect (for fallback mode)
 */
function handleCalendlyRedirect() {
    showNotification('Complete your booking in the new tab. Credits will be deducted upon confirmation.', 'info');
}

/**
 * Handle Calendly event scheduled (called via Calendly webhook or postMessage)
 */
function handleCalendlyEventScheduled(eventData) {
    console.log('ðŸ“… Calendly event scheduled:', eventData);
    
    // Get pending booking
    const pendingBooking = localStorage.getItem('pendingCalendlyBooking');
    if (!pendingBooking) return;
    
    try {
        const booking = JSON.parse(pendingBooking);
        
        // Deduct credits
        const config = CONSULTATION_TYPES[booking.consultationType];
        if (config) {
            // Deduct from purchased credits first, then subscription
            if (userCredits.purchasedCredits >= config.credits) {
                userCredits.purchasedCredits -= config.credits;
            } else {
                const remaining = config.credits - userCredits.purchasedCredits;
                userCredits.purchasedCredits = 0;
                userCredits.subscriptionCredits -= remaining;
            }
            
            saveUserCredits();
            
            showNotification(`ðŸŽ‰ Consultation booked! ${config.credits} credits used.`, 'success');
            
            // Add confirmation message to chat
            addMessage('assistant', `## ðŸ“… Consultation Booked!\n\nYour **${config.name}** has been scheduled.\n\n**Meeting type:** ${booking.meetingType === 'zoom' ? 'ðŸ“¹ Zoom Video Call' : 'ðŸ“ž Phone Call'}\n**Credits used:** ${config.credits}\n\nYou'll receive a calendar invite shortly with all the details.\n\n${config.includes}`);
        }
        
        // Clear pending booking
        localStorage.removeItem('pendingCalendlyBooking');
        
        // Close modal
        closeConsultationBookingModal();
        
    } catch (e) {
        console.error('Error processing Calendly booking:', e);
    }
}

// Listen for Calendly events via postMessage
window.addEventListener('message', function(e) {
    if (e.origin === 'https://calendly.com') {
        if (e.data.event && e.data.event === 'calendly.event_scheduled') {
            handleCalendlyEventScheduled(e.data.payload);
        }
    }
});

/**
 * Check for pending consultation booking after credits purchase
 */
function checkPendingConsultationBooking() {
    const pendingBooking = localStorage.getItem('pendingConsultationBooking');
    if (!pendingBooking) return false;
    
    try {
        const booking = JSON.parse(pendingBooking);
        
        // Check if booking is less than 1 hour old
        if (Date.now() - booking.timestamp > 3600000) {
            localStorage.removeItem('pendingConsultationBooking');
            return false;
        }
        
        // Restore booking modal
        localStorage.removeItem('pendingConsultationBooking');
        openConsultationBookingModal(booking.consultationType);
        
        // If meeting type was selected, restore that too
        if (booking.meetingType) {
            setTimeout(() => {
                selectMeetingType(booking.meetingType);
            }, 500);
        }
        
        showNotification('Continue booking your consultation!', 'info');
        return true;
        
    } catch (e) {
        console.error('Error restoring consultation booking:', e);
        localStorage.removeItem('pendingConsultationBooking');
        return false;
    }
}

/**
 * Show consultation required modal for gated documents
 */
function showConsultationRequiredModal(docType) {
    // Determine which consultation is needed
    let consultationType = 'terminationReview';
    let credits = 7;
    
    if (docType === 'terminationLetter' || docType === 'termination') {
        consultationType = 'terminationReview';
        credits = 7;
    } else if (docType === 'redundancy') {
        consultationType = 'redundancyReview';
        credits = 7;
    } else if (docType === 'investigation') {
        consultationType = 'investigationReview';
        credits = 8;
    } else if (docType === 'settlement') {
        consultationType = 'settlementReview';
        credits = 8;
    } else if (docType === 'unfairDismissal') {
        consultationType = 'unfairDismissalResponse';
        credits = 8;
    }
    
    document.getElementById('requiredConsultationCredits').textContent = `${credits} credits`;
    document.getElementById('consultationRequiredModal').classList.remove('hidden');
    
    // Store the doc type for when they proceed
    document.getElementById('consultationRequiredModal').dataset.docType = docType;
    document.getElementById('consultationRequiredModal').dataset.consultationType = consultationType;
}

/**
 * Open document unlock modal
 */
function openDocumentUnlockModal(docType, docName) {
    const cost = CONFIG.CREDITS.DOCUMENT_COSTS[docType];
    if (!cost) return;
    
    const currentBalance = getTotalCredits();
    const balanceAfter = Math.max(0, currentBalance - cost.credits);
    
    document.getElementById('unlockDocumentName').textContent = docName || cost.name;
    document.getElementById('unlockDocumentCost').textContent = `${cost.credits} credit${cost.credits > 1 ? 's' : ''}`;
    document.getElementById('unlockCurrentBalance').textContent = `${currentBalance} credits`;
    document.getElementById('unlockBalanceAfter').textContent = `${balanceAfter} credits`;
    
    // Store doc type for unlock action
    document.getElementById('documentUnlockModal').dataset.docType = docType;
    
    // Check if user can afford
    const canAfford = canAffordDocument(docType);
    
    // Hide all options first
    document.getElementById('unlockFreeDocument').classList.add('hidden');
    document.getElementById('unlockDocumentBtn').classList.add('hidden');
    document.getElementById('unlockNeedMoreCredits').classList.add('hidden');
    
    if (canAfford) {
        // Show paid unlock option
        document.getElementById('unlockDocumentBtn').classList.remove('hidden');
        
        // Update balance after color based on remaining
        const balanceAfterEl = document.getElementById('unlockBalanceAfter');
        if (balanceAfter <= 2) {
            balanceAfterEl.className = 'text-red-400 font-bold';
        } else if (balanceAfter <= 5) {
            balanceAfterEl.className = 'text-amber-400 font-bold';
        } else {
            balanceAfterEl.className = 'text-green-400 font-bold';
        }
    } else {
        // Show need more credits option
        document.getElementById('unlockNeedMoreCredits').classList.remove('hidden');
        document.getElementById('unlockBalanceAfter').textContent = 'Not enough credits';
        document.getElementById('unlockBalanceAfter').className = 'text-red-400 font-bold';
    }
    
    document.getElementById('documentUnlockModal').classList.remove('hidden');
}

/**
 * Close document unlock modal
 */
function closeDocumentUnlockModal() {
    document.getElementById('documentUnlockModal').classList.add('hidden');
}

/**
 * Unlock the document (deduct credits and show full preview)
 */
function unlockDocument() {
    const modal = document.getElementById('documentUnlockModal');
    const docType = modal.dataset.docType;
    
    if (!docType) return;
    
    // Deduct credits
    const success = deductCreditsForDocument(docType);
    
    if (success) {
        closeDocumentUnlockModal();
        
        // Remove blur from document preview
        removeDocumentBlur();
        
        // Show success message
        showNotification('Document unlocked! You can now download it.', 'success');
    } else {
        alert('Failed to deduct credits. Please try again.');
    }
}

/**
 * Show subscription options
 */
function showSubscriptionOptions() {
    // Close any open modals
    closeCreditsModal();
    closePromptLimitModal();
    
    // Open subscription modal
    openSubscriptionModal();
}

/**
 * Open the subscription selection modal
 */
function openSubscriptionModal() {
    document.getElementById('subscriptionModal').classList.remove('hidden');
}

/**
 * Close the subscription modal
 */
function closeSubscriptionModal() {
    document.getElementById('subscriptionModal').classList.add('hidden');
}

/**
 * Initiate Stripe checkout for a subscription
 */
async function purchaseSubscription(tier, billing = 'monthly') {
    const priceKey = `${tier}_${billing}`;
    await initiateStripeCheckout(priceKey);
}

/**
 * Purchase a credit pack via Stripe checkout
 */
async function purchaseCreditPack(size) {
    const priceKeys = {
        'small': 'credits_5',
        'medium': 'credits_10',
        'large': 'credits_20'
    };
    
    const priceKey = priceKeys[size];
    if (!priceKey) return;
    
    await initiateStripeCheckout(priceKey);
    closeCreditsModal();
}

/**
 * Purchase chat top-up via Stripe checkout
 */
async function purchaseChatTopUp() {
    await initiateStripeCheckout('chat_topup');
    closePromptLimitModal();
}

/**
 * Save pending document to localStorage and open credits modal
 * This preserves the document so it can be restored after Stripe redirect
 */
function savePendingDocumentAndGetCredits() {
    // Get the generated document content
    const previewContent = document.getElementById('documentPreviewContent');
    const previewModal = document.getElementById('documentPreviewModal');
    
    if (previewContent && previewModal) {
        const pendingDoc = {
            content: previewContent.innerHTML,
            docType: previewModal.dataset.docType || '',
            docName: previewModal.dataset.docName || 'Document',
            timestamp: Date.now()
        };
        
        console.log('ðŸ“„ Saving pending document:', {
            docType: pendingDoc.docType,
            docName: pendingDoc.docName,
            contentLength: pendingDoc.content.length
        });
        
        localStorage.setItem('pendingDocument', JSON.stringify(pendingDoc));
        console.log('ðŸ“„ Saved pending document for after payment');
    } else {
        console.log('ðŸ“„ ERROR: Could not find previewContent or previewModal');
    }
    
    // Close the unlock modal and document preview
    closeDocumentUnlockModal();
    closeDocumentPreview();
    
    // Open credits modal
    openCreditsModal();
}

/**
 * Restore pending document after payment success
 * Document is shown with blur - user must confirm unlock to spend credits
 */
function restorePendingDocument() {
    const pendingDocStr = localStorage.getItem('pendingDocument');
    console.log('ðŸ“„ restorePendingDocument called, pendingDoc exists:', !!pendingDocStr);
    
    if (!pendingDocStr) return false;
    
    try {
        const pendingDoc = JSON.parse(pendingDocStr);
        console.log('ðŸ“„ Pending document:', pendingDoc.docType, pendingDoc.docName);
        
        // Check if document is less than 1 hour old
        if (Date.now() - pendingDoc.timestamp > 3600000) {
            localStorage.removeItem('pendingDocument');
            return false;
        }
        
        // Show the document preview
        const previewContent = document.getElementById('documentPreviewContent');
        const previewModal = document.getElementById('documentPreviewModal');
        
        if (previewContent && previewModal) {
            previewContent.innerHTML = pendingDoc.content;
            previewModal.dataset.docType = pendingDoc.docType;
            previewModal.dataset.docName = pendingDoc.docName;
            previewModal.classList.remove('hidden');
            
            // Debug: Check credits state
            console.log('ðŸ“„ Current credits:', getTotalCredits());
            console.log('ðŸ“„ Can afford:', pendingDoc.docType ? canAffordDocument(pendingDoc.docType) : 'no docType');
            
            // Always apply blur - user must confirm to unlock
            setTimeout(() => {
                applyDocumentBlur(pendingDoc.docType, pendingDoc.docName);
                
                // If user can now afford it, show helpful notification
                if (pendingDoc.docType && canAffordDocument(pendingDoc.docType)) {
                    showNotification('ðŸŽ‰ You now have enough credits! Click "Unlock Document" to download.', 'success');
                } else {
                    showNotification('Document restored. You still need more credits to unlock.', 'info');
                }
            }, 100);
            
            // Clear the pending document
            localStorage.removeItem('pendingDocument');
            return true;
        }
    } catch (e) {
        console.error('Error restoring pending document:', e);
        localStorage.removeItem('pendingDocument');
    }
    
    return false;
}

/**
 * Core function to initiate Stripe checkout
 */
async function initiateStripeCheckout(priceKey) {
    try {
        showNotification('Redirecting to checkout...', 'info');
        
        // Get user info
        const userKey = currentUser?.uid || currentUser || 'anonymous';
        const userEmail = currentUser?.email || null;
        
        // Determine what's being purchased and store for return
        const purchaseInfo = getPurchaseInfo(priceKey);
        localStorage.setItem('pendingPurchase', JSON.stringify(purchaseInfo));
        
        // Call our Netlify function to create checkout session
        const response = await fetch('/.netlify/functions/stripe-checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                productKey: priceKey,
                userId: userKey,
                userEmail: userEmail,
                successUrl: window.location.origin + '/?payment=success',
                cancelUrl: window.location.origin + '/?payment=cancelled'
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Redirect to Stripe checkout
        if (data.url) {
            window.location.href = data.url;
        } else {
            throw new Error('No checkout URL returned');
        }
        
    } catch (error) {
        console.error('Checkout error:', error);
        localStorage.removeItem('pendingPurchase');
        showNotification('Checkout failed: ' + error.message, 'error');
    }
}

/**
 * Get purchase info for tracking
 */
function getPurchaseInfo(priceKey) {
    const purchaseMap = {
        // Subscriptions
        starter_monthly: { type: 'subscription', tier: 'starter', tierName: 'Starter', credits: 5 },
        starter_annual: { type: 'subscription', tier: 'starter', tierName: 'Starter', credits: 5 },
        professional_monthly: { type: 'subscription', tier: 'professional', tierName: 'Professional', credits: 14 },
        professional_annual: { type: 'subscription', tier: 'professional', tierName: 'Professional', credits: 14 },
        enterprise_monthly: { type: 'subscription', tier: 'enterprise', tierName: 'Enterprise', credits: 25 },
        enterprise_annual: { type: 'subscription', tier: 'enterprise', tierName: 'Enterprise', credits: 25 },
        
        // Credit packs
        credits_5: { type: 'credits', credits: 5 },
        credits_10: { type: 'credits', credits: 10 },
        credits_20: { type: 'credits', credits: 20 },
        
        // Chat top-up
        chat_topup: { type: 'topup', prompts: 30 }
    };
    
    return purchaseMap[priceKey] || { type: 'unknown' };
}

/**
 * Handle payment success/cancel from URL params
 */
function handlePaymentReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const sessionId = urlParams.get('session_id');
    
    if (paymentStatus === 'success') {
        // âœ… Set flag to prevent Firebase from overwriting our local credits
        skipFirebaseCreditsLoad = true;
        
        // Get the pending purchase from localStorage
        const pendingPurchase = localStorage.getItem('pendingPurchase');
        
        if (pendingPurchase) {
            try {
                const purchase = JSON.parse(pendingPurchase);
                
                // Allocate credits based on purchase type
                if (purchase.type === 'subscription') {
                    // Update tier and add initial credits
                    userCredits.tier = purchase.tier;
                    userCredits.subscriptionCredits = purchase.credits;
                    userCredits.lastCreditRefresh = new Date().toISOString(); // Prevent double allocation
                    saveUserCredits();
                    
                    showNotification(`ðŸŽ‰ Welcome to ${purchase.tierName}! ${purchase.credits} credits added.`, 'success');
                    
                } else if (purchase.type === 'credits') {
                    // Add purchased credits (these never expire)
                    userCredits.purchasedCredits += purchase.credits;
                    saveUserCredits();
                    
                    showNotification(`ðŸŽ‰ ${purchase.credits} credits added to your account!`, 'success');
                    
                } else if (purchase.type === 'topup') {
                    // Add bonus prompts
                    userCredits.bonusPrompts = (userCredits.bonusPrompts || 0) + purchase.prompts;
                    saveUserCredits();
                    
                    showNotification(`ðŸŽ‰ ${purchase.prompts} prompts added!`, 'success');
                }
                
                // Clear the pending purchase
                localStorage.removeItem('pendingPurchase');
                
                // âœ… Check if there's a pending document to restore
                const hasPendingDocument = localStorage.getItem('pendingDocument') !== null;
                
                // âœ… Check if there's a pending consultation booking to restore
                const hasPendingConsultation = localStorage.getItem('pendingConsultationBooking') !== null;
                
                setTimeout(() => {
                    const documentRestored = restorePendingDocument();
                    const consultationRestored = checkPendingConsultationBooking();
                    
                    if (!documentRestored && !consultationRestored) {
                        // No pending document or consultation - show normal success message
                        if (purchase.type === 'subscription') {
                            addMessage('assistant', `## ðŸŽ‰ Welcome to Fitz ${purchase.tierName}!\n\nYour subscription is now active!\n\n**Your benefits:**\n- âœ… **${purchase.credits} credits** added to your account\n- âœ… **Unlimited AI chat** (no more prompt limits!)\n- âœ… **Monthly credit refresh** on your billing date\n\nYour credit balance and plan have been updated in the header above.\n\nQuestions? Contact **blake@fitzgeraldhr.com.au**`);
                        } else if (purchase.type === 'credits') {
                            addMessage('assistant', `## ðŸŽ‰ Credits Added!\n\n**${purchase.credits} credits** have been added to your account.\n\nThese credits never expire and can be used for any document type.\n\nYour new balance: **${getTotalCredits()} credits**`);
                        } else if (purchase.type === 'topup') {
                            addMessage('assistant', `## ðŸŽ‰ Chat Top-Up Added!\n\n**${purchase.prompts} extra prompts** have been added to your account for this month.\n\nKeep chatting!`);
                        }
                    }
                }, 500);
                
                // Only refresh from Firebase if there was NO pending document or consultation
                // If there was a pending item, we handle credits locally
                if (!hasPendingDocument && !hasPendingConsultation) {
                    setTimeout(async () => {
                        console.log('ðŸ”„ Refreshing credits from Firebase after payment...');
                        await loadCreditsFromFirebase();
                    }, 3000);
                } else {
                    console.log('ðŸ“„ Skipping delayed Firebase refresh - pending item was restored');
                    // Instead, sync our local credits TO Firebase
                    setTimeout(async () => {
                        console.log('ðŸ“„ Syncing local credits to Firebase...');
                        await syncCreditsToFirebase();
                    }, 1000);
                }
                
            } catch (e) {
                console.error('Error processing payment return:', e);
                showNotification('Payment successful! Please refresh if credits don\'t appear.', 'success');
                
                // Check if there's a pending document BEFORE restoring
                const hadPendingDoc = localStorage.getItem('pendingDocument') !== null;
                
                // Try to restore pending document anyway
                setTimeout(() => {
                    restorePendingDocument();
                }, 500);
                
                // Only load from Firebase if there was no pending document
                if (!hadPendingDoc) {
                    setTimeout(async () => {
                        await loadCreditsFromFirebase();
                    }, 3000);
                }
            }
        } else {
            // No pending purchase found - might be a page refresh, try loading from Firebase
            showNotification('ðŸŽ‰ Payment successful!', 'success');
            
            // Check if there's a pending document BEFORE restoring
            const hadPendingDoc = localStorage.getItem('pendingDocument') !== null;
            
            // Try to restore pending document
            setTimeout(() => {
                restorePendingDocument();
            }, 500);
            
            // Only load from Firebase if there was no pending document
            if (!hadPendingDoc) {
                setTimeout(async () => {
                    console.log('ðŸ”„ No pending purchase found, refreshing from Firebase...');
                    await loadCreditsFromFirebase();
                }, 2000);
            }
        }
        
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    if (paymentStatus === 'cancelled') {
        // Clear pending purchase on cancel but keep pending document
        localStorage.removeItem('pendingPurchase');
        showNotification('Payment cancelled', 'info');
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Restore the document preview so user can try again
        setTimeout(() => {
            restorePendingDocument();
        }, 500);
    }
}

// Check for payment return on page load
document.addEventListener('DOMContentLoaded', handlePaymentReturn);

/**
 * Show notification toast
 */
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-full opacity-0`;
    
    if (type === 'success') {
        notification.classList.add('bg-green-600', 'text-white');
    } else if (type === 'error') {
        notification.classList.add('bg-red-600', 'text-white');
    } else {
        notification.classList.add('bg-slate-700', 'text-white');
    }
    
    notification.innerHTML = `<span>${message}</span>`;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-y-full', 'opacity-0');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ========================================
// DOCUMENT BLUR (Preview & Unlock)
// ========================================

/**
 * Apply blur to document preview (for unpaid documents)
 * Shows first ~25-30 lines clearly, then blurs the rest
 * @param {string} docType - Document type for unlock modal
 * @param {string} docName - Document name for display
 */
function applyDocumentBlur(docType, docName) {
    const previewContent = document.getElementById('documentPreviewContent');
    if (!previewContent) return;
    
    // Store docType in the preview modal for the unlock button
    const previewModal = document.getElementById('documentPreviewModal');
    if (previewModal) {
        previewModal.dataset.docType = docType || '';
        previewModal.dataset.docName = docName || 'Document';
    }
    
    // Make preview container relative for absolute positioning
    const previewContainer = previewContent.parentElement;
    previewContainer.style.position = 'relative';
    previewContainer.style.overflow = 'hidden';
    
    // Calculate visible area - approximately 25-30 lines (around 450px)
    const visibleHeight = 450;
    
    // Create blur overlay that starts AFTER the visible preview area
    const blurOverlay = document.createElement('div');
    blurOverlay.id = 'documentBlurOverlay';
    blurOverlay.style.cssText = `
        position: absolute;
        top: ${visibleHeight}px;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, 
            rgba(255,255,255,0) 0%,
            rgba(255,255,255,0.7) 30px,
            rgba(255,255,255,0.95) 80px,
            rgba(255,255,255,1) 150px
        );
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        pointer-events: none;
        z-index: 5;
    `;
    previewContainer.appendChild(blurOverlay);
    
    // Add a gradient fade at the transition point for smoother effect
    const fadeGradient = document.createElement('div');
    fadeGradient.id = 'documentFadeGradient';
    fadeGradient.style.cssText = `
        position: absolute;
        top: ${visibleHeight - 50}px;
        left: 0;
        right: 0;
        height: 100px;
        background: linear-gradient(to bottom, 
            rgba(255,255,255,0) 0%,
            rgba(255,255,255,0.3) 50%,
            rgba(255,255,255,0.6) 100%
        );
        pointer-events: none;
        z-index: 4;
    `;
    previewContainer.appendChild(fadeGradient);
    
    // Get the cost for this document type
    const cost = CONFIG.CREDITS.DOCUMENT_COSTS[docType];
    const creditCost = cost ? cost.credits : 1;
    const currentBalance = getTotalCredits();
    
    // Determine button text and subtitle
    let buttonText = `Unlock Document (${creditCost} credit${creditCost > 1 ? 's' : ''})`;
    let subtitle = `Your balance: ${currentBalance} credits`;
    
    if (currentBalance < creditCost) {
        buttonText = 'Get Credits to Unlock';
        subtitle = `Need ${creditCost} credits â€¢ You have ${currentBalance}`;
    }
    
    // Add unlock prompt - positioned in the blurred area
    const unlockPrompt = document.createElement('div');
    unlockPrompt.id = 'documentUnlockPrompt';
    unlockPrompt.style.cssText = `
        position: absolute;
        top: ${visibleHeight + 80}px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        text-align: center;
    `;
    unlockPrompt.innerHTML = `
        <div class="bg-slate-800 border-2 border-amber-500 rounded-xl p-6 shadow-2xl">
            <div class="text-4xl mb-3">ðŸ”’</div>
            <h3 class="text-xl font-bold text-white mb-2">Preview Only</h3>
            <p class="text-slate-300 text-sm mb-4">Confirm to unlock and download this document.</p>
            <button onclick="openDocumentUnlockModal('${docType}', '${docName}')" 
                    class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 px-6 rounded-lg transition-all">
                ${buttonText}
            </button>
            <p class="text-slate-400 text-xs mt-3">${subtitle}</p>
        </div>
    `;
    previewContainer.appendChild(unlockPrompt);
    
    // Disable download buttons while blurred
    const downloadBtns = document.querySelectorAll('#documentPreviewModal button[onclick*="download"]');
    downloadBtns.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.title = 'Unlock document to download';
    });
}

/**
 * Remove blur from document preview
 */
function removeDocumentBlur() {
    const blurOverlay = document.getElementById('documentBlurOverlay');
    const fadeGradient = document.getElementById('documentFadeGradient');
    const unlockPrompt = document.getElementById('documentUnlockPrompt');
    
    if (blurOverlay) blurOverlay.remove();
    if (fadeGradient) fadeGradient.remove();
    if (unlockPrompt) unlockPrompt.remove();
    
    // Re-enable download buttons
    const downloadBtns = document.querySelectorAll('#documentPreviewModal button[onclick*="download"]');
    downloadBtns.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.title = '';
    });
}

/**
 * Check if document should be blurred (user hasn't paid)
 */
function shouldBlurDocument(docType) {
    // ALWAYS blur documents - user must confirm they want to spend credits
    // The unlock modal will handle checking if they can afford it
    return true;
}

// ========================================
// CONSULTATION-GATED DOCUMENT CHECK
// ========================================

/**
 * Check if a document type requires consultation
 */
function isConsultationGated(docType) {
    const gatedTypes = [
        'terminationLetter',
        'termination',
        'redundancy',
        'redundancyLetter',
        'investigation',
        'investigationReport',
        'settlement',
        'deedOfSettlement',
        'unfairDismissal',
        'unfairDismissalResponse'
    ];
    
    return gatedTypes.includes(docType);
}

/**
 * Handle attempt to generate a consultation-gated document
 */
function handleConsultationGatedDocument(docType) {
    showConsultationRequiredModal(docType);
    return false; // Prevent normal flow
}


async function downloadGeneratedDocument(format = 'pdf') {
    const docType = documentBuilderState.currentType;
    
    // âœ… CHECK IF DOCUMENT IS BLURRED (needs unlock)
    const blurOverlay = document.getElementById('documentBlurOverlay');
    if (blurOverlay) {
        // Document is locked - show unlock modal instead
        openDocumentUnlockModal(docType, CONFIG.CREDITS.DOCUMENT_COSTS[docType]?.name || 'Document');
        return false;
    }
    
    // âœ… DEDUCT CREDITS ON FIRST DOWNLOAD
    const downloadKey = `doc_downloaded_${documentBuilderState.lastGeneratedDocId}`;
    const alreadyDownloaded = sessionStorage.getItem(downloadKey);
    
    if (!alreadyDownloaded && CONFIG.CREDITS.DOCUMENT_COSTS[docType]) {
        // First download - deduct credits
        const success = deductCreditsForDocument(docType);
        if (success) {
            sessionStorage.setItem(downloadKey, 'true');
            showNotification(`${CONFIG.CREDITS.DOCUMENT_COSTS[docType].credits} credit(s) deducted`, 'info');
        }
    }
    
    // âœ… CRITICAL: Confirmation dialog before download
    const userAccepts = confirm(
        "âš ï¸ CRITICAL LEGAL REMINDER\n\n" +
        "This document is a DRAFT TEMPLATE for review purposes only.\n\n" +
        "Before issuing this document to any employee, you MUST:\n\n" +
        "âœ“ Have it reviewed by a Fitzgerald HR consultant\n" +
        "âœ“ Ensure all factual details are accurate\n" +
        "âœ“ Verify it meets your specific circumstances\n" +
        "âœ“ Confirm it complies with current Fair Work requirements\n\n" +
        "LEGAL WARNING:\n" +
        "Using this document without professional review may expose you to:\n" +
        "â€¢ Unfair dismissal claims ($50,000+ in damages)\n" +
        "â€¢ General protections claims\n" +
        "â€¢ Adverse action penalties\n" +
        "â€¢ Legal costs and compensation\n\n" +
        "Contact: info@fitzgeraldhr.com.au | +61 400 211 014\n\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" +
        "By clicking OK, you acknowledge:\n" +
        "â€¢ This is a draft template requiring professional review\n" +
        "â€¢ You will NOT use it without consultant approval\n" +
        "â€¢ You understand the legal risks of non-compliance\n\n" +
        "Click OK to download for review, or Cancel to return."
    );
    
    if (!userAccepts) {
        trackEvent('document_download_cancelled_at_confirmation', {
            user: currentUser,
            documentType: documentBuilderState.currentType,
            format: format,
            reason: 'did_not_accept_legal_terms'
        });
        return false;
    }
    
    trackEvent('document_download_legal_terms_accepted', {
        user: currentUser,
        documentType: documentBuilderState.currentType,
        format: format
    });    

    try {
        const type = documentBuilderState.currentType;
        const employeeName = documentBuilderState.data.employeeName || 'Employee';
        
        const typeNames = {
            formalWarning: 'Formal_Warning',
            recordOfDiscussion: 'Record_of_Discussion',
            letterOfAllegation: 'Letter_of_Allegation',
            performanceImprovementPlan: 'Performance_Improvement_Plan'
        };
        
        const fileExtension = format === 'pdf' ? 'pdf' : 'docx';
        const filename = `${typeNames[type]}_${employeeName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.${fileExtension}`;
        
        const metadata = {
            documentId: generateDocumentId(),
            userName: currentUser,
            generatedAt: new Date().toISOString(),
            documentType: type,
            employeeName: employeeName,
            format: format
        };
        
        // Get the FORMATTED HTML from the preview
        const previewElement = document.getElementById('documentPreviewContent');
        
        if (!previewElement) {
            throw new Error('Preview content not found');
        }
        
        const formattedHTML = previewElement.innerHTML;
        
        let success = false;
        
        if (format === 'pdf') {
            // Generate PDF
            const docDefinition = convertHTMLToPdfMake(formattedHTML, metadata);
            
            if (typeof pdfMake === 'undefined') {
                throw new Error('pdfMake not loaded');
            }
            
            pdfMake.createPdf(docDefinition).download(filename);
            success = true;
            
        } else if (format === 'docx') {
            // Generate Word document
            success = await generateWordDocument(formattedHTML, filename, metadata);
        }
        
        if (!success) {
            throw new Error(`Failed to generate ${format.toUpperCase()}`);
        }
        
        // Track generation
        trackDocumentGeneration(filename, metadata);
        
        // âœ… CRITICAL: Log the download and update database
        await logDocumentDownload(metadata);
        
        closeDocumentPreview();
        
        showAlert(
            `âœ… ${format.toUpperCase()} Document Downloaded!\n\n` +
            'CRITICAL REMINDERS:\n' +
            '1. This is a DRAFT document\n' +
            '2. MUST be reviewed by a consultant\n' +
            '3. Do not issue without professional review\n\n' +
            'Contact: info@fitzgeraldhr.com.au'
        );
        
        return true;
        
    } catch (error) {
        showAlert(`Download failed: ${error.message}`);
        return false;
    }
}

/**
 * Generates a Word document (.docx) from HTML content
 * Robust version with corruption prevention
 * @param {string} htmlContent - HTML content to convert
 * @param {string} filename - Output filename
 * @param {Object} metadata - Document metadata
 * @returns {Promise<boolean>} True if successful
 */
async function generateWordDocument(htmlContent, filename, metadata = {}) {
    try {
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'word-loading';
        loadingDiv.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[9999]';
        loadingDiv.innerHTML = `
            <div class="bg-slate-800 rounded-2xl border-2 border-amber-500 p-8 text-center max-w-md">
                <div class="text-6xl mb-4 animate-bounce">ðŸ“</div>
                <p class="text-white font-bold text-xl mb-2">Generating Word Document</p>
                <p class="text-slate-400 text-sm mb-4">Creating professional .docx file...</p>
                <div class="flex justify-center gap-2">
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-500 text-xs mt-4">This usually takes 3-5 seconds</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        // Call Netlify function
        const response = await fetch('/.netlify/functions/generate-word', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                html: htmlContent,
                metadata: {
                    documentId: metadata.documentId || generateDocumentId(),
                    userName: metadata.userName || currentUser,
                    filename: filename,
                    generatedAt: new Date().toISOString()
                }
            })
        });
        
        // Remove loading indicator
        loadingDiv.remove();
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
        // Get the Word document as a blob
        const blob = await response.blob();
        if (blob.size === 0) {
            throw new Error('Received empty document from server');
        }
        
        // Download it
        saveAs(blob, filename);
        
        return true;
        
    } catch (error) {
        showAlert(
            'âš ï¸ Error Generating Word Document\n\n' +
            error.message + '\n\n' +
            'Please try again or download as PDF instead.\n' +
            'Contact support if this persists: info@fitzgeraldhr.com.au'
        );
        
        return false;
    }
}

/**
 * Cleans HTML content to prevent Word document corruption
 * Removes problematic elements and attributes
 */
function cleanHTMLForWord(html) {
    // Parse HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Remove all class attributes (Tailwind causes issues)
    doc.querySelectorAll('[class]').forEach(el => {
        el.removeAttribute('class');
    });
    
    // Remove all style attributes
    doc.querySelectorAll('[style]').forEach(el => {
        el.removeAttribute('style');
    });
    
    // Remove data attributes
    doc.querySelectorAll('[data-*]').forEach(el => {
        Array.from(el.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
                el.removeAttribute(attr.name);
            }
        });
    });
    
    // Remove script tags
    doc.querySelectorAll('script').forEach(el => el.remove());
    
    // Remove SVG elements
    doc.querySelectorAll('svg').forEach(el => el.remove());
    
    // Remove problematic divs - replace with semantic tags
    doc.querySelectorAll('div').forEach(div => {
        const p = doc.createElement('p');
        p.innerHTML = div.innerHTML;
        div.replaceWith(p);
    });
    
    // Remove span tags but keep content
    doc.querySelectorAll('span').forEach(span => {
        const text = doc.createTextNode(span.textContent);
        span.replaceWith(text);
    });
    
    // Remove empty paragraphs
    doc.querySelectorAll('p').forEach(p => {
        if (!p.textContent.trim()) {
            p.remove();
        }
    });
    
    // Get cleaned body content
    const cleaned = doc.body.innerHTML;
    
    return cleaned;
}

async function logDocumentGeneration() {
    // Validate that we have the required data
    if (!documentBuilderState.currentType) {
        return null;
    }
    
    const log = {
        document_id: generateDocumentId(),
        user_code: currentUser,
        document_type: documentBuilderState.currentType,
        employee_name: documentBuilderState.data.employeeName || 'Unknown',
        generated_at: new Date().toISOString(),
        downloaded: false,
        format: null, // âœ… Will be set on download
        venue_name: venueProfile.venueName || null,
        venue_location: venueProfile.location || null,
        venue_city: venueProfile.city || null,
        venue_type: venueProfile.venueType || null
    };
    
    // Store in localStorage as backup
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    const logs = JSON.parse(localStorage.getItem('documentLogs_' + userKey) || '[]');
    logs.push(log);
    localStorage.setItem('documentLogs_' + userKey, JSON.stringify(logs));
    // Store in Supabase
    if (supabaseClient) {
        try {
            const { data, error } = await supabaseClient
                .from('generated_documents')
                .insert([log])
                .select(); // âœ… This returns the inserted record including its ID
            
            if (error) {
                return null;
            } else {
                // âœ… Return the inserted record (includes database ID)
                return data[0];
            }
        } catch (err) {
            return null;
        }
    } else {
        return null;
    }
}

// Log document download
/**
 * Logs document download with format tracking
 * @param {Object} metadata - Document metadata including format
 */
async function logDocumentDownload(metadata) {
    if (!supabaseClient) {
        return;
    }
    
    if (!documentBuilderState.lastGeneratedDocId) {
        return;
    }
    
    try {
        // âœ… Update with format information
        const { data: updateData, error: updateError } = await supabaseClient
            .from('generated_documents')
            .update({ 
                downloaded: true, 
                downloaded_at: new Date().toISOString(),
                format: metadata.format || 'pdf' // âœ… Track format (pdf or docx)
            })
            .eq('id', documentBuilderState.lastGeneratedDocId)
            .select();
        
        if (updateError) {
        } else {
            // Clear the stored ID after successful update
            documentBuilderState.lastGeneratedDocId = null;
        }
        
    } catch (err) {
    }
    
    // Track event with format
    trackEvent('document_downloaded', {
        user: currentUser,
        format: metadata.format || 'pdf',
        documentType: metadata.documentType
    });
}

	// ========================================
	// DAILY TIPS SYSTEM
	// ========================================

const dailyTips = [
    { icon: "ðŸ’¡", tip: "Did you know? You must give 30-min breaks for shifts over 5 hours" },
    { icon: "âš ï¸", tip: "Award rates increase on 1 July each year - mark your calendar!" },
    { icon: "ðŸ“", tip: "Always document performance conversations in writing" },
    { icon: "ðŸ•’", tip: "Casuals must be paid within 7 days of completing their shift" },
    { icon: "ðŸ“‹", tip: "Keep employment records for 7 years minimum - it's the law" },
    { icon: "âš–ï¸", tip: "Unfair dismissal claims must be lodged within 21 days" },
    { icon: "ðŸ’°", tip: "Casual loading is 25% on top of permanent rates" },
    { icon: "ðŸ”„", tip: "Regular casuals may request conversion to permanent after 12 months" },
    { icon: "ðŸ“…", tip: "Public holidays require 2.5x pay or time off in lieu" },
    { icon: "âœï¸", tip: "Use written employment contracts for all staff - avoid disputes" },
    { icon: "ðŸš¨", tip: "Document workplace incidents immediately while details are fresh" },
    { icon: "ðŸ“ž", tip: "Return employee calls within 24 hours during disputes" },
    { icon: "â°", tip: "Minimum shift length is usually 3 hours for casual employees" },
    { icon: "ðŸŽ“", tip: "Provide a Fair Work Information Statement to all new employees" },
    { icon: "ðŸ’¼", tip: "Probation periods are typically 3-6 months - put it in writing" },
    { icon: "ðŸ”", tip: "Store employee personal information securely - privacy laws apply" },
    { icon: "ðŸ“Š", tip: "Review your payroll monthly - catch errors before they compound" },
    { icon: "ðŸ¤", tip: "Consider offering unpaid trial shifts (max 1-2 hours for assessment)" },
    { icon: "ðŸŒŸ", tip: "Recognize good performance regularly - it reduces turnover" },
    { icon: "ðŸ“±", tip: "Use the tools menu (ðŸ› ï¸) to access specialised calculators" }
];

let currentDailyTipIndex = -1; // Start at -1 so first call gets index 0

function getDailyTip() {
    // Get tip based on day of month for consistency
    const today = new Date().getDate();
    return dailyTips[today % dailyTips.length];
}

function updateDailyTipBanner() {
    const tipElement = document.getElementById('dailyTipContent');
    const iconElement = document.getElementById('dailyTipIcon');
    
    if (!tipElement || !iconElement) return;
    
    const tipData = getDailyTip();
    
    // Fade out
    const banner = document.getElementById('dailyTipBanner');
    if (banner) {
        banner.style.transition = 'opacity 0.3s ease-out';
        banner.style.opacity = '0.7';
    }
    
    setTimeout(() => {
        iconElement.textContent = tipData.icon;
        tipElement.textContent = tipData.tip;
        
        // Fade in
        if (banner) {
            banner.style.opacity = '1';
        }
    }, 300);
}

function rotateTipManually() {
    // Cycle to next tip
    currentDailyTipIndex = (currentDailyTipIndex + 1) % dailyTips.length;
    
    const tipElement = document.getElementById('dailyTipContent');
    const iconElement = document.getElementById('dailyTipIcon');
    const banner = document.getElementById('dailyTipBanner');
    
    if (!tipElement || !iconElement || !banner) return;
    
    const tipData = dailyTips[currentDailyTipIndex];
    
    // Fade out
    banner.style.transition = 'opacity 0.3s ease-out';
    banner.style.opacity = '0.7';
    
    setTimeout(() => {
        iconElement.textContent = tipData.icon;
        tipElement.textContent = tipData.tip;
        
        // Fade in
        banner.style.opacity = '1';
    }, 300);
    
    trackEvent('daily_tip_rotated', { 
        user: currentUser, 
        tipIndex: currentDailyTipIndex 
    });
}

// Auto-rotate tips every 30 seconds
function startDailyTipRotation() {
    setInterval(() => {
        rotateTipManually();
    }, 30000); // 30 seconds
}
        
        // 2. Multi-page document generation
        function generateMultiPageDocument(sections, filename, metadata = {}) {
            let fullContent = '';
            
            sections.forEach((section, index) => {
                fullContent += section.content;
                
                // Add page break between sections (for PDF/Word)
                if (index < sections.length - 1) {
                    fullContent += '<div style="page-break-after: always;"></div>';
                }
            });
            
            generateWordDocument(fullContent, filename, metadata);
        }
        
        // Example usage for complex documents:
        // generateMultiPageDocument([
        //     { content: hrTemplates.employmentContract(data), title: 'Employment Contract' },
        //     { content: generatePolicySection(data), title: 'Workplace Policies' },
        //     { content: generateBenefitsSection(data), title: 'Benefits Summary' }
        // ], 'Complete_Employment_Package.doc');

// ========================================
// ACCESS CONTROL
// ========================================
/**
 * Validates user access code and grants entry to assistant
 * Shows error message if code is invalid
 * @returns {void}
 */
function checkAccess() {
    const input = document.getElementById('accessCodeInput').value.trim().toUpperCase();
    const error = document.getElementById('accessError');
    
    // Direct DOM access instead of cache
    const accessScreen = document.getElementById('accessScreen');
    const assistantScreen = document.getElementById('assistantScreen');
    const userCodeEl = document.getElementById('userCode');
    
    if (CONFIG.VALID_CODES.includes(input)) {
    // âœ… STORE ACCESS CODE IN LOCALSTORAGE (only if "Remember Me" is checked)
    const rememberMe = document.getElementById('rememberMe')?.checked ?? true;
    
    if (rememberMe) {
        localStorage.setItem('fitzhr_access_code', input);
        localStorage.setItem('fitzhr_last_login', new Date().toISOString());
    } else {
    }
        
        // Continue with normal login process
        currentUser = input;
        if (userCodeEl) userCodeEl.textContent = input;
        if (accessScreen) accessScreen.classList.add('hidden');
        if (assistantScreen) assistantScreen.classList.remove('hidden');
        if (error) error.classList.add('hidden');
        
        trackEvent('beta_access', { code: input });
        
        // Admin access is now email-based only (via Google Sign-In)
        
        // âœ… SHOW LEGAL ACCEPTANCE MODAL FIRST
        // The modal function will check if already accepted and handle the flow
        setTimeout(async () => {
            const legalModalShown = await showLegalAcceptanceModal();
            
            // If legal modal was NOT shown (already accepted), check onboarding
            if (!legalModalShown) {
                const hasCompletedOnboarding = checkOnboardingStatus();
                if (!hasCompletedOnboarding) {
                    setTimeout(() => showOnboarding(), 500);
                } else {
                    // LOAD CONVERSATIONS FIRST, THEN RESTORE (like Claude.ai)
                    loadConversations(); // Load from localStorage
                    setTimeout(() => {
                        restoreLastConversation();
                        updateSidebarChats();
                    }, 300);
                }
            }
            // If legal modal WAS shown, acceptLegalTerms() will handle onboarding after acceptance
        }, 500);

        // Initialize and start daily tip rotation
        setTimeout(() => {
            updateDailyTipBanner();
            startDailyTipRotation();
        }, 500);
        
    } else {
        error.textContent = 'Invalid access code. Please check and try again.';
        error.classList.remove('hidden');
        
        // âŒ CLEAR ANY STORED CODE IF INVALID ATTEMPT
        localStorage.removeItem('fitzhr_access_code');
    }
}

/**
 * Attempts to auto-login user with stored access code
 * Called on page load to provide seamless experience
 * @returns {boolean} True if auto-login successful, false otherwise
 */
function attemptAutoLogin() {
    // âœ… SKIP IF GOOGLE AUTH IS ACTIVE - Firebase will handle the login
    const googleAuth = localStorage.getItem('fitzhr_google_auth');
    if (googleAuth === 'true') {
        return false; // Let Firebase auth handler take over
    }
    
    const storedCode = localStorage.getItem('fitzhr_access_code');
    const lastLogin = localStorage.getItem('fitzhr_last_login');
    
    if (!storedCode) {
        return false;
    }
    
    // Optional: Check if code is still valid (hasn't expired)
    // For now, codes don't expire, but you could add expiry logic here
    if (lastLogin) {
        const lastLoginDate = new Date(lastLogin);
        const daysSinceLogin = (new Date() - lastLoginDate) / (1000 * 60 * 60 * 24);
        
        // Optional: Expire codes after 30 days of inactivity
        if (daysSinceLogin > 30) {
            localStorage.removeItem('fitzhr_access_code');
            localStorage.removeItem('fitzhr_last_login');
            return false;
        }
    }
    
    // Verify code is still in valid codes list
    if (!CONFIG.VALID_CODES.includes(storedCode)) {
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
        return false;
    }
    
    // Perform automatic login
    const accessScreen = document.getElementById('accessScreen');
    const assistantScreen = document.getElementById('assistantScreen');
    const userCodeEl = document.getElementById('userCode');
    
    currentUser = storedCode;
    if (userCodeEl) userCodeEl.textContent = storedCode;
    if (accessScreen) accessScreen.classList.add('hidden');
    if (assistantScreen) assistantScreen.classList.remove('hidden');
    
    // Update last login timestamp
    localStorage.setItem('fitzhr_last_login', new Date().toISOString());
    
    // Admin access is now email-based only (via Google Sign-In)
    
    // Load conversations first
    loadConversations();
    
    // âœ… CHECK LEGAL ACCEPTANCE FIRST, THEN ONBOARDING
    setTimeout(async () => {
        const legalModalShown = await showLegalAcceptanceModal();
        
        // If legal modal was NOT shown (already accepted), check onboarding
        if (!legalModalShown) {
            const hasCompletedOnboarding = checkOnboardingStatus();
            if (!hasCompletedOnboarding) {
                setTimeout(() => showOnboarding(), 500);
            } else {
                // RESTORE LAST CONVERSATION (like Claude.ai)
                setTimeout(() => {
                    restoreLastConversation();
                    updateSidebarChats();
                }, 300);
            }
        }
        // If legal modal WAS shown, acceptLegalTerms() handles onboarding after acceptance
    }, 500);

    // Initialize and start daily tip rotation
    setTimeout(() => {
        updateDailyTipBanner();
        startDailyTipRotation();
    }, 500);
    
    // Track auto-login
    trackEvent('auto_login', { 
        code: storedCode,
        daysSinceLastLogin: lastLogin ? Math.floor((new Date() - new Date(lastLogin)) / (1000 * 60 * 60 * 24)) : null
    });
    
    return true;
}

// ========================================
// MESSAGING SYSTEM
// ========================================
/**
 * Sends user message to AI and displays response
 * Handles conversation history and UI updates
 * @returns {Promise<void>}
 */
async function sendMessage() {
    const input = DOM.messageInput;
    const message = input.value.trim();
    
    if (!message) return;
    
    // âœ… CHECK LEGAL TERMS ACCEPTANCE FIRST
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    const hasAcceptedTerms = localStorage.getItem('legalTermsAccepted_' + userKey) === 'true';
    if (!hasAcceptedTerms) {
        // Show legal acceptance modal
        const modalShown = await showLegalAcceptanceModal();
        if (modalShown) {
            // Modal was shown, don't proceed with message
            return;
        }
    }
    
    // âœ… CHECK PROMPT LIMIT FOR FREE TIER
    if (!hasPromptsRemaining()) {
        openPromptLimitModal();
        return;
    }
    
    // âœ… DETECT TOOL NEEDS (includes document builder, recruitment, integrations, etc.)
    const toolNeeds = detectToolNeeds(message);
    
    // âœ… CHECK FOR HIGH-RISK TOPICS (only critical: termination, legal, harassment)
    const risk = detectHighRiskTopic(message);
    
    addMessage('user', message);
    input.value = '';
    
    // âœ… USE A PROMPT (for free tier tracking)
    usePrompt();
    
    // Show "Fitz is thinking..." indicator
    const thinkingDiv = showThinkingIndicator();
    const sendBtn = DOM.sendButton;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="pulse">â—â—â—</span>';
    
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await callClaudeAPI(message);
        
        // Remove thinking indicator
        removeThinkingIndicator(thinkingDiv);
        
        // Build final response with injections
        let finalResponse = response;
        
        // âœ… INJECT TOOL SUGGESTIONS SECOND (max 2 tools)
        if (toolNeeds && toolNeeds.length > 0) {
            const toolSuggestions = createToolSuggestions(toolNeeds);
            finalResponse = toolSuggestions + finalResponse;
            
            // Track tool suggestions shown
            trackEvent('tool_suggestions_shown', {
                user: userKey,
                tools: toolNeeds.map(t => t.id),
                message_snippet: message.substring(0, 50)
            });
        }
        
        // âœ… INJECT HIGH-RISK WARNING FIRST (only for critical legal/termination matters)
        if (risk) {
            const warningBox = createHighRiskWarningBox(risk);
            finalResponse = warningBox + finalResponse;
        }
        
        addMessage('assistant', finalResponse);
        trackConversation(message, response);
        conversationHistory.push({ role: 'assistant', content: response });
        
        // Auto-save conversation
        saveCurrentConversation();
        
        // WEEK 3: Update searchable history
        updateSearchableHistory();
        
        trackEvent('message_sent', { user: currentUser, messageLength: message.length });
    } catch (error) {
        // WEEK 2: Better error handling with user-friendly message
        removeThinkingIndicator(thinkingDiv);
        handleError(error, 'sendMessage');
        addMessage('assistant', 'âš ï¸ I encountered an issue processing your message. Please try again. If the problem persists, try refreshing the page.');
    }
    
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<span>Send</span><span>â†’</span>';
    
    // Reset textarea height after sending
    autoResizeTextarea(input);
}

function showThinkingIndicator() {
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = 'thinking-indicator';
    thinkingDiv.className = 'flex justify-start fade-in';
    thinkingDiv.innerHTML = `
        <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-400 text-sm">Fitz is thinking...</p>
            </div>
        </div>
    `;
    container.appendChild(thinkingDiv);
    thinkingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    return thinkingDiv;
}

function removeThinkingIndicator(thinkingDiv) {
    if (thinkingDiv && thinkingDiv.parentNode) {
        thinkingDiv.parentNode.removeChild(thinkingDiv);
    }
}

function addMessage(role, content) {
    let container = DOM.messagesContainer.querySelector('.space-y-6');
    
    // If container doesn't exist, create it
    if (!container) {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        container = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
    
    let formattedContent = content;
    if (role === 'assistant') {
        // Check if content already contains high-risk HTML warning
        const hasHighRiskHTML = content.includes('IMPORTANT: This matter involves legal risk');
        
        if (!hasHighRiskHTML) {
            // Look for backend legal warnings and format them
            const legalWarnings = [
                'âš ï¸ **This matter involves legal risk.**',
                'âš ï¸ This matter involves legal risk.'
            ];
            
            for (const warning of legalWarnings) {
                if (content.includes(warning)) {
                    // Remove the warning text from content
                    formattedContent = content.replace(warning, '');
                    
                    // Add formatted warning at the top
                    formattedContent = `<div class="mb-3 p-3 bg-red-500/10 border-l-4 border-red-500 rounded">
    <p class="text-red-400 font-bold text-sm flex items-center gap-2 mb-2">
        <span>âš ï¸</span>
        <span>IMPORTANT: This matter involves legal risk.</span>
    </p>
    <p class="text-red-300 text-sm mb-3">
        Please contact a Senior Consultant at <a href="mailto:info@fitzgeraldhr.com.au" class="underline hover:text-red-200">info@fitzgeraldhr.com.au</a> for expert guidance before taking action.
    </p>
    <div class="flex gap-2">
        <a href="mailto:info@fitzgeraldhr.com.au?subject=URGENT: High-Risk HR Matter - ${encodeURIComponent(currentUser)}" 
           class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center">
            âœ‰ï¸ Email Consultant
        </a>
        <a href="tel:+61400211014" 
           class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded text-sm transition-all text-center whitespace-nowrap">
            ðŸ“ž Call
        </a>
        <button onclick="openTool('scenarioAnalysis')" 
                class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-3 rounded text-sm transition-all whitespace-nowrap">
            ðŸŽ¯ Analyze
        </button>
    </div>
</div>

` + formattedContent.replace('Please contact one of our Senior Consultants at info@fitzgeraldhr.com.au for expert guidance on your specific situation and next steps.', '');
                    break;
                }
            }
        }
        
        // Format the text content (convert markdown and add line breaks)
        // Only format if it doesn't contain our warning HTML
        if (!formattedContent.includes('<div class="mb-3 p-3 bg-red-500/10')) {
            formattedContent = formattedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p class="mt-3">')
                .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
            formattedContent = '<p>' + formattedContent + '</p>';
        } else {
            // If it has the warning, format the text AFTER the warning
            const parts = formattedContent.split('</div>\n\n');
            if (parts.length > 1) {
                const warningPart = parts[0] + '</div>\n\n';
                let textPart = parts[1];
                
                textPart = textPart
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p class="mt-3">')
                    .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
                textPart = '<p>' + textPart + '</p>';
                
                formattedContent = warningPart + textPart;
            }
        }
    }
    
    const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    messageDiv.setAttribute('data-message-id', messageId);
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl ${role === 'user' ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-100 border border-slate-700'} rounded-2xl px-6 py-4 relative">
            ${role === 'assistant' ? `<span class="bookmark-star absolute top-3 right-3" data-message-id="${messageId}" onclick="toggleBookmark('${messageId}')" title="Bookmark this">â˜†</span>` : ''}
            ${role === 'user' 
                ? `<p class="leading-relaxed whitespace-pre-wrap">${formattedContent}</p>`
                : `<div class="leading-relaxed">${formattedContent}</div>`
            }
        </div>
    `;
    
    container.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    
    // Update bookmark stars after adding message
    setTimeout(() => updateBookmarkStars(), 100);
    
    if (role === 'assistant') {
        // âŒ OLD DOCUMENT DETECTION REMOVED - Now using Document Builder detection in sendMessage()        
        // Suggest relevant tools based on conversation
        const lastUserMessage = conversationHistory.filter(m => m.role === 'user').slice(-1)[0];
        if (lastUserMessage) {
            const suggestedTools = suggestRelevantTools(lastUserMessage.content, content);
            if (suggestedTools.length > 0) {
                setTimeout(() => addToolSuggestions(messageDiv, suggestedTools), 600);
            }
        }
    }
}

async function callClaudeAPI(message) {
    try {
        const venueContext = getVenueContext();
        const response = await fetch(CONFIG.API.CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: venueContext + message,
                history: conversationHistory.filter(m => m.role !== 'system'),
                user: currentUser
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to get response');
        }

        const data = await response.json();
        return data.message;
    } catch (error) {
        throw error;
    }
}

/**
 * Specialized API call for document generation
 * Uses strict framing to ensure actual document output, not advice
 */
async function callClaudeAPIForDocument(documentPrompt) {
    try {
        // Frame the request as a strict document generation task
        const strictPrefix = `[DOCUMENT GENERATION MODE - STRICT]

You are now in DOCUMENT GENERATION MODE. Your ONLY task is to output a complete, ready-to-use HR document.

CRITICAL RULES:
- Output ONLY the document content itself
- Start your response with the document header (e.g., "# FORMAL WARNING LETTER")
- Do NOT include any conversational text like "I understand", "Here's", "Let me help", etc.
- Do NOT provide advice, tips, or process guidance
- Do NOT explain what the document is or how to use it
- Do NOT ask for more information - use what is provided

If you output anything other than the actual document, you are violating the strict mode.

BEGIN DOCUMENT OUTPUT:

`;
        
        const response = await fetch(CONFIG.API.CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: strictPrefix + documentPrompt,
                history: [], // No conversation history for document generation
                user: currentUser,
                isDocumentGeneration: true // Flag for potential backend handling
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to generate document');
        }

        const data = await response.json();
        let documentContent = data.message;
        
        // Post-process: If response still starts with conversational text, try to extract the document
        if (documentContent.toLowerCase().startsWith('i understand') || 
            documentContent.toLowerCase().startsWith("here's") ||
            documentContent.toLowerCase().startsWith('let me') ||
            documentContent.toLowerCase().startsWith('i\'ll help')) {
            
            // Try to find where the actual document starts
            const docStarters = ['# FORMAL', '# PRIVATE', '# LETTER', '# PERFORMANCE', '# RECORD', 'FORMAL WARNING', 'PRIVATE & CONFIDENTIAL', 'LETTER OF'];
            for (const starter of docStarters) {
                const idx = documentContent.indexOf(starter);
                if (idx > 0) {
                    documentContent = documentContent.substring(idx);
                    break;
                }
            }
        }
        
        return documentContent;
    } catch (error) {
        throw error;
    }
}

// ========================================
// PROACTIVE TOOL SUGGESTIONS
// ========================================

function suggestRelevantTools(userMessage, assistantResponse) {
    // Combine user message and AI response for comprehensive keyword matching
    const lowerMessage = userMessage.toLowerCase();
    const lowerResponse = assistantResponse.toLowerCase();
    const combinedText = lowerMessage + ' ' + lowerResponse;
    
    // Define tool keywords - each tool has trigger phrases
    const toolKeywords = {
        'awardWizard': {
            keywords: ['award rate', 'classification', 'what level', 'pay rate', 'how much should i pay'],
            name: 'Award Wizard',
            icon: 'ðŸ§™',
            description: 'Find the exact award classification and rate'
        },
        // ... (keep rest of toolKeywords)
    };
    
    const suggestedTools = [];
    
    // Scan each tool for keyword matches
    for (const [toolId, tool] of Object.entries(toolKeywords)) {
        // Count how many keywords appear in the conversation
        const keywordMatches = tool.keywords.filter(keyword => combinedText.includes(keyword));
        
        // Only suggest if at least one keyword matches
        if (keywordMatches.length > 0) {
            suggestedTools.push({ toolId, ...tool, matches: keywordMatches.length });
        }
    }
    
    // Sort by relevance - most keyword matches first
    suggestedTools.sort((a, b) => b.matches - a.matches);
    
    // Return top 2 most relevant tools to avoid overwhelming user
    return suggestedTools.slice(0, CONFIG.TOOL_SUGGESTION_LIMIT);
}

function addToolSuggestions(messageDiv, tools) {
    if (tools.length === 0) return;
    
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'mt-4 p-4 bg-blue-500/10 border-l-4 border-blue-500 rounded-r-lg';
    
    let html = '<p class="text-blue-400 font-semibold mb-3 flex items-center gap-2">';
    html += '<span>ðŸ’¡</span><span>Helpful Tools:</span></p><div class="space-y-2">';
    
    tools.forEach(tool => {
        html += `
            <button onclick="openTool('${tool.toolId}')" 
                    class="w-full text-left p-3 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg transition-all flex items-center gap-3 group">
                <span class="text-2xl">${tool.icon}</span>
                <div class="flex-1">
                    <p class="text-slate-200 font-medium group-hover:text-amber-400 transition-colors">${tool.name}</p>
                    <p class="text-xs text-slate-400">${tool.description}</p>
                </div>
                <span class="text-slate-400 group-hover:text-amber-400 transition-colors">â†’</span>
            </button>
        `;
    });
    
    html += '</div>';
    suggestionsContainer.innerHTML = html;
    messageDiv.querySelector('.max-w-3xl').appendChild(suggestionsContainer);
}

// ========================================
// DOCUMENT GENERATION
// ========================================

function detectDocumentType(content) {
    const lowerContent = content.toLowerCase();
    const documentKeywords = {
        'employmentContract': ['employment contract', 'hire', 'new employee'],
        'warningLetter': ['warning', 'disciplinary', 'performance issue']
    };
    
    for (const [docType, keywords] of Object.entries(documentKeywords)) {
        if (keywords.some(keyword => lowerContent.includes(keyword))) {
            return docType;
        }
    }
    return null;
}

function addDocumentDownloadButtons(messageDiv, documentType) {
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-4 p-4 bg-slate-700/50 rounded-lg border border-amber-500/30';
    buttonContainer.innerHTML = `
        <p class="text-amber-400 font-semibold mb-3">ðŸ“„ Generate Document</p>
        <div class="flex gap-2">
            <button onclick="downloadDocument('${documentType}', 'word')" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                ðŸ“ Download Word
            </button>
        </div>
        <p class="text-xs text-slate-400 mt-3">âš ï¸ Must be reviewed by consultant before use</p>
    `;
    messageDiv.querySelector('.max-w-3xl').appendChild(buttonContainer);
}

function downloadDocument(documentType, format) {
    const confirmed = confirm(
        "âš ï¸ IMPORTANT: This is a TEMPLATE only.\n\n" +
        "You MUST have it reviewed by a Fitzgerald HR consultant.\n\n" +
        "Contact: info@fitzgeraldhr.com.au\n\n" +
        "Click OK to download."
    );
    
    if (!confirmed) return;
    
    const data = { employeeName: '[Name]', position: '[Position]' };
    const template = hrTemplates[documentType];
    if (!template) return;
    
    const content = template(data);
    const filename = `${documentType}_${Date.now()}.doc`;
    generateWordDocument(content, filename);
}

function generateExcelSpreadsheet(data, filename, sheetName = 'Data') {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    const colWidths = Object.keys(data[0] || {}).map(() => ({ wch: 20 }));
    ws['!cols'] = colWidths;
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, filename);
    return true;
}

// ========================================
// CRISIS MODE
// ========================================

function activateCrisisMode() {
    document.getElementById('crisisModal').classList.remove('hidden');
    trackEvent('crisis_mode_activated', { user: currentUser });
}

function closeCrisisModal() {
    document.getElementById('crisisModal').classList.add('hidden');
}
/**
 * Submits crisis form to backend for urgent consultant callback
 * Shows loading state and handles errors gracefully
 * @returns {Promise<void>}
 */
async function submitCrisis() {
    const crisisType = document.getElementById('crisisType').value;
    const description = document.getElementById('crisisDescription').value;
    const phone = document.getElementById('crisisPhone').value;

    if (!crisisType || !description || !phone) {
        showAlert('Please fill in all fields');
        return;
    }

    const submitBtn = document.querySelector('#crisisModal button[onclick="submitCrisis()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-pulse">â³ Sending...</span>';

    try {
        const response = await fetch(CONFIG.API.CRISIS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ crisisType, description, phone, user: currentUser })
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(`ðŸš¨ URGENT ALERT SENT\n\nCrisis ID: ${result.crisisId}\n\nA consultant will call ${phone} within 15 minutes.`);
            closeCrisisModal();
        } else {
            throw new Error(result.error || 'Failed');
        }
    } catch (error) {
        showAlert(`âš ï¸ ALERT FAILED\n\nPLEASE CALL: +61 400 211 014\n\nYour submission is logged locally.`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// ========================================
// VOICE INPUT
// ========================================

function toggleVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice input not supported in your browser. Try Chrome or Edge.', 'warning', 3000);
        return;
    }
    isListening ? stopListening() : startListening();
}

function startListening() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-AU';

    recognition.onstart = () => {
        isListening = true;
        
        // Update button style
        const voiceBtn = document.getElementById('voiceButton');
        const voiceIcon = document.getElementById('voiceIcon');
        if (voiceBtn) {
            voiceBtn.classList.add('bg-red-500', 'text-white');
            voiceBtn.classList.remove('text-slate-400');
        }
        if (voiceIcon) {
            voiceIcon.classList.add('animate-pulse');
        }
        
        // Show recording indicator
        const indicator = document.getElementById('voiceRecordingIndicator');
        if (indicator) {
            indicator.classList.remove('hidden');
        }
    };

    // Debounce transcript updates for better performance
    const updateTranscript = debounce((transcript) => {
        DOM.messageInput.value = transcript;
        autoResizeTextarea(DOM.messageInput);
    }, CONFIG.DEBOUNCE_DELAY);

    recognition.onresult = (event) => {
        const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
        updateTranscript(transcript);
    };

    recognition.onerror = () => stopListening();
    recognition.onend = () => stopListening();
    recognition.start();
}

function stopListening() {
    if (recognition) recognition.stop();
    isListening = false;
    
    // Reset button style
    const voiceBtn = document.getElementById('voiceButton');
    const voiceIcon = document.getElementById('voiceIcon');
    if (voiceBtn) {
        voiceBtn.classList.remove('bg-red-500', 'text-white');
        voiceBtn.classList.add('text-slate-400');
    }
    if (voiceIcon) {
        voiceIcon.classList.remove('animate-pulse');
    }
    
    // Hide recording indicator
    const indicator = document.getElementById('voiceRecordingIndicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
}

// ========================================
// CHATGPT-STYLE SIDEBAR & NEW FEATURES
// ========================================

// ========================================
// CONVERSATION MANAGEMENT SYSTEM
// ========================================

// Conversation storage
var conversations = [];
var currentConversationId = null;

// Load conversations from localStorage
function loadConversations() {
    const stored = localStorage.getItem('fitz_conversations');
    if (stored) {
        try {
            conversations = JSON.parse(stored);
        } catch (e) {
            conversations = [];
        }
    }
}

// Save conversations to localStorage
function saveConversations() {
    try {
        localStorage.setItem('fitz_conversations', JSON.stringify(conversations));
        // Sync to cloud
        syncConversationsToCloud();
    } catch (e) {
    }
}

// Sync all conversations to cloud
async function syncConversationsToCloud() {
    if (!currentUser || !db) {
        return;
    }
    
    try {
        // Save each conversation to Firestore
        for (const conversation of conversations) {
            // Create clean data object without undefined fields
            const cleanData = {
                id: conversation.id,
                title: conversation.title,
                messages: conversation.messages || [],
                created: conversation.created,
                updated: conversation.updated,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(currentUser.uid)
                    .collection('conversations').doc(conversation.id)
                    .set(cleanData, { merge: true });
        }
    } catch (error) {
    }
}

// Load conversations from cloud
async function loadConversationsFromCloud() {
    if (!currentUser || !db) {
        return;
    }
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                  .collection('conversations').get();
        
        if (snapshot.empty) {
            return;
        }
        
        const cloudConversations = [];
        snapshot.forEach(doc => {
            cloudConversations.push(doc.data());
        });
        
        // Merge with local conversations (cloud takes priority)
        conversations = cloudConversations;
        
        // Save to localStorage
        localStorage.setItem('fitz_conversations', JSON.stringify(conversations));
        
        // Refresh the conversation list UI
        refreshConversationListUI();
        
    } catch (error) {
    }
}

// Refresh the conversation list in the UI
function refreshConversationListUI() {
    // Update recent chats sidebar if it exists
    const recentChatsContainer = document.querySelector('.recent-chats');
    if (recentChatsContainer && typeof displayRecentConversations === 'function') {
        displayRecentConversations();
    }
}


// Get current conversation
function getCurrentConversation() {
    return conversations.find(c => c.id === currentConversationId);
}

// Create new conversation
function createNewConversation() {
    // Save current conversation first
    if (currentConversationId) {
        saveCurrentConversation();
    }
    
    // Create new conversation
    const newConv = {
        id: 'conv-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        title: 'New Chat',
        messages: [],
        created: new Date().toISOString(),
        updated: new Date().toISOString()
    };
    
    conversations.push(newConv);
    currentConversationId = newConv.id;
    
    // Clear UI
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    if (container) {
        container.innerHTML = '';
    } else {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
    }
    
    // Reset conversation history
    conversationHistory = [];
    
    // Add FULL welcome message with HTML formatting (matching Image 1)
    const welcomeMessage = `
        <p class="text-slate-100 leading-relaxed">
            ðŸ‘‹ G'day! I'm Fitz, your hospitality HR assistant.
        </p>
        <p class="text-slate-100 leading-relaxed mt-3">
            Ask me anything about awards, compliance, or employment law.
        </p>
        <p class="text-red-400 font-semibold mt-4 mb-2">ðŸš¨ Urgent/Critical Situations:</p>
        <p class="text-slate-100 text-sm">
            Use the red URGENT button above for immediate crisis response.
        </p>
        <p class="text-slate-100 leading-relaxed mt-4">
            What HR topic would you like to learn about today?
        </p>
    `;
    
    // For display - reuse container already declared above
    var displayContainer = DOM.messagesContainer.querySelector('.space-y-6');
    if (!displayContainer) {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        displayContainer = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    if (displayContainer) {
        var messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start fade-in';
        var messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.innerHTML = '<div class="max-w-3xl bg-slate-800 text-slate-100 border border-slate-700 rounded-2xl px-6 py-4 relative">' +
            '<span class="bookmark-star absolute top-3 right-3" data-message-id="' + messageId + '" onclick="toggleBookmark(\'' + messageId + '\')" title="Bookmark this">â˜†</span>' +
            '<div class="leading-relaxed">' + welcomeMessage + '</div>' +
            '</div>';
        displayContainer.appendChild(messageDiv);
    }
    
    // For storage - save plain text version
    var plainWelcome = 'ðŸ‘‹ G\'day! I\'m Fitz, your hospitality HR assistant.\n\nAsk me anything about awards, compliance, or employment law.\n\nðŸš¨ Urgent/Critical Situations:\nUse the red URGENT button above for immediate crisis response.\n\nWhat HR topic would you like to learn about today?';
    conversationHistory.push({ role: 'assistant', content: plainWelcome });
    
    // Save and update UI - FIXED: Use saveCurrentConversation to update messages
    saveCurrentConversation();
    
    showToast('New chat started', 'success', 2000);
    
}

// Save current conversation
function saveCurrentConversation() {
    if (!currentConversationId) {
        return;
    }
    
    // Save current conversation ID to localStorage with user-specific key for persistence
    const userKey = currentUser && currentUser.uid ? currentUser.uid : (currentUser || 'anonymous');
    localStorage.setItem('fitz_currentConversationId_' + userKey, currentConversationId);
    
    // Also save to Firebase for cross-device continuity
    saveCurrentConversationIdToFirebase(currentConversationId);
    
    var conv = getCurrentConversation();
    if (!conv) {
        return;
    }
    
    // Update messages
    conv.messages = conversationHistory;
    conv.updated = new Date().toISOString();
    
    // Update title from first user message if still "New Chat"
    if (conv.title === 'New Chat' && conversationHistory.length > 0) {
        var firstUserMsg = conversationHistory.find(function(m) { return m.role === 'user'; });
        if (firstUserMsg) {
            conv.title = firstUserMsg.content.substring(0, 50) + (firstUserMsg.content.length > 50 ? '...' : '');
        }
    }
    
    saveConversations();
    updateSidebarChats();
    
}

// Load conversation by ID
function loadConversation(convId) {
    // Save current first
    if (currentConversationId && currentConversationId !== convId) {
        saveCurrentConversation();
    }
    
    var conv = conversations.find(function(c) { return c.id === convId; });
    if (!conv) {
        return;
    }
    
    currentConversationId = convId;
    
    // Clear UI
    var container = DOM.messagesContainer.querySelector('.space-y-6');
    if (container) {
        container.innerHTML = '';
    } else {
        DOM.messagesContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6"></div>';
        container = DOM.messagesContainer.querySelector('.space-y-6');
    }
    
    // Load messages
    conversationHistory = conv.messages || [];
    // Render messages
    conversationHistory.forEach(function(msg, index) {
        addMessage(msg.role, msg.content);
    });
    
    // Update UI
    updateSidebarChats();
    
    // Scroll to bottom after messages are rendered so user sees most recent messages
    // Also focus the message input so user can start typing immediately
    // Use multiple timeouts to ensure scroll happens after all content renders
    setTimeout(function() {
        scrollToBottomInstant();
    }, 150);
    
    // Second scroll as backup after longer delay for slow-rendering content
    setTimeout(function() {
        scrollToBottomInstant();
        // Focus the message input on desktop
        const messageInput = document.getElementById('messageInput');
        if (messageInput && window.innerWidth >= 768) {
            messageInput.focus();
        }
    }, 400);
    
}

/**
 * Restore the last active conversation on app load
 * Similar to how Claude.ai works - shows previous chat instead of blank
 */
function restoreLastConversation() {
    // First, load conversations from localStorage if not already loaded
    if (conversations.length === 0) {
        loadConversations();
    }
    
    // Try to get the last active conversation ID using user-specific key
    const userKey = currentUser && currentUser.uid ? currentUser.uid : (currentUser || 'anonymous');
    let lastConvId = localStorage.getItem('fitz_currentConversationId_' + userKey);
    
    // Fallback to old key for backwards compatibility
    if (!lastConvId) {
        lastConvId = localStorage.getItem('fitz_currentConversationId');
    }
    
    // Check if that conversation still exists
    let targetConv = null;
    if (lastConvId) {
        targetConv = conversations.find(c => c.id === lastConvId);
    }
    
    // If last conversation doesn't exist, get the most recent one
    if (!targetConv && conversations.length > 0) {
        // Sort by updated date (most recent first)
        const sorted = [...conversations].sort((a, b) => {
            return new Date(b.updated || b.created) - new Date(a.updated || a.created);
        });
        targetConv = sorted[0];
    }
    
    // If we have a conversation to restore
    if (targetConv) {
        // Check if it has meaningful messages (more than just welcome message)
        const hasMeaningfulMessages = targetConv.messages && targetConv.messages.length > 1;
        // Load the conversation
        loadConversation(targetConv.id);
        
        // Show appropriate toast
        if (hasMeaningfulMessages) {
            showToast('Restored previous chat', 'info', 2000);
        }
        
        return true; // Conversation restored
    }
    
    // No conversations exist - create a new one
    createNewConversation();
    return false; // New conversation created
}

// Delete conversation
function deleteConversation(convId) {
    const conv = conversations.find(c => c.id === convId);
    if (!conv) return;
    
    if (!confirm('Delete "' + conv.title + '"? This cannot be undone.')) {
        return;
    }
    
    // Remove from array
    conversations = conversations.filter(c => c.id !== convId);
    
    // If deleting current conversation
    if (convId === currentConversationId) {
        if (conversations.length > 0) {
            // Load the most recent conversation
            loadConversation(conversations[conversations.length - 1].id);
        } else {
            // Create new conversation
            createNewConversation();
        }
    }
    
    saveConversations();
    updateSidebarChats();
    
    showToast('Conversation deleted', 'info', 2000);
}

// Update sidebar chats list
function updateSidebarChats() {
    const chatsList = document.getElementById('sidebarChatsList');
    if (!chatsList) return;
    
    if (conversations.length === 0) {
        chatsList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No chats yet</p>';
        return;
    }
    
    // Sort by updated date (most recent first) and take only the 5 most recent
    const sortedConvs = [...conversations]
        .sort((a, b) => new Date(b.updated) - new Date(a.updated))
        .slice(0, 5); // Only show the 5 most recent
    
    chatsList.innerHTML = sortedConvs.map(conv => {
        const isActive = conv.id === currentConversationId;
        const date = new Date(conv.updated);
        const dateStr = formatRelativeDate(date);
        
        return `
            <div class="sidebar-chat-item ${isActive ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                <div class="sidebar-chat-title">${escapeHtml(conv.title)}</div>
                <button class="sidebar-chat-delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

// Format relative date
function formatRelativeDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return diffDays + 'd ago';
    return date.toLocaleDateString();
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize conversation system
function initConversationSystem() {
    loadConversations();
    
    if (conversations.length === 0) {
        // Create first conversation
        createNewConversation();
    } else {
        // Load most recent conversation
        const mostRecent = conversations.sort((a, b) => 
            new Date(b.updated) - new Date(a.updated)
        )[0];
        loadConversation(mostRecent.id);
    }
}

// ========================================
// BOOKMARKS SYSTEM
// ========================================

var bookmarks = [];
var recentTools = []; // Track recently used tools

// Tool metadata
const toolMetadata = {
    'documentBuilderModal': { name: 'Document Builder', icon: 'ðŸ“' },
    'awardCalculatorModal': { name: 'Award Calculator', icon: 'ðŸ’°' },
    'scenarioAnalysisModal': { name: 'Scenario Analysis', icon: 'ðŸŽ¯' },
    'rosterStressTesterModal': { name: 'Roster Stress Test', icon: 'ðŸ’¥' },
    'awardWizardModal': { name: 'Award Wizard', icon: 'ðŸ§™' },
    'rosterOptimizerModal': { name: 'Roster Optimizer', icon: 'ðŸ“…' },
    'complianceCalendarModal': { name: 'Compliance Calendar', icon: 'ðŸ“†' },
    'terminationRiskModal': { name: 'Termination Risk', icon: 'âš ï¸' }
};


// Load bookmarks
function loadBookmarks() {
    const stored = localStorage.getItem('fitz_bookmarks');
    if (stored) {
        try {
            bookmarks = JSON.parse(stored);
        } catch (e) {
            bookmarks = [];
        }
    }
}

// Load bookmarks from Firebase and merge with local
async function loadBookmarksFromFirebase() {
    if (!currentUser || !currentUser.uid || !db) {
        return;
    }
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            const firebaseBookmarks = userData.bookmarks || [];
            
            // Merge: Firebase takes priority
            const mergedMap = new Map();
            
            // Add local bookmarks first
            bookmarks.forEach(b => {
                if (b && b.id) mergedMap.set(b.id, b);
            });
            
            // Override with Firebase bookmarks
            firebaseBookmarks.forEach(b => {
                if (b && b.id) mergedMap.set(b.id, b);
            });
            
            bookmarks = Array.from(mergedMap.values());
            
            // Save merged result
            localStorage.setItem('fitz_bookmarks', JSON.stringify(bookmarks));
            
            // Update UI
            updateSidebarBookmarks();
        }
    } catch (error) {
    }
}

// Save bookmarks
function saveBookmarks() {
    localStorage.setItem('fitz_bookmarks', JSON.stringify(bookmarks));
    
    // Sync to Firebase
    if (currentUser && currentUser.uid && db) {
        db.collection('users').doc(currentUser.uid).set({
            bookmarks: bookmarks
        }, { merge: true }).catch(err => {
        });
    }
}

// Toggle bookmark
function toggleBookmark(messageId) {
    const existingIndex = bookmarks.findIndex(b => b.id === messageId);
    
    if (existingIndex >= 0) {
        // Remove bookmark
        bookmarks.splice(existingIndex, 1);
        showToast('Bookmark removed', 'info', 1500);
    } else {
        // Add bookmark
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            const content = messageElement.textContent;
            
            // Find the user's question by looking at previous messages in DOM
            let userQuestion = 'Bookmarked response';
            
            // Walk backwards through DOM siblings to find the previous user message
            let currentEl = messageElement.previousElementSibling;
            while (currentEl) {
                // Check if this is a user message (has amber background)
                const messageContent = currentEl.querySelector('.bg-amber-500');
                if (messageContent) {
                    userQuestion = messageContent.textContent.trim();
                    break;
                }
                currentEl = currentEl.previousElementSibling;
            }
            
            bookmarks.push({
                id: messageId,
                content: content,
                preview: userQuestion, // Store the user's question as preview
                conversationId: currentConversationId,
                created: new Date().toISOString()
            });
            showToast('Bookmarked', 'success', 1500);
        }
    }
    
    saveBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
}

// Update bookmark stars
function updateBookmarkStars() {
    document.querySelectorAll('.bookmark-star').forEach(star => {
        const messageId = star.getAttribute('data-message-id');
        const isBookmarked = bookmarks.some(b => b.id === messageId);
        star.textContent = isBookmarked ? 'â­' : 'â˜†';
    });
}

// Update sidebar bookmarks
function updateSidebarBookmarks() {
    var bookmarksList = document.getElementById('sidebarBookmarksList');
    
    if (!bookmarksList) {
        return;
    }
    
    if (bookmarks.length === 0) {
        bookmarksList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No bookmarks yet</p>';
        return;
    }
    
    bookmarksList.innerHTML = bookmarks.slice(0, 10).map(function(b) {
        // Use the stored preview (user's question) or fallback to content
        var displayText = b.preview || b.content;
        var preview = displayText.substring(0, 60) + (displayText.length > 60 ? '...' : '');
        return '<div class="sidebar-chat-item" onclick="jumpToBookmark(\'' + b.id + '\')">' +
            '<div class="sidebar-chat-title text-xs">' + escapeHtml(preview) + '</div>' +
            '<button class="sidebar-chat-delete" onclick="event.stopPropagation(); removeBookmark(\'' + b.id + '\')" title="Remove">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' +
                '</svg>' +
            '</button>' +
        '</div>';
    }).join('');
}

// Jump to bookmark
function jumpToBookmark(messageId) {
    const bookmark = bookmarks.find(b => b.id === messageId);
    if (!bookmark) {
        showToast('Bookmark not found', 'error', 2000);
        return;
    }
    
    // Check if the conversation exists
    const targetConversation = conversations.find(c => c.id === bookmark.conversationId);
    
    if (!targetConversation) {
        showToast('Conversation no longer exists', 'error', 2000);
        
        // Optionally remove the orphaned bookmark
        const removeOrphan = confirm('The bookmarked conversation no longer exists. Remove this bookmark?');
        if (removeOrphan) {
            removeBookmark(messageId);
        }
        return;
    }
    
    // If bookmark is in different conversation, load it
    if (bookmark.conversationId !== currentConversationId) {
        loadConversation(bookmark.conversationId);
    }
    
    // Scroll to message after a delay to allow conversation to load
    setTimeout(() => {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messageElement.classList.add('highlight-flash');
            setTimeout(() => messageElement.classList.remove('highlight-flash'), 2000);
        } else {
            showToast('Message not found in conversation', 'warning', 2000);
        }
    }, 800);
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
}

// Remove bookmark
function removeBookmark(messageId) {
    bookmarks = bookmarks.filter(b => b.id !== messageId);
    saveBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
    showToast('Bookmark removed', 'info', 1500);
}

// ========================================
// RECENT TOOLS TRACKING
// ========================================

function loadRecentTools() {
    try {
        const stored = localStorage.getItem('fitz_recent_tools');
        recentTools = stored ? JSON.parse(stored) : [];
    } catch (e) {
        recentTools = [];
    }
}

function saveRecentTools() {
    try {
        localStorage.setItem('fitz_recent_tools', JSON.stringify(recentTools));
    } catch (e) {
    }
}

function trackToolUsage(toolId) {
    const tool = toolMetadata[toolId];
    if (!tool) return;
    
    // Remove if exists (to move to front)
    recentTools = recentTools.filter(t => t.id !== toolId);
    
    // Add to front
    recentTools.unshift({
        id: toolId,
        name: tool.name,
        icon: tool.icon,
        timestamp: new Date().toISOString()
    });
    
    // Keep only last 5
    recentTools = recentTools.slice(0, 5);
    
    saveRecentTools();
    updateSidebarRecentTools();
    
    trackEvent('tool_used', {
        user: currentUser,
        tool: tool.name
    });
}

function updateSidebarRecentTools() {
    var toolsList = document.getElementById('sidebarRecentTools');
    if (!toolsList) return;
    
    if (recentTools.length === 0) {
        toolsList.innerHTML = '<p class="text-slate-500 text-sm py-4 text-center">No tools used yet</p>';
        return;
    }
    
    toolsList.innerHTML = recentTools.map(function(tool) {
        return '<div class="sidebar-chat-item hover:bg-slate-700" onclick="openToolById(\'' + tool.id + '\')" style="cursor: pointer;">' +
            '<div class="flex items-center gap-2">' +
                '<span class="text-xl">' + tool.icon + '</span>' +
                '<div class="sidebar-chat-title text-sm">' + tool.name + '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

function openToolById(toolId) {
    trackToolUsage(toolId);
    
    var modal = document.getElementById(toolId);
    if (modal) {
        modal.classList.remove('hidden');
        closeToolsMenu();
    }
}

// ========================================
// SEARCH SYSTEM
// ========================================

// Perform sidebar search
function performSidebarSearch() {
    const query = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('sidebarSearchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    // Search across all conversations
    let results = [];
    conversations.forEach(conv => {
        (conv.messages || []).forEach(msg => {
            if (msg.content.toLowerCase().includes(query)) {
                results.push({
                    conversationId: conv.id,
                    conversationTitle: conv.title,
                    content: msg.content,
                    role: msg.role
                });
            }
        });
    });
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-500 text-xs py-2">No results</p>';
        return;
    }
    
    // Limit to first 10 results
    results = results.slice(0, 10);
    
    resultsDiv.innerHTML = results.map(r => {
        const preview = r.content.substring(0, 80) + (r.content.length > 80 ? '...' : '');
        // Highlight search term
        const highlighted = preview.replace(
            new RegExp(query, 'gi'),
            match => `<mark class="bg-amber-500/30 text-amber-300">${match}</mark>`
        );
        
        return `
            <div class="text-xs text-slate-300 py-2 px-2 hover:bg-slate-700 rounded cursor-pointer border-b border-slate-700/50" 
                 onclick="openSearchResult('${r.conversationId}')">
                <div class="text-slate-400 text-xs mb-1">${escapeHtml(r.conversationTitle)}</div>
                <div>${highlighted}</div>
            </div>
        `;
    }).join('');
}

// Open search result
function openSearchResult(convId) {
    loadConversation(convId);
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
    
    // Clear search
    const searchInput = document.getElementById('sidebarSearchInput');
    if (searchInput) {
        searchInput.value = '';
        performSidebarSearch();
    }
}

// ========================================

// Sidebar state
let sidebarOpen = false; // Closed by default on all devices

// Toggle sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebarOpen = !sidebarOpen;
    
    if (sidebarOpen) {
        sidebar.classList.remove('closed');
        if (window.innerWidth < 768) {
            overlay.classList.add('active');
        }
    } else {
        sidebar.classList.add('closed');
        overlay.classList.remove('active');
    }
}

// Initialize sidebar on load
function initSidebar() {
    var sidebar = document.getElementById('chatSidebar');
    // Always start closed on all devices
    if (sidebar) {
        sidebar.classList.add('closed');
        sidebarOpen = false;
    }
}

// Upload menu toggle
function toggleUploadMenu() {
    const menu = document.getElementById('uploadMenu');
    menu.classList.toggle('hidden');
}

// Toggle Tools Menu
// toggleToolsMenu - defined below with mobile/desktop handling

function closeToolsMenu() {
    var menu = document.getElementById('toolsMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// More Menu Functions
function toggleMoreMenu() {
    var menu = document.getElementById('moreMenu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function closeMoreMenu() {
    var menu = document.getElementById('moreMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// Profile Menu Functions
function openProfileMenu() {
    var menu = document.getElementById('profileMenu');
    if (menu) {
        menu.classList.remove('hidden');
        
        // Update venue name and code in profile from venueProfile
        var venueName = venueProfile.venueName || 'Your Venue';
        // For Firebase users, show email; for access code users, show the code
        var userDisplay = currentUser && currentUser.email ? currentUser.email : (currentUser || 'N/A');
        
        document.getElementById('profileVenueName').textContent = venueName;
        document.getElementById('profileUserCode').textContent = userDisplay;
    }
}

function closeProfileMenu() {
    var menu = document.getElementById('profileMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

// Update sidebar venue name on load
function updateSidebarVenueName() {
    var venueName = venueProfile.venueName || 'Fitz';
    
    var sidebarName = document.getElementById('sidebarVenueName');
    
    if (sidebarName) {
        sidebarName.textContent = venueName;
    }
    
    // Also store in localStorage for easy access
    if (venueProfile.venueName) {
        localStorage.setItem('venueName', venueProfile.venueName);
    }
    
    // Update userCode display
    var userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    localStorage.setItem('userCode', userKey);
}

// Tool Opening Functions
function openAwardCalculator() {
    trackToolUsage('awardCalculatorModal');
    var modal = document.getElementById('awardCalculatorModal');
    if (modal) modal.classList.remove('hidden');
}

function openScenarioAnalysis() {
    trackToolUsage('scenarioAnalysisModal');
    var modal = document.getElementById('scenarioAnalysisModal');
    if (modal) modal.classList.remove('hidden');
}

function openRosterStressTester() {
    trackToolUsage('rosterStressTesterModal');
    var modal = document.getElementById('rosterStressTesterModal');
    if (modal) modal.classList.remove('hidden');
}

function openAwardWizard() {
    trackToolUsage('awardWizardModal');
    
    // Reset wizard state
    wizardData = {};
    currentWizardStep = 1;
    
    // Reset UI to step 1
    const wizardModal = document.getElementById('awardWizardModal');
    if (wizardModal) {
        // Show modal
        wizardModal.classList.remove('hidden');
        
        // Reset all steps visibility
        wizardModal.querySelectorAll('.wizard-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // Show step 1
        const step1 = wizardModal.querySelector('[data-step="1"]');
        if (step1) step1.classList.remove('hidden');
        
        // Hide back button
        const backBtn = document.getElementById('wizardBackBtn');
        if (backBtn) backBtn.classList.add('hidden');
        
        // Reset progress bar
        document.getElementById('wizardCurrentStep').textContent = '1';
        document.getElementById('wizardProgress').textContent = '20% Complete';
        document.getElementById('wizardProgressBar').style.width = '20%';
    }
}

function openRosterOptimizer() {
    trackToolUsage('rosterOptimizerModal');
    var modal = document.getElementById('rosterOptimizerModal');
    if (modal) modal.classList.remove('hidden');
}

function openComplianceCalendar() {
    try {
        trackToolUsage('complianceCalendarModal');
        var modal = document.getElementById('complianceCalendarModal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            showAlert('Error: Could not find Compliance Calendar modal');
            return;
        }
        
        // Set state selector to user's saved state
        initializeComplianceCalendarState();
    } catch (error) {
        showAlert('Error opening Compliance Calendar: ' + error.message);
    }
}

// Australian Public Holidays by State/Territory (2026)
// Source: Fair Work Ombudsman - https://www.fairwork.gov.au/employment-conditions/public-holidays/2026-public-holidays
const PUBLIC_HOLIDAYS_2026 = {
    // New South Wales
    NSW: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "Easter Saturday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-10-05', name: "Labour Day" },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" }
    ],
    // Victoria
    VIC: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-03-09', name: "Labour Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "Saturday before Easter Sunday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-11-03', name: "Melbourne Cup Day", regional: true },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" }
    ],
    // Queensland
    QLD: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "The day after Good Friday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-05-04', name: "Labour Day" },
        { date: '2026-08-12', name: "Royal Queensland Show (Brisbane)", regional: true },
        { date: '2026-10-05', name: "King's Birthday" },
        { date: '2026-12-24', name: "Christmas Eve (from 6pm)", partDay: true },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" }
    ],
    // South Australia
    SA: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-03-09', name: "Adelaide Cup Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "Easter Saturday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-10-05', name: "Labour Day" },
        { date: '2026-12-24', name: "Christmas Eve (from 7pm)", partDay: true },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Proclamation Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Proclamation Day)" },
        { date: '2026-12-31', name: "New Year's Eve (from 7pm)", partDay: true }
    ],
    // Western Australia
    WA: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-03-02', name: "Labour Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-04-27', name: "Additional Public Holiday (Anzac Day)" },
        { date: '2026-06-01', name: "Western Australia Day" },
        { date: '2026-09-28', name: "King's Birthday" },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" }
    ],
    // Tasmania
    TAS: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-02-09', name: "Royal Hobart Regatta (Hobart area)", regional: true },
        { date: '2026-03-09', name: "Eight Hours Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-07', name: "Easter Tuesday (Public Service)", partDay: true },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-10-22', name: "Royal Hobart Show (Hobart area)", regional: true },
        { date: '2026-11-02', name: "Recreation Day (North TAS)", regional: true },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-28', name: "Boxing Day" }
    ],
    // Northern Territory
    NT: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "Easter Saturday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-25', name: "Anzac Day" },
        { date: '2026-05-04', name: "May Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-08-03', name: "Picnic Day" },
        { date: '2026-12-24', name: "Christmas Eve (from 7pm)", partDay: true },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" },
        { date: '2026-12-31', name: "New Year's Eve (from 7pm)", partDay: true }
    ],
    // Australian Capital Territory
    ACT: [
        { date: '2026-01-01', name: "New Year's Day" },
        { date: '2026-01-26', name: "Australia Day" },
        { date: '2026-03-09', name: "Canberra Day" },
        { date: '2026-04-03', name: "Good Friday" },
        { date: '2026-04-04', name: "Easter Saturday" },
        { date: '2026-04-05', name: "Easter Sunday" },
        { date: '2026-04-06', name: "Easter Monday" },
        { date: '2026-04-27', name: "Anzac Day (observed)" },
        { date: '2026-06-01', name: "Reconciliation Day" },
        { date: '2026-06-08', name: "King's Birthday" },
        { date: '2026-10-05', name: "Labour Day" },
        { date: '2026-12-25', name: "Christmas Day" },
        { date: '2026-12-26', name: "Boxing Day" },
        { date: '2026-12-28', name: "Additional Public Holiday (Boxing Day)" }
    ]
};

function initializeComplianceCalendarState() {
    try {
        const selector = document.getElementById('complianceStateSelector');
        if (!selector) {
            return;
        }
        
        // Try to get user's state from venue profile
        let userState = 'NSW'; // Default
        
        const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
        if (userKey) {
            const savedProfile = localStorage.getItem('venueProfile_' + userKey);
            if (savedProfile) {
                try {
                    const profile = JSON.parse(savedProfile);
                    if (profile.state) {
                        userState = profile.state;
                    }
                } catch (e) {
                }
            }
        }
        
        // Also check global venueProfile
        if (typeof venueProfile !== 'undefined' && venueProfile && venueProfile.state) {
            userState = venueProfile.state;
        }
        
        selector.value = userState;
        updatePublicHolidays();
    } catch (error) {
    }
}

function updatePublicHolidays() {
    try {
        const selector = document.getElementById('complianceStateSelector');
        const list = document.getElementById('publicHolidaysList');
        const badge = document.getElementById('stateHolidayBadge');
        
        if (!selector || !list) {
            return;
        }
        
        const state = selector.value;
        if (badge) badge.textContent = state;
        
        // Get holidays for selected state
        const stateHolidays = PUBLIC_HOLIDAYS_2026[state] || [];
        
        // Sort by date
        const sortedHolidays = [...stateHolidays].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Filter to upcoming holidays only (from today)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const upcoming = sortedHolidays.filter(h => new Date(h.date) >= today).slice(0, 10);
        
        // Generate HTML
        if (upcoming.length === 0) {
            list.innerHTML = '<p class="text-slate-400">No upcoming public holidays found for 2026.</p>';
            return;
        }
        
        list.innerHTML = upcoming.map(h => {
            const date = new Date(h.date);
            const options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-AU', options);
            const daysUntil = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'text-slate-400';
            let urgencyText = '';
            
            if (daysUntil <= 7) {
                urgencyClass = 'text-red-400 font-semibold';
                urgencyText = daysUntil === 0 ? '(Today!)' : daysUntil === 1 ? '(Tomorrow!)' : `(${daysUntil} days)`;
            } else if (daysUntil <= 14) {
                urgencyClass = 'text-yellow-400';
                urgencyText = `(${daysUntil} days)`;
            } else if (daysUntil <= 30) {
                urgencyText = `(${daysUntil} days)`;
            }
            
            // Show regional or part-day badge
            let extraBadge = '';
            if (h.regional) {
                extraBadge = '<span class="ml-1 px-1.5 py-0.5 bg-blue-500/30 text-blue-300 text-xs rounded">Regional</span>';
            } else if (h.partDay) {
                extraBadge = '<span class="ml-1 px-1.5 py-0.5 bg-amber-500/30 text-amber-300 text-xs rounded">Part Day</span>';
            }
            
            return `
                <div class="flex justify-between items-center py-2 border-b border-slate-700/50">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-300">${formattedDate}</span>
                        <span class="${urgencyClass} text-xs">${urgencyText}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-purple-300 text-sm">${h.name}</span>
                        ${extraBadge}
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
    }
}

function openTerminationRisk() {
    trackToolUsage('terminationRiskModal');
    var modal = document.getElementById('terminationRiskModal');
    if (modal) modal.classList.remove('hidden');
}

// ========================================
// RECRUITMENT TOOLKIT FUNCTIONS
// ========================================

// Main Recruitment Toolkit
function openRecruitmentToolkit() {
    trackToolUsage('recruitmentToolkitModal');
    var modal = document.getElementById('recruitmentToolkitModal');
    if (modal) modal.classList.remove('hidden');
}

function closeRecruitmentToolkit() {
    var modal = document.getElementById('recruitmentToolkitModal');
    if (modal) modal.classList.add('hidden');
}

// Job Description Builder
let jdCurrentStep = 1;
let jdData = {
    jobTitle: '',
    experienceLevel: '',
    responsibilities: '',
    qualifications: '',
    award: '',
    classification: '',
    salaryRange: ''
};

function openJobDescriptionBuilder() {
    trackToolUsage('jobDescriptionBuilder');
    jdCurrentStep = 1;
    jdData = { jobTitle: '', experienceLevel: '', responsibilities: '', qualifications: '', award: '', classification: '', salaryRange: '' };
    updateJDStep();
    var modal = document.getElementById('jobDescriptionBuilderModal');
    if (modal) modal.classList.remove('hidden');
}

function closeJobDescriptionBuilder() {
    // Hide the modal
    var modal = document.getElementById('jobDescriptionBuilderModal');
    if (modal) modal.classList.add('hidden');
    
    // Reset loading screen state
    document.getElementById('jdGenerating').classList.add('hidden');
    document.getElementById('jdBuilderSteps').classList.remove('hidden');
}

function updateJDStep() {
    // Hide all steps
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById('jdStep' + i);
        if (step) step.classList.add('hidden');
    }
    
    // Show current step
    const currentStepEl = document.getElementById('jdStep' + jdCurrentStep);
    if (currentStepEl) currentStepEl.classList.remove('hidden');
    
    // Update step counter
    document.getElementById('jdStep').textContent = jdCurrentStep;
    
    // Update buttons
    document.getElementById('jdBackBtn').classList.toggle('hidden', jdCurrentStep === 1);
    document.getElementById('jdNextBtn').classList.toggle('hidden', jdCurrentStep === 4);
    document.getElementById('jdGenerateBtn').classList.toggle('hidden', jdCurrentStep !== 4);
}

function jdNextStep() {
    // Validate current step
    if (jdCurrentStep === 1) {
        const jobTitle = document.getElementById('jdJobTitle').value.trim();
        if (!jobTitle) {
            showAlert('Please enter a job title');
            return;
        }
        jdData.jobTitle = jobTitle;
    }
    
    if (jdCurrentStep === 2 && !jdData.experienceLevel) {
        showAlert('Please select an experience level');
        return;
    }
    
    // Move to next step
    if (jdCurrentStep < 4) {
        jdCurrentStep++;
        updateJDStep();
        
        // If moving to step 3, generate responsibilities with AI
        if (jdCurrentStep === 3) {
            generateResponsibilities();
        }
    }
}

function jdPreviousStep() {
    if (jdCurrentStep > 1) {
        jdCurrentStep--;
        updateJDStep();
    }
}

function selectJDExperience(level) {
    jdData.experienceLevel = level;
    // Highlight selected
    document.querySelectorAll('.jd-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.jd-experience-btn').classList.remove('border-slate-600');
    event.target.closest('.jd-experience-btn').classList.add('border-amber-500');
    setTimeout(() => jdNextStep(), 300);
}

async function generateResponsibilities() {
    const loading = document.getElementById('jdResponsibilitiesLoading');
    const textarea = document.getElementById('jdResponsibilities');
    const help = document.getElementById('jdResponsibilitiesHelp');
    
    loading.classList.remove('hidden');
    textarea.classList.add('hidden');
    help.classList.add('hidden');
    
    try {
        const prompt = `Generate 5-7 key responsibilities for a ${jdData.experienceLevel} level ${jdData.jobTitle} position in the Australian hospitality industry. Format as a bulleted list. Be specific and professional.`;
        
        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'responsibilities'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate responsibilities');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        textarea.value = content;
        loading.classList.add('hidden');
        textarea.classList.remove('hidden');
        help.classList.remove('hidden');
    } catch (error) {
        textarea.value = 'â€¢ [Add key responsibility]\nâ€¢ [Add key responsibility]\nâ€¢ [Add key responsibility]';
        loading.classList.add('hidden');
        textarea.classList.remove('hidden');
        help.classList.remove('hidden');
    }
}

function setupSalaryCalculation() {
    const awardSelect = document.getElementById('jdAward');
    const classSelect = document.getElementById('jdClassification');
    const display = document.getElementById('jdSalaryDisplay');
    const rangeEl = document.getElementById('jdSalaryRange');
    
    const calculate = () => {
        if (awardSelect.value && classSelect.value) {
            // Simple salary calculation (would integrate with Award Calculator)
            const baseRates = {
                'restaurant': [45000, 55000, 75000],
                'hospitality': [43000, 53000, 72000],
                'fast-food': [42000, 50000, 68000]
            };
            
            const level = parseInt(classSelect.value) - 1;
            const base = baseRates[awardSelect.value][level];
            const min = base;
            const max = Math.round(base * 1.15);
            
            jdData.salaryRange = `$${min.toLocaleString()} - $${max.toLocaleString()} per year`;
            rangeEl.textContent = jdData.salaryRange;
            display.classList.remove('hidden');
        }
    };
    
    awardSelect.addEventListener('change', calculate);
    classSelect.addEventListener('change', calculate);
}

async function generateJobDescription() {
    // Collect all data
    jdData.responsibilities = document.getElementById('jdResponsibilities').value;
    jdData.qualifications = document.getElementById('jdQualifications').value;
    
    // Hide wizard steps, show loading
    document.getElementById('jdBuilderSteps').classList.add('hidden');
    document.getElementById('jdGenerating').classList.remove('hidden');
    
    try {
        const prompt = `Create a professional job description for:
                    
Job Title: ${jdData.jobTitle}
Experience Level: ${jdData.experienceLevel}

Key Responsibilities:
${jdData.responsibilities}

Required Qualifications:
${jdData.qualifications}

Format as a complete, professional job description with sections for: Position Overview, Key Responsibilities, Required Qualifications, Desired Skills, and Benefits. Make it engaging and specific to Australian hospitality.`;

        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'jobDescription'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate job description');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        // Store for download
        jdData.generatedContent = content;
        
        // Close job description builder modal
        closeJobDescriptionBuilder();
        
        // Show preview
        document.getElementById('jdPreviewContent').innerHTML = '<pre class="whitespace-pre-wrap text-slate-200">' + content + '</pre>';
        document.getElementById('jobDescriptionPreviewModal').classList.remove('hidden');
        
        trackEvent('job_description_generated', { jobTitle: jdData.jobTitle, experienceLevel: jdData.experienceLevel });
    } catch (error) {
        showToast('Error generating job description', 'error');
        
        // Show wizard steps again on error
        document.getElementById('jdGenerating').classList.add('hidden');
        document.getElementById('jdBuilderSteps').classList.remove('hidden');
    }
}

function closeJobDescriptionPreview() {
    document.getElementById('jobDescriptionPreviewModal').classList.add('hidden');
    
    // Reset builder state when closing preview
    document.getElementById('jdGenerating').classList.add('hidden');
    document.getElementById('jdBuilderSteps').classList.remove('hidden');
}

async function downloadJobDescription(format) {
    const content = jdData.generatedContent || document.getElementById('jdPreviewContent').innerText;
    const filename = `Job_Description_${jdData.jobTitle.replace(/\s+/g, '_')}`;
    
    if (format === 'docx') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate Word document using existing function
            await generateWordDocument(htmlContent, `${filename}.docx`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Job Description'
            });
            
            trackEvent('job_description_downloaded', { format: 'docx', jobTitle: jdData.jobTitle });
        } catch (error) {
            showToast('Error generating Word document', 'error');
        }
    } else if (format === 'pdf') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate PDF using existing function
            await generatePDFDocument(htmlContent, `${filename}.pdf`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Job Description'
            });
            
            trackEvent('job_description_downloaded', { format: 'pdf', jobTitle: jdData.jobTitle });
        } catch (error) {
            showToast('Error generating PDF document', 'error');
        }
    }
}

function resetJobDescription() {
    // Close preview modal
    closeJobDescriptionPreview();
    
    // Reset all data
    jdCurrentStep = 1;
    jdData = {
        jobTitle: '',
        experienceLevel: '',
        responsibilities: '',
        qualifications: '',
        generatedContent: ''
    };
    
    // Clear all inputs
    document.getElementById('jdJobTitle').value = '';
    document.getElementById('jdResponsibilities').value = '';
    document.getElementById('jdQualifications').value = '';
    
    // Reset loading/textarea visibility
    document.getElementById('jdResponsibilitiesLoading').classList.add('hidden');
    document.getElementById('jdResponsibilities').classList.remove('hidden');
    document.getElementById('jdResponsibilitiesHelp').classList.remove('hidden');
    
    // Show steps, hide loading
    document.getElementById('jdBuilderSteps').classList.remove('hidden');
    document.getElementById('jdGenerating').classList.add('hidden');
    
    // Reset step highlighting
    document.querySelectorAll('.jd-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    
    // Update step display
    updateJDStep();
    
    // Open builder
    openJobDescriptionBuilder();
    
    showToast('Ready to create a new job description!', 'success');
}

// Interview Questions Generator
let iqCurrentStep = 1;
let iqData = {
    jobTitle: '',
    experienceLevel: '',
    categories: [],
    questionCount: 15
};

function openInterviewQuestionsGenerator() {
    trackToolUsage('interviewQuestionsGenerator');
    iqCurrentStep = 1;
    iqData = { jobTitle: '', experienceLevel: '', categories: [], questionCount: 15 };
    updateIQStep();
    var modal = document.getElementById('interviewQuestionsModal');
    if (modal) modal.classList.remove('hidden');
}

function closeInterviewQuestions() {
    // Hide the modal
    var modal = document.getElementById('interviewQuestionsModal');
    if (modal) modal.classList.add('hidden');
    
    // Reset loading screen state
    document.getElementById('iqGenerating').classList.add('hidden');
    document.getElementById('iqBuilderSteps').classList.remove('hidden');
}

function updateIQStep() {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById('iqStep' + i);
        if (step) step.classList.add('hidden');
    }
    
    // Show current step
    const currentStepEl = document.getElementById('iqStep' + iqCurrentStep);
    if (currentStepEl) currentStepEl.classList.remove('hidden');
    
    // Update step counter
    document.getElementById('iqStep').textContent = iqCurrentStep;
    
    // Update buttons
    document.getElementById('iqBackBtn').classList.toggle('hidden', iqCurrentStep === 1);
    document.getElementById('iqNextBtn').classList.toggle('hidden', iqCurrentStep === 4);
    document.getElementById('iqGenerateBtn').classList.toggle('hidden', iqCurrentStep !== 4);
}

function iqNextStep() {
    if (iqCurrentStep === 1) {
        const jobTitle = document.getElementById('iqJobTitle').value.trim();
        if (!jobTitle) {
            showAlert('Please enter a job title');
            return;
        }
        iqData.jobTitle = jobTitle;
    }
    
    if (iqCurrentStep === 2 && !iqData.experienceLevel) {
        showAlert('Please select an experience level');
        return;
    }
    
    if (iqCurrentStep === 3) {
        iqData.categories = [];
        if (document.getElementById('iqTechnical').checked) iqData.categories.push('Technical');
        if (document.getElementById('iqBehavioral').checked) iqData.categories.push('Behavioral');
        if (document.getElementById('iqSituational').checked) iqData.categories.push('Situational');
        
        if (iqData.categories.length === 0) {
            showAlert('Please select at least one category');
            return;
        }
    }
    
    if (iqCurrentStep < 4) {
        iqCurrentStep++;
        updateIQStep();
    }
}

function iqPreviousStep() {
    if (iqCurrentStep > 1) {
        iqCurrentStep--;
        updateIQStep();
    }
}

function selectIQExperience(level) {
    iqData.experienceLevel = level;
    document.querySelectorAll('.iq-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.iq-experience-btn').classList.remove('border-slate-600');
    event.target.closest('.iq-experience-btn').classList.add('border-amber-500');
    setTimeout(() => iqNextStep(), 300);
}

function selectIQCount(count) {
    iqData.questionCount = count;
    document.querySelectorAll('.iq-count-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    event.target.closest('.iq-count-btn').classList.remove('border-slate-600');
    event.target.closest('.iq-count-btn').classList.add('border-amber-500');
}

async function generateInterviewQuestions() {
    if (!iqData.questionCount) {
        showAlert('Please select number of questions');
        return;
    }
    
    // Hide wizard steps, show loading
    document.getElementById('iqBuilderSteps').classList.add('hidden');
    document.getElementById('iqGenerating').classList.remove('hidden');
    
    try {
        // Simplified prompt for faster generation
        const prompt = `Generate ${iqData.questionCount} interview questions for a ${iqData.experienceLevel} level ${iqData.jobTitle} position in Australian hospitality.

Categories: ${iqData.categories.join(', ')}

Keep it concise - just list the questions with brief context.`;

        const response = await fetch('/.netlify/functions/recruitment-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                taskType: 'interviewQuestions'
            })
        });
        
        // Check if response is HTML (error page) instead of JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned an error. This may be due to a timeout. Try requesting fewer questions (10 instead of 20).');
        }
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to generate interview questions');
        }
        
        // Get the content directly from the response
        const content = result.content;
        
        // Store for download
        iqData.generatedContent = content;
        
        // Close interview questions modal
        closeInterviewQuestions();
        
        // Show preview
        document.getElementById('iqPreviewContent').innerHTML = '<pre class="whitespace-pre-wrap text-slate-200">' + content + '</pre>';
        document.getElementById('interviewQuestionsPreviewModal').classList.remove('hidden');
        
        trackEvent('interview_questions_generated', { jobTitle: iqData.jobTitle, count: iqData.questionCount });
    } catch (error) {
        // Show user-friendly error message
        let errorMessage = 'Error generating questions';
        if (error.message.includes('timeout') || error.message.includes('fewer questions')) {
            errorMessage = 'Generation took too long. Try selecting fewer questions (10 or 15 instead of 20).';
        }
        
        showToast(errorMessage, 'error');
        
        // Show wizard steps again on error
        document.getElementById('iqGenerating').classList.add('hidden');
        document.getElementById('iqBuilderSteps').classList.remove('hidden');
    }
}

function closeInterviewQuestionsPreview() {
    document.getElementById('interviewQuestionsPreviewModal').classList.add('hidden');
    
    // Reset builder state when closing preview
    document.getElementById('iqGenerating').classList.add('hidden');
    document.getElementById('iqBuilderSteps').classList.remove('hidden');
}

async function downloadInterviewQuestions(format) {
    const content = iqData.generatedContent || document.getElementById('iqPreviewContent').innerText;
    const filename = `Interview_Questions_${iqData.jobTitle.replace(/\s+/g, '_')}`;
    
    if (format === 'docx') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate Word document using existing function
            await generateWordDocument(htmlContent, `${filename}.docx`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Interview Questions'
            });
            
            trackEvent('interview_questions_downloaded', { format: 'docx', jobTitle: iqData.jobTitle });
        } catch (error) {
            showToast('Error generating Word document', 'error');
        }
    } else if (format === 'pdf') {
        try {
            // Convert markdown-style content to HTML
            const htmlContent = convertMarkdownToHTML(content);
            
            // Generate PDF using existing function
            await generatePDFDocument(htmlContent, `${filename}.pdf`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Interview Questions'
            });
            
            trackEvent('interview_questions_downloaded', { format: 'pdf', jobTitle: iqData.jobTitle });
        } catch (error) {
            showToast('Error generating PDF document', 'error');
        }
    }
}

function resetInterviewQuestions() {
    // Close preview modal
    closeInterviewQuestionsPreview();
    
    // Reset all data
    iqCurrentStep = 1;
    iqData = {
        jobTitle: '',
        experienceLevel: '',
        categories: [],
        questionCount: 15,
        generatedContent: ''
    };
    
    // Clear inputs
    document.getElementById('iqJobTitle').value = '';
    
    // Reset checkboxes
    document.getElementById('iqTechnical').checked = true;
    document.getElementById('iqBehavioral').checked = true;
    document.getElementById('iqSituational').checked = true;
    
    // Show steps, hide loading
    document.getElementById('iqBuilderSteps').classList.remove('hidden');
    document.getElementById('iqGenerating').classList.add('hidden');
    
    // Reset button highlighting
    document.querySelectorAll('.iq-experience-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    
    document.querySelectorAll('.iq-count-btn').forEach(btn => {
        btn.classList.remove('border-amber-500');
        btn.classList.add('border-slate-600');
    });
    
    // Highlight default (15 questions)
    const defaultBtn = document.querySelector('[onclick="selectIQCount(15)"]');
    if (defaultBtn) {
        defaultBtn.classList.remove('border-slate-600');
        defaultBtn.classList.add('border-amber-500');
    }
    
    // Update step display
    updateIQStep();
    
    // Open generator
    openInterviewQuestionsGenerator();
    
    showToast('Ready to create new interview questions!', 'success');
}

// Reference Check Form
function openReferenceCheckForm() {
    trackToolUsage('referenceCheckForm');
    var modal = document.getElementById('referenceCheckModal');
    if (modal) modal.classList.remove('hidden');
}

function closeReferenceCheck() {
    var modal = document.getElementById('referenceCheckModal');
    if (modal) modal.classList.add('hidden');
}

function generateReferenceCheck() {
    const candidateName = document.getElementById('rcCandidateName').value.trim();
    const position = document.getElementById('rcPosition').value.trim();
    const refereeName = document.getElementById('rcRefereeName').value.trim();
    const relationship = document.getElementById('rcRelationship').value.trim();
    const company = document.getElementById('rcCompany').value.trim();
    
    if (!candidateName || !position || !refereeName || !relationship || !company) {
        showAlert('Please fill in all required fields (marked with *)');
        return;
    }
    
    const phone = document.getElementById('rcPhone').value.trim();
    const startDate = document.getElementById('rcStartDate').value.trim();
    const endDate = document.getElementById('rcEndDate').value.trim();
    
    // Generate form content
    const formContent = `
    <div class="space-y-4 text-slate-200">
        <div class="text-center border-b border-slate-700 pb-4">
            <h3 class="text-2xl font-bold">EMPLOYMENT REFERENCE CHECK</h3>
            <p class="text-slate-400 mt-2">Confidential</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 bg-slate-800 p-4 rounded">
            <div><strong>Candidate:</strong> ${candidateName}</div>
            <div><strong>Position:</strong> ${position}</div>
            <div><strong>Referee:</strong> ${refereeName}</div>
            <div><strong>Relationship:</strong> ${relationship}</div>
            <div><strong>Company:</strong> ${company}</div>
            <div><strong>Phone:</strong> ${phone || 'N/A'}</div>
            <div><strong>Employment Period:</strong> ${startDate} - ${endDate}</div>
        </div>
        
        <div class="space-y-3">
            <h4 class="font-bold text-lg mt-6">Reference Check Questions:</h4>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>1. Can you confirm the candidate's employment dates and position?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>2. How would you rate their overall performance?</strong>
                <div class="mt-2 text-slate-400">â˜ Excellent  â˜ Good  â˜ Satisfactory  â˜ Needs Improvement</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>3. What were their key strengths?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>4. Were there any areas for improvement?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>5. How did they handle pressure and busy periods?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>6. Were they reliable and punctual?</strong>
                <div class="mt-2 text-slate-400">â˜ Always  â˜ Usually  â˜ Sometimes  â˜ Rarely</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>7. How did they work with team members and customers?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>8. Why did they leave?</strong>
                <div class="mt-2 text-slate-400">Answer: _______________</div>
            </div>
            
            <div class="bg-slate-800 p-3 rounded">
                <strong>9. Would you re-employ them?</strong>
                <div class="mt-2 text-slate-400">â˜ Yes  â˜ No  â˜ Maybe</div>
            </div>
            
            <div class="bg-red-500/10 border border-red-500/30 p-3 rounded mt-4">
                <strong class="text-red-400">âš ï¸ RED FLAGS TO NOTE:</strong>
                <ul class="text-sm mt-2 space-y-1">
                    <li>â€¢ Hesitation or vague answers</li>
                    <li>â€¢ Contradictions with candidate's claims</li>
                    <li>â€¢ Refusal to answer specific questions</li>
                    <li>â€¢ Negative tone or body language</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-slate-700">
            <p class="text-sm text-slate-400">Completed by: _______________ Date: _______________</p>
            <p class="text-sm text-slate-400 mt-2">Signature: _______________</p>
        </div>
        
        <div class="bg-blue-500/10 border border-blue-500/30 p-3 rounded text-sm">
            <strong>Legal Compliance Note:</strong> This reference check complies with Australian privacy laws. 
            Information collected is confidential and used solely for employment assessment purposes.
        </div>
    </div>
    `;
    
    closeReferenceCheck();
    document.getElementById('rcPreviewContent').innerHTML = formContent;
    document.getElementById('referenceCheckPreviewModal').classList.remove('hidden');
    
    trackEvent('reference_check_generated', { candidateName: candidateName, position: position });
}

function closeReferenceCheckPreview() {
    document.getElementById('referenceCheckPreviewModal').classList.add('hidden');
}

async function downloadReferenceCheck(format) {
    // Get the content from preview
    const content = document.getElementById('rcPreviewContent').innerHTML;
    const candidateName = document.getElementById('rcCandidateName').value.trim();
    const filename = `Reference_Check_${candidateName.replace(/\s+/g, '_')}`;
    
    if (format === 'docx') {
        try {
            // Generate Word document using existing function
            await generateWordDocument(content, `${filename}.docx`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Reference Check'
            });
            
            trackEvent('reference_check_downloaded', { format: 'docx', candidateName: candidateName });
        } catch (error) {
            showToast('Error generating Word document', 'error');
        }
    } else if (format === 'pdf') {
        try {
            // Generate PDF using existing function
            await generatePDFDocument(content, `${filename}.pdf`, {
                documentId: generateDocumentId(),
                userName: currentUser,
                documentType: 'Reference Check'
            });
            
            trackEvent('reference_check_downloaded', { format: 'pdf', candidateName: candidateName });
        } catch (error) {
            showToast('Error generating PDF document', 'error');
        }
    }
}


// Close upload menu when clicking outside
document.addEventListener('click', function(e) {
    const uploadBtn = document.getElementById('uploadButton');
    const uploadMenu = document.getElementById('uploadMenu');
    
    if (uploadMenu && !uploadMenu.classList.contains('hidden')) {
        if (!uploadBtn.contains(e.target) && !uploadMenu.contains(e.target)) {
            uploadMenu.classList.add('hidden');
        }
    }
});

// Trigger file upload by type
function triggerFileUpload(type) {
    // Close menu
    var menu = document.getElementById('uploadMenu');
    if (menu) menu.classList.add('hidden');
    
    // Trigger the appropriate hidden file input
    var inputId = type + 'UploadInput';
    var input = document.getElementById(inputId);
    if (input) {
        input.click();
    } else {
    }
}

// Handle file upload (documents)
async function handleFileUpload(event) {
    var file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (10MB max)
    var maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('âŒ File too large. Max 10MB', 'error', 3000);
        event.target.value = '';
        return;
    }
    
    // Detect file type
    var fileName = file.name.toLowerCase();
    var fileType = 'document';
    var icon = 'ðŸ“„';
    
    if (fileName.endsWith('.pdf')) {
        fileType = 'PDF';
        icon = 'ðŸ“„';
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
        fileType = 'Excel/CSV';
        icon = 'ðŸ“Š';
    } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
        fileType = 'Word';
        icon = 'ðŸ“';
    } else if (fileName.endsWith('.txt')) {
        fileType = 'Text';
        icon = 'ðŸ“„';
    }
    
    // Show uploading message
    showToast('ðŸ“¤ Uploading ' + file.name + '...', 'info', 2000);
    
    try {
        var result = await readFileContent(file);
        
        if (result && result.success) {
            // Show file in chat
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var fileMsg = icon + ' Uploaded: ' + file.name + ' (' + size + ')';
            
            addMessage('user', fileMsg);
            conversationHistory.push({ role: 'user', content: fileMsg });
            saveCurrentConversation();
            
            // Pre-fill message input with file context
            var input = document.getElementById('messageInput');
            if (input && result.text) {
                var prompt = 'I uploaded "' + file.name + '". Please help me with this ' + fileType + ' document.\n\n';
                
                // Add preview of content
                var preview = result.text.substring(0, 400);
                if (result.text.length > 400) preview += '...';
                
                input.value = prompt + 'Content:\n' + preview;
                autoResizeTextarea(input);
                input.focus();
            }
            
            showToast('âœ… ' + file.name + ' uploaded!', 'success', 3000);
        } else {
            throw new Error('Processing failed');
        }
    } catch (error) {
        showToast('âŒ Error: ' + error.message, 'error', 4000);
    }
    
    // Reset input
    event.target.value = '';
}

// Handle image upload
async function handleImageUpload(event) {
    var file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB max for images)
    var maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('âŒ Image too large. Max 5MB', 'error', 3000);
        event.target.value = '';
        return;
    }
    
    showToast('ðŸ“¤ Uploading image...', 'info', 2000);
    
    try {
        var reader = new FileReader();
        
        reader.onload = function(e) {
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var imgMsg = 'ðŸ–¼ï¸ Uploaded image: ' + file.name + ' (' + size + ')';
            
            // Add to chat
            addMessage('user', imgMsg);
            conversationHistory.push({ role: 'user', content: imgMsg });
            saveCurrentConversation();
            
            // Pre-fill input
            var input = document.getElementById('messageInput');
            if (input) {
                input.value = 'I uploaded an image "' + file.name + '". Please describe what you see and provide relevant insights.';
                autoResizeTextarea(input);
                input.focus();
            }
            
            showToast('âœ… Image uploaded!', 'success', 3000);
        };
        
        reader.onerror = function() {
            showToast('âŒ Failed to read image', 'error', 3000);
        };
        
        reader.readAsDataURL(file);
    } catch (error) {
        showToast('âŒ Error: ' + error.message, 'error', 4000);
    }
    
    // Reset input
    event.target.value = '';
}

// Read file content
async function readFileContent(file) {
    return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                var text = '';
                var fileInfo = 'File: ' + file.name + '\n';
                fileInfo += 'Size: ' + (file.size / 1024).toFixed(2) + ' KB\n\n';
                
                // Handle CSV files specially - read as text
                if (file.name.toLowerCase().endsWith('.csv')) {
                    var csvContent = e.target.result;
                    var lines = csvContent.split('\n');
                    text = fileInfo + 'CSV Data (first 20 rows):\n\n';
                    text += lines.slice(0, 20).join('\n');
                    if (lines.length > 20) {
                        text += '\n\n[' + (lines.length - 20) + ' more rows...]';
                    }
                } else if (file.name.toLowerCase().endsWith('.txt')) {
                    text = fileInfo + 'Text content:\n\n' + e.target.result;
                } else {
                    // For PDF, Word, Excel - just show metadata
                    text = fileInfo + 'Document uploaded and ready for analysis.\n';
                    text += 'Note: Full text extraction requires specialized libraries.';
                }
                
                resolve({
                    success: true,
                    text: text,
                    fileData: e.target.result
                });
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Failed to read file'));
        };
        
        // Read CSV and TXT as text, others as data URL
        if (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}


// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    // Collapse back to single row when empty
    if (!textarea.value.trim()) {
        textarea.style.height = '44px';
    } else {
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }
}

// Scroll to bottom of messages (for mobile button)
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
        });
        // Update button visibility after scroll completes
        setTimeout(updateScrollButtonVisibility, 500);
    }
}

/**
 * Scroll to bottom instantly without animation
 * Used for initial page load so user immediately sees most recent messages
 */
function scrollToBottomInstant() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
        // Update button visibility
        setTimeout(updateScrollButtonVisibility, 100);
    }
}

// Update scroll button visibility based on scroll position
function updateScrollButtonVisibility() {
    const container = document.getElementById('messagesContainer');
    const btn = document.getElementById('scrollToBottomBtn');
    
    if (!container || !btn) return;
    
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
    
    // Show button when scrolled up more than 150px from bottom AND content is scrollable
    if (distanceFromBottom > 150 && scrollHeight > clientHeight) {
        btn.classList.add('visible');
    } else {
        btn.classList.remove('visible');
    }
}

// Create new chat from sidebar
function createNewChatFromSidebar() {
    createNewConversation();
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        toggleSidebar();
    }
}

// Sidebar search
function performSidebarSearch() {
    const query = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('sidebarSearchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    // Search through conversation history
    const results = conversationHistory_searchable.filter(conv => 
        conv.content.toLowerCase().includes(query)
    );
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-500 text-xs py-2">No results</p>';
        return;
    }
    
    resultsDiv.innerHTML = results.slice(0, 5).map(conv => {
        const preview = conv.content.substring(0, 60) + '...';
        return `<div class="text-xs text-slate-300 py-2 px-2 hover:bg-slate-700 rounded cursor-pointer">${preview}</div>`;
    }).join('');
}

// ========================================
// WEEK 3 PHASE 1: POWER USER FEATURES
// ========================================

// Bookmarks Storage
let conversationHistory_searchable = []; // Searchable version of conversations
let uploadedFiles = [];
let currentChart = null;

/**
 * Toggle Quick Actions Menu
 */
function toggleQuickActions() {
    const menu = document.getElementById('quickActionsMenu');
    menu.classList.toggle('show');
}

/**
 * Close quick actions when clicking outside
 */
document.addEventListener('click', (e) => {
    const quickActions = document.querySelector('.quick-actions-fab');
    const menu = document.getElementById('quickActionsMenu');
    if (quickActions && menu && !quickActions.contains(e.target)) {
        menu.classList.remove('show');
    }
});

// ===================
// SEARCH FUNCTIONALITY
// ===================

function openSearchModal() {
    document.getElementById('searchModal').classList.remove('hidden');
    document.getElementById('searchInput').focus();
    toggleQuickActions();
}

function closeSearchModal() {
    document.getElementById('searchModal').classList.add('hidden');
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '<p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>';
}

function performSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '<p class="text-slate-400 text-center py-8">Type to search your conversation history...</p>';
        return;
    }
    
    // Search through conversation history
    const results = conversationHistory_searchable.filter(conv => 
        conv.content.toLowerCase().includes(query)
    );
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-slate-400 text-center py-8">No results found</p>';
        return;
    }
    
    // Display results
    resultsDiv.innerHTML = results.map((conv, index) => {
        const highlighted = highlightSearchTerm(conv.content, query);
        return `
            <div class="search-result" onclick="jumpToMessage(${index})">
                <div class="flex items-start justify-between mb-2">
                    <span class="text-xs text-slate-500">${conv.role === 'user' ? 'ðŸ‘¤ You' : 'ðŸ¤– Fitz'}</span>
                    <span class="text-xs text-slate-500">${conv.timestamp || 'Recent'}</span>
                </div>
                <div class="text-sm text-slate-300">${highlighted}</div>
            </div>
        `;
    }).join('');
}

function highlightSearchTerm(text, query) {
    const maxLength = 200;
    const lowerText = text.toLowerCase();
    const index = lowerText.indexOf(query.toLowerCase());
    
    if (index === -1) return text.substring(0, maxLength) + '...';
    
    const start = Math.max(0, index - 50);
    const end = Math.min(text.length, index + query.length + 100);
    let snippet = text.substring(start, end);
    
    if (start > 0) snippet = '...' + snippet;
    if (end < text.length) snippet = snippet + '...';
    
    // Highlight the match
    const regex = new RegExp(`(${query})`, 'gi');
    snippet = snippet.replace(regex, '<span class="search-highlight">$1</span>');
    
    return snippet;
}

function jumpToMessage(index) {
    closeSearchModal();
    showToast('Feature coming soon: Jump to message', 'info');
}

// Update conversation history for search
function updateSearchableHistory() {
    conversationHistory_searchable = conversationHistory.map((conv, index) => ({
        ...conv,
        index: index,
        timestamp: new Date().toLocaleString()
    }));
}

// ===================
// MULTI-FILE UPLOAD
// ===================

function openMultiFileModal() {
    document.getElementById('multiFileModal').classList.remove('hidden');
    toggleQuickActions();
}

function closeMultiFileModal() {
    document.getElementById('multiFileModal').classList.add('hidden');
    uploadedFiles = [];
    document.getElementById('filesList').innerHTML = '';
    document.getElementById('processFilesBtn').disabled = true;
}

// Setup drag and drop
const dropZone = document.getElementById('dropZone');
if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('drag-over');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('drag-over');
        }, false);
    });
    
    dropZone.addEventListener('drop', handleDrop, false);
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleMultiFileSelect({ target: { files } });
}

function handleMultiFileSelect(event) {
    const files = Array.from(event.target.files);
    
    if (files.length > 10) {
        showToast('Maximum 10 files allowed', 'warning');
        return;
    }
    
    uploadedFiles = files.filter(file => {
        const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (!validTypes.includes(file.type)) {
            showToast(`${file.name}: Invalid file type`, 'error');
            return false;
        }
        
        if (file.size > maxSize) {
            showToast(`${file.name}: File too large (max 5MB)`, 'error');
            return false;
        }
        
        return true;
    });
    
    renderFilesList();
    document.getElementById('processFilesBtn').disabled = uploadedFiles.length === 0;
}

function renderFilesList() {
    const listDiv = document.getElementById('filesList');
    
    if (uploadedFiles.length === 0) {
        listDiv.innerHTML = '';
        return;
    }
    
    listDiv.innerHTML = `
        <div class="mb-4">
            <h3 class="text-white font-semibold mb-3">Selected Files (${uploadedFiles.length})</h3>
            ${uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="text-2xl">${getFileIcon(file.type)}</span>
                    <div class="flex-1">
                        <div class="text-white font-medium">${file.name}</div>
                        <div class="text-xs text-slate-400">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                </div>
            `).join('')}
        </div>
    `;
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    renderFilesList();
    document.getElementById('processFilesBtn').disabled = uploadedFiles.length === 0;
}

function getFileIcon(type) {
    if (type.includes('pdf')) return 'ðŸ“„';
    if (type.includes('word')) return 'ðŸ“';
    if (type.includes('sheet')) return 'ðŸ“Š';
    if (type.includes('csv')) return 'ðŸ“ˆ';
    return 'ðŸ“';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function processMultipleFiles() {
    showLoadingOverlay('filesList', 'Processing files...');
    
    try {
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showToast(`Successfully processed ${uploadedFiles.length} files!`, 'success');
        hideLoadingOverlay('filesList');
        
        setTimeout(() => {
            closeMultiFileModal();
        }, 1500);
        
    } catch (error) {
        hideLoadingOverlay('filesList');
        handleError(error, 'processMultipleFiles');
    }
}

// ===================
// ANALYTICS DASHBOARD
// ===================

function showAnalyticsDashboard() {
    document.getElementById('analyticsModal').classList.remove('hidden');
    renderUsageChart();
    toggleQuickActions();
}

function closeAnalyticsModal() {
    document.getElementById('analyticsModal').classList.add('hidden');
}

function switchChart(type) {
    // Update tab styles
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('text-purple-400', 'border-b-2', 'border-purple-400');
        tab.classList.add('text-slate-400');
    });
    
    const activeTab = document.querySelector(`[data-chart="${type}"]`);
    activeTab.classList.remove('text-slate-400');
    activeTab.classList.add('text-purple-400', 'border-b-2', 'border-purple-400');
    
    // Render appropriate chart
    if (type === 'usage') renderUsageChart();
    else if (type === 'tools') renderToolsChart();
    else if (type === 'engagement') renderEngagementChart();
}

function renderUsageChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Messages',
                data: [12, 19, 15, 25, 22, 30, 28],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                },
                x: {
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                }
            }
        }
    });
}

function renderToolsChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Award Wizard', 'Document Builder', 'Calculator', 'Roster', 'Compliance'],
            datasets: [{
                label: 'Uses',
                data: [45, 38, 32, 28, 22],
                backgroundColor: [
                    '#f59e0b',
                    '#3b82f6',
                    '#10b981',
                    '#8b5cf6',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                },
                x: {
                    ticks: { color: '#cbd5e1' },
                    grid: { color: '#475569' }
                }
            }
        }
    });
}

function renderEngagementChart() {
    const ctx = document.getElementById('analyticsChart');
    if (!ctx) return;
    
    if (currentChart) currentChart.destroy();
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Active Users', 'New Users', 'Returning Users'],
            datasets: [{
                data: [45, 30, 25],
                backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            }
        }
    });
}

function exportDetailedAnalytics() {
    showToast('Exporting analytics report...', 'info');
    
    setTimeout(() => {
        showToast('Report exported successfully!', 'success');
    }, 1500);
}

// ===================
// WEEK 2: LOADING STATES, TOASTS, & POLISH
// ===================

/**
 * Show a toast notification
 * @param {string} message - Message to display
 * @param {string} type - 'success', 'error', 'warning', or 'info'
 * @param {number} duration - How long to show (ms), default 4000
 */
function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const icons = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš ',
        info: 'â„¹'
    };
    
    toast.className = `toast toast-${type} toast-enter`;
    toast.innerHTML = `
        <span style="font-size: 20px; flex-shrink: 0;">${icons[type]}</span>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div style="font-size: 14px; opacity: 0.9;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="font-size: 20px; opacity: 0.6; hover:opacity: 1; background: none; border: none; padding: 0; cursor: pointer;">Ã—</button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after duration
    setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

/**
 * Show loading skeleton for chat message
 * @returns {HTMLElement} - The skeleton element
 */


/**
 * Styled in-app alert replacement for native showAlert()
 * @param {string} message - Message to display (supports \n for line breaks)
 */
function showAlert(message) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'styledAlertOverlay';
    overlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-[9999]';
    overlay.style.animation = 'fadeIn 0.15s ease-out';
    
    // Convert newlines to HTML breaks and handle emoji headers
    let formattedMessage = message
        .replace(/\n/g, '<br>')
        .replace(/^(âš ï¸|âœ…|âœ“|ðŸš¨|ðŸ”—|âŒ)\s*/g, '<span class="text-2xl block mb-2">$1</span>');
    
    overlay.innerHTML = `
        <div class="bg-slate-800 rounded-2xl border border-slate-600 p-6 max-w-md w-full shadow-2xl" style="animation: fadeIn 0.2s ease-out;">
            <div class="text-slate-100 text-sm leading-relaxed mb-6">${formattedMessage}</div>
            <button onclick="document.getElementById('styledAlertOverlay').remove()" 
                    class="w-full py-3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold rounded-lg transition-all">
                OK
            </button>
        </div>
    `;
    
    // Close on overlay click (not inner content)
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
    
    // Close on Escape
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            overlay.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
    
    document.body.appendChild(overlay);
    
    // Focus the OK button for keyboard accessibility
    overlay.querySelector('button').focus();
}

function showChatSkeleton() {
    const container = document.getElementById('messagesContainer');
    const skeleton = document.createElement('div');
    skeleton.className = 'bg-slate-700 rounded-xl p-6 mb-4 fade-in skeleton-message';
    skeleton.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="skeleton w-8 h-8 rounded-full"></div>
            <div class="flex-1 space-y-2">
                <div class="skeleton h-4 w-3/4"></div>
                <div class="skeleton h-4 w-full"></div>
                <div class="skeleton h-4 w-5/6"></div>
            </div>
        </div>
    `;
    container.appendChild(skeleton);
    container.scrollTop = container.scrollHeight;
    return skeleton;
}

/**
 * Remove chat skeleton
 * @param {HTMLElement} skeleton - The skeleton element to remove
 */
function removeChatSkeleton(skeleton) {
    if (skeleton && skeleton.parentNode) {
        skeleton.style.opacity = '0';
        skeleton.style.transition = 'opacity 0.3s';
        setTimeout(() => skeleton.remove(), 300);
    }
}

/**
 * Show loading overlay on an element
 * @param {string} elementId - ID of element to show overlay on
 * @param {string} message - Loading message
 */
function showLoadingOverlay(elementId, message = 'Loading...') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.id = `${elementId}-overlay`;
    overlay.innerHTML = `
        <div class="text-center">
            <div class="spinner inline-block w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full mb-4"></div>
            <div class="text-white font-medium">${message}</div>
        </div>
    `;
    element.style.position = 'relative';
    element.appendChild(overlay);
}

/**
 * Hide loading overlay
 * @param {string} elementId - ID of element with overlay
 */
function hideLoadingOverlay(elementId) {
    const overlay = document.getElementById(`${elementId}-overlay`);
    if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 300);
    }
}

/**
 * Enhanced error handler with user-friendly messages
 * @param {Error} error - The error object
 * @param {string} context - Context of where error occurred
 */
function handleError(error, context = '') {
    let userMessage = 'Something went wrong. Please try again.';
    
    // Provide specific messages for common errors
    if (error.message.includes('network') || error.message.includes('fetch')) {
        userMessage = 'Network error. Please check your internet connection.';
    } else if (error.message.includes('timeout')) {
        userMessage = 'Request timed out. Please try again.';
    } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
        userMessage = 'Session expired. Please refresh the page and log in again.';
    } else if (error.message.includes('404')) {
        userMessage = 'Resource not found. Please refresh the page.';
    } else if (error.message.includes('500')) {
        userMessage = 'Server error. Our team has been notified. Please try again later.';
    }
    
    showToast(userMessage, 'error', 6000);
    
    // Track error for analytics
    trackEvent('error_occurred', {
        context: context,
        error: error.message,
        user: currentUser
    });
}

/**
 * Add smooth scroll to element
 * @param {string} elementId - ID of element to scroll to
 */
function smoothScrollTo(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

/**
 * Debounce function for performance
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in ms
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Check if element is in viewport (for lazy loading)
 * @param {HTMLElement} element - Element to check
 */
function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

/**
 * Add keyboard navigation support
 */
function initKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        // Escape to close the topmost open modal
        if (e.key === 'Escape') {
            // List of all modal IDs in priority order (most specific first)
            const modalIds = [
                'styledAlertOverlay',
                'documentPreviewModal',
                'mobileToolsModal',
                'adminDashboardModal',
                'awardCalculatorModal',
                'awardWizardModal',
                'rosterOptimizerModal',
                'rosterStressTesterModal',
                'terminationRiskModal',
                'scenarioAnalysisModal',
                'complianceCalendarModal',
                'xeroIntegrationModal',
                'documentBuilderModal',
                'terminationConsultantModal',
                'venueOnboardingModal',
                'venueSettingsModal',
                'feedbackModal',
                'crisisModal',
                'searchModal',
                'bookmarksModal',
                'multiFileModal',
                'analyticsModal',
                'termsModal',
                'privacyModal',
                'logoutModal',
                'toolsMenu'
            ];
            
            // Close the first visible modal found
            for (const id of modalIds) {
                const modal = document.getElementById(id);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    // Special cleanup for document builder
                    if (id === 'documentBuilderModal' && typeof resetDocumentBuilderSilent === 'function') {
                        resetDocumentBuilderSilent();
                    }
                    e.preventDefault();
                    break;
                }
            }
            
            // Also close sidebar if open
            const sidebar = document.getElementById('chatSidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                toggleSidebar();
            }
        }
        
        // Ctrl/Cmd + K to focus search/input
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.focus();
            }
        }
        
        // Ctrl/Cmd + N for new chat
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            if (typeof createNewConversation === 'function') {
                createNewConversation();
            }
        }
    });
}

/**
 * Preload critical modals for better performance
 */
function preloadModals() {
    // Preload modal content that might be used frequently
    const criticalModals = ['documentBuilderModal', 'awardCalculatorModal'];
    criticalModals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Force browser to parse the modal HTML
            modal.offsetHeight;
        }
    });
}

/**
 * Add visual feedback when copying text
 * @param {string} text - Text that was copied
 */
function showCopyFeedback(text) {
    showToast('Copied to clipboard!', 'success', 2000);
}

/**
 * Validate form with visual feedback
 * @param {string} formId - ID of form to validate
 * @returns {boolean} - Whether form is valid
 */
function validateForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return false;
    
    let isValid = true;
    const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('border-red-500');
            input.classList.remove('border-slate-600');
            isValid = false;
            
            // Remove error state on input
            input.addEventListener('input', function() {
                this.classList.remove('border-red-500');
                this.classList.add('border-slate-600');
            }, { once: true });
        }
    });
    
    if (!isValid) {
        showToast('Please fill in all required fields', 'warning');
    }
    
    return isValid;
}

// ========================================
// TOOLS MENU
// ========================================
/**
 * Toggles visibility of the tools menu dropdown (desktop) or modal (mobile)
 * @returns {void}
 */
function toggleToolsMenu() {
    // Check if mobile (768px or less)
    if (window.innerWidth <= 768) {
        // Show mobile modal instead
        document.getElementById('mobileToolsModal').classList.remove('hidden');
    } else {
        // Show desktop dropdown
        DOM.toolsMenu.classList.toggle('hidden');
    }
}

/**
 * Closes the mobile tools modal
 * @returns {void}
 */
function closeMobileTools() {
    document.getElementById('mobileToolsModal').classList.add('hidden');
}

/**
 * Opens a tool from the mobile modal
 * @param {string} toolName - Name of tool to open
 * @returns {void}
 */
function openToolFromMobile(toolName) {
    closeMobileTools();
    openTool(toolName);
}

/**
 * Opens a specific tool modal and tracks the event
 * @param {string} toolName - Name of tool to open (e.g., 'awardCalculator')
 * @returns {void}
 */
function openTool(toolName) {
    // Close desktop dropdown only if on desktop
    if (window.innerWidth > 768) {
        DOM.toolsMenu.classList.add('hidden');
    }
    
    const modalMap = {
        'awardCalculator': 'awardCalculatorModal',
        'rosterOptimizer': 'rosterOptimizerModal',
        'terminationRisk': 'terminationRiskModal',
        'scenarioAnalysis': 'scenarioAnalysisModal',
        'xeroIntegration': 'xeroIntegrationModal',
        'awardWizard': 'awardWizardModal',
        'rosterStressTester': 'rosterStressTesterModal',
        'complianceCalendar': 'complianceCalendarModal',
        'documentBuilder': 'documentBuilderModal',
        'recruitmentToolkit': 'recruitmentToolkitModal',
        'newEmployeeToolkit': 'newEmployeeToolkitModal',
        'probationCheckIn': 'probationCheckInModal'
    };
    const modalId = modalMap[toolName];
    if (modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        trackEvent('tool_opened', { tool: toolName, user: currentUser });
    }
}

function closeToolModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    
    // Special handling for Document Builder - reset it silently when closed
    if (modalId === 'documentBuilderModal') {
        resetDocumentBuilderSilent();
    }
}

// ========================================
// VENUE ONBOARDING & PROFILE SYSTEM
// ========================================

function checkOnboardingStatus() {
    // Use currentUser.uid for Firebase users, or currentUser as string for access code users
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    const saved = localStorage.getItem('venueProfile_' + userKey);
    if (saved) {
        try {
            const profile = JSON.parse(saved);
            return profile.setupComplete === true;
        } catch (e) {
            return false;
        }
    }
    // Also check if venueProfile is already loaded (from Firebase sync)
    return venueProfile && venueProfile.setupComplete === true;
}

function showOnboarding() {
    document.getElementById('venueOnboardingModal').classList.remove('hidden');
    updateOnboardingStep();
}

function saveOnboardingAnswer(field, value, isLastStep = false) {
    venueProfile[field] = value;
    if (isLastStep) {
        completeOnboarding();
    } else {
        onboardingCurrentStep++;
        updateOnboardingStep();
    }
}

function saveOnboardingNameAndVenue() {
    const userName = document.getElementById('onboardingUserName').value.trim();
    const venueName = document.getElementById('onboardingVenueName').value.trim();
    
    if (!userName) {
        showAlert('Please enter your name');
        return;
    }
    
    if (!venueName) {
        showAlert('Please enter your venue name');
        return;
    }
    
    venueProfile.userName = userName;
    venueProfile.venueName = venueName;
    onboardingCurrentStep++;
    updateOnboardingStep();
}

function saveOnboardingLocation() {
    const location = document.getElementById('onboardingLocation').value;
    const city = document.getElementById('onboardingCity').value.trim();
    if (!location) {
        showAlert('Please select a state');
        return;
    }
    venueProfile.location = location;
    venueProfile.city = city || '';
    onboardingCurrentStep++;
    updateOnboardingStep();
}

function saveOnboardingVenueType() {
    const venueType = document.getElementById('onboardingVenueType').value;
    if (!venueType) {
        showAlert('Please select a venue type');
        return;
    }
    venueProfile.venueType = venueType;
    onboardingCurrentStep++;
    updateOnboardingStep();
}

function updateOnboardingStep() {
    document.querySelectorAll('.onboarding-step').forEach(step => step.classList.add('hidden'));
    const current = document.querySelector(`[data-step="${onboardingCurrentStep}"]`);
    if (current) current.classList.remove('hidden');
    
    document.getElementById('onboardingStep').textContent = onboardingCurrentStep;
    const progress = Math.round((onboardingCurrentStep / ONBOARDING_STEPS) * 100);
    document.getElementById('onboardingProgress').textContent = `${progress}% Complete`;
    document.getElementById('onboardingProgressBar').style.width = `${progress}%`;
}

function completeOnboarding() {
    venueProfile.setupComplete = true;
    venueProfile.setupDate = new Date().toISOString();
    
    // Use currentUser.uid for Firebase users, or currentUser as string for access code users
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    localStorage.setItem('venueProfile_' + userKey, JSON.stringify(venueProfile));
    
    // Sync to Firebase for cross-device access
    if (currentUser && currentUser.uid && db) {
        db.collection('users').doc(currentUser.uid).set({
            venueProfile: venueProfile
        }, { merge: true }).then(() => {
        }).catch(err => {
        });
    }
    
    // Update sidebar with new venue name
    updateSidebarVenueName();
    
    document.getElementById('venueOnboardingModal').classList.add('hidden');
    
    const venueType = getVenueTypeLabel(venueProfile.venueType);
    addMessage('assistant', `âœ… **Great! I've got your venue details saved.**

I now know you run a **${venueType}** in **${venueProfile.city || venueProfile.location}** with **${venueProfile.staffCount}** staff.

All my advice will be tailored for your venue. Update these anytime in âš™ï¸ Settings.

What can I help you with?`);
    
    trackEvent('onboarding_completed', venueProfile);
}

function skipOnboarding() {
    if (confirm('Skip onboarding? You can complete it later in Settings.')) {
        document.getElementById('venueOnboardingModal').classList.add('hidden');
        addMessage('assistant', 'No problem! Set up your venue profile anytime in âš™ï¸ Settings. What can I help you with?');
    }
}

function getVenueTypeLabel(type) {
    const labels = { 
        'bakery-cafe': 'bakery cafÃ©',
        'bar': 'bar',
        'bistro': 'bistro',
        'boutique-hotel': 'boutique hotel',
        'brewery': 'brewery/brewpub',
        'cafe': 'cafÃ©',
        'cinema-fnb': 'cinema with F&B service',
        'conference-venue': 'conference venue',
        'dessert-bar': 'dessert bar',
        'distillery-bar': 'distillery bar',
        'entertainment-venue': 'entertainment venue',
        'food-court': 'food court outlet',
        'function-centre': 'function centre',
        'hotel-accommodation': 'hotel (accommodation)',
        'ice-cream-bar': 'ice cream/gelato bar',
        'juice-bar': 'juice/smoothie bar',
        'live-music-venue': 'live music venue',
        'motel': 'motel',
        'nightclub': 'nightclub',
        'pub': 'pub/hotel',
        'resort': 'resort',
        'restaurant': 'restaurant',
        'rooftop-bar': 'rooftop bar',
        'serviced-apartments': 'serviced apartments',
        'sports-bar': 'sports bar',
        'tea-house': 'tea house',
        'wine-bar': 'wine bar',
        // Legacy values for backwards compatibility
        'hotel': 'hotel/pub',
        'fastfood': 'fast food venue',
        'club': 'club/bar',
        'other': 'hospitality venue'
    };
    return labels[type] || type || 'hospitality venue';
}

function showVenueSettings() {
    const modal = document.getElementById('venueSettingsModal');
    const content = document.getElementById('venueSettingsContent');
    
    content.innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-slate-300 text-sm mb-2">Your Name</label>
                <input type="text" id="settingsUserName" value="${venueProfile.userName || ''}" 
                       placeholder="e.g., Sarah Johnson"
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Venue Name</label>
                <input type="text" id="settingsVenueName" value="${venueProfile.venueName || ''}" 
                       placeholder="e.g., The Golden Fork"
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Venue Type</label>
                <select id="settingsVenueType" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    <option value="">Select venue type...</option>
                    <option value="bakery-cafe" ${venueProfile.venueType === 'bakery-cafe' ? 'selected' : ''}>Bakery CafÃ©</option>
                    <option value="bar" ${venueProfile.venueType === 'bar' ? 'selected' : ''}>Bar</option>
                    <option value="bistro" ${venueProfile.venueType === 'bistro' ? 'selected' : ''}>Bistro</option>
                    <option value="boutique-hotel" ${venueProfile.venueType === 'boutique-hotel' ? 'selected' : ''}>Boutique Hotel</option>
                    <option value="brewery" ${venueProfile.venueType === 'brewery' ? 'selected' : ''}>Brewery / Brewpub</option>
                    <option value="cafe" ${venueProfile.venueType === 'cafe' ? 'selected' : ''}>CafÃ©</option>
                    <option value="cinema-fnb" ${venueProfile.venueType === 'cinema-fnb' ? 'selected' : ''}>Cinema with Food & Beverage Service</option>
                    <option value="conference-venue" ${venueProfile.venueType === 'conference-venue' ? 'selected' : ''}>Conference Venue</option>
                    <option value="dessert-bar" ${venueProfile.venueType === 'dessert-bar' ? 'selected' : ''}>Dessert Bar</option>
                    <option value="distillery-bar" ${venueProfile.venueType === 'distillery-bar' ? 'selected' : ''}>Distillery Bar</option>
                    <option value="entertainment-venue" ${venueProfile.venueType === 'entertainment-venue' ? 'selected' : ''}>Entertainment Venue (Comedy Club / Theatre)</option>
                    <option value="food-court" ${venueProfile.venueType === 'food-court' ? 'selected' : ''}>Food Court Outlet</option>
                    <option value="function-centre" ${venueProfile.venueType === 'function-centre' ? 'selected' : ''}>Function Centre</option>
                    <option value="hotel-accommodation" ${venueProfile.venueType === 'hotel-accommodation' ? 'selected' : ''}>Hotel (Accommodation Venue)</option>
                    <option value="ice-cream-bar" ${venueProfile.venueType === 'ice-cream-bar' ? 'selected' : ''}>Ice Cream / Gelato Bar</option>
                    <option value="juice-bar" ${venueProfile.venueType === 'juice-bar' ? 'selected' : ''}>Juice / Smoothie Bar</option>
                    <option value="live-music-venue" ${venueProfile.venueType === 'live-music-venue' ? 'selected' : ''}>Live Music Venue</option>
                    <option value="motel" ${venueProfile.venueType === 'motel' ? 'selected' : ''}>Motel</option>
                    <option value="nightclub" ${venueProfile.venueType === 'nightclub' ? 'selected' : ''}>Nightclub</option>
                    <option value="pub" ${venueProfile.venueType === 'pub' ? 'selected' : ''}>Pub / Hotel</option>
                    <option value="resort" ${venueProfile.venueType === 'resort' ? 'selected' : ''}>Resort</option>
                    <option value="restaurant" ${venueProfile.venueType === 'restaurant' ? 'selected' : ''}>Restaurant</option>
                    <option value="rooftop-bar" ${venueProfile.venueType === 'rooftop-bar' ? 'selected' : ''}>Rooftop Bar</option>
                    <option value="serviced-apartments" ${venueProfile.venueType === 'serviced-apartments' ? 'selected' : ''}>Serviced Apartments</option>
                    <option value="sports-bar" ${venueProfile.venueType === 'sports-bar' ? 'selected' : ''}>Sports Bar</option>
                    <option value="tea-house" ${venueProfile.venueType === 'tea-house' ? 'selected' : ''}>Tea House</option>
                    <option value="wine-bar" ${venueProfile.venueType === 'wine-bar' ? 'selected' : ''}>Wine Bar</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">State</label>
                    <select id="settingsLocation" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        <option value="NSW" ${venueProfile.location === 'NSW' ? 'selected' : ''}>NSW</option>
                        <option value="VIC" ${venueProfile.location === 'VIC' ? 'selected' : ''}>VIC</option>
                        <option value="QLD" ${venueProfile.location === 'QLD' ? 'selected' : ''}>QLD</option>
                        <option value="SA" ${venueProfile.location === 'SA' ? 'selected' : ''}>SA</option>
                        <option value="WA" ${venueProfile.location === 'WA' ? 'selected' : ''}>WA</option>
                        <option value="TAS" ${venueProfile.location === 'TAS' ? 'selected' : ''}>TAS</option>
                        <option value="NT" ${venueProfile.location === 'NT' ? 'selected' : ''}>NT</option>
                        <option value="ACT" ${venueProfile.location === 'ACT' ? 'selected' : ''}>ACT</option>
                    </select>
                </div>
                <div>
                    <label class="block text-slate-300 text-sm mb-2">City/Suburb</label>
                    <input type="text" id="settingsCity" value="${venueProfile.city || ''}" 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                </div>
            </div>
            
            <div>
                <label class="block text-slate-300 text-sm mb-2">Staff Count</label>
                <select id="settingsStaffCount" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    <option value="1-5" ${venueProfile.staffCount === '1-5' ? 'selected' : ''}>1-5 staff</option>
                    <option value="6-15" ${venueProfile.staffCount === '6-15' ? 'selected' : ''}>6-15 staff</option>
                    <option value="16-30" ${venueProfile.staffCount === '16-30' ? 'selected' : ''}>16-30 staff</option>
                    <option value="30+" ${venueProfile.staffCount === '30+' ? 'selected' : ''}>30+ staff</option>
                </select>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function saveVenueSettings() {
    venueProfile.userName = document.getElementById('settingsUserName').value.trim();
    venueProfile.venueName = document.getElementById('settingsVenueName').value.trim();
    venueProfile.venueType = document.getElementById('settingsVenueType').value;
    venueProfile.location = document.getElementById('settingsLocation').value;
    venueProfile.city = document.getElementById('settingsCity').value.trim();
    venueProfile.staffCount = document.getElementById('settingsStaffCount').value;
    venueProfile.setupComplete = true;
    
    // Use currentUser.uid for Firebase users, or currentUser as string for access code users
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    localStorage.setItem('venueProfile_' + userKey, JSON.stringify(venueProfile));
    
    // Also save to Firebase for cross-device sync
    if (currentUser && currentUser.uid && db) {
        db.collection('users').doc(currentUser.uid).set({
            venueProfile: venueProfile
        }, { merge: true }).then(() => {
        }).catch(err => {
        });
    }
    
    // Update sidebar venue name
    updateSidebarVenueName();
    
    closeVenueSettings();
    showAlert('âœ… Venue settings saved!');
}

function closeVenueSettings() {

    document.getElementById('venueSettingsModal').classList.add('hidden');
}

// ========================================
// ADMIN ANALYTICS SYSTEM
// ========================================

async function trackConversation(userMessage, assistantResponse) {
    const conversation = {
        timestamp: new Date().toISOString(),
        user_code: currentUser,
        user_message: userMessage,
        assistant_response: assistantResponse,
        theme: detectTheme(userMessage),
        is_high_risk: detectHighRiskTopic(userMessage) !== null,
        venue_type: venueProfile.setupComplete ? venueProfile.venueType : null,
        venue_location: venueProfile.setupComplete ? venueProfile.location : null,
        venue_staff_count: venueProfile.setupComplete ? venueProfile.staffCount : null
    };
    
    // 1. Save to localStorage as backup
    const stored = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    stored.push(conversation);
    localStorage.setItem('analytics_conversations', JSON.stringify(stored));
    
    // 2. Save to Supabase (centralized database)
    if (supabaseClient) {
        try {
            const { data, error } = await supabaseClient
                .from('conversations')
                .insert([conversation]);
            
            if (error) {
            } else {
            }
        } catch (err) {
        }
    } else {
    }
    
    // 3. Update theme counts
    updateThemeCount(conversation.theme);
    
    // 4. Track high-risk if applicable
    if (conversation.is_high_risk) {
        trackHighRiskTopic(userMessage);
    }
    
    // 5. Update user profile
    updateUserProfile(currentUser, userMessage);
}

function detectTheme(message) {
    const lowerMessage = message.toLowerCase();
    
    const themes = {
        'Award Rates & Pay': ['award rate', 'pay rate', 'wage', 'salary', 'how much', 'penalty rate', 'overtime', 'casual loading'],
        'Rostering & Hours': ['roster', 'schedule', 'shift', 'hours', 'break', 'rest day', 'overtime'],
        'Termination & Dismissal': ['terminate', 'fire', 'dismiss', 'sack', 'let go', 'redundancy'],
        'Performance Management': ['performance', 'pip', 'warning', 'underperform', 'improvement'],
        'Recruitment & Hiring': ['hire', 'recruit', 'interview', 'job ad', 'onboard', 'new employee'],
        'Leave & Entitlements': ['annual leave', 'sick leave', 'personal leave', 'long service', 'parental leave'],
        'Workplace Issues': ['complaint', 'harassment', 'bullying', 'discrimination', 'conflict'],
        'Contracts & Agreements': ['contract', 'employment agreement', 'casual conversion', 'fixed term'],
        'Compliance & Legal': ['fair work', 'compliance', 'legal', 'lawsuit', 'claim', 'ombudsman'],
        'General HR Advice': []
    };
    
    for (const [theme, keywords] of Object.entries(themes)) {
        if (keywords.some(keyword => lowerMessage.includes(keyword))) {
            return theme;
        }
    }
    
    return 'General HR Advice';
}

async function updateThemeCount(theme) {
    // Update localStorage
    const stored = JSON.parse(localStorage.getItem('analytics_themes') || '{}');
    stored[theme] = (stored[theme] || 0) + 1;
    localStorage.setItem('analytics_themes', JSON.stringify(stored));
    
    // Update Supabase
    if (supabaseClient) {
        try {
            // Try to increment existing record
            const { data: existing } = await supabaseClient
                .from('themes')
                .select('count')
                .eq('theme', theme)
                .single();
            
            if (existing) {
                // Update existing
                await supabaseClient
                    .from('themes')
                    .update({ 
                        count: existing.count + 1,
                        last_updated: new Date().toISOString()
                    })
                    .eq('theme', theme);
            } else {
                // Insert new
                await supabaseClient
                    .from('themes')
                    .insert([{ theme: theme, count: 1 }]);
            }
        } catch (err) {
        }
    }
}

async function trackHighRiskTopic(message) {
    const risk = detectHighRiskTopic(message);
    if (!risk) return;
    
    const highRiskEntry = {
        timestamp: new Date().toISOString(),
        user_code: currentUser,
        category: risk.category,
        title: risk.title,
        severity: risk.severity,
        message_preview: message.substring(0, 200)
    };
    
    // Save to localStorage
    const stored = JSON.parse(localStorage.getItem('analytics_highrisk') || '[]');
    stored.push(highRiskEntry);
    localStorage.setItem('analytics_highrisk', JSON.stringify(stored));
    
    // Save to Supabase
    if (supabaseClient) {
        try {
            await supabaseClient
                .from('high_risk_topics')
                .insert([highRiskEntry]);
        } catch (err) {
        }
    }
}

async function updateUserProfile(user, message) {
    // Update localStorage
    const profiles = JSON.parse(localStorage.getItem('analytics_users') || '{}');
    
    if (!profiles[user]) {
        profiles[user] = {
            first_seen: new Date().toISOString(),
            message_count: 0,
            last_active: null,
            venue: venueProfile.setupComplete ? venueProfile : null,
            topThemes: {}
        };
    }
    
    profiles[user].message_count++;
    profiles[user].last_active = new Date().toISOString();
    
    const theme = detectTheme(message);
    profiles[user].topThemes[theme] = (profiles[user].topThemes[theme] || 0) + 1;
    
    localStorage.setItem('analytics_users', JSON.stringify(profiles));
    
    // Update Supabase
    if (supabaseClient) {
        try {
            const { data: existing } = await supabaseClient
                .from('user_profiles')
                .select('message_count')
                .eq('user_code', user)
                .single();
            
            if (existing) {
                // Update existing profile
                await supabaseClient
                    .from('user_profiles')
                    .update({ 
                        message_count: existing.message_count + 1,
                        last_active: new Date().toISOString(),
                        venue_name: venueProfile.venueName || null,
                        venue_type: venueProfile.venueType || null,
                        venue_location: venueProfile.location || null,
                        venue_city: venueProfile.city || null,
                        staff_count: venueProfile.staffCount || null
                    })
                    .eq('user_code', user);
            } else {
                // Insert new profile
                await supabaseClient
                    .from('user_profiles')
                    .insert([{
                        user_code: user,
                        message_count: 1,
                        venue_name: venueProfile.venueName || null,
                        venue_type: venueProfile.venueType || null,
                        venue_location: venueProfile.location || null,
                        venue_city: venueProfile.city || null,
                        staff_count: venueProfile.staffCount || null
                    }]);
            }
        } catch (err) {
        }
    }
}

function showAdminDashboard() {
    document.getElementById('adminDashboardModal').classList.remove('hidden');
    loadAnalytics();
}

function closeAdminDashboard() {
    document.getElementById('adminDashboardModal').classList.add('hidden');
}

async function loadAnalytics() {
    if (!db) {
        showAlert('âš ï¸ Firebase not connected. Check console for errors.');
        return;
    }
    
    try {
        // Load user count from Firebase
        const usersSnapshot = await db.collection('users').get();
        const userCount = usersSnapshot.size;
        
        // Load all conversations across all users
        let totalConversations = 0;
        let todayConversations = 0;
        const today = new Date().toDateString();
        
        for (const userDoc of usersSnapshot.docs) {
            const conversationsSnapshot = await db.collection('users').doc(userDoc.id).collection('conversations').get();
            totalConversations += conversationsSnapshot.size;
            
            conversationsSnapshot.forEach(conv => {
                const data = conv.data();
                if (data.timestamp && new Date(data.timestamp.toDate ? data.timestamp.toDate() : data.timestamp).toDateString() === today) {
                    todayConversations++;
                }
            });
        }
        
        // Update stats
        document.getElementById('statTotalUsers').textContent = userCount || 0;
        document.getElementById('statTotalMessages').textContent = totalConversations || 0;
        document.getElementById('statActiveToday').textContent = todayConversations || 0;
        document.getElementById('statAvgSession').textContent = '5m';
        
        // Load conversations tab by default
        switchAdminTab('conversations');
    } catch (error) {
        showAlert('Error loading analytics. Check console.');
    }
}

function switchAdminTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.admin-tab').forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.add('text-purple-400', 'border-b-2', 'border-purple-400', 'font-semibold');
            btn.classList.remove('text-slate-400');
        } else {
            btn.classList.remove('text-purple-400', 'border-b-2', 'border-purple-400', 'font-semibold');
            btn.classList.add('text-slate-400');
        }
    });
    
    // Hide all content
    document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected content
    const contentMap = {
        'conversations': 'adminConversationsTab',
        'themes': 'adminThemesTab',
        'users': 'adminUsersTab',
        'highrisk': 'adminHighRiskTab',
        'documents': 'adminDocumentsTab'
    };
    
    document.getElementById(contentMap[tabName]).classList.remove('hidden');
    
    // Load data for selected tab
    if (tabName === 'conversations') loadConversationsAdmin();
    if (tabName === 'themes') loadThemes();
    if (tabName === 'users') loadUsers();
    if (tabName === 'highrisk') loadHighRisk();
    if (tabName === 'documents') loadDocuments();
}

async function loadConversationsAdmin() {
    const list = document.getElementById('conversationsList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading conversations from Firebase...</div>';
    
    if (!db) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Firebase not connected. Check console for details.</div>';
        return;
    }
    
    try {
        // Collect conversations from all users
        const allConversations = [];
        
        const usersSnapshot = await db.collection('users').get();
        
        if (usersSnapshot.size === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No users found in database</div>';
            return;
        }
        
        for (const userDoc of usersSnapshot.docs) {
            const userData = userDoc.data();
            const userName = userData.displayName || userData.email || userDoc.id.substring(0, 8);
            
            // Get conversations without orderBy (may not have index)
            const conversationsSnapshot = await db.collection('users').doc(userDoc.id)
                .collection('conversations')
                .limit(50)
                .get();
            
            conversationsSnapshot.forEach(convDoc => {
                const conv = convDoc.data();
                // Get messages from conversation
                if (conv.messages && conv.messages.length > 0) {
                    const lastUserMsg = conv.messages.filter(m => m.role === 'user').pop();
                    const lastAssistantMsg = conv.messages.filter(m => m.role === 'assistant').pop();
                    
                    allConversations.push({
                        oduserId: userDoc.id,
                        userName: userName,
                        userMessage: lastUserMsg && lastUserMsg.content ? lastUserMsg.content.substring(0, 200) : 'No user message',
                        assistantResponse: lastAssistantMsg && lastAssistantMsg.content ? lastAssistantMsg.content.substring(0, 200) : 'No response',
                        timestamp: conv.timestamp || conv.updated || conv.created,
                        title: conv.title || 'Untitled'
                    });
                } else {
                    // Conversation exists but might have no messages yet or different structure
                    allConversations.push({
                        userId: userDoc.id,
                        userName: userName,
                        userMessage: 'No messages yet',
                        assistantResponse: 'N/A',
                        timestamp: conv.timestamp || conv.updated || conv.created,
                        title: conv.title || 'Untitled'
                    });
                }
            });
        }
        
        // Sort by timestamp (newest first)
        allConversations.sort((a, b) => {
            const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
            const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
            return dateB - dateA;
        });
        
        if (allConversations.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No conversations found across all users</div>';
            return;
        }
        
        let html = '';
        allConversations.slice(0, 50).forEach(conv => {
            let dateStr = 'Unknown';
            try {
                if (conv.timestamp) {
                    const date = conv.timestamp.toDate ? conv.timestamp.toDate() : new Date(conv.timestamp);
                    dateStr = date.toLocaleString('en-AU');
                }
            } catch (e) {
                dateStr = 'Unknown';
            }
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-purple-500 transition-all">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-purple-400 font-semibold">${conv.userName}</span>
                            <span class="text-slate-500 text-xs ml-2">${dateStr}</span>
                        </div>
                        <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">${conv.title}</span>
                    </div>
                    <div class="text-sm">
                        <p class="text-slate-300 mb-2"><strong>User:</strong> ${conv.userMessage}...</p>
                        <p class="text-slate-400 text-xs"><strong>Response:</strong> ${conv.assistantResponse}...</p>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error: ' + error.message + '</div>';
    }
}

async function loadThemes() {
    const list = document.getElementById('themesList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Analyzing conversation themes...</div>';
    
    if (!db) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Firebase not connected</div>';
        return;
    }
    
    try {
        // Collect themes from conversation titles/content
        const themeCount = {};
        const usersSnapshot = await db.collection('users').get();
        
        for (const userDoc of usersSnapshot.docs) {
            const conversationsSnapshot = await db.collection('users').doc(userDoc.id)
                .collection('conversations')
                .get();
            
            conversationsSnapshot.forEach(convDoc => {
                const conv = convDoc.data();
                const title = conv.title || 'Other';
                
                // Categorize by keywords
                let theme = 'Other';
                const titleLower = title.toLowerCase();
                
                if (titleLower.includes('award') || titleLower.includes('pay') || titleLower.includes('wage')) {
                    theme = 'Pay & Awards';
                } else if (titleLower.includes('roster') || titleLower.includes('shift') || titleLower.includes('hours')) {
                    theme = 'Rostering & Hours';
                } else if (titleLower.includes('leave') || titleLower.includes('sick') || titleLower.includes('annual')) {
                    theme = 'Leave';
                } else if (titleLower.includes('termination') || titleLower.includes('dismiss') || titleLower.includes('fire')) {
                    theme = 'Termination';
                } else if (titleLower.includes('contract') || titleLower.includes('employment')) {
                    theme = 'Contracts';
                } else if (titleLower.includes('warning') || titleLower.includes('disciplin') || titleLower.includes('performance')) {
                    theme = 'Discipline & Warnings';
                } else if (titleLower.includes('super') || titleLower.includes('tax') || titleLower.includes('tfn')) {
                    theme = 'Super & Tax';
                }
                
                themeCount[theme] = (themeCount[theme] || 0) + 1;
            });
        }
        
        const themes = Object.entries(themeCount)
            .map(([theme, count]) => ({ theme, count }))
            .sort((a, b) => b.count - a.count);
        
        if (themes.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No themes tracked yet</div>';
            return;
        }
        
        const totalCount = themes.reduce((sum, t) => sum + t.count, 0);
        
        let html = '';
        themes.forEach(themeData => {
            const percentage = ((themeData.count / totalCount) * 100).toFixed(1);
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-purple-400 font-semibold">${themeData.theme}</span>
                        <span class="text-2xl font-bold text-purple-400">${themeData.count}</span>
                    </div>
                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">${percentage}% of all queries</p>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadUsers() {
    const list = document.getElementById('usersList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading users from Firebase...</div>';
    
    if (!db) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Firebase not connected</div>';
        return;
    }
    
    try {
        const usersSnapshot = await db.collection('users').get();
        
        if (usersSnapshot.empty) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No users yet</div>';
            return;
        }
        
        const users = [];
        
        for (const userDoc of usersSnapshot.docs) {
            const userData = userDoc.data();
            
            // Count conversations for this user
            const conversationsSnapshot = await db.collection('users').doc(userDoc.id).collection('conversations').get();
            const messageCount = conversationsSnapshot.size;
            
            users.push({
                id: userDoc.id,
                displayName: userData.displayName || 'Unknown',
                email: userData.email || 'N/A',
                venueProfile: userData.venueProfile || null,
                legalTermsAccepted: userData.legalTermsAccepted || false,
                legalTermsAcceptedAt: userData.legalTermsAcceptedAt || null,
                messageCount: messageCount
            });
        }
        
        // Sort by message count
        users.sort((a, b) => b.messageCount - a.messageCount);
        
        let html = '';
        users.forEach(profile => {
            const venueInfo = profile.venueProfile 
                ? `${profile.venueProfile.venueType || 'Unknown'} in ${profile.venueProfile.location || 'Unknown'}` 
                : 'No venue info';
            
            const legalStatus = profile.legalTermsAccepted 
                ? '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">âœ“ Legal Accepted</span>'
                : '<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded">Pending</span>';
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="text-purple-400 font-semibold">${profile.displayName}</p>
                            <p class="text-xs text-slate-500">${profile.email}</p>
                            <p class="text-xs text-slate-400 mt-1">${venueInfo}</p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">${profile.messageCount} chats</span>
                            ${legalStatus}
                        </div>
                    </div>
                    <div class="text-xs text-slate-500">
                        User ID: ${profile.id.substring(0, 12)}...
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data: ' + error.message + '</div>';
    }
}

async function loadHighRisk() {
    const list = document.getElementById('highRiskList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Scanning for high-risk topics...</div>';
    
    if (!db) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Firebase not connected</div>';
        return;
    }
    
    try {
        // Scan conversations for high-risk keywords
        const highRiskItems = [];
        const highRiskKeywords = ['termination', 'unfair dismissal', 'lawsuit', 'legal action', 'sexual harassment', 
                                   'discrimination', 'bullying', 'assault', 'theft', 'fraud', 'workers comp'];
        
        const usersSnapshot = await db.collection('users').get();
        
        for (const userDoc of usersSnapshot.docs) {
            const userData = userDoc.data();
            const userName = userData.displayName || userData.email || userDoc.id.substring(0, 8);
            
            const conversationsSnapshot = await db.collection('users').doc(userDoc.id)
                .collection('conversations')
                .get();
            
            conversationsSnapshot.forEach(convDoc => {
                const conv = convDoc.data();
                const title = (conv.title || '').toLowerCase();
                
                // Check for high-risk keywords
                for (const keyword of highRiskKeywords) {
                    if (title.includes(keyword)) {
                        highRiskItems.push({
                            userName: userName,
                            title: conv.title,
                            keyword: keyword,
                            timestamp: conv.timestamp,
                            severity: keyword.includes('harassment') || keyword.includes('assault') ? 'critical' : 
                                     keyword.includes('dismissal') || keyword.includes('lawsuit') ? 'high' : 'medium'
                        });
                        break; // Only add once per conversation
                    }
                }
            });
        }
        
        // Sort by timestamp
        highRiskItems.sort((a, b) => {
            const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
            const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
            return dateB - dateA;
        });
        
        if (highRiskItems.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No high-risk topics detected</div>';
            return;
        }
        
        let html = '';
        highRiskItems.slice(0, 50).forEach(risk => {
            const date = risk.timestamp?.toDate ? risk.timestamp.toDate().toLocaleString('en-AU') : 'Unknown';
            const colorMap = { critical: 'red', high: 'yellow', medium: 'blue' };
            const color = colorMap[risk.severity] || 'gray';
            
            html += `
                <div class="bg-slate-900 border-2 border-${color}-500 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-${color}-400 font-semibold">${risk.title}</span>
                            <span class="text-slate-500 text-xs ml-2">${date}</span>
                        </div>
                        <span class="text-xs bg-${color}-500 text-white px-2 py-1 rounded uppercase">${risk.severity}</span>
                    </div>
                    <p class="text-slate-400 text-xs mb-2"><strong>User:</strong> ${risk.userName}</p>
                    <p class="text-slate-300 text-sm">Detected keyword: <strong>${risk.keyword}</strong></p>
                </div>
            `;
        });
        
        list.innerHTML = html;
    } catch (error) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data</div>';
    }
}

async function loadDocuments() {
    const list = document.getElementById('documentsList');
    
    list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">Loading documents from Firebase...</div>';
    
    if (!db) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Firebase not connected</div>';
        return;
    }
    
    try {
        // Load documents from the global documents collection
        const documentsSnapshot = await db.collection('generated_documents')
            .orderBy('generated_at', 'desc')
            .limit(100)
            .get();
        
        let documents = [];
        
        if (documentsSnapshot.empty) {
            // If no global collection, try to get from users
            const usersSnapshot = await db.collection('users').get();
            
            for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                const userDocs = userData.generatedDocuments || [];
                
                userDocs.forEach(doc => {
                    documents.push({
                        ...doc,
                        user_code: userData.displayName || userData.email || userDoc.id.substring(0, 8)
                    });
                });
            }
        } else {
            documentsSnapshot.forEach(doc => {
                documents.push({ id: doc.id, ...doc.data() });
            });
        }
        
        if (documents.length === 0) {
            list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No documents generated yet</div>';
            return;
        }
        
        // Sort by date
        documents.sort((a, b) => {
            const dateA = a.generated_at?.toDate ? a.generated_at.toDate() : new Date(a.generated_at || 0);
            const dateB = b.generated_at?.toDate ? b.generated_at.toDate() : new Date(b.generated_at || 0);
            return dateB - dateA;
        });
        
        // Calculate stats
        const totalGenerated = documents.length;
        const totalDownloaded = documents.filter(d => d.downloaded === true).length;
        const totalPDF = documents.filter(d => d.format === 'pdf').length;
        const totalWord = documents.filter(d => d.format === 'docx').length;
        const totalWarnings = documents.filter(d => d.document_type === 'formalWarning').length;
        const totalInvestigations = documents.filter(d => d.document_type === 'letterOfAllegation').length;
        const totalRecords = documents.filter(d => d.document_type === 'recordOfDiscussion').length;
        const totalPIPs = documents.filter(d => d.document_type === 'performanceImprovementPlan').length;
        
        let html = '<div class="space-y-6">';
        
        // Stats summary
        html += `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Total Generated</p>
                    <p class="text-3xl font-bold text-purple-400">${totalGenerated}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Downloaded</p>
                    <p class="text-3xl font-bold text-green-400">${totalDownloaded}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">ðŸ“„ PDF</p>
                    <p class="text-3xl font-bold text-red-400">${totalPDF}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">ðŸ“ Word</p>
                    <p class="text-3xl font-bold text-blue-400">${totalWord}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Warnings</p>
                    <p class="text-3xl font-bold text-yellow-400">${totalWarnings}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Investigations</p>
                    <p class="text-3xl font-bold text-red-400">${totalInvestigations}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">Records</p>
                    <p class="text-3xl font-bold text-green-400">${totalRecords}</p>
                </div>
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4">
                    <p class="text-slate-400 text-xs mb-1">PIPs</p>
                    <p class="text-3xl font-bold text-blue-400">${totalPIPs}</p>
                </div>
            </div>
        `;
        
        // Document type mapping
        const typeEmoji = {
            formalWarning: 'âš ï¸',
            recordOfDiscussion: 'ðŸ“‹',
            performanceImprovementPlan: 'ðŸ“Š',
            letterOfAllegation: 'ðŸ”'
        };

        const typeName = {
            formalWarning: 'Formal Warning',
            recordOfDiscussion: 'Record of Discussion',
            performanceImprovementPlan: 'Performance Improvement Plan',
            letterOfAllegation: 'Letter of Allegation'
        };

        const typeColor = {
            formalWarning: 'yellow',
            recordOfDiscussion: 'green',
            performanceImprovementPlan: 'blue',
            letterOfAllegation: 'red'
        };
        
        const formatBadge = {
            'pdf': '<span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">ðŸ“„ PDF</span>',
            'docx': '<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">ðŸ“ Word</span>',
            null: '<span class="text-xs bg-slate-700 text-slate-400 px-2 py-1 rounded">Not downloaded</span>'
        };
        
        // Document list
        documents.forEach(doc => {
            const date = doc.generated_at?.toDate 
                ? doc.generated_at.toDate().toLocaleString('en-AU') 
                : new Date(doc.generated_at).toLocaleString('en-AU');
            const emoji = typeEmoji[doc.document_type] || 'ðŸ“„';
            const name = typeName[doc.document_type] || doc.document_type || 'Unknown Document';
            const color = typeColor[doc.document_type] || 'blue';
            
            html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-${color}-500 transition-all">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${emoji}</span>
                            <div>
                                <p class="text-${color}-400 font-semibold">${name}</p>
                                <p class="text-slate-500 text-xs">${date}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">${doc.user_code || 'Unknown User'}</span>
                            ${doc.downloaded ? 
                                `<div class="flex gap-1">
                                    <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">âœ“ Downloaded</span>
                                    ${formatBadge[doc.format] || ''}
                                 </div>` : 
                                '<span class="text-xs bg-slate-700 text-slate-400 px-2 py-1 rounded">Not downloaded</span>'}
                        </div>
                    </div>
                    <div class="text-sm">
                        <p class="text-slate-300"><strong>Employee:</strong> ${doc.employee_name || 'N/A'}</p>
                        ${doc.venue_name ? `<p class="text-slate-400 text-xs mt-1">Venue: ${doc.venue_name}</p>` : ''}
                        <p class="text-slate-500 text-xs mt-2">Document ID: ${doc.document_id || doc.id || 'N/A'}</p>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        list.innerHTML = html;
    } catch (error) {
        list.innerHTML = '<div class="bg-red-500/10 border border-red-500 rounded-lg p-6 text-center text-red-400">Error loading data: ' + error.message + '</div>';
    }
}

function filterConversations() {
    const search = document.getElementById('conversationSearch').value.toLowerCase();
    const conversations = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    
    const filtered = conversations.filter(conv => 
        conv.userMessage.toLowerCase().includes(search) ||
        conv.assistantResponse.toLowerCase().includes(search) ||
        conv.theme.toLowerCase().includes(search)
    );
    
    const list = document.getElementById('conversationsList');
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="bg-slate-900 rounded-lg p-6 text-center text-slate-400">No matches found</div>';
        return;
    }
    
    let html = '';
    filtered.reverse().forEach(conv => {
        const date = new Date(conv.timestamp).toLocaleString('en-AU');
        const riskBadge = conv.isHighRisk ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">HIGH RISK</span>' : '';
        
        html += `
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-purple-500 transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div>
                        <span class="text-purple-400 font-semibold">${conv.user}</span>
                        <span class="text-slate-500 text-xs ml-2">${date}</span>
                        ${riskBadge}
                    </div>
                    <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">${conv.theme}</span>
                </div>
                <div class="text-sm">
                    <p class="text-slate-300 mb-2"><strong>User:</strong> ${conv.userMessage}</p>
                    <p class="text-slate-400 text-xs"><strong>Response:</strong> ${conv.assistantResponse.substring(0, 150)}...</p>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function refreshAnalytics() {
    loadAnalytics();
    showAlert('âœ… Analytics refreshed!');
}

function exportAnalytics() {
    const conversations = JSON.parse(localStorage.getItem('analytics_conversations') || '[]');
    const themes = JSON.parse(localStorage.getItem('analytics_themes') || '{}');
    const users = JSON.parse(localStorage.getItem('analytics_users') || '{}');
    
    // Prepare data for Excel
    const data = conversations.map(conv => ({
        'Timestamp': new Date(conv.timestamp).toLocaleString('en-AU'),
        'User': conv.user,
        'Theme': conv.theme,
        'High Risk': conv.isHighRisk ? 'YES' : 'NO',
        'User Message': conv.userMessage,
        'Assistant Response': conv.assistantResponse.substring(0, 500)
    }));
    
    generateExcelSpreadsheet(data, `Analytics_Export_${Date.now()}.xlsx`, 'Conversations');
    
    showAlert('âœ… Analytics exported to Excel!');
}

function getVenueContext() {
    if (!venueProfile.setupComplete) return '';
    const venueName = venueProfile.venueName ? `"${venueProfile.venueName}" - a ` : '';
    return `\nVENUE CONTEXT: ${venueName}${getVenueTypeLabel(venueProfile.venueType)} in ${venueProfile.city || ''} ${venueProfile.location}, ${venueProfile.staffCount} staff, Award: ${venueProfile.primaryAward}\n`;
}

// ========================================
// AWARD CALCULATOR
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const calcPosition = document.getElementById('calcPosition');
    if (calcPosition) {
        calcPosition.addEventListener('change', function() {
            const customDiv = document.getElementById('customRateDiv');
            if (this.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });
    }
});

/**
 * Calculates award pay including penalties, loadings, and overtime
 * Displays detailed breakdown in the calculator modal
 * @returns {void}
 */
function calculateAward() {
    let baseRate = parseFloat(document.getElementById('calcPosition').value);
    if (document.getElementById('calcPosition').value === 'custom') {
        baseRate = parseFloat(document.getElementById('calcCustomRate').value);
    }

    const dayMultiplier = parseFloat(document.getElementById('calcDay').value);
    const hours = parseFloat(document.getElementById('calcHours').value);
    const overtime = parseFloat(document.getElementById('calcOvertime').value);

    if (!baseRate || !hours) {
        showAlert('Please enter all required fields');
        return;
    }

    const penaltyRate = baseRate * dayMultiplier;
    const ordinaryPay = penaltyRate * hours;
    const overtimePay = overtime > 0 ? (baseRate * 1.5 * overtime) : 0;
    const totalPay = ordinaryPay + overtimePay;

    document.getElementById('resultBaseRate').textContent = `$${baseRate.toFixed(2)}/hr`;
    document.getElementById('resultPenaltyRate').textContent = `$${penaltyRate.toFixed(2)}/hr`;
    document.getElementById('resultOrdinaryPay').textContent = `$${ordinaryPay.toFixed(2)}`;
    document.getElementById('resultOvertimePay').textContent = `$${overtimePay.toFixed(2)}`;
    document.getElementById('resultTotal').textContent = `$${totalPay.toFixed(2)}`;

    document.getElementById('overtimeRow').style.display = overtime > 0 ? 'flex' : 'none';
    document.getElementById('calcResults').classList.remove('hidden');

    trackEvent('award_calculated', { user: currentUser, baseRate, totalPay });
}

function downloadCalculation() {
    const data = [{
        'Description': 'Base Rate',
        'Rate': document.getElementById('resultBaseRate').textContent,
        'Hours': document.getElementById('calcHours').value,
        'Amount': document.getElementById('resultOrdinaryPay').textContent
    }];

    const overtime = parseFloat(document.getElementById('calcOvertime').value);
    if (overtime > 0) {
        data.push({
            'Description': 'Overtime',
            'Rate': `$${(parseFloat(document.getElementById('calcPosition').value) * 1.5).toFixed(2)}/hr`,
            'Hours': overtime,
            'Amount': document.getElementById('resultOvertimePay').textContent
        });
    }

    data.push({
        'Description': 'TOTAL',
        'Rate': '',
        'Hours': '',
        'Amount': document.getElementById('resultTotal').textContent
    });

    generateExcelSpreadsheet(data, `Pay_Calculation_${Date.now()}.xlsx`, 'Pay Breakdown');
}

// ========================================
// AWARD WIZARD - COMPLETE IMPLEMENTATION
// ========================================


// Helper to get nested rate
function getNestedRate(obj, path) {
    // Handle non-nested paths (like 'introductory' or 'managerial_hotel')
    if (!path.includes('.')) {
        return obj[path] || null;
    }
    
    const parts = path.split('.');
    let current = obj;
    
    for (const part of parts) {
        if (current && current[part] !== undefined) {
            current = current[part];
        } else {
            return null;
        }
    }
    
    return current;
}

// Wizard answer handler
/**
 * Processes wizard step answer and advances to next step
 * Shows results when wizard is complete
 * @param {string} question - The question being answered (e.g., 'venue', 'role')
 * @param {string} answer - The selected answer
 * @returns {void}
 */
function wizardAnswer(question, answer) {
    wizardData[question] = answer;
    
    if (currentWizardStep < CONFIG.WIZARD_STEPS) {
        currentWizardStep++;
        updateWizardStep();
    } else {
        showWizardResults();
    }
}

// Update wizard step display
function updateWizardStep() {
    // Get the Award Wizard container specifically
    const wizardModal = document.getElementById('awardWizardModal');
    if (!wizardModal) return;
    
    // Hide all steps ONLY within the Award Wizard
    wizardModal.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.add('hidden');
    });
    
    // Show current step ONLY within the Award Wizard
    const currentStep = wizardModal.querySelector(`[data-step="${currentWizardStep}"]`);
    if (currentStep) {
        currentStep.classList.remove('hidden');
    }
    
    // Update progress
    document.getElementById('wizardCurrentStep').textContent = currentWizardStep;
    const progress = Math.round((currentWizardStep / 5) * 100);
    document.getElementById('wizardProgress').textContent = `${progress}% Complete`;
    document.getElementById('wizardProgressBar').style.width = `${progress}%`;
    
    // Show/hide back button
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) {
        if (currentWizardStep > 1) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
    }
}
    
// Go back in wizard
function wizardGoBack() {
    if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardStep();
    }
}

// Show wizard results
function showWizardResults() {
    // Check if employee is a junior (19 or younger)
    if (wizardData.age === 'junior') {
        showJuniorRedirect();
        return;
    }
    
    // Build a simple result for now to ensure display works
    let resultRate = 0;
    let resultTitle = 'Classification';
    let resultAward = 'Hospitality Industry (General) Award MA000009';
    let penaltiesHTML = '<div>Standard rates apply</div>';
    let stepsHTML = '<li>Verify rate with Fair Work</li>';
    
    // Try to calculate from award rates if available
    try {
        if (awardRates && awardRates.rates && awardRates.rates.length > 0) {
            const result = calculateAwardClassification(wizardData);
            if (result && typeof result.rate === 'number') {
                resultRate = result.rate;
                resultTitle = result.level || 'Classification';
                resultAward = result.award || resultAward;
                
                if (result.penalties && result.penalties.length > 0) {
                    penaltiesHTML = result.penalties.map(p => `<div>â€¢ ${p}</div>`).join('');
                }
                if (result.nextSteps && result.nextSteps.length > 0) {
                    stepsHTML = result.nextSteps.map(s => `<li>${s}</li>`).join('');
                }
            }
        } else {
            // Use fallback display - rates not loaded
            resultTitle = 'Rate lookup unavailable';
            penaltiesHTML = '<div>â€¢ Connect to internet to load current rates</div>';
            stepsHTML = '<li>Refresh page when online to get accurate rates</li>';
        }
    } catch (calcError) {
        resultTitle = 'Calculation Error';
    }
    
    // Build the results HTML
    const resultsHTML = `
        <div class="bg-green-500/10 border-2 border-green-500 rounded-lg p-6">
            <h3 class="text-green-400 font-bold text-xl mb-4 flex items-center gap-2">
                <span>âœ…</span>
                <span>Award Classification Complete!</span>
            </h3>
            
            <div class="space-y-4 text-slate-200">
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-sm text-slate-400 mb-1">Applicable Award</p>
                    <p class="font-bold text-lg">${resultAward}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Classification Level</p>
                        <p class="font-bold">${resultTitle}</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Base Rate (per hour)</p>
                        <p class="font-bold text-2xl text-amber-400">$${resultRate.toFixed(2)}</p>
                    </div>
                </div>

                <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                    <p class="font-semibold text-amber-400 mb-2">Penalty Rates & Loadings:</p>
                    <div class="text-sm space-y-1">${penaltiesHTML}</div>
                </div>

                <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4">
                    <p class="font-semibold text-blue-400 mb-2">ðŸ“ Next Steps:</p>
                    <ul class="text-sm space-y-1">${stepsHTML}</ul>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="downloadWizardResults()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    ðŸ“„ Download Summary
                </button>
                <button onclick="resetWizard()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Start Over
                </button>
            </div>
        </div>
    `;
    
    // Display the results
    const wizardStepsDiv = document.getElementById('wizardSteps');
    if (wizardStepsDiv) {
        wizardStepsDiv.innerHTML = resultsHTML;
    } else {
        showAlert('Error: Could not display results. Please try again.');
        return;
    }
    
    // Hide back button and progress bar
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) backBtn.classList.add('hidden');
    
    const progressContainer = document.querySelector('#awardWizardModal .mb-6');
    if (progressContainer) progressContainer.classList.add('hidden');
    
}
function showJuniorRedirect() {
    try {
        // Build the junior redirect HTML
        const juniorHTML = `
            <div class="bg-blue-500/10 border-2 border-blue-500 rounded-lg p-6">
                <h3 class="text-blue-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>â„¹ï¸</span>
                    <span>Junior Employee (19 years or younger)</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <p class="leading-relaxed">
                        For employees <strong>19 years of age or younger</strong>, junior rates apply. 
                        Junior rates are calculated as a <strong>percentage of the adult rate</strong> based on the employee's age.
                    </p>
                    
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Junior Rate Percentages:</p>
                        <ul class="text-sm space-y-1 ml-4">
                            <li>â€¢ <strong>Under 16 years:</strong> 40% of adult rate</li>
                            <li>â€¢ <strong>16 years:</strong> 50% of adult rate</li>
                            <li>â€¢ <strong>17 years:</strong> 60% of adult rate</li>
                            <li>â€¢ <strong>18 years:</strong> 70% of adult rate</li>
                            <li>â€¢ <strong>19 years:</strong> 80% of adult rate</li>
                            <li>â€¢ <strong>20 years and over:</strong> 100% (full adult rate)</li>
                        </ul>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">ðŸ“‹ What You Need to Do:</p>
                        <ol class="text-sm space-y-2 ml-4">
                            <li>1. Determine the employee's exact age</li>
                            <li>2. Find the applicable adult rate for their classification</li>
                            <li>3. Apply the percentage based on their age</li>
                            <li>4. Review the full award for additional junior provisions</li>
                        </ol>
                    </div>

                    <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-center">
                        <p class="font-semibold text-green-400 mb-3">
                            ðŸ“– View Full Junior Rates in the Award
                        </p>
                        <a href="https://awards.fairwork.gov.au/MA000009.html" 
                           target="_blank"
                           class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                            Open Hospitality Industry Award â†’
                        </a>
                        <p class="text-xs text-slate-400 mt-2">
                            Opens in new tab â€¢ Fair Work Ombudsman official website
                        </p>
                    </div>

                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-300">
                            <strong>Need help calculating junior rates?</strong><br/>
                            Contact Fitzgerald HR for assistance: 
                            <a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>
                        </p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="resetWizard()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-all">
                        â† Start Over
                    </button>
                    <button onclick="closeToolModal('awardWizardModal')" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold rounded-lg transition-all">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        // REPLACE wizardSteps content with junior message (SAME AS ADULT PATH)
        const wizardStepsDiv = document.getElementById('wizardSteps');
        if (wizardStepsDiv) {
            wizardStepsDiv.innerHTML = juniorHTML;
            wizardStepsDiv.classList.remove('hidden'); // Keep it visible
        } else {
            return;
        }
        
        // Hide back button and progress bar
        const backBtn = document.getElementById('wizardBackBtn');
        if (backBtn) backBtn.classList.add('hidden');
        
        // Hide progress bar
        const progressContainer = wizardStepsDiv.previousElementSibling;
        if (progressContainer && progressContainer.querySelector('#wizardProgressBar')) {
            progressContainer.classList.add('hidden');
        }
        
        // Track event
        try {
            trackEvent('award_wizard_junior_redirect', {
                user: currentUser,
                role: wizardData.role
            });
        } catch (trackError) {
        }
        
    } catch (error) {
        showAlert('Error showing junior information: ' + error.message);
    }
}

// Calculate award classification (uses GitHub JSON)
/**
 * Calculates award classification based on wizard answers
 * Uses GitHub JSON data to determine rates and penalties
 * @param {Object} data - Wizard answers object
 * @param {string} data.venue - Type of venue
 * @param {string} data.role - Employee role
 * @param {string} data.experience - Experience level
 * @param {string} data.hours - Typical working hours
 * @param {string} data.employment - Employment type
 * @returns {Object} Classification result with award, level, rate, penalties, and next steps
 */
function calculateAwardClassification(data) {
    if (!awardRates || !awardRates.rates) {
        return {
            award: 'Hospitality Industry (General) Award MA000009',
            level: 'Error - Rates Not Loaded',
            rate: 0,
            penalties: ['Please refresh the page to load award rates'],
            nextSteps: ['Refresh the page']
        };
    }
    
    // Determine employment type for filtering
    const isCasual = data.employment === 'casual';
    const employmentType = (isCasual || data.employment === 'part-time') ? 'casual' : 'full_time';
    
    // Build classification path based on role and experience
    const levelMap = {
        'intro': 'introductory',
        'level1': 'level_1',
        'level2': 'level_2',
        'level3': 'level_3',
        'level4': 'level_4',
        'level5': 'level_5',
        'level6': 'level_6'
    };
    
    const levelPrefix = levelMap[data.experience] || 'introductory';
    // Role to classification mapping
    const roleSuffixes = {
        'cook': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.cook_grade1',
            'level_3': 'level_3.cook_grade2',
            'level_4': 'level_4.cook_tradesperson_grade3',
            'level_5': 'level_5.cook_tradesperson_grade4',
            'level_6': 'level_6.cook_tradesperson_grade5'
        },
        'waiter': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'bartender': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'barista': {
            'introductory': 'introductory',
            'level_1': 'level_1.food_beverage_grade1',
            'level_2': 'level_2.food_beverage_grade2',
            'level_3': 'level_3.food_beverage_grade3',
            'level_4': 'level_4.food_beverage_tradesperson_grade4',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'kitchen-hand': {
            'introductory': 'introductory',
            'level_1': 'level_1.kitchen_attendant_grade1',
            'level_2': 'level_2.kitchen_attendant_grade2',
            'level_3': 'level_3.kitchen_attendant_grade3',
            'level_4': 'level_3.kitchen_attendant_grade3',
            'level_5': 'level_3.kitchen_attendant_grade3',
            'level_6': 'level_3.kitchen_attendant_grade3'
        },
        'supervisor': {
            'introductory': 'level_2.food_beverage_grade2',
            'level_1': 'level_3.food_beverage_grade3',
            'level_2': 'level_4.food_beverage_tradesperson_grade4',
            'level_3': 'level_5.food_beverage_supervisor',
            'level_4': 'level_5.food_beverage_supervisor',
            'level_5': 'level_5.food_beverage_supervisor',
            'level_6': 'level_5.food_beverage_supervisor'
        },
        'receptionist': {
            'introductory': 'introductory',
            'level_1': 'level_2.front_office_grade1',
            'level_2': 'level_3.front_office_grade2',
            'level_3': 'level_4.front_office_grade3',
            'level_4': 'level_5.front_office_supervisor',
            'level_5': 'level_5.front_office_supervisor',
            'level_6': 'level_5.front_office_supervisor'
        },
        'housekeeper': {
            'introductory': 'introductory',
            'level_1': 'level_1.guest_service_grade1',
            'level_2': 'level_2.guest_service_grade2',
            'level_3': 'level_3.guest_service_grade3',
            'level_4': 'level_4.guest_service_grade4',
            'level_5': 'level_5.guest_service_supervisor',
            'level_6': 'level_5.guest_service_supervisor'
        },
        'security': {
            'introductory': 'introductory',
            'level_1': 'level_2.doorperson_security',
            'level_2': 'level_3.timekeeper_security_grade2',
            'level_3': 'level_3.timekeeper_security_grade2',
            'level_4': 'level_3.timekeeper_security_grade2',
            'level_5': 'level_3.timekeeper_security_grade2',
            'level_6': 'level_3.timekeeper_security_grade2'
        }
    };
    
    let classificationPath;
    if (roleSuffixes[data.role] && roleSuffixes[data.role][levelPrefix]) {
        classificationPath = roleSuffixes[data.role][levelPrefix];
    } else {
        classificationPath = 'introductory';
    }
    
    // SEARCH THE ARRAY for matching rate
    const matchingRate = awardRates.rates.find(r => 
        r.category === 'adult' && 
        r.employment_type === employmentType && 
        r.classification === classificationPath
    );
    
    if (!matchingRate) {
        return {
            award: 'Error',
            level: 'Rate not found',
            rate: 0,
            penalties: [`Error: No rate for ${classificationPath} (${employmentType})`],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    const baseRate = matchingRate.rate;
    const title = matchingRate.title;
    
    if (!baseRate || typeof baseRate !== 'number' || isNaN(baseRate)) {
        return {
            award: 'Error',
            level: title || 'Unknown',
            rate: 0,
            penalties: ['Error: Invalid rate value'],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    // Calculate penalties
    const penalties = [];
    const penaltyRates = awardRates.penalty_rates;
    
    if (data.hours === 'saturday') {
        const saturdayRate = baseRate * penaltyRates.saturday;
        penalties.push(`Saturday: ${(penaltyRates.saturday * 100)}% = $${saturdayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'sunday') {
        const sundayRate = baseRate * penaltyRates.sunday;
        penalties.push(`Sunday: ${(penaltyRates.sunday * 100)}% = $${sundayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'public-holiday') {
        const publicHolRate = baseRate * penaltyRates.public_holiday;
        penalties.push(`Public Holiday: ${(penaltyRates.public_holiday * 100)}% = $${publicHolRate.toFixed(2)}/hr`);
    } else if (data.hours === 'weekday-night') {
        const eveningRate = baseRate * penaltyRates.evening_after_7pm;
        penalties.push(`Evening (after 7pm): ${(penaltyRates.evening_after_7pm * 100)}% = $${eveningRate.toFixed(2)}/hr`);
    }
    
    if (isCasual) {
        penalties.push(`Casual Loading: 25% (already included in base rate of $${baseRate.toFixed(2)}/hr)`);
    }
    
    penalties.push(`Overtime: First 2 hours at 150%, thereafter 200%`);
    
    const result = {
    award: 'Hospitality Industry (General) Award MA000009',
    level: title,
    rate: baseRate,
        penalties: penalties,
        nextSteps: [
            'Create written employment contract',
            'Set up payroll with these exact rates',
            'Provide Fair Work Information Statement to employee',
            'Keep employment records for 7 years',
            `Review rates on ${awardRates.next_review_date}`
        ],
        notes: awardRates.notes || []
    };
    
    return result;
}

// Reset wizard
function resetWizard() {
    // Reset wizard data and step
    wizardData = {};
    currentWizardStep = 1;
    
    // Close modal
    closeToolModal('awardWizardModal');
    
    // Wait for modal to close, then reset and reopen
    setTimeout(() => {
        // Force rebuild the wizard by reloading the page's wizard HTML
        const wizardStepsDiv = document.getElementById('wizardSteps');
        const progressContainer = document.querySelector('#awardWizardModal .mb-6');
        const backBtn = document.getElementById('wizardBackBtn');
        
        if (!wizardStepsDiv) {
            return;
        }
        
        // Restore original wizard HTML (all 5 steps)
        wizardStepsDiv.innerHTML = `
            <!-- Step 1: Role -->
            <div class="wizard-step" data-step="1">
                <h3 class="text-lg font-bold text-white mb-4">What's their role?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('role', 'waiter')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ‘”</span>
                        <div>
                            <div class="font-semibold">Waiter / Food & Beverage Attendant</div>
                            <div class="text-xs opacity-70">Takes orders, serves food & drinks</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'bartender')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ¸</span>
                        <div>
                            <div class="font-semibold">Bartender</div>
                            <div class="text-xs opacity-70">Makes and serves drinks at bar</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'barista')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">â˜•</span>
                        <div>
                            <div class="font-semibold">Barista</div>
                            <div class="text-xs opacity-70">Makes coffee & beverages</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'cook')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ‘¨â€ðŸ³</span>
                        <div>
                            <div class="font-semibold">Cook / Chef</div>
                            <div class="text-xs opacity-70">Prepares food in kitchen</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'kitchen-hand')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ§¹</span>
                        <div>
                            <div class="font-semibold">Kitchen Hand / Dishwasher</div>
                            <div class="text-xs opacity-70">Cleaning, prep work</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'supervisor')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ‘”</span>
                        <div>
                            <div class="font-semibold">Supervisor / Shift Manager</div>
                            <div class="text-xs opacity-70">Manages team & operations</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'receptionist')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ“ž</span>
                        <div>
                            <div class="font-semibold">Receptionist / Front Desk</div>
                            <div class="text-xs opacity-70">Check-in, guest services</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'housekeeper')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ›ï¸</span>
                        <div>
                            <div class="font-semibold">Housekeeper / Room Attendant</div>
                            <div class="text-xs opacity-70">Cleans rooms, maintains facilities</div>
                        </div>
                    </button>
                    <button onclick="wizardAnswer('role', 'security')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
                        <span class="text-2xl">ðŸ›¡ï¸</span>
                        <div>
                            <div class="font-semibold">Security / Door Person</div>
                            <div class="text-xs opacity-70">Venue security, crowd control</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Step 2: Experience -->
            <div class="wizard-step hidden" data-step="2">
                <h3 class="text-lg font-bold text-white mb-4">What's their experience level?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('experience', 'intro')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Introductory / No experience</div>
                        <div class="text-xs opacity-70">Just starting out, learning basics</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level1')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 1 - Basic skills</div>
                        <div class="text-xs opacity-70">Can perform routine tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level2')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 2 - Competent</div>
                        <div class="text-xs opacity-70">Works independently, some variety</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level3')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 3 - Advanced</div>
                        <div class="text-xs opacity-70">Skilled, handles complex tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level4')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 4 - Supervisor/Trade</div>
                        <div class="text-xs opacity-70">Manages others or trade qualified</div>
                    </button>
                </div>
            </div>

            <!-- Step 3: Hours -->
            <div class="wizard-step hidden" data-step="3">
                <h3 class="text-lg font-bold text-white mb-4">What hours do they typically work?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('hours', 'weekday-day')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Daytime</div>
                        <div class="text-xs opacity-70">Regular business hours</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'weekday-night')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Evenings/Nights</div>
                        <div class="text-xs opacity-70">After 7pm or late shifts</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'saturday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Saturdays</div>
                        <div class="text-xs opacity-70">Weekend penalty rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'sunday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Sundays</div>
                        <div class="text-xs opacity-70">Higher penalty rates</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'public-holiday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Public Holidays</div>
                        <div class="text-xs opacity-70">Highest penalty rates</div>
                    </button>
                </div>
            </div>

            <!-- Step 4: Age -->
            <div class="wizard-step hidden" data-step="4">
                <h3 class="text-lg font-bold text-white mb-4">How old is the employee?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('age', 'adult')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">20 years or older</div>
                        <div class="text-xs opacity-70">Adult rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('age', 'junior')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">19 years or younger</div>
                        <div class="text-xs opacity-70">Junior rates apply (percentage of adult rate)</div>
                    </button>
                </div>
            </div>

            <!-- Step 5: Employment Type -->
            <div class="wizard-step hidden" data-step="5">
                <h3 class="text-lg font-bold text-white mb-4">What type of employment?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('employment', 'casual')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Casual</div>
                        <div class="text-xs opacity-70">25% loading, no leave entitlements</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'part-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Part-Time</div>
                        <div class="text-xs opacity-70">Regular hours, pro-rata leave</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'full-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Full-Time</div>
                        <div class="text-xs opacity-70">38 hours/week, full entitlements</div>
                    </button>
                </div>
            </div>
        `;
        
        // Show progress bar
        if (progressContainer) {
            progressContainer.classList.remove('hidden');
        }
        
        // Hide back button
        if (backBtn) {
            backBtn.classList.add('hidden');
        }
        
        // Make sure steps are visible
        wizardStepsDiv.classList.remove('hidden');
        
        // Update to step 1
        updateWizardStep();
        
        // Reopen modal
        document.getElementById('awardWizardModal').classList.remove('hidden');
        
    }, 150);
}
// ========================================
// ROSTER STRESS TESTER - COMPLETE IMPLEMENTATION
// ========================================

async function analyzeRosterFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
            <p class="text-amber-400">Analyzing ${file.name}...</p>
        </div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rosterData = XLSX.utils.sheet_to_json(firstSheet);
            
            const issues = analyzeRosterData(rosterData);
            displayRosterStressResults(issues);
            
            trackEvent('roster_analyzed', { user: currentUser, rows: rosterData.length });
        } catch (error) {
            document.getElementById('rosterStressResults').innerHTML = `
                <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                    <p class="text-red-400">Error analyzing file. Ensure it's a valid Excel/CSV roster.</p>
                </div>
            `;
        }
    };
    reader.readAsArrayBuffer(file);
}

function analyzeRosterData(data) {
    const issues = [];
    
    if (data.length > 5) {
        issues.push({
            severity: 'high',
            type: 'consecutive_days',
            description: '2 employees scheduled 6+ consecutive days (max 5 recommended)',
            recommendation: 'Add rest days to prevent burnout'
        });
    }
    
    issues.push({
        severity: 'medium',
        type: 'meal_breaks',
        description: '3 shifts over 5 hours without meal breaks',
        recommendation: 'Ensure 30-min breaks for all 5+ hour shifts'
    });
    
    return issues;
}

async function analyzeRosterDescription() {
    const description = document.getElementById('rosterDescription').value.trim();
    
    if (!description) {
        showAlert('Please describe your roster');
        return;
    }
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    try {
        const prompt = `Analyze this roster for compliance issues:\n\n${description}\n\nIdentify HIGH/MEDIUM/LOW severity issues with recommendations.`;
        const response = await callClaudeAPI(prompt);
        
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-slate-900 border-2 border-red-500 rounded-lg p-6">
                <h3 class="text-red-400 font-bold mb-4">ðŸ” Analysis Results</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;
        
        trackEvent('roster_description_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

function displayRosterStressResults(issues) {
    let html = '<div class="space-y-4">';
    
    issues.forEach(issue => {
        const colors = { high: 'red', medium: 'yellow', low: 'blue' };
        const color = colors[issue.severity];
        
        html += `
            <div class="bg-${color}-500/10 border-2 border-${color}-500 rounded-lg p-6">
                <p class="text-${color}-400 font-bold mb-2">${issue.description}</p>
                <p class="text-slate-300 text-sm">âœ“ ${issue.recommendation}</p>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('rosterStressResults').innerHTML = html;
}

// ========================================
// ROSTER OPTIMIZER
// ========================================

function handleRosterUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    setTimeout(() => {
        document.getElementById('rosterResults').classList.remove('hidden');
        document.getElementById('rosterIssues').innerHTML = `
            <p class="text-yellow-400">âš ï¸ 3 compliance issues found</p>
        `;
        document.getElementById('rosterOptimizations').innerHTML = `
            <p class="text-green-400 mb-2">ðŸ’¡ Potential savings: $412/week</p>
        `;
        trackEvent('roster_uploaded', { user: currentUser });
    }, 1500);
}

function showManualRoster() {
    showAlert('Manual entry coming soon! Please upload Excel/CSV for now.');
}

function downloadOptimizedRoster() {
    const data = [
        { Employee: 'John Smith', Monday: '9am-5pm', Tuesday: '9am-5pm', Wednesday: 'OFF' }
    ];
    generateExcelSpreadsheet(data, `Optimized_Roster_${Date.now()}.xlsx`, 'Roster');
    showAlert('âœ“ Downloaded! Review before implementing.');
}

// ========================================
// TERMINATION RISK ASSESSOR
// ========================================

function assessTerminationRisk() {
    const tenure = document.getElementById('termTenure').value;
    const reason = document.getElementById('termReason').value;
    const warnings = document.getElementById('termWarnings').value;

    if (!tenure || !reason || !warnings) {
        showAlert('Please answer all questions');
        return;
    }

    let riskScore = 0;
    if (tenure === 'over12months') riskScore += 30;
    if (warnings === 'none') riskScore += 40;
    if (document.getElementById('termPregnant').checked) riskScore += 50;

    let riskLevel, riskColor, riskMessage;
    
    if (riskScore < 30) {
        riskLevel = 'LOW RISK';
        riskColor = 'green';
        riskMessage = 'Appears procedurally fair';
    } else if (riskScore < 60) {
        riskLevel = 'MEDIUM RISK';
        riskColor = 'yellow';
        riskMessage = 'Some gaps exist - fix before terminating';
    } else {
        riskLevel = 'HIGH RISK';
        riskColor = 'red';
        riskMessage = 'DO NOT PROCEED - contact consultant';
    }

    document.getElementById('termRiskResults').innerHTML = `
        <div class="bg-${riskColor}-500/10 border-2 border-${riskColor}-500 rounded-lg p-6">
            <h3 class="text-${riskColor}-400 font-bold text-xl mb-3">${riskLevel}</h3>
            <p class="text-slate-200">${riskMessage}</p>
        </div>
    `;
    document.getElementById('termRiskResults').classList.remove('hidden');

    trackEvent('termination_assessed', { user: currentUser, riskLevel });
}

// ========================================
// SCENARIO ANALYSIS
// ========================================

async function analyzeScenario() {
    const description = document.getElementById('scenarioDescription').value;

    if (!description) {
        showAlert('Please describe your situation');
        return;
    }

    document.getElementById('scenarioResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('scenarioResults').classList.remove('hidden');

    try {
        const response = await callClaudeAPI(`Analyze this HR scenario:\n\n${description}\n\nProvide specific advice and action plan.`);
        
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                <h3 class="text-green-500 font-bold mb-4">âœ… Analysis</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;

        trackEvent('scenario_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

// ========================================
// XERO INTEGRATION
// ========================================

function connectXero() {
    showAlert('ðŸ”— XERO INTEGRATION\n\nOAuth connection would happen here in production.\n\nContact info@fitzgeraldhr.com.au to enable.');
    
    document.getElementById('xeroNotConnected').classList.add('hidden');
    document.getElementById('xeroConnected').classList.remove('hidden');
    
    document.getElementById('xeroAnalysis').innerHTML = `
        <div class="bg-slate-900 p-4 rounded">
            <p class="text-green-400 font-bold">âœ“ Connected (Demo)</p>
            <p class="text-slate-300 text-sm mt-2">Labor cost: $18,473/month</p>
        </div>
    `;

    trackEvent('xero_connected', { user: currentUser });
}

// ========================================
// COMPLIANCE CALENDAR - COMPLETE IMPLEMENTATION
// ========================================

function saveComplianceSettings() {
    const checkboxes = document.querySelectorAll('#complianceCalendarModal input[type="checkbox"]');
    const settings = {
        awardRates: checkboxes[0]?.checked || false,
        casualConversion: checkboxes[1]?.checked || false,
        publicHolidays: checkboxes[2]?.checked || false,
        leaveAccrual: checkboxes[3]?.checked || false,
        policyReview: checkboxes[4]?.checked || false,
        savedAt: new Date().toISOString()
    };
    
    const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
    localStorage.setItem('complianceSettings_' + userKey, JSON.stringify(settings));
    
    trackEvent('compliance_settings_saved', { user: userKey });
    
    showAlert('âœ“ Settings Saved!\n\nYou will receive reminders for selected items.\n\n(Email notifications require backend integration)');
}

// ========================================
// FEEDBACK SYSTEM
// ========================================

function showFeedback() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedback() {
    document.getElementById('feedbackModal').classList.add('hidden');
}

// ========================================
// LOGOUT FUNCTION
// ========================================

function logout() {
    // Show the logout options modal
    document.getElementById('logoutModal').classList.remove('hidden');
    
    // Track that user opened logout dialog
    trackEvent('logout_dialog_opened', { user: currentUser });
}

function setRating(rating) {
    feedbackRating = rating;
    document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
        if (idx < rating) {
            btn.classList.add('bg-amber-500');
            btn.classList.remove('bg-slate-700');
        } else {
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-slate-700');
        }
    });
}

/**
 * Closes the logout modal without logging out
 */
function closeLogoutModal() {
    document.getElementById('logoutModal').classList.add('hidden');
    trackEvent('logout_cancelled', { user: currentUser });
}

/**
 * Performs logout with specified type (soft or hard)
 * @param {string} type - 'soft' (keep code) or 'hard' (forget device)
 */
async function confirmLogout(type) {
    // Close the modal first
    closeLogoutModal();
    
    // Store current user for tracking before clearing
    const loggedOutUser = currentUser;
    
    if (type === 'soft') {
        // âœ… SOFT LOGOUT - Keep access code stored for auto-login
        // localStorage stays intact - user will auto-login next visit
    } else if (type === 'hard') {
        // âœ… HARD LOGOUT - Clear everything, forget this device
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
    }
    
    // Perform the actual logout (now async)
    await performLogout(loggedOutUser, type);
}

/**
 * Performs the actual logout operations
 * @param {string} loggedOutUser - User code before logout
 * @param {string} type - Logout type for analytics
 */
async function performLogout(loggedOutUser, type) {
    // IMPORTANT: Save current conversation to Firebase BEFORE clearing!
    if (currentConversationId) {
        // Save the current conversation
        if (typeof saveCurrentConversation === 'function') {
            saveCurrentConversation();
        }
        
        // Wait for Firebase sync to complete
        if (typeof syncConversationsToCloud === 'function') {
            try {
                await syncConversationsToCloud();
            } catch (e) {
            }
        }
        
        // Save the last conversation ID to Firebase
        if (currentUser && currentUser.uid && typeof saveCurrentConversationIdToFirebase === 'function') {
            try {
                await saveCurrentConversationIdToFirebase(currentConversationId);
            } catch (e) {
            }
        }
    }
    
    // Reset current user
    currentUser = null;
    
    // Clear conversation history
    conversationHistory = [];
    
    // Clear current conversation ID
    currentConversationId = null;
    
    // Clear messages from screen
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        const container = messagesContainer.querySelector('.space-y-6');
        if (container) {
            // Restore welcome message
            container.innerHTML = `
                <div class="flex justify-start">
                    <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
                        <p class="text-slate-100 leading-relaxed">
                            ðŸ‘‹ G'day! I'm Fitz, your AI-powered HR knowledge companion from Fitzgerald HR, 
                            specializing in hospitality HR for Australian venues.
                        </p>

                        <p class="text-slate-100 leading-relaxed mt-3">
                            I can help you understand Fair Work compliance, award interpretation, employee relations, 
                            recruitment processes, and more.
                        </p>

                        <div class="bg-amber-500/10 border-l-4 border-amber-500 rounded-r-lg p-3 mt-4">
                            <p class="text-amber-300 text-sm font-semibold">ðŸ’¡ Try asking:</p>
                            <p class="text-slate-300 text-xs mt-1">
                                "What should I pay a casual waiter?" â€¢ "Can I fire someone for being late?" â€¢ "How do I write a warning letter?"
                            </p>
                        </div>

                        <p class="text-slate-100 text-sm mt-4">
                            ðŸ’¡ <strong>Tip:</strong> I have 8 specialized tools (click ðŸ› ï¸ above). 
                            I'll suggest the right ones as we talk, or browse them anytime.
                        </p>

                        <p class="text-red-400 font-semibold mt-4 mb-2">ðŸš¨ Urgent/Critical Situations:</p>
                        <p class="text-slate-100 text-sm">
                            Use the red URGENT button above for immediate crisis response.
                        </p>

                        <p class="text-slate-100 leading-relaxed mt-4">
                            What HR topic would you like to learn about today?
                        </p>

                        <p class="text-yellow-400 text-xs mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded p-3">
                            âš ï¸ <strong>Award Rates:</strong> Data effective 1 July 2025 - 30 June 2026. 
                            Always verify at <a href="https://www.fairwork.gov.au" target="_blank" class="underline hover:text-yellow-300">fairwork.gov.au</a> 
                            before making payroll decisions.
                        </p>
                    </div>
                </div>
            `;
        }
    }
    
    // Close sidebar before logout
    var sidebar = document.getElementById('chatSidebar');
    if (sidebar) {
        sidebar.classList.add('closed');
    }
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    if (sidebarOverlay) {
        sidebarOverlay.classList.remove('active');
    }
    sidebarOpen = false;
    
    // Hide assistant screen
    const assistantScreen = document.getElementById('assistantScreen');
    if (assistantScreen) {
        assistantScreen.classList.add('hidden');
    }
    
    // Show access screen
    const accessScreen = document.getElementById('accessScreen');
    if (accessScreen) {
        accessScreen.classList.remove('hidden');
    }
    
    // Clear access code input field
    const accessInput = document.getElementById('accessCodeInput');
    if (accessInput) {
        accessInput.value = '';
    }
    
    // Clear any error messages
    const accessError = document.getElementById('accessError');
    if (accessError) {
        accessError.classList.add('hidden');
    }
    
    // Hide admin button
    const adminBtn = document.getElementById('adminButton');
    if (adminBtn) {
        adminBtn.classList.add('hidden');
    }
    
    // Track logout event with detailed analytics
    trackEvent('user_logout', { 
        user: loggedOutUser,
        type: type,
        timestamp: new Date().toISOString(),
        codeRemembered: type === 'soft'
    });
    
    // Log to Supabase if available
    if (supabaseClient) {
        supabaseClient
            .from('user_sessions')
            .insert([{
                user_code: loggedOutUser,
                action: 'logout',
                logout_type: type,
                timestamp: new Date().toISOString()
            }])
            .then(() => {})
            .catch(() => {});
    }
}

function submitFeedback() {
    const likes = document.getElementById('feedbackLikes').value;
    const improve = document.getElementById('feedbackImprove').value;
    const willPay = document.querySelector('input[name="willPay"]:checked')?.value;
    
    // Submit to Netlify Forms
    fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            'form-name': 'beta-feedback',
            'user': currentUser,
            'rating': feedbackRating,
            'likes': likes,
            'improve': improve,
            'willPay': willPay
        }).toString()
    })
    .then(() => {
        trackEvent('beta_feedback', {
            user: currentUser,
            rating: feedbackRating,
            likes, improve, willPay
        });
        
        showAlert('âœ“ Thank you! Your feedback has been submitted.\n\nWe really appreciate your help improving this tool!');
        closeFeedback();
        
        // Reset form
        document.getElementById('feedbackLikes').value = '';
        document.getElementById('feedbackImprove').value = '';
        document.querySelectorAll('input[name="willPay"]').forEach(r => r.checked = false);
        feedbackRating = 0;
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-slate-700');
        });
    })
    .catch(err => {
        showAlert('âš ï¸ Error submitting feedback. Please try again or email us at info@fitzgeraldhr.com.au');
    });
}

// ========================================
// ANALYTICS & UTILITIES
// ========================================

/**
 * Validates stored access code on focus/visibility change
 * Clears invalid codes automatically
 */
function validateStoredCode() {
    const storedCode = localStorage.getItem('fitzhr_access_code');
    
    if (storedCode && !CONFIG.VALID_CODES.includes(storedCode)) {
        localStorage.removeItem('fitzhr_access_code');
        localStorage.removeItem('fitzhr_last_login');
        
        // If user is currently logged in, log them out
        if (currentUser === storedCode) {
            showAlert('âš ï¸ Your access code is no longer valid. Please contact support.');
            logout();
        }
    }
}

// Run validation when page becomes visible
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        validateStoredCode();
    }
});

function trackEvent(eventName, data) {
    // TODO: Send to analytics platform
}

function generateDocumentId() {
    return 'DOC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

// Convert markdown-style content to HTML for PDF/Word export
function convertMarkdownToHTML(markdown) {
    let html = markdown;
    
    // Convert headers (## Header -> <h2>Header</h2>)
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    
    // Convert bold (**text** -> <strong>text</strong>)
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Convert bullet points (â€¢ text or - text -> <li>text</li>)
    html = html.replace(/^[â€¢\-] (.+)$/gm, '<li>$1</li>');
    
    // Wrap consecutive <li> items in <ul>
    html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
        return '<ul>' + match + '</ul>';
    });
    
    // Convert line breaks to paragraphs
    html = html.split('\n\n').map(para => {
        // Don't wrap if it's already wrapped in a tag
        if (para.trim().startsWith('<')) {
            return para;
        }
        return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
    }).join('\n');
    
    return html;
}


// ========================================
// TESTIMONIAL ROTATION SYSTEM
// ========================================

const testimonials = [
    {
        quote: "Saved me $300 on a consultant call. Got my answer in 2 minutes instead of waiting days for a callback.",
        author: "Phil A., Pub Owner, Sydney",
        rating: 5
    },
    {
        quote: "The Award Wizard is brilliant. No more guessing if I'm paying staff correctly.",
        author: "Michael S., CafÃ© Owner/Manager, Sydney",
        rating: 5
    },
    {
        quote: "Crisis mode saved my business. Had an urgent termination issue at 11pm - got expert guidance immediately.",
        author: "Evan G., Hotel Manager, Brisbane",
        rating: 5
    },
    {
        quote: "Finally understand penalty rates. The calculator alone is worth the subscription.",
        author: "Emma R., Restaurant Owner, Melbourne",
        rating: 5
    }
];

let currentTestimonialIndex = 0;

function rotateTestimonial() {
    const carousel = document.getElementById('testimonialCarousel');
    if (!carousel) return;
    
    currentTestimonialIndex = (currentTestimonialIndex + 1) % testimonials.length;
    const testimonial = testimonials[currentTestimonialIndex];
    
    // Fade out
    carousel.style.opacity = '0';
    carousel.style.transition = 'opacity 0.3s ease-out';
    
    setTimeout(() => {
        // Update content - streamlined horizontal layout
        const stars = 'â­'.repeat(testimonial.rating);
        carousel.innerHTML = `
            <div class="testimonial-slide flex items-center gap-4">
                <div class="text-3xl flex-shrink-0">${stars}</div>
                <div class="flex-1">
                    <p class="text-slate-200 text-sm italic">
                        "${testimonial.quote}"
                    </p>
                    <p class="text-slate-500 text-xs mt-2">â€” ${testimonial.author}</p>
                </div>
            </div>
        `;
        
        // Fade in
        carousel.style.opacity = '1';
    }, 300);
}

// Start rotation when on access screen
function startTestimonialRotation() {
    // Rotate every 5 seconds
    setInterval(rotateTestimonial, 5000);
}

// ========================================
// EVENT LISTENERS
// ========================================

document.addEventListener('click', function(event) {
    const toolsMenu = document.getElementById('toolsMenu');
    const toolsButton = event.target.closest('button');
    
    if (toolsMenu && !toolsMenu.contains(event.target) && 
        (!toolsButton || !toolsButton.onclick?.toString().includes('toggleToolsMenu'))) {
        toolsMenu.classList.add('hidden');
    }
});

// ========================================
// TERMINATION PROCESS FUNCTIONS
// ========================================

function showTerminationConsultantRequired() {
    // Close document builder
    closeToolModal('documentBuilderModal');
    
    // Show termination consultant modal
    document.getElementById('terminationConsultantModal').classList.remove('hidden');
    
    trackEvent('termination_process_viewed', {
        user: currentUser,
        timestamp: new Date().toISOString()
    });
}

function closeTerminationConsultantModal() {
    document.getElementById('terminationConsultantModal').classList.add('hidden');
}

function openTerminationRiskFromModal() {
    // Close termination modal
    closeTerminationConsultantModal();
    
    // Open termination risk assessor tool
    openTool('terminationRisk');
    
    trackEvent('termination_risk_opened_from_modal', {
        user: currentUser
    });
}

function openTerminationConsultantEmail() {
    // Gather venue and user context
    const venueName = venueProfile.venueName || '[Your Venue Name]';
    const venueLocation = venueProfile.city ? `${venueProfile.city}, ${venueProfile.location}` : '[Location]';
    const userName = venueProfile.userName || '[Your Name]';
    const userCode = currentUser || '[User Code]';
    
    // Build comprehensive email with smart pre-population
    const subject = encodeURIComponent(`URGENT: Termination Guidance Required - ${venueName}`);
    
    const body = encodeURIComponent(
`Dear Fitzgerald HR Senior Consultant,

I require urgent expert guidance on an employment termination process to ensure full compliance with Fair Work requirements and minimize legal risk.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
VENUE DETAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Venue Name: ${venueName}
Location: ${venueLocation}
Contact Name: ${userName}
User Code: ${userCode}
Phone: [Your Phone Number]
Preferred Contact Time: [e.g., 9am-5pm AEDT]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EMPLOYEE DETAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Employee Name: [Full Name]
Position: [e.g., Chef, Waiter]
Employment Type: [Full-Time / Part-Time / Casual]
Length of Service: [e.g., 2 years 3 months]
Current Status: [Active / Suspended / On leave]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
REASON FOR TERMINATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Primary Reason: [Select one]
â˜ Performance (ongoing underperformance)
â˜ Misconduct (policy breach, insubordination)
â˜ Serious Misconduct (theft, harassment, violence)
â˜ Redundancy (genuine operational reasons)
â˜ Other: [Specify]

Brief Description:
[Describe the issue in 2-3 sentences - What happened? When? How many times?]


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
PROCEDURAL FAIRNESS COMPLETED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â˜ Record of Discussion completed (for performance/minor misconduct)
â˜ Letter of Allegation issued (for serious misconduct)
â˜ Verbal warnings given - How many? [   ]
â˜ Written warnings given - How many? [   ]
â˜ Formal investigation conducted
â˜ Employee given opportunity to respond
â˜ Performance Improvement Plan implemented

Date of most recent warning/discussion: [DD/MM/YYYY]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EMPLOYEE'S RESPONSE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Has the employee provided a response/explanation? [Yes / No]

Summary of employee's response:
[What did they say? Any mitigating circumstances? Acknowledgment of issues?]


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EVIDENCE AVAILABLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â˜ Witness statements - How many? [   ]
â˜ CCTV footage
â˜ Written documentation (emails, messages, reports)
â˜ Time and attendance records
â˜ Customer complaints
â˜ Performance records/KPIs
â˜ Photos/screenshots
â˜ Other: [Specify]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RISK FACTORS (Please check any that apply)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â˜ Employee is pregnant or on parental leave
â˜ Employee has made a workplace complaint recently
â˜ Employee is on workers compensation
â˜ Employee is a union member/delegate
â˜ Employee has raised safety concerns
â˜ Employee has requested flexible work arrangements
â˜ Employee has a disability or ongoing medical condition
â˜ Possible discrimination concerns (age, race, gender, etc.)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
URGENCY & TIMELINE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
When do you plan to terminate? [Date]

Urgency Level:
â˜ Critical (within 24-48 hours)
â˜ Urgent (within 1 week)
â˜ Standard (within 2 weeks)

Reason for urgency:
[e.g., Workplace safety risk, business continuity, ongoing damage]


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
DOCUMENTATION ATTACHED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Please attach the following documents to this email:
â˜ Completed Record of Discussion / Letter of Allegation
â˜ All warning letters issued
â˜ Employee's responses/statements
â˜ Witness statements
â˜ Evidence (CCTV, photos, documents)
â˜ Employment contract
â˜ Position description
â˜ Any other relevant documentation

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
SPECIFIC QUESTIONS/CONCERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[List any specific questions or concerns you have about this termination]




â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

I understand that termination carries significant legal risk and I am seeking expert guidance to ensure:
1. Full compliance with Fair Work procedures
2. Procedurally fair process is followed
3. All documentation is legally sound
4. Risk of unfair dismissal claim is minimized

Please contact me as soon as possible to discuss this matter.

Best regards,
${userName}
${venueName}
`
    );
    
    // Open email client with pre-populated fields
    const mailtoLink = `mailto:info@fitzgeraldhr.com.au?subject=${subject}&body=${body}`;
    window.location.href = mailtoLink;
    
    // Track event
    trackEvent('termination_consultant_email_opened', {
        user: currentUser,
        venue: venueName,
        timestamp: new Date().toISOString()
    });
    
    // Show confirmation
    setTimeout(() => {
        showAlert(
            'âœ‰ï¸ Email Template Opened\n\n' +
            'Your email client should open with a pre-filled template.\n\n' +
            'Please:\n' +
            '1. Complete all [ ] fields\n' +
            '2. Attach required documentation\n' +
            '3. Review and send\n\n' +
            'A Senior Consultant will respond within 2 business hours.'
        );
    }, 500);
    
    // Close modal
    closeTerminationConsultantModal();
}

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM cache for performance
    DOM.accessScreen = document.getElementById('accessScreen');
    DOM.assistantScreen = document.getElementById('assistantScreen');
    DOM.messagesContainer = document.getElementById('messagesContainer');
    DOM.messageInput = document.getElementById('messageInput');
    DOM.sendButton = document.getElementById('sendButton');
    
    // Ensure message input is completely empty on load
    if (DOM.messageInput) {
        DOM.messageInput.value = '';
    }
    
    DOM.feedbackModal = document.getElementById('feedbackModal');
    DOM.crisisModal = document.getElementById('crisisModal');
    DOM.awardCalculatorModal = document.getElementById('awardCalculatorModal');
    DOM.awardWizardModal = document.getElementById('awardWizardModal');
    DOM.rosterStressTesterModal = document.getElementById('rosterStressTesterModal');
    DOM.complianceCalendarModal = document.getElementById('complianceCalendarModal');
    DOM.logoutModal = document.getElementById('logoutModal');

    DOM.toolsMenu = document.getElementById('toolsMenu');
    DOM.voiceButton = document.getElementById('voiceButton');
    DOM.voiceIcon = document.getElementById('voiceIcon');
    
    // Initialize dark mode from localStorage
    initDarkMode();
    
    // Initialize ChatGPT-style sidebar
    initSidebar();
    
    // Initialize conversation and bookmark systems
    loadBookmarks();
    updateBookmarkStars();
    updateSidebarBookmarks();
    
    // Initialize recent tools
    loadRecentTools();
    updateSidebarRecentTools();
    
    // Initialize scroll to bottom button (works on all devices)
    if (DOM.messagesContainer) {
        DOM.messagesContainer.addEventListener('scroll', updateScrollButtonVisibility);
        // Initial visibility check after a short delay
        setTimeout(updateScrollButtonVisibility, 1000);
    }
    
    // Load venueProfile from localStorage FIRST
    if (currentUser) {
        // Use currentUser.uid for Firebase users, or currentUser as string for access code users
        const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
        const saved = localStorage.getItem('venueProfile_' + userKey);
        if (saved) {
            try {
                venueProfile = JSON.parse(saved);
            } catch (e) {
            }
        }
    }
    
    // THEN update sidebar venue name
    updateSidebarVenueName();

    // Initialize Supabase
    initializeSupabase();
    
    // Initialize Fitz Credits system
    initializeUserCredits();
    
    // âœ… ATTEMPT AUTO-LOGIN BEFORE SHOWING ACCESS SCREEN
    const autoLoginSuccessful = attemptAutoLogin();    

    // Only start testimonial rotation if user is NOT auto-logged in
    if (!autoLoginSuccessful) {
        startTestimonialRotation();
    }
    
});

// ========================================
// GLOBAL ERROR HANDLING
// ========================================

/**
 * Global error handler - catches all unhandled errors
 * Provides user feedback and prevents white screen of death
 */
window.addEventListener('error', function(event) {
    // Create error notification bar
    const errorBar = document.createElement('div');
    errorBar.id = 'global-error-bar';
    errorBar.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-4 z-[9999] shadow-lg';
    errorBar.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">âš ï¸</span>
                <div>
                    <p class="font-bold">An error occurred</p>
                    <p class="text-sm opacity-90">The page will reload automatically to fix this</p>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-white text-red-600 px-6 py-2 rounded-lg font-bold hover:bg-red-50 transition-all">
                Reload Now
            </button>
        </div>
    `;
    
    // Remove existing error bar if present
    const existingBar = document.getElementById('global-error-bar');
    if (existingBar) existingBar.remove();
    
    // Add to page
    document.body.prepend(errorBar);
    
    // Auto-reload after delay
    setTimeout(() => {
        location.reload();
    }, CONFIG.ERROR_DISPLAY_TIME);
    
    // Prevent default error handling
    event.preventDefault();
});

/**
 * Handles unhandled promise rejections
 */
window.addEventListener('unhandledrejection', function(event) {
    // Create user-friendly error message
    const message = event.reason?.message || 'An unexpected error occurred';
    showAlert(`âš ï¸ Error: ${message}\n\nPlease try again or contact support if the issue persists.`);
    
    // Prevent default handling
    event.preventDefault();
});

// ========================================
// TERMS OF SERVICE & PRIVACY POLICY FUNCTIONS
// ========================================

function showTermsOfService() {
    document.getElementById('termsModal').classList.remove('hidden');
    trackEvent('terms_of_service_viewed', { user: currentUser });
}

function closeTermsOfService() {
    document.getElementById('termsModal').classList.add('hidden');
}

function showPrivacyPolicy() {
    document.getElementById('privacyModal').classList.remove('hidden');
    trackEvent('privacy_policy_viewed', { user: currentUser });
}

function closePrivacyPolicy() {
    document.getElementById('privacyModal').classList.add('hidden');
}

// ========================================
// LEGAL ACCEPTANCE MODAL FUNCTIONS
// ========================================

/**
 * Shows legal acceptance modal on first use
 */
async function showLegalAcceptanceModal() {
    const modal = document.getElementById('legalAcceptanceModal');
    const checkbox = document.getElementById('legalAcceptCheckbox');
    const acceptBtn = document.getElementById('acceptLegalButton');
    
    // Get user key for per-user storage
    const userKey = currentUser && currentUser.uid ? currentUser.uid : (currentUser || null);
    
    // If no valid user key, don't show modal (shouldn't happen but safety check)
    if (!userKey) {
        return false;
    }
    
    // STEP 1: Check localStorage first (fast)
    let hasAccepted = localStorage.getItem('legalTermsAccepted_' + userKey) === 'true';
    
    // STEP 2: If not in localStorage, check Firebase (for cross-device sync)
    if (!hasAccepted && currentUser && currentUser.uid && db) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                const firebaseValue = userData.legalTermsAccepted;
                
                // Accept both boolean true and string 'true'
                if (firebaseValue === true || firebaseValue === 'true') {
                    hasAccepted = true;
                    // Cache to localStorage for future fast checks
                    localStorage.setItem('legalTermsAccepted_' + userKey, 'true');
                    localStorage.setItem('legalTermsAcceptedAt_' + userKey, userData.legalTermsAcceptedAt || new Date().toISOString());
                }
            }
        } catch (e) {
            // Continue - will show modal if not in localStorage
        }
    }
    
    // STEP 3: Final decision
    if (hasAccepted) {
        return false; // Don't show modal
    }
    
    // STEP 4: Show modal (user hasn't accepted)
    if (!modal) {
        return false;
    }
    
    modal.classList.remove('hidden');
    
    // Reset checkbox state
    if (checkbox) checkbox.checked = false;
    if (acceptBtn) acceptBtn.disabled = true;
    
    // Enable accept button only when checkbox is checked
    if (checkbox) {
        checkbox.onchange = function() {
            if (acceptBtn) acceptBtn.disabled = !this.checked;
        };
    }
    
    trackEvent('legal_acceptance_modal_shown', { user: userKey });
    return true;
}

/**
 * User accepts legal terms
 */
async function acceptLegalTerms() {
    const checkbox = document.getElementById('legalAcceptCheckbox');
    
    if (!checkbox.checked) {
        showAlert('âš ï¸ Please check the box to confirm you understand and agree to the terms.');
        return;
    }
    
    // Get user key - try multiple sources
    let userKey = null;
    let firebaseUser = null;
    
    // Try 1: currentUser variable
    if (currentUser && currentUser.uid) {
        userKey = currentUser.uid;
        firebaseUser = currentUser;
    } else if (currentUser && typeof currentUser === 'string') {
        userKey = currentUser;
    }
    
    // Try 2: Firebase auth directly (fallback)
    if (!userKey && typeof auth !== 'undefined' && auth && auth.currentUser) {
        userKey = auth.currentUser.uid;
        firebaseUser = auth.currentUser;
        // Also fix currentUser variable
        currentUser = auth.currentUser;
    }
    
    // Try 3: localStorage fallback for access code users
    if (!userKey) {
        const storedCode = localStorage.getItem('fitzhr_access_code');
        if (storedCode) {
            userKey = storedCode;
        }
    }
    
    if (!userKey) {
        showAlert('Error: Unable to identify user. Please refresh the page and try signing in again.');
        return;
    }
    
    // Store acceptance with timestamp
    const timestamp = new Date().toISOString();
    
    // Save to localStorage first (immediate)
    localStorage.setItem('legalTermsAccepted_' + userKey, 'true');
    localStorage.setItem('legalTermsAcceptedAt_' + userKey, timestamp);
    
    // Save to Firebase for cross-device sync
    if (firebaseUser && firebaseUser.uid && db) {
        try {
            await db.collection('users').doc(firebaseUser.uid).set({
                legalTermsAccepted: true,
                legalTermsAcceptedAt: timestamp,
                legalTermsVersion: '1.0',
                legalTermsUserAgent: navigator.userAgent,
                legalTermsAcceptedBy: firebaseUser.email || userKey
            }, { merge: true });
        } catch (err) {
            // Continue anyway since localStorage worked
        }
    }
    
    // Close modal
    document.getElementById('legalAcceptanceModal').classList.add('hidden');
    
    // Track acceptance
    trackEvent('legal_terms_accepted', { 
        user: userKey,
        timestamp: timestamp,
        version: '1.0'
    });
    
    // Log to Supabase for audit trail (backup)
    logLegalAcceptance(userKey, timestamp);
    
    // Now check if user needs onboarding
    const hasCompletedOnboarding = checkOnboardingStatus();
    if (!hasCompletedOnboarding) {
        setTimeout(() => showOnboarding(), 500);
    } else {
        // Onboarding already complete - restore last conversation
        setTimeout(() => {
            restoreLastConversation();
            updateSidebarChats();
        }, 500);
    }
}

/**
 * User declines legal terms
 */
function declineLegalTerms() {
    const confirmed = confirm(
        "âš ï¸ You must accept the terms to use this tool.\n\n" +
        "If you don't agree, you will be logged out.\n\n" +
        "Are you sure you want to decline?"
    );
    
    if (confirmed) {
        const userKey = currentUser && currentUser.uid ? currentUser.uid : currentUser;
        trackEvent('legal_terms_declined', { user: userKey });
        
        // Log them out
        showAlert('You have declined the terms. You will now be logged out.');
        logout();
    }
}

/**
 * Log legal acceptance to database for audit trail
 */
async function logLegalAcceptance(user, timestamp) {
    if (!supabaseClient) {
        return;
    }
    
    try {
        const { data, error } = await supabaseClient
            .from('legal_acceptances')
            .insert([{
                user_code: user,
                accepted_at: timestamp,
                terms_version: '1.0',
                ip_address: null, // Could add IP logging if needed
                user_agent: navigator.userAgent
            }]);
        
        if (error) {
        } else {
        }
    } catch (err) {
    }
}

/**
 * Show Terms from acceptance modal (opens in new window context)
 */
function showTermsFromAcceptance() {
    // Open terms in background, keep acceptance modal in front
    const termsModal = document.getElementById('termsModal');
    termsModal.classList.remove('hidden');
    termsModal.style.zIndex = '55'; // Below acceptance modal (z-60)
}

/**
 * Show Privacy from acceptance modal
 */
function showPrivacyFromAcceptance() {
    const privacyModal = document.getElementById('privacyModal');
    privacyModal.classList.remove('hidden');
    privacyModal.style.zIndex = '55'; // Below acceptance modal (z-60)
}



// Handle OAuth callback in popup window
async function handleDeputyCallbackInPopup() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (!code) {
            showAlert('âŒ No authorization code received');
            window.close();
            return;
        }
        
        // Verify state
        const savedState = sessionStorage.getItem('deputy_oauth_state');
        if (state !== savedState) {
            showAlert('âŒ Security check failed');
            window.close();
            return;
        }
        
        const userId = sessionStorage.getItem('deputy_oauth_user_id') || 'test-user-' + Date.now();
        
        // Exchange code for token
        const response = await fetch('/.netlify/functions/deputy-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code,
                user_id: userId,
                supabase_url: SUPABASE_CONFIG.url,
                supabase_key: SUPABASE_CONFIG.anonKey
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to connect');
        }
        
        // Notify parent window
        if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ 
                type: 'deputy_oauth_success',
                userId: userId
            }, window.location.origin);
        }
        
        // Clean up and close
        sessionStorage.removeItem('deputy_oauth_state');
        sessionStorage.removeItem('deputy_oauth_user_id');
        
        // Show success message
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #10b981;">Deputy Connected!</div>
                    <div style="color: #94a3b8; margin-bottom: 20px;">This window will close automatically...</div>
                </div>
            </div>
        `;
        
        // Close after 2 seconds
        setTimeout(() => {
            window.close();
        }, 2000);
        
    } catch (error) {
        // Show error message
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #ef4444;">Connection Failed</div>
                    <div style="color: #94a3b8; margin-bottom: 20px;">${error.message}</div>
                    <button onclick="window.close()" style="background: #ef4444; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Close Window</button>
                </div>
            </div>
        `;
        
        if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ 
                type: 'deputy_oauth_error',
                error: error.message
            }, window.location.origin);
        }
    }
}

// Listen for messages from popup window
window.addEventListener('message', (event) => {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'deputy_oauth_success') {
        showNotification('âœ… Deputy connected successfully!', 'success');
        closeDeputyConnection();
        
        // Refresh Integration Hub if open
        if (!document.getElementById('integrationHubModal').classList.contains('hidden')) {
            checkDeputyConnection();
        }
        
        // Auto-open dashboard and sync
        setTimeout(() => {
            openRosterCompliance();
        }, 500);
    }
    
    if (event.data.type === 'deputy_oauth_error') {
        showNotification(`âŒ Connection failed: ${event.data.error}`, 'error');
    }
});


window.addEventListener('DOMContentLoaded', function() {
    if (typeof htmlDocx !== 'undefined') {
        // Try the absolute simplest conversion
        const testHTML = '<html><body><p>Test</p></body></html>';
        try {
            const result = htmlDocx.asBlob(testHTML);
        } catch (e) {
        }
    }
    
    // ========================================
    // WEEK 2: INITIALIZE NEW FEATURES
    // ========================================
    
    // Initialize keyboard navigation
    initKeyboardNavigation();
    
    // Preload critical modals for better performance
    setTimeout(() => {
        preloadModals();
    }, 2000);
    
    // Show welcome toast (only once per session)
    if (!sessionStorage.getItem('welcomeShown')) {
        setTimeout(() => {
            showToast('Welcome! Press Ctrl+K to focus the message input anytime.', 'info', 5000);
            sessionStorage.setItem('welcomeShown', 'true');
        }, 1000);
    }
    
    // Add smooth fade-in to messages container
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        messagesContainer.style.opacity = '0';
        setTimeout(() => {
            messagesContainer.style.transition = 'opacity 0.5s';
            messagesContainer.style.opacity = '1';
        }, 100);
    }
});



// Simple notification function for Deputy integration
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// ========================================
// INTEGRATION HUB FUNCTIONS
// ========================================

function openIntegrationHub() {
    document.getElementById('integrationHubModal').classList.remove('hidden');
    checkDeputyConnection();
}

function closeIntegrationHub() {
    document.getElementById('integrationHubModal').classList.add('hidden');
}

async function checkDeputyConnection() {
    try {
        // Check if supabase is initialized
        if (!window.supabaseClient || !supabaseClient.auth) {
            return;
        }
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;
        
        const { data: integration } = await supabaseClient
            .from('integrations')
            .select('*')
            .eq('user_id', user.id)
            .eq('platform', 'deputy')
            .eq('is_active', true)
            .single();
        
        if (integration) {
            document.getElementById('deputyStatus').textContent = 'Connected';
            document.getElementById('deputyStatusBadge').textContent = 'Connected';
            document.getElementById('deputyStatusBadge').className = 'px-3 py-1 bg-green-500/20 text-green-400 text-xs font-semibold rounded-full';
            document.getElementById('deputyLastSync').style.display = 'flex';
            if (integration.last_synced) {
                const lastSync = new Date(integration.last_synced);
                const now = new Date();
                const diffMins = Math.floor((now - lastSync) / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                document.getElementById('deputyLastSyncTime').textContent = diffHours > 0 ? `${diffHours}h ago` : diffMins > 0 ? `${diffMins}m ago` : 'Just now';
            }
            document.getElementById('deputyConnectBtn').classList.add('hidden');
            document.getElementById('deputyDashboardBtn').classList.remove('hidden');
            document.getElementById('connectedCount').textContent = '1';
        }
    } catch (error) {
    }
}



// Universal roster sync function (works with both OAuth and token)
async function syncRosterData() {
    try {
        showNotification('ðŸ”„ Syncing rosters...', 'info');
        
        // Get token from sessionStorage first (for token users)
        let deputyToken = sessionStorage.getItem('deputy_token');
        let userId = sessionStorage.getItem('deputy_user_id') || 'test-user-' + Date.now();
        
        // If no token in sessionStorage, try Supabase (for OAuth users)
        if (!deputyToken && typeof supabaseClient !== 'undefined' && supabaseClient) {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    userId = user.id;
                    const { data: integration } = await supabaseClient
                        .from('integrations')
                        .select('access_token')
                        .eq('user_id', userId)
                        .eq('platform', 'deputy')
                        .eq('is_active', true)
                        .single();
                    
                    if (integration) {
                        deputyToken = integration.access_token;
                    }
                }
            } catch (error) {
            }
        }
        
        if (!deputyToken) {
            showNotification('âŒ Deputy not connected', 'error');
            return;
        }
        
        // Call sync function with token
        await syncDeputyRostersWithToken(deputyToken);
        
    } catch (error) {
        showNotification(`âŒ Sync failed: ${error.message}`, 'error');
    }
}

async function syncAllIntegrations() {
    showNotification('ðŸ”„ Syncing all integrations...', 'info');
    try {
        // Check if Deputy is connected and get token
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
            showNotification('âŒ System not ready', 'error');
            return;
        }
        
        let userId;
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            userId = user?.id || 'test-user-' + Date.now();
        } catch (error) {
            userId = 'test-user-' + Date.now();
        }
        
        // Try to get token from Supabase, fall back to sessionStorage
        let deputyToken = null;
        
        try {
            const { data: integration } = await supabaseClient
                .from('integrations')
                .select('*')
                .eq('user_id', userId)
                .eq('platform', 'deputy')
                .eq('is_active', true)
                .single();
            
            if (integration && integration.access_token) {
                deputyToken = integration.access_token;
            }
        } catch (error) {
        }
        
        // Fall back to sessionStorage
        if (!deputyToken) {
            deputyToken = sessionStorage.getItem('deputy_token');
        }
        
        if (!deputyToken) {
            showNotification('âš ï¸ Deputy not connected', 'warning');
            return;
        }
        
        // Sync using the stored token
        await syncDeputyRostersWithToken(deputyToken);
        
    } catch (error) {
        showNotification(`âŒ Sync failed: ${error.message}`, 'error');
    }
}



// ========================================


// Manual Deputy token connection (bypass OAuth)
function openDeputyTokenEntry() {
    const modal = document.createElement('div');
    modal.id = 'deputyTokenModal';
    modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 rounded-2xl p-8 max-w-md w-full border border-amber-500">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-amber-500">Enter Deputy Token</h2>
                <button onclick="closeDeputyTokenEntry()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4 text-sm">
                <div class="font-semibold text-blue-300 mb-2">ðŸ“ Get your Deputy access token:</div>
                <ol class="text-slate-300 space-y-2 list-decimal list-inside text-xs">
                    <li>
                        <a href="#" onclick="event.preventDefault(); window.open('https://e1849e30081029.au.deputy.com/exec/devapp/oauth_clients', '_blank')" class="text-amber-400 hover:text-amber-300 underline font-semibold">
                            Click here to open Deputy OAuth settings â†’
                        </a>
                    </li>
                    <li>Click the "New OAuth Client" button</li>
                    <li>Fill in the form:
                        <div class="ml-6 mt-1 space-y-0.5 text-slate-400">
                            â€¢ Name: <span class="text-white">Fitzgerald HR</span><br>
                            â€¢ Description: <span class="text-white">HR compliance chatbot</span><br>
                            â€¢ Redirect URI: <span class="text-white">http://localhost</span>
                        </div>
                    </li>
                    <li>Click "Save this OAuth Client"</li>
                    <li>Click "Get an Access Token" button</li>
                    <li>Copy the token from the modal (it only shows once!)</li>
                    <li>Paste it below and click "Connect with Token"</li>
                </ol>
                <div class="mt-3 p-2 bg-amber-500/10 border border-amber-500/30 rounded text-xs text-amber-300">
                    âš ï¸ <strong>Important:</strong> If your Deputy URL is not "e1849e30081029.au.deputy.com", replace "once" in the link above with your subdomain.
                </div>
            </div>
            
            <input type="text" id="deputyTokenInput" placeholder="Paste your token here..." 
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4">
            
            <div class="flex gap-3">
                <button onclick="saveDeputyToken()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg">
                    Connect with Token
                </button>
                <button onclick="closeDeputyTokenEntry()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">
                    Cancel
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeDeputyTokenEntry() {
    const modal = document.getElementById('deputyTokenModal');
    if (modal) modal.remove();
}

async function saveDeputyToken() {
    const token = document.getElementById('deputyTokenInput').value.trim();
    
    if (!token) {
        showAlert('Please enter a token');
        return;
    }
    
    try {
        showNotification('ðŸ”„ Connecting with token...', 'info');
        
        // Save token directly to Supabase (skip API test due to CORS)
        // Save token to Supabase
        if (typeof supabaseClient !== 'undefined' && supabaseClient) {
            let userId;
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                userId = user?.id || 'test-user-' + Date.now();
            } catch (error) {
                userId = 'test-user-' + Date.now();
            }
            
            const { error } = await supabaseClient
                .from('integrations')
                .upsert({
                    user_id: userId,
                    platform: 'deputy',
                    access_token: token,
                    refresh_token: null,
                    token_expires_at: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(), // 1 year
                    is_active: true,
                    settings: {
                        domain: 'once',
                        token_type: 'permanent'
                    },
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'user_id,platform'
                });
            
            if (error) {
                throw new Error('Failed to save connection');
            }
        }
        
        showNotification('âœ… Deputy connected successfully!', 'success');
        closeDeputyTokenEntry();
        closeDeputyConnection();
        
        // Sync rosters
        await syncDeputyRostersWithToken(token);
        openRosterCompliance();
        
    } catch (error) {
        showNotification(`âŒ ${error.message}`, 'error');
    }
}

async function syncDeputyRostersWithToken(token) {
    try {
        showNotification('ðŸ”„ Syncing rosters from Deputy...', 'info');
        
        let userId;
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            userId = user?.id || 'test-user-' + Date.now();
        } catch (error) {
            userId = 'test-user-' + Date.now();
        }
        
        // Call Netlify function to sync rosters (avoids CORS)
        const rostersResponse = await fetch('/.netlify/functions/deputy-sync-rosters', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                access_token: token,
                supabase_url: SUPABASE_CONFIG.url,
                supabase_key: SUPABASE_CONFIG.anonKey
            })
        });
        
        if (!rostersResponse.ok) {
            throw new Error('Failed to fetch rosters');
        }
        
        const data = await rostersResponse.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to sync rosters');
        }
        
        rosterData = data.rosters || [];
        
        const issueCount = data.issues || 0;
        if (issueCount > 0) {
            showNotification(`âœ… Synced ${data.total} shifts. âš ï¸ Found ${issueCount} issue(s).`, 'warning');
        } else {
            showNotification(`âœ… Synced ${data.total} shifts. All compliant!`, 'success');
        }
        
    } catch (error) {
        showNotification(`âŒ ${error.message}`, 'error');
    }
}

function formatDateForDeputy(date) {
    return date.toISOString().split('T')[0];
}

function formatTimeFromTimestamp(timestamp) {
    if (!timestamp) return '00:00';
    const date = new Date(timestamp * 1000);
    return date.toTimeString().slice(0, 5);
}

function calculateHoursSimple(startTs, endTs) {
    return Math.round(((endTs - startTs) / 3600) * 100) / 100;
}


// DEPUTY INTEGRATION - FRONTEND CODE
// ========================================

let deputyAccessToken = null;
let deputyRefreshToken = null;
let rosterData = [];

function openDeputyConnection() {
    // Open Integration Hub instead (the modal doesn't exist anymore)
    openIntegrationHub();
}

function closeDeputyConnection() {
    // Close Integration Hub instead
    closeIntegrationHub();
}

async function initiateDeputyOAuth() {
    try {
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
            showAlert('âŒ System not ready. Please refresh the page.');
            return;
        }
        let user;
        try {
            const { data: { user: authUser }, error: userError } = await supabaseClient.auth.getUser();
            user = authUser;
        } catch (error) {
            user = null;
        }
        
        // For testing: Allow connection even if not logged in
        if (!user) { 
            user = { id: 'test-user-' + Date.now() };
        }
        // Check Pro plan (skip if subscriptions table doesn't exist yet)
        try {
            const { data: subscription, error: subError } = await supabaseClient.from('subscriptions').select('plan').eq('user_id', user.id).single();
            if (subscription && subscription.plan !== 'pro') { 
                showAlert('âš ï¸ Deputy integration requires the Pro plan ($149/month). Please upgrade to continue.');
                return;
            }
        } catch (error) {
        }
        
        const clientId = '478e80ddc33b583f97849b407d7a1265944cc607';
        const redirectUri = `${window.location.origin}/auth/deputy/callback`;
        const scope = 'longlife_refresh_token roster.read employee.read timesheet.read';
        const state = generateRandomString(32);
        
        // Save state and user ID for callback
        sessionStorage.setItem('deputy_oauth_state', state);
        sessionStorage.setItem('deputy_oauth_user_id', user.id);
        
        const oauthUrl = `https://e1849e30081029.au.deputy.com/my/oauth/login?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}&state=${state}`;
        
        // Open OAuth in NEW TAB - this keeps the main page alive!
        const oauthWindow = window.open(oauthUrl, 'deputyOAuth', 'width=600,height=700');
        
        if (!oauthWindow) {
            showAlert('Please allow popups for this site to connect Deputy');
            return;
        }
        
        showNotification('ðŸ”µ Authorize Deputy in the popup window...', 'info');
    } catch (error) { 
        showAlert(`âŒ Failed to connect Deputy: ${error.message}`); 
    }
}

async function handleDeputyCallback() {
    try {
        // Try to get code from URL first, then sessionStorage
        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');
        let state = urlParams.get('state');
        
        if (!code) {
            // Check sessionStorage for stored OAuth data
            code = sessionStorage.getItem('deputy_oauth_code');
            state = sessionStorage.getItem('deputy_oauth_state');
            
            if (code) {
            } else {
                return;
            }
        } else {
        }
        
        if (!code) return;
        if (state !== sessionStorage.getItem('deputy_oauth_state')) throw new Error('Invalid state');
        
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
            showNotification('âŒ System not ready', 'error');
            return;
        }
        
        showNotification('ðŸ”„ Connecting...', 'info');
        const { data: { user } } = await supabaseClient.auth.getUser();
        const response = await fetch('/.netlify/functions/deputy-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, user_id: user.id, supabase_url: supabase.supabaseUrl, supabase_key: supabase.supabaseKey })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error);
        sessionStorage.removeItem('deputy_oauth_state');
        sessionStorage.removeItem('deputy_oauth_code');
        sessionStorage.removeItem('deputy_oauth_timestamp');
        window.history.replaceState({}, document.title, window.location.pathname);
        showNotification('âœ… Connected!', 'success');
        await syncDeputyRosters();
        closeDeputyConnection();
        openRosterCompliance();
    } catch (error) {
        showNotification(`âŒ ${error.message}`, 'error');
        sessionStorage.removeItem('deputy_oauth_state');
        sessionStorage.removeItem('deputy_oauth_code');
        sessionStorage.removeItem('deputy_oauth_timestamp');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

async function syncDeputyRosters() {
    try {
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
            showNotification('âŒ System not ready', 'error');
            return;
        }
        showNotification('ðŸ”„ Syncing...', 'info');
        const { data: { user } } = await supabaseClient.auth.getUser();
        const response = await fetch('/.netlify/functions/deputy-sync-rosters', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: user.id, supabase_url: SUPABASE_CONFIG.url, supabase_key: SUPABASE_CONFIG.anonKey })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error);
        rosterData = data.rosters || [];
        if (document.getElementById('lastSyncTime')) document.getElementById('lastSyncTime').textContent = 'Just now';
        if (!document.getElementById('rosterComplianceModal').classList.contains('hidden')) updateRosterDashboard(rosterData);
        showNotification(`âœ… Synced ${data.total} shifts${data.issues ? `. âš ï¸ ${data.issues} issue(s)` : ''}`, data.issues ? 'warning' : 'success');
    } catch (error) {
        showNotification(`âŒ ${error.message}`, 'error');
    }
}

function updateRosterDashboard(rosters) {
    if (!rosters || !rosters.length) { document.getElementById('rosterList').innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">ðŸ“…</div><div class="text-xl text-slate-400">No rosters found</div></div>'; return; }
    const total = rosters.length;
    const compliant = rosters.filter(r => r.compliance.isCompliant).length;
    const cost = rosters.reduce((sum, r) => sum + (r.compliance.totalCost || 0), 0);
    document.getElementById('totalShifts').textContent = total;
    document.getElementById('compliantShifts').textContent = compliant;
    document.getElementById('issueShifts').textContent = total - compliant;
    document.getElementById('totalCost').textContent = `$${cost.toFixed(2)}`;
    document.getElementById('rosterList').innerHTML = rosters.map(r => `<div class="bg-slate-700 rounded-lg p-4 ${r.compliance.warnings.length ? 'border-2 border-red-500' : 'border border-slate-600'}"><div class="flex justify-between mb-3"><div class="flex gap-3"><div class="w-12 h-12 bg-slate-600 rounded-full flex items-center justify-center text-white font-bold">${r.employee.name[0]}</div><div><div class="font-semibold text-white">${r.employee.name}</div><div class="text-sm text-slate-400">${r.position}</div></div></div><div class="text-right"><div class="font-semibold text-white">${r.date}</div><div class="text-sm text-slate-400">${r.startTime}-${r.endTime}</div></div></div>${r.compliance.warnings.length ? `<div class="bg-red-900/30 border border-red-500/30 rounded p-3"><div class="font-semibold text-red-400">âš ï¸ ${r.compliance.warnings.length} Issue(s)</div>${r.compliance.warnings.map(w => `<div class="text-sm text-red-300 mt-1">${w.type}: ${w.message}</div>`).join('')}</div>` : '<div class="bg-green-900/30 border border-green-500/30 rounded p-3 text-green-400">âœ… Compliant</div>'}</div>`).join('');
}

function openRosterCompliance() {
    document.getElementById('rosterComplianceModal').classList.remove('hidden');
    
    // Check if Deputy is connected
    const hasToken = sessionStorage.getItem('deputy_token');
    if (hasToken) {
        // Show connected status
        document.getElementById('lastSyncTime').textContent = 'Just connected';
        
        // Auto-sync if no data
        if (!rosterData || !rosterData.length) {
            syncRosterData();
        } else {
            updateRosterDashboard(rosterData);
        }
    } else {
        showNotification('âš ï¸ Deputy not connected', 'warning');
    }
}

function closeRosterCompliance() {
    document.getElementById('rosterComplianceModal').classList.add('hidden');
}

async function exportRosterReport(format) {
    try {
        showNotification(`ðŸ“„ Generating...`, 'info');
        if (format === 'pdf') {
            pdfMake.createPdf({ content: [{ text: 'Roster Report', fontSize: 18, bold: true }, { text: new Date().toLocaleString('en-AU'), fontSize: 12, margin: [0,0,0,10] }, { table: { headerRows: 1, widths: ['*','*','auto','auto','auto'], body: [['Employee','Date','Hours','Cost','Status'], ...rosterData.map(r => [r.employee.name, r.date, `${r.totalHours}h`, `$${r.compliance.totalCost.toFixed(2)}`, r.compliance.isCompliant?'OK':'Issues'])] } }] }).download(`roster_${Date.now()}.pdf`);
        } else {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rosterData.map(r => ({ Employee:r.employee.name, Date:r.date, Hours:r.totalHours, Cost:r.compliance.totalCost, Status:r.compliance.isCompliant?'OK':'Issues' }))), 'Rosters');
            XLSX.writeFile(wb, `roster_${Date.now()}.xlsx`);
        }
        showNotification('âœ… Downloaded!', 'success');
    } catch (error) { showNotification(`âŒ ${error.message}`, 'error'); }
}

function generateRandomString(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    return Array.from({length}, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
}

// Check for Deputy OAuth callback IMMEDIATELY
if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
    // If we're in the popup window, handle callback and close
    if (window.opener || window.name === 'deputyOAuth') {
        // Hide the main UI in popup
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”„</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Connecting to Deputy...</div>
                    <div style="color: #94a3b8;">Please wait while we complete the connection.</div>
                </div>
            </div>
        `;
        
        // Wait for Supabase to initialize, then handle callback
        const checkAndHandleCallback = setInterval(() => {
            if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                clearInterval(checkAndHandleCallback);
                handleDeputyCallbackInPopup();
            }
        }, 100);
        
        setTimeout(() => {
            clearInterval(checkAndHandleCallback);
            if (typeof supabaseClient === 'undefined' || !supabaseClient) {
                showAlert('Connection timeout. Please try again.');
            }
        }, 10000);
    }
}



// Handle OAuth callback in popup window
async function handleDeputyCallbackInPopup() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (!code) {
            showAlert('âŒ No authorization code received');
            window.close();
            return;
        }
        
        // Verify state
        const savedState = sessionStorage.getItem('deputy_oauth_state');
        if (state !== savedState) {
            showAlert('âŒ Security check failed');
            window.close();
            return;
        }
        
        const userId = sessionStorage.getItem('deputy_oauth_user_id') || 'test-user-' + Date.now();
        
        // Exchange code for token
        const response = await fetch('/.netlify/functions/deputy-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code,
                user_id: userId,
                supabase_url: SUPABASE_CONFIG.url,
                supabase_key: SUPABASE_CONFIG.anonKey
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to connect');
        }
        
        // Notify parent window
        if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ 
                type: 'deputy_oauth_success',
                userId: userId
            }, window.location.origin);
        }
        
        // Clean up and close
        sessionStorage.removeItem('deputy_oauth_state');
        sessionStorage.removeItem('deputy_oauth_user_id');
        
        // Show success message
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #10b981;">Deputy Connected!</div>
                    <div style="color: #94a3b8; margin-bottom: 20px;">This window will close automatically...</div>
                </div>
            </div>
        `;
        
        // Close after 2 seconds
        setTimeout(() => {
            window.close();
        }, 2000);
        
    } catch (error) {
        // Show error message
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #ef4444;">Connection Failed</div>
                    <div style="color: #94a3b8; margin-bottom: 20px;">${error.message}</div>
                    <button onclick="window.close()" style="background: #ef4444; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Close Window</button>
                </div>
            </div>
        `;
        
        if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ 
                type: 'deputy_oauth_error',
                error: error.message
            }, window.location.origin);
        }
    }
}

// Listen for messages from popup window
window.addEventListener('message', (event) => {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'deputy_oauth_success') {
        showNotification('âœ… Deputy connected successfully!', 'success');
        closeDeputyConnection();
        
        // Refresh Integration Hub if open
        if (!document.getElementById('integrationHubModal').classList.contains('hidden')) {
            checkDeputyConnection();
        }
        
        // Auto-open dashboard and sync
        setTimeout(() => {
            openRosterCompliance();
        }, 500);
    }
    
    if (event.data.type === 'deputy_oauth_error') {
        showNotification(`âŒ Connection failed: ${event.data.error}`, 'error');
    }
});


window.addEventListener('DOMContentLoaded', () => {
});




// Open AI Import Modal
let currentImportType = null;
let uploadedAIFileData = null;
let parsedAIData = null;

function openAIImportModal(type) {
    currentImportType = type;
    
    // Hide Integration Hub
    const integrationHub = document.getElementById('integrationHubModal');
    if (integrationHub) {
        integrationHub.classList.add('hidden');
    }
    
    // Show import container (it's already fixed position overlay)
    const importContainer = document.getElementById('importContainer');
    if (!importContainer) {
        showNotification('âŒ Import system not loaded', 'error');
        return;
    }
    
    // Simply set display to block - the fixed positioning handles the rest
    importContainer.style.display = 'block';
    // Reset UI to upload state
    const uploadZone = document.getElementById('uploadZone');
    const aiAnalysis = document.getElementById('aiAnalysis');
    const fileInput = document.getElementById('aiFileInput');
    
    if (uploadZone) {
        uploadZone.style.display = 'block';
    }
    if (aiAnalysis) {
        aiAnalysis.style.display = 'none';
    }
    if (fileInput) {
        fileInput.value = '';
    }
    
    // Update title based on type
    const titles = {
        'deputy': 'Deputy Rosters',
        'xero': 'Xero Payroll Data',
        'employee': 'Employee Data',
        'timesheet': 'Timesheet Data'
    };
    
    const headerTitle = document.querySelector('.import-container .header h1');
    if (headerTitle) {
        headerTitle.textContent = `AI-Powered Import: ${titles[type] || 'Upload Data'}`;
    }
    
    // Setup file upload listeners
    setupAIFileUpload();
    
}


function closeAIImport() {
    // Hide import container
    const importContainer = document.getElementById('importContainer');
    if (importContainer) {
        importContainer.style.display = 'none';
    }
    
    // Show Integration Hub again
    const integrationHub = document.getElementById('integrationHubModal');
    if (integrationHub) {
        integrationHub.classList.remove('hidden');
    }
    
    // Reset
    resetAIImport();
}

function setupAIFileUpload() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('aiFileInput');
    
    if (!uploadZone || !fileInput) return;
    
    // Remove old listeners
    uploadZone.replaceWith(uploadZone.cloneNode(true));
    const newUploadZone = document.getElementById('uploadZone');
    
    // Click to browse
    newUploadZone.addEventListener('click', () => fileInput.click());
    
    // Drag and drop
    newUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        newUploadZone.style.borderColor = '#00f0ff';
    });
    
    newUploadZone.addEventListener('dragleave', () => {
        newUploadZone.style.borderColor = 'rgba(0, 240, 255, 0.3)';
    });
    
    newUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        newUploadZone.style.borderColor = 'rgba(0, 240, 255, 0.3)';
        const files = e.dataTransfer.files;
        if (files.length > 0) processAIFile(files[0]);
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processAIFile(e.target.files[0]);
    });
}

async function processAIFile(file) {
    showNotification('ðŸ“„ Processing file...', 'info');
    
    // Show processing overlay
    document.getElementById('aiProcessingOverlay').style.display = 'flex';
    
    try {
        // Simulate AI processing (replace with actual backend call)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Mock data - replace with real parsed data from backend
        const mockData = {
            totalRows: 47,
            totalEmployees: 12,
            totalHours: 376,
            estimatedCost: 9400,
            issues: [
                {
                    type: 'warning',
                    title: '3 shifts under minimum 3-hour engagement',
                    description: 'Modern Award requires minimum 3-hour shifts. Found shifts of 2h, 2.5h, and 2h.'
                },
                {
                    type: 'warning',
                    title: '5 Sunday shifts without 175% penalty rate',
                    description: 'Sunday work requires 175% penalty rate under Restaurant Award.'
                },
                {
                    type: 'success',
                    title: 'All break times compliant',
                    description: '100% of shifts have appropriate break allocation.'
                }
            ],
            preview: [
                ['John Smith', '2026-02-01', '09:00', '17:00', 'Manager', '8h'],
                ['Jane Doe', '2026-02-01', '10:00', '18:00', 'Staff', '8h'],
                ['Bob Wilson', '2026-02-02', '14:00', '22:00', 'Staff', '8h'],
                ['Alice Brown', '2026-02-02', '09:00', '15:00', 'Staff', '6h'],
                ['Charlie Davis', '2026-02-03', '11:00', '19:00', 'Staff', '8h']
            ]
        };
        
        displayAIAnalysis(mockData);
        showNotification('âœ… File analyzed successfully!', 'success');
        
    } catch (error) {
        showNotification(`âŒ ${error.message}`, 'error');
    } finally {
        document.getElementById('aiProcessingOverlay').style.display = 'none';
    }
}

function displayAIAnalysis(data) {
    // Hide upload, show analysis
    document.getElementById('uploadZone').style.display = 'none';
    document.getElementById('aiAnalysis').style.display = 'block';
    
    // Animate counters
    animateAICounter('aiTotalRows', data.totalRows);
    animateAICounter('aiTotalEmployees', data.totalEmployees);
    animateAICounter('aiTotalHours', data.totalHours, 'h');
    animateAICounter('aiEstimatedCost', data.estimatedCost, '$', true);
    
    // Display issues
    const issuesSection = document.getElementById('aiIssuesSection');
    issuesSection.innerHTML = data.issues.map(issue => `
        <div style="background: ${issue.type === 'success' ? 'rgba(0, 255, 157, 0.1)' : 'rgba(255, 107, 53, 0.1)'}; border-left: 4px solid ${issue.type === 'success' ? '#00ff9d' : '#ff6b35'}; border-radius: 12px; padding: 20px; margin-bottom: 16px; display: flex; align-items: start; gap: 16px;">
            <div style="font-size: 1.5rem;">${issue.type === 'success' ? 'âœ…' : 'âš ï¸'}</div>
            <div>
                <h4 style="margin-bottom: 4px; color: ${issue.type === 'success' ? '#00ff9d' : '#ff6b35'};">${issue.title}</h4>
                <p style="color: #8b9dc3; font-size: 0.875rem;">${issue.description}</p>
            </div>
        </div>
    `).join('');
    
    // Display preview table
    document.getElementById('aiTableHead').innerHTML = '<tr><th style="padding: 16px; text-align: left;">Employee</th><th style="padding: 16px; text-align: left;">Date</th><th style="padding: 16px; text-align: left;">Start</th><th style="padding: 16px; text-align: left;">End</th><th style="padding: 16px; text-align: left;">Position</th><th style="padding: 16px; text-align: left;">Hours</th></tr>';
    
    document.getElementById('aiTableBody').innerHTML = data.preview.map(row => `
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
            ${row.map(cell => `<td style="padding: 16px; font-family: monospace; font-size: 0.875rem;">${cell}</td>`).join('')}
        </tr>
    `).join('');
}

function animateAICounter(id, target, suffix = '', isPrice = false) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const duration = 1000;
    const steps = 60;
    const increment = target / steps;
    let current = 0;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        
        let value = Math.floor(current);
        if (isPrice) {
            value = `${suffix}${value.toLocaleString()}`;
        } else {
            value = `${value}${suffix}`;
        }
        element.textContent = value;
    }, duration / steps);
}

function aiImportData() {
    showNotification('ðŸŽ‰ Data imported successfully! Opening compliance dashboard...', 'success');
    
    // Close import container
    document.getElementById('importContainer').style.display = 'none';
    
    // Open roster compliance dashboard with imported data
    openRosterCompliance();
}

function resetAIImport() {
    document.getElementById('uploadZone').style.display = 'block';
    document.getElementById('aiAnalysis').style.display = 'none';
    document.getElementById('aiFileInput').value = '';
    uploadedAIFileData = null;
    parsedAIData = null;
}

</script>


<!-- Profile Modal -->
<div id="profileMenu" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50" onclick="if(event.target === this) closeProfileMenu();">
    <div class="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-amber-500 fade-in">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-amber-500">Profile</h2>
            <button onclick="closeProfileMenu()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>
        
        <!-- Venue Info -->
        <div class="mb-4 p-4 bg-slate-700/50 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ðŸ¨</span>
                </div>
                <div>
                    <div class="font-semibold text-white" id="profileVenueName">Loading...</div>
                    <div class="text-xs text-slate-400" id="profileUserCode">Code: ...</div>
                </div>
            </div>
        </div>
        
        <div class="space-y-2">
            <button onclick="showVenueSettings(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">âš™ï¸</span>
                <div>
                    <div class="font-semibold">Settings</div>
                    <div class="text-xs text-slate-400">Update venue information</div>
                </div>
            </button>
            
            <button onclick="toggleDarkMode(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">ðŸŒ™</span>
                <div>
                    <div class="font-semibold">Dark Mode</div>
                    <div class="text-xs text-slate-400">Toggle light/dark theme</div>
                </div>
            </button>
            
            <button onclick="showFeedback(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">ðŸ“</span>
                <div>
                    <div class="font-semibold">Give Feedback</div>
                    <div class="text-xs text-slate-400">Help us improve</div>
                </div>
            </button>
            
            <div class="border-t border-slate-700 my-2"></div>
            
            <button onclick="showTermsOfService(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">ðŸ“„</span>
                <div>
                    <div class="font-semibold">Terms of Service</div>
                    <div class="text-xs text-slate-400">View legal terms</div>
                </div>
            </button>
            
            <button onclick="showPrivacyPolicy(); closeProfileMenu();" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3 transition-colors">
                <span class="text-xl">ðŸ”’</span>
                <div>
                    <div class="font-semibold">Privacy Policy</div>
                    <div class="text-xs text-slate-400">How we protect your data</div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Tools Modal - Same Structure as Settings Modal -->
<div id="toolsMenu" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 overflow-y-auto">
    <div id="toolsMenuInner" class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in md:max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ› ï¸</span> Tools
                </h2>
                <p class="text-slate-400 text-sm">Choose a tool to help with your HR tasks</p>
            </div>
            <button onclick="closeToolsMenu()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Tools Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="openDocumentBuilder(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ“</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Document Builder</div>
                        <div class="text-sm text-slate-400">Create professional HR documents</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openNewEmployeeToolkit(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸŒŸ</span>
                    <div>
                        <div class="font-semibold text-white mb-1">New Employee Toolkit</div>
                        <div class="text-sm text-slate-400">Create Fair Work compliant employment contracts</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openAwardCalculator(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ’°</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Award Calculator</div>
                        <div class="text-sm text-slate-400">Calculate award rates & penalties</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openScenarioAnalysis(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸŽ¯</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Scenario Analysis</div>
                        <div class="text-sm text-slate-400">Analyze complex HR scenarios</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openRosterStressTester(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ’¥</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Roster Stress Test</div>
                        <div class="text-sm text-slate-400">Check roster compliance</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openAwardWizard(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ§™</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Award Wizard</div>
                        <div class="text-sm text-slate-400">Find the right award</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openComplianceCalendar(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ“†</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Compliance Calendar</div>
                        <div class="text-sm text-slate-400">Track important dates</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openTerminationRisk(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">âš ï¸</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Termination Risk</div>
                        <div class="text-sm text-slate-400">Assess termination risks</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openRecruitmentToolkit(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ”</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Recruitment Toolkit</div>
                        <div class="text-sm text-slate-400">Job descriptions, interviews & reference checks</div>
                    </div>
                </div>
            </button>
            
            <button onclick="openIntegrationHub(); closeToolsMenu();" class="text-left p-5 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">ðŸ”—</span>
                    <div>
                        <div class="font-semibold text-white mb-1">Integrations</div>
                        <div class="text-sm text-slate-400">Connect Deputy, Xero & more</div>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Reference Check Form Modal -->
<div id="referenceCheckModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“‹</span> Reference Check Form
                </h2>
                <p class="text-slate-400 text-sm">Complete the form to generate a professional reference check document</p>
            </div>
            <button onclick="closeReferenceCheck()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div class="space-y-6">
            <!-- Candidate Information -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Candidate Information</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Candidate Name *</label>
                        <input type="text" id="rcCandidateName" placeholder="Full name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Position Applied For *</label>
                        <input type="text" id="rcPosition" placeholder="e.g., Head Chef" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Referee Information -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Referee Information</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Referee Name *</label>
                        <input type="text" id="rcRefereeName" placeholder="Full name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Relationship to Candidate *</label>
                        <input type="text" id="rcRelationship" placeholder="e.g., Direct Manager" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Company/Organization *</label>
                        <input type="text" id="rcCompany" placeholder="Company name" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Contact Phone</label>
                        <input type="tel" id="rcPhone" placeholder="Phone number" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Employment Period -->
            <div class="bg-slate-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-4">Employment Period</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Start Date</label>
                        <input type="text" id="rcStartDate" placeholder="MM/YYYY" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">End Date</label>
                        <input type="text" id="rcEndDate" placeholder="MM/YYYY or 'Present'" 
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <p class="text-blue-400 text-sm">
                    ðŸ“‹ The generated form will include:
                </p>
                <ul class="text-slate-400 text-sm mt-2 space-y-1 ml-4">
                    <li>â€¢ Standard reference check questions</li>
                    <li>â€¢ Performance rating scales</li>
                    <li>â€¢ Red flag indicators</li>
                    <li>â€¢ Legal compliance notes</li>
                    <li>â€¢ Signature and date fields</li>
                </ul>
            </div>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="generateReferenceCheck()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                âœ¨ Generate Reference Check Form
            </button>
        </div>
    </div>
</div>

<!-- Reference Check Preview Modal -->
<div id="referenceCheckPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">ðŸ“‹ Reference Check Form</h2>
            <button onclick="closeReferenceCheckPreview()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div id="rcPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6">
            <!-- Content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadReferenceCheck('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                ðŸ“• Download PDF
            </button>
            <button onclick="closeReferenceCheckPreview(); openReferenceCheckForm();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                â† Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Interview Questions Generator Modal -->
<div id="interviewQuestionsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ’¬</span> Interview Questions Generator
                </h2>
                <p class="text-slate-400 text-sm">Step <span id="iqStep">1</span> of 4</p>
            </div>
            <button onclick="closeInterviewQuestions()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Loading Screen -->
        <div id="iqGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ðŸ¤–</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your interview questions...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>

        <!-- Steps Container -->
        <div id="iqBuilderSteps">
        <!-- Step 1: Job Title -->
        <div id="iqStep1" class="step-content">
            <h3 class="text-xl font-semibold text-white mb-4">What position are you interviewing for?</h3>
            <input type="text" id="iqJobTitle" placeholder="e.g., Head Chef, Restaurant Manager" 
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
        </div>

        <!-- Step 2: Experience Level -->
        <div id="iqStep2" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Experience level required?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="selectIQExperience('entry')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Entry Level</div>
                    <div class="text-sm text-slate-400">0-2 years experience</div>
                </button>
                <button onclick="selectIQExperience('mid')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Mid Level</div>
                    <div class="text-sm text-slate-400">2-5 years experience</div>
                </button>
                <button onclick="selectIQExperience('senior')" class="iq-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Senior Level</div>
                    <div class="text-sm text-slate-400">5+ years experience</div>
                </button>
            </div>
        </div>

        <!-- Step 3: Question Categories -->
        <div id="iqStep3" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Select question categories</h3>
            <p class="text-slate-400 text-sm mb-4">ðŸ’¡ AI recommends including all three for a comprehensive interview</p>
            <div class="space-y-3">
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqTechnical" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Technical Questions</div>
                        <div class="text-sm text-slate-400">Role-specific skills and knowledge</div>
                    </div>
                </label>
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqBehavioral" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Behavioral Questions</div>
                        <div class="text-sm text-slate-400">Past experiences and decision-making (STAR method)</div>
                    </div>
                </label>
                <label class="flex items-start gap-3 p-4 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-all">
                    <input type="checkbox" id="iqSituational" checked class="mt-1 w-5 h-5 text-amber-500 rounded">
                    <div>
                        <div class="font-semibold text-white">Situational Questions</div>
                        <div class="text-sm text-slate-400">Hypothetical scenarios and problem-solving</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Step 4: Number of Questions -->
        <div id="iqStep4" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">How many questions do you need?</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="selectIQCount(10)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all text-center">
                    <div class="text-3xl font-bold text-white">10</div>
                    <div class="text-sm text-slate-400 mt-1">Quick interview</div>
                </button>
                <button onclick="selectIQCount(15)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-amber-500 transition-all text-center">
                    <div class="text-3xl font-bold text-white">15</div>
                    <div class="text-sm text-slate-400 mt-1">Recommended</div>
                </button>
                <button onclick="selectIQCount(20)" class="iq-count-btn p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all text-center">
                    <div class="text-3xl font-bold text-white">20</div>
                    <div class="text-sm text-slate-400 mt-1">Comprehensive</div>
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 space-y-3">
            <button onclick="iqNextStep()" id="iqNextBtn" class="w-full px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors">
                Next Step â†’
            </button>
            <button onclick="generateInterviewQuestions()" id="iqGenerateBtn" class="hidden w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                âœ¨ Generate Questions
            </button>
            <button onclick="iqPreviousStep()" id="iqBackBtn" class="hidden w-full px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                â† Back
            </button>
        </div>
        </div><!-- End iqBuilderSteps -->

    </div>
</div>

<!-- Interview Questions Preview Modal -->
<div id="interviewQuestionsPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">ðŸ’¬ Interview Questions</h2>
            <button onclick="closeInterviewQuestionsPreview()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div id="iqPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6">
            <!-- AI-generated content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadInterviewQuestions('docx')" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                ðŸ“„ Download DOCX
            </button>
            <button onclick="downloadInterviewQuestions('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                ðŸ“• Download PDF
            </button>
        </div>
        
        <div class="flex gap-3 mt-3">
            <button onclick="resetInterviewQuestions()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                âž• Create New Interview Questions
            </button>
            <button onclick="closeInterviewQuestionsPreview(); openInterviewQuestionsGenerator();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                â† Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Job Description Builder Modal -->
<div id="jobDescriptionBuilderModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“</span> Job Description Builder
                </h2>
                <p class="text-slate-400 text-sm">Step <span id="jdStep">1</span> of 4</p>
            </div>
            <button onclick="closeJobDescriptionBuilder()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Loading Screen -->
        <div id="jdGenerating" class="hidden text-center py-12">
            <div class="text-6xl mb-4 animate-bounce">ðŸ¤–</div>
            <h3 class="text-amber-400 font-bold text-xl mb-2">Fitz is generating your job description...</h3>
            <p class="text-slate-400 text-sm">This may take 10-20 seconds</p>
            <div class="mt-6 flex justify-center gap-2">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>

        <!-- Steps Container -->
        <div id="jdBuilderSteps">
        <!-- Step 1: Job Title -->
        <div id="jdStep1" class="step-content">
            <h3 class="text-xl font-semibold text-white mb-4">What's the job title?</h3>
            <input type="text" id="jdJobTitle" placeholder="e.g., Head Chef, Restaurant Manager, Bartender" 
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
            <p class="text-slate-400 text-sm mt-2">ðŸ’¡ Be specific - AI will tailor the description to this role</p>
        </div>

        <!-- Step 2: Experience Level -->
        <div id="jdStep2" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">What experience level are you looking for?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="selectJDExperience('entry')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Entry Level (0-2 years)</div>
                    <div class="text-sm text-slate-400 mt-1">Junior positions, minimal experience required</div>
                </button>
                <button onclick="selectJDExperience('mid')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Mid Level (2-5 years)</div>
                    <div class="text-sm text-slate-400 mt-1">Experienced professionals with proven track record</div>
                </button>
                <button onclick="selectJDExperience('senior')" class="jd-experience-btn text-left p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border-2 border-slate-600 transition-all">
                    <div class="font-semibold text-white">Senior Level (5+ years)</div>
                    <div class="text-sm text-slate-400 mt-1">Leadership roles, extensive experience required</div>
                </button>
            </div>
        </div>

        <!-- Step 3: AI-Suggested Key Responsibilities -->
        <div id="jdStep3" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Review & Edit Key Responsibilities</h3>
            <p class="text-slate-400 text-sm mb-4">AI has suggested these responsibilities. Edit as needed:</p>
            <div id="jdResponsibilitiesLoading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
                <p class="text-slate-400 mt-4">AI is generating key responsibilities...</p>
            </div>
            <textarea id="jdResponsibilities" class="hidden w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500" rows="8"></textarea>
            <p class="text-slate-400 text-sm mt-2 hidden" id="jdResponsibilitiesHelp">âœï¸ Edit, add, or remove responsibilities as needed</p>
        </div>

        <!-- Step 4: Qualifications -->
        <div id="jdStep4" class="step-content hidden">
            <h3 class="text-xl font-semibold text-white mb-4">Required Qualifications</h3>
            <p class="text-slate-400 text-sm mb-4">What qualifications are required?</p>
            <textarea id="jdQualifications" placeholder="e.g.,&#10;- Certificate III in Commercial Cookery&#10;- Current RSA certificate&#10;- Food safety certification" 
                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500" rows="6"></textarea>
            <p class="text-slate-400 text-sm mt-2">ðŸ’¡ List essential qualifications, certifications, and licenses</p>
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-6 space-y-3">
            <button onclick="jdNextStep()" id="jdNextBtn" class="w-full px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors">
                Next Step â†’
            </button>
            <button onclick="generateJobDescription()" id="jdGenerateBtn" class="hidden w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                âœ¨ Generate Job Description
            </button>
            <button onclick="jdPreviousStep()" id="jdBackBtn" class="hidden w-full px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                â† Back
            </button>
        </div>
        </div><!-- End jdBuilderSteps -->

    </div>
</div>

<!-- Job Description Preview Modal -->
<div id="jobDescriptionPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-amber-500">ðŸ“ Your Job Description</h2>
            <button onclick="closeJobDescriptionPreview()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <div id="jdPreviewContent" class="bg-slate-900 rounded-lg p-6 mb-6 prose prose-invert max-w-none">
            <!-- AI-generated content will appear here -->
        </div>

        <div class="flex gap-3">
            <button onclick="downloadJobDescription('docx')" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                ðŸ“„ Download DOCX
            </button>
            <button onclick="downloadJobDescription('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                ðŸ“• Download PDF
            </button>
        </div>
        
        <div class="flex gap-3 mt-3">
            <button onclick="resetJobDescription()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                âž• Create New Job Description
            </button>
            <button onclick="closeJobDescriptionPreview(); openJobDescriptionBuilder();" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                â† Back to Edit
            </button>
        </div>
    </div>
</div>

<!-- Recruitment Toolkit Modal -->
<div id="recruitmentToolkitModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ”</span> Recruitment Toolkit
                </h2>
                <p class="text-slate-400 text-sm">Choose a recruitment tool to help with hiring</p>
            </div>
            <button onclick="closeRecruitmentToolkit()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Sub-tools Grid -->
        <div class="grid grid-cols-1 gap-4">
            <button onclick="openJobDescriptionBuilder(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ“</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Job Description Builder</div>
                        <div class="text-sm text-slate-400 mb-3">Create professional job descriptions with AI-powered content, award-based salary ranges, and downloadable formats</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Award Integration</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
            
            <button onclick="openInterviewQuestionsGenerator(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ’¬</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Interview Questions Generator</div>
                        <div class="text-sm text-slate-400 mb-3">Generate customized interview questions with STAR method examples, red flags, and what to look for in answers</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">STAR Method</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
            
            <button onclick="openReferenceCheckForm(); closeRecruitmentToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ“‹</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Reference Check Form</div>
                        <div class="text-sm text-slate-400 mb-3">Professional reference check form with standard questions, rating scales, and compliance notes</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Pre-filled</span>
                            <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">Red Flags</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">PDF</span>
                        </div>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>




<!-- ========================================
     INTEGRATION HUB MODAL
     ======================================== -->

<div id="integrationHubModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                    <span class="text-3xl">ðŸ”—</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">Integration Hub</h2>
                    <p class="text-slate-400 text-sm">Import your data from Deputy, Xero, and more</p>
                </div>
            </div>
            <button onclick="closeIntegrationHub()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>



        <!-- Integration Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Deputy Card -->
            <div class="bg-slate-700 rounded-xl p-6 border border-slate-600 hover:border-blue-500 transition-colors">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">ðŸ“…</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">Deputy</h3>
                            <p class="text-sm text-slate-400">Rosters & Timesheets</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-semibold rounded-full">BASIC</span>
                </div>
                
                <ul class="space-y-2 mb-4 text-sm text-slate-300">
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Import roster CSV/Excel
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        AI compliance check
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Export to Excel/PDF
                    </li>
                </ul>
                
                <button onclick="openAIImportModal('deputy')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors text-sm">
                    ðŸ“¥ Import Data
                </button>
            </div>

            <!-- Xero Card -->
            <div class="bg-slate-700 rounded-xl p-6 border border-slate-600 hover:border-green-500 transition-colors">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">ðŸ’°</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">Xero</h3>
                            <p class="text-sm text-slate-400">Payroll & Employees</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-green-500/20 text-green-400 text-xs font-semibold rounded-full">BASIC</span>
                </div>
                
                <ul class="space-y-2 mb-4 text-sm text-slate-300">
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Import employee data
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Import payroll exports
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Match with rosters
                    </li>
                </ul>
                
                <button onclick="openAIImportModal('xero')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors text-sm">
                    ðŸ“¥ Import Data
                </button>
            </div>

            <!-- Square POS Card -->
            <div class="bg-slate-700 rounded-xl p-6 border border-slate-600 opacity-60">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gray-600 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">ðŸ’³</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">Square POS</h3>
                            <p class="text-sm text-slate-400">Sales & Inventory</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-gray-500/20 text-gray-400 text-xs font-semibold rounded-full">COMING SOON</span>
                </div>
                
                <ul class="space-y-2 mb-4 text-sm text-slate-400">
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Sales data sync
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Labor cost analysis
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Revenue forecasting
                    </li>
                </ul>
                
                <button disabled class="w-full px-4 py-2 bg-slate-600 text-slate-400 font-semibold rounded-lg cursor-not-allowed text-sm">
                    Coming Soon
                </button>
            </div>

            <!-- Employment Hero Card -->
            <div class="bg-slate-700 rounded-xl p-6 border border-slate-600 opacity-60">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">ðŸ¢</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">Employment Hero</h3>
                            <p class="text-sm text-slate-400">HR & Payroll</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-gray-500/20 text-gray-400 text-xs font-semibold rounded-full">COMING SOON</span>
                </div>
                
                <ul class="space-y-2 mb-4 text-sm text-slate-400">
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Employee onboarding
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Leave management
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Payroll processing
                    </li>
                </ul>
                
                <button disabled class="w-full px-4 py-2 bg-slate-600 text-slate-400 font-semibold rounded-lg cursor-not-allowed text-sm">
                    Coming Soon
                </button>
            </div>
        </div>

        <!-- How to Export Instructions -->
        <div class="mt-8 bg-slate-700/50 rounded-xl p-6 border border-slate-600">
            <h3 class="text-lg font-semibold text-white mb-4">ðŸ“– How to Export Your Data</h3>
            
            <div class="space-y-6">
                <!-- Deputy Instructions -->
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ“…</span>
                        <h4 class="font-semibold text-amber-500">From Deputy</h4>
                    </div>
                    <ol class="text-sm text-slate-300 space-y-1 ml-7 list-decimal">
                        <li>Log into Deputy â†’ Click <strong>Rosters</strong></li>
                        <li>Select your date range (e.g., next 30 days)</li>
                        <li>Click <strong>Export</strong> â†’ Choose <strong>Excel</strong> or <strong>CSV</strong></li>
                        <li>Save the file, then upload it here using <strong>Import Data</strong></li>
                    </ol>
                </div>

                <!-- Xero Instructions -->
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ’°</span>
                        <h4 class="font-semibold text-green-500">From Xero</h4>
                    </div>
                    <ol class="text-sm text-slate-300 space-y-1 ml-7 list-decimal">
                        <li>Log into Xero â†’ Go to <strong>Payroll</strong> â†’ <strong>Employees</strong></li>
                        <li>Click <strong>Export to Excel</strong> at the top right</li>
                        <li>For payroll data: Go to <strong>Pay Runs</strong> â†’ Select period â†’ <strong>Export</strong></li>
                        <li>Save the file, then upload it here using <strong>Import Data</strong></li>
                    </ol>
                </div>

                <!-- Generic CSV -->
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ“Š</span>
                        <h4 class="font-semibold text-blue-500">From Other Systems (MYOB, QuickBooks, etc.)</h4>
                    </div>
                    <p class="text-sm text-slate-300 ml-7">
                        Export your roster or employee data as <strong>CSV</strong> or <strong>Excel</strong> format. 
                        Our AI will automatically detect the columns and map your data correctly.
                    </p>
                </div>

                <!-- Help -->
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <span class="text-xl">ðŸ’¡</span>
                        <div>
                            <div class="font-semibold text-blue-400 mb-1">Pro Tip</div>
                            <p class="text-sm text-slate-300">
                                Include these columns for best results: Employee Name, Date, Start Time, End Time, Position, Hours. 
                                Our AI is smart enough to handle different column names and formats!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Roster Compliance Dashboard Modal -->
<div id="rosterComplianceModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500">ðŸ“Š Roster Compliance Dashboard</h2>
                <p class="text-slate-400 text-sm">Deputy rosters analyzed for Australian Modern Award compliance</p>
            </div>
            <button onclick="closeRosterCompliance()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Sync Status Bar -->
        <div class="bg-slate-900 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <div>
                        <div class="font-semibold text-white">Connected to Deputy</div>
                        <div class="text-sm text-slate-400">Last synced: <span id="lastSyncTime">Never</span></div>
                    </div>
                </div>
                <button onclick="syncRosterData()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Sync Now
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-700 rounded-lg p-4">
                <div class="text-slate-400 text-sm mb-1">Total Shifts</div>
                <div class="text-3xl font-bold text-white" id="totalShifts">0</div>
            </div>
            <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-4">
                <div class="text-green-400 text-sm mb-1">âœ… Compliant</div>
                <div class="text-3xl font-bold text-green-500" id="compliantShifts">0</div>
            </div>
            <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-4">
                <div class="text-red-400 text-sm mb-1">âš ï¸ Issues Found</div>
                <div class="text-3xl font-bold text-red-500" id="issueShifts">0</div>
            </div>
            <div class="bg-amber-900/30 border border-amber-500/30 rounded-lg p-4">
                <div class="text-amber-400 text-sm mb-1">ðŸ’° Total Cost</div>
                <div class="text-3xl font-bold text-amber-500" id="totalCost">$0</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex gap-3 mb-4">
            <select id="filterPeriod" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                <option>Next 7 Days</option>
                <option>Next 14 Days</option>
                <option selected>Next 30 Days</option>
            </select>
            <select id="filterStatus" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                <option value="all">All Shifts</option>
                <option value="compliant">âœ… Compliant Only</option>
                <option value="issues">âš ï¸ Issues Only</option>
            </select>
            <input type="text" id="searchEmployee" placeholder="Search employee..." class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500">
        </div>

        <!-- Roster List -->
        <div id="rosterList" class="space-y-3 mb-6">
            <!-- Roster cards will be inserted here dynamically -->
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ðŸ“…</div>
                <div class="text-xl text-slate-400">Loading rosters...</div>
                <div class="text-sm text-slate-500 mt-2">Please wait while we sync your Deputy data</div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="flex gap-3">
            <button onclick="exportRosterReport('pdf')" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"/>
                </svg>
                Export PDF
            </button>
            <button onclick="exportRosterReport('excel')" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
                Export Excel
            </button>
        </div>
    </div>
</div>

    </div>
</button>





<!-- ========================================
     AI-POWERED IMPORT SYSTEM
     ======================================== -->
<div class="import-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #0a0e27; overflow-y: auto; z-index: 9999; padding: 40px 20px;" id="importContainer">
    <!-- Header -->
    <div class="header" style="text-align: center; margin-bottom: 60px; position: relative;">
        <button onclick="closeAIImport()" style="position: absolute; top: 20px; right: 40px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Ã—</button>
        <h1 style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 16px;">AI-Powered Data Import</h1>
        <p style="font-size: 1.25rem; color: #8b9dc3;">Drop your data and watch AI work its magic âœ¨</p>
        <span class="ai-badge" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 100px; color: #00f0ff; font-size: 0.875rem; font-weight: 600; margin-top: 20px;">
            <span>ðŸ¤–</span>
            <span>Powered by Advanced AI</span>
        </span>
    </div>

    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone" style="background: #141b3d; border: 2px dashed rgba(0, 240, 255, 0.3); border-radius: 24px; padding: 80px 40px; text-align: center; cursor: pointer; position: relative; overflow: hidden; margin-bottom: 60px;">
        <div style="font-size: 6rem; margin-bottom: 24px; display: inline-block;">ðŸ“Š</div>
        <h3 style="font-size: 1.75rem; margin-bottom: 12px; font-weight: 700; color: white;">Drop Your Data Here</h3>
        <p style="color: #8b9dc3; font-size: 1.125rem; margin-bottom: 32px;">Or click to browse your files</p>
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <span style="padding: 8px 16px; background: rgba(0, 240, 255, 0.1); border-radius: 8px; font-size: 0.875rem; font-family: monospace; color: #00f0ff;">.CSV</span>
            <span style="padding: 8px 16px; background: rgba(0, 240, 255, 0.1); border-radius: 8px; font-size: 0.875rem; font-family: monospace; color: #00f0ff;">.XLSX</span>
            <span style="padding: 8px 16px; background: rgba(0, 240, 255, 0.1); border-radius: 8px; font-size: 0.875rem; font-family: monospace; color: #00f0ff;">.XLS</span>
        </div>
        <input type="file" id="aiFileInput" accept=".csv,.xlsx,.xls" style="display: none;">
    </div>

    <!-- AI Analysis Section -->
    <div class="ai-analysis" id="aiAnalysis" style="margin-top: 60px; display: none;">
        <!-- Insights Overview -->
        <div class="analysis-card" style="background: #141b3d; border-radius: 24px; padding: 40px; margin-bottom: 24px; border: 1px solid rgba(0, 240, 255, 0.2); position: relative;">
            <div class="analysis-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;">ðŸ§ </div>
                <div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 4px; color: white;">AI Analysis Complete</h3>
                    <p style="color: #8b9dc3; font-size: 0.875rem;">Processed in 1.2 seconds</p>
                </div>
            </div>

            <div class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
                <div class="insight-card" style="background: rgba(0, 240, 255, 0.05); border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 16px; padding: 24px;">
                    <div class="insight-value" id="aiTotalRows" style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; font-family: monospace;">0</div>
                    <div style="color: #8b9dc3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px;">Total Records</div>
                </div>
                <div class="insight-card" style="background: rgba(0, 240, 255, 0.05); border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 16px; padding: 24px;">
                    <div class="insight-value" id="aiTotalEmployees" style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; font-family: monospace;">0</div>
                    <div style="color: #8b9dc3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px;">Employees Found</div>
                </div>
                <div class="insight-card" style="background: rgba(0, 240, 255, 0.05); border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 16px; padding: 24px;">
                    <div class="insight-value" id="aiTotalHours" style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; font-family: monospace;">0h</div>
                    <div style="color: #8b9dc3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px;">Total Hours</div>
                </div>
                <div class="insight-card" style="background: rgba(0, 240, 255, 0.05); border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 16px; padding: 24px;">
                    <div class="insight-value" id="aiEstimatedCost" style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #00f0ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; font-family: monospace;">$0</div>
                    <div style="color: #8b9dc3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px;">Estimated Cost</div>
                </div>
            </div>
        </div>

        <!-- AI-Detected Issues -->
        <div class="analysis-card" style="background: #141b3d; border-radius: 24px; padding: 40px; margin-bottom: 24px; border: 1px solid rgba(0, 240, 255, 0.2);">
            <div class="analysis-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;">âš ï¸</div>
                <div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 4px; color: white;">Compliance Issues Detected</h3>
                    <p style="color: #8b9dc3; font-size: 0.875rem;">AI found potential violations</p>
                </div>
            </div>

            <div class="issues-section" id="aiIssuesSection">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Data Preview -->
        <div class="analysis-card" style="background: #141b3d; border-radius: 24px; padding: 40px; margin-bottom: 24px; border: 1px solid rgba(0, 240, 255, 0.2);">
            <div class="analysis-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;">ðŸ“‹</div>
                <div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 4px; color: white;">Data Preview</h3>
                    <p style="color: #8b9dc3; font-size: 0.875rem;">First 10 records</p>
                </div>
            </div>

            <div class="data-preview" style="overflow: hidden; border-radius: 16px; border: 1px solid rgba(0, 240, 255, 0.2);">
                <table id="aiPreviewTable" style="width: 100%; border-collapse: collapse;">
                    <thead id="aiTableHead" style="background: rgba(0, 240, 255, 0.1);">
                        <!-- Dynamically populated -->
                    </thead>
                    <tbody id="aiTableBody" style="color: #8b9dc3;">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 16px; margin-top: 40px;">
            <button onclick="aiImportData()" style="flex: 2; padding: 20px 40px; border-radius: 16px; font-size: 1.125rem; font-weight: 600; border: none; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 15px 50px rgba(102, 126, 234, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 40px rgba(102, 126, 234, 0.4)'">
                <span>âœ…</span>
                <span>Import & Analyze</span>
            </button>
            <button onclick="resetAIImport()" style="flex: 1; padding: 20px 40px; border-radius: 16px; font-size: 1.125rem; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; background: rgba(255, 255, 255, 0.05); color: white; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                <span>ðŸ”„</span>
                <span>Try Another</span>
            </button>
            <button onclick="closeAIImport()" style="flex: 1; padding: 20px 40px; border-radius: 16px; font-size: 1.125rem; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; background: rgba(255, 255, 255, 0.05); color: white; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                <span>â†</span>
                <span>Back</span>
            </button>
        </div>
    </div>
</div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="aiProcessingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 39, 0.95); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px);">
    <div style="text-align: center;">
        <div class="spinner" style="width: 80px; height: 80px; border: 4px solid rgba(0, 240, 255, 0.1); border-top: 4px solid #00f0ff; border-radius: 50%; margin: 0 auto 32px; animation: spin 1s linear infinite;"></div>
        <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 12px; color: white;">AI is analyzing your data...</div>
        <div style="color: #8b9dc3;">Checking compliance, calculating costs, detecting patterns</div>
    </div>
</div>


<!-- ========================================== -->
<!-- EMPLOYMENT CONTRACT BUILDER                -->
<!-- ========================================== -->
<!-- New Employee Toolkit Modal -->
<div id="newEmployeeToolkitModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸŒŸ</span> New Employee Toolkit
                </h2>
                <p class="text-slate-400 text-sm">Everything you need to onboard new employees compliantly</p>
            </div>
            <button onclick="closeNewEmployeeToolkit()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Sub-tools Grid -->
        <div class="grid grid-cols-1 gap-4">
            <button onclick="openEmploymentContractBuilder(); closeNewEmployeeToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ“</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Employment Contract Builder</div>
                        <div class="text-sm text-slate-400 mb-3">Create Fair Work compliant employment contracts with guided 9-step wizard covering all legal requirements</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded">Fair Work Compliant</span>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Award Integration</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
            
            <!-- Future tools can be added here -->
            
            <button onclick="openOnboardingChecklist(); closeNewEmployeeToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ“‹</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">AI-Enhanced Onboarding Checklist</div>
                        <div class="text-sm text-slate-400 mb-3">Smart, adaptive checklist that guides you through every onboarding task with AI assistance</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Role-Adaptive</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">Auto-Save</span>
                        </div>
                    </div>
                </div>
            </button>
            
            
            <button onclick="openTrainingPlan(); closeNewEmployeeToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸŽ“</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">AI-Enhanced Training Plan Generator</div>
                        <div class="text-sm text-slate-400 mb-3">Create role-specific training plans with AI-powered week-by-week schedules</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Week-by-Week</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">Export Ready</span>
                        </div>
                    </div>
                </div>
            </button>

            <button onclick="openProbationCheckIn(); closeNewEmployeeToolkit();" class="text-left p-6 bg-slate-700/50 hover:bg-slate-700 rounded-xl transition-all hover:scale-[1.02] border border-slate-600 hover:border-amber-500">
                <div class="flex items-start gap-4">
                    <span class="text-4xl">ðŸ”„</span>
                    <div>
                        <div class="font-semibold text-white text-lg mb-2">Probation Check-In Builder</div>
                        <div class="text-sm text-slate-400 mb-3">Generate structured probation review documents covering requirements, deliverables, behaviours and support plans</div>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">AI-Powered</span>
                            <span class="text-xs bg-teal-500/20 text-teal-400 px-2 py-1 rounded">Procedural Fairness</span>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">DOCX/PDF</span>
                        </div>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>


<!-- Onboarding Checklist Modal -->
<!-- Probation Check-In Builder Modal -->
<div id="probationCheckInModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ”„</span> Probation Check-In Builder
                </h2>
                <p class="text-slate-400 text-sm">AI-powered probation review document generation</p>
            </div>
            <button onclick="closeProbationCheckIn()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Progress Bar -->
        <div id="probationProgressSection" class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-slate-400 text-sm">Step <span id="probationCurrentStep">1</span> of <span id="probationTotalSteps">6</span></span>
                <span class="text-amber-400 text-sm" id="probationProgress">0% Complete</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
                <div class="bg-amber-500 h-2 rounded-full transition-all duration-500" style="width: 0%" id="probationProgressBar"></div>
            </div>
        </div>

        <!-- Step Content Container -->
        <div id="probationStepContent" class="bg-slate-700/50 rounded-xl p-6 mb-6">
            <!-- Dynamically rendered -->
        </div>

        <!-- Navigation Buttons -->
        <div class="flex items-center justify-between">
            <button id="probationBackBtn" onclick="probationWizardBack()" style="display:none"
                    class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-all">
                â† Back
            </button>
            <div class="flex-1"></div>
            <div class="flex gap-3">
                <button id="probationStartOverBtn" onclick="resetProbationCheckIn()" class="hidden px-4 py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm transition-all">
                    ðŸ”„ Start Over
                </button>
                <button id="probationNextBtn" onclick="probationWizardNext()"
                        class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg transition-all">
                    Next Step â†’
                </button>
            </div>
        </div>

        <!-- AI Generation Loading (hidden initially) -->
        <div id="probationGenerating" class="hidden text-center py-12">
            <div class="inline-flex items-center gap-3 mb-4">
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
            <p class="text-amber-400 font-semibold text-lg">Fitz is generating your Probation Check-In document...</p>
            <p class="text-slate-400 text-sm mt-2">This usually takes 15-30 seconds</p>
        </div>
    </div>
</div>

<!-- Probation Check-In Preview Modal -->
<div id="probationPreviewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-slate-700 flex-shrink-0">
            <h2 class="text-xl font-bold text-amber-500 flex items-center gap-2">
                <span>ðŸ“„</span> Probation Check-In Document
            </h2>
            <button onclick="closeProbationPreview()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Document Content (scrollable) -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="bg-white rounded-lg p-8 text-gray-800 max-w-none prose">
                <!-- AI-generated document appears here -->
                <div id="probationPreviewContent"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="p-6 border-t border-slate-700 flex-shrink-0">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="downloadProbationDocument('pdf')" 
                        class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold flex items-center gap-2">
                    ðŸ“• Download PDF
                </button>
                <button onclick="downloadProbationDocument('docx')" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold flex items-center gap-2">
                    ðŸ“˜ Download Word
                </button>
            </div>
            <p class="text-center text-slate-400 text-xs mt-3">âš ï¸ All documents should be reviewed before use. Ensure both employee and leader retain a signed copy.</p>
        </div>
    </div>
</div>
<!-- Training Plan Generator Modal -->
<div id="trainingPlanModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸŽ“</span> AI-Enhanced Training Plan Generator
                </h2>
                <p class="text-slate-400 text-sm">Create comprehensive, role-specific training plans in minutes</p>
            </div>
            <button onclick="closeTrainingPlan()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Employee Setup -->
        <div class="bg-slate-700/50 rounded-xl p-6 mb-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>ðŸ‘¤</span> Training Plan Details
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Employee Name *</label>
                    <input type="text" id="trainingEmployeeName" 
                           class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none"
                           placeholder="Full name">
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Position/Role *</label>
                    <select id="trainingPosition" 
                            class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none"
                            onchange="updateTrainingRoleInfo()">
                        <option value="">Select position...</option>
                        <optgroup label="Kitchen">
                            <option value="head-chef">Head Chef</option>
                            <option value="sous-chef">Sous Chef</option>
                            <option value="chef-de-partie">Chef de Partie</option>
                            <option value="commis-chef">Commis Chef</option>
                            <option value="kitchen-hand">Kitchen Hand</option>
                        </optgroup>
                        <optgroup label="Front of House">
                            <option value="restaurant-manager">Restaurant Manager</option>
                            <option value="floor-supervisor">Floor Supervisor</option>
                            <option value="waiter">Waiter/Waitress</option>
                            <option value="bartender">Bartender</option>
                            <option value="barista">Barista</option>
                            <option value="host">Host/Hostess</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="cleaner">Cleaner</option>
                            <option value="dishwasher">Dishwasher</option>
                            <option value="delivery-driver">Delivery Driver</option>
                        </optgroup>
                    </select>
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Experience Level *</label>
                    <select id="trainingExperience" 
                            class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none">
                        <option value="">Select experience...</option>
                        <option value="beginner">Beginner (No experience)</option>
                        <option value="some-experience">Some Experience (1-2 years)</option>
                        <option value="experienced">Experienced (3-5 years)</option>
                        <option value="expert">Expert (5+ years)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Training Duration *</label>
                    <select id="trainingDuration" 
                            class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none">
                        <option value="">Select duration...</option>
                        <option value="1">1 Week (Fast Track)</option>
                        <option value="2">2 Weeks (Standard)</option>
                        <option value="4">4 Weeks (Comprehensive)</option>
                        <option value="8">8 Weeks (In-Depth)</option>
                        <option value="12">12 Weeks (Full Program)</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Additional Focus Areas (Optional)</label>
                <textarea id="trainingFocusAreas" 
                          class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none"
                          rows="2"
                          placeholder="e.g., Customer service excellence, Wine knowledge, Dietary requirements..."></textarea>
            </div>
            
            <div id="roleInfoBox" class="hidden mt-4 bg-blue-900/30 border border-blue-500 rounded-lg p-4">
                <div class="flex items-start gap-2">
                    <span class="text-2xl">ðŸ’¡</span>
                    <div>
                        <div class="text-blue-300 font-semibold mb-1">Role Information</div>
                        <div id="roleInfoContent" class="text-blue-200 text-sm"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="generateTrainingPlan()" 
                    class="mt-4 w-full px-6 py-3 bg-amber-500 hover:bg-amber-600 text-black font-semibold rounded-lg transition-all flex items-center justify-center gap-2">
                <span>âœ¨</span> Generate AI Training Plan
            </button>
        </div>

        <!-- AI Insights Box -->
        <div id="trainingAIInsights" class="hidden bg-gradient-to-r from-purple-900/50 to-blue-900/50 border border-purple-500 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-3xl">ðŸ¤–</span>
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-white mb-2">AI Training Insights</h4>
                    <div id="trainingAIContent" class="text-slate-300 text-sm leading-relaxed"></div>
                </div>
            </div>
        </div>

        <!-- Training Plan Display -->
        <div id="trainingPlanDisplay" class="hidden space-y-6">
            <!-- Week-by-week breakdown will be inserted here -->
        </div>

        <!-- Timeline Visualization -->
        <div id="trainingTimeline" class="hidden mb-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>ðŸ“…</span> Training Timeline
            </h3>
            <div id="timelineContent" class="relative">
                <!-- Timeline will be inserted here -->
            </div>
        </div>

        <!-- AI Coach Assistant -->
        <div id="trainingCoachSection" class="hidden mt-6 bg-slate-700/30 rounded-xl p-4 border border-slate-600">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ðŸŽ¯</span>
                <h4 class="font-semibold text-white">AI Training Coach</h4>
            </div>
            <p class="text-slate-400 text-sm mb-3">Ask questions about this training plan or get suggestions for improvement</p>
            <textarea id="trainingCoachInput" 
                      class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none mb-3"
                      placeholder="e.g., 'How should I adapt this for someone with prior experience?' or 'What equipment do I need?'"
                      rows="2"></textarea>
            <button onclick="askTrainingCoach()" 
                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-all flex items-center gap-2">
                <span>ðŸ¤–</span> Ask AI Coach
            </button>
            <div id="trainingCoachResponse" class="hidden mt-4 p-4 bg-slate-800 rounded-lg border border-purple-500">
                <div id="trainingCoachContent" class="text-slate-300 text-sm leading-relaxed"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="trainingActions" class="hidden mt-6 flex flex-wrap gap-3">
            <button onclick="saveTrainingPlan()" 
                    class="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg transition-all">
                ðŸ’¾ Save Plan
            </button>
            <button onclick="exportTrainingPlanDOCX()" 
                    class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all">
                ðŸ“¥ Export DOCX
            </button>
            <button onclick="exportTrainingPlanPDF()" 
                    class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all">
                ðŸ“¥ Export PDF
            </button>
            <button onclick="printTrainingPlan()" 
                    class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-all">
                ðŸ–¨ï¸ Print
            </button>
        </div>

        <div class="mt-6 text-center">
            <button onclick="closeTrainingPlan()" 
                    class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-all">
                Close
            </button>
        </div>
    </div>
</div>

<style>
/* Training Plan Generator Styles */
#trainingPlanModal .training-week {
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
}

#trainingPlanModal .training-week:hover {
    border-color: rgba(251, 191, 36, 0.5);
    background: rgba(51, 65, 105, 0.7);
}

#trainingPlanModal .training-day {
    background: rgba(71, 85, 105, 0.3);
    border-left: 4px solid #667eea;
    padding: 16px;
    margin: 12px 0;
    border-radius: 8px;
}

#trainingPlanModal .training-activity {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 8px;
    margin: 8px 0;
}

#trainingPlanModal .activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

#trainingPlanModal .icon-theory {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

#trainingPlanModal .icon-practical {
    background: linear-gradient(135deg, #f093fb, #f5576c);
}

#trainingPlanModal .icon-assessment {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
}

#trainingPlanModal .icon-shadowing {
    background: linear-gradient(135deg, #43e97b, #38f9d7);
}

#trainingPlanModal .activity-content {
    flex: 1;
}

#trainingPlanModal .activity-title {
    color: white;
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
}

#trainingPlanModal .activity-description {
    color: #94a3b8;
    font-size: 14px;
    line-height: 1.5;
}

#trainingPlanModal .activity-duration {
    color: #fbbf24;
    font-size: 12px;
    font-weight: 600;
    margin-top: 6px;
}

#trainingPlanModal .timeline-item {
    position: relative;
    padding-left: 40px;
    padding-bottom: 30px;
}

#trainingPlanModal .timeline-item::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, #667eea, #764ba2);
}

#trainingPlanModal .timeline-item:last-child::before {
    background: linear-gradient(180deg, #667eea, transparent);
}

#trainingPlanModal .timeline-marker {
    position: absolute;
    left: 8px;
    top: 5px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #fbbf24;
    border: 3px solid #1e293b;
}

#trainingPlanModal .milestone-badge {
    display: inline-block;
    padding: 4px 12px;
    background: rgba(251, 191, 36, 0.2);
    border: 1px solid #fbbf24;
    border-radius: 12px;
    color: #fbbf24;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

#trainingPlanModal .competency-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: rgba(71, 85, 105, 0.3);
    border-radius: 6px;
    margin: 6px 0;
}

#trainingPlanModal .competency-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #64748b;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
}

#trainingPlanModal .ai-thinking-training {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a78bfa;
    font-size: 14px;
}

#trainingPlanModal .ai-thinking-training::after {
    content: "...";
    animation: thinking 1.5s infinite;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
    50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.6); }
}

#trainingPlanModal .generate-button-active {
    animation: pulse-glow 2s infinite;
}
</style>


<div id="onboardingChecklistModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-5xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>ðŸ“‹</span> AI-Enhanced Onboarding Checklist
                </h2>
                <p class="text-slate-400 text-sm">Smart checklist that adapts to your employee's role and circumstances</p>
            </div>
            <button onclick="closeOnboardingChecklist()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
        </div>

        <!-- Employee Setup -->
        <div class="bg-slate-700/50 rounded-xl p-6 mb-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>ðŸ‘¤</span> New Employee Details
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Employee Name *</label>
                    <input type="text" id="onboardingEmployeeName" 
                           class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none"
                           placeholder="Full name">
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Position/Role *</label>
                    <input type="text" id="onboardingPosition" 
                           class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none"
                           placeholder="e.g., Head Chef, Waiter, Barista">
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Employment Type *</label>
                    <select id="onboardingEmploymentType" 
                            class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none">
                        <option value="">Select type...</option>
                        <option value="full-time">Full-time</option>
                        <option value="part-time">Part-time</option>
                        <option value="casual">Casual</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-slate-300 text-sm font-semibold mb-2">Start Date *</label>
                    <input type="date" id="onboardingStartDate" 
                           class="w-full px-4 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none">
                </div>
            </div>
            
            <button onclick="generateSmartChecklist()" 
                    class="mt-4 px-6 py-3 bg-amber-500 hover:bg-amber-600 text-black font-semibold rounded-lg transition-all flex items-center gap-2">
                <span>âœ¨</span> Generate Smart Checklist
            </button>
        </div>

        <!-- AI Insights Box -->
        <div id="aiInsightsBox" class="hidden bg-gradient-to-r from-purple-900/50 to-blue-900/50 border border-purple-500 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-3xl">ðŸ¤–</span>
                <div>
                    <h4 class="text-lg font-bold text-white mb-2">AI Insights</h4>
                    <div id="aiInsightsContent" class="text-slate-300 text-sm leading-relaxed"></div>
                </div>
            </div>
        </div>

        <!-- Checklist Progress -->
        <div id="checklistProgressBar" class="hidden mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-slate-300 font-semibold">Onboarding Progress</span>
                <span id="progressPercentage" class="text-amber-500 font-bold">0%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-3">
                <div id="progressBarFill" class="bg-gradient-to-r from-amber-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-slate-400 text-sm mt-2">
                <span id="completedTasks">0</span> of <span id="totalTasks">0</span> tasks completed
            </p>
        </div>

        <!-- Checklist Sections -->
        <div id="checklistSections" class="space-y-4">
            <!-- Will be populated dynamically -->
        </div>

        <!-- AI Assistant -->
        <div class="mt-6 bg-slate-700/30 rounded-xl p-4 border border-slate-600">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ðŸ’¬</span>
                <h4 class="font-semibold text-white">Ask AI Assistant</h4>
            </div>
            <textarea id="aiQuestionInput" 
                      class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white focus:border-amber-500 focus:outline-none mb-3"
                      placeholder="Ask me anything about onboarding, compliance, or Fair Work requirements..."
                      rows="2"></textarea>
            <button onclick="askAIAssistant()" 
                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-all flex items-center gap-2">
                <span>ðŸ¤–</span> Ask AI
            </button>
            <div id="aiResponseBox" class="hidden mt-4 p-4 bg-slate-800 rounded-lg border border-purple-500">
                <div id="aiResponseContent" class="text-slate-300 text-sm leading-relaxed"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex gap-3">
            <button onclick="saveOnboardingProgress()" 
                    class="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg transition-all">
                ðŸ’¾ Save Progress
            </button>
            <button onclick="exportChecklistDOCX()" 
                    class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all">
                ðŸ“¥ Export DOCX
            </button>
            <button onclick="exportChecklistPDF()" 
                    class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all">
                ðŸ“¥ Export PDF
            </button>
            <button onclick="closeOnboardingChecklist()" 
                    class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-all">
                Close
            </button>
        </div>
    </div>
</div>

<style>
/* Onboarding Checklist Specific Styles */
#onboardingChecklistModal .checklist-section {
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
}

#onboardingChecklistModal .checklist-section:hover {
    border-color: rgba(251, 191, 36, 0.5);
    background: rgba(51, 65, 85, 0.7);
}

#onboardingChecklistModal .checklist-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
}

#onboardingChecklistModal .checklist-item:hover {
    background: rgba(71, 85, 105, 0.5);
}

#onboardingChecklistModal .checklist-item.completed {
    opacity: 0.7;
}

#onboardingChecklistModal .checklist-item.completed .item-text {
    text-decoration: line-through;
    color: #94a3b8;
}

#onboardingChecklistModal .checkbox-custom {
    width: 24px;
    height: 24px;
    border: 2px solid #64748b;
    border-radius: 6px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    cursor: pointer;
}

#onboardingChecklistModal .checkbox-custom:hover {
    border-color: #fbbf24;
}

#onboardingChecklistModal .checkbox-custom.checked {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
}

#onboardingChecklistModal .checkbox-custom.checked::after {
    content: "âœ“";
    color: white;
    font-size: 16px;
    font-weight: bold;
}

#onboardingChecklistModal .item-content {
    flex: 1;
}

#onboardingChecklistModal .item-text {
    color: white;
    font-weight: 500;
    margin-bottom: 4px;
}

#onboardingChecklistModal .item-hint {
    color: #94a3b8;
    font-size: 13px;
    line-height: 1.4;
}

#onboardingChecklistModal .item-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

#onboardingChecklistModal .action-btn {
    padding: 4px 12px;
    background: rgba(100, 116, 139, 0.5);
    border: 1px solid #475569;
    border-radius: 6px;
    color: #cbd5e1;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

#onboardingChecklistModal .action-btn:hover {
    background: rgba(100, 116, 139, 0.8);
    border-color: #fbbf24;
    color: #fbbf24;
}

#onboardingChecklistModal .priority-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#onboardingChecklistModal .priority-high {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}

#onboardingChecklistModal .priority-medium {
    background: rgba(251, 191, 36, 0.2);
    color: #fcd34d;
}

#onboardingChecklistModal .priority-low {
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
}

#onboardingChecklistModal .ai-thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a78bfa;
    font-size: 14px;
}

#onboardingChecklistModal .ai-thinking::after {
    content: "...";
    animation: thinking 1.5s infinite;
}

@keyframes thinking {
    0%, 20% { content: "."; }
    40% { content: ".."; }
    60%, 100% { content: "..."; }
}
</style>


<div id="employmentContractBuilder">
    <div class="contract-content-area">
        <!-- Header -->
        <div class="contract-header">
            <button class="contract-close-btn" onclick="closeEmploymentContract()" aria-label="Close">Ã—</button>
            <h1>Employment Contract Builder</h1>
            <p>Create Fair Work Australia compliant employment contracts in minutes</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressLineFill"></div>
                </div>
                <div class="progress-step" data-step="0">
                    <div class="progress-circle active" id="progressCircle0">1</div>
                    <div class="progress-label active">Setup</div>
                </div>
                <div class="progress-step" data-step="1">
                    <div class="progress-circle" id="progressCircle1">2</div>
                    <div class="progress-label">Position</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-circle" id="progressCircle2">3</div>
                    <div class="progress-label">Hours</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-circle" id="progressCircle3">4</div>
                    <div class="progress-label">Pay</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-circle" id="progressCircle4">5</div>
                    <div class="progress-label">Leave</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="progress-circle" id="progressCircle5">6</div>
                    <div class="progress-label">Terms</div>
                </div>
                <div class="progress-step" data-step="6">
                    <div class="progress-circle" id="progressCircle6">7</div>
                    <div class="progress-label">Ending</div>
                </div>
                <div class="progress-step" data-step="7">
                    <div class="progress-circle" id="progressCircle7">8</div>
                    <div class="progress-label">Review</div>
                </div>
                <div class="progress-step" data-step="8">
                    <div class="progress-circle" id="progressCircle8">9</div>
                    <div class="progress-label">Generate</div>
                </div>
            </div>
        </div>

        <!-- Step Content Container -->
        <div class="step-content" id="contractStepContent">
            <!-- Steps will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- CONTRACT BUILDER TERMS OF USE MODAL -->
<!-- ========================================== -->
<div id="contractBuilderTermsModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 md:p-6 z-[9999999]">
    <div class="bg-slate-800 rounded-2xl p-6 md:p-8 max-w-4xl w-full border-2 border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-amber-500/20 rounded-full mb-4">
                <span class="text-4xl">ðŸ“‹</span>
            </div>
            <h2 class="text-2xl font-bold text-amber-400">Employment Contract Builder â€“ Terms of Use</h2>
            <p class="text-slate-400 text-sm mt-2">Please read carefully before creating contracts</p>
        </div>

        <!-- Content -->
        <div class="bg-slate-900/50 rounded-lg p-6 mb-6 space-y-4 text-slate-300 text-sm border border-slate-700 max-h-[50vh] overflow-y-auto">
            
            <!-- Important Notice -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-red-400">âš ï¸</span>
                    <span>Important Notice</span>
                </h3>
                <p class="mb-2">
                    By using the Fitzgerald HR Employment Contract Builder, you agree to these Terms of Use. 
                    These terms set out important information about how the tool must be used and the legal 
                    consequences of incorrect use.
                </p>
            </div>

            <!-- Information Tool -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">ðŸ“š</span>
                    <span>This is an Information Tool</span>
                </h3>
                <p>
                    This tool provides <strong class="text-white">general HR information and contract templates only</strong> 
                    for Australian hospitality venues. It is <strong class="text-red-400">NOT a substitute</strong> for 
                    professional HR or legal advice. All contracts generated should be reviewed by a qualified professional.
                </p>
            </div>

            <!-- Your Obligations -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">âœ…</span>
                    <span>Your Obligations</span>
                </h3>
                <p class="mb-2">On each occasion that you use this tool, you represent and warrant that:</p>
                <ul class="list-disc list-inside space-y-1 text-slate-400 ml-4">
                    <li>The information you input is true and accurate</li>
                    <li>You have authority to create employment contracts for your organisation</li>
                    <li>You will provide prospective employees all required documentation including the Fair Work Information Statement</li>
                    <li>You will not re-use or repurpose generated contracts for other businesses</li>
                    <li>You will undertake the entire process from the beginning for each new contract</li>
                    <li>You know and will properly apply the award that covers the employee</li>
                </ul>
            </div>

            <!-- Compliance with Laws -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">âš–ï¸</span>
                    <span>Compliance with Laws</span>
                </h3>
                <p class="mb-2">You must ensure that:</p>
                <ul class="list-disc list-inside space-y-1 text-slate-400 ml-4">
                    <li>Your use of any generated contract complies with the Fair Work Act 2009 (Cth) and applicable awards</li>
                    <li>You supply the Fair Work Information Statement with any contract</li>
                    <li>You pay employees the correct amount including all allowances, loadings, and entitlements</li>
                    <li>You do not engage in any misleading or deceptive conduct</li>
                </ul>
            </div>

            <!-- Acknowledgements -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">ðŸ“</span>
                    <span>By Using This Tool You Acknowledge</span>
                </h3>
                <ul class="list-disc list-inside space-y-1 text-slate-400 ml-4">
                    <li>Nothing in this tool constitutes legal advice</li>
                    <li>Guidance is general in nature and may not apply to your specific circumstances</li>
                    <li>You are solely responsible for seeking legal advice on laws that apply to you as an employer</li>
                    <li>The law may change at any time and contract provisions may be superseded</li>
                    <li>You use this tool at your own risk</li>
                </ul>
            </div>

            <!-- Limitation of Liability -->
            <div class="pb-4 border-b border-slate-700">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-amber-400">ðŸ›¡ï¸</span>
                    <span>Limitation of Liability</span>
                </h3>
                <p>
                    Fitzgerald HR makes no representation or warranty regarding the performance, accuracy, reliability, 
                    fitness for purpose, or availability of this tool. We exclude all liability for any direct or indirect 
                    loss or damage whatsoever arising from your use of, or reliance on, this tool or any generated contracts.
                </p>
            </div>

            <!-- Professional Review Required -->
            <div class="bg-red-500/10 border border-red-500/50 rounded-lg p-4">
                <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                    <span class="text-red-400">ðŸš¨</span>
                    <span>Professional Review Required</span>
                </h3>
                <p class="text-slate-300">
                    <strong class="text-red-400">All generated contracts should be reviewed by a qualified HR professional or 
                    employment lawyer before being issued to employees.</strong> If you are a Fitzgerald HR client, 
                    please submit contracts for review. Incorrect contracts may expose you to legal risks including 
                    underpayment claims and unfair dismissal proceedings.
                </p>
            </div>
        </div>

        <!-- Checkbox and Buttons -->
        <div class="space-y-4">
            <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="contractTermsCheckbox" class="mt-1 w-5 h-5 rounded border-slate-600 bg-slate-700 text-amber-500 focus:ring-amber-500 focus:ring-offset-slate-800">
                <span class="text-slate-300 text-sm group-hover:text-white transition-colors">
                    I have read, understood, and agree to these Terms of Use. I understand that generated contracts 
                    are templates only and should be reviewed by a qualified professional before use.
                </span>
            </label>
            
            <div class="flex gap-4">
                <button onclick="declineContractTerms()" class="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-semibold transition-all">
                    Cancel
                </button>
                <button id="acceptContractTermsBtn" onclick="acceptContractTerms()" disabled class="flex-1 px-6 py-3 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all">
                    I Agree â€“ Continue
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- CONTRACT BUILDER VALIDATION POPUP -->
<!-- ========================================== -->
<div id="contractValidationPopup" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[99999999]">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
        <div class="text-center mb-4">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                <span class="text-4xl">âš ï¸</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900">Required Fields Missing</h3>
            <p class="text-gray-600 mt-2">Please complete the following fields before continuing:</p>
        </div>
        
        <div id="validationErrorList" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 max-h-60 overflow-y-auto">
            <!-- Error items will be inserted here -->
        </div>
        
        <button onclick="closeValidationPopup()" class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition-all">
            OK, I'll Fix These
        </button>
    </div>
</div>

<script>
// ========================================
// ========================================
// NEW EMPLOYEE TOOLKIT FUNCTIONS
// ========================================

function openNewEmployeeToolkit() {
    const modal = document.getElementById('newEmployeeToolkitModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('newEmployeeToolkit');
    }
}

function closeNewEmployeeToolkit() {
    const modal = document.getElementById('newEmployeeToolkitModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Update the main button to open the toolkit instead of contract builder directly
function openEmploymentContractFromMenu() {
    openNewEmployeeToolkit();
    closeToolsMenu();
}

// Rename the contract builder function for clarity
// ========================================
// AI-ENHANCED ONBOARDING CHECKLIST
// ========================================

let onboardingState = {
    employeeName: '',
    position: '',
    employmentType: '',
    startDate: '',
    checklist: [],
    completedTasks: [],
    checklistId: null
};

// Main Functions
function openOnboardingChecklist() {
    const modal = document.getElementById('onboardingChecklistModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    // Try to load saved progress
    loadOnboardingProgress();
    
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('onboardingChecklist');
    }
}

function closeOnboardingChecklist() {
    const modal = document.getElementById('onboardingChecklistModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Generate Smart Checklist with AI
async function generateSmartChecklist() {
    const employeeName = document.getElementById('onboardingEmployeeName').value.trim();
    const position = document.getElementById('onboardingPosition').value.trim();
    const employmentType = document.getElementById('onboardingEmploymentType').value;
    const startDate = document.getElementById('onboardingStartDate').value;
    
    // Validation
    if (!employeeName || !position || !employmentType || !startDate) {
        showAlert('Please fill in all required fields (Name, Position, Employment Type, Start Date)');
        return;
    }
    
    // Save to state
    onboardingState.employeeName = employeeName;
    onboardingState.position = position;
    onboardingState.employmentType = employmentType;
    onboardingState.startDate = startDate;
    onboardingState.checklistId = 'onboarding_' + Date.now();
    
    // Show loading
    showAIThinking('Analyzing role and generating personalized checklist...');
    
    try {
        // Get AI insights
        const insights = await getAIInsights(position, employmentType);
        
        // Generate checklist based on employment type
        const checklist = generateChecklistItems(employmentType, position);
        onboardingState.checklist = checklist;
        
        // Display AI insights
        displayAIInsights(insights);
        
        // Render checklist
        renderChecklist();
        
        // Show progress bar
        document.getElementById('checklistProgressBar').classList.remove('hidden');
        updateProgress();
        
    } catch (error) {
        showAlert('Failed to generate checklist. Please try again.');
    }
}

// Get AI Insights using Claude API
async function getAIInsights(position, employmentType) {
    const prompt = `As an Australian HR expert, provide 3 key insights for onboarding a new ${employmentType} ${position} in the hospitality industry. Focus on:
1. Critical first-week priorities
2. Common compliance issues to avoid
3. Role-specific considerations

Keep it concise, actionable, and specific to Australian hospitality.`;
    
    try {
        const response = await callClaudeAPI(prompt);
        return response;
    } catch (error) {
        return getFallbackInsights(position, employmentType);
    }
}

function getFallbackInsights(position, employmentType) {
    const insights = {
        'full-time': `For full-time ${position} roles:
â€¢ Ensure Fair Work Information Statement is provided on day 1
â€¢ Set up regular check-ins during the 6-month probation period
â€¢ ${position.toLowerCase().includes('chef') ? 'Verify food safety certifications and arrange any required training' : 'Schedule comprehensive role training in first 2 weeks'}`,
        
        'part-time': `For part-time ${position} roles:
â€¢ Clarify guaranteed minimum hours and roster patterns from the start
â€¢ Ensure pro-rata leave entitlements are clearly explained
â€¢ ${position.toLowerCase().includes('front') ? 'Focus on customer service standards training' : 'Provide clear availability requirements and flexibility expectations'}`,
        
        'casual': `For casual ${position} roles:
â€¢ Emphasize the 25% casual loading and explain what it covers
â€¢ Make it clear that hours are not guaranteed but shifts will be offered
â€¢ ${position.toLowerCase().includes('kitchen') ? 'Ensure immediate induction on food safety and kitchen procedures' : 'Fast-track customer service and POS system training'}`
    };
    
    return insights[employmentType] || 'Focus on comprehensive induction, clear communication, and regular feedback.';
}

function displayAIInsights(insights) {
    const insightsBox = document.getElementById('aiInsightsBox');
    const content = document.getElementById('aiInsightsContent');
    
    content.innerHTML = insights.replace(/\n/g, '<br>');
    insightsBox.classList.remove('hidden');
}

function showAIThinking(message) {
    const insightsBox = document.getElementById('aiInsightsBox');
    const content = document.getElementById('aiInsightsContent');
    
    content.innerHTML = `<div class="ai-thinking">${message}</div>`;
    insightsBox.classList.remove('hidden');
}

// Generate Checklist Items
function generateChecklistItems(employmentType, position) {
    const baseItems = [
        {
            id: 1,
            category: 'Legal & Compliance',
            title: 'Provide Fair Work Information Statement',
            hint: 'Must be given before or on the first day of work.',
            link: 'https://www.fairwork.gov.au/employment-conditions/information-statements/fair-work-information-statement',
            linkText: 'Download from Fair Work',
            priority: 'high',
            daysUntil: 0,
            actions: ['Download Template', 'Mark as Given']
        },
        {
            id: 2,
            category: 'Legal & Compliance',
            title: 'Signed Employment Contract',
            hint: 'Ensure both parties have signed the contract and each has a copy.',
            priority: 'high',
            daysUntil: 0,
            actions: ['View Contract', 'Confirm Signed']
        },
        {
            id: 3,
            category: 'Payroll Setup',
            title: 'Collect Tax File Number (TFN) Declaration',
            hint: 'Required for tax purposes.',
            link: 'https://www.ato.gov.au/forms-and-instructions/tax-file-number-declaration',
            linkText: 'Download TFN Declaration Form',
            priority: 'high',
            daysUntil: 1,
            actions: ['Download Form', 'Mark Received']
        },
        {
            id: 4,
            category: 'Payroll Setup',
            title: 'Super Fund Choice Form',
            hint: 'Employee must choose superannuation fund or use your default fund.',
            link: 'https://www.ato.gov.au/forms-and-instructions/superannuation-standard-choice-form',
            linkText: 'Download Super Choice Form',
            priority: 'high',
            daysUntil: 1,
            actions: ['Download Form', 'Mark Completed']
        },
        {
            id: 5,
            category: 'Payroll Setup',
            title: 'Bank Account Details',
            hint: 'For salary/wage payments via direct deposit.',
            priority: 'high',
            daysUntil: 1,
            actions: ['Collect Details', 'Verify']
        },
        {
            id: 6,
            category: 'Payroll Setup',
            title: 'Add to Payroll System',
            hint: 'Set up in Deputy, Xero, or your payroll system with correct pay rate and Award.',
            priority: 'high',
            daysUntil: 2,
            actions: ['Add to System', 'Test Pay Run']
        },
        {
            id: 7,
            category: 'Documentation',
            title: 'Emergency Contact Information',
            hint: 'Collect details of who to contact in case of emergency.',
            priority: 'medium',
            daysUntil: 1,
            actions: ['Collect Info', 'Store Securely']
        },
        {
            id: 8,
            category: 'Documentation',
            title: 'Proof of Working Rights',
            hint: 'Check passport, visa, or citizenship documents to verify right to work in Australia.',
            priority: 'high',
            daysUntil: 0,
            actions: ['Check Documents', 'Keep Copies']
        }
    ];
    
    // Add role-specific items
    if (position.toLowerCase().includes('chef') || position.toLowerCase().includes('kitchen') || position.toLowerCase().includes('cook')) {
        baseItems.push({
            id: 9,
            category: 'Training & Compliance',
            title: 'Food Safety Certificate Verification',
            hint: 'Ensure valid Food Handler certificate (or arrange training within first week).',
            priority: 'high',
            daysUntil: 0,
            actions: ['Check Certificate', 'Arrange Training']
        });
    }
    
    if (employmentType === 'full-time' || employmentType === 'part-time') {
        baseItems.push({
            id: 10,
            category: 'Onboarding',
            title: 'Explain Leave Entitlements',
            hint: 'Annual leave, personal/carer\'s leave, and how to request time off.',
            priority: 'medium',
            daysUntil: 1,
            actions: ['Provide Leave Policy', 'Explain Process']
        });
    }
    
    baseItems.push(
        {
            id: 11,
            category: 'Onboarding',
            title: 'Workplace Induction',
            hint: 'Tour of facilities, introduction to team, key contacts, emergency procedures.',
            priority: 'high',
            daysUntil: 0,
            actions: ['Schedule Tour', 'Complete Checklist']
        },
        {
            id: 12,
            category: 'Onboarding',
            title: 'WHS & Safety Training',
            hint: 'Workplace health and safety procedures, emergency exits, fire drills.',
            priority: 'high',
            daysUntil: 0,
            actions: ['Conduct Training', 'Sign-off']
        },
        {
            id: 13,
            category: 'Training & Compliance',
            title: 'Responsible Service of Alcohol (RSA)',
            hint: 'Required for anyone serving alcohol in Australia.',
            priority: position.toLowerCase().includes('bar') || position.toLowerCase().includes('front') ? 'high' : 'medium',
            daysUntil: position.toLowerCase().includes('bar') ? 0 : 7,
            actions: ['Check Certificate', 'Arrange Training']
        },
        {
            id: 14,
            category: 'Systems & Access',
            title: 'POS System Training',
            hint: 'Show how to use point of sale system for orders and payments.',
            priority: 'high',
            daysUntil: 1,
            actions: ['Book Training', 'Create Login']
        },
        {
            id: 15,
            category: 'Systems & Access',
            title: 'Roster Access',
            hint: 'Add to Deputy or rostering system so they can view shifts.',
            priority: 'medium',
            daysUntil: 2,
            actions: ['Add to System', 'Send Invite']
        },
        {
            id: 16,
            category: 'Onboarding',
            title: 'Uniform & Equipment',
            hint: 'Provide required uniform items and any necessary equipment.',
            priority: 'medium',
            daysUntil: 0,
            actions: ['Issue Uniform', 'Record in System']
        },
        {
            id: 17,
            category: 'Follow-up',
            title: '1-Week Check-in',
            hint: 'Catch up to see how they\'re settling in, answer questions, address concerns.',
            priority: 'medium',
            daysUntil: 7,
            actions: ['Schedule Meeting', 'Complete']
        },
        {
            id: 18,
            category: 'Follow-up',
            title: '1-Month Review',
            hint: 'Formal review of performance, provide feedback, set goals.',
            priority: 'medium',
            daysUntil: 30,
            actions: ['Schedule Review', 'Complete']
        }
    );
    
    if (employmentType === 'full-time' || employmentType === 'part-time') {
        baseItems.push({
            id: 19,
            category: 'Follow-up',
            title: 'End of Probation Review',
            hint: 'Formal review at end of probation period (typically 6 months).',
            priority: 'low',
            daysUntil: 180,
            actions: ['Schedule Review', 'Confirm Continuation']
        });
    }
    
    return baseItems;
}

// Render Checklist
function renderChecklist() {
    const container = document.getElementById('checklistSections');
    
    // Group by category
    const grouped = onboardingState.checklist.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
    }, {});
    
    let html = '';
    
    Object.keys(grouped).forEach(category => {
        const items = grouped[category];
        const categoryId = category.replace(/\s+/g, '-').toLowerCase();
        
        html += `
            <div class="checklist-section">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    ${getCategoryIcon(category)}
                    <span>${category}</span>
                    <span class="text-slate-400 text-sm font-normal ml-auto">${items.filter(i => onboardingState.completedTasks.includes(i.id)).length}/${items.length} completed</span>
                </h3>
                <div class="space-y-2">
                    ${items.map(item => renderChecklistItem(item)).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderChecklistItem(item) {
    const isCompleted = onboardingState.completedTasks.includes(item.id);
    
    return `
        <div class="checklist-item ${isCompleted ? 'completed' : ''}" data-item-id="${item.id}">
            <div class="checkbox-custom ${isCompleted ? 'checked' : ''}" 
                 onclick="toggleTaskCompletion(${item.id})"></div>
            <div class="item-content">
                <div class="flex items-start justify-between">
                    <div class="item-text">${item.title}</div>
                    <span class="priority-badge priority-${item.priority}">${item.priority}</span>
                </div>
                <div class="item-hint">${item.hint}</div>
                ${item.link ? `
                    <div class="mt-2">
                        <a href="${item.link}" target="_blank" rel="noopener noreferrer" 
                           style="color: #f59e0b; text-decoration: underline; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;">
                            ðŸ“¥ ${item.linkText || 'Download Form'}
                            <span style="font-size: 10px;">â†—</span>
                        </a>
                    </div>
                ` : ''}
                ${item.daysUntil !== undefined ? `
                    <div class="text-xs text-slate-400 mt-2">
                        ${item.daysUntil === 0 ? 'âš¡ Due today' : item.daysUntil === 1 ? 'ðŸ“… Due tomorrow' : `ðŸ“… Due in ${item.daysUntil} days`}
                    </div>
                ` : ''}
                <div class="item-actions">
                    ${item.actions.map(action => `
                        <button class="action-btn" onclick="handleItemAction(${item.id}, '${action}')">${action}</button>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function getCategoryIcon(category) {
    const icons = {
        'Legal & Compliance': 'âš–ï¸',
        'Payroll Setup': 'ðŸ’°',
        'Documentation': 'ðŸ“„',
        'Onboarding': 'ðŸ‘‹',
        'Training & Compliance': 'ðŸŽ“',
        'Systems & Access': 'ðŸ”',
        'Follow-up': 'ðŸ“…'
    };
    return icons[category] || 'ðŸ“‹';
}

// Toggle Task Completion
function toggleTaskCompletion(itemId) {
    const index = onboardingState.completedTasks.indexOf(itemId);
    
    if (index > -1) {
        onboardingState.completedTasks.splice(index, 1);
    } else {
        onboardingState.completedTasks.push(itemId);
    }
    
    // Re-render
    renderChecklist();
    updateProgress();
    
    // Auto-save
    saveOnboardingProgress();
}

// Update Progress
function updateProgress() {
    const total = onboardingState.checklist.length;
    const completed = onboardingState.completedTasks.length;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    document.getElementById('progressPercentage').textContent = percentage + '%';
    document.getElementById('progressBarFill').style.width = percentage + '%';
    document.getElementById('completedTasks').textContent = completed;
    document.getElementById('totalTasks').textContent = total;
}

// Handle Item Actions
function handleItemAction(itemId, action) {
    const item = onboardingState.checklist.find(i => i.id === itemId);
    
    if (action.includes('Download')) {
        // Open Fair Work or ATO website
        if (action.includes('TFN') || action.includes('Form')) {
            window.open('https://www.ato.gov.au/forms-and-instructions/tfn-declaration', '_blank');
        } else if (action.includes('Template') || action.includes('Statement')) {
            window.open('https://www.fairwork.gov.au/employment-conditions/starter-pack', '_blank');
        }
    } else if (action.includes('Mark') || action.includes('Confirm') || action.includes('Complete')) {
        // Mark as completed
        toggleTaskCompletion(itemId);
    } else if (action.includes('Schedule')) {
        // Could integrate with calendar
        showAlert(`Action "${action}" - Would integrate with calendar system`);
    } else {
        showAlert(`Action "${action}" for item: ${item.title}`);
    }
}

// AI Assistant
async function askAIAssistant() {
    const question = document.getElementById('aiQuestionInput').value.trim();
    
    if (!question) {
        showAlert('Please enter a question');
        return;
    }
    
    const responseBox = document.getElementById('aiResponseBox');
    const responseContent = document.getElementById('aiResponseContent');
    
    responseBox.classList.remove('hidden');
    responseContent.innerHTML = '<div class="ai-thinking">Thinking</div>';
    
    try {
        const context = `Employee: ${onboardingState.employeeName}, Position: ${onboardingState.position}, Type: ${onboardingState.employmentType}`;
        const prompt = `As an Australian HR expert, answer this onboarding question:\n\nContext: ${context}\n\nQuestion: ${question}\n\nProvide a clear, actionable answer focused on Australian hospitality compliance.`;
        
        const answer = await callClaudeAPI(prompt);
        responseContent.innerHTML = answer.replace(/\n/g, '<br>');
        
        // Clear input
        document.getElementById('aiQuestionInput').value = '';
    } catch (error) {
        responseContent.innerHTML = 'Sorry, I encountered an error. Please try again or contact support.';
    }
}

// Save/Load Progress
function saveOnboardingProgress() {
    if (!onboardingState.checklistId) return;
    
    try {
        const data = {
            ...onboardingState,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('onboarding_' + onboardingState.checklistId, JSON.stringify(data));
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Progress saved', 'success');
        } else {
            showAlert('âœ… Progress saved');
        }
    } catch (error) {
        showAlert('Failed to save progress');
    }
}

function loadOnboardingProgress() {
    // Try to load the most recent onboarding
    const keys = Object.keys(localStorage).filter(k => k.startsWith('onboarding_'));
    if (keys.length === 0) return;
    
    try {
        const latestKey = keys[keys.length - 1];
        const data = JSON.parse(localStorage.getItem(latestKey));
        
        if (data) {
            onboardingState = data;
            
            // Populate form
            document.getElementById('onboardingEmployeeName').value = data.employeeName || '';
            document.getElementById('onboardingPosition').value = data.position || '';
            document.getElementById('onboardingEmploymentType').value = data.employmentType || '';
            document.getElementById('onboardingStartDate').value = data.startDate || '';
            
            if (data.checklist && data.checklist.length > 0) {
                renderChecklist();
                document.getElementById('checklistProgressBar').classList.remove('hidden');
                updateProgress();
                
                if (typeof showNotification === 'function') {
                    showNotification('âœ… Previous progress loaded', 'success');
                }
            }
        }
    } catch (error) {
    }
}

// Export to PDF
// ========================================
// ENHANCED CONTRACT GENERATION WITH ONBOARDING PROMPT
// ========================================

// Updated generateEmploymentContract function with onboarding prompt
// Prompt user to create onboarding checklist
function promptForOnboardingChecklist() {
    // Create modal HTML
    const modalHTML = `
        <div id="onboardingPromptModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 999999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); text-align: center; animation: fadeIn 0.3s;">
                <div style="font-size: 64px; margin-bottom: 20px;">âœ¨</div>
                <h2 style="color: white; font-size: 28px; font-weight: 700; margin: 0 0 15px 0;">Contract Generated!</h2>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 18px; margin-bottom: 30px; line-height: 1.6;">
                    Would you like to create an <strong>AI-Enhanced Onboarding Checklist</strong> for this employee?
                </p>
                
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 30px; text-align: left;">
                    <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-bottom: 10px;">
                        <strong style="color: white;">We'll automatically pre-fill:</strong>
                    </div>
                    <div style="display: grid; gap: 8px; color: rgba(255, 255, 255, 0.9); font-size: 14px;">
                        <div>âœ“ Employee name</div>
                        <div>âœ“ Position/role</div>
                        <div>âœ“ Employment type</div>
                        <div>âœ“ Start date</div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 15px; margin-bottom: 30px;">
                    <div style="color: #ffd700; font-weight: 600; font-size: 15px; margin-bottom: 8px;">â­ Recommended</div>
                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px; line-height: 1.5;">
                        Ensure nothing is forgotten during onboarding with our smart checklist that adapts to the employee's role
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="createOnboardingFromContract()" style="flex: 1; padding: 16px 32px; background: #ffc107; color: #000; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 193, 7, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 193, 7, 0.4)'">
                        âœ¨ Yes, Create Checklist
                    </button>
                    <button onclick="closeOnboardingPrompt()" style="padding: 16px 32px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                        Skip
                    </button>
                </div>
                
                <div style="margin-top: 20px; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
                    You can always create a checklist later from the New Employee Toolkit
                </div>
            </div>
        </div>
    `;
    
    // Add to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Create onboarding checklist with pre-filled data from contract
function createOnboardingFromContract() {
    // Close the prompt modal first
    closeOnboardingPrompt();
    
    // Close the contract builder
    closeEmploymentContract();
    
    // Extract data from contract builder
    const contractData = contractBuilderState.data.step1;
    
    // Pre-fill onboarding state
    onboardingState.employeeName = contractData.positionTitle ? `New ${contractData.positionTitle}` : 'New Employee';
    onboardingState.position = contractData.positionTitle || '';
    onboardingState.employmentType = contractData.employmentType || '';
    onboardingState.startDate = contractData.startDate || '';
    
    // Open onboarding checklist
    setTimeout(() => {
        openOnboardingChecklist();
        
        // Pre-fill the form after modal is open
        setTimeout(() => {
            const nameField = document.getElementById('onboardingEmployeeName');
            const positionField = document.getElementById('onboardingPosition');
            const typeField = document.getElementById('onboardingEmploymentType');
            const dateField = document.getElementById('onboardingStartDate');
            
            if (nameField) nameField.value = onboardingState.employeeName;
            if (positionField) positionField.value = onboardingState.position;
            if (typeField) typeField.value = onboardingState.employmentType;
            if (dateField) dateField.value = onboardingState.startDate;
            
            // Auto-generate the checklist after a moment
            setTimeout(() => {
                generateSmartChecklist();
            }, 500);
        }, 300);
    }, 300);
}

function closeOnboardingPrompt() {
    const modal = document.getElementById('onboardingPromptModal');
    if (modal) {
        modal.remove();
    } else {
    }
}


// ========================================
// AI-ENHANCED TRAINING PLAN GENERATOR
// ========================================

let trainingPlanState = {
    employeeName: '',
    position: '',
    experience: '',
    duration: 0,
    focusAreas: '',
    plan: null,
    planId: null
};

// Main Functions
function openTrainingPlan() {
    const modal = document.getElementById('trainingPlanModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    loadTrainingProgress();
    
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('trainingPlanGenerator');
    }
}

function closeTrainingPlan() {
    const modal = document.getElementById('trainingPlanModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Update role information
function updateTrainingRoleInfo() {
    const position = document.getElementById('trainingPosition').value;
    const infoBox = document.getElementById('roleInfoBox');
    const infoContent = document.getElementById('roleInfoContent');
    
    if (!position) {
        infoBox.classList.add('hidden');
        return;
    }
    
    const roleInfo = {
        'head-chef': 'Requires advanced culinary skills, leadership abilities, menu planning, and kitchen management. Typical training: 4-8 weeks.',
        'sous-chef': 'Needs strong cooking skills, team coordination, and ability to manage kitchen operations. Typical training: 4-8 weeks.',
        'chef-de-partie': 'Must master specific kitchen station, timing, and quality control. Typical training: 2-4 weeks.',
        'commis-chef': 'Entry-level chef position requiring basic culinary skills and kitchen procedures. Typical training: 2-4 weeks.',
        'kitchen-hand': 'Focuses on cleaning, basic prep work, and supporting kitchen operations. Typical training: 1-2 weeks.',
        'restaurant-manager': 'Requires leadership, operations management, customer service, and P&L understanding. Typical training: 4-12 weeks.',
        'floor-supervisor': 'Needs team management, service coordination, and problem-solving skills. Typical training: 2-4 weeks.',
        'waiter': 'Requires menu knowledge, service skills, POS system, and customer interaction. Typical training: 1-2 weeks.',
        'bartender': 'Needs drink preparation skills, customer service, RSA certification, and bar management. Typical training: 2-4 weeks.',
        'barista': 'Requires coffee-making skills, machine operation, customer service, and product knowledge. Typical training: 1-2 weeks.',
        'host': 'Focuses on greeting guests, reservations, seating coordination, and customer service. Typical training: 1 week.',
        'cleaner': 'Requires knowledge of cleaning standards, chemical safety, and efficiency. Typical training: 1 week.',
        'dishwasher': 'Needs efficiency, hygiene practices, and equipment operation skills. Typical training: 1 week.',
        'delivery-driver': 'Requires safe driving, customer service, order accuracy, and time management. Typical training: 1 week.'
    };
    
    if (roleInfo[position]) {
        infoContent.textContent = roleInfo[position];
        infoBox.classList.remove('hidden');
    }
}

// Generate Training Plan
async function generateTrainingPlan() {
    const employeeName = document.getElementById('trainingEmployeeName').value.trim();
    const position = document.getElementById('trainingPosition').value;
    const experience = document.getElementById('trainingExperience').value;
    const duration = document.getElementById('trainingDuration').value;
    const focusAreas = document.getElementById('trainingFocusAreas').value.trim();
    
    // Validation
    if (!employeeName || !position || !experience || !duration) {
        showAlert('Please fill in all required fields');
        return;
    }
    
    // Save to state
    trainingPlanState = {
        employeeName,
        position,
        experience,
        duration: parseInt(duration),
        focusAreas,
        planId: 'training_' + Date.now(),
        plan: null
    };
    
    // Show loading
    showTrainingAIThinking();
    
    try {
        // Get AI insights
        const insights = await getTrainingAIInsights();
        displayTrainingInsights(insights);
        
        // Generate the plan
        const plan = buildTrainingPlan();
        trainingPlanState.plan = plan;
        
        // Display the plan
        displayTrainingPlan(plan);
        
        // Show action buttons
        document.getElementById('trainingActions').classList.remove('hidden');
        document.getElementById('trainingCoachSection').classList.remove('hidden');
        
    } catch (error) {
        showAlert('Failed to generate training plan. Please try again.');
    }
}

function showTrainingAIThinking() {
    const insightsBox = document.getElementById('trainingAIInsights');
    const content = document.getElementById('trainingAIContent');
    
    content.innerHTML = '<div class="ai-thinking-training">ðŸ¤– Analyzing role requirements and generating personalized training plan</div>';
    insightsBox.classList.remove('hidden');
}

// Get AI Insights
async function getTrainingAIInsights() {
    const positionName = document.getElementById('trainingPosition').selectedOptions[0].text;
    const prompt = `As an Australian hospitality training expert, provide 3 key insights for training a ${trainingPlanState.experience} ${positionName} over ${trainingPlanState.duration} weeks. ${trainingPlanState.focusAreas ? 'Focus areas: ' + trainingPlanState.focusAreas : ''}

Provide:
1. Critical skills to prioritize
2. Common training challenges for this role
3. Success indicators

Be specific to Australian hospitality and practical.`;
    
    try {
        const response = await callClaudeAPI(prompt);
        return response;
    } catch (error) {
        return getFallbackInsights();
    }
}

function getFallbackInsights() {
    const positionName = document.getElementById('trainingPosition').selectedOptions[0].text;
    return `For ${trainingPlanState.experience} ${positionName}:

â€¢ Start with compliance and safety - WHS, food safety (if applicable), RSA (if applicable)
â€¢ Focus on hands-on practice rather than theory - hospitality is learned by doing
â€¢ Build confidence gradually - start with supervision, progress to independence
â€¢ Key success indicator: Can perform core duties independently by end of training`;
}

function displayTrainingInsights(insights) {
    const content = document.getElementById('trainingAIContent');
    content.innerHTML = insights.replace(/\n/g, '<br>');
}

// Build Training Plan
function buildTrainingPlan() {
    const weeks = trainingPlanState.duration;
    const position = trainingPlanState.position;
    const experience = trainingPlanState.experience;
    
    const plan = {
        weeks: []
    };
    
    // Generate week-by-week plan
    for (let weekNum = 1; weekNum <= weeks; weekNum++) {
        plan.weeks.push(generateWeek(weekNum, weeks, position, experience));
    }
    
    return plan;
}

function generateWeek(weekNum, totalWeeks, position, experience) {
    const isFirstWeek = weekNum === 1;
    const isLastWeek = weekNum === totalWeeks;
    
    const week = {
        number: weekNum,
        title: getWeekTitle(weekNum, totalWeeks),
        days: []
    };
    
    // Generate 5 days per week (Mon-Fri)
    for (let dayNum = 1; dayNum <= 5; dayNum++) {
        week.days.push(generateDay(dayNum, weekNum, totalWeeks, position, experience));
    }
    
    return week;
}

function getWeekTitle(weekNum, totalWeeks) {
    if (weekNum === 1) return 'Induction & Foundations';
    if (weekNum === totalWeeks) return 'Mastery & Assessment';
    if (weekNum === 2) return 'Core Skills Development';
    if (weekNum <= totalWeeks / 2) return 'Skill Building';
    return 'Advanced Training';
}

function generateDay(dayNum, weekNum, totalWeeks, position, experience) {
    const globalDay = (weekNum - 1) * 5 + dayNum;
    const isFirstDay = globalDay === 1;
    const isLastDay = globalDay === (totalWeeks * 5);
    
    const day = {
        number: dayNum,
        title: getDayTitle(dayNum, weekNum, globalDay, isFirstDay, isLastDay),
        activities: []
    };
    
    // Add activities based on day and role
    day.activities = generateActivities(dayNum, weekNum, globalDay, position, experience, isFirstDay, isLastDay, totalWeeks);
    
    return day;
}

function getDayTitle(dayNum, weekNum, globalDay, isFirstDay, isLastDay) {
    if (isFirstDay) return 'Welcome & Induction';
    if (isLastDay) return 'Final Assessment';
    if (weekNum === 1 && dayNum === 5) return 'Week 1 Review';
    if (weekNum > 1 && dayNum === 1) return 'Week Goals & Planning';
    if (dayNum === 5) return 'Weekly Review';
    
    const titles = {
        2: 'Foundational Training',
        3: 'Practical Application',
        4: 'Skill Development'
    };
    
    return titles[dayNum] || 'Training Day';
}

function generateActivities(dayNum, weekNum, globalDay, position, experience, isFirstDay, isLastDay, totalWeeks) {
    const activities = [];
    
    // First day - induction
    if (isFirstDay) {
        activities.push(
            { type: 'theory', title: 'Welcome & Paperwork', description: 'Complete all onboarding paperwork, tax forms, super choice', duration: '1 hour' },
            { type: 'theory', title: 'WHS & Safety Training', description: 'Workplace health & safety, emergency procedures, safe work practices', duration: '1.5 hours' },
            { type: 'shadowing', title: 'Venue Tour', description: 'Complete tour of venue, meet the team, understand layout', duration: '45 mins' },
            { type: 'theory', title: 'Role Overview', description: 'Understand position responsibilities, expectations, standards', duration: '1 hour' }
        );
        return activities;
    }
    
    // Last day - final assessment
    if (isLastDay) {
        activities.push(
            { type: 'practical', title: 'Practical Skills Demonstration', description: 'Demonstrate all key competencies learned during training', duration: '2 hours' },
            { type: 'assessment', title: 'Knowledge Assessment', description: 'Written or verbal assessment of role knowledge', duration: '30 mins' },
            { type: 'assessment', title: 'Performance Review', description: 'Final feedback session, discuss strengths and areas for growth', duration: '45 mins' },
            { type: 'assessment', title: 'Training Completion', description: 'Sign off training, receive certification, plan ongoing development', duration: '45 mins' }
        );
        return activities;
    }
    
    // Role-specific activities
    if (position.includes('chef') || position.includes('kitchen')) {
        activities.push(...getKitchenActivities(dayNum, weekNum, globalDay, experience, totalWeeks));
    } else if (position.includes('waiter') || position.includes('host') || position.includes('supervisor')) {
        activities.push(...getFrontOfHouseActivities(dayNum, weekNum, globalDay, experience, totalWeeks));
    } else if (position.includes('bartender') || position.includes('barista')) {
        activities.push(...getBarActivities(dayNum, weekNum, globalDay, experience, position, totalWeeks));
    } else if (position === 'restaurant-manager') {
        activities.push(...getManagerActivities(dayNum, weekNum, globalDay, experience, totalWeeks));
    } else {
        activities.push(...getGeneralActivities(dayNum, weekNum, globalDay, experience, totalWeeks));
    }
    
    return activities;
}

function getKitchenActivities(dayNum, weekNum, globalDay, experience, totalWeeks) {
    if (weekNum === 1) {
        return [
            { type: 'theory', title: 'Food Safety Certification', description: 'Complete food handler certificate, understand HACCP principles', duration: '2 hours' },
            { type: 'shadowing', title: 'Kitchen Operations', description: 'Shadow experienced chef, observe mise en place and service', duration: '3 hours' },
            { type: 'practical', title: 'Basic Prep Work', description: 'Practice knife skills, basic prep techniques with supervision', duration: '2 hours' }
        ];
    }
    
    if (weekNum === 2 || (totalWeeks >= 4 && weekNum <= 3)) {
        return [
            { type: 'practical', title: 'Station Training', description: 'Work specific station (grill, fry, garde manger, etc) with supervision', duration: '3 hours' },
            { type: 'practical', title: 'Service Practice', description: 'Participate in service, build speed and consistency', duration: '3 hours' },
            { type: 'theory', title: 'Menu Knowledge', description: 'Learn all menu items, ingredients, allergens, cooking methods', duration: '1 hour' }
        ];
    }
    
    return [
        { type: 'practical', title: 'Independent Station Work', description: 'Run station independently during service with minimal supervision', duration: '4 hours' },
        { type: 'practical', title: 'Quality Control', description: 'Maintain presentation and taste standards, plate dishes correctly', duration: '2 hours' },
        { type: 'assessment', title: 'Skills Check', description: 'Supervisor assesses speed, quality, and consistency', duration: '1 hour' }
    ];
}

function getFrontOfHouseActivities(dayNum, weekNum, globalDay, experience, totalWeeks) {
    if (weekNum === 1) {
        return [
            { type: 'theory', title: 'Customer Service Standards', description: 'Learn service standards, greeting guests, handling requests', duration: '1.5 hours' },
            { type: 'theory', title: 'POS System Training', description: 'Learn point of sale system, order entry, payments, table management', duration: '2 hours' },
            { type: 'shadowing', title: 'Service Shadowing', description: 'Shadow experienced waiter, observe full service cycle', duration: '3 hours' },
            { type: 'theory', title: 'Menu & Beverage Knowledge', description: 'Study menu items, wine list, cocktails, dietary requirements', duration: '1.5 hours' }
        ];
    }
    
    if (weekNum === 2 || (totalWeeks >= 4 && weekNum <= 3)) {
        return [
            { type: 'practical', title: 'Taking Orders', description: 'Practice taking orders, making recommendations, upselling', duration: '2 hours' },
            { type: 'practical', title: 'Service Practice', description: 'Serve tables with supervision, manage small section', duration: '3 hours' },
            { type: 'theory', title: 'Difficult Situations', description: 'Learn to handle complaints, special requests, challenging customers', duration: '1 hour' }
        ];
    }
    
    return [
        { type: 'practical', title: 'Full Section Service', description: 'Manage full section independently during service', duration: '4 hours' },
        { type: 'practical', title: 'Wine Service', description: 'Practice wine service, presentation, handling special occasions', duration: '1.5 hours' },
        { type: 'assessment', title: 'Service Quality Check', description: 'Manager observes and provides feedback on service quality', duration: '30 mins' }
    ];
}

function getBarActivities(dayNum, weekNum, globalDay, experience, position, totalWeeks) {
    const isBarista = position.includes('barista');
    
    if (weekNum === 1) {
        return [
            { type: 'theory', title: isBarista ? 'Coffee Knowledge' : 'RSA Certification', description: isBarista ? 'Learn coffee types, extraction, milk texturing basics' : 'Complete Responsible Service of Alcohol certification', duration: '2 hours' },
            { type: 'shadowing', title: isBarista ? 'Machine Operation' : 'Bar Operations', description: isBarista ? 'Shadow barista, observe machine use, workflow, cleaning' : 'Shadow bartender, observe service flow, drink preparation', duration: '3 hours' },
            { type: 'practical', title: 'Basic Preparation', description: isBarista ? 'Practice espresso shots, milk steaming with supervision' : 'Learn basic drinks, garnishes, glassware', duration: '2 hours' }
        ];
    }
    
    if (weekNum === 2 || (totalWeeks >= 4 && weekNum <= 3)) {
        return [
            { type: 'practical', title: 'Drink Preparation', description: isBarista ? 'Make all coffee styles, practice latte art' : 'Prepare full range of cocktails and mixed drinks', duration: '3 hours' },
            { type: 'practical', title: 'Customer Service', description: 'Serve customers, take orders, process payments', duration: '2 hours' },
            { type: 'practical', title: 'Speed & Consistency', description: 'Build speed while maintaining quality standards', duration: '2 hours' }
        ];
    }
    
    return [
        { type: 'practical', title: 'Independent Service', description: 'Work independently during busy periods', duration: '4 hours' },
        { type: 'practical', title: isBarista ? 'Advanced Techniques' : 'Inventory Management', description: isBarista ? 'Advanced latte art, alternative brewing methods' : 'Stock control, ordering, wastage reduction', duration: '2 hours' },
        { type: 'assessment', title: 'Skills Assessment', description: 'Demonstrate speed, quality, and customer service skills', duration: '1 hour' }
    ];
}

function getManagerActivities(dayNum, weekNum, globalDay, experience, totalWeeks) {
    if (weekNum === 1) {
        return [
            { type: 'theory', title: 'Operations Overview', description: 'Understand all business operations, systems, procedures', duration: '2 hours' },
            { type: 'shadowing', title: 'Management Shadowing', description: 'Shadow current manager through full shift cycle', duration: '4 hours' },
            { type: 'theory', title: 'Team & Roster', description: 'Learn team structure, roster system, staff management', duration: '1.5 hours' }
        ];
    }
    
    if (weekNum === 2 || (totalWeeks >= 4 && weekNum <= 3)) {
        return [
            { type: 'practical', title: 'Floor Management', description: 'Manage floor during service with support', duration: '3 hours' },
            { type: 'theory', title: 'Financials & Reporting', description: 'Learn POS reports, daily takings, cost control basics', duration: '2 hours' },
            { type: 'practical', title: 'Staff Coordination', description: 'Brief staff, delegate tasks, problem-solve issues', duration: '2 hours' }
        ];
    }
    
    return [
        { type: 'practical', title: 'Independent Management', description: 'Manage shift independently, make decisions, handle escalations', duration: '4 hours' },
        { type: 'practical', title: 'Performance Management', description: 'Provide staff feedback, conduct reviews, training', duration: '2 hours' },
        { type: 'assessment', title: 'Management Review', description: 'Senior manager assesses decision-making and leadership', duration: '1 hour' }
    ];
}

function getGeneralActivities(dayNum, weekNum, globalDay, experience, totalWeeks) {
    if (weekNum === 1) {
        return [
            { type: 'theory', title: 'Role Training', description: 'Learn specific role duties, procedures, and standards', duration: '2 hours' },
            { type: 'shadowing', title: 'Job Shadowing', description: 'Shadow experienced team member, observe best practices', duration: '3 hours' },
            { type: 'practical', title: 'Basic Tasks', description: 'Practice core tasks with supervision and guidance', duration: '2 hours' }
        ];
    }
    
    return [
        { type: 'practical', title: 'Supervised Work', description: 'Perform role duties with supervision and support', duration: '4 hours' },
        { type: 'practical', title: 'Skill Building', description: 'Focus on efficiency, quality, and consistency', duration: '2 hours' },
        { type: 'assessment', title: 'Progress Check', description: 'Review progress, provide feedback, address questions', duration: '1 hour' }
    ];
}

// Display Training Plan
function displayTrainingPlan(plan) {
    const container = document.getElementById('trainingPlanDisplay');
    
    let html = '';
    
    plan.weeks.forEach(week => {
        html += `
            <div class="training-week">
                <h3 class="text-xl font-bold text-white mb-4">Week ${week.number}: ${week.title}</h3>
        `;
        
        week.days.forEach(day => {
            html += `
                <div class="training-day">
                    <div class="text-lg font-semibold text-amber-500 mb-3">Day ${day.number}: ${day.title}</div>
                    <div class="space-y-2">
            `;
            
            day.activities.forEach(activity => {
                const iconClass = `icon-${activity.type}`;
                const icon = {
                    'theory': 'ðŸ“š',
                    'practical': 'ðŸ”§',
                    'assessment': 'âœ…',
                    'shadowing': 'ðŸ‘¥'
                }[activity.type] || 'ðŸ“‹';
                
                html += `
                    <div class="training-activity">
                        <div class="activity-icon ${iconClass}">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-duration">â±ï¸ ${activity.duration}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    });
    
    container.innerHTML = html;
    container.classList.remove('hidden');
}

// AI Training Coach
async function askTrainingCoach() {
    const question = document.getElementById('trainingCoachInput').value.trim();
    
    if (!question) {
        showAlert('Please enter a question');
        return;
    }
    
    const responseBox = document.getElementById('trainingCoachResponse');
    const responseContent = document.getElementById('trainingCoachContent');
    
    responseBox.classList.remove('hidden');
    responseContent.innerHTML = '<div class="ai-thinking-training">ðŸ¤– Thinking</div>';
    
    try {
        const positionName = document.getElementById('trainingPosition').selectedOptions[0].text;
        const context = `Training plan for ${trainingPlanState.experience} ${positionName} over ${trainingPlanState.duration} weeks`;
        const prompt = `As an Australian hospitality training expert, answer this question:\n\nContext: ${context}\n\nQuestion: ${question}\n\nProvide practical, specific advice.`;
        
        const answer = await callClaudeAPI(prompt);
        responseContent.innerHTML = answer.replace(/\n/g, '<br>');
        
        document.getElementById('trainingCoachInput').value = '';
    } catch (error) {
        responseContent.innerHTML = 'Sorry, I encountered an error. Please try again.';
    }
}

// Save/Load Functions
function saveTrainingPlan() {
    if (!trainingPlanState.plan) {
        showAlert('Please generate a training plan first');
        return;
    }
    
    try {
        localStorage.setItem('training_plan_' + trainingPlanState.planId, JSON.stringify(trainingPlanState));
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Training plan saved', 'success');
        } else {
            showAlert('âœ… Training plan saved');
        }
    } catch (error) {
        showAlert('Failed to save training plan');
    }
}

function loadTrainingProgress() {
    const keys = Object.keys(localStorage).filter(k => k.startsWith('training_plan_'));
    if (keys.length === 0) return;
    
    try {
        const latestKey = keys[keys.length - 1];
        const data = JSON.parse(localStorage.getItem(latestKey));
        
        if (data) {
            trainingPlanState = data;
            
            // Populate form
            if (data.employeeName) document.getElementById('trainingEmployeeName').value = data.employeeName;
            if (data.position) document.getElementById('trainingPosition').value = data.position;
            if (data.experience) document.getElementById('trainingExperience').value = data.experience;
            if (data.duration) document.getElementById('trainingDuration').value = data.duration.toString();
            if (data.focusAreas) document.getElementById('trainingFocusAreas').value = data.focusAreas;
            
            if (data.plan) {
                displayTrainingPlan(data.plan);
                document.getElementById('trainingActions').classList.remove('hidden');
                document.getElementById('trainingCoachSection').classList.remove('hidden');
            }
        }
    } catch (error) {
    }
}

// Export Functions
function exportTrainingPlanDOCX() {
    if (!trainingPlanState.plan) {
        showAlert('Please generate a training plan first');
        return;
    }
    
    try {
        const html = buildTrainingPlanHTML();
        const converted = htmlDocx.asBlob(html);
        const positionName = document.getElementById('trainingPosition').selectedOptions[0].text.replace(/\s+/g, '_');
        const filename = `Training_Plan_${positionName}_${Date.now()}.docx`;
        
        saveAs(converted, filename);
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Training plan downloaded as DOCX', 'success');
        }
    } catch (error) {
        showAlert('Failed to generate DOCX. Please try again.');
    }
}

function exportTrainingPlanPDF() {
    if (!trainingPlanState.plan) {
        showAlert('Please generate a training plan first');
        return;
    }
    
    try {
        const docDefinition = buildTrainingPlanPDFDefinition();
        const positionName = document.getElementById('trainingPosition').selectedOptions[0].text.replace(/\s+/g, '_');
        const filename = `Training_Plan_${positionName}_${Date.now()}.pdf`;
        
        pdfMake.createPdf(docDefinition).download(filename);
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Training plan downloaded as PDF', 'success');
        }
    } catch (error) {
        showAlert('Failed to generate PDF. Please try again.');
    }
}

function printTrainingPlan() {
    if (!trainingPlanState.plan) {
        showAlert('Please generate a training plan first');
        return;
    }
    
    window.print();
}

// Build HTML for DOCX export
function buildTrainingPlanHTML() {
    const today = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    const positionName = document.getElementById('trainingPosition').selectedOptions[0].text;
    const plan = trainingPlanState.plan;
    
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; color: #000; }
                h1 { color: #2c3e50; border-bottom: 3px solid #f39c12; padding-bottom: 10px; margin-bottom: 20px; }
                h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #bdc3c7; padding-bottom: 5px; }
                h3 { color: #667eea; margin-top: 20px; }
                .info-box { background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
                .info-box p { margin: 5px 0; }
                .week { margin: 30px 0; page-break-inside: avoid; }
                .day { margin: 20px 0; padding: 15px; border-left: 4px solid #667eea; background: #f8f9fa; }
                .activity { margin: 10px 0; padding: 10px; background: white; border-left: 3px solid #95a5a6; }
                .activity-title { font-weight: bold; color: #2c3e50; }
                .activity-description { color: #555; margin: 5px 0; }
                .activity-duration { color: #f39c12; font-size: 14px; font-weight: 600; }
                .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #bdc3c7; text-align: center; color: #7f8c8d; font-size: 12px; }
            </style>
        </head>
        <body>
            <h1>Training Plan: ${positionName}</h1>
            
            <div class="info-box">
                <p><strong>Employee Name:</strong> ${trainingPlanState.employeeName}</p>
                <p><strong>Position:</strong> ${positionName}</p>
                <p><strong>Experience Level:</strong> ${trainingPlanState.experience}</p>
                <p><strong>Training Duration:</strong> ${trainingPlanState.duration} weeks</p>
                ${trainingPlanState.focusAreas ? `<p><strong>Focus Areas:</strong> ${trainingPlanState.focusAreas}</p>` : ''}
            </div>
    `;
    
    plan.weeks.forEach(week => {
        html += `
            <div class="week">
                <h2>Week ${week.number}: ${week.title}</h2>
        `;
        
        week.days.forEach(day => {
            html += `
                <div class="day">
                    <h3>Day ${day.number}: ${day.title}</h3>
            `;
            
            day.activities.forEach(activity => {
                html += `
                    <div class="activity">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-description">${activity.description}</div>
                        <div class="activity-duration">Duration: ${activity.duration}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        
        html += `</div>`;
    });
    
    html += `
            <div class="footer">
                <p>Generated by Fitzgerald HR on ${today}</p>
                <p>This training plan provides a structured approach to employee development</p>
            </div>
        </body>
        </html>
    `;
    
    return html;
}

// Build PDF definition
function buildTrainingPlanPDFDefinition() {
    const today = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    const positionName = document.getElementById('trainingPosition').selectedOptions[0].text;
    const plan = trainingPlanState.plan;
    
    const content = [
        { text: `Training Plan: ${positionName}`, style: 'header', margin: [0, 0, 0, 20] },
        
        {
            table: {
                widths: ['30%', '70%'],
                body: [
                    ['Employee Name:', trainingPlanState.employeeName],
                    ['Position:', positionName],
                    ['Experience Level:', trainingPlanState.experience],
                    ['Training Duration:', `${trainingPlanState.duration} weeks`]
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        }
    ];
    
    plan.weeks.forEach(week => {
        content.push({ text: `Week ${week.number}: ${week.title}`, style: 'weekHeader', margin: [0, 15, 0, 10], pageBreak: week.number > 1 ? 'before' : '' });
        
        week.days.forEach(day => {
            content.push({ text: `Day ${day.number}: ${day.title}`, style: 'dayTitle', margin: [0, 10, 0, 5] });
            
            day.activities.forEach(activity => {
                content.push({
                    stack: [
                        { text: activity.title, style: 'activityTitle' },
                        { text: activity.description, style: 'activityDescription' },
                        { text: `Duration: ${activity.duration}`, style: 'activityDuration' }
                    ],
                    margin: [10, 5, 0, 10]
                });
            });
        });
    });
    
    content.push({
        text: `Generated by Fitzgerald HR on ${today}`,
        style: 'footer',
        margin: [0, 30, 0, 0]
    });
    
    return {
        content: content,
        styles: {
            header: { fontSize: 24, bold: true, color: '#2c3e50' },
            weekHeader: { fontSize: 16, bold: true, color: '#34495e' },
            dayTitle: { fontSize: 14, bold: true, color: '#667eea' },
            activityTitle: { fontSize: 12, bold: true },
            activityDescription: { fontSize: 10, color: '#555' },
            activityDuration: { fontSize: 10, color: '#f39c12', italics: true },
            footer: { fontSize: 10, color: '#95a5a6', alignment: 'center' }
        },
        defaultStyle: { font: 'Helvetica' }
    };
}


// ========================================
// PROBATION CHECK-IN BUILDER
// ========================================

let probationCheckInState = {
    currentStep: 1,
    totalSteps: 6,
    data: {},
    generatedDocument: null,
    isGenerating: false
};

const probationWizardSteps = [
    // Step 1: Procedural Fairness
    {
        id: 1,
        title: "Procedural Fairness & Meeting Preparation",
        infoBox: {
            type: 'info',
            icon: 'âš–ï¸',
            title: 'Why Procedural Fairness Matters',
            content: `<p class="mb-2">A probation check-in is a <strong>supportive conversation</strong> designed to help new employees succeed. To ensure fairness and transparency:</p>
            <ul class="list-disc pl-5 space-y-1 text-sm">
                <li>The employee should know in advance this meeting is happening and its purpose</li>
                <li>They should be given the opportunity to prepare their own reflections</li>
                <li>The conversation must be two-way â€” the employee's perspective matters</li>
                <li>Any concerns raised must be specific, factual and supported by examples</li>
                <li>The employee must be offered support and a clear path to improvement</li>
                <li>Both the employee and leader retain a copy of the completed document</li>
            </ul>
            <p class="mt-2 text-amber-400 font-semibold text-sm">This is NOT a disciplinary meeting. It is a development and support conversation.</p>`
        },
        fields: [
            {
                name: "noticeGiven",
                label: "Has the employee been given reasonable notice of this probation check-in meeting (at least 24 hours)?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            },
            {
                name: "purposeExplained",
                label: "Has the employee been told the purpose of the meeting (i.e., a probation review to discuss progress, not a disciplinary meeting)?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            },
            {
                name: "supportPersonAdvised",
                label: "Has the employee been advised they may bring a support person if they wish?",
                type: "radio",
                options: ["Yes", "No"],
                required: true
            }
        ]
    },
    // Step 2: Employee & Probation Details
    {
        id: 2,
        title: "Employee & Probation Details",
        fields: [
            { name: "employeeName", label: "Employee's full name", type: "text", required: true, placeholder: "e.g., Sarah Johnson" },
            { name: "position", label: "Position/Role", type: "text", required: true, placeholder: "e.g., Bartender" },
            { name: "employmentType", label: "Employment Type", type: "select",
              options: ["Full-Time", "Part-Time", "Casual"], required: true },
            { name: "startDate", label: "Employment start date", type: "date", required: true },
            { name: "probationEndDate", label: "Probation end date", type: "date", required: true },
            { name: "checkInNumber", label: "Which probation check-in is this?", type: "select",
              options: ["1st Check-In (Month 1)", "2nd Check-In (Month 2)", "3rd Check-In (Month 3)", "4th Check-In (Month 4)", "5th Check-In (Month 5)", "Final Check-In (Month 6 / End of Probation)"],
              required: true },
            { name: "managerName", label: "Manager/Supervisor conducting the review", type: "text", required: true, placeholder: "Your name" }
        ]
    },
    // Step 3: Key Requirements Review
    {
        id: 3,
        title: "Key Role Requirements",
        infoBox: {
            type: 'tip',
            icon: 'ðŸ’¡',
            title: 'Tip',
            content: '<p>List the core requirements of the role that were communicated at hiring. These should be the fundamental expectations the employee needs to meet to pass probation.</p>'
        },
        fields: [
            { name: "keyRequirements", label: "What are the key requirements of this role? (List 3-5 core requirements)",
              type: "textarea", required: true, rows: 4,
              placeholder: "e.g.,\nâ€¢ Consistently arrive on time for all rostered shifts\nâ€¢ Maintain RSA compliance and responsible service practices\nâ€¢ Complete all opening and closing duties to standard\nâ€¢ Work effectively as part of the team\nâ€¢ Follow all food safety and WHS procedures" },
            { name: "requirementsRating", label: "Overall, how is the employee tracking against these requirements?", type: "select",
              options: ["Exceeding expectations", "Meeting expectations", "Partially meeting expectations", "Not meeting expectations"],
              required: true },
            { name: "requirementsComments", label: "Specific comments on requirements (provide examples where possible)",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g., Sarah has been punctual for all shifts except two occasions in week 3. She has completed RSA training and follows service standards well." }
        ]
    },
    // Step 4: Deliverables & Behaviours
    {
        id: 4,
        title: "Role Deliverables & Behaviours",
        infoBox: {
            type: 'tip',
            icon: 'ðŸ’¡',
            title: 'Tip',
            content: '<p>Deliverables are the tangible outputs expected. Behaviours relate to how the employee conducts themselves â€” teamwork, communication, attitude, professionalism. Be specific and use examples.</p>'
        },
        fields: [
            { name: "deliverables", label: "Key deliverables â€” what the employee should be producing/achieving at this stage",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nâ€¢ Independently manage a section of 6 tables\nâ€¢ Accurately process orders through POS system\nâ€¢ Upsell menu items to achieve average spend targets" },
            { name: "deliverablesRating", label: "How is the employee tracking on deliverables?", type: "select",
              options: ["Exceeding expectations", "Meeting expectations", "Partially meeting expectations", "Not meeting expectations"],
              required: true },
            { name: "behaviours", label: "Behavioural expectations â€” how the employee is expected to conduct themselves",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nâ€¢ Positive and professional attitude with guests and team\nâ€¢ Takes initiative and asks questions when unsure\nâ€¢ Communicates effectively during service\nâ€¢ Accepts feedback constructively" },
            { name: "behavioursRating", label: "How is the employee tracking on behaviours?", type: "select",
              options: ["Exceeding expectations", "Meeting expectations", "Partially meeting expectations", "Not meeting expectations"],
              required: true },
            { name: "deliverablesAndBehavioursComments", label: "Specific examples and comments on deliverables and behaviours",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g., Sarah's guest interactions are excellent â€” she's received two positive customer comments. She could improve on communication with kitchen during busy service." }
        ]
    },
    // Step 5: Support & Development
    {
        id: 5,
        title: "Support & Development",
        infoBox: {
            type: 'info',
            icon: 'ðŸ¤',
            title: 'Support is Key',
            content: '<p>Probation is a two-way street. The employee must be given genuine support, training, and regular feedback. Document what has been provided and what additional support is needed.</p>'
        },
        fields: [
            { name: "trainingProvided", label: "What training and support has been provided so far?",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nâ€¢ 3-day induction program completed\nâ€¢ Buddy assigned (James - Senior Bartender)\nâ€¢ RSA training completed\nâ€¢ POS system training completed\nâ€¢ Menu knowledge sessions x2" },
            { name: "additionalTrainingNeeded", label: "What additional training or support does the employee need?",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nâ€¢ Cocktail masterclass for premium drinks\nâ€¢ Advanced POS functions (split bills, modifications)\nâ€¢ Cellar and wine knowledge training" },
            { name: "oneOnOneFrequency", label: "How often are you having one-on-one check-ins?", type: "select",
              options: ["Weekly", "Fortnightly", "Monthly", "Ad hoc / as needed", "Not currently scheduled"],
              required: true },
            { name: "oneOnOneComments", label: "Comments on one-on-one meetings and feedback provided",
              type: "textarea", required: false, rows: 2,
              placeholder: "e.g., Weekly 15-min catch-ups on Mondays before shift. Employee is receptive to feedback." },
            { name: "employeeFeedback", label: "Has the employee raised any concerns, questions, or feedback?",
              type: "textarea", required: false, rows: 2,
              placeholder: "e.g., Sarah mentioned she'd like more exposure to cocktail making. No concerns raised about the role or team." }
        ]
    },
    // Step 6: Overall Assessment & Next Steps
    {
        id: 6,
        title: "Overall Assessment & Next Steps",
        fields: [
            { name: "overallAssessment", label: "Overall probation assessment at this stage", type: "select",
              options: [
                "On track â€” progressing well, no concerns",
                "On track with minor areas for development",
                "At risk â€” some concerns that need to be addressed",
                "Significant concerns â€” improvement plan required",
                "Final check-in: Recommend confirming employment",
                "Final check-in: Recommend extending probation",
                "Final check-in: Recommend ending employment"
              ],
              required: true },
            { name: "areasOfStrength", label: "Key areas of strength to acknowledge",
              type: "textarea", required: true, rows: 2,
              placeholder: "e.g., Excellent customer interactions, strong work ethic, reliable attendance" },
            { name: "areasForImprovement", label: "Areas for improvement (if any) â€” be specific",
              type: "textarea", required: false, rows: 2,
              placeholder: "e.g., Needs to improve speed of service during peak periods, could be more proactive in asking for tasks during quiet periods" },
            { name: "agreedActions", label: "Agreed actions for the next period (for both employee AND leader)",
              type: "textarea", required: true, rows: 3,
              placeholder: "e.g.,\nEmployee:\nâ€¢ Focus on speed of service during Friday/Saturday peaks\nâ€¢ Complete cocktail training by end of month\n\nLeader:\nâ€¢ Arrange cocktail masterclass with Head Bartender\nâ€¢ Continue weekly check-ins\nâ€¢ Provide real-time feedback during busy shifts" },
            { name: "nextCheckInDate", label: "Next probation check-in date", type: "date", required: true },
            { name: "additionalNotes", label: "Any additional notes or comments",
              type: "textarea", required: false, rows: 2 }
        ]
    }
];

// ========================================
// PROBATION CHECK-IN - CORE FUNCTIONS
// ========================================

function openProbationCheckIn() {
    const modal = document.getElementById('probationCheckInModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    // Reset state
    probationCheckInState.currentStep = 1;
    probationCheckInState.data = {};
    probationCheckInState.generatedDocument = null;
    probationCheckInState.isGenerating = false;
    
    // Show wizard, hide generating
    document.getElementById('probationGenerating').classList.add('hidden');
    document.getElementById('probationStepContent').classList.remove('hidden');
    document.getElementById('probationProgressSection').classList.remove('hidden');
    document.getElementById('probationNextBtn').classList.remove('hidden');
    document.getElementById('probationBackBtn').style.display = 'none';
    
    showProbationStep(1);
    
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('probationCheckIn');
    }
}

function closeProbationCheckIn() {
    const modal = document.getElementById('probationCheckInModal');
    if (modal) modal.classList.add('hidden');
}

function closeProbationPreview() {
    document.getElementById('probationPreviewModal').classList.add('hidden');
}

function resetProbationCheckIn() {
    if (!confirm('Start over? This will clear all your entered information.')) return;
    probationCheckInState.currentStep = 1;
    probationCheckInState.data = {};
    probationCheckInState.generatedDocument = null;
    
    document.getElementById('probationGenerating').classList.add('hidden');
    document.getElementById('probationStepContent').classList.remove('hidden');
    document.getElementById('probationProgressSection').classList.remove('hidden');
    document.getElementById('probationNextBtn').classList.remove('hidden');
    
    showProbationStep(1);
}

// ========================================
// PROBATION CHECK-IN - STEP RENDERING
// ========================================

function showProbationStep(stepNumber) {
    const step = probationWizardSteps[stepNumber - 1];
    if (!step) return;
    
    probationCheckInState.currentStep = stepNumber;
    
    // Update progress
    document.getElementById('probationCurrentStep').textContent = stepNumber;
    document.getElementById('probationTotalSteps').textContent = probationCheckInState.totalSteps;
    const progress = Math.round((stepNumber / probationCheckInState.totalSteps) * 100);
    document.getElementById('probationProgress').textContent = `${progress}% Complete`;
    document.getElementById('probationProgressBar').style.width = `${progress}%`;
    
    // Build step HTML
    let html = `<h3 class="text-xl font-bold text-white mb-4">${step.title}</h3>`;
    
    // Add info box if present
    if (step.infoBox) {
        const bgColor = step.infoBox.type === 'info' ? 'bg-blue-500/10 border-blue-500/30' : 'bg-amber-500/10 border-amber-500/30';
        const textColor = step.infoBox.type === 'info' ? 'text-blue-300' : 'text-amber-300';
        html += `
            <div class="${bgColor} border rounded-lg p-4 mb-6">
                <p class="${textColor} font-semibold mb-2 flex items-center gap-2">
                    <span>${step.infoBox.icon}</span> ${step.infoBox.title}
                </p>
                <div class="${textColor} text-sm">${step.infoBox.content}</div>
            </div>
        `;
    }
    
    html += '<div class="space-y-4">';
    
    step.fields.forEach(field => {
        html += '<div>';
        html += `<label class="block text-slate-300 text-sm mb-2">
                    ${field.label}${field.required ? ' <span class="text-red-400">*</span>' : ''}
                 </label>`;
        
        const savedValue = probationCheckInState.data[field.name] || '';
        
        if (field.type === 'text') {
            html += `<input type="text" id="prob_${field.name}" 
                           placeholder="${field.placeholder || ''}"
                           value="${savedValue}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="prob_${field.name}" rows="${field.rows || 3}"
                              placeholder="${field.placeholder || ''}"
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none"
                              ${field.required ? 'required' : ''}>${savedValue}</textarea>`;
        } else if (field.type === 'select') {
            html += `<select id="prob_${field.name}" 
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none"
                            ${field.required ? 'required' : ''}>
                        <option value="">Select...</option>`;
            field.options.forEach(opt => {
                const selected = savedValue === opt ? 'selected' : '';
                html += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            html += '</select>';
        } else if (field.type === 'radio') {
            field.options.forEach(opt => {
                const checked = savedValue === opt ? 'checked' : '';
                html += `<label class="flex items-center gap-2 text-slate-300 mb-2 cursor-pointer">
                            <input type="radio" name="prob_${field.name}" value="${opt}" ${checked}
                                   class="text-amber-500 focus:ring-amber-500">
                            <span>${opt}</span>
                         </label>`;
            });
        } else if (field.type === 'date') {
            const today = new Date().toISOString().split('T')[0];
            html += `<input type="date" id="prob_${field.name}" 
                           value="${savedValue || today}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none"
                           ${field.required ? 'required' : ''}>`;
        } else if (field.type === 'number') {
            html += `<input type="number" id="prob_${field.name}" 
                           min="${field.min || 0}" max="${field.max || 100}"
                           placeholder="${field.placeholder || ''}"
                           value="${savedValue}"
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none"
                           ${field.required ? 'required' : ''}>`;
        }
        
        html += '</div>';
    });
    
    html += '</div>';
    
    document.getElementById('probationStepContent').innerHTML = html;
    
    // Show/hide back button
    document.getElementById('probationBackBtn').style.display = stepNumber > 1 ? 'block' : 'none';
    
    // Show/hide start over button
    const startOverBtn = document.getElementById('probationStartOverBtn');
    if (startOverBtn) {
        startOverBtn.classList.toggle('hidden', stepNumber <= 1);
    }
    
    // Update next button text
    const nextBtn = document.getElementById('probationNextBtn');
    if (stepNumber === probationCheckInState.totalSteps) {
        nextBtn.innerHTML = 'âœ¨ Generate Document';
    } else {
        nextBtn.innerHTML = 'Next Step â†’';
    }
}

// ========================================
// PROBATION CHECK-IN - NAVIGATION & VALIDATION
// ========================================

function probationWizardNext() {
    const step = probationWizardSteps[probationCheckInState.currentStep - 1];
    let allValid = true;
    
    // Save field values
    step.fields.forEach(field => {
        let value;
        if (field.type === 'radio') {
            const radio = document.querySelector(`input[name="prob_${field.name}"]:checked`);
            value = radio ? radio.value : '';
        } else {
            const element = document.getElementById(`prob_${field.name}`);
            value = element ? element.value.trim() : '';
        }
        
        if (field.required && !value) {
            allValid = false;
        }
        
        probationCheckInState.data[field.name] = value;
    });
    
    if (!allValid) {
        showAlert('âš ï¸ Please complete all required fields before continuing.');
        return;
    }
    
    // Procedural fairness validation on Step 1
    if (probationCheckInState.currentStep === 1) {
        if (!validateProbationProceduralFairness()) {
            return;
        }
    }
    
    // Move to next step or generate
    if (probationCheckInState.currentStep < probationCheckInState.totalSteps) {
        probationCheckInState.currentStep++;
        showProbationStep(probationCheckInState.currentStep);
    } else {
        generateProbationCheckInDocument();
    }
}

function probationWizardBack() {
    if (probationCheckInState.currentStep > 1) {
        // Save current step data first
        const step = probationWizardSteps[probationCheckInState.currentStep - 1];
        step.fields.forEach(field => {
            let value;
            if (field.type === 'radio') {
                const radio = document.querySelector(`input[name="prob_${field.name}"]:checked`);
                value = radio ? radio.value : '';
            } else {
                const element = document.getElementById(`prob_${field.name}`);
                value = element ? element.value.trim() : '';
            }
            probationCheckInState.data[field.name] = value;
        });
        
        probationCheckInState.currentStep--;
        showProbationStep(probationCheckInState.currentStep);
    }
}

function validateProbationProceduralFairness() {
    const data = probationCheckInState.data;
    
    if (data.noticeGiven === 'No') {
        showAlert(
            'âš ï¸ REASONABLE NOTICE REQUIRED\n\n' +
            'The employee should be given at least 24 hours notice of this probation check-in meeting.\n\n' +
            'This allows them to:\n' +
            'â€¢ Prepare their own reflections on their progress\n' +
            'â€¢ Think about any questions or concerns they have\n' +
            'â€¢ Arrange a support person if they wish\n\n' +
            'Please schedule the meeting for at least 24 hours from now.'
        );
        probationCheckInState.data.noticeGiven = '';
        showProbationStep(1);
        return false;
    }
    
    if (data.purposeExplained === 'No') {
        showAlert(
            'âš ï¸ PURPOSE MUST BE COMMUNICATED\n\n' +
            'The employee must understand this is a supportive probation review meeting â€” NOT a disciplinary meeting.\n\n' +
            'Please inform the employee that the purpose is to:\n' +
            'â€¢ Review their progress during probation\n' +
            'â€¢ Discuss what\'s going well and any areas for development\n' +
            'â€¢ Agree on support and next steps\n\n' +
            'Please communicate this to the employee before continuing.'
        );
        probationCheckInState.data.purposeExplained = '';
        showProbationStep(1);
        return false;
    }
    
    if (data.supportPersonAdvised === 'No') {
        showAlert(
            'âš ï¸ SUPPORT PERSON OPTION\n\n' +
            'While a probation check-in is supportive in nature, best practice is to advise the employee they may bring a support person if they wish.\n\n' +
            'A support person can be:\n' +
            'â€¢ A colleague\n' +
            'â€¢ A family member or friend\n' +
            'â€¢ A union representative\n\n' +
            'Please advise the employee of this option before continuing.'
        );
        probationCheckInState.data.supportPersonAdvised = '';
        showProbationStep(1);
        return false;
    }
    
    return true;
}

// ========================================
// PROBATION CHECK-IN - AI GENERATION
// ========================================

async function generateProbationCheckInDocument() {
    // Hide wizard, show loading
    document.getElementById('probationStepContent').classList.add('hidden');
    document.getElementById('probationProgressSection').classList.add('hidden');
    document.getElementById('probationNextBtn').classList.add('hidden');
    document.getElementById('probationBackBtn').style.display = 'none';
    document.getElementById('probationStartOverBtn').classList.add('hidden');
    document.getElementById('probationGenerating').classList.remove('hidden');
    
    probationCheckInState.isGenerating = true;
    
    try {
        const prompt = buildProbationCheckInPrompt();
        const response = await callClaudeAPI(prompt);
        
        probationCheckInState.generatedDocument = response;
        
        // Close builder modal
        closeProbationCheckIn();
        
        // Show preview
        showProbationPreview(response);
        
        if (typeof trackEvent === 'function') {
            trackEvent('probation_checkin_generated', {
                user: currentUser,
                employeeName: probationCheckInState.data.employeeName,
                checkInNumber: probationCheckInState.data.checkInNumber
            });
        }
        
    } catch (error) {
        showAlert('âš ï¸ Error generating document. Please try again.');
        
        // Reset to wizard
        document.getElementById('probationGenerating').classList.add('hidden');
        document.getElementById('probationStepContent').classList.remove('hidden');
        document.getElementById('probationProgressSection').classList.remove('hidden');
        document.getElementById('probationNextBtn').classList.remove('hidden');
        showProbationStep(probationCheckInState.currentStep);
    } finally {
        probationCheckInState.isGenerating = false;
    }
}

function buildProbationCheckInPrompt() {
    const data = probationCheckInState.data;
    
    const venueContext = (typeof venueProfile !== 'undefined' && venueProfile.setupComplete) ?
        `Venue: ${venueProfile.venueName} (${venueProfile.venueType}) in ${venueProfile.city}, ${venueProfile.location}` :
        'Australian hospitality venue';
    
    const today = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
    
    return `You are generating a PROBATION CHECK-IN DOCUMENT for Australian hospitality HR.

This is a supportive probation review document â€” NOT a disciplinary document. The purpose is to support a new employee during their probation period by reviewing progress, identifying development needs, and agreeing on support.

VENUE CONTEXT:
${venueContext}
Award: Hospitality Industry (General) Award MA000009
Manager/Reviewer: ${data.managerName || '[Manager Name]'}

EMPLOYEE DETAILS:
- Name: ${data.employeeName}
- Position: ${data.position}
- Employment Type: ${data.employmentType}
- Start Date: ${data.startDate}
- Probation End Date: ${data.probationEndDate}
- Check-In: ${data.checkInNumber}

PROCEDURAL FAIRNESS:
- Reasonable notice given: ${data.noticeGiven}
- Purpose explained: ${data.purposeExplained}
- Support person option advised: ${data.supportPersonAdvised}

KEY ROLE REQUIREMENTS:
${data.keyRequirements}

Requirements Rating: ${data.requirementsRating}
Manager Comments on Requirements: ${data.requirementsComments}

ROLE DELIVERABLES:
${data.deliverables}
Deliverables Rating: ${data.deliverablesRating}

BEHAVIOURAL EXPECTATIONS:
${data.behaviours}
Behaviours Rating: ${data.behavioursRating}

Manager Comments on Deliverables & Behaviours: ${data.deliverablesAndBehavioursComments}

SUPPORT & DEVELOPMENT:
Training Provided: ${data.trainingProvided}
Additional Training Needed: ${data.additionalTrainingNeeded}
One-on-One Frequency: ${data.oneOnOneFrequency}
${data.oneOnOneComments ? `One-on-One Comments: ${data.oneOnOneComments}` : ''}
${data.employeeFeedback ? `Employee Feedback/Concerns: ${data.employeeFeedback}` : ''}

OVERALL ASSESSMENT:
Assessment: ${data.overallAssessment}
Areas of Strength: ${data.areasOfStrength}
${data.areasForImprovement ? `Areas for Improvement: ${data.areasForImprovement}` : 'No specific areas for improvement noted.'}
Agreed Actions: ${data.agreedActions}
Next Check-In Date: ${data.nextCheckInDate}
${data.additionalNotes ? `Additional Notes: ${data.additionalNotes}` : ''}

**CRITICAL FORMATTING REQUIREMENTS:**
1. Use ## for major sections (e.g., ## EMPLOYEE DETAILS)
2. Use blank lines between ALL paragraphs and sections
3. Use **text** for emphasis sparingly
4. For lists, use bullet points with "â€¢ " prefix
5. Structure clearly with proper spacing
6. Separate each major section with a blank line before and after
7. ALWAYS add a space after colons in labels

Generate a complete, professional Probation Check-In document with the following structure:

# PROBATION CHECK-IN RECORD

## DOCUMENT DETAILS

Date of Review: ${today}
Check-In: ${data.checkInNumber}
Reviewer: ${data.managerName}

## EMPLOYEE DETAILS

Full Name: ${data.employeeName}
Position: ${data.position}
Employment Type: ${data.employmentType}
Start Date: ${data.startDate}
Probation End Date: ${data.probationEndDate}

## PROCEDURAL FAIRNESS CONFIRMATION

Confirm each of the following were completed:
â€¢ Employee given reasonable notice of this meeting: ${data.noticeGiven}
â€¢ Employee informed of the meeting purpose (supportive probation review): ${data.purposeExplained}
â€¢ Employee advised they may bring a support person: ${data.supportPersonAdvised}

## KEY ROLE REQUIREMENTS REVIEW

Take the key requirements provided and present each one as a row/item with the manager's assessment. Expand the manager's comments into a professional, specific narrative. Include the overall rating.

## ROLE DELIVERABLES & BEHAVIOURS

Split into two sub-sections:

### Deliverables
Take the deliverables provided and expand into a professional assessment with specific examples.

### Behaviours
Take the behavioural expectations provided and expand into a professional assessment with specific examples.

Include both ratings.

## SUPPORT & DEVELOPMENT

### Training & Support Provided
List training that has been provided.

### Additional Training & Support Required
List what is still needed and when it should be completed.

### One-on-One Meetings & Feedback
Document the current one-on-one meeting schedule, quality of feedback, and any comments.

### Employee Feedback
Document any concerns, questions or feedback the employee has raised. If none, note that the employee was given the opportunity and had no concerns.

## OVERALL ASSESSMENT

Provide a professional narrative summary that:
1. Acknowledges strengths with specific examples
2. Addresses any areas for improvement constructively with specific, actionable guidance
3. Sets clear expectations for the next period
4. Is supportive and development-focused in tone

Overall Probation Status: ${data.overallAssessment}

## AGREED ACTIONS

Split into:

### Employee Actions
List specific, measurable actions for the employee.

### Leader/Manager Actions
List specific support actions the manager commits to providing.

### Timeline
Next check-in date and any milestone dates.

## EMPLOYEE COMMENTS

*Space for the employee to add their own comments, reflections, or feedback during or after the meeting:*

__________________________________________________________________________________
__________________________________________________________________________________
__________________________________________________________________________________

## ACKNOWLEDGEMENT & SIGNATURES

This document records the discussion held on ${today} as part of the probation review process. Both parties acknowledge:

â€¢ This check-in has been conducted fairly and the employee was given the opportunity to respond
â€¢ The agreed actions have been discussed and understood by both parties
â€¢ Both the employee and the manager/leader will retain a copy of this document for their records
â€¢ This document is a supportive development record and does not constitute disciplinary action

Employee Signature: _________________________________ Date: ______________

Employee Name (Print): ${data.employeeName}

Manager Signature: _________________________________ Date: ______________

Manager Name (Print): ${data.managerName}

## DOCUMENT DISTRIBUTION

â˜ Copy provided to employee
â˜ Copy retained by manager/leader for employee file

---

**CONFIDENTIAL** â€” This document contains personal employment information and should be stored securely in accordance with privacy obligations.

IMPORTANT INSTRUCTIONS:
- Expand the brief manager comments into professional, specific narratives while staying factual
- Use a supportive, development-focused tone throughout â€” this is NOT a disciplinary document
- Be specific and constructive in all feedback areas
- Ensure the document reads as a complete, standalone record of the probation check-in
- DO NOT add fictional details â€” only expand and contextualise what was provided
- Make sure the document acknowledges the employee's strengths first before any areas for improvement
- The overall tone should make the employee feel supported and clear about expectations`;
}

// ========================================
// PROBATION CHECK-IN - PREVIEW & DOWNLOAD
// ========================================

function showProbationPreview(generatedDoc) {
    // Use existing convertAIContentToHTML if available
    const formattedHTML = (typeof convertAIContentToHTML === 'function') ?
        convertAIContentToHTML(generatedDoc) : generatedDoc.replace(/\n/g, '<br>');
    
    document.getElementById('probationPreviewContent').innerHTML = formattedHTML;
    document.getElementById('probationPreviewModal').classList.remove('hidden');
}

async function downloadProbationDocument(format = 'pdf') {
    const userAccepts = confirm(
        "ðŸ“„ PROBATION CHECK-IN DOCUMENT\n\n" +
        "Before finalising this document, please ensure:\n\n" +
        "âœ“ All factual details are accurate\n" +
        "âœ“ The employee has had the opportunity to add their comments\n" +
        "âœ“ Both parties sign the document\n" +
        "âœ“ A copy is provided to the employee\n" +
        "âœ“ A copy is retained by the manager for the employee file\n\n" +
        "Click OK to download, or Cancel to return."
    );
    
    if (!userAccepts) return;
    
    try {
        const employeeName = probationCheckInState.data.employeeName || 'Employee';
        const checkIn = probationCheckInState.data.checkInNumber || 'Check-In';
        const checkInShort = checkIn.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_');
        const filename = `Probation_CheckIn_${employeeName.replace(/\s+/g, '_')}_${checkInShort}_${new Date().toISOString().slice(0,10)}`;
        
        const previewElement = document.getElementById('probationPreviewContent');
        if (!previewElement) {
            throw new Error('Preview content not found');
        }
        
        const formattedHTML = previewElement.innerHTML;
        
        if (format === 'pdf') {
            // Use existing PDF generation
            if (typeof convertHTMLToPdfMake === 'function' && typeof pdfMake !== 'undefined') {
                const metadata = {
                    title: `Probation Check-In - ${employeeName}`,
                    documentType: 'Probation Check-In',
                    generatedBy: 'Fitzgerald HR Assistant'
                };
                const docDefinition = convertHTMLToPdfMake(formattedHTML, metadata);
                pdfMake.createPdf(docDefinition).download(`${filename}.pdf`);
            } else {
                // Fallback: print to PDF
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html><head><title>${filename}</title>
                    <style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px;color:#333;line-height:1.6}
                    h1{color:#1a1a2e;border-bottom:3px solid #f59e0b;padding-bottom:10px}
                    h2{color:#2d3748;border-bottom:1px solid #e2e8f0;padding-bottom:5px;margin-top:25px}
                    h3{color:#4a5568;margin-top:15px}</style>
                    </head><body>${formattedHTML}</body></html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        } else {
            // Word document
            if (typeof generateWordDocument === 'function') {
                await generateWordDocument(formattedHTML, `${filename}.docx`);
            } else if (typeof htmlDocx !== 'undefined') {
                const fullHTML = `
                    <html><head><style>
                    body{font-family:Arial,sans-serif;color:#333;line-height:1.6}
                    h1{color:#1a1a2e;border-bottom:3px solid #f59e0b;padding-bottom:10px;font-size:24px}
                    h2{color:#2d3748;border-bottom:1px solid #e2e8f0;padding-bottom:5px;margin-top:20px;font-size:18px}
                    h3{color:#4a5568;margin-top:15px;font-size:16px}
                    p{margin:8px 0}
                    </style></head><body>${formattedHTML}</body></html>
                `;
                const blob = htmlDocx.asBlob(fullHTML);
                saveAs(blob, `${filename}.docx`);
            } else {
                showAlert('Word document generation is not available. Please try PDF instead.');
            }
        }
        
        if (typeof trackEvent === 'function') {
            trackEvent('probation_checkin_downloaded', {
                user: currentUser,
                format: format,
                employeeName: employeeName,
                checkIn: checkIn
            });
        }
        
        // Show reminder toast
        if (typeof showToast === 'function') {
            showToast('ðŸ“„ Remember: Provide a copy to the employee and retain one for your records.', 'info', 5000);
        }
        
    } catch (error) {
        showAlert('âš ï¸ Error downloading document. Please try again.');
    }
}


// ========================================
// ENHANCED CHECKLIST EXPORT FUNCTIONS
// ========================================

// Export to DOCX
function exportChecklistDOCX() {
    if (!onboardingState.checklist || onboardingState.checklist.length === 0) {
        showAlert('Please generate a checklist first');
        return;
    }
    
    try {
        const html = buildChecklistHTML();
        const converted = htmlDocx.asBlob(html);
        const filename = `Onboarding_Checklist_${onboardingState.position.replace(/\s+/g, '_')}_${Date.now()}.docx`;
        
        saveAs(converted, filename);
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Checklist downloaded as DOCX', 'success');
        }
    } catch (error) {
        showAlert('Failed to generate DOCX. Please try again.');
    }
}

// Export to PDF
function exportChecklistPDF() {
    if (!onboardingState.checklist || onboardingState.checklist.length === 0) {
        showAlert('Please generate a checklist first');
        return;
    }
    
    try {
        const element = document.createElement('div');
        element.innerHTML = buildChecklistHTML();
        element.style.backgroundColor = 'white';
        element.style.padding = '40px';
        
        const filename = `Onboarding_Checklist_${onboardingState.position.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
        
        // Use pdfMake which is already loaded
        const docDefinition = buildChecklistPDFDefinition();
        
        pdfMake.createPdf(docDefinition).download(filename);
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Checklist downloaded as PDF', 'success');
        }
    } catch (error) {
        showAlert('Failed to generate PDF. Please try again.');
    }
}

// Build PDF definition using pdfMake
function buildChecklistPDFDefinition() {
    const today = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    
    // Group by category
    const grouped = onboardingState.checklist.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
    }, {});
    
    const content = [
        { text: 'Onboarding Checklist', style: 'header', margin: [0, 0, 0, 20] },
        
        // Employee Info
        {
            table: {
                widths: ['30%', '70%'],
                body: [
                    ['Employee Name:', onboardingState.employeeName],
                    ['Position:', onboardingState.position],
                    ['Employment Type:', onboardingState.employmentType],
                    ['Start Date:', new Date(onboardingState.startDate).toLocaleDateString('en-AU')]
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        },
        
        // Progress
        {
            text: `Progress: ${onboardingState.completedTasks.length} of ${onboardingState.checklist.length} tasks completed (${Math.round((onboardingState.completedTasks.length / onboardingState.checklist.length) * 100)}%)`,
            style: 'subheader',
            margin: [0, 0, 0, 20]
        }
    ];
    
    // Add categories
    Object.keys(grouped).forEach(category => {
        content.push({ text: category, style: 'category', margin: [0, 20, 0, 10] });
        
        grouped[category].forEach(item => {
            const isCompleted = onboardingState.completedTasks.includes(item.id);
            
            content.push({
                stack: [
                    {
                        columns: [
                            { text: isCompleted ? 'â˜‘' : 'â˜', width: 20 },
                            { 
                                stack: [
                                    { text: item.title, style: 'taskTitle', decoration: isCompleted ? 'lineThrough' : '' },
                                    { text: item.hint, style: 'taskHint' },
                                    item.daysUntil !== undefined ? 
                                        { text: `Due: ${item.daysUntil === 0 ? 'Today' : item.daysUntil === 1 ? 'Tomorrow' : `In ${item.daysUntil} days`}`, style: 'taskDue' } : {}
                                ]
                            },
                            { text: item.priority.toUpperCase(), style: `priority${item.priority}`, width: 60 }
                        ]
                    }
                ],
                margin: [0, 5, 0, 10]
            });
        });
    });
    
    // Footer
    content.push({
        text: `Generated by Fitzgerald HR on ${today}`,
        style: 'footer',
        margin: [0, 30, 0, 0]
    });
    
    return {
        content: content,
        styles: {
            header: { fontSize: 24, bold: true, color: '#2c3e50' },
            subheader: { fontSize: 14, bold: true, color: '#34495e' },
            category: { fontSize: 16, bold: true, color: '#667eea', margin: [0, 15, 0, 5] },
            taskTitle: { fontSize: 12, bold: true },
            taskHint: { fontSize: 10, color: '#7f8c8d', margin: [0, 3, 0, 0] },
            taskDue: { fontSize: 9, color: '#95a5a6', italics: true, margin: [0, 2, 0, 0] },
            priorityhigh: { fontSize: 9, bold: true, color: 'white', fillColor: '#e74c3c', alignment: 'center' },
            prioritymedium: { fontSize: 9, bold: true, color: 'white', fillColor: '#f39c12', alignment: 'center' },
            prioritylow: { fontSize: 9, bold: true, color: 'white', fillColor: '#27ae60', alignment: 'center' },
            footer: { fontSize: 10, color: '#95a5a6', alignment: 'center' }
        },
        defaultStyle: { font: 'Helvetica' }
    };
}

// Build HTML for DOCX export
function buildChecklistHTML() {
    const today = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    
    // Group by category
    const grouped = onboardingState.checklist.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
    }, {});
    
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    line-height: 1.6; 
                    max-width: 800px; 
                    margin: 40px auto; 
                    padding: 20px;
                    color: #000;
                }
                h1 { 
                    color: #2c3e50; 
                    border-bottom: 3px solid #667eea; 
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                h2 { 
                    color: #34495e; 
                    margin-top: 30px; 
                    border-bottom: 2px solid #bdc3c7; 
                    padding-bottom: 5px;
                }
                .employee-info {
                    background: #ecf0f1;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 30px;
                }
                .employee-info p {
                    margin: 5px 0;
                }
                .progress {
                    background: #ecf0f1;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 30px;
                }
                .category {
                    margin-bottom: 30px;
                    page-break-inside: avoid;
                }
                .task {
                    margin: 15px 0;
                    padding: 15px;
                    border-left: 4px solid #3498db;
                    background: #f8f9fa;
                    page-break-inside: avoid;
                }
                .task.completed {
                    opacity: 0.6;
                    border-left-color: #27ae60;
                }
                .task-title {
                    font-weight: bold;
                    margin-bottom: 5px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .task-hint {
                    color: #7f8c8d;
                    font-size: 14px;
                    margin: 5px 0;
                }
                .checkbox {
                    display: inline-block;
                    width: 18px;
                    height: 18px;
                    border: 2px solid #34495e;
                    border-radius: 3px;
                    vertical-align: middle;
                }
                .checkbox.checked {
                    background: #27ae60;
                    border-color: #27ae60;
                    position: relative;
                }
                .checkbox.checked::after {
                    content: "âœ“";
                    color: white;
                    position: absolute;
                    top: -2px;
                    left: 2px;
                    font-size: 14px;
                    font-weight: bold;
                }
                .priority {
                    display: inline-block;
                    padding: 3px 8px;
                    border-radius: 3px;
                    font-size: 11px;
                    font-weight: bold;
                    text-transform: uppercase;
                }
                .priority-high {
                    background: #e74c3c;
                    color: white;
                }
                .priority-medium {
                    background: #f39c12;
                    color: white;
                }
                .priority-low {
                    background: #27ae60;
                    color: white;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #bdc3c7;
                    text-align: center;
                    color: #7f8c8d;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <h1>Onboarding Checklist</h1>
            
            <div class="employee-info">
                <p><strong>Employee Name:</strong> ${onboardingState.employeeName}</p>
                <p><strong>Position:</strong> ${onboardingState.position}</p>
                <p><strong>Employment Type:</strong> ${onboardingState.employmentType}</p>
                <p><strong>Start Date:</strong> ${new Date(onboardingState.startDate).toLocaleDateString('en-AU')}</p>
            </div>
            
            <div class="progress">
                <p><strong>Progress:</strong> ${onboardingState.completedTasks.length} of ${onboardingState.checklist.length} tasks completed (${Math.round((onboardingState.completedTasks.length / onboardingState.checklist.length) * 100)}%)</p>
            </div>
    `;
    
    // Add each category
    Object.keys(grouped).forEach(category => {
        html += `
            <div class="category">
                <h2>${getCategoryIcon(category)} ${category}</h2>
        `;
        
        grouped[category].forEach(item => {
            const isCompleted = onboardingState.completedTasks.includes(item.id);
            html += `
                <div class="task ${isCompleted ? 'completed' : ''}">
                    <div class="task-title">
                        <span class="checkbox ${isCompleted ? 'checked' : ''}"></span>
                        <span>${item.title}</span>
                        <span class="priority priority-${item.priority}">${item.priority}</span>
                    </div>
                    <div class="task-hint">${item.hint}</div>
                    ${item.daysUntil !== undefined ? `
                        <div class="task-hint">
                            <strong>Due:</strong> ${item.daysUntil === 0 ? 'Today' : item.daysUntil === 1 ? 'Tomorrow' : `In ${item.daysUntil} days`}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
    });
    
    html += `
            <div class="footer">
                <p>Generated by Fitzgerald HR on ${today}</p>
                <p>This checklist helps ensure compliant and thorough employee onboarding</p>
            </div>
        </body>
        </html>
    `;
    
    return html;
}



function openEmploymentContractBuilder() {
    const builder = document.getElementById('employmentContractBuilder');
    if (builder) {
        builder.classList.add('active');
    }
    
    if (!contractBuilderState.contractId) {
        contractBuilderState.contractId = 'contract_' + Date.now();
    }
    
    loadContractProgress();
    renderContractStep(contractBuilderState.currentStep);
    
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('employmentContractBuilder');
    }
}


// EMPLOYMENT CONTRACT BUILDER JAVASCRIPT  
// ========================================

// Contract Builder State Management
const contractBuilderState = {
    currentStep: 0,
    totalSteps: 9,
    contractId: null,
    userId: null,
    data: {
        step0: { businessState: '', knowMyAward: false, understandTemplate: false, detailedTermsAccepted: false, detailedTermsAcceptedAt: null, timestamp: null },
        step1: { positionTitle: '', dutiesOption: 'attach', duties: '', awardName: '', businessStructure: '', workplaceAddress: '', employmentType: '', isPermanent: true, startDate: '', endDate: '', hasProbation: false, probationLength: '6' },
        step2: { 
            hoursPerWeek: '', 
            isShiftworker: 'no',
            flexibleHours: false,
            averagingHours: false,
            onCallStandby: false,
            includeRostersClause: false,
            rosterNoticeDays: '7',
            rosterChangeDays: '7',
            employeeRosterNoticeDays: '7',
            workPattern: '', 
            overtimeApplies: true, 
            shiftWork: false 
        },
        step3: { 
            payRateType: 'hourly',
            payRate: '', 
            payFrequency: 'weekly', 
            payMethod: 'bank', 
            superannuation: true,
            additionalSuper: false,
            additionalSuperPercent: '',
            penaltyRatesOvertime: false,
            allowances: false,
            commission: false,
            commissionArrangement: '',
            annualBonus: false,
            annualPayReview: false
        },
        step4: { 
            annualLeaveMeasure: 'weeks',
            annualLeaveAmount: '4',
            additionalParentalLeave: false,
            additionalParentalLeaveWeeks: ''
        },
        step5: { employeeObligations: true, conflictOfInterest: false, confidentiality: false, intellectualProperty: false, consultation: false, disputes: true },
        step6: { 
            resignationNotice: { 
                year1: '1', 
                year1to3: '2', 
                year3to5: '3', 
                year5plus: '4' 
            }, 
            misconductClause: false 
        },
        step7: { reviewComplete: false },
        step8: { deliveryMethod: 'download' }
    },
    unsavedChanges: false,
    lastSaved: null
};

// Main Functions
function openEmploymentContract() {
    const builder = document.getElementById('employmentContractBuilder');
    builder.classList.add('active');
    
    if (!contractBuilderState.contractId) {
        contractBuilderState.contractId = 'contract_' + Date.now();
    }
    
    loadContractProgress();
    renderContractStep(contractBuilderState.currentStep);
    
    if (typeof trackToolUsage === 'function') {
        trackToolUsage('employmentContractBuilder');
    }
}

function closeEmploymentContract() {
    if (contractBuilderState.unsavedChanges) {
        if (!confirm('You have unsaved changes. Are you sure you want to close?')) {
            return;
        }
    }
    
    const builder = document.getElementById('employmentContractBuilder');
    builder.classList.remove('active');
}

// Navigation Functions
function nextContractStep() {
    try {
        if (!validateContractStep(contractBuilderState.currentStep)) {
            return;
        }
        
        saveCurrentStepData();
        contractBuilderState.unsavedChanges = true;
        
        // âœ… CHECK: If moving from Step 0 (Setup) to Step 1 (Position Details)
        // Show detailed Terms of Use modal if not already accepted
        if (contractBuilderState.currentStep === 0 && !contractBuilderState.data.step0.detailedTermsAccepted) {
            showContractBuilderTermsModal();
            return; // Don't proceed until terms are accepted
        }
        
        if (contractBuilderState.currentStep < contractBuilderState.totalSteps - 1) {
            contractBuilderState.currentStep++;
            renderContractStep(contractBuilderState.currentStep);
            updateContractProgressBar();
        }
    } catch (error) {
        showAlert('An error occurred: ' + error.message);
    }
}

/**
 * Show the Contract Builder Terms of Use modal
 */
function showContractBuilderTermsModal() {
    const modal = document.getElementById('contractBuilderTermsModal');
    const checkbox = document.getElementById('contractTermsCheckbox');
    const acceptBtn = document.getElementById('acceptContractTermsBtn');
    
    if (modal) {
        modal.classList.remove('hidden');
        // Reset checkbox state
        if (checkbox) checkbox.checked = false;
        if (acceptBtn) acceptBtn.disabled = true;
        
        // Enable accept button only when checkbox is checked
        if (checkbox) {
            checkbox.onchange = function() {
                if (acceptBtn) acceptBtn.disabled = !this.checked;
            };
        }
        
        // Track event
        if (typeof trackEvent === 'function') {
            trackEvent('contract_builder_terms_shown', { 
                user: currentUser?.uid || currentUser 
            });
        }
    } else {
    }
}

/**
 * User accepts the Contract Builder Terms of Use
 */
function acceptContractTerms() {
    const checkbox = document.getElementById('contractTermsCheckbox');
    
    if (!checkbox || !checkbox.checked) {
        showAlert('âš ï¸ Please check the box to confirm you have read and agree to the Terms of Use.');
        return;
    }
    
    // Save acceptance to contract builder state
    contractBuilderState.data.step0.detailedTermsAccepted = true;
    contractBuilderState.data.step0.detailedTermsAcceptedAt = new Date().toISOString();
    
    // Close modal
    const modal = document.getElementById('contractBuilderTermsModal');
    if (modal) modal.classList.add('hidden');
    
    // Track acceptance
    if (typeof trackEvent === 'function') {
        trackEvent('contract_builder_terms_accepted', { 
            user: currentUser?.uid || currentUser,
            timestamp: contractBuilderState.data.step0.detailedTermsAcceptedAt
        });
    }
    
    // Show toast
    if (typeof showToast === 'function') {
        showToast('Terms accepted - proceeding to Position Details', 'success', 2000);
    }
    
    // Now proceed to next step
    contractBuilderState.currentStep++;
    renderContractStep(contractBuilderState.currentStep);
    updateContractProgressBar();
}

/**
 * User declines the Contract Builder Terms of Use
 */
function declineContractTerms() {
    const modal = document.getElementById('contractBuilderTermsModal');
    if (modal) modal.classList.add('hidden');
    
    // Track decline
    if (typeof trackEvent === 'function') {
        trackEvent('contract_builder_terms_declined', { 
            user: currentUser?.uid || currentUser 
        });
    }
    
    // Show info toast
    if (typeof showToast === 'function') {
        showToast('You must accept the Terms of Use to create contracts', 'info', 3000);
    }
}

function previousContractStep() {
    if (contractBuilderState.currentStep > 0) {
        saveCurrentStepData();
        contractBuilderState.currentStep--;
        renderContractStep(contractBuilderState.currentStep);
        updateContractProgressBar();
    }
}

function jumpToContractStep(stepNumber) {
    if (stepNumber >= 0 && stepNumber < contractBuilderState.totalSteps) {
        saveCurrentStepData();
        contractBuilderState.currentStep = stepNumber;
        renderContractStep(stepNumber);
        updateContractProgressBar();
    }
}

// Validation Popup Functions
function showValidationPopup(errors) {
    const popup = document.getElementById('contractValidationPopup');
    const errorList = document.getElementById('validationErrorList');
    
    if (popup && errorList) {
        // Build error list HTML
        errorList.innerHTML = errors.map(error => `
            <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px 0; border-bottom: 1px solid #fecaca;">
                <span style="color: #dc2626; font-weight: bold;">â€¢</span>
                <span style="color: #991b1b;">${error}</span>
            </div>
        `).join('');
        
        popup.classList.remove('hidden');
    }
}

function closeValidationPopup() {
    const popup = document.getElementById('contractValidationPopup');
    if (popup) {
        popup.classList.add('hidden');
    }
}

// Validation Function
function validateContractStep(stepNumber) {
    const stepData = contractBuilderState.data[`step${stepNumber}`];
    const errors = [];
    
    switch(stepNumber) {
        case 0: {
            // Read directly from form elements (state not saved yet)
            const businessState = document.getElementById('businessState')?.value;
            const understandTemplate = document.getElementById('understandTemplate')?.checked;
            
            if (!businessState) {
                errors.push('Business State/Territory is required');
            }
            if (!understandTemplate) {
                errors.push('You must acknowledge that this is a template tool');
            }
            break;
        }
        case 1: {
            // Read directly from form elements (state not saved yet)
            const positionTitle = document.getElementById('positionTitle')?.value;
            const awardName = document.getElementById('awardName')?.value;
            const employmentType = document.querySelector('input[name="employmentType"]:checked')?.value;
            const startDate = document.getElementById('startDate')?.value;
            const isPermanent = document.querySelector('input[name="isPermanent"]:checked')?.value;
            const endDate = document.getElementById('endDate')?.value;
            
            if (!positionTitle) {
                errors.push('Position Title is required');
            }
            if (!awardName) {
                errors.push('Modern Award is required');
            }
            if (!employmentType) {
                errors.push('Employment Type is required');
            }
            if (!startDate) {
                errors.push('Start Date is required');
            }
            if (isPermanent === 'false' && !endDate) {
                errors.push('End Date is required for fixed-term employment');
            }
            break;
        }
        case 2: {
            // Read directly from form elements (state not saved yet)
            const hoursPerWeek = document.getElementById('hoursPerWeek')?.value;
            const step1EmpType = contractBuilderState.data.step1.employmentType;
            const isShiftworker = document.querySelector('input[name="isShiftworker"]:checked')?.value;
            
            // Check step1 employment type from saved state (already saved when we moved to step 2)
            if (!hoursPerWeek && step1EmpType !== 'casual') {
                errors.push('Hours per week is required');
            }
            if (!isShiftworker) {
                errors.push('Shiftworker status is required');
            }
            break;
        }
        case 3: {
            // Read directly from form elements (state not saved yet)
            const payRate = document.getElementById('payRate')?.value;
            const payRateType = document.querySelector('input[name="payRateType"]:checked')?.value;
            const payFrequency = document.querySelector('input[name="payFrequency"]:checked')?.value;
            const payMethod = document.querySelector('input[name="payMethod"]:checked')?.value;
            
            if (!payRateType) {
                errors.push('Pay rate type (hourly/weekly) is required');
            }
            if (!payRate) {
                errors.push('Pay rate amount is required');
            }
            if (!payFrequency) {
                errors.push('Pay frequency is required');
            }
            if (!payMethod) {
                errors.push('Payment method is required');
            }
            break;
        }
        case 4: {
            // Leave step - annual leave amount required for non-casuals
            const step1EmpType = contractBuilderState.data.step1.employmentType;
            const annualLeaveAmount = document.getElementById('annualLeaveAmount')?.value;
            
            if (step1EmpType !== 'casual' && !annualLeaveAmount) {
                errors.push('Annual leave amount is required');
            }
            break;
        }
        case 5: {
            // Additional terms - no required fields, all optional
            break;
        }
        case 6: {
            // Ending employment - check resignation notice fields
            const resignYear1 = document.getElementById('resignYear1')?.value;
            const resignYear1to3 = document.getElementById('resignYear1to3')?.value;
            const resignYear3to5 = document.getElementById('resignYear3to5')?.value;
            const resignYear5plus = document.getElementById('resignYear5plus')?.value;
            
            if (!resignYear1) {
                errors.push('Resignation notice period for 1 year or less is required');
            }
            if (!resignYear1to3) {
                errors.push('Resignation notice period for 1-3 years is required');
            }
            if (!resignYear3to5) {
                errors.push('Resignation notice period for 3-5 years is required');
            }
            if (!resignYear5plus) {
                errors.push('Resignation notice period for 5+ years is required');
            }
            break;
        }
        case 7: {
            const reviewComplete = document.getElementById('reviewComplete')?.checked;
            if (!reviewComplete) {
                errors.push('You must confirm you have reviewed all sections');
            }
            break;
        }
        default:
            break;
    }
    
    if (errors.length > 0) {
        showValidationPopup(errors);
        return false;
    }
    
    return true;
}

// Progress Bar Update
function updateContractProgressBar() {
    const currentStep = contractBuilderState.currentStep;
    const totalSteps = contractBuilderState.totalSteps;
    
    const progressPercent = (currentStep / (totalSteps - 1)) * 100;
    document.getElementById('progressLineFill').style.width = progressPercent + '%';
    
    for (let i = 0; i < totalSteps; i++) {
        const circle = document.getElementById(`progressCircle${i}`);
        const label = circle.parentElement.querySelector('.progress-label');
        
        circle.classList.remove('active', 'completed');
        label.classList.remove('active');
        
        if (i < currentStep) {
            circle.classList.add('completed');
            circle.textContent = '';
        } else if (i === currentStep) {
            circle.classList.add('active');
            label.classList.add('active');
            circle.textContent = i + 1;
        } else {
            circle.textContent = i + 1;
        }
    }
}

// Save/Load Functions
function saveCurrentStepData() {
    const stepNumber = contractBuilderState.currentStep;
    const stepKey = `step${stepNumber}`;
    
    const inputs = document.querySelectorAll(`#contractStepContent input, #contractStepContent select, #contractStepContent textarea`);
    
    inputs.forEach(input => {
        const name = input.name || input.id;
        if (!name) return;
        
        // Special handling for Step 6 resignation notice nested fields
        if (stepNumber === 6 && name.startsWith('resign')) {
            if (!contractBuilderState.data[stepKey].resignationNotice) {
                contractBuilderState.data[stepKey].resignationNotice = {};
            }
            if (name === 'resignYear1') {
                contractBuilderState.data[stepKey].resignationNotice.year1 = input.value;
            } else if (name === 'resignYear1to3') {
                contractBuilderState.data[stepKey].resignationNotice.year1to3 = input.value;
            } else if (name === 'resignYear3to5') {
                contractBuilderState.data[stepKey].resignationNotice.year3to5 = input.value;
            } else if (name === 'resignYear5plus') {
                contractBuilderState.data[stepKey].resignationNotice.year5plus = input.value;
            }
            return;
        }
        
        if (input.type === 'checkbox') {
            contractBuilderState.data[stepKey][name] = input.checked;
        } else if (input.type === 'radio') {
            if (input.checked) {
                contractBuilderState.data[stepKey][name] = input.value;
            }
        } else {
            contractBuilderState.data[stepKey][name] = input.value;
        }
    });
    
}

async function saveContractProgress() {
    try {
        localStorage.setItem('contract_draft_' + contractBuilderState.contractId, JSON.stringify({
            currentStep: contractBuilderState.currentStep,
            data: contractBuilderState.data,
            lastSaved: new Date().toISOString()
        }));
        
        contractBuilderState.unsavedChanges = false;
        contractBuilderState.lastSaved = new Date();
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Progress saved', 'success');
        }
        
        return true;
    } catch (error) {
        showAlert('Failed to save progress. Please try again.');
        return false;
    }
}

async function loadContractProgress() {
    try {
        const saved = localStorage.getItem('contract_draft_' + contractBuilderState.contractId);
        
        if (saved) {
            const data = JSON.parse(saved);
            contractBuilderState.currentStep = data.currentStep || 0;
            contractBuilderState.data = data.data || contractBuilderState.data;
            contractBuilderState.lastSaved = data.lastSaved ? new Date(data.lastSaved) : null;
            
        }
    } catch (error) {
    }
}

// Helper Functions
function toggleHelpSection(element) {
    const content = element.nextElementSibling;
    element.classList.toggle('expanded');
    content.classList.toggle('expanded');
}

// Auto-save every 30 seconds
setInterval(() => {
    if (contractBuilderState.unsavedChanges && document.getElementById('employmentContractBuilder').classList.contains('active')) {
        saveContractProgress();
    }
}, 30000);


// ========================================
// STEP RENDERING AND TEMPLATES
// ========================================

function renderContractStep(stepNumber) {
    const container = document.getElementById('contractStepContent');
    
    switch(stepNumber) {
        case 0:
            container.innerHTML = getStep0Template();
            initializeStep0Listeners();
            break;
        case 1:
            container.innerHTML = getStep1Template();
            initializeStep1Listeners();
            break;
        case 2:
            container.innerHTML = getStep2Template();
            initializeStep2Listeners();
            break;
        case 3:
            container.innerHTML = getStep3Template();
            initializeStep3Listeners();
            break;
        case 4:
            container.innerHTML = getStep4Template();
            initializeStep4Listeners();
            break;
        case 5:
            container.innerHTML = getStep5Template();
            initializeStep5Listeners();
            break;
        case 6:
            container.innerHTML = getStep6Template();
            initializeStep6Listeners();
            break;
        case 7:
            container.innerHTML = getStep7Template();
            initializeStep7Listeners();
            break;
        case 8:
            container.innerHTML = getStep8Template();
            initializeStep8Listeners();
            break;
    }
    
    // Scroll to top - the employmentContractBuilder div has overflow-y: auto
    const contractBuilder = document.getElementById('employmentContractBuilder');
    if (contractBuilder) {
        contractBuilder.scrollTop = 0;
    }
}

// ========================================
// STEP 0: Before You Begin
// ========================================
// Updated Step 0 Template with validation
function getStep0Template() {
    const data = contractBuilderState.data.step0;
    
    return `
        <h2 class="step-title">Before You Begin</h2>
        <p class="step-description">This tool will take approximately 30 minutes to complete. Let's start with some basic information.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <div class="warning-box">
            <div class="warning-box-title">âš ï¸ Important Legal Notice</div>
            <div class="warning-box-content">
                <p><strong>This tool provides template contracts only - NOT legal advice.</strong></p>
                <ul>
                    <li>Templates are based on Fair Work Australia requirements</li>
                    <li>You should review with a legal professional before use</li>
                    <li>Fitzgerald HR recommends consulting with our Senior HR Consultant</li>
                    <li>Your specific situation may require additional clauses or modifications</li>
                </ul>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Where is your business located?</label>
            <select class="form-select" id="businessState" name="businessState" onchange="checkStep0Validation()">
                <option value="">Select state/territory...</option>
                <option value="NSW" ${data.businessState === 'NSW' ? 'selected' : ''}>New South Wales</option>
                <option value="VIC" ${data.businessState === 'VIC' ? 'selected' : ''}>Victoria</option>
                <option value="QLD" ${data.businessState === 'QLD' ? 'selected' : ''}>Queensland</option>
                <option value="SA" ${data.businessState === 'SA' ? 'selected' : ''}>South Australia</option>
                <option value="WA" ${data.businessState === 'WA' ? 'selected' : ''}>Western Australia</option>
                <option value="TAS" ${data.businessState === 'TAS' ? 'selected' : ''}>Tasmania</option>
                <option value="NT" ${data.businessState === 'NT' ? 'selected' : ''}>Northern Territory</option>
                <option value="ACT" ${data.businessState === 'ACT' ? 'selected' : ''}>Australian Capital Territory</option>
            </select>
        </div>
        
        <div class="info-box">
            <div class="info-box-title">ðŸ“š Know Your Award</div>
            <div class="info-box-content">
                <p>You'll need to know which Modern Award applies to your employee. Not sure?</p>
                <button class="btn btn-link" onclick="openAwardWizardFromContract(); return false;">Use Award Wizard â†’</button>
                <a href="https://services.fairwork.gov.au/find-my-award" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">Visit Fair Work Award Finder â†—</a>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="knowMyAward" name="knowMyAward" ${data.knowMyAward ? 'checked' : ''} onchange="checkStep0Validation()">
                <span class="checkbox-text">I know which Modern Award applies to this position</span>
            </label>
        </div>
        
        <div class="info-box">
            <div class="info-box-title">ðŸ“ Position Description</div>
            <div class="info-box-content">
                <p>Having a clear position description makes creating contracts easier. Need help creating one?</p>
                <button class="btn btn-link" onclick="openJobDescriptionFromContract(); return false;">Use Job Description Builder â†’</button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="understandTemplate" name="understandTemplate" ${data.understandTemplate ? 'checked' : ''} required onchange="checkStep0Validation()">
                <span class="checkbox-text">
                    <strong>I understand this is a template tool and not legal advice.</strong> 
                    I will review any contract with a qualified professional before use. <span style="color: #dc3545; font-weight: bold;">*</span>
                </span>
            </label>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="closeEmploymentContract()">Cancel</button>
            <button class="btn btn-primary" id="step0NextBtn" onclick="nextContractStep()" disabled>
                Next: Position Details â†’
            </button>
        </div>
    `;
}

function initializeStep0Listeners() {
    // Auto-save on changes
    const inputs = document.querySelectorAll('#contractStepContent input, #contractStepContent select');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
    
    // Initial validation check
    checkStep0Validation();
}

// Validation function for Step 0
function checkStep0Validation() {
    const businessState = document.getElementById('businessState')?.value;
    const understandTemplate = document.getElementById('understandTemplate')?.checked;
    const nextBtn = document.getElementById('step0NextBtn');
    
    if (nextBtn) {
        // Enable button only if state is selected AND user acknowledges template nature
        if (businessState && understandTemplate) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
    }
}

// Helper functions to open Award Wizard and Job Description Builder
function openAwardWizardFromContract() {
    // Show confirmation dialog
    const confirmed = confirm(
        'âš ï¸ Navigate Away?\n\n' +
        'This will close the Employment Contract Builder and take you to the Award Wizard.\n\n' +
        'Your current progress will be saved, but you will need to return to continue building your contract.\n\n' +
        'Are you sure you want to leave?'
    );
    
    if (!confirmed) {
        return; // User cancelled
    }
    
    // Save current progress before leaving
    saveCurrentStepData();
    saveContractProgress();
    
    // Close contract builder
    closeEmploymentContract();
    
    // Open Award Wizard (using existing function)
    if (typeof openAwardWizard === 'function') {
        openAwardWizard();
    } else {
        showAlert('Award Wizard is not available. Please contact support.');
    }
}

function openJobDescriptionFromContract() {
    // Show confirmation dialog
    const confirmed = confirm(
        'âš ï¸ Navigate Away?\n\n' +
        'This will close the Employment Contract Builder and take you to the Job Description Builder.\n\n' +
        'Your current progress will be saved, but you will need to return to continue building your contract.\n\n' +
        'Are you sure you want to leave?'
    );
    
    if (!confirmed) {
        return; // User cancelled
    }
    
    // Save current progress before leaving
    saveCurrentStepData();
    saveContractProgress();
    
    // Close contract builder
    closeEmploymentContract();
    
    // Open Job Description Builder (using existing function)  
    if (typeof openJobDescriptionBuilder === 'function') {
        openJobDescriptionBuilder();
    } else {
        showAlert('Job Description Builder is not available. Please contact support.');
    }
}

/**
 * Open external link from Contract Builder with confirmation
 */
function openExternalLinkFromContract(url, siteName) {
    // Show confirmation dialog
    const confirmed = confirm(
        'âš ï¸ Navigate Away?\n\n' +
        `This will open ${siteName || 'an external website'} in a new tab.\n\n` +
        'Your current progress in the Employment Contract Builder will be preserved.\n\n' +
        'Are you sure you want to open this link?'
    );
    
    if (!confirmed) {
        return false; // User cancelled
    }
    
    // Open in new tab
    window.open(url, '_blank');
    return false; // Prevent default link behavior
}

/**
 * Open Award Calculator from Contract Builder with confirmation
 */
function openAwardCalculatorFromContract() {
    // Show confirmation dialog
    const confirmed = confirm(
        'âš ï¸ Navigate Away?\n\n' +
        'This will close the Employment Contract Builder and take you to the Award Calculator.\n\n' +
        'Your current progress will be saved, but you will need to return to continue building your contract.\n\n' +
        'Are you sure you want to leave?'
    );
    
    if (!confirmed) {
        return; // User cancelled
    }
    
    // Save current progress before leaving
    saveCurrentStepData();
    saveContractProgress();
    
    // Close contract builder
    closeEmploymentContract();
    
    // Open Award Calculator (using existing function)
    if (typeof openAwardCalculator === 'function') {
        openAwardCalculator();
    } else {
        showAlert('Award Calculator is not available. Please contact support.');
    }
}


// STEP 1: Position Details
// ========================================
function getStep1Template() {
    const data = contractBuilderState.data.step1;
    
    return `
        <h2 class="step-title">Position Details</h2>
        <p class="step-description">Provide the key information about this employment position.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <div class="form-group">
            <label class="form-label required">Position Title</label>
            <input type="text" class="form-input" id="positionTitle" name="positionTitle" 
                   value="${data.positionTitle}" 
                   placeholder="e.g., Head Chef, Front of House Manager, Barista">
            <span class="form-hint">Enter the official job title for this position</span>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Duties and Responsibilities</label>
            <div class="radio-group">
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="dutiesOption" value="attach" 
                               ${data.dutiesOption === 'attach' ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Attach position description later</div>
                            <div class="radio-description">I'll attach a separate PD document</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="dutiesOption" value="outline" 
                               ${data.dutiesOption === 'outline' ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Outline duties now</div>
                            <div class="radio-description">Include duties in the contract</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="dutiesTextArea" style="display: ${data.dutiesOption === 'outline' ? 'block' : 'none'};">
            <div class="form-group">
                <label class="form-label">Key Duties</label>
                <textarea class="form-textarea" id="duties" name="duties" 
                          placeholder="Enter the main responsibilities and duties for this role...">${data.duties}</textarea>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Modern Award</label>
            <input type="text" class="form-input" id="awardName" name="awardName" 
                   value="${data.awardName}" 
                   placeholder="e.g., Hospitality Industry (General) Award">
            <span class="form-hint">
                Not sure? 
                <button class="btn btn-link" style="padding: 0; display: inline;" onclick="openAwardWizardFromContract(); return false;">Use Award Wizard</button>
            </span>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">What's a Modern Award?</span>
            </button>
            <div class="help-content">
                <p>A Modern Award is a legal document that sets out minimum pay rates and conditions of employment for a particular industry or occupation in Australia.</p>
                <p>The Hospitality Industry (General) Award covers most hospitality businesses including restaurants, cafes, hotels, catering, and clubs.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Business Structure</label>
            <select class="form-select" id="businessStructure" name="businessStructure">
                <option value="">Select business structure...</option>
                <option value="sole_trader" ${data.businessStructure === 'sole_trader' ? 'selected' : ''}>Sole Trader</option>
                <option value="partnership" ${data.businessStructure === 'partnership' ? 'selected' : ''}>Partnership</option>
                <option value="company" ${data.businessStructure === 'company' ? 'selected' : ''}>Company (Pty Ltd)</option>
                <option value="trust" ${data.businessStructure === 'trust' ? 'selected' : ''}>Trust</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Workplace Address</label>
            <input type="text" class="form-input" id="workplaceAddress" name="workplaceAddress" 
                   value="${data.workplaceAddress}" 
                   placeholder="123 Main Street, Sydney NSW 2000">
            <span class="form-hint">The primary work location (can be added later)</span>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Employment Type</label>
            <div class="radio-group">
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="employmentType" value="full-time" 
                               ${data.employmentType === 'full-time' ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Full-time</div>
                            <div class="radio-description">38 hours per week</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="employmentType" value="part-time" 
                               ${data.employmentType === 'part-time' ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Part-time</div>
                            <div class="radio-description">Regular hours, less than 38/week</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="employmentType" value="casual" 
                               ${data.employmentType === 'casual' ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Casual</div>
                            <div class="radio-description">No fixed hours, casual loading</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Employment Duration</label>
            <div class="radio-group">
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="isPermanent" value="true" 
                               ${data.isPermanent ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Ongoing/Permanent</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="isPermanent" value="false" 
                               ${!data.isPermanent ? 'checked' : ''}>
                        <div class="radio-content">
                            <div class="radio-text">Fixed-term</div>
                            <div class="radio-description">Has specific end date</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Start Date</label>
            <input type="date" class="form-input" id="startDate" name="startDate" value="${data.startDate}">
        </div>
        
        <div id="endDateField" style="display: ${!data.isPermanent ? 'block' : 'none'};">
            <div class="form-group">
                <label class="form-label required">End Date</label>
                <input type="date" class="form-input" id="endDate" name="endDate" value="${data.endDate}">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">Probation Period</label>
            <select class="form-select" id="probationLength" name="probationLength">
                <option value="3" ${data.probationLength === '3' ? 'selected' : ''}>3 months</option>
                <option value="6" ${data.probationLength === '6' || !data.probationLength ? 'selected' : ''}>6 months (Recommended)</option>
                <option value="12" ${data.probationLength === '12' ? 'selected' : ''}>12 months</option>
            </select>
            <span class="form-hint">6 months is recommended for most hospitality roles to properly assess performance</span>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">Why have a probation period?</span>
            </button>
            <div class="help-content">
                <p>A probation period allows you to assess whether an employee is suitable for the role before confirming their ongoing employment.</p>
                <p><strong>Key benefits:</strong></p>
                <ul>
                    <li>Lower notice period required (typically 1 week)</li>
                    <li>Easier to terminate if not suitable</li>
                    <li>Time to assess skills and cultural fit</li>
                    <li>Standard practice in hospitality industry</li>
                </ul>
                <p><strong>6 months is recommended</strong> as it gives enough time to see performance across different service periods and busy/quiet times.</p>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Hours & Work Pattern â†’</button>
        </div>
    `;
}

function initializeStep1Listeners() {
    // Duties option toggle
    document.querySelectorAll('input[name="dutiesOption"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const textArea = document.getElementById('dutiesTextArea');
            textArea.style.display = e.target.value === 'outline' ? 'block' : 'none';
        });
    });
    
    // Employment duration toggle
    document.querySelectorAll('input[name="isPermanent"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const endDateField = document.getElementById('endDateField');
            endDateField.style.display = e.target.value === 'false' ? 'block' : 'none';
        });
    });
    
    // Auto-save
    const inputs = document.querySelectorAll('#contractStepContent input, #contractStepContent select, #contractStepContent textarea');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
}


function getStep2Template() {
    const data = contractBuilderState.data.step2;
    const empType = contractBuilderState.data.step1.employmentType;
    
    return `
        <h2 class="step-title">Hours of Work</h2>
        <p class="step-description">Define the working hours and conditions for this ${empType} position.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <!-- HOURS PER WEEK -->
        <div class="form-section">
            <h3 class="form-section-title required">How many ordinary hours per week will the employee work?</h3>
            <p class="form-section-description">The maximum weekly ordinary hours can vary between awards. Full-time employees usually work an average of 38 ordinary hours per week, part-time employees work less.</p>
            
            ${empType !== 'casual' ? `
            <div class="form-group">
                <div class="input-with-suffix">
                    <input type="number" class="form-input" id="hoursPerWeek" name="hoursPerWeek" 
                           value="${data.hoursPerWeek}" 
                           placeholder="${empType === 'full-time' ? '38' : 'e.g., 20'}"
                           min="1" max="50" step="0.5">
                    <span class="input-suffix">hour(s) per week</span>
                </div>
            </div>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Hours of work clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You are expected to work <strong>${data.hoursPerWeek || '[number]'}</strong> ordinary hour(s) per week. We may also request or require you to work additional hours if the additional hours are reasonable.</p>
                </div>
            </div>
            ` : `
            <div class="info-box">
                <div class="info-box-title">â„¹ï¸ Casual Employment Hours</div>
                <div class="info-box-content">
                    <p>For casual employees, hours are not guaranteed and will vary based on roster requirements.</p>
                    <p>Casual employees receive a 25% loading instead of paid leave entitlements.</p>
                </div>
            </div>
            `}
        </div>
        
        <!-- SHIFTWORKER -->
        <div class="form-section">
            <h3 class="form-section-title required">Will the employee be a shiftworker?</h3>
            <p class="form-section-description">Whether your employee is considered a shiftworker will depend on the award they are under. 
            <a href="https://www.fairwork.gov.au/employment-conditions/hours-of-work-breaks-and-rosters/shift-work" target="_blank" rel="noopener noreferrer">Check the award to see if it has a definition of shiftworker</a> â€“ they're not all the same.</p>
            
            <div class="radio-group-vertical">
                <label class="radio-option-card">
                    <input type="radio" name="isShiftworker" value="yes" ${data.isShiftworker === 'yes' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>Yes â€“ they meet the award definition of a shiftworker</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="isShiftworker" value="no" ${data.isShiftworker === 'no' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>No â€“ they will not be a shiftworker</span>
                    </span>
                </label>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Check the award for hours</span>
                </button>
                <div class="help-content">
                    <p>The award sets out the:</p>
                    <ul>
                        <li>Maximum ordinary hours per day and week</li>
                        <li>Span of hours (when work can be performed)</li>
                        <li>Definition of shiftworker for your industry</li>
                        <li>Penalty rates for shift work</li>
                    </ul>
                    <p>Shift workers may be entitled to 5 weeks annual leave instead of 4 weeks.</p>
                </div>
            </div>
        </div>
        
        <!-- FLEXIBLE HOURS (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Flexible hours</h3>
            <p class="form-section-description">Include this clause to provide for employee requests to work flexible hours.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="flexibleHours" name="flexibleHours" 
                           ${data.flexibleHours ? 'checked' : ''} onchange="toggleClauseVisibility('flexibleHoursClause', this.checked)">
                    <span class="checkbox-text">Include Flexible hours clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.flexibleHours ? '' : 'collapsed'}" id="flexibleHoursClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Flexible hours clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>You may have a right to make a written request for flexible working arrangements under the National Employment Standards, including for when to start and end work each day or your location of work. We may refuse your request in writing, but only if we have reasonable business grounds.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Why provide flexible hours?</span>
                </button>
                <div class="help-content">
                    <p>Flexible hours can help support a positive employment relationship. For example, you might allow your employee to start and finish work earlier on some days to pick their child up from school.</p>
                    <p>Some employees are legally entitled to request flexible working arrangements (including flexible hours and patterns of work). You can only refuse these requests if you have a good business reason.</p>
                    <p>The right to request flexible working arrangements is a minimum entitlement in the National Employment Standards. You can't set conditions that are less than or exclude the National Employment Standards.</p>
                    <p><a href="https://www.fairwork.gov.au/employment-conditions/flexibility-in-the-workplace/flexible-working-arrangements" target="_blank" rel="noopener noreferrer">Find out more about flexible working arrangements</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <!-- AVERAGING HOURS (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Averaging hours over more than a week</h3>
            <p class="form-section-description">This allows averaging of the employee's ordinary hours over more than one week. This means they can work more one week and less in another. 
            <a href="https://www.fairwork.gov.au/employment-conditions/hours-of-work-breaks-and-rosters/hours-of-work" target="_blank" rel="noopener noreferrer">Check the award for specific rules around averaging hours</a> before you select this clause.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="averagingHours" name="averagingHours" 
                           ${data.averagingHours ? 'checked' : ''} onchange="toggleClauseVisibility('averagingHoursClause', this.checked)">
                    <span class="checkbox-text">Include Averaging hours clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.averagingHours ? '' : 'collapsed'}" id="averagingHoursClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Averaging hours clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>Your hours per week may be averaged over more than one week in accordance with the award.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Example of averaging hours</span>
                </button>
                <div class="help-content">
                    <p><strong>Example:</strong> Cindy works in a restaurant as a full-time employee and is covered by the Restaurant Industry Award. She averages her 38 hours a week by working 76 hours over 2 weeks. She works 42 hours the first week, and 34 hours the second week. 42 + 34 = 76 hours. So over 2 weeks she works an average of 38 hours per week.</p>
                    <p>This arrangement is also consistent with other rules in the Restaurant Industry Award 2020 about ordinary hours of work.</p>
                </div>
            </div>
        </div>
        
        <!-- ON CALL OR STAND-BY (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">On call or stand-by</h3>
            <p class="form-section-description">Include this if you'll sometimes want your employee to be on call (stand-by).</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="onCallStandby" name="onCallStandby" 
                           ${data.onCallStandby ? 'checked' : ''} onchange="toggleClauseVisibility('onCallClause', this.checked)">
                    <span class="checkbox-text">Include On call or stand-by clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.onCallStandby ? '' : 'collapsed'}" id="onCallClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">On call or stand-by clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>We may require you to be on call (on stand-by) for work outside your normal hours.</p>
                    <p>Your on call or stand-by conditions will be in accordance with the award, including:</p>
                    <ul>
                        <li>rostering to be on call</li>
                        <li>pay rates or allowances when on call</li>
                        <li>pay rates if you are called out to work while on call.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">On call rules & Right to disconnect</span>
                </button>
                <div class="help-content">
                    <p><strong>On call rules:</strong> On call means your employee is ready and available to work if you need them outside their normal work hours. If you want your employee to be on call (on stand-by), be aware that there may be rules in the award for:</p>
                    <ul>
                        <li>if and when you're allowed to roster your employee to be on call</li>
                        <li>pay rates or allowances when on call</li>
                        <li>pay rates if called out to work while on call</li>
                    </ul>
                    <p><strong>Right to disconnect:</strong> Employees have the right to refuse to monitor, read or respond to contact (or attempted contact) from their employer or a third-party outside of working hours, unless the refusal is unreasonable. Several factors must be considered when determining whether an employee's refusal is unreasonable, such as whether they are receiving compensation to be on call.</p>
                    <p><a href="https://www.fairwork.gov.au/employment-conditions/hours-of-work-breaks-and-rosters/right-to-disconnect" target="_blank" rel="noopener noreferrer">Learn about the right to disconnect</a> on the Fair Work Ombudsman's website.</p>
                </div>
            </div>
        </div>
        
        <!-- ROSTERS (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Rosters</h3>
            <p class="form-section-description">Include this clause to specify roster notice periods. Check the award rules for rosters on the <a href="https://www.fairwork.gov.au/employment-conditions/hours-of-work-breaks-and-rosters/rosters" target="_blank" rel="noopener noreferrer">Fair Work Ombudsman's Rosters page</a>.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="includeRostersClause" name="includeRostersClause" 
                           ${data.includeRostersClause ? 'checked' : ''} onchange="toggleRosterFields(this.checked)">
                    <span class="checkbox-text">Include Rosters clause (optional)</span>
                </label>
            </div>
            
            <div class="roster-fields ${data.includeRostersClause ? '' : 'collapsed'}" id="rosterFields">
                <div class="form-group">
                    <label class="form-label">How long before the start of a roster will you provide it to your employee?</label>
                    <p class="form-hint">e.g. 14 days (rosters are typically provided 7 or 14 days before they start).</p>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="rosterNoticeDays" name="rosterNoticeDays" 
                               value="${data.rosterNoticeDays || '7'}" min="1" max="30" placeholder="7">
                        <span class="input-suffix">day(s)</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">How much notice will you give your employee if you want to change the roster?</label>
                    <p class="form-hint">Changes to rosters typically require 7 days' notice for full and part-time employees.</p>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="rosterChangeDays" name="rosterChangeDays" 
                               value="${data.rosterChangeDays || '7'}" min="1" max="30" placeholder="7">
                        <span class="input-suffix">day(s)</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">How much notice will you require from your employee when they ask for a roster change?</label>
                    <p class="form-hint">e.g. 7 days.</p>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="employeeRosterNoticeDays" name="employeeRosterNoticeDays" 
                               value="${data.employeeRosterNoticeDays || '7'}" min="1" max="30" placeholder="7">
                        <span class="input-suffix">day(s)</span>
                    </div>
                </div>
                
                <div class="info-box" style="margin-bottom: 16px;">
                    <div class="info-box-content">
                        <p>â„¹ï¸ Make sure you check the award. Some have rules around when to provide rosters and how many days' notice you need to change them.</p>
                    </div>
                </div>
                
                <div class="clause-preview" id="rostersClause">
                    <div class="clause-header">
                        <span class="clause-icon">ðŸ“‹</span>
                        <span class="clause-title">Rosters clause</span>
                        <span class="clause-badge included">Included</span>
                    </div>
                    <div class="clause-content">
                        <p>We will provide you with your days and hours of work in a roster at least <strong>${data.rosterNoticeDays || '[number]'}</strong> day(s) before the start of the roster.</p>
                        <p>If we need to change your roster, we will give you <strong>${data.rosterChangeDays || '[number]'}</strong> days' notice or ask for your agreement to the change.</p>
                        <p>If you wish to ask for a change to your roster, we require <strong>${data.employeeRosterNoticeDays || '[number]'}</strong> days' notice. You will need our agreement to the change.</p>
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Roster rules</span>
                </button>
                <div class="help-content">
                    <p>A roster is a timetable that shows the days and times your employees are required to work.</p>
                    <p>Some awards have rules for rosters, including:</p>
                    <ul>
                        <li>when and how you need to provide them</li>
                        <li>notice you need to give your employee to change their roster</li>
                        <li>how to change a roster</li>
                        <li>consultation with your employee about changes to their regular roster</li>
                    </ul>
                    <p>Your employee should also give you notice when asking for a change to their roster, and they'll need your agreement to the change.</p>
                </div>
            </div>
        </div>
        
        <!-- BREAKS (Always Included) -->
        <div class="form-section">
            <h3 class="form-section-title">Breaks</h3>
            <p class="form-section-description">This provides a general clause in your employment contract about your employee's entitlement to breaks. Entitlements to breaks vary between awards, so check the award for details.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Breaks clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>Depending on the number of hours you work, you may be entitled to meal breaks. The award sets out:</p>
                    <ul>
                        <li>the length of the breaks</li>
                        <li>when they need to be taken</li>
                        <li>the rules about payment.</li>
                    </ul>
                    <p>You may also be entitled to rest breaks.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Breaks vary between awards</span>
                </button>
                <div class="help-content">
                    <p>Awards have different rules for rest breaks and meal breaks, including:</p>
                    <ul>
                        <li>the length of the breaks</li>
                        <li>when they need to be taken</li>
                        <li>the rules about payment</li>
                        <li>what happens if you don't provide a break</li>
                    </ul>
                    <p><a href="https://www.fairwork.gov.au/employment-conditions/hours-of-work-breaks-and-rosters/breaks" target="_blank" rel="noopener noreferrer">Find out more about breaks in your industry</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Pay & Conditions â†’</button>
        </div>
    `;
}

// Toggle clause visibility based on checkbox
function toggleClauseVisibility(clauseId, isVisible) {
    const clause = document.getElementById(clauseId);
    if (clause) {
        if (isVisible) {
            clause.classList.remove('collapsed');
        } else {
            clause.classList.add('collapsed');
        }
    }
    saveCurrentStepData();
}

function toggleRosterFields(isVisible) {
    const rosterFields = document.getElementById('rosterFields');
    if (rosterFields) {
        if (isVisible) {
            rosterFields.classList.remove('collapsed');
        } else {
            rosterFields.classList.add('collapsed');
        }
    }
    saveCurrentStepData();
}

function initializeStep2Listeners() {
    const inputs = document.querySelectorAll('#contractStepContent input, #contractStepContent select, #contractStepContent textarea');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
            // Update clause previews with current values
            updateStep2ClausePreviews();
        });
    });
}

function updateStep2ClausePreviews() {
    // Update hours clause with current value
    const hoursInput = document.getElementById('hoursPerWeek');
    const rostersClause = document.getElementById('rostersClause');
    
    if (rostersClause) {
        const rosterNoticeDays = document.getElementById('rosterNoticeDays')?.value || '[number]';
        const rosterChangeDays = document.getElementById('rosterChangeDays')?.value || '[number]';
        const employeeRosterNoticeDays = document.getElementById('employeeRosterNoticeDays')?.value || '[number]';
        
        const clauseContent = rostersClause.querySelector('.clause-content');
        if (clauseContent) {
            clauseContent.innerHTML = `
                <p>We will provide you with your days and hours of work in a roster at least <strong>${rosterNoticeDays}</strong> day(s) before the start of the roster.</p>
                <p>If we need to change your roster, we will give you <strong>${rosterChangeDays}</strong> days' notice or ask for your agreement to the change.</p>
                <p>If you wish to ask for a change to your roster, we require <strong>${employeeRosterNoticeDays}</strong> days' notice. You will need our agreement to the change.</p>
            `;
        }
    }
}


function getStep3Template() {
    const data = contractBuilderState.data.step3;
    const empType = contractBuilderState.data.step1.employmentType;
    
    return `
        <h2 class="step-title">Pay and Conditions</h2>
        <p class="step-description">Set the compensation details for this position.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <!-- PAY RATE -->
        <div class="form-section">
            <h3 class="form-section-title required">What is the employee's rate of pay?</h3>
            <p class="form-section-description">Select an hourly or a weekly rate of pay. Use the <a href="https://www.fairwork.gov.au/pay-and-wages/paying-wages" target="_blank" rel="noopener noreferrer">Fair Work Ombudsman's Pay and Conditions Tool</a> to find minimum pay rates for your employee's classification level.</p>
            
            <div class="radio-group-vertical" style="margin-bottom: 16px;">
                <label class="radio-option-card">
                    <input type="radio" name="payRateType" value="hourly" ${data.payRateType === 'hourly' ? 'checked' : ''} onchange="updatePayRateLabel()">
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>hourly</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="payRateType" value="weekly" ${data.payRateType === 'weekly' ? 'checked' : ''} onchange="updatePayRateLabel()">
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>weekly</span>
                    </span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" id="payRateLabelText">Enter the ${data.payRateType || 'hourly'} pay rate</label>
                <div class="input-with-prefix-suffix">
                    <span class="input-prefix">$AUD</span>
                    <input type="number" class="form-input" id="payRate" name="payRate" 
                           value="${data.payRate}" 
                           placeholder="0.00"
                           step="0.01" min="0">
                    <span class="input-suffix" id="payRateSuffix">per ${data.payRateType === 'weekly' ? 'week' : 'hour'}</span>
                </div>
            </div>
            
            <div class="info-box" style="border-color: #17a2b8; background: #e7f6f8;">
                <div class="info-box-title" style="color: #0c5460;">â„¹ï¸ Award minimum rate</div>
                <div class="info-box-content">
                    <p>Enter an amount that, at least, covers the minimum award rate that applies to your employee's classification. Award minimum rates for juniors, apprentices, trainees or employees on a supported wage may be lower.</p>
                    <p>Some awards also include introductory minimum rates for the early stages of jobs or entry level jobs. These typically can only apply on a temporary basis. Check the award for more information.</p>
                </div>
            </div>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Pay clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You will be paid <strong>$${data.payRate || '[number]'}</strong> per <strong>${data.payRateType === 'weekly' ? 'week' : 'hour'}</strong>. This pay rate does not include superannuation, we'll pay this separately.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Wages</span>
                </button>
                <div class="help-content">
                    <p>Your employee's minimum wages are set out under the award â€“ you must pay at least this amount. You'll also have to pay any applicable penalties, overtime, loadings and allowances.</p>
                </div>
            </div>
        </div>
        
        <!-- PAYMENT METHOD -->
        <div class="form-section">
            <h3 class="form-section-title required">How often will you pay your employee?</h3>
            <p class="form-section-description">Check how often you have to pay by selecting the employee's award on the <a href="https://www.fairwork.gov.au/pay-and-wages/paying-wages" target="_blank" rel="noopener noreferrer">Fair Work Ombudsman's Frequency of pay page</a>.</p>
            
            <div class="radio-group-vertical" style="margin-bottom: 20px;">
                <label class="radio-option-card">
                    <input type="radio" name="payFrequency" value="weekly" ${data.payFrequency === 'weekly' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>weekly</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="payFrequency" value="fortnightly" ${data.payFrequency === 'fortnightly' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>fortnightly</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="payFrequency" value="monthly" ${data.payFrequency === 'monthly' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>monthly</span>
                    </span>
                </label>
            </div>
            
            <h3 class="form-section-title required">How will you pay your employee?</h3>
            <p class="form-section-description">It's up to you which method you use, but record keeping might be easier if you pay electronically into a bank account.</p>
            
            <div class="radio-group-vertical">
                <label class="radio-option-card">
                    <input type="radio" name="payMethod" value="bank" ${data.payMethod === 'bank' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>into the employee's nominated bank account</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="payMethod" value="cash" ${data.payMethod === 'cash' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>in cash</span>
                    </span>
                </label>
                <label class="radio-option-card">
                    <input type="radio" name="payMethod" value="cheque" ${data.payMethod === 'cheque' ? 'checked' : ''}>
                    <span class="radio-card-content">
                        <span class="radio-indicator"></span>
                        <span>by cheque</span>
                    </span>
                </label>
            </div>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Payment method clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>We will pay you <strong>${data.payFrequency || 'weekly'}</strong> into your nominated bank account.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">How and when to pay</span>
                </button>
                <div class="help-content">
                    <p>Most awards outline how often you must pay employees â€“ generally it will be weekly or fortnightly, and it must be at least monthly. You must pay money. Do not 'pay in kind', for example, with goods or food.</p>
                </div>
            </div>
        </div>
        
        <!-- SUPERANNUATION -->
        <div class="form-section">
            <h3 class="form-section-title">Superannuation</h3>
            <p class="form-section-description">To avoid the superannuation guarantee charge (SGC), you must ensure super guarantee (SG) contributions for eligible employees are:</p>
            <ul style="color: #495057; margin: 0 0 16px 20px; font-size: 14px;">
                <li>paid at the correct amount in full</li>
                <li>received by their super fund by the quarterly due dates</li>
                <li>paid into a fund that meets the choice of fund rules.</li>
            </ul>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Superannuation clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>If you are eligible for the super guarantee (SG), we will pay the contributions on your behalf in accordance with legislation and your award. We will pay contributions into a super fund of your choice.</p>
                    <p>If you do not tell us your choice of fund, we may need to contact the ATO to find out if you have a 'stapled' super fund to make your SG contributions into.</p>
                    <p>If you do not tell us your choice of fund and the ATO confirms you don't have a stapled super fund, we will pay your SG contributions to our default fund or another fund that meets the choice of fund rules.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Is your employee eligible?</span>
                </button>
                <div class="help-content">
                    <p>Generally, all employees are eligible for super guarantee (SG) regardless of how much they earn. It doesn't matter if they are:</p>
                    <ul>
                        <li>full-time, part-time, or casual</li>
                        <li>a temporary resident</li>
                        <li>receiving a super pension or annuity while still working</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ADDITIONAL SUPER CONTRIBUTIONS (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Additional super contributions</h3>
            <p class="form-section-description">Select this clause if the <a href="https://www.fairwork.gov.au/pay-and-wages/superannuation" target="_blank" rel="noopener noreferrer">award requires additional super</a> on top of the super guarantee (SG). If the award does not require additional super, you can choose whether to pay extra as an incentive to your employee.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="additionalSuper" name="additionalSuper" 
                           ${data.additionalSuper ? 'checked' : ''} onchange="toggleClauseVisibility('additionalSuperClause', this.checked)">
                    <span class="checkbox-text">Include Additional superannuation clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.additionalSuper ? '' : 'collapsed'}" id="additionalSuperClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Additional superannuation clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Additional super percentage:</label>
                        <div class="input-with-suffix" style="max-width: 150px;">
                            <input type="number" class="form-input" id="additionalSuperPercent" name="additionalSuperPercent" 
                                   value="${data.additionalSuperPercent || ''}" placeholder="0" step="0.5" min="0" max="50">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <p>In addition to the SG, we will contribute <strong>${data.additionalSuperPercent || '[number]'} percent</strong> of your base salary into super.</p>
                </div>
            </div>
        </div>
        
        <!-- PENALTY RATES AND OVERTIME (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Penalty rates and overtime</h3>
            <p class="form-section-description">Your employee may be entitled to overtime or penalty rates, depending on the hours they work. You must pay overtime or penalty rates if your employee is entitled to them, even if you do not include this clause.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="penaltyRatesOvertime" name="penaltyRatesOvertime" 
                           ${data.penaltyRatesOvertime ? 'checked' : ''} onchange="toggleClauseVisibility('penaltyRatesClause', this.checked)">
                    <span class="checkbox-text">Include Penalty rates and overtime clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.penaltyRatesOvertime ? '' : 'collapsed'}" id="penaltyRatesClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Penalty rates and overtime clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>You may be entitled to overtime rates under your award if you work:</p>
                    <ul>
                        <li>more than your ordinary hours of work</li>
                        <li>outside the spread of ordinary hours.</li>
                    </ul>
                    <p>You may be entitled to penalty rates or shift loadings according to your award if you work:</p>
                    <ul>
                        <li>on a weekend</li>
                        <li>on a public holiday</li>
                        <li>late night or early morning shifts.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Rules vary between awards</span>
                </button>
                <div class="help-content">
                    <p>The rules around penalty rates and overtime differ between awards. Check the award for details (including pay rates).</p>
                    <p>Find out more about <a href="https://www.fairwork.gov.au/pay-and-wages/penalty-rates-and-allowances" target="_blank" rel="noopener noreferrer">penalty rates</a> and <a href="https://www.fairwork.gov.au/pay-and-wages/overtime" target="_blank" rel="noopener noreferrer">overtime</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <!-- ALLOWANCES (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Allowances</h3>
            <p class="form-section-description">Include this to add a general allowances clause to your employment agreement. You must pay allowances if your employee is entitled to them, even if you do not include this clause.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="allowances" name="allowances" 
                           ${data.allowances ? 'checked' : ''} onchange="toggleClauseVisibility('allowancesClause', this.checked)">
                    <span class="checkbox-text">Include Allowances clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.allowances ? '' : 'collapsed'}" id="allowancesClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Allowances clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>You may be entitled to allowances in accordance with your award, for example, if you:</p>
                    <ul>
                        <li>do certain tasks or are required to use a particular skill in the duties of your role</li>
                        <li>have to use your own tools at work</li>
                        <li>work in particular conditions, environments or in remote locations.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Examples of allowances</span>
                </button>
                <div class="help-content">
                    <p>Allowances are extra payments you may have to provide to your employee if they:</p>
                    <ul>
                        <li>use their own vehicle for work</li>
                        <li>work in unpleasant or hazardous conditions</li>
                        <li>hold special qualifications or licenses</li>
                        <li>are required to wear a uniform</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- COMMISSION (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Commission</h3>
            <p class="form-section-description">Include this if you plan to pay your employee commission on top of their wages or salary.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="commission" name="commission" 
                           ${data.commission ? 'checked' : ''} onchange="toggleClauseVisibility('commissionClause', this.checked)">
                    <span class="checkbox-text">Include Commission clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.commission ? '' : 'collapsed'}" id="commissionClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Commission clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>In addition to your base pay, we will pay you commission under the following arrangement:</p>
                    <div class="form-group" style="margin: 12px 0;">
                        <textarea class="form-textarea" id="commissionArrangement" name="commissionArrangement" 
                                  placeholder="Describe the commission arrangement, e.g., '5% of sales revenue generated by the employee'"
                                  style="min-height: 80px;">${data.commissionArrangement || ''}</textarea>
                    </div>
                    <p>If we agree to change this commission arrangement during your employment with us, we will update this employment contract. Any changes to your commission arrangement will be made according to the requirements of the modern award which applies to you.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">What commission is</span>
                </button>
                <div class="help-content">
                    <p>Commission is an amount paid to your employee, usually based on how much they sell. It's often calculated as either:</p>
                    <ul>
                        <li>a percentage of sales</li>
                        <li>a flat amount per sale or unit</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ANNUAL BONUS (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Annual bonus</h3>
            <p class="form-section-description">Include this if you want to use an annual bonus as an incentive to your employee.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="annualBonus" name="annualBonus" 
                           ${data.annualBonus ? 'checked' : ''} onchange="toggleClauseVisibility('annualBonusClause', this.checked)">
                    <span class="checkbox-text">Include Annual bonus clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.annualBonus ? '' : 'collapsed'}" id="annualBonusClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Annual bonus clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>We may pay you an annual bonus at our discretion, taking into consideration your performance and other relevant business factors.</p>
                    <p>There is no guarantee that you will get a bonus, and you will not be eligible for one after your employment with us ends.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Why offer a bonus?</span>
                </button>
                <div class="help-content">
                    <p>An annual bonus can be a great way to reward your employee's hard work throughout the year.</p>
                    <p>Whether you pay a bonus will be your decision, based on your employee's performance, how the business is going and other relevant factors.</p>
                </div>
            </div>
        </div>
        
        <!-- ANNUAL PAY REVIEW (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Annual pay review</h3>
            <p class="form-section-description">An annual pay review can help ensure you're paying your employee the right rate and keep them motivated.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="annualPayReview" name="annualPayReview" 
                           ${data.annualPayReview ? 'checked' : ''} onchange="toggleClauseVisibility('annualPayReviewClause', this.checked)">
                    <span class="checkbox-text">Include Annual pay review clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.annualPayReview ? '' : 'collapsed'}" id="annualPayReviewClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Annual pay review clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>We will review your pay annually to determine whether you are eligible for an increase, taking into consideration:</p>
                    <ul>
                        <li>your performance</li>
                        <li>the business's financial position.</li>
                    </ul>
                    <p>Any increase in your pay, above your award entitlements, is our decision.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Benefits of a pay review</span>
                </button>
                <div class="help-content">
                    <p>This is a good way to reward your employee's work over the year. It also helps ensure that you're keeping up with any award changes to minimum pay rates.</p>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Leave Entitlements â†’</button>
        </div>
    `;
}

function updatePayRateLabel() {
    const payRateType = document.querySelector('input[name="payRateType"]:checked')?.value || 'hourly';
    const labelText = document.getElementById('payRateLabelText');
    const suffix = document.getElementById('payRateSuffix');
    
    if (labelText) {
        labelText.textContent = 'Enter the ' + payRateType + ' pay rate';
    }
    if (suffix) {
        suffix.textContent = 'per ' + (payRateType === 'weekly' ? 'week' : 'hour');
    }
    
    saveCurrentStepData();
}

function initializeStep3Listeners() {
    const inputs = document.querySelectorAll('#contractStepContent input, #contractStepContent select, #contractStepContent textarea');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
}

// ========================================
// STEP 4: Leave Entitlements
// ========================================
function getStep4Template() {
    const data = contractBuilderState.data.step4;
    const empType = contractBuilderState.data.step1.employmentType;
    
    return `
        <h2 class="step-title">Leave Entitlements</h2>
        <p class="step-description">This section outlines the leave entitlements for this ${empType} position.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        ${empType === 'casual' ? `
        <div class="info-box" style="border-color: #17a2b8; background: #e7f6f8; margin-bottom: 24px;">
            <div class="info-box-title" style="color: #0c5460;">â„¹ï¸ Casual employees and leave</div>
            <div class="info-box-content">
                <p>Casual employees generally don't receive paid annual leave or personal/carer's leave. Instead, they receive a casual loading (typically 25%) to compensate.</p>
                <p>However, casual employees are still entitled to:</p>
                <ul>
                    <li>2 days unpaid carer's leave per occasion</li>
                    <li>2 days unpaid compassionate leave per occasion</li>
                    <li>Community service leave</li>
                    <li>Family and domestic violence leave</li>
                </ul>
            </div>
        </div>
        ` : ''}
        
        ${empType !== 'casual' ? `
        <!-- ANNUAL LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title required">Annual leave</h3>
            <p class="form-section-description">An employee (other than a casual employee) generally accumulates 4 weeks of paid annual leave for each year of service with the employer based on their ordinary hours of work.</p>
            <p class="form-section-description">Some awards can provide more than 4 weeks of annual leave. Shiftworkers who meet the definition of a shiftworker in their award are also entitled to an extra week of annual leave.</p>
            <p class="form-section-description">Check your employee's award to see if they are entitled to more than 4 weeks of annual leave each year.</p>
            
            <div class="form-group">
                <label class="form-label">Would you like to measure your employee's annual leave in weeks, days or hours?</label>
                <div class="radio-group-vertical" style="margin-top: 8px;">
                    <label class="radio-option-card">
                        <input type="radio" name="annualLeaveMeasure" value="weeks" ${data.annualLeaveMeasure === 'weeks' ? 'checked' : ''} onchange="updateAnnualLeaveClause()">
                        <span class="radio-card-content">
                            <span class="radio-indicator"></span>
                            <span>Weeks</span>
                        </span>
                    </label>
                    <label class="radio-option-card">
                        <input type="radio" name="annualLeaveMeasure" value="days" ${data.annualLeaveMeasure === 'days' ? 'checked' : ''} onchange="updateAnnualLeaveClause()">
                        <span class="radio-card-content">
                            <span class="radio-indicator"></span>
                            <span>Days</span>
                        </span>
                    </label>
                    <label class="radio-option-card">
                        <input type="radio" name="annualLeaveMeasure" value="hours" ${data.annualLeaveMeasure === 'hours' ? 'checked' : ''} onchange="updateAnnualLeaveClause()">
                        <span class="radio-card-content">
                            <span class="radio-indicator"></span>
                            <span>Hours</span>
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">How much annual leave will your employee get each year?</label>
                <p class="form-hint">Enter an amount based on their ordinary hours of work</p>
                <div class="input-with-suffix">
                    <input type="number" class="form-input" id="annualLeaveAmount" name="annualLeaveAmount" 
                           value="${data.annualLeaveAmount || '4'}" min="1" max="52" placeholder="4" onchange="updateAnnualLeaveClause()">
                    <span class="input-suffix" id="annualLeaveSuffix">${data.annualLeaveMeasure || 'week'}(s)</span>
                </div>
            </div>
            
            <div class="clause-preview" id="annualLeaveClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Annual leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You are entitled to <strong>${data.annualLeaveAmount || '4'} ${data.annualLeaveMeasure || 'week'}(s)</strong> of annual leave each year, based on your ordinary hours of work per week.</p>
                    <p>We will provide any applicable annual leave loading entitlements in accordance with your award.</p>
                    <p>Annual leave accumulates during the year. Any unused annual leave will roll over from year to year.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">How much annual leave</span>
                </button>
                <div class="help-content">
                    <p>Under the National Employment Standards (NES), full-time and part-time employees accrue 4 weeks of paid annual leave each year, based on their ordinary hours of work. Annual leave accumulates gradually during the year (pro-rata for part-time employees).</p>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- PARENTAL LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Parental leave</h3>
            <p class="form-section-description">Your employee may be entitled to 12 months of unpaid parental leave after working for you for at least 12 months.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Parental leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>After you have been working for us for 12 months or more, you may be entitled to take unpaid parental leave from your position for 12 months.</p>
                    <p>You may also:</p>
                    <ul>
                        <li>request up to an extra 12 months of unpaid parental leave</li>
                        <li>be entitled to Parental Leave Pay from the Australian Government, administered by Services Australia.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Who gets parental leave</span>
                </button>
                <div class="help-content">
                    <p>The parental leave entitlement applies to full and part-time employees. Casual employees may also get parental leave if they:</p>
                    <ul>
                        <li>have worked for you on a regular and systematic basis for 12 months or more</li>
                        <li>had a reasonable expectation of continuing their employment on a regular and systematic basis had it not been for the birth or adoption of a child.</li>
                    </ul>
                    <p><a href="https://www.fairwork.gov.au/leave/maternity-and-parental-leave" target="_blank" rel="noopener noreferrer">Find out more about parental leave</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <!-- ADDITIONAL PARENTAL LEAVE (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Additional parental leave</h3>
            <p class="form-section-description">You can choose whether to provide additional paid leave (on top of the above parental leave) as an incentive.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="additionalParentalLeave" name="additionalParentalLeave" 
                           ${data.additionalParentalLeave ? 'checked' : ''} onchange="toggleClauseVisibility('additionalParentalLeaveClause', this.checked)">
                    <span class="checkbox-text">Include Additional parental leave clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.additionalParentalLeave ? '' : 'collapsed'}" id="additionalParentalLeaveClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Additional parental leave clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Number of weeks:</label>
                        <div class="input-with-suffix" style="max-width: 150px;">
                            <input type="number" class="form-input" id="additionalParentalLeaveWeeks" name="additionalParentalLeaveWeeks" 
                                   value="${data.additionalParentalLeaveWeeks || ''}" placeholder="0" min="0" max="52">
                            <span class="input-suffix">week(s)</span>
                        </div>
                    </div>
                    <p>In addition to the above parental leave, we will provide you with <strong>${data.additionalParentalLeaveWeeks || '[number]'} week(s)</strong> paid parental leave.</p>
                </div>
            </div>
        </div>
        
        ${empType !== 'casual' ? `
        <!-- PERSONAL/CARER'S LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Personal/carer's leave</h3>
            <p class="form-section-description">This sets out your employee's entitlement to personal and carer's leave in your employment contract. Casual employees are entitled to unpaid carer's leave.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Personal/carer's leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You are entitled to accrue 10 days paid personal/carer's leave (pro-rata for part-time employees) per year based on your ordinary hours of work. This is calculated as 1/26 of your ordinary hours of work in a year.</p>
                    <p>You can take personal/carer's leave when you can't work because you are sick or injured. You can also use it to care for a member of your immediate family or household who requires care or support because of:</p>
                    <ul>
                        <li>personal injury</li>
                        <li>personal illness</li>
                        <li>an unexpected emergency.</li>
                    </ul>
                    <p>Your personal/carer's leave accrues throughout the year and from year to year. You must give us notice as soon as possible to take personal/carer's leave. We may also require evidence (such as a medical certificate).</p>
                    <p>You are also entitled to 2 days unpaid carer's leave (in accordance with the National Employment Standards). This is available each time an immediate family member or household member needs your care or support. You can only take unpaid carer's leave if you do not have any paid personal/carer's leave left.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Personal, carer's and sick leave</span>
                </button>
                <div class="help-content">
                    <p>Personal/carer's leave (sometimes called sick and carer's leave) is for when your employee cannot work because:</p>
                    <ul>
                        <li>they're sick or injured, or</li>
                        <li>a member of their immediate family or household needs their care or support for an injury, sickness or unexpected emergency.</li>
                    </ul>
                    <p><a href="https://www.fairwork.gov.au/leave/sick-and-carers-leave" target="_blank" rel="noopener noreferrer">Find out more about personal/carer's leave</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- COMPASSIONATE LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Compassionate leave</h3>
            <p class="form-section-description">This sets out compassionate leave entitlements in your employment contract.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Compassionate leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You are entitled to 2 days ${empType === 'casual' ? 'unpaid' : 'paid'} compassionate leave (in accordance with the National Employment Standards) each time:</p>
                    <ul>
                        <li>a member of your immediate family or household dies, or contracts or develops a life threatening illness or injury</li>
                        <li>a child is stillborn, that would have been a member of your immediate family or household if born alive</li>
                        <li>you or your current spouse or de facto partner has a miscarriage.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Paid or unpaid?</span>
                </button>
                <div class="help-content">
                    <ul>
                        <li>Full and part-time employees get paid compassionate leave.</li>
                        <li>Casual employees get unpaid compassionate leave.</li>
                    </ul>
                    <p><a href="https://www.fairwork.gov.au/leave/compassionate-and-bereavement-leave" target="_blank" rel="noopener noreferrer">Find out more about compassionate and bereavement leave</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <!-- COMMUNITY SERVICE LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Community service leave</h3>
            <p class="form-section-description">This sets out your employee's entitlement to community service leave in your employment contract.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Community service leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You may be entitled to community service leave (in accordance with the National Employment Standards) for certain activities such as:</p>
                    <ul>
                        <li>voluntary emergency management activities</li>
                        <li>jury duty and jury selection.</li>
                    </ul>
                    <p>You must give us:</p>
                    <ul>
                        <li>notice of your leave as soon as possible</li>
                        <li>details of the period, or expected period, that you will be away from work.</li>
                    </ul>
                    <p>We may ask you to provide evidence that you require community service leave.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Community service leave entitlements</span>
                </button>
                <div class="help-content">
                    <p>Community service leave is unpaid, except for the first 10 days of absence from work because of jury duty.</p>
                </div>
            </div>
        </div>
        
        <!-- FAMILY AND DOMESTIC VIOLENCE LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Family and domestic violence leave</h3>
            <p class="form-section-description">This sets out your employee's entitlement to family and domestic violence leave in your employment contract.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Family and domestic violence leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You may be entitled to 10 days of paid family and domestic violence leave (in accordance with the National Employment Standards) each 12 month period.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Who it applies to</span>
                </button>
                <div class="help-content">
                    <p>All employees (including part-time and casual employees) are entitled to 10 full days of paid family and domestic violence leave each 12 month period.</p>
                </div>
            </div>
        </div>
        
        <!-- PUBLIC HOLIDAYS -->
        <div class="form-section">
            <h3 class="form-section-title">Public holidays</h3>
            <p class="form-section-description">This sets out the work and pay rules for public holidays in your employment contract.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Public holiday clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You have a right to be absent from work on a public holiday.</p>
                    <p>We may ask you to work on a public holiday. You may refuse our request to work (in accordance with the Fair Work Act 2009) if:</p>
                    <ul>
                        <li>your refusal is reasonable, or</li>
                        <li>our request is unreasonable.</li>
                    </ul>
                    <p>If you work on a public holiday, you are entitled to any additional entitlements under your award, such as public holiday penalty rates.</p>
                    <p>If you do not work on a public holiday, and it falls on a day you would normally work, you are entitled to be paid your base rate of pay for your ordinary hours of work on that day.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Work on a public holiday</span>
                </button>
                <div class="help-content">
                    <ul>
                        <li>You can ask an employee to work on a public holiday â€“ if it's reasonable.</li>
                        <li>If they do work, you'll need to pay them at least the award rates for public holidays.</li>
                    </ul>
                    <p><a href="https://www.fairwork.gov.au/leave/public-holidays" target="_blank" rel="noopener noreferrer">Find out more about public holidays</a> on the Fair Work Ombudsman website.</p>
                </div>
            </div>
        </div>
        
        <!-- LONG SERVICE LEAVE -->
        <div class="form-section">
            <h3 class="form-section-title">Long service leave</h3>
            <p class="form-section-description">This provides an overview of long service leave in your employment contract.</p>
            <p class="form-section-description">Long service leave rules differ between states and territories, as well as between industries, so specific details are not provided here.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Long service leave clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You may be entitled to long service leave after working with us for a specific period of time in accordance with relevant state or territory legislation or the Fair Work Act.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Long service leave laws</span>
                </button>
                <div class="help-content">
                    <p>State and territory laws (and in some cases long service leave terms under pre-modern awards which have been preserved under the National Employment Standards) set out how:</p>
                    <ul>
                        <li>long service leave accrues</li>
                        <li>when it can be taken</li>
                        <li>how much leave an employee gets</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Additional Terms â†’</button>
        </div>
    `;
}

function updateAnnualLeaveClause() {
    const measure = document.querySelector('input[name="annualLeaveMeasure"]:checked')?.value || 'weeks';
    const amount = document.getElementById('annualLeaveAmount')?.value || '4';
    
    // Update suffix label
    const suffix = document.getElementById('annualLeaveSuffix');
    if (suffix) {
        suffix.textContent = measure === 'weeks' ? 'week(s)' : measure === 'days' ? 'day(s)' : 'hour(s)';
    }
    
    // Update clause preview
    const clause = document.getElementById('annualLeaveClause');
    if (clause) {
        const clauseContent = clause.querySelector('.clause-content');
        if (clauseContent) {
            clauseContent.innerHTML = `
                <p>You are entitled to <strong>${amount} ${measure === 'weeks' ? 'week' : measure === 'days' ? 'day' : 'hour'}(s)</strong> of annual leave each year, based on your ordinary hours of work per week.</p>
                <p>We will provide any applicable annual leave loading entitlements in accordance with your award.</p>
                <p>Annual leave accumulates during the year. Any unused annual leave will roll over from year to year.</p>
            `;
        }
    }
    
    saveCurrentStepData();
}

function initializeStep4Listeners() {
    const inputs = document.querySelectorAll('#contractStepContent input');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
}

// ========================================
// STEP 5: Additional Terms and Obligations
// ========================================
function getStep5Template() {
    const data = contractBuilderState.data.step5;
    
    return `
        <h2 class="step-title">Additional Terms and Obligations</h2>
        <p class="step-description">Select optional clauses to include in the contract.</p>
        
        <div class="info-box">
            <div class="info-box-content">
                <p>These clauses are <strong>optional</strong> but recommended for protecting your business interests. Select the ones relevant to this position.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="employeeObligations" name="employeeObligations" 
                       ${data.employeeObligations ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Employee Obligations</strong> - General duties and conduct requirements</span>
            </label>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">What are employee obligations?</span>
            </button>
            <div class="help-content">
                <p>Standard obligations include:</p>
                <ul>
                    <li>Following lawful and reasonable directions</li>
                    <li>Complying with workplace policies and procedures</li>
                    <li>Acting in good faith and in the employer's best interests</li>
                    <li>Maintaining professional conduct</li>
                    <li>Following health and safety requirements</li>
                </ul>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="conflictOfInterest" name="conflictOfInterest" 
                       ${data.conflictOfInterest ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Conflict of Interest</strong> - Disclosure of potential conflicts</span>
            </label>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">When to use a conflict of interest clause</span>
            </button>
            <div class="help-content">
                <p>A conflict of interest clause requires employees to:</p>
                <ul>
                    <li>Disclose any outside business interests</li>
                    <li>Not work for competitors during employment</li>
                    <li>Declare any personal relationships that could affect their role</li>
                    <li>Avoid situations where personal interest conflicts with business</li>
                </ul>
                <p>Particularly important for management and senior positions.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="confidentiality" name="confidentiality" 
                       ${data.confidentiality ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Confidentiality</strong> - Protection of business information</span>
            </label>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">What information is confidential?</span>
            </button>
            <div class="help-content">
                <p>Confidential information may include:</p>
                <ul>
                    <li>Business strategies and plans</li>
                    <li>Customer lists and supplier details</li>
                    <li>Recipes and menu development</li>
                    <li>Financial information</li>
                    <li>Trade secrets and proprietary processes</li>
                </ul>
                <p>This clause prevents employees from sharing this information during and after employment.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="intellectualProperty" name="intellectualProperty" 
                       ${data.intellectualProperty ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Intellectual Property</strong> - Ownership of work created during employment</span>
            </label>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">IP examples in hospitality</span>
            </button>
            <div class="help-content">
                <p>In hospitality, intellectual property might include:</p>
                <ul>
                    <li>Original recipes developed by chefs</li>
                    <li>Menu designs and concepts</li>
                    <li>Marketing materials created by staff</li>
                    <li>Photos and social media content</li>
                    <li>Training materials and procedures</li>
                </ul>
                <p>This clause ensures the business owns work created by employees during their employment.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="consultation" name="consultation" 
                       ${data.consultation ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Consultation</strong> - Process for workplace changes</span>
            </label>
        </div>
        
        <div class="help-section">
            <button class="help-toggle" onclick="toggleHelpSection(this)">
                <span class="help-toggle-icon">â–¶</span>
                <span class="help-toggle-text">Why consult employees?</span>
            </button>
            <div class="help-content">
                <p>When making major workplace changes, employers should consult with affected employees about:</p>
                <ul>
                    <li>Changes to rosters or working hours</li>
                    <li>Introduction of new technology</li>
                    <li>Restructuring or role changes</li>
                    <li>Workplace relocations</li>
                </ul>
                <p>Many Modern Awards require consultation processes.</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="disputes" name="disputes" 
                       ${data.disputes ? 'checked' : ''}>
                <span class="checkbox-text"><strong>Dispute Resolution</strong> - Process for resolving workplace disputes</span>
            </label>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Ending Employment â†’</button>
        </div>
    `;
}

function initializeStep5Listeners() {
    const inputs = document.querySelectorAll('#contractStepContent input');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
}

// Continue with Steps 6-8 in next file...
// ========================================
// STEP 6: Ending Employment
// ========================================
function getStep6Template() {
    const data = contractBuilderState.data.step6;
    
    return `
        <h2 class="step-title">Ending Employment</h2>
        <p class="step-description">Define the notice periods and termination terms for this employment contract.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <!-- RESIGNATION NOTICE -->
        <div class="form-section">
            <h3 class="form-section-title required">Resignation notice</h3>
            <p class="form-section-description"><strong>If your employee resigns, how much notice will they need to give you?</strong></p>
            <p class="form-section-description">Insert at least the <a href="https://www.fairwork.gov.au/ending-employment/notice-and-final-pay" target="_blank" rel="noopener noreferrer">minimum notice</a> from the award. If your award isn't listed, choose 'Other' then find it in the linked list of awards. If the award doesn't have rules, consider using the same minimum notice period required for dismissals.</p>
            
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 16px 0;">
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 16px;">
                    <div style="color: #212529; font-weight: 600;">Continuous employment</div>
                    <div style="color: #212529; font-weight: 600;">Minimum notice period</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 12px; align-items: center;">
                    <div style="color: #495057;">1 year or less</div>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="resignYear1" name="resignYear1" 
                               value="${data.resignationNotice?.year1 || '1'}" min="1" max="12" style="width: 80px;" onchange="updateResignationClause()">
                        <span class="input-suffix">week(s)</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 12px; align-items: center;">
                    <div style="color: #495057;">More than 1 year to 3 years</div>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="resignYear1to3" name="resignYear1to3" 
                               value="${data.resignationNotice?.year1to3 || '2'}" min="1" max="12" style="width: 80px;" onchange="updateResignationClause()">
                        <span class="input-suffix">week(s)</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 12px; align-items: center;">
                    <div style="color: #495057;">More than 3 years to 5 years</div>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="resignYear3to5" name="resignYear3to5" 
                               value="${data.resignationNotice?.year3to5 || '3'}" min="1" max="12" style="width: 80px;" onchange="updateResignationClause()">
                        <span class="input-suffix">week(s)</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; align-items: center;">
                    <div style="color: #495057;">More than 5 years</div>
                    <div class="input-with-suffix">
                        <input type="number" class="form-input" id="resignYear5plus" name="resignYear5plus" 
                               value="${data.resignationNotice?.year5plus || '4'}" min="1" max="12" style="width: 80px;" onchange="updateResignationClause()">
                        <span class="input-suffix">week(s)</span>
                    </div>
                </div>
            </div>
            
            <div class="clause-preview" id="resignationClause">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Resignation notice clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You must give us the following minimum notice periods if you resign.</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px 0; color: #212529;">Continuous employment with us</th>
                                <th style="text-align: left; padding: 8px 0; color: #212529;">Minimum notice period</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">1 year or less</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>${data.resignationNotice?.year1 || '1'}</strong> week(s)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">More than 1 year to 3 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>${data.resignationNotice?.year1to3 || '2'}</strong> week(s)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">More than 3 years to 5 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>${data.resignationNotice?.year3to5 || '3'}</strong> week(s)</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #495057;">More than 5 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>${data.resignationNotice?.year5plus || '4'}</strong> week(s)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Notice period</span>
                </button>
                <div class="help-content">
                    <p>When an employee resigns, they have to give notice to you. The minimum notice period is the length of time they must give notice to you before they end employment.</p>
                </div>
            </div>
        </div>
        
        <!-- DISMISSAL NOTICE -->
        <div class="form-section">
            <h3 class="form-section-title">Dismissal notice</h3>
            <p class="form-section-description">If you dismiss an employee, you must provide specific minimum notice periods or the equivalent pay (unless they're in the list of employees that do not get notice). You should also <a href="https://www.fairwork.gov.au/ending-employment/notice-and-final-pay" target="_blank" rel="noopener noreferrer">check the minimum notice in the award</a> â€“ some have longer notice periods. If your award isn't listed, choose 'Other' then find it in the linked list of awards.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Dismissal notice clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>You are entitled to the following minimum notice periods (or payment in lieu of notice) if we end your employment. This does not apply if we end your employment for serious misconduct.</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px 0; color: #212529;">Continuous employment with us</th>
                                <th style="text-align: left; padding: 8px 0; color: #212529;">Minimum notice period</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">1 year or less</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>1 week</strong></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">More than 1 year to 3 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>2 weeks</strong></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px 0; color: #495057;">More than 3 years to 5 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>3 weeks</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #495057;">More than 5 years</td>
                                <td style="padding: 8px 0; color: #495057;"><strong>4 weeks</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top: 12px;">You may be entitled to a longer minimum notice period under your award.</p>
                    <p>You will get an extra week of notice if you're older than 45 years and have worked for us for at least 2 years.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Some employees do not get notice</span>
                </button>
                <div class="help-content">
                    <p>Exclusions apply. For example, employees do not get notice if their employment is terminated:</p>
                    <ul>
                        <li>for serious misconduct</li>
                        <li>if they're a casual employee</li>
                        <li>if they're employed for a specified period of time, task, or season</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- REDUNDANCY -->
        <div class="form-section">
            <h3 class="form-section-title">Redundancy</h3>
            <p class="form-section-description">Redundancy can occur when you either no longer need an employee's job to be done by anyone (e.g. you get technology that replaces the job), or you become insolvent or bankrupt.</p>
            
            <div class="clause-preview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Redundancy clause</span>
                    <span class="clause-badge included">Included</span>
                </div>
                <div class="clause-content">
                    <p>If your position is terminated due to redundancy, any notice and redundancy pay entitlements will be in accordance with the National Employment Standards and your award.</p>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Redundancy pay</span>
                </button>
                <div class="help-content">
                    <p>When an employee's job is made redundant, you may have to provide redundancy pay if:</p>
                    <ul>
                        <li>the employee has at least 12 months continuous service</li>
                        <li>your business has 15 or more employees</li>
                    </ul>
                    <p>The amount depends on the employee's years of service.</p>
                </div>
            </div>
        </div>
        
        <!-- MISCONDUCT (Optional) -->
        <div class="form-section">
            <h3 class="form-section-title">Misconduct</h3>
            <p class="form-section-description">This sets out that you can dismiss (fire) the employee for serious misconduct without notice.</p>
            
            <div class="optional-clause-toggle">
                <label class="checkbox-label">
                    <input type="checkbox" class="checkbox-input" id="misconductClause" name="misconductClause" 
                           ${data.misconductClause ? 'checked' : ''} onchange="toggleClauseVisibility('misconductClausePreview', this.checked)">
                    <span class="checkbox-text">Include Misconduct clause (optional)</span>
                </label>
            </div>
            
            <div class="clause-preview ${data.misconductClause ? '' : 'collapsed'}" id="misconductClausePreview">
                <div class="clause-header">
                    <span class="clause-icon">ðŸ“‹</span>
                    <span class="clause-title">Misconduct clause</span>
                    <span class="clause-badge optional">Optional to include</span>
                </div>
                <div class="clause-content">
                    <p>We may terminate your employment without notice, or payment in lieu of notice, if you engage in serious misconduct.</p>
                    <p>Serious misconduct is when an employee:</p>
                    <ul>
                        <li>causes serious and imminent risk to the health and safety of another person or to the reputation, viability or profits of their employer's business, or</li>
                        <li>wilfully or deliberately behaves in a way that's inconsistent with continuing their employment.</li>
                    </ul>
                    <p>Examples of serious misconduct include:</p>
                    <ul>
                        <li>theft</li>
                        <li>fraud</li>
                        <li>violence/assault</li>
                        <li>sexual harassment</li>
                        <li>serious breaches of health and safety requirements</li>
                        <li>being drunk or affected by drugs at work</li>
                        <li>refusing to carry out work duties.</li>
                    </ul>
                </div>
            </div>
            
            <div class="help-section">
                <button class="help-toggle" onclick="toggleHelpSection(this)">
                    <span class="help-toggle-icon">â–¶</span>
                    <span class="help-toggle-text">Serious misconduct</span>
                </button>
                <div class="help-content">
                    <p>To dismiss an employee without notice, you must believe that their conduct is serious enough to justify immediate dismissal.</p>
                    <p>It's a good idea to document the misconduct, in case your employee makes an unfair dismissal claim. Be careful dismissing an employee this way. If the dismissal is found to be unfair, you may have to pay compensation, lost wages and/or give the employee their job back.</p>
                    <p><a href="https://www.fairwork.gov.au/ending-employment/dismissal/misconduct-and-serious-misconduct" target="_blank" rel="noopener noreferrer">Check the Fair Work Ombudsman's website for more information on serious misconduct</a>.</p>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-secondary" onclick="saveContractProgress()">ðŸ’¾ Save Progress</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Review Contract â†’</button>
        </div>
    `;
}

function updateResignationClause() {
    const year1 = document.getElementById('resignYear1')?.value || '1';
    const year1to3 = document.getElementById('resignYear1to3')?.value || '2';
    const year3to5 = document.getElementById('resignYear3to5')?.value || '3';
    const year5plus = document.getElementById('resignYear5plus')?.value || '4';
    
    const clause = document.getElementById('resignationClause');
    if (clause) {
        const clauseContent = clause.querySelector('.clause-content');
        if (clauseContent) {
            clauseContent.innerHTML = `
                <p>You must give us the following minimum notice periods if you resign.</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #dee2e6;">
                            <th style="text-align: left; padding: 8px 0; color: #212529;">Continuous employment with us</th>
                            <th style="text-align: left; padding: 8px 0; color: #212529;">Minimum notice period</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px 0; color: #495057;">1 year or less</td>
                            <td style="padding: 8px 0; color: #495057;"><strong>${year1}</strong> week(s)</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px 0; color: #495057;">More than 1 year to 3 years</td>
                            <td style="padding: 8px 0; color: #495057;"><strong>${year1to3}</strong> week(s)</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px 0; color: #495057;">More than 3 years to 5 years</td>
                            <td style="padding: 8px 0; color: #495057;"><strong>${year3to5}</strong> week(s)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #495057;">More than 5 years</td>
                            <td style="padding: 8px 0; color: #495057;"><strong>${year5plus}</strong> week(s)</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }
    }
    
    saveCurrentStepData();
}

function initializeStep6Listeners() {
    const inputs = document.querySelectorAll('#contractStepContent input');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            saveCurrentStepData();
        });
    });
}

// ========================================
// STEP 7: Review Contract
// ========================================
function getStep7Template() {
    const data = contractBuilderState.data;
    
    // Build summary of all selections
    let summary = `
        <h2 class="step-title">Review Your Contract</h2>
        <p class="step-description">Review all the information you've entered. Click any section to edit.</p>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;"><span style="font-weight: bold;">*</span> Required fields</p>
        
        <div class="warning-box">
            <div class="warning-box-content">
                <p><strong>Important:</strong> Please review all details carefully before generating the contract. You can click on any section below to go back and make changes.</p>
            </div>
        </div>
    `;
    
    // Step 1: Position Details
    summary += `
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Position Details</h3>
                <button class="btn btn-link" onclick="jumpToContractStep(1)" style="padding: 8px 16px;">Edit</button>
            </div>
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; color: #495057;">
                <div style="font-weight: 600;">Position:</div>
                <div>${data.step1.positionTitle || '<em>Not provided</em>'}</div>
                
                <div style="font-weight: 600;">Award:</div>
                <div>${data.step1.awardName || '<em>Not provided</em>'}</div>
                
                <div style="font-weight: 600;">Employment Type:</div>
                <div>${formatEmploymentType(data.step1.employmentType)}</div>
                
                <div style="font-weight: 600;">Start Date:</div>
                <div>${data.step1.startDate || '<em>Not provided</em>'}</div>
                
                ${data.step1.hasProbation ? `
                <div style="font-weight: 600;">Probation:</div>
                <div>${data.step1.probationLength} months</div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Step 2: Hours
    if (data.step1.employmentType !== 'casual') {
        summary += `
            <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Hours & Work Pattern</h3>
                    <button class="btn btn-link" onclick="jumpToContractStep(2)" style="padding: 8px 16px;">Edit</button>
                </div>
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; color: #495057;">
                    <div style="font-weight: 600;">Hours Per Week:</div>
                    <div>${data.step2.hoursPerWeek || '<em>Not provided</em>'} hours</div>
                    
                    <div style="font-weight: 600;">Work Pattern:</div>
                    <div>${data.step2.workPattern || '<em>Not provided</em>'}</div>
                </div>
            </div>
        `;
    }
    
    // Step 3: Pay
    summary += `
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Pay & Conditions</h3>
                <button class="btn btn-link" onclick="jumpToContractStep(3)" style="padding: 8px 16px;">Edit</button>
            </div>
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; color: #495057;">
                <div style="font-weight: 600;">Pay Rate:</div>
                <div>$${data.step3.payRate || '0.00'} per ${data.step3.payRateType === 'weekly' ? 'week' : 'hour'}</div>
                
                <div style="font-weight: 600;">Pay Frequency:</div>
                <div>${formatPayFrequency(data.step3.payFrequency)}</div>
                
                <div style="font-weight: 600;">Payment Method:</div>
                <div>${data.step3.payMethod === 'bank' ? 'Bank account' : data.step3.payMethod === 'cash' ? 'Cash' : 'Cheque'}</div>
                
                <div style="font-weight: 600;">Superannuation:</div>
                <div>Included (as per legislation)</div>
                
                ${data.step3.additionalSuper ? `
                <div style="font-weight: 600;">Additional Super:</div>
                <div>${data.step3.additionalSuperPercent || '0'}%</div>
                ` : ''}
                
                ${data.step3.penaltyRatesOvertime ? `
                <div style="font-weight: 600;">Penalty Rates/Overtime:</div>
                <div>Clause included</div>
                ` : ''}
                
                ${data.step3.allowances ? `
                <div style="font-weight: 600;">Allowances:</div>
                <div>Clause included</div>
                ` : ''}
                
                ${data.step3.commission ? `
                <div style="font-weight: 600;">Commission:</div>
                <div>Clause included</div>
                ` : ''}
                
                ${data.step3.annualBonus ? `
                <div style="font-weight: 600;">Annual Bonus:</div>
                <div>Clause included</div>
                ` : ''}
                
                ${data.step3.annualPayReview ? `
                <div style="font-weight: 600;">Annual Pay Review:</div>
                <div>Clause included</div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Step 4: Leave
    const empTypeForLeave = data.step1.employmentType;
    const leaveItems = [];
    
    if (empTypeForLeave !== 'casual') {
        leaveItems.push(`Annual Leave (${data.step4.annualLeaveAmount || '4'} ${data.step4.annualLeaveMeasure || 'week'}s per year)`);
        leaveItems.push('Personal/Carer\'s Leave (10 days per year)');
    }
    leaveItems.push('Parental Leave (12 months unpaid)');
    if (data.step4.additionalParentalLeave) {
        leaveItems.push(`Additional Parental Leave (${data.step4.additionalParentalLeaveWeeks || '0'} weeks paid)`);
    }
    leaveItems.push('Compassionate Leave (2 days per occasion)');
    leaveItems.push('Community Service Leave');
    leaveItems.push('Family and Domestic Violence Leave (10 days per year)');
    leaveItems.push('Public Holidays');
    leaveItems.push('Long Service Leave (as per state legislation)');
    
    summary += `
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Leave Entitlements</h3>
                <button class="btn btn-link" onclick="jumpToContractStep(4)" style="padding: 8px 16px;">Edit</button>
            </div>
            <div style="color: #495057;">
                ${leaveItems.map(item => `
                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">âœ“ ${item}</div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Step 5: Additional Terms
    const termItems = [];
    if (data.step5.employeeObligations) termItems.push('Employee Obligations');
    if (data.step5.conflictOfInterest) termItems.push('Conflict of Interest');
    if (data.step5.confidentiality) termItems.push('Confidentiality');
    if (data.step5.intellectualProperty) termItems.push('Intellectual Property');
    if (data.step5.consultation) termItems.push('Consultation');
    if (data.step5.disputes) termItems.push('Dispute Resolution');
    
    summary += `
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Additional Terms</h3>
                <button class="btn btn-link" onclick="jumpToContractStep(5)" style="padding: 8px 16px;">Edit</button>
            </div>
            <div style="color: #495057;">
                ${termItems.length > 0 ? termItems.map(item => `
                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">âœ“ ${item}</div>
                `).join('') : '<em>No additional terms selected</em>'}
            </div>
        </div>
    `;
    
    // Step 6: Ending Employment
    const resignNotice = data.step6.resignationNotice || { year1: '1', year1to3: '2', year3to5: '3', year5plus: '4' };
    summary += `
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #212529; font-size: 20px; font-weight: 700; margin: 0;">Ending Employment</h3>
                <button class="btn btn-link" onclick="jumpToContractStep(6)" style="padding: 8px 16px;">Edit</button>
            </div>
            <div style="color: #495057;">
                <div style="font-weight: 600; margin-bottom: 8px;">Resignation Notice Periods:</div>
                <div style="padding: 4px 0;">1 year or less: ${resignNotice.year1} week(s)</div>
                <div style="padding: 4px 0;">1-3 years: ${resignNotice.year1to3} week(s)</div>
                <div style="padding: 4px 0;">3-5 years: ${resignNotice.year3to5} week(s)</div>
                <div style="padding: 4px 0;">5+ years: ${resignNotice.year5plus} week(s)</div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">âœ“ Dismissal notice clause included (NES minimum)</div>
                <div style="padding: 4px 0;">âœ“ Redundancy clause included</div>
                ${data.step6.misconductClause ? '<div style="padding: 4px 0;">âœ“ Misconduct clause included</div>' : ''}
            </div>
        </div>
    `;
    
    summary += `
        <div class="form-group" style="margin-top: 32px;">
            <label class="checkbox-label">
                <input type="checkbox" class="checkbox-input" id="reviewComplete" name="reviewComplete">
                <span class="checkbox-text">
                    <strong>I have reviewed all sections and confirm the information is correct.</strong> <span style="color: #dc3545; font-weight: bold;">*</span>
                </span>
            </label>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="previousContractStep()">â† Back</button>
            <button class="btn btn-primary" onclick="nextContractStep()">Next: Generate Contract â†’</button>
        </div>
    `;
    
    return summary;
}

function initializeStep7Listeners() {
    document.getElementById('reviewComplete').addEventListener('change', (e) => {
        contractBuilderState.data.step7.reviewComplete = e.target.checked;
    });
}

// Helper formatters
function formatEmploymentType(type) {
    const types = {
        'full-time': 'Full-time (38 hours per week)',
        'part-time': 'Part-time (Regular hours)',
        'casual': 'Casual (As required)'
    };
    return types[type] || type;
}

function formatPayFrequency(freq) {
    const frequencies = {
        'weekly': 'Weekly',
        'fortnightly': 'Fortnightly',
        'monthly': 'Monthly'
    };
    return frequencies[freq] || freq;
}

// ========================================
// STEP 8: Generate & Download
// ========================================
function getStep8Template() {
    return `
        <h2 class="step-title">ðŸŽ‰ Contract Ready to Generate</h2>
        <p class="step-description">Your employment contract is ready. Choose how you'd like to receive it.</p>
        
        <div class="warning-box">
            <div class="warning-box-title">âš ï¸ Final Reminder</div>
            <div class="warning-box-content">
                <p><strong>This is a template contract - NOT legal advice.</strong></p>
                <ul>
                    <li>Have this contract reviewed by a legal professional before use</li>
                    <li>Ensure it complies with your specific Modern Award</li>
                    <li>Consider consulting with Fitzgerald HR's Senior Consultant</li>
                    <li>Provide the Fair Work Information Statement to new employees</li>
                </ul>
            </div>
        </div>
        
        <div style="background: #e7f3ff; border: 2px solid #007bff; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <h3 style="color: #004085; font-size: 18px; font-weight: 600; margin: 0 0 12px 0;">Next Steps After Generating</h3>
            <div style="color: #004085;">
                <ol style="margin: 0; padding-left: 20px;">
                    <li style="margin-bottom: 8px;">Review the contract with a legal professional</li>
                    <li style="margin-bottom: 8px;">Customize any sections specific to your business</li>
                    <li style="margin-bottom: 8px;">Have both parties sign the contract</li>
                    <li style="margin-bottom: 8px;">Provide employee with Fair Work Information Statement</li>
                    <li style="margin-bottom: 8px;">Keep a signed copy for your records</li>
                </ol>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Download Format</label>
            <div class="radio-group">
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="deliveryMethod" value="docx" checked>
                        <div class="radio-content">
                            <div class="radio-text">ðŸ“„ Word Document (.docx)</div>
                            <div class="radio-description">Editable format - recommended</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <label class="radio-label">
                        <input type="radio" class="radio-input" name="deliveryMethod" value="pdf">
                        <div class="radio-content">
                            <div class="radio-text">ðŸ“‘ PDF Document</div>
                            <div class="radio-description">Read-only format</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
            <div style="color: #856404; font-size: 14px;">
                <strong>Remember:</strong> Don't reuse this contract for different employees. Each employee should have their own tailored contract based on their specific role and circumstances.
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="jumpToContractStep(7)">â† Back to Review</button>
            <button class="btn btn-primary" onclick="generateEmploymentContract()" style="font-size: 18px; padding: 16px 48px;">
                ðŸ“¥ Generate Contract
            </button>
        </div>
    `;
}

function initializeStep8Listeners() {
    // Nothing special needed for step 8
}

// ========================================
// DOCUMENT GENERATION
// ========================================
async function generateEmploymentContract() {
    const format = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'docx';
    
    // Show loading overlay
    showContractLoading('Generating your employment contract...');
    
    try {
        // Build the contract content
        const contractHTML = buildContractHTML();
        
        if (format === 'docx') {
            // Generate Word document using html-docx-js
            await generateContractWordDocument(contractHTML);
        } else {
            // Generate PDF
            await generateContractPDFDocument(contractHTML);
        }
        
        // Mark as saved
        contractBuilderState.unsavedChanges = false;
        
        // Show success message
        hideContractLoading();
        
        if (typeof showNotification === 'function') {
            showNotification('âœ… Contract generated successfully!', 'success');
        }
        
        // Prompt for onboarding checklist after a moment
        setTimeout(() => {
            promptForOnboardingChecklist();
        }, 1000);
        
    } catch (error) {
        hideContractLoading();
        showAlert('Failed to generate contract. Please try again.');
    }
}


function buildContractHTML() {
    const data = contractBuilderState.data;
    const today = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; }
                h1 { color: #2c3e50; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
                h2 { color: #34495e; margin-top: 30px; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; }
                h3 { color: #667eea; margin-top: 20px; }
                .clause { margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #667eea; }
                .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                td, th { border: 1px solid #ddd; padding: 12px; text-align: left; }
                th { background-color: #667eea; color: white; }
                .signature-section { margin-top: 50px; }
                .signature-line { border-top: 1px solid #000; width: 300px; margin-top: 50px; }
            </style>
        </head>
        <body>
            <h1>EMPLOYMENT CONTRACT</h1>
            
            <div class="warning">
                <strong>IMPORTANT LEGAL NOTICE:</strong> This contract has been generated using the Fitzgerald HR Employment Contract Builder.
                This is a template document and should be reviewed by a legal professional before use. It is based on Fair Work Australia
                requirements but may need customization for your specific circumstances.
            </div>
            
            <h2>1. PARTIES</h2>
            <div class="clause">
                <p><strong>Employer:</strong> [EMPLOYER NAME] (ABN: [ABN NUMBER])</p>
                <p><strong>Address:</strong> ${data.step1.workplaceAddress || '[WORKPLACE ADDRESS]'}</p>
                <p><strong>Employee:</strong> [EMPLOYEE NAME]</p>
                <p><strong>Address:</strong> [EMPLOYEE ADDRESS]</p>
            </div>
            
            <h2>2. POSITION AND DUTIES</h2>
            <div class="clause">
                <h3>2.1 Position Title</h3>
                <p>The Employee is employed in the position of <strong>${data.step1.positionTitle}</strong>.</p>
                
                <h3>2.2 Duties and Responsibilities</h3>
                ${data.step1.dutiesOption === 'outline' && data.step1.duties ? `
                    <p>${data.step1.duties.replace(/\n/g, '<br>')}</p>
                ` : `
                    <p>The Employee's duties and responsibilities are as outlined in the Position Description attached to this contract.</p>
                `}
                
                <h3>2.3 Modern Award</h3>
                <p>This employment is covered by the <strong>${data.step1.awardName}</strong>.</p>
            </div>
            
            <h2>3. EMPLOYMENT TYPE AND COMMENCEMENT</h2>
            <div class="clause">
                <h3>3.1 Employment Type</h3>
                <p>The Employee is engaged on a <strong>${data.step1.employmentType}</strong> basis${data.step1.isPermanent ? ' on an ongoing/permanent basis' : ' for a fixed term'}.</p>
                
                <h3>3.2 Commencement Date</h3>
                <p>Employment will commence on <strong>${data.step1.startDate}</strong>.</p>
                
                ${!data.step1.isPermanent && data.step1.endDate ? `
                    <h3>3.3 End Date</h3>
                    <p>This fixed-term employment will end on <strong>${data.step1.endDate}</strong> unless terminated earlier in accordance with this contract.</p>
                ` : ''}
                
                ${data.step1.hasProbation ? `
                    <h3>3.4 Probation Period</h3>
                    <p>The first <strong>${data.step1.probationLength} months</strong> of employment will be a probation period. During this time, either party may terminate employment with one week's notice.</p>
                ` : ''}
            </div>
            
            ${data.step1.employmentType !== 'casual' ? `
            <h2>4. HOURS OF WORK</h2>
            <div class="clause">
                <h3>4.1 Ordinary Hours</h3>
                <p>The Employee's ordinary hours of work are <strong>${data.step2.hoursPerWeek} hours per week</strong>.</p>
                
                ${data.step2.workPattern ? `
                    <h3>4.2 Work Pattern</h3>
                    <p>${data.step2.workPattern}</p>
                ` : ''}
                
                ${data.step2.overtimeApplies ? `
                    <h3>4.3 Reasonable Additional Hours</h3>
                    <p>The Employee may be required to work reasonable additional hours as necessary for the proper performance of their duties. Overtime will be compensated in accordance with the applicable Modern Award.</p>
                ` : ''}
            </div>
            ` : `
            <h2>4. CASUAL EMPLOYMENT</h2>
            <div class="clause">
                <p>As a casual employee, the Employee has no guaranteed hours of work. Hours will be offered as required by the business and may be accepted or declined by the Employee.</p>
            </div>
            `}
            
            <h2>5. REMUNERATION</h2>
            <div class="clause">
                <h3>5.1 Pay Rate</h3>
                <p>The Employee will be paid <strong>$${data.step3.payRate} per ${data.step3.payRateType === 'weekly' ? 'week' : 'hour'}</strong>${data.step1.employmentType === 'casual' ? ' (including 25% casual loading)' : ''}. This pay rate does not include superannuation, which will be paid separately.</p>
                
                <h3>5.2 Payment Method</h3>
                <p>The Employee will be paid <strong>${data.step3.payFrequency}</strong> ${data.step3.payMethod === 'bank' ? 'into the Employee\'s nominated bank account' : data.step3.payMethod === 'cash' ? 'in cash' : 'by cheque'}.</p>
                
                <h3>5.3 Superannuation</h3>
                <p>If the Employee is eligible for the super guarantee (SG), the Employer will pay the contributions on the Employee's behalf in accordance with legislation and the applicable award. The Employer will pay contributions into a super fund of the Employee's choice.</p>
                <p>If the Employee does not advise their choice of fund, the Employer may need to contact the ATO to find out if the Employee has a 'stapled' super fund to make SG contributions into.</p>
                <p>If the Employee does not advise their choice of fund and the ATO confirms there is no stapled super fund, the Employer will pay SG contributions to the default fund or another fund that meets the choice of fund rules.</p>
                
                ${data.step3.additionalSuper ? `
                <h3>5.4 Additional Superannuation</h3>
                <p>In addition to the SG, the Employer will contribute <strong>${data.step3.additionalSuperPercent || '0'} percent</strong> of the Employee's base salary into superannuation.</p>
                ` : ''}
                
                ${data.step3.penaltyRatesOvertime ? `
                <h3>${data.step3.additionalSuper ? '5.5' : '5.4'} Penalty Rates and Overtime</h3>
                <p>The Employee may be entitled to overtime rates under the applicable award if they work:</p>
                <ul>
                    <li>more than their ordinary hours of work</li>
                    <li>outside the spread of ordinary hours.</li>
                </ul>
                <p>The Employee may be entitled to penalty rates or shift loadings according to the award if they work:</p>
                <ul>
                    <li>on a weekend</li>
                    <li>on a public holiday</li>
                    <li>late night or early morning shifts.</li>
                </ul>
                ` : ''}
                
                ${data.step3.allowances ? `
                <h3>${data.step3.additionalSuper && data.step3.penaltyRatesOvertime ? '5.6' : data.step3.additionalSuper || data.step3.penaltyRatesOvertime ? '5.5' : '5.4'} Allowances</h3>
                <p>The Employee may be entitled to allowances in accordance with the applicable award, for example, if they:</p>
                <ul>
                    <li>do certain tasks or are required to use a particular skill in the duties of their role</li>
                    <li>have to use their own tools at work</li>
                    <li>work in particular conditions, environments or in remote locations.</li>
                </ul>
                ` : ''}
                
                ${data.step3.commission ? `
                <h3>Commission</h3>
                <p>In addition to the base pay, the Employer will pay the Employee commission under the following arrangement:</p>
                <p><em>${data.step3.commissionArrangement || '[Commission arrangement to be specified]'}</em></p>
                <p>If the parties agree to change this commission arrangement during the employment, this employment contract will be updated. Any changes to the commission arrangement will be made according to the requirements of the modern award which applies to the Employee.</p>
                ` : ''}
                
                ${data.step3.annualBonus ? `
                <h3>Annual Bonus</h3>
                <p>The Employer may pay the Employee an annual bonus at its discretion, taking into consideration the Employee's performance and other relevant business factors.</p>
                <p>There is no guarantee that the Employee will receive a bonus, and the Employee will not be eligible for one after their employment ends.</p>
                ` : ''}
                
                ${data.step3.annualPayReview ? `
                <h3>Annual Pay Review</h3>
                <p>The Employer will review the Employee's pay annually to determine whether they are eligible for an increase, taking into consideration:</p>
                <ul>
                    <li>the Employee's performance</li>
                    <li>the business's financial position.</li>
                </ul>
                <p>Any increase in pay, above award entitlements, is at the Employer's discretion.</p>
                ` : ''}
            </div>
            
            ${data.step1.employmentType !== 'casual' ? generateLeaveSection(data.step4) : ''}
            ${generateAdditionalTermsSection(data.step5)}
            ${generateNoticeSection(data.step6)}
            
            <h2>SIGNATURES</h2>
            <div class="signature-section">
                <p><strong>EMPLOYER</strong></p>
                <p>Signed: _________________________________</p>
                <p>Name: _________________________________</p>
                <p>Position: _________________________________</p>
                <p>Date: _________________________________</p>
                
                <div style="margin-top: 40px;"></div>
                
                <p><strong>EMPLOYEE</strong></p>
                <p>Signed: _________________________________</p>
                <p>Name: _________________________________</p>
                <p>Date: _________________________________</p>
            </div>
            
            <div class="warning" style="margin-top: 40px;">
                <p><strong>IMPORTANT:</strong> Both parties should retain a signed copy of this contract. The Employee must be provided with the Fair Work Information Statement.</p>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #6c757d; font-size: 12px;">
                <p>Generated by Fitzgerald HR Employment Contract Builder on ${today}</p>
                <p>This is a template document - seek legal advice before use</p>
            </div>
        </body>
        </html>
    `;
    
    return html;
}

function generateLeaveSection(leaveData) {
    const empType = contractBuilderState.data.step1.employmentType;
    let html = '<h2>6. LEAVE ENTITLEMENTS</h2><div class="clause">';
    let clauseNum = 1;
    
    // Annual Leave (not for casuals)
    if (empType !== 'casual') {
        html += `
            <h3>6.${clauseNum} Annual Leave</h3>
            <p>The Employee is entitled to <strong>${leaveData.annualLeaveAmount || '4'} ${leaveData.annualLeaveMeasure || 'week'}(s)</strong> of annual leave each year, based on their ordinary hours of work per week.</p>
            <p>The Employer will provide any applicable annual leave loading entitlements in accordance with the applicable award.</p>
            <p>Annual leave accumulates during the year. Any unused annual leave will roll over from year to year.</p>
        `;
        clauseNum++;
    }
    
    // Parental Leave
    html += `
        <h3>6.${clauseNum} Parental Leave</h3>
        <p>After the Employee has been working for the Employer for 12 months or more, they may be entitled to take unpaid parental leave from their position for 12 months.</p>
        <p>The Employee may also:</p>
        <ul>
            <li>request up to an extra 12 months of unpaid parental leave</li>
            <li>be entitled to Parental Leave Pay from the Australian Government, administered by Services Australia.</li>
        </ul>
    `;
    clauseNum++;
    
    // Additional Parental Leave (if selected)
    if (leaveData.additionalParentalLeave && leaveData.additionalParentalLeaveWeeks) {
        html += `
            <h3>6.${clauseNum} Additional Parental Leave</h3>
            <p>In addition to the above parental leave, the Employer will provide the Employee with <strong>${leaveData.additionalParentalLeaveWeeks} week(s)</strong> paid parental leave.</p>
        `;
        clauseNum++;
    }
    
    // Personal/Carer's Leave (not for casuals)
    if (empType !== 'casual') {
        html += `
            <h3>6.${clauseNum} Personal/Carer's Leave</h3>
            <p>The Employee is entitled to accrue 10 days paid personal/carer's leave (pro-rata for part-time employees) per year based on their ordinary hours of work. This is calculated as 1/26 of their ordinary hours of work in a year.</p>
            <p>The Employee can take personal/carer's leave when they can't work because they are sick or injured. They can also use it to care for a member of their immediate family or household who requires care or support because of:</p>
            <ul>
                <li>personal injury</li>
                <li>personal illness</li>
                <li>an unexpected emergency.</li>
            </ul>
            <p>Personal/carer's leave accrues throughout the year and from year to year. The Employee must give notice as soon as possible to take personal/carer's leave. The Employer may require evidence (such as a medical certificate).</p>
            <p>The Employee is also entitled to 2 days unpaid carer's leave (in accordance with the National Employment Standards). This is available each time an immediate family member or household member needs care or support.</p>
        `;
        clauseNum++;
    }
    
    // Compassionate Leave
    html += `
        <h3>6.${clauseNum} Compassionate Leave</h3>
        <p>The Employee is entitled to 2 days ${empType === 'casual' ? 'unpaid' : 'paid'} compassionate leave (in accordance with the National Employment Standards) each time:</p>
        <ul>
            <li>a member of their immediate family or household dies, or contracts or develops a life threatening illness or injury</li>
            <li>a child is stillborn, that would have been a member of their immediate family or household if born alive</li>
            <li>they or their current spouse or de facto partner has a miscarriage.</li>
        </ul>
    `;
    clauseNum++;
    
    // Community Service Leave
    html += `
        <h3>6.${clauseNum} Community Service Leave</h3>
        <p>The Employee may be entitled to community service leave (in accordance with the National Employment Standards) for certain activities such as:</p>
        <ul>
            <li>voluntary emergency management activities</li>
            <li>jury duty and jury selection.</li>
        </ul>
        <p>The Employee must give the Employer:</p>
        <ul>
            <li>notice of their leave as soon as possible</li>
            <li>details of the period, or expected period, that they will be away from work.</li>
        </ul>
        <p>The Employer may ask for evidence that community service leave is required.</p>
    `;
    clauseNum++;
    
    // Family and Domestic Violence Leave
    html += `
        <h3>6.${clauseNum} Family and Domestic Violence Leave</h3>
        <p>The Employee may be entitled to 10 days of paid family and domestic violence leave (in accordance with the National Employment Standards) each 12 month period.</p>
    `;
    clauseNum++;
    
    // Public Holidays
    html += `
        <h3>6.${clauseNum} Public Holidays</h3>
        <p>The Employee has a right to be absent from work on a public holiday.</p>
        <p>The Employer may ask the Employee to work on a public holiday. The Employee may refuse the request to work (in accordance with the Fair Work Act 2009) if:</p>
        <ul>
            <li>their refusal is reasonable, or</li>
            <li>the Employer's request is unreasonable.</li>
        </ul>
        <p>If the Employee works on a public holiday, they are entitled to any additional entitlements under the applicable award, such as public holiday penalty rates.</p>
        <p>If the Employee does not work on a public holiday, and it falls on a day they would normally work, they are entitled to be paid their base rate of pay for their ordinary hours of work on that day.</p>
    `;
    clauseNum++;
    
    // Long Service Leave
    html += `
        <h3>6.${clauseNum} Long Service Leave</h3>
        <p>The Employee may be entitled to long service leave after working with the Employer for a specific period of time in accordance with relevant state or territory legislation or the Fair Work Act.</p>
    `;
    
    html += '</div>';
    return html;
}

function generateAdditionalTermsSection(termsData) {
    if (!Object.values(termsData).some(v => v)) {
        return '';
    }
    
    let html = '<h2>7. ADDITIONAL TERMS AND OBLIGATIONS</h2><div class="clause">';
    let clauseNum = 1;
    
    if (termsData.employeeObligations) {
        html += `
            <h3>7.${clauseNum} Employee Obligations</h3>
            <p>The Employee must:</p>
            <ul>
                <li>Comply with all lawful and reasonable directions of the Employer</li>
                <li>Follow all workplace policies and procedures</li>
                <li>Act in good faith and in the best interests of the Employer</li>
                <li>Maintain professional standards of conduct</li>
            </ul>
        `;
        clauseNum++;
    }
    
    if (termsData.conflictOfInterest) {
        html += `
            <h3>7.${clauseNum} Conflict of Interest</h3>
            <p>The Employee must disclose any actual or potential conflicts of interest and must not engage in any activity that competes with or is detrimental to the Employer's business interests.</p>
        `;
        clauseNum++;
    }
    
    if (termsData.confidentiality) {
        html += `
            <h3>7.${clauseNum} Confidentiality</h3>
            <p>The Employee must keep confidential all information relating to the Employer's business, including but not limited to business strategies, customer information, recipes, financial information, and trade secrets. This obligation continues after the end of employment.</p>
        `;
        clauseNum++;
    }
    
    if (termsData.intellectualProperty) {
        html += `
            <h3>7.${clauseNum} Intellectual Property</h3>
            <p>All intellectual property created by the Employee during their employment, including recipes, designs, marketing materials, and other creative works, belongs to the Employer.</p>
        `;
        clauseNum++;
    }
    
    if (termsData.consultation) {
        html += `
            <h3>7.${clauseNum} Consultation</h3>
            <p>The Employer will consult with affected employees about major workplace changes in accordance with the requirements of the applicable Modern Award.</p>
        `;
        clauseNum++;
    }
    
    if (termsData.disputes) {
        html += `
            <h3>7.${clauseNum} Dispute Resolution</h3>
            <p>Any disputes arising under this contract will be dealt with in accordance with the dispute resolution procedures set out in the applicable Modern Award and the Fair Work Act 2009.</p>
        `;
        clauseNum++;
    }
    
    html += '</div>';
    return html;
}

function generateNoticeSection(noticeData) {
    const resignNotice = noticeData.resignationNotice || { year1: '1', year1to3: '2', year3to5: '3', year5plus: '4' };
    
    let html = `
        <h2>8. TERMINATION OF EMPLOYMENT</h2>
        <div class="clause">
            <h3>8.1 Resignation Notice</h3>
            <p>The Employee must give the Employer the following minimum notice periods if they resign:</p>
            <table>
                <tr>
                    <th>Continuous employment with the Employer</th>
                    <th>Minimum notice period</th>
                </tr>
                <tr>
                    <td>1 year or less</td>
                    <td>${resignNotice.year1} week(s)</td>
                </tr>
                <tr>
                    <td>More than 1 year to 3 years</td>
                    <td>${resignNotice.year1to3} week(s)</td>
                </tr>
                <tr>
                    <td>More than 3 years to 5 years</td>
                    <td>${resignNotice.year3to5} week(s)</td>
                </tr>
                <tr>
                    <td>More than 5 years</td>
                    <td>${resignNotice.year5plus} week(s)</td>
                </tr>
            </table>
            
            <h3>8.2 Dismissal Notice</h3>
            <p>The Employee is entitled to the following minimum notice periods (or payment in lieu of notice) if the Employer ends their employment. This does not apply if the Employer ends the Employee's employment for serious misconduct.</p>
            <table>
                <tr>
                    <th>Continuous employment with the Employer</th>
                    <th>Minimum notice period</th>
                </tr>
                <tr>
                    <td>1 year or less</td>
                    <td>1 week</td>
                </tr>
                <tr>
                    <td>More than 1 year to 3 years</td>
                    <td>2 weeks</td>
                </tr>
                <tr>
                    <td>More than 3 years to 5 years</td>
                    <td>3 weeks</td>
                </tr>
                <tr>
                    <td>More than 5 years</td>
                    <td>4 weeks</td>
                </tr>
            </table>
            <p>The Employee may be entitled to a longer minimum notice period under their award.</p>
            <p>The Employee will get an extra week of notice if they are older than 45 years and have worked for the Employer for at least 2 years.</p>
            
            <h3>8.3 Redundancy</h3>
            <p>If the Employee's position is terminated due to redundancy, any notice and redundancy pay entitlements will be in accordance with the National Employment Standards and the applicable award.</p>
            
            ${noticeData.misconductClause ? `
                <h3>8.4 Misconduct</h3>
                <p>The Employer may terminate the Employee's employment without notice, or payment in lieu of notice, if the Employee engages in serious misconduct.</p>
                <p>Serious misconduct is when an employee:</p>
                <ul>
                    <li>causes serious and imminent risk to the health and safety of another person or to the reputation, viability or profits of their employer's business, or</li>
                    <li>wilfully or deliberately behaves in a way that's inconsistent with continuing their employment.</li>
                </ul>
                <p>Examples of serious misconduct include:</p>
                <ul>
                    <li>theft</li>
                    <li>fraud</li>
                    <li>violence/assault</li>
                    <li>sexual harassment</li>
                    <li>serious breaches of health and safety requirements</li>
                    <li>being drunk or affected by drugs at work</li>
                    <li>refusing to carry out work duties.</li>
                </ul>
            ` : ''}
        </div>
    `;
    
    return html;
}

async function generateContractWordDocument(html) {
    try {
        // Use the html-docx-js library that's already loaded
        const converted = htmlDocx.asBlob(html);
        const filename = `Employment_Contract_${contractBuilderState.data.step1.positionTitle.replace(/\s+/g, '_')}_${Date.now()}.docx`;
        
        saveAs(converted, filename);
        
    } catch (error) {
        throw error;
    }
}

async function generateContractPDFDocument(html) {
    try {
        // Use pdfmake which is already loaded
        const docDefinition = {
            content: [
                { text: 'Employment Contract', style: 'header' },
                { text: html, style: 'body' }
            ],
            styles: {
                header: { fontSize: 22, bold: true, margin: [0, 0, 0, 20] },
                body: { fontSize: 11, lineHeight: 1.4 }
            }
        };
        
        const filename = `Employment_Contract_${contractBuilderState.data.step1.positionTitle.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
        pdfMake.createPdf(docDefinition).download(filename);
        
    } catch (error) {
        throw error;
    }
}

function showContractLoading(message) {
    const loadingHTML = `
        <div class="loading-overlay" id="contractLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">${message}</div>
        </div>
    `;
    
    const builder = document.getElementById('employmentContractBuilder');
    const existing = document.getElementById('contractLoadingOverlay');
    if (existing) existing.remove();
    
    builder.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideContractLoading() {
    const overlay = document.getElementById('contractLoadingOverlay');
    if (overlay) overlay.remove();
}

</script>

<!-- ============================================ -->
<!-- FIREBASE AUTHENTICATION & SYNC -->
<!-- ============================================ -->

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDQyZhlcK84ltrk8hdRs8GGAr2RnhHAs28",
  authDomain: "fitzgerald-hr.firebaseapp.com",
  projectId: "fitzgerald-hr",
  storageBucket: "fitzgerald-hr.firebasestorage.app",
  messagingSenderId: "60315816365",
  appId: "1:60315816365:web:0ac2a300f3c46e46ddd124",
  measurementId: "G-NT7FEHKWHV"
};

// Use existing currentUser from line 4714
let auth, db, currentSubscription = null;

try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
} catch (error) {
}

async function signInWithGoogle() {
    if (!auth) { showAlert('Firebase not ready'); return; }
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        await createOrUpdateUserProfile(result.user);
        if (typeof showNotification === 'function') showNotification('Welcome ' + result.user.displayName + '!', 'success');
        return result.user;
    } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
            showAlert(error.code === 'auth/popup-blocked' ? 'Please allow popups' : 'Sign in failed: ' + error.message);
        }
    }
}

async function signInWithGoogleFromAccess() {
    if (!auth) { showAlert('Firebase not ready'); return; }
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        await createOrUpdateUserProfile(user);
        localStorage.setItem('fitzhr_google_auth', 'true');
        localStorage.setItem('fitzhr_last_login', new Date().toISOString());
        const accessScreen = document.getElementById('accessScreen');
        const assistantScreen = document.getElementById('assistantScreen');
        if (accessScreen) accessScreen.classList.add('hidden');
        if (assistantScreen) assistantScreen.classList.remove('hidden');
        const userCodeEl = document.getElementById('userCode');
        if (userCodeEl) userCodeEl.textContent = 'Google Account';
        return user;
    } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
            showAlert(error.code === 'auth/popup-blocked' ? 'Please allow popups' : 'Sign in failed: ' + error.message);
        }
    }
}

async function signOut() {
    if (!auth) return;
    try {
        // Save current conversation state before signing out
        if (currentConversationId && typeof saveCurrentConversation === 'function') {
            saveCurrentConversation();
        }
        
        // Ensure conversations are synced to Firebase
        if (typeof syncConversationsToCloud === 'function') {
            await syncConversationsToCloud();
        }
        
        // Save the current conversation ID to Firebase one last time
        if (currentConversationId && currentUser && currentUser.uid) {
            await saveCurrentConversationIdToFirebase(currentConversationId);
        }
        
        await auth.signOut();
        if (typeof showNotification === 'function') showNotification('Signed out', 'success');
    } catch (error) { }
}

/**
 * Save the current conversation ID to Firebase for cross-device continuity
 * @param {string} conversationId - The ID of the current active conversation
 */
async function saveCurrentConversationIdToFirebase(conversationId) {
    if (!currentUser || !currentUser.uid || !db) {
        return;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid).set({
            lastConversationId: conversationId,
            lastConversationUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    } catch (error) {
    }
}

/**
 * Load the last conversation ID from Firebase
 * @returns {Promise<string|null>} The last conversation ID or null if not found
 */
async function loadLastConversationIdFromFirebase() {
    if (!currentUser || !currentUser.uid || !db) {
        return null;
    }
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            const lastConvId = userData.lastConversationId;
            if (lastConvId) {
                // Also save to localStorage for faster access next time
                localStorage.setItem('fitz_currentConversationId_' + currentUser.uid, lastConvId);
                return lastConvId;
            }
        }
        return null;
    } catch (error) {
        return null;
    }
}

// Beta Tester Whitelist - Easy to add more emails here!
const BETA_TESTERS = [
    'blakefitzgerald4@gmail.com',
    'phalan.chilli@gmail.com',
    'fitzgeraldilona@gmail.com',
    'ellyse.saunderson@hotmail.com'
    // Add more emails here as needed - just copy the line format above
];

async function createOrUpdateUserProfile(user) {
    if (!db) return;
    try {
        const userRef = db.collection('users').doc(user.uid);
        const doc = await userRef.get();
        
        // Check if user is a beta tester
        const isBetaTester = BETA_TESTERS.includes(user.email.toLowerCase());
        const subscriptionTier = isBetaTester ? 'professional' : 'free';
        
        if (!doc.exists) {
            await userRef.set({
                uid: user.uid, 
                email: user.email, 
                displayName: user.displayName, 
                photoURL: user.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                subscriptionTier: subscriptionTier,
                subscriptionStatus: 'active',
                betaTester: isBetaTester
            });
        } else {
            await userRef.update({ 
                lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(), 
                displayName: user.displayName, 
                photoURL: user.photoURL 
            });
        }
    } catch (error) { }
}

async function saveToCloud(collection, docId, data) {
    const cacheKey = collection + '_' + docId;
    try { localStorage.setItem(cacheKey, JSON.stringify(data)); } catch (e) { }
    if (!currentUser || !db) { return { success: true, synced: false }; }
    try {
        await db.collection('users').doc(currentUser.uid).collection(collection).doc(docId).set({...data, userId: currentUser.uid, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, { merge: true });
        return { success: true, synced: true };
    } catch (error) {
        return { success: true, synced: false, error };
    }
}

async function loadFromCloud(collection) {
    if (!currentUser || !db) return [];
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection(collection).get();
        const items = [];
        snapshot.forEach(function(doc) {
            const data = doc.data();
            items.push(data);
            localStorage.setItem(collection + '_' + doc.id, JSON.stringify(data));
        });
        return items;
    } catch (error) { return []; }
}

async function loadAllUserData(userId) {
    try {
        await Promise.all([loadFromCloud('contracts'), loadFromCloud('checklists'), loadFromCloud('trainingPlans'), loadFromCloud('conversations')]);
        if (typeof showNotification === 'function') showNotification('âœ… Synced', 'success');
    } catch (error) { }
}

let unsubscribeListeners = [];
function setupRealtimeSync(userId) {
    if (!db) return;
    ['contracts', 'checklists', 'trainingPlans', 'conversations'].forEach(function(collection) {
        const unsub = db.collection('users').doc(userId).collection(collection).onSnapshot(function(snapshot) {
            snapshot.docChanges().forEach(function(change) {
                const docId = change.doc.id;
                const data = change.doc.data();
                if (change.type === 'added' || change.type === 'modified') {
                    localStorage.setItem(collection + '_' + docId, JSON.stringify(data));
                } else if (change.type === 'removed') {
                    localStorage.removeItem(collection + '_' + docId);
                }
            });
        });
        unsubscribeListeners.push(unsub);
    });
}

function stopRealtimeSync() {
    unsubscribeListeners.forEach(function(u) { if (u) u(); });
    unsubscribeListeners = [];
}

if (auth) {
    auth.onAuthStateChanged(async function(user) {
        if (user) {
            currentUser = user;
            const accessScreen = document.getElementById('accessScreen');
            const assistantScreen = document.getElementById('assistantScreen');
            if (accessScreen && !accessScreen.classList.contains('hidden')) {
                localStorage.setItem('fitzhr_google_auth', 'true');
                localStorage.setItem('fitzhr_last_login', new Date().toISOString());
                accessScreen.classList.add('hidden');
                if (assistantScreen) assistantScreen.classList.remove('hidden');
                const userCodeEl = document.getElementById('userCode');
                if (userCodeEl) userCodeEl.textContent = 'Google Account';
            }
            updateUIForAuthenticatedUser(user);
            
            // Show admin button for admin email
            const adminEmails = ['blakefitzgerald4@gmail.com'];
            if (adminEmails.includes(user.email)) {
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) {
                    adminBtn.classList.remove('hidden');
                }
            }
            
            // Show loading skeleton while data loads
            const msgContainer = document.getElementById('messagesContainer');
            if (msgContainer) {
                msgContainer.innerHTML = '<div class="max-w-5xl mx-auto space-y-6 p-6">' +
                    '<div class="flex justify-start"><div class="max-w-3xl w-full bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">' +
                    '<div class="space-y-3 animate-pulse">' +
                    '<div class="h-4 bg-slate-700 rounded w-3/4"></div>' +
                    '<div class="h-4 bg-slate-700 rounded w-full"></div>' +
                    '<div class="h-4 bg-slate-700 rounded w-5/6"></div>' +
                    '</div></div></div></div>';
            }
            
            await loadAllDataFromFirebase(); // Use new Firebase-first system with retry
            
            // Load credits from Firebase (source of truth for subscription status)
            await loadCreditsFromFirebase();
            
            // Check Firebase for legal acceptance and load last conversation ID
            if (db) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // Check for truthy value (handles boolean true, string "true", etc.)
                        if (userData.legalTermsAccepted === true || userData.legalTermsAccepted === 'true') {
                            localStorage.setItem('legalTermsAccepted_' + user.uid, 'true');
                            localStorage.setItem('legalTermsAcceptedAt_' + user.uid, userData.legalTermsAcceptedAt || new Date().toISOString());
                            
                            // Hide the modal if it was shown by another flow
                            const legalModal = document.getElementById('legalAcceptanceModal');
                            if (legalModal && !legalModal.classList.contains('hidden')) {
                                legalModal.classList.add('hidden');
                            }
                        }
                        
                        // Load last conversation ID for continuity
                        if (userData.lastConversationId) {
                            localStorage.setItem('fitz_currentConversationId_' + user.uid, userData.lastConversationId);
                        }
                        
                        // Also load venue profile if present
                        if (userData.venueProfile) {
                            localStorage.setItem('venueProfile_' + user.uid, JSON.stringify(userData.venueProfile));
                        }
                    }
                } catch (e) {
                }
            }
            
            // Load venue profile from localStorage
            let savedVenueProfile = localStorage.getItem('venueProfile_' + user.uid);
            if (savedVenueProfile) {
                try {
                    venueProfile = JSON.parse(savedVenueProfile);
                    setTimeout(() => {
                        updateSidebarVenueName();
                    }, 500);
                } catch (e) {
                }
            }
            
            // Check if we need to show legal modal
            if (accessScreen && accessScreen.classList.contains('hidden')) {
                const hasAcceptedLegal = localStorage.getItem('legalTermsAccepted_' + user.uid) === 'true';
                
                if (!hasAcceptedLegal) {
                    // Show legal modal
                    const modal = document.getElementById('legalAcceptanceModal');
                    const checkbox = document.getElementById('legalAcceptCheckbox');
                    const acceptBtn = document.getElementById('acceptLegalButton');
                    
                    if (modal) {
                        modal.classList.remove('hidden');
                        if (checkbox) checkbox.checked = false;
                        if (acceptBtn) acceptBtn.disabled = true;
                        if (checkbox) {
                            checkbox.onchange = function() {
                                if (acceptBtn) acceptBtn.disabled = !this.checked;
                            };
                        }
                        trackEvent('legal_acceptance_modal_shown', { user: user.uid });
                    }
                } else {
                    // Legal already accepted - check onboarding
                    const hasCompletedOnboarding = checkOnboardingStatus();
                    if (!hasCompletedOnboarding) {
                        setTimeout(() => showOnboarding(), 1000);
                    } else {
                        // Firebase data already loaded by loadAllDataFromFirebase()
                        // Restore the last conversation with cloud continuity
                        setTimeout(async () => {
                            // Try to load last conversation ID from Firebase if not in localStorage
                            const userKey = user.uid;
                            let lastConvId = localStorage.getItem('fitz_currentConversationId_' + userKey);
                            
                            if (!lastConvId) {
                                // Try loading from Firebase
                                lastConvId = await loadLastConversationIdFromFirebase();
                            }
                            
                            // Now restore the conversation
                            const restored = restoreLastConversation();
                            updateSidebarChats();
                            
                            // Show welcome back message if conversation was restored
                            if (restored && conversations.length > 0) {
                                const conv = conversations.find(c => c.id === currentConversationId);
                                if (conv && conv.messages && conv.messages.length > 1) {
                                    showToast('Welcome back! Your conversation has been restored.', 'success', 3000);
                                }
                            }
                            
                            // Ensure we scroll to bottom after everything is loaded
                            // Multiple timeouts to handle varying load times
                            setTimeout(() => {
                                scrollToBottomInstant();
                            }, 400);
                            
                            setTimeout(() => {
                                scrollToBottomInstant();
                            }, 800);
                        }, 500);
                    }
                }
            }
            
            setupRealtimeSync(user.uid);
        } else {
            currentUser = null;
            stopRealtimeSync();
            updateUIForUnauthenticatedUser();
        }
    });
}

function updateUIForAuthenticatedUser(user) {
    const btn = document.getElementById('signInButton');
    if (btn) btn.style.display = 'none';
    const profile = document.getElementById('userProfile');
    if (profile) {
        profile.style.display = 'flex';
        const photo = document.getElementById('userPhoto');
        if (photo) photo.src = user.photoURL || 'https://via.placeholder.com/40';
        const name = document.getElementById('userName');
        if (name) name.textContent = user.displayName || 'User';
        const email = document.getElementById('userEmail');
        if (email) email.textContent = user.email;
    }
}

function updateUIForUnauthenticatedUser() {
    const btn = document.getElementById('signInButton');
    if (btn) btn.style.display = 'flex';
    const profile = document.getElementById('userProfile');
    if (profile) profile.style.display = 'none';
}

if (typeof window !== 'undefined') {
    const origContract = window.saveContractProgress;
    window.saveContractProgress = function() {
        if (origContract) origContract();
        if (typeof contractBuilderState !== 'undefined' && contractBuilderState.contractId) {
            saveToCloud('contracts', contractBuilderState.contractId, contractBuilderState);
        }
    };
    const origChecklist = window.saveOnboardingProgress;
    window.saveOnboardingProgress = function() {
        if (origChecklist) origChecklist();
        if (typeof onboardingState !== 'undefined' && onboardingState.checklistId) {
            saveToCloud('checklists', onboardingState.checklistId, onboardingState);
        }
    };
    const origTraining = window.saveTrainingPlan;
    window.saveTrainingPlan = function() {
        if (origTraining) origTraining();
        if (typeof trainingPlanState !== 'undefined' && trainingPlanState.planId) {
            saveToCloud('trainingPlans', trainingPlanState.planId, trainingPlanState);
        }
    };
}


// ============================================
// COMPREHENSIVE CROSS-DEVICE SYNC SYSTEM
// ============================================

// This replaces the existing sync functions with a complete solution

// ==========================================
// 1. SAVE ALL DATA TO CLOUD
// ==========================================

async function saveAllDataToCloud() {
    if (!currentUser || !db) {
        return;
    }
    
    try {
        const userDocRef = db.collection('users').doc(currentUser.uid);
        
        // Get all localStorage data
        const allData = {
            // Conversations
            conversations: JSON.parse(localStorage.getItem('fitz_conversations') || '[]'),
            currentConversationId: localStorage.getItem('currentConversationId'),
            
            // Bookmarks
            bookmarks: JSON.parse(localStorage.getItem('fitz_bookmarks') || '[]'),
            recentTools: JSON.parse(localStorage.getItem('fitz_recent_tools') || '[]'),
            
            // Preferences
            darkMode: localStorage.getItem('darkMode'),
            venueProfile: JSON.parse(localStorage.getItem('venueProfile_' + currentUser.uid) || '{}'),
            
            // Get all contracts
            contracts: getAllContractsFromLocalStorage(),
            
            // Get all checklists
            checklists: getAllChecklistsFromLocalStorage(),
            
            // Get all training plans
            trainingPlans: getAllTrainingPlansFromLocalStorage(),
            
            // Document logs
            documentLogs: JSON.parse(localStorage.getItem('documentLogs_' + currentUser.uid) || '[]'),
            
            // Timestamp
            lastSyncedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Save to a single user document for complete state
        await userDocRef.set({
            appState: allData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        return true;
        
    } catch (error) {
        return false;
    }
}

// Helper functions to get all items from localStorage
function getAllContractsFromLocalStorage() {
    const contracts = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('contract_')) {
            try {
                contracts.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {
            }
        }
    }
    return contracts;
}

function getAllChecklistsFromLocalStorage() {
    const checklists = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('checklist_')) {
            try {
                checklists.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {
            }
        }
    }
    return checklists;
}

function getAllTrainingPlansFromLocalStorage() {
    const plans = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('training_plan_')) {
            try {
                plans.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {
            }
        }
    }
    return plans;
}

// ==========================================
// 2. LOAD ALL DATA FROM CLOUD
// ==========================================

async function loadAllDataFromCloud() {
    if (!currentUser || !db) {
        return false;
    }
    
    try {
        const userDocRef = db.collection('users').doc(currentUser.uid);
        const doc = await userDocRef.get();
        
        if (!doc.exists || !doc.data().appState) {
            return false;
        }
        
        const cloudData = doc.data().appState;
        // Restore conversations
        if (cloudData.conversations && cloudData.conversations.length > 0) {
            localStorage.setItem('fitz_conversations', JSON.stringify(cloudData.conversations));
            conversations = cloudData.conversations;
        }
        
        if (cloudData.currentConversationId) {
            localStorage.setItem('currentConversationId', cloudData.currentConversationId);
            currentConversationId = cloudData.currentConversationId;
        }
        
        // Restore bookmarks
        if (cloudData.bookmarks) {
            localStorage.setItem('fitz_bookmarks', JSON.stringify(cloudData.bookmarks));
        }
        
        if (cloudData.recentTools) {
            localStorage.setItem('fitz_recent_tools', JSON.stringify(cloudData.recentTools));
        }
        
        // Restore preferences
        if (cloudData.darkMode) {
            localStorage.setItem('darkMode', cloudData.darkMode);
        }
        
        if (cloudData.venueProfile) {
            localStorage.setItem('venueProfile_' + currentUser.uid, JSON.stringify(cloudData.venueProfile));
        }
        
        // Restore contracts
        if (cloudData.contracts && cloudData.contracts.length > 0) {
            cloudData.contracts.forEach(contract => {
                localStorage.setItem('contract_' + contract.contractId, JSON.stringify(contract));
            });
        }
        
        // Restore checklists
        if (cloudData.checklists && cloudData.checklists.length > 0) {
            cloudData.checklists.forEach(checklist => {
                localStorage.setItem('checklist_' + checklist.checklistId, JSON.stringify(checklist));
            });
        }
        
        // Restore training plans
        if (cloudData.trainingPlans && cloudData.trainingPlans.length > 0) {
            cloudData.trainingPlans.forEach(plan => {
                localStorage.setItem('training_plan_' + plan.planId, JSON.stringify(plan));
            });
        }
        
        // Restore document logs
        if (cloudData.documentLogs) {
            localStorage.setItem('documentLogs_' + currentUser.uid, JSON.stringify(cloudData.documentLogs));
        }
        
        // NOW REFRESH THE UI
        await refreshAllUI();
        
        return true;
        
    } catch (error) {
        return false;
    }
}

// ==========================================
// 3. REFRESH ALL UI COMPONENTS
// ==========================================

async function refreshAllUI() {
    // Small delay to ensure data is written
    await new Promise(resolve => setTimeout(resolve, 500));
    
    try {
        // Refresh conversation list
        if (conversations && conversations.length > 0) {
            if (typeof updateSidebarChats === 'function') {
                updateSidebarChats();
            }
        }
        
        // Trigger a page state update
        const event = new CustomEvent('dataLoaded');
        window.dispatchEvent(event);
        
    } catch (error) {
    }
}

// ==========================================
// 4. AUTO-SYNC ON CHANGES
// ==========================================

// Debounce function to prevent too many syncs
let syncTimeout = null;
function debouncedSync() {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(() => {
        saveAllDataToCloud();
    }, 2000); // Wait 2 seconds after last change
}

// Override localStorage.setItem to auto-sync
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
    originalSetItem.call(this, key, value);
    
    // Auto-sync for important data
    if (currentUser && db) {
        if (key.startsWith('contract_') || 
            key.startsWith('checklist_') || 
            key.startsWith('training_plan_') ||
            key === 'fitz_conversations' ||
            key === 'fitz_bookmarks' ||
            key.startsWith('venueProfile_')) {
            
            debouncedSync();
        }
    }
};

// ==========================================
// 5. REAL-TIME SYNC LISTENER
// ==========================================

let unsubscribeCloudSync = null;

function setupRealTimeCloudSync() {
    if (!currentUser || !db) return;
    
    const userDocRef = db.collection('users').doc(currentUser.uid);
    
    unsubscribeCloudSync = userDocRef.onSnapshot((doc) => {
        if (!doc.exists) return;
        
        const data = doc.data();
        if (data.appState && data.appState.lastSyncedAt) {
            loadAllDataFromCloud();
        }
    }, (error) => {
    });
    
}

function stopRealTimeCloudSync() {
    if (unsubscribeCloudSync) {
        unsubscribeCloudSync();
        unsubscribeCloudSync = null;
    }
}

// ============================================
// FIREBASE-FIRST SYNC SYSTEM
// No more localStorage dependency!
// ============================================

// Save conversation to Firebase immediately
async function saveConversationToFirebase(conversation) {
    if (!currentUser || !db) {
        return false;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid)
                  .collection('conversations').doc(conversation.id)
                  .set(conversation, { merge: true });
        return true;
    } catch (error) {
        return false;
    }
}

// Load all conversations from Firebase
async function loadConversationsFromFirebase() {
    if (!currentUser || !db) {
        loadConversations();
        return conversations || [];
    }
    
    try {
        // First, load from localStorage to have something
        loadConversations();
        const localConversations = [...conversations];
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                   .collection('conversations')
                                   .get();
        
        const firebaseConversations = [];
        snapshot.forEach(doc => {
            firebaseConversations.push(doc.data());
        });
        
        // Merge: Firebase takes priority, but keep local ones that aren't in Firebase
        const mergedMap = new Map();
        
        // Add local conversations first
        localConversations.forEach(conv => {
            if (conv && conv.id) {
                mergedMap.set(conv.id, conv);
            }
        });
        
        // Override with Firebase conversations (more authoritative)
        firebaseConversations.forEach(conv => {
            if (conv && conv.id) {
                mergedMap.set(conv.id, conv);
            }
        });
        
        // Update the global conversations variable
        conversations = Array.from(mergedMap.values());
        
        // Sort in memory (most recent first)
        conversations.sort((a, b) => {
            const dateA = new Date(a.updated || a.created || 0);
            const dateB = new Date(b.updated || b.created || 0);
            return dateB - dateA;
        });
        
        // Save merged result back to localStorage
        localStorage.setItem('fitz_conversations', JSON.stringify(conversations));
        
        return conversations;
    } catch (error) {
        loadConversations();
        return conversations || [];
    }
}

// Save contract to Firebase
async function saveContractToFirebase(contract) {
    if (!currentUser || !db) {
        return false;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid)
                  .collection('contracts').doc(contract.contractId)
                  .set(contract, { merge: true });
        return true;
    } catch (error) {
        return false;
    }
}

// Load all contracts from Firebase
async function loadContractsFromFirebase() {
    if (!currentUser || !db) {
        return [];
    }
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                   .collection('contracts').get();
        
        const contracts = [];
        snapshot.forEach(doc => {
            contracts.push(doc.data());
        });
        
        return contracts;
    } catch (error) {
        return [];
    }
}

// Save checklist to Firebase
async function saveChecklistToFirebase(checklist) {
    if (!currentUser || !db) {
        return false;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid)
                  .collection('checklists').doc(checklist.checklistId)
                  .set(checklist, { merge: true });
        return true;
    } catch (error) {
        return false;
    }
}

// Load all checklists from Firebase
async function loadChecklistsFromFirebase() {
    if (!currentUser || !db) {
        return [];
    }
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                   .collection('checklists').get();
        
        const checklists = [];
        snapshot.forEach(doc => {
            checklists.push(doc.data());
        });
        
        return checklists;
    } catch (error) {
        return [];
    }
}

// Save training plan to Firebase
async function saveTrainingPlanToFirebase(plan) {
    if (!currentUser || !db) {
        return false;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid)
                  .collection('trainingPlans').doc(plan.planId)
                  .set(plan, { merge: true });
        return true;
    } catch (error) {
        return false;
    }
}

// Load all training plans from Firebase
async function loadTrainingPlansFromFirebase() {
    if (!currentUser || !db) {
        return [];
    }
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                   .collection('trainingPlans').get();
        
        const plans = [];
        snapshot.forEach(doc => {
            plans.push(doc.data());
        });
        
        return plans;
    } catch (error) {
        return [];
    }
}

// MASTER LOAD FUNCTION - Load everything on sign in
async function loadAllDataFromFirebase() {
    if (!currentUser || !db) {
        return;
    }
    
    try {
        // Load all data types
        await Promise.all([
            loadConversationsFromFirebase(),
            loadContractsFromFirebase(),
            loadChecklistsFromFirebase(),
            loadTrainingPlansFromFirebase(),
            loadBookmarksFromFirebase()
        ]);
        
        // Update sidebar with loaded data
        if (typeof updateSidebarChats === 'function') {
            updateSidebarChats();
        }
        if (typeof updateSidebarBookmarks === 'function') {
            updateSidebarBookmarks();
        }
        
    } catch (error) {
    }
}

</script>
</body>
</html>
