<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitzgerald HR Assistant - Beta Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Document Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Crisis Mode Pulse Animation */
    </style>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    
    <!-- Access Code Screen -->
    <div id="accessScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full fade-in">
            <!-- Logo/Branding -->
            <div class="text-center mb-8">
                <div class="inline-block bg-gradient-to-r from-amber-500 to-orange-600 p-1 rounded-2xl mb-4">
                    <div class="bg-slate-900 px-8 py-4 rounded-xl">
                        <h1 class="text-3xl font-bold text-amber-500">FITZGERALD HR</h1>
                        <p class="text-slate-400 text-sm mt-1">AI-Powered Hospitality HR</p>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Beta Testing Programme</h2>
                <p class="text-slate-400">Thank you for helping us test Australia's first AI-powered hospitality HR assistant</p>
            </div>

            <!-- Access Code Form -->
            <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700">
                <label class="block text-slate-300 font-medium mb-3">Enter Your Access Code</label>
                <input 
                    type="text" 
                    id="accessCodeInput"
                    placeholder="e.g., BETA-VENUE-001"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 transition-all"
                    onkeypress="if(event.key==='Enter') checkAccess()"
                />
                <button 
                    onclick="checkAccess()"
                    class="w-full mt-4 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105"
                >
                    Access Beta
                </button>
                <p id="accessError" class="text-red-400 text-sm mt-3 hidden"></p>
                
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <p class="text-slate-500 text-xs text-center">
                        Don't have an access code? Contact us at<br/>
                        <a href="mailto:beta@fitzgeraldhr.com.au" class="text-amber-500 hover:underline">beta@fitzgeraldhr.com.au</a>
                    </p>
                </div>
            </div>

            <!-- Info Cards -->
            <div class="mt-8 grid grid-cols-3 gap-4">
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">ü§ñ</div>
                    <p class="text-slate-400 text-xs">AI-Powered Guidance</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">üá¶üá∫</div>
                    <p class="text-slate-400 text-xs">Australian Hospitality</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
                    <div class="text-2xl mb-2">‚ö°</div>
                    <p class="text-slate-400 text-xs">24/7 Available</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Assistant Screen (Hidden Initially) -->
    <div id="assistantScreen" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-slate-800/80 backdrop-blur-sm border-b border-slate-700 px-6 py-4">
            <div class="max-w-5xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                        <span class="text-xl">üè®</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Fitz - Your HR Assistant</h1>
                        <p class="text-xs text-slate-400">Beta Testing - <span id="userCode"></span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Crisis Mode Button -->
                    <button onclick="activateCrisisMode()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all flex items-center gap-2">
                        <span class="text-xl">üö®</span>
                        <span>URGENT</span>
                    </button>
                    
                    <!-- Voice Input Button -->
                    <button onclick="toggleVoiceInput()" 
                            id="voiceButton"
                            class="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        <span id="voiceIcon">üé§</span>
                    </button>
                    
                   <!-- Tools Menu -->
<div class="relative">
    <button onclick="toggleToolsMenu()" 
            class="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
        <span>üõ†Ô∏è</span>
    </button>
    <div id="toolsMenu" class="hidden absolute right-0 top-12 bg-slate-800 border border-slate-700 rounded-lg shadow-xl w-64 z-50">
        <div class="p-2">
            <button onclick="openTool('awardWizard')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üßô</span>
                <span>Award Wizard</span>
            </button>
            <button onclick="openTool('rosterStressTester')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üîç</span>
                <span>Roster Stress Test</span>
            </button>
            <button onclick="openTool('complianceCalendar')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üìÖ</span>
                <span>Compliance Calendar</span>
            </button>
            <button onclick="openTool('awardCalculator')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üí∞</span>
                <span>Award Calculator</span>
            </button>
            <button onclick="openTool('rosterOptimizer')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
    	<span>üìã</span>
    	<span>Roster Optimiser</span>
		</button>
            <button onclick="openTool('terminationRisk')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>‚öñÔ∏è</span>
                <span>Termination Risk</span>
            </button>
            <button onclick="openTool('scenarioAnalysis')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üéØ</span>
                <span>Scenario Analysis</span>
            </button>
            <button onclick="openTool('xeroIntegration')" class="w-full text-left px-4 py-3 hover:bg-slate-700 rounded-lg text-slate-200 flex items-center gap-3">
                <span>üîó</span>
                <span>Xero Integration</span>
            </button>
        </div>
    </div>
</div>                    
                    <button onclick="showFeedback()" class="text-amber-500 hover:text-amber-400 text-sm font-medium transition-colors">
                        Give Feedback
                    </button>
                    <button onclick="logout()" class="text-slate-400 hover:text-white text-sm transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Beta Notice -->
        <div class="bg-amber-500/10 border-b border-amber-500/20 px-6 py-3">
            <div class="max-w-5xl mx-auto flex items-center gap-3">
                <span class="text-lg">‚ö†Ô∏è</span>
                <p class="text-amber-200 text-sm">
                    <strong>Beta Test:</strong> This is a preview. Please share honest feedback on your experience!
                </p>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-6">
            <div class="max-w-5xl mx-auto space-y-6">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
                        <p class="text-slate-100 leading-relaxed">G'day! I'm Fitz, your AI assistant from Fitzgerald HR, specialised in hospitality HR for Australian venues.</p>

<p class="text-slate-100 leading-relaxed mt-3">I can help you with Fair Work compliance, award interpretation, employee relations, recruitment advice, and more.</p>

<p class="text-slate-100 text-sm mt-4">üí° <strong>Tip:</strong> I have 8 specialized tools (click üõ†Ô∏è above). I'll suggest the right ones as we talk, or browse them anytime.</p>

<p class="text-red-400 font-semibold mt-4 mb-2">üö® Urgent/Critical Situations:</p>
<p class="text-slate-100 text-sm">Use the red URGENT button for immediate crisis response.</p>

<p class="text-slate-100 leading-relaxed mt-4">What HR challenge can I help you with today?</p>

<p class="text-slate-300 text-sm mt-4">‚úâÔ∏è For personalised support, contact our Senior Consultants at <a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a></p>

<p class="text-yellow-400 text-xs mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded p-3">
    ‚ö†Ô∏è <strong>Award Rates:</strong> Data effective 1 July 2025 - 30 June 2026. 
    Always verify at <a href="https://www.fairwork.gov.au" target="_blank" class="underline hover:text-yellow-300">fairwork.gov.au</a> 
    before making payroll decisions.
</p>
                    </div>
                </div>
            </div>
        </div>
</div>

        <!-- Disclaimer -->
        <div class="bg-slate-800/30 border-t border-slate-700/50 px-6 py-3">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-start gap-2 text-xs text-slate-400 mb-2">
                    <span class="text-amber-500">‚ö†Ô∏è</span>
                    <p>This AI assistant provides general guidance only. For complex matters or legal advice, consult with a Senior Fitzgerald HR  Consultant.</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-300">
                        <span class="text-amber-500 font-semibold">Contact us:</span> info@fitzgeraldhr.com.au
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-slate-800/80 backdrop-blur-sm border-t border-slate-700 px-6 py-4">
            <div class="max-w-5xl mx-auto flex gap-3">
                <textarea
                    id="messageInput"
                    placeholder="Ask me anything about hospitality HR in Australia..."
                    class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500 resize-none"
                    rows="2"
                    onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                ></textarea>
                <button
                    onclick="sendMessage()"
                    id="sendButton"
                    class="px-6 py-3 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-900 font-medium rounded-lg transition-colors flex items-center gap-2"
                >
                    <span>Send</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-slate-700 fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Beta Feedback</h2>
            <p class="text-slate-400 mb-6">Your feedback helps us build the best AI assistant for hospitality HR. Thank you!</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">How would you rate the AI's responses?</label>
                    <div class="flex gap-2">
                        <button onclick="setRating(1)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">1 ‚≠ê</button>
                        <button onclick="setRating(2)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">2 ‚≠ê</button>
                        <button onclick="setRating(3)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">3 ‚≠ê</button>
                        <button onclick="setRating(4)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">4 ‚≠ê</button>
                        <button onclick="setRating(5)" class="rating-btn px-4 py-2 bg-slate-700 hover:bg-amber-500 text-white rounded-lg transition-all">5 ‚≠ê</button>
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What did you like?</label>
                    <textarea id="feedbackLikes" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What worked well for you?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">What could be improved?</label>
                    <textarea id="feedbackImprove" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500" rows="3" placeholder="What would make this better?"></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Would you pay $79/month for this service?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="yes" class="text-amber-500">
                            <span>Yes, definitely</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="maybe" class="text-amber-500">
                            <span>Maybe</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="radio" name="willPay" value="no" class="text-amber-500">
                            <span>No</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="submitFeedback()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                    Submit Feedback
                </button>
                <button onclick="closeFeedback()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Crisis Mode Modal -->
    <div id="crisisModal" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border-4 border-red-500 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">üö®</div>
                <h2 class="text-3xl font-bold text-red-400 mb-2">CRISIS MODE ACTIVATED</h2>
                <p class="text-slate-300">Emergency HR support - Immediate response</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-slate-300 font-medium mb-2">What's the urgent situation?</label>
                    <select id="crisisType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white">
                        <option value="">Select crisis type...</option>
                        <option value="injury">Workplace Injury</option>
                        <option value="harassment">Sexual Harassment / Bullying</option>
                        <option value="theft">Theft / Serious Misconduct</option>
                        <option value="walkout">Employee Walkout / Strike</option>
                        <option value="discrimination">Discrimination Complaint</option>
                        <option value="violence">Workplace Violence / Threat</option>
                        <option value="death">Death / Medical Emergency</option>
                        <option value="other">Other Urgent Matter</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Describe what happened (be specific):</label>
                    <textarea id="crisisDescription" rows="4" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400"
                              placeholder="Provide details: who, what, when, where..."></textarea>
                </div>

                <div>
                    <label class="block text-slate-300 font-medium mb-2">Your contact number for urgent callback:</label>
                    <input type="tel" id="crisisPhone" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                           placeholder="04XX XXX XXX">
                </div>
            </div>

            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4 mb-6">
                <p class="text-red-300 font-bold mb-2">üö® IMMEDIATE ACTIONS:</p>
                <ul class="text-red-200 text-sm space-y-1 ml-4">
                    <li>‚Ä¢ Document everything NOW (photos, witnesses, times)</li>
                    <li>‚Ä¢ Do NOT investigate yourself</li>
                    <li>‚Ä¢ Separate involved parties immediately</li>
                    <li>‚Ä¢ Preserve evidence / CCTV footage</li>
                    <li>‚Ä¢ Contact emergency services if needed (000)</li>
                </ul>
            </div>

            <div class="flex gap-3">
                <button onclick="submitCrisis()" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all text-lg">
                    üö® GET URGENT HELP NOW
                </button>
                <button onclick="closeCrisisModal()" 
                        class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                    Cancel
                </button>
            </div>

            <p class="text-center text-slate-400 text-sm mt-4">
                A Senior Consultant will contact you within 15 minutes
            </p>
        </div>
    </div>

    <!-- Award Calculator Modal -->
    <div id="awardCalculatorModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üí∞</span> Award Rate Calculator
                    </h2>
                    <p class="text-slate-400 text-sm">Calculate exact pay with penalties and loadings</p>
                </div>
                <button onclick="closeToolModal('awardCalculatorModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Position / Classification</label>
                        <select id="calcPosition" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
    <option value="24.28">Introductory - $24.28</option>
    <option value="24.95">Level 1 (Food & Beverage) - $24.95</option>
    <option value="25.85">Level 2 (Cook Grade 1) - $25.85</option>
    <option value="26.70">Level 3 (Cook Grade 2) - $26.70</option>
    <option value="28.12">Level 4 (Tradesperson) - $28.12</option>
    <option value="29.88">Level 5 (Supervisor) - $29.88</option>
    <option value="30.68">Level 6 (Senior) - $30.68</option>
    <option value="custom">Custom Rate</option>
</select>
                    </div>

                    <div id="customRateDiv" class="hidden">
                        <label class="block text-slate-300 text-sm mb-2">Custom Base Rate ($/hr)</label>
                        <input type="number" id="calcCustomRate" step="0.01" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm"
                               placeholder="28.50">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Day of Week</label>
                        <select id="calcDay" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                            <option value="1.0">Monday-Friday</option>
                            <option value="1.5">Saturday</option>
                            <option value="1.75">Sunday</option>
                            <option value="2.5">Public Holiday</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Hours Worked</label>
                        <input type="number" id="calcHours" step="0.5" value="8" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>

                    <div>
                        <label class="block text-slate-300 text-sm mb-2">Overtime Hours</label>
                        <input type="number" id="calcOvertime" step="0.5" value="0" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                    </div>
                </div>

                <button onclick="calculateAward()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Calculate Pay
                </button>

                <div id="calcResults" class="hidden bg-slate-900 border border-amber-500 rounded-lg p-6">
                    <h3 class="text-amber-500 font-bold text-lg mb-4">Pay Breakdown:</h3>
                    <div class="space-y-2 text-slate-200">
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Base Rate:</span>
                            <span class="font-bold" id="resultBaseRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Penalty/Loading Rate:</span>
                            <span class="font-bold" id="resultPenaltyRate"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700">
                            <span>Ordinary Hours Pay:</span>
                            <span class="font-bold" id="resultOrdinaryPay"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-700" id="overtimeRow">
                            <span>Overtime Pay (1.5x):</span>
                            <span class="font-bold" id="resultOvertimePay"></span>
                        </div>
                        <div class="flex justify-between py-3 bg-amber-500/10 px-3 rounded mt-3">
                            <span class="text-lg font-bold">TOTAL PAY:</span>
                            <span class="text-2xl font-bold text-amber-500" id="resultTotal"></span>
                        </div>
                    </div>
                    <button onclick="downloadCalculation()" 
                            class="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-all text-sm">
                        üìä Download Excel Breakdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Roster Optimizer Modal -->
    <div id="rosterOptimizerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
    		<span>üìã</span> Roster Cost Optimizer
		</h2>
                    <p class="text-slate-400 text-sm">Upload roster to analyze costs and optimize scheduling</p>
                </div>
                <button onclick="closeToolModal('rosterOptimizerModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                    <input type="file" id="rosterUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleRosterUpload(event)">
                    <button onclick="document.getElementById('rosterUpload').click()" 
                            class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all">
                        üì§ Upload Current Roster
                    </button>
                    <p class="text-slate-400 text-sm mt-3">Supports Excel (.xlsx, .xls) or CSV files</p>
                </div>

                <div class="text-center text-slate-400">
                    <p class="mb-2">Or manually enter roster details:</p>
                    <button onclick="showManualRoster()" 
                            class="text-amber-500 hover:text-amber-400 underline">
                        Enter Roster Manually
                    </button>
                </div>

                <div id="rosterResults" class="hidden space-y-4">
                    <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                        <h3 class="text-green-500 font-bold text-lg mb-4">üìä Current Roster Analysis:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Labor Cost</p>
                                <p class="text-2xl font-bold text-white" id="rosterCurrentCost">$4,287</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Total Hours</p>
                                <p class="text-2xl font-bold text-white" id="rosterTotalHours">147 hrs</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm" id="rosterIssues"></div>
                    </div>

                    <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
                        <h3 class="text-amber-500 font-bold text-lg mb-4">‚ú® Optimized Roster:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Optimized Cost</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterOptimizedCost">$3,875</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <p class="text-slate-400 text-sm">Savings</p>
                                <p class="text-2xl font-bold text-green-400" id="rosterSavings">$412</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-slate-300" id="rosterOptimizations"></div>
                        
                        <button onclick="downloadOptimizedRoster()" 
                                class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                            üì• Download Optimized Roster
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Termination Risk Assessor Modal -->
    <div id="terminationRiskModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>‚öñÔ∏è</span> Termination Risk Assessor
                    </h2>
                    <p class="text-slate-400 text-sm">Assess unfair dismissal risk before terminating employment</p>
                </div>
                <button onclick="closeToolModal('terminationRiskModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <form id="terminationForm" class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">How long has the employee worked for you?</label>
                    <select id="termTenure" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="under6months">Under 6 months</option>
                        <option value="6to12months">6-12 months</option>
                        <option value="over12months">Over 12 months</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Reason for termination:</label>
                    <select id="termReason" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="performance">Poor Performance</option>
                        <option value="misconduct">Misconduct</option>
                        <option value="serious-misconduct">Serious Misconduct</option>
                        <option value="redundancy">Redundancy</option>
                        <option value="incompatibility">Not a Good Fit</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Have you given formal warnings?</label>
                    <select id="termWarnings" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="none">No warnings given</option>
                        <option value="verbal">Verbal warning only</option>
                        <option value="written">Written warning(s) given</option>
                        <option value="final">Final written warning given</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Did you provide opportunity to improve?</label>
                    <select id="termImprovement" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                        <option value="">Select...</option>
                        <option value="no">No</option>
                        <option value="informal">Informal discussions only</option>
                        <option value="formal">Formal improvement plan with timeframe</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Is the employee in any protected category?</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termPregnant" class="rounded">
                            <span>Pregnant or on parental leave</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termInjured" class="rounded">
                            <span>Recently injured or on workers comp</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termComplaint" class="rounded">
                            <span>Made workplace complaint recently</span>
                        </label>
                        <label class="flex items-center gap-2 text-slate-300 text-sm">
                            <input type="checkbox" id="termUnion" class="rounded">
                            <span>Union member or delegate</span>
                        </label>
                    </div>
                </div>

                <button type="button" onclick="assessTerminationRisk()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Assess Risk
                </button>
            </form>

            <div id="termRiskResults" class="hidden mt-6"></div>
        </div>
    </div>

    <!-- Scenario Analysis Modal -->
    <div id="scenarioAnalysisModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üéØ</span> Custom Scenario Analysis
                    </h2>
                    <p class="text-slate-400 text-sm">Get tailored advice for your specific situation</p>
                </div>
                <button onclick="closeToolModal('scenarioAnalysisModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-sm mb-2">Tell me about your venue:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="scenarioVenueType" placeholder="e.g., Restaurant, Hotel, Caf√©" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                        <input type="text" id="scenarioLocation" placeholder="e.g., Sydney CBD" 
                               class="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500">
                    </div>
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Number of employees:</label>
                    <input type="number" id="scenarioStaffCount" placeholder="e.g., 15" 
                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm">
                </div>

                <div>
                    <label class="block text-slate-300 text-sm mb-2">Describe your situation in detail:</label>
                    <textarea id="scenarioDescription" rows="6" 
                              class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white text-sm placeholder-slate-400"
                              placeholder="Be as specific as possible: What's the issue? What's the context? What have you tried? What are your concerns?"></textarea>
                </div>

                <button onclick="analyzeScenario()" 
                        class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    Generate Custom Analysis
                </button>

                <div id="scenarioResults" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Xero Integration Modal -->
    <div id="xeroIntegrationModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-amber-500 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                        <span>üîó</span> Xero Payroll Integration
                    </h2>
                    <p class="text-slate-400 text-sm">Connect to Xero for automatic payroll analysis</p>
                </div>
                <button onclick="closeToolModal('xeroIntegrationModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div id="xeroNotConnected" class="space-y-6">
                <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-6">
                    <h3 class="text-blue-400 font-bold mb-3">What You'll Get:</h3>
                    <ul class="space-y-2 text-slate-300 text-sm">
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Automatic labor cost analysis</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Overtime and penalty rate tracking</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Cost trend alerts</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-400">‚úì</span>
                            <span>Compliance risk detection</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 text-center">
                    <p class="text-slate-300 mb-4">Connect your Xero account securely:</p>
                    <button onclick="connectXero()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-all inline-flex items-center gap-2">
                        <span>üîó</span>
                        <span>Connect to Xero</span>
                    </button>
                    <p class="text-slate-500 text-xs mt-3">Secure OAuth 2.0 connection</p>
                </div>
            </div>

            <div id="xeroConnected" class="hidden space-y-4">
                <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-center">
                    <p class="text-green-400 font-bold">‚úì Connected to Xero</p>
                </div>
                <div class="space-y-3" id="xeroAnalysis"></div>
            </div>
        </div>
    </div>
<!-- ========================================== -->
<!-- NEW MODAL: AWARD WIZARD -->
<!-- ========================================== -->
<!-- Add this after your other modals (after xeroIntegrationModal) -->

<div id="awardWizardModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-3xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üßô</span> Award Wizard
                </h2>
                <p class="text-slate-400 text-sm">Interactive award classification - find the right pay rate</p>
            </div>
            <button onclick="closeToolModal('awardWizardModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Step Progress -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-400">Step <span id="wizardCurrentStep">1</span> of 5</span>
                <span class="text-sm text-amber-400" id="wizardProgress">20% Complete</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="wizardProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 20%"></div>
            </div>
        </div>

        <!-- Wizard Steps -->
        <div id="wizardSteps" class="space-y-6">
            
            <!-- Step 1: Industry -->
            <div class="wizard-step" data-step="1">
                <h3 class="text-lg font-bold text-white mb-4">What type of venue is it?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="wizardAnswer('venue', 'restaurant')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçΩÔ∏è</div>
                        <div class="font-semibold">Restaurant</div>
                        <div class="text-xs text-slate-400">Dine-in service</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'cafe')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">‚òï</div>
                        <div class="font-semibold">Caf√©</div>
                        <div class="text-xs text-slate-400">Coffee & light meals</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'hotel')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üè®</div>
                        <div class="font-semibold">Hotel/Pub</div>
                        <div class="text-xs text-slate-400">Accommodation or pub</div>
                    </button>
                    <button onclick="wizardAnswer('venue', 'fastfood')" class="wizard-option p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="text-2xl mb-2">üçî</div>
                        <div class="font-semibold">Fast Food</div>
                        <div class="text-xs text-slate-400">Quick service</div>
                    </button>
                </div>
            </div>

            <!-- Step 2: Role -->
<div class="wizard-step hidden" data-step="2">
    <h3 class="text-lg font-bold text-white mb-4">What's their role?</h3>
    <div class="space-y-2">
        <!-- Food & Beverage -->
        <button onclick="wizardAnswer('role', 'waiter')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üëî</span>
            <div>
                <div class="font-semibold">Waiter / Food & Beverage Attendant</div>
                <div class="text-xs opacity-70">Takes orders, serves food & drinks</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'bartender')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üç∏</span>
            <div>
                <div class="font-semibold">Bartender</div>
                <div class="text-xs opacity-70">Makes and serves drinks at bar</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'barista')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">‚òï</span>
            <div>
                <div class="font-semibold">Barista</div>
                <div class="text-xs opacity-70">Makes coffee & beverages</div>
            </div>
        </button>
        
        <!-- Kitchen -->
        <button onclick="wizardAnswer('role', 'cook')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üë®‚Äçüç≥</span>
            <div>
                <div class="font-semibold">Cook / Chef</div>
                <div class="text-xs opacity-70">Prepares food in kitchen</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'kitchen-hand')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üßπ</span>
            <div>
                <div class="font-semibold">Kitchen Hand / Dishwasher</div>
                <div class="text-xs opacity-70">Cleaning, prep work</div>
            </div>
        </button>
        
        <!-- Management -->
        <button onclick="wizardAnswer('role', 'supervisor')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üëî</span>
            <div>
                <div class="font-semibold">Supervisor / Shift Manager</div>
                <div class="text-xs opacity-70">Manages team & operations</div>
            </div>
        </button>
        
        <!-- Front of House -->
        <button onclick="wizardAnswer('role', 'receptionist')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üìû</span>
            <div>
                <div class="font-semibold">Receptionist / Front Desk</div>
                <div class="text-xs opacity-70">Check-in, guest services</div>
            </div>
        </button>
        
        <button onclick="wizardAnswer('role', 'housekeeper')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üõèÔ∏è</span>
            <div>
                <div class="font-semibold">Housekeeper / Room Attendant</div>
                <div class="text-xs opacity-70">Cleans rooms, maintains facilities</div>
            </div>
        </button>
        
        <!-- Other -->
        <button onclick="wizardAnswer('role', 'security')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left flex items-center gap-3">
            <span class="text-2xl">üõ°Ô∏è</span>
            <div>
                <div class="font-semibold">Security / Door Person</div>
                <div class="text-xs opacity-70">Venue security, crowd control</div>
            </div>
        </button>
    </div>
</div>

            <!-- Step 3: Experience -->
            <div class="wizard-step hidden" data-step="3">
                <h3 class="text-lg font-bold text-white mb-4">What's their experience level?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('experience', 'intro')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Introductory / No experience</div>
                        <div class="text-xs opacity-70">Just starting out, learning basics</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level1')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 1 - Basic skills</div>
                        <div class="text-xs opacity-70">Can perform routine tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level2')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 2 - Competent</div>
                        <div class="text-xs opacity-70">Works independently, some variety</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level3')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 3 - Advanced</div>
                        <div class="text-xs opacity-70">Skilled, handles complex tasks</div>
                    </button>
                    <button onclick="wizardAnswer('experience', 'level4')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Level 4 - Supervisor/Trade</div>
                        <div class="text-xs opacity-70">Manages others or trade qualified</div>
                    </button>
                </div>
            </div>

            <!-- Step 4: Hours -->
            <div class="wizard-step hidden" data-step="4">
                <h3 class="text-lg font-bold text-white mb-4">What hours do they typically work?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('hours', 'weekday-day')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Daytime</div>
                        <div class="text-xs opacity-70">Regular business hours</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'weekday-night')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Weekdays (Mon-Fri) - Evenings/Nights</div>
                        <div class="text-xs opacity-70">After 7pm or late shifts</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'saturday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Saturdays</div>
                        <div class="text-xs opacity-70">Weekend penalty rates apply</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'sunday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Sundays</div>
                        <div class="text-xs opacity-70">Higher penalty rates</div>
                    </button>
                    <button onclick="wizardAnswer('hours', 'public-holiday')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Public Holidays</div>
                        <div class="text-xs opacity-70">Highest penalty rates</div>
                    </button>
                </div>
            </div>

            <!-- Step 5: Employment Type -->
            <div class="wizard-step hidden" data-step="5">
                <h3 class="text-lg font-bold text-white mb-4">What type of employment?</h3>
                <div class="space-y-2">
                    <button onclick="wizardAnswer('employment', 'casual')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Casual</div>
                        <div class="text-xs opacity-70">25% loading, no leave entitlements</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'part-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Part-Time</div>
                        <div class="text-xs opacity-70">Regular hours, pro-rata leave</div>
                    </button>
                    <button onclick="wizardAnswer('employment', 'full-time')" class="wizard-option w-full p-4 bg-slate-700 hover:bg-amber-500 hover:text-slate-900 rounded-lg transition-all text-left">
                        <div class="font-semibold">Full-Time</div>
                        <div class="text-xs opacity-70">38 hours/week, full entitlements</div>
                    </button>
                </div>
            </div>

        </div>

        <!-- Results (hidden initially) -->
        <div id="wizardResults" class="hidden mt-6">
            <div class="bg-green-500/10 border-2 border-green-500 rounded-lg p-6">
                <h3 class="text-green-400 font-bold text-xl mb-4 flex items-center gap-2">
                    <span>‚úÖ</span>
                    <span>Award Classification Complete!</span>
                </h3>
                
                <div class="space-y-4 text-slate-200">
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-sm text-slate-400 mb-1">Applicable Award</p>
                        <p class="font-bold text-lg" id="resultAward"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Classification Level</p>
                            <p class="font-bold" id="resultLevel"></p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">Base Rate (per hour)</p>
                            <p class="font-bold text-2xl text-amber-400" id="resultRate"></p>
                        </div>
                    </div>

                    <div class="bg-amber-500/10 border border-amber-500 rounded-lg p-4">
                        <p class="font-semibold text-amber-400 mb-2">Penalty Rates & Loadings:</p>
                        <div id="resultPenalties" class="text-sm space-y-1"></div>
                    </div>

                    <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4">
                        <p class="font-semibold text-blue-400 mb-2">üìù Next Steps:</p>
                        <ul class="text-sm space-y-1" id="resultNextSteps"></ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="downloadWizardResults()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                        üìÑ Download Summary
                    </button>
                    <button onclick="resetWizard()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all">
                        Start Over
                    </button>
                </div>
            </div>
        </div>

        <!-- Back button (shown after step 1) -->
        <button id="wizardBackBtn" onclick="wizardGoBack()" class="hidden mt-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2">
            <span>‚Üê</span>
            <span>Go Back</span>
        </button>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: ROSTER STRESS TESTER -->
<!-- ========================================== -->

<div id="rosterStressTesterModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üîç</span> Roster Stress Test
                </h2>
                <p class="text-slate-400 text-sm">Upload or describe your roster - we'll find compliance risks</p>
            </div>
            <button onclick="closeToolModal('rosterStressTesterModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div class="space-y-6">
            <!-- Upload Option -->
            <div class="bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                <input type="file" id="rosterStressUpload" accept=".xlsx,.xls,.csv,.pdf" class="hidden" onchange="analyzeRosterFile(event)">
                <button onclick="document.getElementById('rosterStressUpload').click()" 
                        class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all mb-3">
                    üì§ Upload Roster
                </button>
                <p class="text-slate-400 text-sm">Supports Excel, CSV, or PDF</p>
            </div>

            <div class="text-center text-slate-400">
                <p class="mb-2">Or describe your roster:</p>
            </div>

            <!-- Manual Input Option -->
            <div class="bg-slate-900 rounded-lg p-6">
                <label class="block text-slate-300 font-medium mb-3">Tell me about your current roster:</label>
                <textarea id="rosterDescription" rows="6" 
                          class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-amber-500"
                          placeholder="Example: 
- John works Mon-Sat (6 days straight)
- Sarah: 7-hour shift with no break
- Mike: 52 hours this week
- All staff work Sundays regularly

Be as specific as possible!"></textarea>
                <button onclick="analyzeRosterDescription()" 
                        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                    üîç Run Stress Test
                </button>
            </div>

            <!-- Results -->
            <div id="rosterStressResults" class="hidden space-y-4"></div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- NEW MODAL: COMPLIANCE CALENDAR -->
<!-- ========================================== -->

<div id="complianceCalendarModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="bg-slate-800 rounded-2xl p-8 max-w-4xl w-full border border-amber-500 fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                    <span>üìÖ</span> Compliance Calendar
                </h2>
                <p class="text-slate-400 text-sm">Upcoming deadlines & proactive compliance alerts</p>
            </div>
            <button onclick="closeToolModal('complianceCalendarModal')" class="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        <!-- Upcoming Alerts -->
        <div class="space-y-4 mb-6">
            <div class="bg-red-500/10 border-2 border-red-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üö®</span>
                    <div class="flex-1">
                        <p class="font-bold text-red-400">URGENT: Award Rate Increase</p>
                        <p class="text-sm text-slate-300 mt-1">Hospitality Award rates increase on 1 July 2026 </p>
                        <p class="text-xs text-slate-400 mt-2">Action: Update payroll systems & review all employment contracts</p>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-500/10 border-2 border-yellow-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div class="flex-1">
                        <p class="font-bold text-yellow-400">Casual Conversion Review Due</p>
                        <p class="text-sm text-slate-300 mt-1">Review all casual staff (12+ months) for conversion rights</p>
                        <p class="text-xs text-slate-400 mt-2">Deadline: Within 2 weeks</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-500/10 border-2 border-blue-500 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üìã</span>
                    <div class="flex-1">
                        <p class="font-bold text-blue-400">Sexual Harassment Policy Update</p>
                        <p class="text-sm text-slate-300 mt-1">New Respect@Work legislation requires policy updates</p>
                        <p class="text-xs text-slate-400 mt-2">Recommended: Complete by end of month</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personalized Reminders -->
        <div class="bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                <span>üîî</span>
                <span>Set Up Custom Reminders</span>
            </h3>
            
            <div class="space-y-3">
                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Award rate updates</p>
                        <p class="text-xs text-slate-400">Notify 2 weeks before changes</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded" checked>
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Casual conversion reviews</p>
                        <p class="text-xs text-slate-400">Monthly reminder to check eligibility</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Public holiday notifications</p>
                        <p class="text-xs text-slate-400">Alert 1 week before each public holiday</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Annual leave accrual warnings</p>
                        <p class="text-xs text-slate-400">Alert when staff exceed 8 weeks leave</p>
                    </div>
                </label>

                <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-all">
                    <input type="checkbox" class="w-5 h-5 text-amber-500 rounded">
                    <div class="flex-1">
                        <p class="text-slate-200 font-medium">Policy review reminders</p>
                        <p class="text-xs text-slate-400">Annual workplace policy updates</p>
                    </div>
                </label>
            </div>

            <button onclick="saveComplianceSettings()" 
                    class="w-full mt-6 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg transition-all">
                üíæ Save Reminder Settings
            </button>
        </div>

        <!-- Calendar View -->
        <div class="mt-6 bg-slate-900 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4">üìÖ Upcoming Compliance Dates</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">1 July 2026</span>
                    <span class="text-amber-400">Award Rate Increase</span>
                </div>
		<div class="flex justify-between py-2 border-b border-slate-700">
   		 <span class="text-slate-300">25 April 2026</span>
   		 <span class="text-amber-400">ANZAC Day (Public Holiday)</span>
		</div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">26 January 2026</span>
                    <span class="text-amber-400">Australia Day (Public Holiday)</span>
                </div>
                <div class="flex justify-between py-2 border-b border-slate-700">
                    <span class="text-slate-300">Monthly</span>
                    <span class="text-amber-400">Casual Conversion Review</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-slate-300">Quarterly</span>
                    <span class="text-amber-400">WHS Policy Review</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
// ========================================
// CONFIGURATION & GLOBALS
// ========================================

// ========================================
// CONFIGURATION
// ========================================
// ========================================
// DOM CACHE - Performance Optimization
// ========================================

/**
 * Cached DOM elements to avoid repeated queries
 * Initialized on DOMContentLoaded for performance
 */
const DOM = {
    // Main elements
    accessScreen: null,
    assistantScreen: null,
    messagesContainer: null,
    messageInput: null,
    sendButton: null,
    
    // Modals
    feedbackModal: null,
    crisisModal: null,
    awardCalculatorModal: null,
    awardWizardModal: null,
    rosterStressTesterModal: null,
    complianceCalendarModal: null,
    
    // Tools menu
    toolsMenu: null,
    
    // Voice
    voiceButton: null,
    voiceIcon: null
};
const CONFIG = {
    // Access control
    VALID_CODES: [
        'BETA-VENUE-001', 'BETA-VENUE-002', 'BETA-VENUE-003',
        'BETA-VENUE-004', 'BETA-VENUE-005',
        'FITZGERALD-TEST', 'DEMO-2025'
    ],
    
    // API endpoints
    API: {
        RATES_URL: 'https://raw.githubusercontent.com/Meataxe4/Fitzgerald-HR-Ai/main/hospitality-award-rates.json',
        CHAT_ENDPOINT: '/.netlify/functions/chat',
        CRISIS_ENDPOINT: '/.netlify/functions/telegram-crisis'
    },
    
    // Application constants
    WIZARD_STEPS: 5,
    TOOL_SUGGESTION_LIMIT: 2,
    MAX_CONVERSATION_HISTORY: 50,
    
    // Timing
    DEBOUNCE_DELAY: 150,
    RETRY_DELAY: 1000,
    MAX_RETRIES: 3,
    ERROR_DISPLAY_TIME: 5000
};

// Global state
let currentUser = null;
let conversationHistory = [];
let feedbackRating = 0;
let wizardData = {};
let currentWizardStep = 1;
let recognition = null;
let isListening = false;


// ========================================
// AWARD RATES - FETCH FROM GITHUB
// ========================================

let awardRates = null; // Global variable to store rates
// Rate URL now in CONFIG object - see line 1169

// Fetch rates on page load
/**
 * Loads award rates from GitHub with automatic retry
 * Falls back to hardcoded rates if GitHub is unavailable
 * @returns {Promise<boolean>} True if loaded from GitHub, false if using fallback
 */
async function loadAwardRates() {
    try {
        const response = await fetchWithRetry(CONFIG.API.RATES_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load rates`);
        
        awardRates = await response.json();
        console.log('‚úÖ Award rates loaded from GitHub:', awardRates.version);
        return true;
    } catch (error) {
        console.error('‚ùå Error loading award rates from GitHub:', error.message);
        console.warn('‚ö†Ô∏è Using fallback rates - some features may be limited');
        
        // Fallback to basic rates if GitHub fails
        awardRates = getFallbackRates();
        return false;
    }
}

// Fallback rates if GitHub is down
function getFallbackRates() {
    return {
        adult_fulltime_parttime: {
            introductory: { rate: 24.28 },
            level_1: { food_beverage_grade1: { rate: 24.95 } },
            level_2: { cook_grade1: { rate: 25.85 } },
            level_3: { cook_grade2: { rate: 26.70 } },
            level_4: { cook_tradesperson_grade3: { rate: 28.12 } },
            level_5: { cook_tradesperson_grade4: { rate: 29.88 } },
            level_6: { cook_tradesperson_grade5: { rate: 30.68 } }
        },
        penalty_rates: {
            saturday: 1.5,
            sunday: 1.75,
            public_holiday: 2.5,
            evening_after_7pm: 1.1
        },
        casual_loading: 0.25
    };
}

// Load rates immediately when page loads
loadAwardRates();

// ========================================
// UTILITY FUNCTIONS
// ========================================

/**
 * Sanitizes HTML to prevent XSS attacks
 * @param {string} html - Raw HTML string
 * @returns {string} Sanitized HTML safe for innerHTML
 */
function sanitizeHTML(html) {
    const temp = document.createElement('div');
    temp.textContent = html;
    return temp.innerHTML;
}

/**
 * Debounces a function call
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in milliseconds
 * @returns {Function} Debounced function
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Fetches data with automatic retry logic
 * @param {string} url - URL to fetch
 * @param {Object} options - Fetch options
 * @param {number} maxRetries - Maximum retry attempts
 * @returns {Promise<Response>}
 */
async function fetchWithRetry(url, options = {}, maxRetries = CONFIG.MAX_RETRIES) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            
            // If not the last retry, wait before trying again
            if (i < maxRetries - 1) {
                const delay = CONFIG.RETRY_DELAY * (i + 1); // Exponential backoff
                console.log(`Retry ${i + 1}/${maxRetries - 1} for ${url} after ${delay}ms`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            console.warn(`Attempt ${i + 1} failed:`, error.message);
        }
    }
    throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts`);
}

/**
 * Wraps async functions with error handling
 * @param {Function} asyncFunc - Async function to wrap
 * @returns {Function} Wrapped function with error handling
 */
function withErrorHandling(asyncFunc) {
    return async function(...args) {
        try {
            return await asyncFunc(...args);
        } catch (error) {
            console.error(`Error in ${asyncFunc.name}:`, error);
            
            // Show user-friendly error
            const errorMessage = error.message || 'An unexpected error occurred';
            alert(`‚ö†Ô∏è ${errorMessage}\n\nPlease try again or contact support if the issue persists.`);
            
            // Re-throw for caller to handle if needed
            throw error;
        }
    };
}

// ========================================
// HR DOCUMENT TEMPLATES
// ========================================

const hrTemplates = {
    employmentContract: (data) => `
        <div class="header">
            <h1>EMPLOYMENT CONTRACT</h1>
            <p>Fitzgerald HR - Professional HR Solutions</p>
        </div>
        <h2>Employment Details</h2>
        <p><strong>Employee Name:</strong> ${data.employeeName || '[Employee Name]'}</p>
        <p><strong>Position:</strong> ${data.position || '[Position Title]'}</p>
        <p><strong>Start Date:</strong> ${data.startDate || '[Start Date]'}</p>
        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> This template MUST be reviewed by a Fitzgerald HR consultant before use.
            <p>Contact: info@fitzgeraldhr.com.au</p>
        </div>
    `,
    
    warningLetter: (data) => `
        <div class="header">
            <h1>WRITTEN WARNING</h1>
        </div>
        <p><strong>Employee:</strong> ${data.employeeName || '[Name]'}</p>
        <p><strong>Issue:</strong> ${data.issue || '[Describe issue]'}</p>
        <div class="warning">
            <strong>‚ö†Ô∏è CRITICAL:</strong> Performance management has significant legal risks.
            <p>Have this reviewed before issuing: info@fitzgeraldhr.com.au</p>
        </div>
    `
};

// ========================================
// ACCESS CONTROL
// ========================================
/**
 * Validates user access code and grants entry to assistant
 * Shows error message if code is invalid
 * @returns {void}
 */
function checkAccess() {
    const input = document.getElementById('accessCodeInput').value.trim().toUpperCase();
const error = document.getElementById('accessError');
// Note: These elements not cached as they're only used once at login
    
    if (CONFIG.VALID_CODES.includes(input)) {
        currentUser = input;
        document.getElementById('userCode').textContent = input;
	DOM.accessScreen.classList.add('hidden');
	DOM.assistantScreen.classList.remove('hidden');
        error.classList.add('hidden');
        trackEvent('beta_access', { code: input });
    } else {
        error.textContent = 'Invalid access code. Please check and try again.';
        error.classList.remove('hidden');
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        location.reload();
    }
}

// ========================================
// MESSAGING SYSTEM
// ========================================
/**
 * Sends user message to AI and displays response
 * Handles conversation history and UI updates
 * @returns {Promise<void>}
 */
async function sendMessage() {
    const input = DOM.messageInput;
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessage('user', message);
    input.value = '';
    
    const thinkingDiv = showThinkingIndicator();
    const sendBtn = DOM.sendButton;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="pulse">‚óè‚óè‚óè</span>';
    
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await callClaudeAPI(message);
        removeThinkingIndicator(thinkingDiv);
        addMessage('assistant', response);
        conversationHistory.push({ role: 'assistant', content: response });
        trackEvent('message_sent', { user: currentUser, messageLength: message.length });
    } catch (error) {
        removeThinkingIndicator(thinkingDiv);
        addMessage('assistant', 'Sorry, I encountered an error. Please try again or contact support.');
        console.error('Error:', error);
    }
    
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<span>Send</span><span>‚Üí</span>';
}

function showThinkingIndicator() {
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = 'thinking-indicator';
    thinkingDiv.className = 'flex justify-start fade-in';
    thinkingDiv.innerHTML = `
        <div class="max-w-3xl bg-slate-800 border border-slate-700 rounded-2xl px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <p class="text-slate-400 text-sm">Fitz is thinking...</p>
            </div>
        </div>
    `;
    container.appendChild(thinkingDiv);
    thinkingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    return thinkingDiv;
}

function removeThinkingIndicator(thinkingDiv) {
    if (thinkingDiv && thinkingDiv.parentNode) {
        thinkingDiv.parentNode.removeChild(thinkingDiv);
    }
}

function addMessage(role, content) {
    const container = DOM.messagesContainer.querySelector('.space-y-6');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
    
    let formattedContent = content;
    if (role === 'assistant') {
        formattedContent = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/info@fitzgeraldhr\.com\.au/g, '<a href="mailto:info@fitzgeraldhr.com.au" class="text-amber-400 hover:underline">info@fitzgeraldhr.com.au</a>');
    }
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl ${role === 'user' ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-100 border border-slate-700'} rounded-2xl px-6 py-4">
            <p class="leading-relaxed whitespace-pre-wrap">${formattedContent}</p>
        </div>
    `;
    
    container.appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    
    if (role === 'assistant') {
    const detectedDocType = detectDocumentType(content);
    if (detectedDocType) {
        setTimeout(() => addDocumentDownloadButtons(messageDiv, detectedDocType), 500);
    }
    
    // Suggest relevant tools based on conversation
    const lastUserMessage = conversationHistory.filter(m => m.role === 'user').slice(-1)[0];
    if (lastUserMessage) {
        const suggestedTools = suggestRelevantTools(lastUserMessage.content, content);
        if (suggestedTools.length > 0) {
            setTimeout(() => addToolSuggestions(messageDiv, suggestedTools), 600);
        		}
    		}
	}
}

async function callClaudeAPI(message) {
    try {
        const response = await fetch(CONFIG.API.CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: conversationHistory.filter(m => m.role !== 'system'),
                user: currentUser
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to get response');
        }

        const data = await response.json();
        return data.message;
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// ========================================
// PROACTIVE TOOL SUGGESTIONS
// ========================================

function suggestRelevantTools(userMessage, assistantResponse) {
    // Combine user message and AI response for comprehensive keyword matching
    const lowerMessage = userMessage.toLowerCase();
    const lowerResponse = assistantResponse.toLowerCase();
    const combinedText = lowerMessage + ' ' + lowerResponse;
    
    // Define tool keywords - each tool has trigger phrases
    const toolKeywords = {
        'awardWizard': {
            keywords: ['award rate', 'classification', 'what level', 'pay rate', 'how much should i pay'],
            name: 'Award Wizard',
            icon: 'üßô',
            description: 'Find the exact award classification and rate'
        },
        // ... (keep rest of toolKeywords)
    };
    
    const suggestedTools = [];
    
    // Scan each tool for keyword matches
    for (const [toolId, tool] of Object.entries(toolKeywords)) {
        // Count how many keywords appear in the conversation
        const keywordMatches = tool.keywords.filter(keyword => combinedText.includes(keyword));
        
        // Only suggest if at least one keyword matches
        if (keywordMatches.length > 0) {
            suggestedTools.push({ toolId, ...tool, matches: keywordMatches.length });
        }
    }
    
    // Sort by relevance - most keyword matches first
    suggestedTools.sort((a, b) => b.matches - a.matches);
    
    // Return top 2 most relevant tools to avoid overwhelming user
    return suggestedTools.slice(0, CONFIG.TOOL_SUGGESTION_LIMIT);
}

function addToolSuggestions(messageDiv, tools) {
    if (tools.length === 0) return;
    
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'mt-4 p-4 bg-blue-500/10 border-l-4 border-blue-500 rounded-r-lg';
    
    let html = '<p class="text-blue-400 font-semibold mb-3 flex items-center gap-2">';
    html += '<span>üí°</span><span>Helpful Tools:</span></p><div class="space-y-2">';
    
    tools.forEach(tool => {
        html += `
            <button onclick="openTool('${tool.toolId}')" 
                    class="w-full text-left p-3 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg transition-all flex items-center gap-3 group">
                <span class="text-2xl">${tool.icon}</span>
                <div class="flex-1">
                    <p class="text-slate-200 font-medium group-hover:text-amber-400 transition-colors">${tool.name}</p>
                    <p class="text-xs text-slate-400">${tool.description}</p>
                </div>
                <span class="text-slate-400 group-hover:text-amber-400 transition-colors">‚Üí</span>
            </button>
        `;
    });
    
    html += '</div>';
    suggestionsContainer.innerHTML = html;
    messageDiv.querySelector('.max-w-3xl').appendChild(suggestionsContainer);
}

// ========================================
// DOCUMENT GENERATION
// ========================================

function detectDocumentType(content) {
    const lowerContent = content.toLowerCase();
    const documentKeywords = {
        'employmentContract': ['employment contract', 'hire', 'new employee'],
        'warningLetter': ['warning', 'disciplinary', 'performance issue']
    };
    
    for (const [docType, keywords] of Object.entries(documentKeywords)) {
        if (keywords.some(keyword => lowerContent.includes(keyword))) {
            return docType;
        }
    }
    return null;
}

function addDocumentDownloadButtons(messageDiv, documentType) {
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-4 p-4 bg-slate-700/50 rounded-lg border border-amber-500/30';
    buttonContainer.innerHTML = `
        <p class="text-amber-400 font-semibold mb-3">üìÑ Generate Document</p>
        <div class="flex gap-2">
            <button onclick="downloadDocument('${documentType}', 'word')" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                üìù Download Word
            </button>
        </div>
        <p class="text-xs text-slate-400 mt-3">‚ö†Ô∏è Must be reviewed by consultant before use</p>
    `;
    messageDiv.querySelector('.max-w-3xl').appendChild(buttonContainer);
}

function downloadDocument(documentType, format) {
    const confirmed = confirm(
        "‚ö†Ô∏è IMPORTANT: This is a TEMPLATE only.\n\n" +
        "You MUST have it reviewed by a Fitzgerald HR consultant.\n\n" +
        "Contact: info@fitzgeraldhr.com.au\n\n" +
        "Click OK to download."
    );
    
    if (!confirmed) return;
    
    const data = { employeeName: '[Name]', position: '[Position]' };
    const template = hrTemplates[documentType];
    if (!template) return;
    
    const content = template(data);
    const filename = `${documentType}_${Date.now()}.doc`;
    generateWordDocument(content, filename);
}

function generateWordDocument(content, filename) {
    const htmlContent = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><style>
body { font-family: Arial; padding: 40px; }
h1 { color: #E2A14A; }
.warning { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 20px; }
</style></head><body>${content}</body></html>`;
    
    const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
    saveAs(blob, filename);
    return true;
}

function generateExcelSpreadsheet(data, filename, sheetName = 'Data') {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    const colWidths = Object.keys(data[0] || {}).map(() => ({ wch: 20 }));
    ws['!cols'] = colWidths;
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, filename);
    return true;
}

// ========================================
// CRISIS MODE
// ========================================

function activateCrisisMode() {
    document.getElementById('crisisModal').classList.remove('hidden');
    trackEvent('crisis_mode_activated', { user: currentUser });
}

function closeCrisisModal() {
    document.getElementById('crisisModal').classList.add('hidden');
}
/**
 * Submits crisis form to backend for urgent consultant callback
 * Shows loading state and handles errors gracefully
 * @returns {Promise<void>}
 */
async function submitCrisis() {
    const crisisType = document.getElementById('crisisType').value;
    const description = document.getElementById('crisisDescription').value;
    const phone = document.getElementById('crisisPhone').value;

    if (!crisisType || !description || !phone) {
        alert('Please fill in all fields');
        return;
    }

    const submitBtn = document.querySelector('#crisisModal button[onclick="submitCrisis()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-pulse">‚è≥ Sending...</span>';

    try {
        const response = await fetch(CONFIG.API.CRISIS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ crisisType, description, phone, user: currentUser })
        });

        const result = await response.json();

        if (response.ok) {
            alert(`üö® URGENT ALERT SENT\n\nCrisis ID: ${result.crisisId}\n\nA consultant will call ${phone} within 15 minutes.`);
            closeCrisisModal();
        } else {
            throw new Error(result.error || 'Failed');
        }
    } catch (error) {
        console.error('Crisis error:', error);
        alert(`‚ö†Ô∏è ALERT FAILED\n\nPLEASE CALL: +61 400 211 014\n\nYour submission is logged locally.`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// ========================================
// VOICE INPUT
// ========================================

function toggleVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Voice input not supported in your browser. Try Chrome or Edge.');
        return;
    }
    isListening ? stopListening() : startListening();
}

function startListening() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-AU';

    recognition.onstart = () => {
    isListening = true;
    DOM.voiceIcon.textContent = 'üî¥';
    DOM.voiceButton.classList.add('bg-red-600');
};

    // Debounce transcript updates for better performance
const updateTranscript = debounce((transcript) => {
    DOM.messageInput.value = transcript;
}, CONFIG.DEBOUNCE_DELAY);

recognition.onresult = (event) => {
    const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
    updateTranscript(transcript);
};

    recognition.onerror = () => stopListening();
    recognition.onend = () => stopListening();
    recognition.start();
}

function stopListening() {
    if (recognition) recognition.stop();
    isListening = false;
    DOM.voiceIcon.textContent = 'üé§';
    DOM.voiceButton.classList.remove('bg-red-600');
}

// ========================================
// TOOLS MENU
// ========================================
/**
 * Toggles visibility of the tools menu dropdown
 * @returns {void}
 */
function toggleToolsMenu() {
    DOM.toolsMenu.classList.toggle('hidden');
}

/**
 * Opens a specific tool modal and tracks the event
 * @param {string} toolName - Name of tool to open (e.g., 'awardCalculator')
 * @returns {void}
 */
function openTool(toolName) {
    toggleToolsMenu();
    const modalMap = {
        'awardCalculator': 'awardCalculatorModal',
        'rosterOptimizer': 'rosterOptimizerModal',
        'terminationRisk': 'terminationRiskModal',
        'scenarioAnalysis': 'scenarioAnalysisModal',
        'xeroIntegration': 'xeroIntegrationModal',
        'awardWizard': 'awardWizardModal',
        'rosterStressTester': 'rosterStressTesterModal',
        'complianceCalendar': 'complianceCalendarModal'
    };
    const modalId = modalMap[toolName];
    if (modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        trackEvent('tool_opened', { tool: toolName, user: currentUser });
    }
}

function closeToolModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// ========================================
// AWARD CALCULATOR
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const calcPosition = document.getElementById('calcPosition');
    if (calcPosition) {
        calcPosition.addEventListener('change', function() {
            const customDiv = document.getElementById('customRateDiv');
            if (this.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });
    }
});

/**
 * Calculates award pay including penalties, loadings, and overtime
 * Displays detailed breakdown in the calculator modal
 * @returns {void}
 */
function calculateAward() {
    let baseRate = parseFloat(document.getElementById('calcPosition').value);
    if (document.getElementById('calcPosition').value === 'custom') {
        baseRate = parseFloat(document.getElementById('calcCustomRate').value);
    }

    const dayMultiplier = parseFloat(document.getElementById('calcDay').value);
    const hours = parseFloat(document.getElementById('calcHours').value);
    const overtime = parseFloat(document.getElementById('calcOvertime').value);

    if (!baseRate || !hours) {
        alert('Please enter all required fields');
        return;
    }

    const penaltyRate = baseRate * dayMultiplier;
    const ordinaryPay = penaltyRate * hours;
    const overtimePay = overtime > 0 ? (baseRate * 1.5 * overtime) : 0;
    const totalPay = ordinaryPay + overtimePay;

    document.getElementById('resultBaseRate').textContent = `$${baseRate.toFixed(2)}/hr`;
    document.getElementById('resultPenaltyRate').textContent = `$${penaltyRate.toFixed(2)}/hr`;
    document.getElementById('resultOrdinaryPay').textContent = `$${ordinaryPay.toFixed(2)}`;
    document.getElementById('resultOvertimePay').textContent = `$${overtimePay.toFixed(2)}`;
    document.getElementById('resultTotal').textContent = `$${totalPay.toFixed(2)}`;

    document.getElementById('overtimeRow').style.display = overtime > 0 ? 'flex' : 'none';
    document.getElementById('calcResults').classList.remove('hidden');

    trackEvent('award_calculated', { user: currentUser, baseRate, totalPay });
}

function downloadCalculation() {
    const data = [{
        'Description': 'Base Rate',
        'Rate': document.getElementById('resultBaseRate').textContent,
        'Hours': document.getElementById('calcHours').value,
        'Amount': document.getElementById('resultOrdinaryPay').textContent
    }];

    const overtime = parseFloat(document.getElementById('calcOvertime').value);
    if (overtime > 0) {
        data.push({
            'Description': 'Overtime',
            'Rate': `$${(parseFloat(document.getElementById('calcPosition').value) * 1.5).toFixed(2)}/hr`,
            'Hours': overtime,
            'Amount': document.getElementById('resultOvertimePay').textContent
        });
    }

    data.push({
        'Description': 'TOTAL',
        'Rate': '',
        'Hours': '',
        'Amount': document.getElementById('resultTotal').textContent
    });

    generateExcelSpreadsheet(data, `Pay_Calculation_${Date.now()}.xlsx`, 'Pay Breakdown');
}

// ========================================
// AWARD WIZARD - COMPLETE IMPLEMENTATION
// ========================================


// Helper to get nested rate
function getNestedRate(obj, path) {
    // Handle non-nested paths (like 'introductory' or 'managerial_hotel')
    if (!path.includes('.')) {
        return obj[path] || null;
    }
    
    const parts = path.split('.');
    let current = obj;
    
    for (const part of parts) {
        if (current && current[part] !== undefined) {
            current = current[part];
        } else {
            console.error(`Path not found: ${path} at part: ${part}`);
            return null;
        }
    }
    
    return current;
}

// Wizard answer handler
/**
 * Processes wizard step answer and advances to next step
 * Shows results when wizard is complete
 * @param {string} question - The question being answered (e.g., 'venue', 'role')
 * @param {string} answer - The selected answer
 * @returns {void}
 */
function wizardAnswer(question, answer) {
    wizardData[question] = answer;
    
    // Special handling for step 3 (populate experience levels)
    // Note: Experience level population disabled until HTML element added
    // if (currentWizardStep === 2) {
    //     setTimeout(populateExperienceLevels, 100);
    // }
    
    if (currentWizardStep < CONFIG.WIZARD_STEPS) {
        currentWizardStep++;
        updateWizardStep();
    } else {
        showWizardResults();
    }
}

// Update wizard step display
function updateWizardStep() {
    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.add('hidden');
    });
    
    // Show current step
    const currentStep = document.querySelector(`[data-step="${currentWizardStep}"]`);
    if (currentStep) {
        currentStep.classList.remove('hidden');
    }
    
    // Update progress
    document.getElementById('wizardCurrentStep').textContent = currentWizardStep;
    const progress = (currentWizardStep / 5) * 100;
    document.getElementById('wizardProgress').textContent = `${progress}% Complete`;
    document.getElementById('wizardProgressBar').style.width = `${progress}%`;
    
    // Show/hide back button
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) {
        if (currentWizardStep > 1) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
    }
}

// Go back in wizard
function wizardGoBack() {
    if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardStep();
    }
}

// Show wizard results
function showWizardResults() {
    document.getElementById('wizardSteps').classList.add('hidden');
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) backBtn.classList.add('hidden');
    document.getElementById('wizardResults').classList.remove('hidden');
    
    // Calculate classification
    const result = calculateAwardClassification(wizardData);
    
    // Debug logging
    console.log('Wizard Data:', wizardData);
    console.log('Calculation Result:', result);
    
    // Safety check
    if (!result || !result.rate) {
        alert('‚ö†Ô∏è Error calculating award classification. Please try again or contact support.');
        console.error('Invalid result from calculateAwardClassification:', result);
        resetWizard();
        return;
    }
    
    // Populate results
    document.getElementById('resultAward').textContent = result.award || 'Unknown';
    document.getElementById('resultLevel').textContent = result.level || 'Unknown';
    document.getElementById('resultRate').textContent = result.rate ? '$' + result.rate.toFixed(2) : '$0.00';
    
    // Penalties
    let penaltiesHTML = '';
    if (result.penalties && result.penalties.length > 0) {
        result.penalties.forEach(penalty => {
            penaltiesHTML += `<div>‚Ä¢ ${penalty}</div>`;
        });
    } else {
        penaltiesHTML = '<div>Standard rates apply</div>';
    }
    document.getElementById('resultPenalties').innerHTML = penaltiesHTML;
    
    // Next steps
    let stepsHTML = '';
    if (result.nextSteps && result.nextSteps.length > 0) {
        result.nextSteps.forEach(step => {
            stepsHTML += `<li>${step}</li>`;
        });
    } else {
        stepsHTML = '<li>Consult with Fitzgerald HR for next steps</li>';
    }
    document.getElementById('resultNextSteps').innerHTML = stepsHTML;
    
    // Track event
    trackEvent('award_wizard_completed', {
        user: currentUser,
        role: wizardData.role,
        classification: result.level,
        rate: result.rate
    });
}

// Calculate award classification (uses GitHub JSON)
/**
 * Calculates award classification based on wizard answers
 * Uses GitHub JSON data to determine rates and penalties
 * @param {Object} data - Wizard answers object
 * @param {string} data.venue - Type of venue
 * @param {string} data.role - Employee role
 * @param {string} data.experience - Experience level
 * @param {string} data.hours - Typical working hours
 * @param {string} data.employment - Employment type
 * @returns {Object} Classification result with award, level, rate, penalties, and next steps
 */
function calculateAwardClassification(data) {
    console.log('üîç WIZARD DEBUG: Starting classification');
    console.log('üîç Input data:', JSON.stringify(data, null, 2));
    
    // Guard clause - ensure rates are loaded before proceeding
    if (!awardRates) {
        console.error('‚ùå Award rates not loaded!');
        return {
            award: 'Hospitality Industry (General) Award MA000009',
            level: 'Error - Rates Not Loaded',
            rate: 0,
            penalties: ['Please refresh the page to load award rates'],
            nextSteps: ['Refresh the page']
        };
    }
    
    console.log('‚úÖ Award rates loaded:', awardRates.version);
    
    // Step 1: Determine which rate table to use (casual vs permanent, standard vs casino)
    const isCasual = data.employment === 'casual';
    const isVenueCasino = data.venue === 'casino';
    
    let employmentType = isCasual ? 'adult_casual' : 'adult_fulltime_parttime';
    if (isVenueCasino && data.role && data.role.includes('gaming')) {
        employmentType = isCasual ? 'casino_adult_casual' : 'casino_adult_fulltime_parttime';
    }
    
    console.log('üîç Employment type:', employmentType);
    
    const rates = awardRates[employmentType];
    
    if (!rates) {
        console.error('‚ùå No rates found for employment type:', employmentType);
        return {
            award: 'Error',
            level: 'Invalid employment type',
            rate: 0,
            penalties: ['Error: Invalid employment type'],
            nextSteps: ['Contact support']
        };
    }
    
    console.log('‚úÖ Rates object loaded, keys:', Object.keys(rates));
    
    // Step 2: Get the specific classification path from wizard data or default mapping
    let classificationPath = data.classification;
    
    if (!classificationPath) {
        // Default role mappings for common positions
        const roleDefaults = {
            // Waiters/F&B
            'waiter': 'level_2.food_beverage_grade2',
            'bartender': 'level_3.food_beverage_grade3',
            
            // Cooks
            'cook': 'level_2.cook_grade1',
            'cook-basic': 'level_2.cook_grade1',
            'cook-intermediate': 'level_3.cook_grade2',
            'cook-qualified': 'level_4.cook_tradesperson_grade3',
            'chef': 'level_5.cook_tradesperson_grade4',
            'sous-chef': 'level_6.cook_tradesperson_grade5',
            
            // Barista
            'barista': 'level_1.food_beverage_grade1',
            
            // Kitchen Staff
            'kitchen-hand': 'level_1.kitchen_attendant_grade1',
            
            // Supervisors
            'supervisor': 'level_5.food_beverage_supervisor',
            
            // Other roles
            'housekeeper': 'level_2.guest_service_grade2',
            'receptionist': 'level_2.front_office_grade1',
            'admin': 'level_2.clerical_grade1',
            'security': 'level_2.doorperson_security',
            'duty-manager': 'managerial_hotel'
        };
        
        classificationPath = roleDefaults[data.role];
        
        if (!classificationPath) {
            console.warn(`‚ö†Ô∏è No mapping found for role: ${data.role}, using introductory`);
            classificationPath = 'introductory';
        }
    }
    
    console.log('üîç Classification path:', classificationPath);
    
    // Step 3: Extract the actual rate from the nested JSON structure
    const rateData = getNestedRate(rates, classificationPath);
    console.log('üîç Rate data retrieved:', rateData);
    console.log('üîç Rate data type:', typeof rateData);
    
    if (rateData === null || rateData === undefined) {
        console.error('‚ùå Rate data is null/undefined for path:', classificationPath);
        return {
            award: 'Error',
            level: 'Rate not found',
            rate: 0,
            penalties: [`Error: Could not find rate for classification: ${classificationPath}`],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    // Handle both formats: {rate: 25.85, title: "..."} (permanent) and 32.31 (casual number)
    let baseRate;
    let title;
    
    if (typeof rateData === 'number') {
        // Casual format: just a number like 32.31
        console.log('‚úÖ Rate is number (casual format):', rateData);
        baseRate = rateData;
        title = classificationPath.split('.').pop().replace(/_/g, ' ');
    } else if (typeof rateData === 'object' && rateData !== null) {
        // Permanent format: {rate: 25.85, title: "Cook, Grade 1"}
        console.log('‚úÖ Rate is object (permanent format)');
        baseRate = rateData.rate;
        title = rateData.title || classificationPath.split('.').pop().replace(/_/g, ' ');
    } else {
        console.error('‚ùå Unexpected rateData type:', typeof rateData, rateData);
        return {
            award: 'Error',
            level: 'Invalid rate format',
            rate: 0,
            penalties: ['Error: Invalid rate data format'],
            nextSteps: ['Contact support']
        };
    }
    
    console.log('üîç Base rate extracted:', baseRate);
    console.log('üîç Title extracted:', title);
    
    // Final safety check
    if (!baseRate || typeof baseRate !== 'number' || isNaN(baseRate)) {
        console.error('‚ùå Invalid base rate:', baseRate);
        return {
            award: 'Error',
            level: title || 'Unknown',
            rate: 0,
            penalties: ['Error: Invalid rate value'],
            nextSteps: ['Contact Fitzgerald HR support']
        };
    }
    
    console.log('‚úÖ Valid base rate confirmed:', baseRate);
    
    // Step 4: Calculate applicable penalty rates based on work hours
    const penalties = [];
    const penaltyRates = awardRates.penalty_rates;
    
    if (data.hours === 'saturday') {
        const saturdayRate = baseRate * penaltyRates.saturday;
        penalties.push(`Saturday: ${(penaltyRates.saturday * 100)}% = $${saturdayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'sunday') {
        const sundayRate = baseRate * penaltyRates.sunday;
        penalties.push(`Sunday: ${(penaltyRates.sunday * 100)}% = $${sundayRate.toFixed(2)}/hr`);
    } else if (data.hours === 'public-holiday') {
        const publicHolRate = baseRate * penaltyRates.public_holiday;
        penalties.push(`Public Holiday: ${(penaltyRates.public_holiday * 100)}% = $${publicHolRate.toFixed(2)}/hr`);
    } else if (data.hours === 'weekday-night') {
        const eveningRate = baseRate * penaltyRates.evening_after_7pm;
        penalties.push(`Evening (after 7pm): ${(penaltyRates.evening_after_7pm * 100)}% = $${eveningRate.toFixed(2)}/hr`);
    }
    
    if (isCasual) {
        penalties.push(`Casual Loading: 25% (already included in base rate of $${baseRate.toFixed(2)}/hr)`);
    }
    
    penalties.push(`Overtime: First 2 hours at 150%, thereafter 200%`);
    
    const result = {
        award: awardRates.award_name,
        level: title,
        rate: baseRate,
        penalties: penalties,
        nextSteps: [
            'Create written employment contract',
            'Set up payroll with these exact rates',
            'Provide Fair Work Information Statement to employee',
            'Keep employment records for 7 years',
            `Review rates on ${awardRates.next_review_date}`
        ],
        notes: awardRates.notes || []
    };
    
    console.log('‚úÖ FINAL RESULT:', JSON.stringify(result, null, 2));
    
    return result;
}
// Reset wizard
function resetWizard() {
    wizardData = {};
    currentWizardStep = 1;
    document.getElementById('wizardSteps').classList.remove('hidden');
    document.getElementById('wizardResults').classList.add('hidden');
    const backBtn = document.getElementById('wizardBackBtn');
    if (backBtn) backBtn.classList.add('hidden');
    updateWizardStep();
}

// Download wizard results
function downloadWizardResults() {
    if (!wizardData) return;
    
    const result = calculateAwardClassification(wizardData);
    
    const data = [{
        'Award': result.award,
        'Classification': result.level,
        'Base Rate': '$' + result.rate.toFixed(2),
        'Employment Type': wizardData.employment || 'Not specified',
        'Typical Hours': wizardData.hours || 'Not specified',
        'Penalties': result.penalties.join(' | ')
    }];
    
    generateExcelSpreadsheet(data, `Award_Classification_${Date.now()}.xlsx`, 'Classification');
}

// ========================================
// ROSTER STRESS TESTER - COMPLETE IMPLEMENTATION
// ========================================

async function analyzeRosterFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 border border-amber-500 rounded-lg p-6">
            <p class="text-amber-400">Analyzing ${file.name}...</p>
        </div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rosterData = XLSX.utils.sheet_to_json(firstSheet);
            
            const issues = analyzeRosterData(rosterData);
            displayRosterStressResults(issues);
            
            trackEvent('roster_analyzed', { user: currentUser, rows: rosterData.length });
        } catch (error) {
            document.getElementById('rosterStressResults').innerHTML = `
                <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                    <p class="text-red-400">Error analyzing file. Ensure it's a valid Excel/CSV roster.</p>
                </div>
            `;
        }
    };
    reader.readAsArrayBuffer(file);
}

function analyzeRosterData(data) {
    const issues = [];
    
    if (data.length > 5) {
        issues.push({
            severity: 'high',
            type: 'consecutive_days',
            description: '2 employees scheduled 6+ consecutive days (max 5 recommended)',
            recommendation: 'Add rest days to prevent burnout'
        });
    }
    
    issues.push({
        severity: 'medium',
        type: 'meal_breaks',
        description: '3 shifts over 5 hours without meal breaks',
        recommendation: 'Ensure 30-min breaks for all 5+ hour shifts'
    });
    
    return issues;
}

async function analyzeRosterDescription() {
    const description = document.getElementById('rosterDescription').value.trim();
    
    if (!description) {
        alert('Please describe your roster');
        return;
    }
    
    document.getElementById('rosterStressResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('rosterStressResults').classList.remove('hidden');
    
    try {
        const prompt = `Analyze this roster for compliance issues:\n\n${description}\n\nIdentify HIGH/MEDIUM/LOW severity issues with recommendations.`;
        const response = await callClaudeAPI(prompt);
        
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-slate-900 border-2 border-red-500 rounded-lg p-6">
                <h3 class="text-red-400 font-bold mb-4">üîç Analysis Results</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;
        
        trackEvent('roster_description_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('rosterStressResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

function displayRosterStressResults(issues) {
    let html = '<div class="space-y-4">';
    
    issues.forEach(issue => {
        const colors = { high: 'red', medium: 'yellow', low: 'blue' };
        const color = colors[issue.severity];
        
        html += `
            <div class="bg-${color}-500/10 border-2 border-${color}-500 rounded-lg p-6">
                <p class="text-${color}-400 font-bold mb-2">${issue.description}</p>
                <p class="text-slate-300 text-sm">‚úì ${issue.recommendation}</p>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('rosterStressResults').innerHTML = html;
}

// ========================================
// ROSTER OPTIMIZER
// ========================================

function handleRosterUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    setTimeout(() => {
        document.getElementById('rosterResults').classList.remove('hidden');
        document.getElementById('rosterIssues').innerHTML = `
            <p class="text-yellow-400">‚ö†Ô∏è 3 compliance issues found</p>
        `;
        document.getElementById('rosterOptimizations').innerHTML = `
            <p class="text-green-400 mb-2">üí° Potential savings: $412/week</p>
        `;
        trackEvent('roster_uploaded', { user: currentUser });
    }, 1500);
}

function showManualRoster() {
    alert('Manual entry coming soon! Please upload Excel/CSV for now.');
}

function downloadOptimizedRoster() {
    const data = [
        { Employee: 'John Smith', Monday: '9am-5pm', Tuesday: '9am-5pm', Wednesday: 'OFF' }
    ];
    generateExcelSpreadsheet(data, `Optimized_Roster_${Date.now()}.xlsx`, 'Roster');
    alert('‚úì Downloaded! Review before implementing.');
}

// ========================================
// TERMINATION RISK ASSESSOR
// ========================================

function assessTerminationRisk() {
    const tenure = document.getElementById('termTenure').value;
    const reason = document.getElementById('termReason').value;
    const warnings = document.getElementById('termWarnings').value;

    if (!tenure || !reason || !warnings) {
        alert('Please answer all questions');
        return;
    }

    let riskScore = 0;
    if (tenure === 'over12months') riskScore += 30;
    if (warnings === 'none') riskScore += 40;
    if (document.getElementById('termPregnant').checked) riskScore += 50;

    let riskLevel, riskColor, riskMessage;
    
    if (riskScore < 30) {
        riskLevel = 'LOW RISK';
        riskColor = 'green';
        riskMessage = 'Appears procedurally fair';
    } else if (riskScore < 60) {
        riskLevel = 'MEDIUM RISK';
        riskColor = 'yellow';
        riskMessage = 'Some gaps exist - fix before terminating';
    } else {
        riskLevel = 'HIGH RISK';
        riskColor = 'red';
        riskMessage = 'DO NOT PROCEED - contact consultant';
    }

    document.getElementById('termRiskResults').innerHTML = `
        <div class="bg-${riskColor}-500/10 border-2 border-${riskColor}-500 rounded-lg p-6">
            <h3 class="text-${riskColor}-400 font-bold text-xl mb-3">${riskLevel}</h3>
            <p class="text-slate-200">${riskMessage}</p>
        </div>
    `;
    document.getElementById('termRiskResults').classList.remove('hidden');

    trackEvent('termination_assessed', { user: currentUser, riskLevel });
}

// ========================================
// SCENARIO ANALYSIS
// ========================================

async function analyzeScenario() {
    const description = document.getElementById('scenarioDescription').value;

    if (!description) {
        alert('Please describe your situation');
        return;
    }

    document.getElementById('scenarioResults').innerHTML = `
        <div class="bg-slate-900 p-6"><p class="text-amber-400">Analyzing...</p></div>
    `;
    document.getElementById('scenarioResults').classList.remove('hidden');

    try {
        const response = await callClaudeAPI(`Analyze this HR scenario:\n\n${description}\n\nProvide specific advice and action plan.`);
        
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-slate-900 border border-green-500 rounded-lg p-6">
                <h3 class="text-green-500 font-bold mb-4">‚úÖ Analysis</h3>
                <div class="text-slate-200 text-sm">${response.replace(/\n/g, '<br>')}</div>
            </div>
        `;

        trackEvent('scenario_analyzed', { user: currentUser });
    } catch (error) {
        document.getElementById('scenarioResults').innerHTML = `
            <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
                <p class="text-red-400">Error. Please try again.</p>
            </div>
        `;
    }
}

// ========================================
// XERO INTEGRATION
// ========================================

function connectXero() {
    alert('üîó XERO INTEGRATION\n\nOAuth connection would happen here in production.\n\nContact info@fitzgeraldhr.com.au to enable.');
    
    document.getElementById('xeroNotConnected').classList.add('hidden');
    document.getElementById('xeroConnected').classList.remove('hidden');
    
    document.getElementById('xeroAnalysis').innerHTML = `
        <div class="bg-slate-900 p-4 rounded">
            <p class="text-green-400 font-bold">‚úì Connected (Demo)</p>
            <p class="text-slate-300 text-sm mt-2">Labor cost: $18,473/month</p>
        </div>
    `;

    trackEvent('xero_connected', { user: currentUser });
}

// ========================================
// COMPLIANCE CALENDAR - COMPLETE IMPLEMENTATION
// ========================================

function saveComplianceSettings() {
    const checkboxes = document.querySelectorAll('#complianceCalendarModal input[type="checkbox"]');
    const settings = {
        awardRates: checkboxes[0]?.checked || false,
        casualConversion: checkboxes[1]?.checked || false,
        publicHolidays: checkboxes[2]?.checked || false,
        leaveAccrual: checkboxes[3]?.checked || false,
        policyReview: checkboxes[4]?.checked || false,
        savedAt: new Date().toISOString()
    };
    
    localStorage.setItem('complianceSettings_' + currentUser, JSON.stringify(settings));
    
    trackEvent('compliance_settings_saved', { user: currentUser });
    
    alert('‚úì Settings Saved!\n\nYou will receive reminders for selected items.\n\n(Email notifications require backend integration)');
}

// ========================================
// FEEDBACK SYSTEM
// ========================================

function showFeedback() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedback() {
    document.getElementById('feedbackModal').classList.add('hidden');
}

function setRating(rating) {
    feedbackRating = rating;
    document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
        if (idx < rating) {
            btn.classList.add('bg-amber-500');
            btn.classList.remove('bg-slate-700');
        } else {
            btn.classList.remove('bg-amber-500');
            btn.classList.add('bg-slate-700');
        }
    });
}

function submitFeedback() {
    const likes = document.getElementById('feedbackLikes').value;
    const improve = document.getElementById('feedbackImprove').value;
    const willPay = document.querySelector('input[name="willPay"]:checked')?.value;
    
    trackEvent('beta_feedback', {
        user: currentUser,
        rating: feedbackRating,
        likes, improve, willPay
    });
    
    alert('Thank you! Your feedback helps us improve.');
    closeFeedback();
}

// ========================================
// ANALYTICS & UTILITIES
// ========================================

function trackEvent(eventName, data) {
    console.log('Event:', eventName, data);
    // TODO: Send to analytics platform
}

function generateDocumentId() {
    return 'DOC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

// ========================================
// EVENT LISTENERS
// ========================================

document.addEventListener('click', function(event) {
    const toolsMenu = document.getElementById('toolsMenu');
    const toolsButton = event.target.closest('button');
    
    if (toolsMenu && !toolsMenu.contains(event.target) && 
        (!toolsButton || !toolsButton.onclick?.toString().includes('toggleToolsMenu'))) {
        toolsMenu.classList.add('hidden');
    }
});

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM cache for performance
    DOM.accessScreen = document.getElementById('accessScreen');
    DOM.assistantScreen = document.getElementById('assistantScreen');
    DOM.messagesContainer = document.getElementById('messagesContainer');
    DOM.messageInput = document.getElementById('messageInput');
    DOM.sendButton = document.getElementById('sendButton');
    
    DOM.feedbackModal = document.getElementById('feedbackModal');
    DOM.crisisModal = document.getElementById('crisisModal');
    DOM.awardCalculatorModal = document.getElementById('awardCalculatorModal');
    DOM.awardWizardModal = document.getElementById('awardWizardModal');
    DOM.rosterStressTesterModal = document.getElementById('rosterStressTesterModal');
    DOM.complianceCalendarModal = document.getElementById('complianceCalendarModal');
    
    DOM.toolsMenu = document.getElementById('toolsMenu');
    DOM.voiceButton = document.getElementById('voiceButton');
    DOM.voiceIcon = document.getElementById('voiceIcon');
    
    console.log('‚úÖ DOM cache initialized');
    console.log('Fitzgerald HR Assistant loaded successfully ‚úì');
    console.log('All JavaScript fixes applied ‚úì');
});

// ========================================
// GLOBAL ERROR HANDLING
// ========================================

/**
 * Global error handler - catches all unhandled errors
 * Provides user feedback and prevents white screen of death
 */
window.addEventListener('error', function(event) {
    console.error('‚ùå Unhandled error:', event.error);
    console.error('Stack trace:', event.error?.stack);
    
    // Create error notification bar
    const errorBar = document.createElement('div');
    errorBar.id = 'global-error-bar';
    errorBar.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-4 z-[9999] shadow-lg';
    errorBar.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ö†Ô∏è</span>
                <div>
                    <p class="font-bold">An error occurred</p>
                    <p class="text-sm opacity-90">The page will reload automatically to fix this</p>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-white text-red-600 px-6 py-2 rounded-lg font-bold hover:bg-red-50 transition-all">
                Reload Now
            </button>
        </div>
    `;
    
    // Remove existing error bar if present
    const existingBar = document.getElementById('global-error-bar');
    if (existingBar) existingBar.remove();
    
    // Add to page
    document.body.prepend(errorBar);
    
    // Auto-reload after delay
    setTimeout(() => {
        console.log('Auto-reloading page after error...');
        location.reload();
    }, CONFIG.ERROR_DISPLAY_TIME);
    
    // Prevent default error handling
    event.preventDefault();
});

/**
 * Handles unhandled promise rejections
 */
window.addEventListener('unhandledrejection', function(event) {
    console.error('‚ùå Unhandled promise rejection:', event.reason);
    
    // Create user-friendly error message
    const message = event.reason?.message || 'An unexpected error occurred';
    alert(`‚ö†Ô∏è Error: ${message}\n\nPlease try again or contact support if the issue persists.`);
    
    // Prevent default handling
    event.preventDefault();
});

</script>
</body>
</html>
